<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Games202 Hw5 JBF and SVGF</title>
    <link href="/2023/07/21/00019.%20Games202%20Hw5/"/>
    <url>/2023/07/21/00019.%20Games202%20Hw5/</url>
    
    <content type="html"><![CDATA[<h1 id="æœ€ç»ˆæ•ˆæœå›¾">æœ€ç»ˆæ•ˆæœå›¾</h1><p>ä¸ºäº†é™ä½å›¾ç‰‡å­˜å‚¨ç©ºé—´ï¼Œåªèƒ½æ§åˆ¶ä¸€ä¸‹FPSä»¥åŠåˆ†è¾¨ç‡äº†ï¼Œçœ‹èµ·æ¥åƒpptåˆ«ä»‹æ„ğŸ‘€ã€‚<br />è¿™æ˜¯é™å™ªå‰çš„æˆªå›¾<br /><img src="/img/00019/image-11.png" alt="0" /> Pinkroom-SVGF<br /><img src="/img/00019/pinkroom-svgf.gif" alt="1" /><br />Pinkroom-JBF-Atrous<br /><img src="/img/00019/pinkroom-JBF-atrous.gif" alt="2" /></p><h1 id="ä½œä¸šè¦æ±‚æ€»è§ˆ">ä½œä¸šè¦æ±‚æ€»è§ˆ</h1><ol type="1"><li>å®ç°å•å¸§é™å™ªã€‚<br /></li><li>å®ç°ä¸¤å¸§é—´çš„æŠ•å½±ã€‚<br /></li><li>å®ç°ä¸¤å¸§é—´çš„ç´¯ç§¯ã€‚<br /></li><li>Bouns 1ï¼šå®ç°A-Trous WaveletåŠ é€Ÿå•å¸§é™å™ªã€‚</li></ol><p>ä¸ªäººæ‰©å±•éƒ¨åˆ†ï¼šSpatiotemporal-Variance-Guided-Filtering</p><h1 id="æºç ">æºç </h1><p>æš‚æœªå…¬å¼€</p><h1 id="å‰è¨€">å‰è¨€</h1><p>å…³äºä½œä¸šçš„æ„å»ºä»¥åŠå®Œæ•´è¿è¡Œæµç¨‹æœ¬æ–‡ä¸åšå¤ªå¤šä»‹ç»ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºè¯¥éƒ¨åˆ†å†…å®¹çš„æ•™ç¨‹ï¼Œé‡ç‚¹æ”¾åœ¨ç®—æ³•æœ¬èº«ã€‚</p><h1 id="æ¦‚è¿°">æ¦‚è¿°</h1><p>æœ¬æ¬¡ä½œä¸šæ¡†æ¶æä¾›äº†<code>exræ–‡ä»¶</code>çš„è¯»å†™æ“ä½œï¼ˆexrçš„å†…å®¹å°±æ˜¯1Sppçš„pathtracingå¾—åˆ°çš„ç»“æœï¼‰ï¼Œæˆ‘ä»¬éœ€è¦çš„æ•°æ®ä¹Ÿé€šè¿‡<code>FrameInfo</code>å°è£…å¥½äº†ï¼Œéœ€è¦å®Œæˆçš„åœ°æ–¹å°±æ˜¯<code>denoiserç±»</code>çš„æˆå‘˜å‡½æ•°ã€‚</p><p>å…³äº<code>è¯»å–exr</code>éœ€è¦çš„æ³¨æ„çš„åœ°æ–¹å°±æ˜¯,<code>width</code>å’Œ<code>height</code>è®°å¾—å°†å…¶åˆå§‹åŒ–ä¸€ä¸‹ï¼Œå¦åˆ™<code>exræ–‡ä»¶</code>è¯»å–é”™è¯¯æ—¶ï¼Œå†…å­˜ä¼šç›´æ¥æ’‘çˆ†ï¼Œå¡çš„è¦æ­»ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Buffer2D&lt;Float3&gt; <span class="hljs-title">ReadFloat3Image</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;filename)</span> </span>&#123;<br>    <span class="hljs-type">int</span> width = <span class="hljs-number">0</span>, height = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">float</span> *_buffer = <span class="hljs-built_in">ReadImage</span>(filename, width, height, <span class="hljs-number">3</span>);<br>    ...<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">float</span> *<span class="hljs-title">ReadImage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;filename, <span class="hljs-type">int</span> &amp;width, <span class="hljs-type">int</span> &amp;height,</span></span><br><span class="hljs-params"><span class="hljs-function">                 <span class="hljs-type">const</span> <span class="hljs-type">int</span> &amp;channel)</span> </span>&#123;<br>    ...<br>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">LoadEXR</span>(&amp;out, &amp;width, &amp;height, filename.<span class="hljs-built_in">c_str</span>(), &amp;err);<br>    <span class="hljs-comment">//ä¸åˆå§‹åŒ–ï¼Œè¯»å–å¤±è´¥åwidth * heightå¾—åˆ°çš„å€¼å·¨å¤§æ— æ¯”ã€‚</span><br>    <span class="hljs-type">float</span> *buffer = <span class="hljs-keyword">new</span> <span class="hljs-type">float</span>[width * height * channel];<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>ç„¶åå°±æ˜¯<code>debug</code>éƒ¨åˆ†åœ¨è¿™é‡ŒåŠ ä¸Šæ–­ç‚¹ï¼Œå¯ä»¥è®©ä½ åœ¨è°ƒè¯•æ—¶å€™é€šè¿‡<strong>å †æ ˆ</strong>å¿«é€Ÿå®šä½é—®é¢˜åœ°æ–¹ã€‚å¦åˆ™æŠ¥é”™åªæœ‰ç®€çŸ­çš„æŠ¥é”™ä¿¡æ¯ï¼Œå‹æ ¹ä¸çŸ¥é“æ˜¯å“ªé”™äº†ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">inline</span> T &amp;Buffer2D&lt;T&gt;::<span class="hljs-built_in">operator</span>()(<span class="hljs-type">const</span> <span class="hljs-type">int</span> &amp;x, <span class="hljs-type">const</span> <span class="hljs-type">int</span> &amp;y) &#123;<br>    <span class="hljs-keyword">if</span> (!(<span class="hljs-number">0</span> &lt;= x &amp;&amp; x &lt; m_width &amp;&amp; <span class="hljs-number">0</span> &lt;= y &amp;&amp; y &lt; m_height))<br>        <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure></p><h1 id="å®ç°-jbf-a-trous-wavelet">å®ç° JBF A-Trous Wavelet</h1><h2 id="é«˜æ–¯æ»¤æ³¢">é«˜æ–¯æ»¤æ³¢</h2><p>å…ˆä»‹ç»ä¸€ä¸‹é«˜æ–¯æ»¤æ³¢åœ¨å›¾å½¢å­¦çš„åº”ç”¨åé¢ä¼šç”¨åˆ°<br />äºŒç»´é«˜æ–¯å‡½æ•°çš„å®šä¹‰ä¸ºï¼š<br /><span class="math display">\[f(x,y) = \dfrac{1}{2\pi\sigma^{2}}e^{-\dfrac{x^{2}+y^{2}}{2\sigma^{2}}}\]</span></p><p><code>x,y</code> ï¼šæ˜¯åç§»å€¼ï¼Œ<span class="math inline">\(r^2 = x^2 +y^2\)</span>å¯ä»¥çœ‹åšè·ç¦»å¹³æ–¹<br /><code>Ïƒ</code> ï¼šæ˜¯æ­£æ€åˆ†å¸ƒçš„æ ‡å‡†åå·®ï¼Œå¯ä»¥å†³å®šå‡½æ•°çš„èƒ–ç˜¦ã€‚</p><p>åœ¨äºŒç»´ç©ºé—´ä¸­ï¼Œè¿™ä¸ªå…¬å¼ç”Ÿæˆçš„æ›²é¢çš„ç­‰é«˜çº¿æ˜¯ä»ä¸­å¿ƒå¼€å§‹å‘ˆæ­£æ€åˆ†å¸ƒçš„åŒå¿ƒåœ†ã€‚åˆ†å¸ƒä¸ä¸ºé›¶çš„åƒç´ ç»„æˆçš„å·ç§¯çŸ©é˜µä¸åŸå§‹å›¾åƒåšå˜æ¢ã€‚æ¯ä¸ªåƒç´ çš„å€¼éƒ½æ˜¯å‘¨å›´ç›¸é‚»åƒç´ å€¼çš„åŠ æƒå¹³å‡ã€‚åŸå§‹åƒç´ çš„å€¼æœ‰æœ€å¤§çš„é«˜æ–¯åˆ†å¸ƒå€¼ï¼Œæ‰€ä»¥æœ‰æœ€å¤§çš„æƒé‡ï¼Œç›¸é‚»åƒç´ éšç€è·ç¦»åŸå§‹åƒç´ è¶Šæ¥è¶Šè¿œï¼Œå…¶æƒé‡ä¹Ÿè¶Šæ¥è¶Šå°ã€‚</p><p>ä¸€ä¸ª<code>3 * 3</code>é«˜æ–¯æ ¸çš„åç§»å›¾ï¼š<br /><span class="math display">\[\begin{bmatrix}-1,1 &amp; 0,1 &amp; 1,1 \\\-1,0 &amp; 0,0 &amp; 1,0 \\\-1,-1 &amp; 0,-1 &amp; 1,-1\end{bmatrix}\]</span></p><p>å‡å®š<span class="math inline">\(\sigma =0.8\)</span>ï¼Œæ ¹æ®åç§»å€¼å’Œé«˜æ–¯å‡½æ•°å¯ä»¥å¾—åˆ°ä¸€ä¸ª<code>3 * 3</code>é«˜æ–¯æ ¸ï¼š<br /><span class="math display">\[\begin{bmatrix}0.05212 &amp; 0.1138 &amp; 0.05212 \\\0.1138 &amp; 0.2486 &amp; 0.1138 \\\0.05212 &amp; 0.1138 &amp; 0.05212\end{bmatrix}\]</span>ç”±äºé«˜æ–¯æ ¸çš„å¤§å°ä¸èƒ½æ— é™å¤§ï¼Œæ‰€ä»¥è¯¥ä¸Šé¢ç”Ÿæˆçš„é«˜æ–¯æ ¸æƒé‡åŠ èµ·æ¥å¤§çº¦åªæœ‰<code>0.91</code>å·¦å³ã€‚åœ¨æ¬¡ä¹‹å‰éœ€è¦é™¤ä»¥å·¦ä¸Šè§’çš„å€¼ä½¿æœ€å°å€¼ä¸º<code>1</code>ï¼Œç„¶åå–æ•´ï¼Œæœ€åè¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œä½¿<code>3 * 3</code>çš„é«˜æ–¯æ ¸æ€»æƒé‡ä¸º<code>1</code>ï¼Œå¾—åˆ°ä¸€ä¸ªç±»é«˜æ–¯çš„æ»¤æ³¢æ ¸ã€‚ä¸‹é¢æ˜¯å½’ä¸€åŒ–çš„é«˜æ–¯æ ¸ï¼š<br /><span class="math display">\[\begin{bmatrix}\dfrac{1}{16} &amp; \dfrac{1}{8} &amp; \dfrac{1}{16} \\\\dfrac{1}{8} &amp; \dfrac{1}{4} &amp; \dfrac{1}{8} \\\\dfrac{1}{16} &amp; \dfrac{1}{8} &amp; \dfrac{1}{16}\end{bmatrix}\]</span></p><h2 id="è”åˆåŒè¾¹æ»¤æ³¢">è”åˆåŒè¾¹æ»¤æ³¢</h2><p>æƒé‡æ€»å’Œä¸º<code>1</code>æˆ–ä¸ä¸º<code>1</code>çš„æ»¤æ³¢å™¨çš„å®ç°åœ¨è¯¾ä¸Šæœ‰æåˆ°ï¼š<br /><img src="/img/00019/implementation-of-filtering.png" alt="3" /><code>w_ij</code> : éå†åˆ°å‘¨å›´åƒç´ æ—¶ï¼Œè¯¥åƒç´ çš„æƒé‡ã€‚<br /><code>sum_of_weights</code> :å„åƒç´ æƒé‡æ€»å’Œï¼Œå¦‚æœæ˜¯ä¸Šé¢æåˆ°çš„å½’ä¸€åŒ–é«˜æ–¯æ ¸ï¼Œåˆ™è¯¥å€¼ç­‰äº<code>1</code>ã€‚<br /><code>sum_of_weighted_values</code> :å„åƒç´ å€¼ç»è¿‡æƒé‡å¤„ç†åçš„æ€»å’Œã€‚<br /><code>C^&#123;input&#125;[j]</code> :å„åƒç´ çš„å€¼ï¼Œå¯ä»¥æ˜¯ç°åº¦å€¼æˆ–è€…<code>RGB</code>é¢œè‰²å€¼ã€‚<br />æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯æ¯ä¸ªåƒç´ éƒ½ä¼šè€ƒè™‘å®ƒä¸€å®šèŒƒå›´å†…åƒç´ å€¼å¯¹å®ƒçš„è´¡çŒ®ï¼Œæœ€åå†é™¤ä»¥<strong>æƒé‡æ€»å’Œ</strong>å°±æ˜¯è¯¥åƒç´ çš„é¢œè‰²å€¼ã€‚è¿™æ ·åšä¼˜ç‚¹åœ¨äºï¼Œå®ƒä¸ä¼šå¼•èµ·æ•´ä½“èƒ½é‡çš„é™ä½æˆ–å‡é«˜ï¼Œä¸ä¼šå¯¼è‡´å›¾åƒæ•´ä½“å˜æš—æˆ–å˜äº®ã€‚<br />æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å†å…³ç³»æ»¤æ³¢æ ¸çš„æƒé‡ï¼Œè€Œæ˜¯å…³æ³¨æ»¤æ³¢æ ¸çš„å½¢çŠ¶ï¼Œè€Œå›¾åƒé™å™ªéƒ¨åˆ†æœ€é‡è¦çš„å°±æ˜¯æ»¤æ³¢æ ¸çš„å½¢çŠ¶ã€‚</p><p>å¦‚æœåªæ˜¯ä½¿ç”¨é«˜æ–¯æ»¤æ³¢æ ¸ï¼Œåˆ™å›¾åƒçš„é«˜é¢‘ä¿¡æ¯éƒ½ä¼šè¢«æŠ¹å»ï¼Œä¿ç•™ä½äº†ä½é¢‘ä¿¡æ¯ï¼Œè¿™æ ·çœ‹èµ·æ¥å›¾åƒå°±ä¼šå˜å¾—å¾ˆæ¨¡ç³Šï¼š<br /><img src="/img/00019/gaussian-filter.png" alt="4" />è€Œæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›è¾¹ç•Œä¸è¦è¢«ç³Šæ‰ï¼Œä»¥åŠä¿ç•™ä¸€äº›æœ‰ç”¨çš„é«˜é¢‘ä¿¡æ¯ï¼Œè¿™å°±å¼•å…¥äº†æ–°çš„æ–¹æ³•<code>BF(Bilateral Filtering)</code>ï¼š<br /><img src="/img/00019/bilateral-filtering.png" alt="5" /><code>i</code>ï¼Œ<code>j</code> è¡¨ç¤ºä¸€ä¸ªç‚¹ï¼›<code>k</code>ï¼Œ<code>l</code> è¡¨ç¤ºå¦ä¸€ä¸ªç‚¹ã€‚<br />è¯¥æ–¹æ³•åœ¨ç±»é«˜æ–¯æ»¤æ³¢ï¼ˆä¸€åˆ‡éšè·ç¦»è¡°å‡çš„å‡½æ•°éƒ½å¯ä»¥ç”¨ï¼Œæ‰€ä»¥å‰é¢é‚£ä¸€å¨å°±å»æ‰äº†ï¼‰ä¸Šå¢åŠ äº†ä¸€ä¸ªé¢œè‰²è´¡çŒ®é¡¹ï¼Œä¹Ÿå°±è¯´ä¸­å¿ƒå‘¨å›´çš„åƒç´ å’Œä¸­å¿ƒåƒç´ çš„é¢œè‰²å·®å¼‚è¿‡å¤§å°±ä¸ç»™äºˆå®ƒè´¡çŒ®ï¼Œè¿™æ ·è¾¹ç•Œè¿™ç§é«˜é¢‘ä¿¡æ¯å°±ä¸ä¼šè¢«ç³Šæ‰ã€‚ä¸‹é¢å°±æ˜¯è¯¥æ–¹æ³•çš„æ•ˆæœï¼š<br /><img src="/img/00019/bilateral-filtering-result.png" alt="6" />æ•ˆæœæ˜¯å¥½äº†å¾ˆå¤šï¼Œè¾¹ç•Œä¹Ÿå¾ˆæ¸…æ™°äº†ï¼Œä½†è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå±±ä½“ä»¥åŠæ°´é¢å¾ˆå¤šæœ‰ç”¨çš„é«˜é¢‘ä¿¡æ¯è¢«å½“åšå™ªå£°æŠ¹æ‰äº†ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ–¹æ³•åˆ†ä¸æ¸…å™ªç‚¹å’Œæœ‰ç”¨çš„é«˜é¢‘ä¿¡æ¯ã€‚</p><p>æ‰€ä»¥åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå†å¢åŠ ä¸€äº›æ–°çš„åˆ¤æ–­æ ‡å‡†å°±å¯ä»¥ä¿ç•™æ›´å¤šæœ‰ç”¨çš„é«˜é¢‘ä¿¡æ¯ï¼Œè¿™å°±æ˜¯å¼•å…¥äº†<code>JBF/CBF(Joint/Cross Bilateral Filtering)</code>:<br /><span class="math display">\[J(i,j) = \exp(-\frac{\lVert i-j\lVert ^2}{2\sigma_{p}^2} - \frac{\lVert\widetilde{C}[i] - \widetilde{C}[j] \lVert ^2 }{2\sigma_{c}^2} -\frac{D_{normal}(i,j)^2}{2\sigma_{n}^2} -\frac{D_{plane}(i,j)^2}{2\sigma_{d}^2})\]</span></p><p>å…¶ä¸­<code>i</code>ï¼Œ<code>j</code> ä¸ºä¸åŒçš„ä¸¤ä¸ªåƒç´ ç‚¹ã€‚ <spanclass="math display">\[D_{normal}(i,j) = arccos(Normal[i] \cdot Normal[j])\]</span></p><p><span class="math display">\[D_{plane}(i,j) = Normal[i]\cdot \frac{Position[j] - Position[i]}{\lVertPosition[j] - Positon[i] \lVert}\]</span></p><p><spanclass="math inline">\(\widetilde{C}\)</span>ä¸ºæœ‰å™ªå£°çš„è¾“å…¥å›¾åƒï¼Œ<spanclass="math inline">\(D_{normal}\)</span>ä¸ºä¸¤æ³•çº¿å¤¹è§’ï¼Œ<spanclass="math inline">\(D_{plane}\)</span>ä¸ºæ·±åº¦å·®å€¼æŒ‡æ ‡ã€‚å…¬å¼ä¸­çš„å„ä¸ª<code>Ïƒ</code>å€¼åœ¨<code>Denoiser</code>ç±»ä¸­æœ‰æä¾›ã€‚</p><p>è¯¥æ–¹æ³•æ–°å¢ä¸¤ä¸ªåˆ¤æ–­æ ‡å‡†æ¥æº<code>Gbuffer</code>ï¼Œç”±äº<code>Gbuffer</code>ç”Ÿæˆçš„çº¹ç†æ˜¯æ²¡æœ‰ä»»ä½•å™ªå£°çš„ï¼Œæ‰€ä»¥ç”¨å®ƒä»¬æ¥æŒ‡å¯¼æ»¤æ³¢æ•ˆæœéå¸¸ä¸é”™ï¼Œè€Œä¸”ç”Ÿæˆ<code>Gbuffer</code>çš„æ€§èƒ½æ¶ˆè€—å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œåœ¨ç¬¬ä¸€è¶Ÿ<code>Rasterization</code>ç”Ÿæˆ<code>Primary Ray</code>çš„æ—¶å€™ç›´æ¥é¡ºå¸¦å°±ç”Ÿæˆäº†æ‰€éœ€è¦çš„<code>Gbuffer</code>ã€‚</p><p><code>JBF</code>çš„ä»£ç ç­‰åˆ°åé¢è®²è§£<code>A-Trous Wavelet</code>å•å¸§é™å™ªåŠ é€Ÿæ—¶åœ¨è´´ä¸Šã€‚</p><h2 id="ä¸¤å¸§é—´çš„æŠ•å½±">ä¸¤å¸§é—´çš„æŠ•å½±</h2><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯æ‰¾å‡ºå½“å‰å¸§çš„æ¯ä¸ªåƒç´ åœ¨ä¸Šä¸€å¸§å¯¹åº”æ˜¯å“ªä¸ªåƒç´ ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br /><img src="/img/00019/back-projection.png" alt="7" />æˆ‘ä»¬ç§°è¿™ä¸€è¿‡ç¨‹ä¸º<code>Back Projection</code>ï¼Œå®ƒå®ç°çš„å…·ä½“è¡¨è¾¾å¼å¦‚ä¸‹ï¼š<br /><span class="math display">\[Screen_{i-1} = E_{i-1}P_{i-1}V_{i-1}M_{i-1}M_{i}^{-1}World_{i}\]</span> <span class="math inline">\(E_{i-1}\)</span>æ˜¯è§†å£å˜æ¢ï¼Œé—«è€å¸ˆè¯´å…¬å¼ä¸­æ¼æ‰äº†ï¼Œè¿™é‡Œæˆ‘è¡¥ä¸Šã€‚<br />æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥å¼å­æ‰¾åˆ°å½“å‰å¸§å½“å‰ç‰‡æ®µå¯¹åº”çš„ä¸Šä¸€å¸§çš„ç‰‡æ®µï¼Œä¸Šè¿°å¼å­ä¸­æ‰€éœ€è¦çš„å„ç§æ•°æ®åœ¨æ¡†æ¶ä¸­éƒ½æœ‰æä¾›ï¼Œå…·ä½“è¯·åé¢çš„ä»£ç å®ç°ã€‚æ‰¾åˆ°çš„ä¸Šä¸€å¸§ä¿¡æ¯è¿˜æœ‰å¯èƒ½æ— æ³•ä½¿ç”¨ï¼Œè¿™ä¸€ç°è±¡æˆ‘ä»¬ç§°ä½œä¸º<code>Temporal Failure</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæœ‰ä¸‰ç§æƒ…å¢ƒä¼šå¯¼è‡´æŠ•å½±å¾—åˆ°çš„ä¿¡æ¯æ— æ•ˆã€‚<br /><img src="/img/00019/temporal-failure.png" alt="8" />å·¦è¾¹çš„ç®±å­æ˜¯ä¸Šä¸€å¸§ï¼Œå³è¾¹çš„ç®±å­æ˜¯å½“å‰å¸§ã€‚<br />disocclusion ï¼šå½“å‰å¸§æ–°å‡ºç°çš„ç‰©ä½“ï¼Œç”±è¢«é®æŒ¡çš„çŠ¶æ€å˜æˆæœªè¢«é®æŒ¡çš„çŠ¶æ€ã€‚</p><p>å‰ä¸¤ç§æƒ…å†µç”±å±å¹•ç©ºé—´çš„èŒƒå›´æ¥çº¦æŸå®ƒï¼Œè¶…å‡ºèŒƒå›´çš„ç›´æ¥ä¸¢å¼ƒï¼ˆå› ä¸ºä¸Šä¸€å¸§å¹¶æœªè®°å½•å±å¹•å¤–çš„ä¿¡æ¯ï¼‰ã€‚å¯¹äºç¬¬ä¸‰ç§ï¼Œæˆ‘ä»¬åˆ™ç”¨ä¸€ä¸ªå«<code>Object ID</code>çš„æ–¹æ³•æ¥æ£€æµ‹<code>Temporal Failure</code>ï¼Œå¦‚æœä¸Šä¸€å¸§å’Œå½“å‰å¸§çš„<code>Object ID</code>ä¸ä¸€è‡´åˆ™ä¸¢å¼ƒï¼Œè¯´æ˜å½“å‰å¸§è¯¥ç‰©ä½“å±äº<code>disocclusion</code>çŠ¶æ€ã€‚</p><p>ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Denoiser_JBF::Reprojection</span><span class="hljs-params">(<span class="hljs-type">const</span> FrameInfo &amp;frameInfo)</span> </span>&#123;<br>    <span class="hljs-type">int</span> height = m_accColor.m_height;<br>    <span class="hljs-type">int</span> width = m_accColor.m_width;<br>    Matrix4x4 pre_World_To_Screen =<br>        m_preFrameInfo.m_matrix[m_preFrameInfo.m_matrix.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>];<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Reproject</span><br>            <span class="hljs-built_in">m_valid</span>(x, y) = <span class="hljs-literal">false</span>;<br>            <span class="hljs-built_in">m_misc</span>(x, y) = <span class="hljs-built_in">Float3</span>(<span class="hljs-number">0.f</span>);<br><br>            <span class="hljs-type">int</span> id = frameInfo.<span class="hljs-built_in">m_id</span>(x, y);<br>            <span class="hljs-keyword">if</span> (id == <span class="hljs-number">-1</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            Matrix4x4 world_to_local = <span class="hljs-built_in">Inverse</span>(frameInfo.m_matrix[id]);<br>            Matrix4x4 pre_local_to_world = m_preFrameInfo.m_matrix[id];<br>            <span class="hljs-keyword">auto</span> world_position = frameInfo.<span class="hljs-built_in">m_position</span>(x, y);<br>            <span class="hljs-keyword">auto</span> local_position =<br>                <span class="hljs-built_in">world_to_local</span>(world_position, Float3::EType::Point);<br>            <span class="hljs-keyword">auto</span> pre_world_position =<br>                <span class="hljs-built_in">pre_local_to_world</span>(local_position, Float3::EType::Point);<br>            <span class="hljs-keyword">auto</span> pre_screen_position =<br>                <span class="hljs-built_in">pre_World_To_Screen</span>(pre_world_position, Float3::EType::Point);<br><br>            <span class="hljs-keyword">if</span> (pre_screen_position.x &lt; <span class="hljs-number">0</span> || pre_screen_position.x &gt;= width ||<br>                pre_screen_position.y &lt; <span class="hljs-number">0</span> || pre_screen_position.y &gt;= height) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">int</span> pre_id =<br>                    m_preFrameInfo.<span class="hljs-built_in">m_id</span>(pre_screen_position.x, pre_screen_position.y);<br>                <span class="hljs-keyword">if</span> (pre_id == id) &#123;<br>                    <span class="hljs-built_in">m_valid</span>(x, y) = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-built_in">m_misc</span>(x, y) =<br>                        <span class="hljs-built_in">m_accColor</span>(pre_screen_position.x, pre_screen_position.y);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//m_miscæ˜¯ä¸€ä¸ªä¸´æ—¶å­˜å‚¨çš„bufferï¼Œå¦‚æœä¸€è¶Ÿpassä¸­ï¼Œè¯»å†™æ˜¯åŒä¸€ä¸ªbufferï¼Œå°±éœ€è¦å¦å¼€ä¸€ä¸ªbufferæ¥é¿å…å®ƒä»¬ç›¸äº’å¹²æ‰°ã€‚åœ¨åé¢svgfä¸­æˆ‘ä»¬ä¹Ÿä¼šç»å¸¸è¿™ä¹ˆä½¿ç”¨ã€‚</span><br>    std::<span class="hljs-built_in">swap</span>(m_misc, m_accColor);<br>&#125;<br></code></pre></td></tr></table></figure></p><p>å…¶ä¸­<code>world_to_local</code>å¯¹åº” <spanclass="math inline">\(M_{i}^{-1}\)</span>ï¼Œ<code>pre_local_to_world</code>å¯¹åº”<spanclass="math inline">\(M_{i-1}\)</span>ï¼Œ<code>pre_World_To_Screen</code>å¯¹åº”<span class="math inline">\(E_{i-1}P_{i-1}V_{i-1}\)</span>ã€‚</p><h2 id="ä¸¤å¸§é—´çš„ç´¯ç§¯">ä¸¤å¸§é—´çš„ç´¯ç§¯</h2><p>ä¸Šä¸€èŠ‚ä¸­æˆ‘å·²ç»æ‹¿åˆ°äº†ä¸Šä¸€å¸§æœ‰ç”¨çš„å†å²ä¿¡æ¯ï¼Œè¿™ä¸€å°èŠ‚åˆ™æ˜¯å°†å½“å‰å¸§ä¸ä¸Šä¸€å¸§è¿›è¡Œçº¿æ€§æ··åˆï¼Œåœ¨çº¿æ€§æ··åˆä¹‹å‰è¿˜éœ€è¦ä¸€æ¬¡<code>Clamp</code>æ“ä½œï¼Œå°†ä¸Šä¸€å¸§çš„é¢œè‰²åˆ©ç”¨å½“å‰å¸§çš„å‡å€¼å’Œæ–¹å·®ä¸¥æ ¼æ§åˆ¶åœ¨å½“å‰å¸§é¢œè‰²é™„è¿‘ï¼Œå…¬å¼å¦‚ä¸‹ï¼š<span class="math display">\[\overline{C}_{i}=\alpha\overline{C}_{i}+(1-\alpha)Clamp(\overline{C}_{i-1})\]</span> <spanclass="math inline">\(\alpha\)</span>çš„å€¼é€šå¸¸å–<code>0.2</code>ã€‚<br />å¯¹äº<code>Clamp</code>éƒ¨åˆ†ï¼Œé¦–å…ˆéœ€è¦è®¡ç®— <spanclass="math inline">\(\overline{C}_{i}\)</span>åœ¨<code>7 * 7</code>çš„é‚»åŸŸå†…çš„å‡å€¼<code>Î¼</code>å’Œæ–¹å·®<code>Ïƒ</code>ï¼Œç„¶åæŠŠä¸Šä¸€å¸§çš„é¢œè‰²<spanclass="math inline">\(\overline{C}_{i-1}\)</span><code>Clamp</code>åœ¨<span class="math inline">\((\mu - k\sigma, \mu + k\sigma)\)</span>èŒƒå›´å†…ã€‚</p><p>ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Denoiser_JBF::TemporalAccumulation</span><span class="hljs-params">(<span class="hljs-type">const</span> Buffer2D&lt;Float3&gt; &amp;curFilteredColor)</span> </span>&#123;<br>    <span class="hljs-type">int</span> height = m_accColor.m_height;<br>    <span class="hljs-type">int</span> width = m_accColor.m_width;<br>    <span class="hljs-type">int</span> kernelRadius = <span class="hljs-number">3</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Temporal clamp</span><br>            Float3 color = <span class="hljs-built_in">m_accColor</span>(x, y);<br>            <span class="hljs-comment">//Set Alpha to 1 when no legal corresponding point was found in the previous frame</span><br>            <span class="hljs-type">float</span> alpha = <span class="hljs-number">1.0f</span>;<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">m_valid</span>(x, y)) &#123;<br>                alpha = m_alpha;<br><br>                <span class="hljs-type">int</span> x_start = std::<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, x - kernelRadius);<br>                <span class="hljs-type">int</span> x_end = std::<span class="hljs-built_in">min</span>(width - <span class="hljs-number">1</span>, x + kernelRadius);<br>                <span class="hljs-type">int</span> y_start = std::<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, y - kernelRadius);<br>                <span class="hljs-type">int</span> y_end = std::<span class="hljs-built_in">min</span>(height - <span class="hljs-number">1</span>, y + kernelRadius);<br><br>                <span class="hljs-function">Float3 <span class="hljs-title">mu</span><span class="hljs-params">(<span class="hljs-number">0.f</span>)</span></span>;<br>                <span class="hljs-function">Float3 <span class="hljs-title">sigma</span><span class="hljs-params">(<span class="hljs-number">0.f</span>)</span></span>;<br><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> m = x_start; m &lt;= x_end; m++) &#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> n = y_start; n &lt;= y_end; n++) &#123;<br>                        mu += <span class="hljs-built_in">curFilteredColor</span>(m, n);<br>                        <span class="hljs-comment">//sqrï¼šå¹³æ–¹</span><br>                        sigma += <span class="hljs-built_in">Sqr</span>(<span class="hljs-built_in">curFilteredColor</span>(x, y) - <span class="hljs-built_in">curFilteredColor</span>(m, n));<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-type">int</span> count = kernelRadius * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;<br>                <span class="hljs-comment">// 7 * 7</span><br>                count *= count;<br><br>                mu /= <span class="hljs-built_in">float</span>(count);<br>                sigma = <span class="hljs-built_in">SafeSqrt</span>(sigma / <span class="hljs-built_in">float</span>(count));<br>                color = <span class="hljs-built_in">Clamp</span>(color, mu - sigma * m_colorBoxK, mu + sigma * m_colorBoxK);<br>            &#125;<br><br>            <span class="hljs-built_in">m_misc</span>(x, y) = <span class="hljs-built_in">Lerp</span>(color, <span class="hljs-built_in">curFilteredColor</span>(x, y), alpha);<br>        &#125;<br>    &#125;<br>    std::<span class="hljs-built_in">swap</span>(m_misc, m_accColor);<br>&#125;<br></code></pre></td></tr></table></figure><code>Clamp</code>æ˜¯ä¸ºäº†å‡è½»<code>Lagging(æ‹–å½±)</code>ç°è±¡ï¼Œå¦‚æœä»€ä¹ˆéƒ½ä¸åšå¼ºè¡Œä½¿ç”¨ä¸Šä¸€å¸§çš„ä¿¡æ¯ï¼Œå°±ä¼šå¯¼è‡´æ‹–å½±ç°è±¡:<br /><img src="/img/00019/lagging.png" alt="9" /></p><p>ä½¿ç”¨äº†<code>Clamp</code>æ–¹æ³•åï¼Œæ‹–å½±ç°è±¡æ²¡äº†ï¼Œä½†æ˜¯ä¼šé‡æ–°å¼•å…¥å™ªå£°ï¼Œä¸è¿‡ç›¸æ¯”äºæ‹–å½±æ•ˆæœè¿˜æ˜¯å¥½äº†å¾ˆå¤šï¼š<br /><img src="/img/00019/noise.png" alt="10" /></p><p>é€šå¸¸<code>Object ID</code>å’Œ<code>Clamp</code>æ–¹æ³•æ˜¯ä¸€èµ·ä½¿ç”¨ã€‚</p><p>å³ä½¿æˆ‘ä»¬å·²ç»åšå¾—è¶³å¤Ÿå¥½äº†ï¼Œä½†è¿˜æ˜¯æœ‰å¾ˆå¤šçš„<code>Temporal Failure</code>ï¼Œå¹¶ä¸æ˜¯å› ä¸ºå‡ ä½•çš„åŸå› ï¼Œè€Œæ˜¯<code>shading</code>è¿‡ç¨‹ä¸­ä¹Ÿä¼šå‡ºé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´é˜´å½±æˆ–è€…åå°„è¿™ç§ç°è±¡ï¼Œåœ¨ç”¨ä¸Šä¸€å¸§çš„ä¿¡æ¯æ—¶ï¼Œå®ƒçš„<code>motion vector</code>æ˜¯é›¶ï¼Œå½“å‰å¸§å½“å‰ç‰‡æ®µå°±ä¼šç”¨ä¸Šä¸€å¸§çš„ä¿¡æ¯ï¼Œè¿™å°±ä¼šå¯¼è‡´é˜´å½±æ‹–å°¾æˆ–è€…åå°„å»¶è¿Ÿçš„ç°è±¡ï¼š<br />Detached/Lagging shadows<br /><img src="/img/00019/lagging-shadows.png" alt="11" /> Reflectionhysteresis<br /><img src="/img/00019/reflection-hysteresis.gif" alt="12" /></p><h2 id="åŠ é€Ÿå•å¸§é™å™ª">åŠ é€Ÿå•å¸§é™å™ª</h2><h3 id="separate-passes">Separate Passes</h3><p>åœ¨æ­¤ä¹‹å‰è¿˜ä»‹ç»ä¸€ç§<code>Separate Passes</code>çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥å°†å¤æ‚åº¦ä»<code>N^2</code>é™åˆ°<code>2N</code>ï¼š<br /><img src="/img/00019/image.png" alt="13" />è¯¥æ–¹æ³•å¾ˆé€‚åˆé«˜æ–¯æ»¤æ³¢ï¼Œå› ä¸ºé«˜æ–¯æ»¤æ³¢åœ¨å®šä¹‰ä¸Šå°±å¯ä»¥æ‹†åˆ†æˆä¸¤ä¸ªæ–¹å‘ä¸Šå‡½æ•°çš„ä¹˜ç§¯å½¢å¼,æ»¤æ³¢è¿‡ç¨‹ä¸­ç›¸å½“äºå…ˆæ°´å¹³æ–¹å‘åšä¸€æ¬¡å·ç§¯ï¼Œç„¶åå°†ç»“æœç»™åˆ°ç«–ç›´æ–¹å‘å†åšä¸€æ¬¡å·ç§¯ï¼Œéå¸¸å®Œç¾ï¼š<br /><img src="/img/00019/image-1.png" alt="14" />ä½†é—®é¢˜æ˜¯<code>BF</code>å’Œ<code>JBF</code>çš„å·ç§¯æ ¸ï¼Œä¸æ˜¯ä¸€ä¸ªé«˜æ–¯å‡½æ•°ï¼Œæƒ³è¦å°†å®ƒæ‹†åˆ†æˆæ°´å¹³ç«–ç›´çš„å‡½æ•°æ˜¯å‡ ä¹ä¸å¯èƒ½ï¼Œä½†è¿™é‡Œæ˜¯å®æ—¶æ¸²æŸ“ï¼Œâ€œçº¦ç­‰äºâ€æ— å¤„ä¸åœ¨ğŸ˜†ï¼Œ<code>filter</code>çš„èŒƒå›´åªè¦ä¸æ˜¯å¤ªå¤§æ¯”å¦‚<code>32 * 32</code>è¿˜æ˜¯å¯ä»¥å‹‰å¼ºç”¨ä¸€ç”¨çš„ã€‚</p><h3 id="a-trous-wavelet">A-Trous Wavelet</h3><p>ä¸Šé¢æåˆ°çš„<code>Separate Passes</code>æ–¹æ³•ï¼Œæˆ‘è¿˜æ²¡çœ‹åˆ°åœ¨å“ªé‡Œç”¨ä¸Šäº†ğŸ˜…ã€‚è€Œ<code>A-Trous Wavelet</code>æ–¹æ³•åœ¨é™å™ªè¿™æ–¹é¢å‡ ä¹æ˜¯é€šåƒï¼Œåº”ç”¨éå¸¸å¹¿æ³›ï¼š<br /><img src="/img/00019/image-2.png" alt="15" />è¿™é‡Œ<code>ppt</code>ä¸Šçš„å›¾ç‰‡ä¸å¤ªå¥½ç†è§£ï¼Œæˆ‘è¿™é‡Œå¼•ç”¨ä¸€ä¸‹çŸ¥ä¹<ahref="https://zhuanlan.zhihu.com/p/607012514">èŠ±æ¡‘</a>çš„å›¾ç‰‡<br /><img src="/img/00019/image-3.png" alt="16" /><code>A-Trous Wavelet</code>æ–¹æ³•ç›¸å½“äºå§ä¸€ä¸ªéå¸¸å¤§èŒƒå›´çš„<code>filterè¿‡ç¨‹</code>åˆ†è§£æˆ<code>å‡ è¶Ÿpass</code>æ¥å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦<code>filter</code>çš„ç‚¹ä½<code>p</code>å°±æ˜¯<code>const Float3 p = ipos + Float3(xx, yy,0) * stepSize;</code>å…¶ä¸­<code>ipos</code>ä¸­å¿ƒç‚¹ï¼Œ<code>xx,yy</code>æ˜¯åç§»å€¼ï¼Œ<code>stepSize</code>åˆ™æ˜¯<span class="math inline">\(2^{pass-1}\)</span><br />è¿™æ ·<code>3</code>è¶Ÿ<code>5 * 5</code>çš„æ»¤æ³¢å°±ç›¸å½“äº<code>16 * 16</code>çš„æ»¤æ³¢ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ä¸€ä¸ªå¤§å°ä¸º<code>5 * 5</code>çš„æ»¤æ³¢æ ¸ï¼Œèµ°<code>5</code>è¶Ÿï¼Œæ¥æ¨¡æ‹Ÿ<code>64 * 64</code>çš„æ»¤æ³¢è¿‡ç¨‹ã€‚(5* 5çš„æ»¤æ³¢æ ¸ï¼Œèµ°5è¶Ÿï¼ŒfilteråŠå¾„å³ <span class="math inline">\(2 \times2^{5-1}=32\)</span>)</p><p>å½“ç„¶è¿™åªæ˜¯è¯¥æ–¹æ³•çš„åº”ç”¨ï¼Œå®ƒçš„åŸç†å…¶å®å¾ˆå¤æ‚ï¼Œç®€å•æ¦‚è¿°ä¸€ä¸‹ï¼š<br /><img src="/img/00019/image-4.png" alt="17" /> å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼š<br />ä¸ºä»€ä¹ˆè¦ç”¨ä¸€ä¸ªé€æ¸å¢åŠ çš„<code>filter</code>èŒƒå›´ï¼Œä¸èƒ½ä¸€ä¸Šæ¥å°±æ˜¯æœ€å¤§èŒƒå›´ï¼Ÿ<br />å›¾ä¸Šç»™å‡ºçš„ç­”æ¡ˆæ˜¯ï¼Œé€æ¸å¢åŠ çš„<code>filter</code>èŒƒå›´ ==å»æ‰æ›´ä½çš„é¢‘ç‡ã€‚<br />å¯¹äºç¬¬ä¸€è¶Ÿ<code>pass</code>ï¼Œæˆ‘ä»¬<code>filter</code>çš„è¿‡ç¨‹æ˜¯å°†é«˜é¢‘ä¿¡æ¯é™åˆ¶åœ¨ä¸€ä¸ªå¯æ¥å—çš„èŒƒå›´å†…ï¼Œå¾€åçš„æ¯ä¸€è¶Ÿ<code>pass</code>éƒ½æ˜¯åœ¨å‰ä¸€è¶Ÿçš„åŸºç¡€ä¸Šç»§ç»­å°†é«˜é¢‘ä¿¡æ¯é™åˆ¶åœ¨ä¸€ä¸ªæ›´ä½çš„å¯æ¥å—èŒƒå›´å†…ï¼Œæ‰€ä»¥è¿™é‡Œâ€œå»æ‰æ›´ä½çš„é¢‘ç‡â€æ„æ€æ˜¯ç›¸æ¯”äºä¸Šä¸€è¶Ÿ<code>pass</code>ï¼Œå»æ‰æ¯”ä¸Šä¸€è¶Ÿé«˜é¢‘ä¿¡æ¯æ›´ä½ä¸€ç‚¹çš„é«˜é¢‘ä¿¡æ¯ã€‚è‡ªç„¶è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯<code>filter</code>çš„èŒƒå›´æ˜¯é€æ¸å¢åŠ ï¼Œè€Œä¸èƒ½ä¸€ä¸Šæ¥å°±æ˜¯<code>filter</code>æœ€å¤§çš„èŒƒå›´ã€‚<br />å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼š<br />ä¸ºä»€ä¹ˆå¯ä»¥å®‰å…¨çš„è·³è¿‡ä¸€äº›é‡‡æ ·ç‚¹ï¼Ÿ<br />å›¾ä¸Šç»™å‡ºçš„ç­”æ¡ˆæ˜¯ï¼Œé‡‡æ · == é‡å¤æ¬ç§»é¢‘è°±ã€‚<br />é¦–å…ˆå¯¹äºé‡‡æ ·æ¥è¯´ï¼Œæ—¶åŸŸä¸Šçš„é‡‡æ ·ç­‰äºåŸå§‹å‡½æ•°ä¹˜ä¸Šå†²å‡»å‡½æ•°ã€‚è€Œå¯¹åº”é¢‘åŸŸä¸Šï¼Œå°±æ˜¯åŸå§‹é¢‘è°±å·ç§¯å†²å‡»é¢‘è°±ï¼Œç›¸å½“äºå¯¹åœ¨é¢‘åŸŸä¸Šå¯¹åŸå§‹é¢‘è°±è¿›è¡Œæ¬ç§»çš„æ“ä½œï¼Œè€Œä¸”æ—¶åŸŸå†²å‡»å‡½æ•°çš„å†²å‡»é—´éš”è¶Šå¤§ï¼Œå¯¹åº”é¢‘åŸŸæ¬ç§»çš„é—´éš”å°±è¶Šå°ï¼š<br /><img src="/img/00019/image-5.png" alt="18" /><br />(a)ä¸ºåŸå§‹å‡½æ•°ï¼Œ(b)ä¸ºè¯¥å‡½æ•°ç»è¿‡å‚…é‡Œå¶å˜åŒ–åçš„é¢‘è°±ã€‚<br />(c)ä¸ºå†²å‡»å‡½æ•°ï¼Œ(d)ä¸ºè¯¥å‡½æ•°ç»è¿‡å‚…é‡Œå¶å˜åŒ–åçš„é¢‘è°±ã€‚<br />(e)ä¸ºåŸå§‹å‡½æ•°ä¹˜ä¸Šå†²å‡»å‡½æ•°çš„ç»“æœã€‚<br />(f)ä¸º(b)(d)é¢‘è°±å·ç§¯åçš„ç»“æœã€‚<br />æˆ‘ä»¬çŸ¥é“å¦‚æœæ—¶åŸŸé‡‡æ ·é—´éš”å¢åŠ å¤§ï¼Œé¢‘åŸŸä¸Šé¢‘è°±æ··å å°±è¶Šä¸¥é‡ï¼Œåªæœ‰å½“é¢‘è°±ä¸­é«˜é¢‘ä¿¡æ¯è¢«æŠ¹æ‰åï¼Œæ··å æ‰ä¸ä¼šå¼•èµ·èµ°æ ·ã€‚è¿™ä¹Ÿæ˜¯è¦ç”¨ä¸€ä¸ªé€æ¸å¢åŠ çš„<code>filter</code>èŒƒå›´çš„ä¸€ä¸ªåŸå› ã€‚<br /><img src="/img/00019/image-6.png" alt="19" />å›åˆ°é—®é¢˜ä¸Šï¼Œ<code>A-Trous Wavelet</code>çš„é‡‡æ ·é—´éš”ä¸º<spanclass="math inline">\(2^{pass-1}-1\)</span>ï¼Œè¿™ç§é‡‡æ ·é—´è·çš„å¥½å¤„æ˜¯æ¬ç§»çš„è¾¹ç•Œæ­£å¥½æ˜¯ä¸Šä¸€è¶Ÿç•™ä¸‹çš„æœ€é«˜é¢‘ç‡ã€‚æ‰€ä»¥è¿™ç§é‡‡æ ·å¯ä»¥å®‰å…¨çš„è·³è¿‡ä¸€äº›é‡‡æ ·ç‚¹ï¼Œè€Œä¸å¼•å…¥èµ°æ ·ã€‚<br />ç»“åˆç¬¬ä¸€ä¸ªé—®é¢˜å’Œç¬¬äºŒä¸ªé—®é¢˜ï¼Œå½“å‰<code>pass</code>ä¼šé™¤å»ä¸€äº›æ›´ä½çš„é«˜é¢‘ä¿¡æ¯ï¼Œæœ‰åŠ©äºæ¬ç§»æ··å æ—¶å‡å°‘èµ°æ ·ç°è±¡ï¼Œä»¥<spanclass="math inline">\(2^{pass-1}-1\)</span>çš„é—´éš”å»é‡‡æ ·ï¼Œç”±äºæ¬ç§»æ—¶å·¦å³è¾¹ç•Œéƒ½æ˜¯ä¸Šä¸€æ¬¡ç•™ä¸‹çš„æœ€é«˜é¢‘ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™ç§é€æ¸å¢å¤§çš„é‡‡æ ·é—´éš”å¹¶ä¸ä¼šæ–°å¢èµ°æ ·ã€‚æ›´å¤šå†…å®¹è¯·å…³æ³¨è¯¥è®ºæ–‡ï¼š<br /><a href="https://jo.dreggn.org/home/2010_atrous.pdf">Edge-AvoidingÃ€-Trous Wavelet Transform for fast Global Illumination Filtering</a></p><p><code>JBF A-Trous Wavelet</code>çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Buffer2D&lt;Float3&gt; <span class="hljs-title">Denoiser_JBF::ATrousWaveletFilter</span><span class="hljs-params">(<span class="hljs-type">const</span> FrameInfo &amp;frameInfo)</span> </span>&#123;<br>    <span class="hljs-type">int</span> height = frameInfo.m_beauty.m_height;<br>    <span class="hljs-type">int</span> width = frameInfo.m_beauty.m_width;<br>    Buffer2D&lt;Float3&gt; filteredImage = <span class="hljs-built_in">CreateBuffer2D</span>&lt;Float3&gt;(width, height);<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Joint bilateral filter</span><br>            <span class="hljs-comment">// filteredImage(x, y) = frameInfo.m_beauty(x, y);</span><br><br>            <span class="hljs-keyword">auto</span> center_postion = frameInfo.<span class="hljs-built_in">m_position</span>(x, y);<br>            <span class="hljs-keyword">auto</span> center_normal = frameInfo.<span class="hljs-built_in">m_normal</span>(x, y);<br>            <span class="hljs-keyword">auto</span> center_color = frameInfo.<span class="hljs-built_in">m_beauty</span>(x, y);<br><br>            Float3 final_color;<br>            <span class="hljs-keyword">auto</span> total_weight = <span class="hljs-number">.0</span>f;<br><br>            <span class="hljs-type">int</span> passes = <span class="hljs-number">5</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> pass = <span class="hljs-number">0</span>; pass &lt; passes; pass++) &#123;<br><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> filterX = <span class="hljs-number">-2</span>; filterX &lt;= <span class="hljs-number">2</span>; filterX++) &#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> filterY = <span class="hljs-number">-2</span>; filterY &lt;= <span class="hljs-number">2</span>; filterY++) &#123;<br><br>                        <span class="hljs-type">int</span> m = x + std::<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, pass) * filterX;<br>                        <span class="hljs-type">int</span> n = y + std::<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, pass) * filterY;<br><br>                        <span class="hljs-keyword">auto</span> postion = frameInfo.<span class="hljs-built_in">m_position</span>(m, n);<br>                        <span class="hljs-keyword">auto</span> normal = frameInfo.<span class="hljs-built_in">m_normal</span>(m, n);<br>                        <span class="hljs-keyword">auto</span> color = frameInfo.<span class="hljs-built_in">m_beauty</span>(m, n);<br><br>                        <span class="hljs-keyword">auto</span> d_position = <span class="hljs-built_in">SqrDistance</span>(center_postion, postion) /<br>                                          (<span class="hljs-number">2.0f</span> * m_sigmaCoord * m_sigmaCoord);<br>                        <span class="hljs-keyword">auto</span> d_color = <span class="hljs-built_in">SqrDistance</span>(center_color, color) /<br>                                       (<span class="hljs-number">2.0f</span> * m_sigmaColor * m_sigmaColor);<br>                        <span class="hljs-keyword">auto</span> d_normal = <span class="hljs-built_in">SafeAcos</span>(<span class="hljs-built_in">Dot</span>(center_normal, normal));<br>                        d_normal *= d_normal;<br>                        d_normal /= (<span class="hljs-number">2.0f</span> * m_sigmaNormal * m_sigmaNormal);<br><br>                        <span class="hljs-type">float</span> d_plane = <span class="hljs-number">.0</span>f;<br>                        <span class="hljs-keyword">if</span> (d_position &gt; <span class="hljs-number">0.f</span>) &#123;<br>                            d_plane = <span class="hljs-built_in">Dot</span>(center_normal, <span class="hljs-built_in">Normalize</span>(postion - center_postion));<br>                        &#125;<br>                        d_plane *= d_plane;<br>                        d_plane /= (<span class="hljs-number">2.0f</span> * m_sigmaPlane * m_sigmaPlane);<br><br>                        <span class="hljs-type">float</span> weight =<br>                            std::<span class="hljs-built_in">exp</span>(-d_plane - d_position - d_color - d_normal);<br>                        total_weight += weight;<br>                        final_color += color * weight;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (total_weight == <span class="hljs-number">0</span>)<br>                <span class="hljs-built_in">filteredImage</span>(x, y) = center_color;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-built_in">filteredImage</span>(x, y) = final_color / total_weight;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> filteredImage;<br>&#125;<br></code></pre></td></tr></table></figure></p><p>ç”¨è¯¥æ–¹æ³•<code>filter</code>çš„æ•ˆæœå›¾ï¼š<br />æ­¤æ—¶çš„<code>sigmaColor</code>ä¸º<code>0.6f</code><br /><img src="/img/00019/box-JBF-atrous.gif" alt="20" /><br />è€Œ<code>Pink Room</code>çš„<code>sigmaColor</code>éœ€è¦è°ƒä¸º<code>10.0f</code>ï¼Œå¦åˆ™å®Œå…¨ä¸èƒ½çœ‹ã€‚<br /><img src="/img/00019/pinkroom-JBF-atrous.gif" alt="21" /></p><h1 id="å®ç°-svgf">å®ç° SVGF</h1><h2id="è®ºæ–‡åœ°å€ä»¥åŠè®ºæ–‡æä¾›çš„æºç åœ°å€">è®ºæ–‡åœ°å€ä»¥åŠè®ºæ–‡æä¾›çš„æºç åœ°å€</h2><p><code>Paper</code> : <ahref="https://research.nvidia.com/sites/default/files/pubs/2017-07_Spatiotemporal-Variance-Guided-Filtering%3A//svgf_preprint.pdf">Spatiotemporal-Variance-Guided-Filtering</a><br /><code>Source Code</code> : <ahref="https://github.com/NVIDIAGameWorks/Falcor/tree/master/Source/RenderPasses/SVGFPass">Falcor</a><br />æœ¬æ–‡éƒ¨åˆ†ä»£ç ä»¥åŠå›¾ç‰‡å‡æ¥æºäºæ­¤ã€‚</p><h2 id="ç®—æ³•æ¦‚è¿°">ç®—æ³•æ¦‚è¿°</h2><p><code>SVGF</code>èµ„æ–™ä¸å¤šï¼Œæˆ‘å¼•ç”¨ä¸€ä¸‹è®ºæ–‡ä¸­çš„å›¾ç‰‡æ¥è®²è§£ï¼š<br /><img src="/img/00019/image-8.png" alt="22" /><br />é¦–å…ˆä»è·¯å¾„è¿½è¸ªå¾—åˆ°ç›´æ¥å…‰å’Œé—´æ¥å…‰æ¯ä¸ªåƒç´ çš„é¢œè‰²ï¼Œç„¶åé€šè¿‡é™¤ä»¥åƒç´ ä¸Šçš„çº¹ç†ä¿¡æ¯ï¼ˆDemodulateAlbedoï¼‰å¾—åˆ°åƒç´ çš„<code>Irradiance</code>ï¼ˆè¾ç…§åº¦ï¼‰ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">float3 <span class="hljs-title">demodulate</span><span class="hljs-params">(float3 c, float3 albedo)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> c / <span class="hljs-built_in">max</span>(albedo, <span class="hljs-built_in">float3</span>(<span class="hljs-number">0.001</span>, <span class="hljs-number">0.001</span>, <span class="hljs-number">0.001</span>));<br>&#125;<br><br>float3 illumination = <span class="hljs-built_in">demodulate</span>(gColor[ipos].rgb - gEmission[ipos].rgb, gAlbedo[ipos].rgb);<br></code></pre></td></tr></table></figure>æ¥ç€å¯¹åˆ†åˆ«å¯¹ç›´æ¥å…‰ç…§å’Œé—´æ¥å…‰ç…§çš„<code>Irradiance</code>ä¿¡æ¯è¿›è¡Œæ—¶é—´å’Œç©ºé—´ä¸Šçš„æ··åˆ<code>Filter</code>æ¥é‡å»ºå› ä¸ºæ ·æœ¬æåº¦ç¨€ç–æ‰€ä¸¢å¤±çš„ä¿¡æ¯ï¼ˆReconstructionFilterï¼‰ã€‚å¯¹<code>Irradiance</code>è¿›è¡Œ<code>Filter</code>ä¹‹åï¼Œå†æŠŠçº¹ç†ä¿¡æ¯å åŠ å›æ¥ï¼ˆModulateAlbedoï¼‰ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">float4 <span class="hljs-title">main</span><span class="hljs-params">(FullScreenPassVsOut vsOut)</span> : SV_TARGET0</span><br><span class="hljs-function">&#123;</span><br>    <span class="hljs-type">const</span> int2 ipos = <span class="hljs-built_in">int2</span>(vsOut.posH.xy);<br><br>    <span class="hljs-keyword">return</span> gAlbedo[ipos] * gIllumination[ipos] + gEmission[ipos];<br>&#125;<br></code></pre></td></tr></table></figure>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œçº¹ç†çš„ç»†èŠ‚å¹¶ä¸ä¼šå› ä¸º<code>Filter</code>çš„å¼ºåº¦è¿‡äºå¤§è€Œä¸¢å¤±æ‰ã€‚åœ¨<code>Pipeline</code>çš„æœ€åï¼Œé‡‡ç”¨ç°åœ¨å¼•æ“é‡Œéå¸¸æµè¡Œçš„<code>Temporal AA</code>ï¼Œæ›´è¿›ä¸€æ­¥çš„æ¶ˆé™¤ç”»é¢ä¸Šæ®‹ç•™çš„æŠ–åŠ¨ï¼Œä¿è¯ç»“æœåºåˆ—å¸§é—´çš„ç¨³å®šã€‚</p><p>ç”±äºä½œä¸š5ï¼Œæä¾›çš„<code>EXRæ–‡ä»¶</code>ä¸­åªåŒ…å«äº†ç›´æ¥å…‰å’Œé—´æ¥å…‰ç»“åˆåœ¨ä¸€èµ·çš„å®Œæ•´ç»“æœï¼Œæˆ‘åœ¨è¿›è¡Œ<code>Reconstruction Filter</code>è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯ç›´æ¥å¯¹è¯¥ç»“æœè¿›è¡Œçš„<code>Filter</code>ï¼Œæ‰€ä»¥ç”»é¢æœ‰äº›åœ°æ–¹ä¼šç³Šæ‰ä¼šå¾ˆæ­£å¸¸ã€‚</p><p>è‡³äº<code>Tone Mapping</code>å’Œ<code>TAA</code>æˆ‘å‡æœªå®ç°ï¼Œæˆ‘ä»¬çš„é‡ç‚¹æ˜¯<code>Reconstruction Filter</code>ã€‚</p><h2 id="reconstruction-filter">Reconstruction Filter</h2><p><img src="/img/00019/image-9.png" alt="23" /><br />é‡å»ºæ‰§è¡Œä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼šåœ¨æ—¶é—´ä¸Šç´¯ç§¯æˆ‘ä»¬çš„<code>1 spp</code>è·¯å¾„è·Ÿè¸ªè¾“å…¥ä»¥æé«˜æœ‰æ•ˆé‡‡æ ·ç‡ï¼Œä½¿ç”¨è¿™äº›æ—¶é—´ä¸Šå¢å¼ºçš„é¢œè‰²æ ·æœ¬æ¥ä¼°è®¡å±€éƒ¨äº®åº¦æ–¹å·®ï¼Œä»¥åŠä½¿ç”¨è¿™äº›æ–¹å·®ä¼°è®¡æ¥é©±åŠ¨åˆ†å±‚çš„<code>â€œa-trouså°æ³¢æ»¤æ³¢å™¨â€</code>ã€‚</p><h3 id="temporal-filtering">Temporal Filtering</h3><p><code>Temporal Filter</code>å’Œä¸Šæ–‡æåˆ°çš„â€œä¸¤å¸§é—´çš„ç´¯ç§¯â€å¾ˆç›¸ä¼¼ï¼Œå…¬å¼å¦‚ä¸‹ï¼š<br /><span class="math display">\[C_{i} = \alpha C_{i} + (1-\alpha)C_{i-1}\]</span>ä¸ºäº†å°½å¯èƒ½å¤šçš„å›Šæ‹¬å†å²å¸§é‡Œçš„æ ·æœ¬ä¿¡æ¯ï¼Œ<code>Temporal Filter</code>å¹¶ä¸åƒ<code>JBF</code>é‚£æ ·é€šè¿‡<code>Color Clamping</code>æ¥é˜²æ­¢<code>Ghosting</code>è¿™ç§é—®é¢˜ã€‚æ‰€ä»¥åœ¨åš<code>Sample Reprojection</code>çš„æ—¶å€™éœ€è¦æ£€æŸ¥èŒƒå›´ï¼Œæ·±åº¦ï¼Œæ³•çº¿ï¼Œæ¨¡å‹ç´¢å¼•ç­‰ï¼Œå»å°½å¯èƒ½çš„ä¸¢å¼ƒæ— æ•ˆçš„å†å²æ ·æœ¬:<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span> (loc.x &lt; <span class="hljs-number">0</span> || loc.x &gt;= width || loc.y &lt; <span class="hljs-number">0</span> || loc.y &gt;= height)<br>    <span class="hljs-comment">//ä¸¢å¼ƒ</span><br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Denoiser_SVGF::isReprjValid</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">float</span> depth,<span class="hljs-type">const</span> <span class="hljs-type">float</span> preDepth,<span class="hljs-type">const</span> <span class="hljs-type">float</span> fwidthZ,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> Float3 normal, <span class="hljs-type">const</span> Float3 preNormal,<span class="hljs-type">const</span> <span class="hljs-type">float</span> fwidthNormal,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">int</span> meshId,<span class="hljs-type">const</span> <span class="hljs-type">int</span> preMeshId</span></span><br><span class="hljs-params"><span class="hljs-function">)</span> </span>&#123;<br>    <span class="hljs-comment">// check if deviation of depths is acceptable</span><br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">fabs</span>(depth - preDepth) / (fwidthZ + <span class="hljs-number">1e-2</span>) &gt; <span class="hljs-number">10.0f</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// check normals for compatibility</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Distance</span>(normal, preNormal) / (fwidthNormal + <span class="hljs-number">1e-2</span>) &gt; <span class="hljs-number">16.0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// Since the grayscale is the result of direct path-tracing, there is a mutual contribution that can occur without meshid.</span><br>    <span class="hljs-comment">//To mitigate this, add meshid, which can cause other problems such as artifacts.</span><br>    <span class="hljs-keyword">if</span> (meshId != preMeshId)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure> ä»£ç ä¸­çš„<code>fwidthZï¼ŒfwidthNormal</code>ä¸ºæ·±åº¦æˆ–æ³•çº¿<ahref="https://developer.download.nvidia.com/cg/fwidth.html">åœ¨xï¼Œyæ–¹å‘ä¸Šçš„åå¯¼å’Œ</a>ã€‚å…¶è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> Float3 normal = frameInfo.<span class="hljs-built_in">m_normal</span>(x, y);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> ddxN = <span class="hljs-built_in">Distance</span>(frameInfo.<span class="hljs-built_in">m_normal</span>(x + <span class="hljs-number">1</span>, y), normal);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> ddyN = <span class="hljs-built_in">Distance</span>(frameInfo.<span class="hljs-built_in">m_normal</span>(x, y + <span class="hljs-number">1</span>), normal);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> fwidthNormal = ddxN + ddyN;<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> depth = frameInfo.<span class="hljs-built_in">m_depth</span>(x, y);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> ddxZ = std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(x + <span class="hljs-number">1</span>, y) - depth);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> ddyZ = std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(x, y + <span class="hljs-number">1</span>) - depth);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> fwidthZ = ddxZ + ddyZ;<br></code></pre></td></tr></table></figure> <code>Temporal Filter</code>å…¬å¼ä¸­çš„<spanclass="math inline">\(\alpha\)</span>æ˜¯æ ¹æ®å¯»æ‰¾å†å²æ ·æœ¬çš„æˆåŠŸæ¬¡æ•°æ¥å®šçš„ï¼Œæœ€å¤§ä¸º<code>1</code>ï¼Œæœ€å°è‡ªå®šï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// this adjusts the alpha for the case where insufficient history is available.</span><br><span class="hljs-comment">// It boosts the temporal accumulation to give the samples equal weights in the beginning.</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> alpha = success ? std::<span class="hljs-built_in">fmax</span>(m_Alpha, <span class="hljs-number">1.0</span> / historyLength) : <span class="hljs-number">1.0</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> alphaMoments = success ? std::<span class="hljs-built_in">fmax</span>(m_MomentsAlpha, <span class="hljs-number">1.0</span> / historyLength) : <span class="hljs-number">1.0</span>;<br><br><span class="hljs-comment">// compute first two moments of luminance</span><br>Float3 moments;<br>moments.x = <span class="hljs-built_in">Luminance</span>(illumination);<br>moments.y = moments.x * moments.x;<br><br><span class="hljs-comment">// temporal integration of the moments</span><br>moments = <span class="hljs-built_in">Lerp</span>(prevMoments, moments, alphaMoments);<br><br><span class="hljs-type">float</span> variance = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">0.f</span>, moments.y - moments.x * moments.x);<br><span class="hljs-comment">// temporal integration of illumination</span><br><span class="hljs-built_in">m_accColor</span>(x, y) = <span class="hljs-built_in">Lerp</span>(prevIllumination, illumination, alpha);<br><span class="hljs-built_in">m_curFrameVariance</span>(x,y) = variance;<br><span class="hljs-built_in">m_moments</span>(x, y) = moments;<br><span class="hljs-built_in">m_tmpHisLength</span>(x,y) = historyLength;<br></code></pre></td></tr></table></figure>æ˜¯çš„ï¼Œä¸ä»…ä»…æ˜¯é¢œè‰²éœ€è¦<code>Temporal Filter</code>ï¼Œ<code>Moments</code>ä¹Ÿéœ€è¦ï¼Œæ–¹å·®çš„è®¡ç®—ä¾èµ–å®ƒï¼Œé€šè¿‡åœ¨æ—¶é—´ä¸Šç§¯ç´¯<code>Luminance</code>çš„<code>First</code>å’Œ<code>Second Moment</code>ï¼Œ<spanclass="math inline">\(\mu^{\prime}_{1i}\)</span>å’Œ<spanclass="math inline">\(\mu^{\prime}_{2i}\)</span>ï¼Œæ–¹å·®çš„è®¡ç®—å…¬å¼å¦‚ä¸‹:<br /><span class="math display">\[\sigma^{\prime 2}_{i}=\mu^{\prime}_{2i}-\mu^{\prime 2}_{1i}\]</span><code>Moments Temporal Filter</code>å¯¹åº”ä¸Šå›¾ä¸­ç´«è‰²å—çš„å¤„ç†è¿‡ç¨‹ã€‚</p><h3 id="variance-estimation">Variance Estimation</h3><p>ç”±äºæ‘„åƒæœºè¿åŠ¨ã€å½±è§†æ•ˆæœå’Œè§†å£å˜æ¢å‡ºç•Œéƒ½ä¼šå¯¼è‡´<code>disocclusionäº‹ä»¶</code>ï¼Œä»è€Œå½±å“æ–¹å·®ä¼°è®¡çš„è´¨é‡ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å¯¹å‡ºç°<code>disocclusionäº‹ä»¶</code>çš„å‰<code>4</code>å¸§è¿›è¡Œç©ºé—´ä¸Šçš„<code>7 * 7</code>åŒè¾¹æ»¤æ³¢ï¼Œè¯¥æ»¤æ³¢æ ¸æƒé‡ç”±æ·±åº¦ï¼Œæ³•çº¿ï¼Œç°åº¦å€¼å†³å®šã€‚åœ¨æ­¤æœŸé—´ä¹Ÿå¯¹<code>illumination</code>åšä¸€æ¬¡<code>Filter</code>ï¼Œä¸¤è€…æ˜¯åŒæ—¶è¿›è¡Œï¼Œå‡ ä¹æ²¡æœ‰é¢å¤–å¼€é”€ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Denoiser_SVGF::VarianceEstimation</span><span class="hljs-params">(<span class="hljs-type">const</span> FrameInfo &amp;frameInfo)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> height = frameInfo.m_beauty.m_height;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> width = frameInfo.m_beauty.m_width;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> radius = <span class="hljs-number">3</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br><br>            <span class="hljs-type">const</span> Float3 ipos = <span class="hljs-built_in">Float3</span>(x, y, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">float</span> h = <span class="hljs-built_in">m_historyLength</span>(ipos.x, ipos.y);<br>            <span class="hljs-keyword">if</span> (h &lt; <span class="hljs-number">4.0</span>)&#123;<span class="hljs-comment">// not enough temporal history available</span><br>                <span class="hljs-type">float</span> sumWIllumination = <span class="hljs-number">0.0</span>;<br>                Float3 sumIllumination = <span class="hljs-built_in">Float3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>                Float3 sumMoments = <span class="hljs-built_in">Float3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>                <span class="hljs-type">const</span> Float3 illuminationCenter = <span class="hljs-built_in">m_accColor</span>(ipos.x, ipos.y);<br>                <span class="hljs-type">const</span> <span class="hljs-type">float</span> lIlluminationCenter = <span class="hljs-built_in">Luminance</span>(illuminationCenter);<br><br>                <span class="hljs-type">const</span> Float3 nCenter = frameInfo.<span class="hljs-built_in">m_normal</span>(ipos.x, ipos.y);<br>                <span class="hljs-type">const</span> <span class="hljs-type">float</span> zCenter = frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x, ipos.y);<br>                <span class="hljs-comment">// depth-gradient estimation from screen-space derivatives</span><br>                <span class="hljs-type">float</span> dgrad_x = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">1e-8</span>, std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x + <span class="hljs-number">1</span>, ipos.y) - zCenter)) * <span class="hljs-number">3.0</span>;<br>                <span class="hljs-type">float</span> dgrad_y = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">1e-8</span>, std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x, ipos.y + <span class="hljs-number">1</span>) - zCenter)) * <span class="hljs-number">3.0</span>;<br>                <span class="hljs-type">float</span> maxDgrad = std::<span class="hljs-built_in">fmax</span>(dgrad_x, dgrad_y);<br><br>                <span class="hljs-comment">// compute first and second moment spatially. This code also applies cross-bilateral</span><br>                <span class="hljs-comment">// filtering on the input illumination.</span><br><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yy = -radius; yy &lt;= radius; yy++) &#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xx = -radius; xx &lt;= radius; xx++) &#123;<br>                        <span class="hljs-type">const</span> Float3 p = ipos + <span class="hljs-built_in">Float3</span>(xx, yy,<span class="hljs-number">0</span>);<br>                        <span class="hljs-type">bool</span> inside = <span class="hljs-literal">false</span>;<br>                        <span class="hljs-keyword">if</span> (p.x &gt;= <span class="hljs-number">0</span> &amp;&amp; p.y &gt;= <span class="hljs-number">0</span> &amp;&amp; p.x &lt; width &amp;&amp; p.y &lt; height)<br>                            inside = <span class="hljs-literal">true</span>;<br><br>                        <span class="hljs-keyword">if</span> (inside) &#123;<br>                            <span class="hljs-type">const</span> Float3 illuminationP = <span class="hljs-built_in">m_accColor</span>(p.x, p.y);<br>                            <span class="hljs-type">const</span> Float3 momentsP = <span class="hljs-built_in">m_moments</span>(p.x, p.y);<br>                            <span class="hljs-type">const</span> <span class="hljs-type">float</span> lIlluminationP = <span class="hljs-built_in">Luminance</span>(illuminationP);<br>                            <span class="hljs-type">const</span> <span class="hljs-type">float</span> zP = frameInfo.<span class="hljs-built_in">m_depth</span>(p.x, p.y);<br>                            <span class="hljs-type">const</span> Float3 nP = frameInfo.<span class="hljs-built_in">m_normal</span>(p.x,p.y);<br><br>                            <span class="hljs-comment">// calculate the normal, depth and luminance weights</span><br>                            <span class="hljs-type">float</span> nw = <span class="hljs-built_in">normalWeight</span>(nCenter, nP);<br>                            <span class="hljs-type">float</span> dw = <span class="hljs-built_in">depthWeight</span>(zCenter, zP, maxDgrad,xx, yy);<br>                            <span class="hljs-type">float</span> lw = <span class="hljs-built_in">luminanceWeight</span>(lIlluminationCenter,<br>                                                       lIlluminationP, <span class="hljs-number">1.0</span>);<br>                            <span class="hljs-type">float</span> w = nw * dw * lw;<br>                            sumWIllumination += w;<br>                            sumIllumination += illuminationP * w;<br>                            sumMoments += momentsP * w;<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// Clamp sum to &gt;0 to avoid NaNs.</span><br>                sumWIllumination = std::<span class="hljs-built_in">fmax</span>(sumWIllumination, <span class="hljs-number">1e-6</span>f);<br>                sumIllumination /= sumWIllumination;<br>                sumMoments /= sumWIllumination;<br><br>                <span class="hljs-comment">// compute variance using the first and second moments</span><br>                <span class="hljs-type">float</span> variance = sumMoments.y - sumMoments.x * sumMoments.x;<br><br>                <span class="hljs-comment">// give the variance a boost for the first frames</span><br>                <span class="hljs-keyword">if</span> (h != <span class="hljs-number">0</span>)<br>                    variance *= <span class="hljs-number">4.0</span> / h;<br><br>                <span class="hljs-built_in">m_tmpColor</span>(ipos.x, ipos.y) = sumIllumination;<br>                <span class="hljs-built_in">m_curFrameVariance</span>(ipos.x, ipos.y) = variance;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// do nothing</span><br>                <span class="hljs-built_in">m_tmpColor</span>(ipos.x, ipos.y) = <span class="hljs-built_in">m_accColor</span>(ipos.x, ipos.y);<br>            &#125;<br>        &#125;<br>    &#125;<br>    std::<span class="hljs-built_in">swap</span>(m_tmpColor, m_accColor);<br>&#125;<br></code></pre></td></tr></table></figure>æœ¬è´¨ä¸Šæ¥è¯´æˆ‘ä»¬åªå¯¹å‡ºç°äº†<code>disocclusionäº‹ä»¶</code>çš„å‰å‡ å¸§è¿›è¡Œç©ºé—´ä¸Šçš„æ–¹å·®ä¼°è®¡ï¼Œç›´åˆ°æ—¶é—´ç´¯ç§¯æ”¶é›†äº†è¶³å¤Ÿçš„æ•°æ®æ¥è¿›è¡Œç¨³å®šçš„ä¼°è®¡ã€‚æƒé‡è®¡ç®—å‡½æ•°åœ¨ä¸‹ä¸€èŠ‚è®²ã€‚</p><h3 id="edge-stopping-functions">Edge-Stopping Functions</h3><h4 id="depth">Depth</h4><p>çœŸå®çš„åœºæ™¯åœ¨å‡ ä½•å°ºåº¦ä¸Šæœ‰å¾ˆå¤§çš„å˜åŒ–ï¼Œå°¤å…¶æ˜¯åœ¨å¼€é˜”çš„æ™¯è§‚ä¸­ã€‚ä½¿å¾—å…¨å±€è¾¹ç¼˜åœæ­¢å‡½æ•°ä¸å—æ§åˆ¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯¹è¡¨é¢æ·±åº¦è®¾å®šäº†ä¸€ä¸ªå±€éƒ¨çº¿æ€§æ¨¡å‹ï¼Œå¹¶ä¸”æµ‹é‡å…¶è¡¨é¢æ·±åº¦çš„åå·®ã€‚æˆ‘ä»¬ä½¿ç”¨å‰ªåˆ‡ç©ºé—´æ·±åº¦ï¼ˆåªè¦æ˜¯çº¿æ€§æ·±åº¦å³å¯ï¼Œæœ¬æ–‡ä½¿ç”¨çš„æ·±åº¦ä¿¡æ¯åº”è¯¥å±äºviewspaceï¼‰çš„å±å¹•ç©ºé—´åå¯¼æ•°æ¥ä¼°è®¡å±€éƒ¨æ·±åº¦æ¨¡å‹ã€‚è¯¥æƒé‡å‡½æ•°ä¸ºï¼š<br /><span class="math display">\[w_{z}=exp(-\dfrac{\left| z(p)-z(q) \right|}{\sigma_{z} \left| \nablaz(p) \cdot (p-q) \right|+\epsilon})\]</span></p><p>æ ¹æ®ç»éªŒ<spanclass="math inline">\(\sigma_{z}\)</span>ä¸º<code>1.0</code>å¯ä»¥å¾—åˆ°æ¯”è¾ƒå¥½çš„æ•ˆæœï¼Œç”¨æ¥æ§åˆ¶æ·±åº¦çš„å½±å“æ˜¯å¤§è¿˜æ˜¯å°ã€‚<span class="math inline">\(\nablaz\)</span>æ˜¯å±å¹•åæ ‡ä¸‹æ·±åº¦çš„æ¢¯åº¦ï¼Œ<spanclass="math inline">\(\epsilon\)</span>æ˜¯é˜²æ­¢é™¤ä»¥é›¶ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">Denoiser_SVGF::depthWeight</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">float</span> center_depth, <span class="hljs-type">const</span> <span class="hljs-type">float</span> depth,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">const</span> <span class="hljs-type">float</span> dgrad, </span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">const</span> <span class="hljs-type">float</span> offset_x, <span class="hljs-type">const</span> <span class="hljs-type">float</span> offset_y)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> eps = <span class="hljs-number">1e-8</span>;<br>    Float3 offset&#123;offset_x, offset_y,<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">exp</span>( (-std::<span class="hljs-built_in">fabs</span>(center_depth - depth)) / (std::<span class="hljs-built_in">fabs</span>( m_phiDepth * dgrad * <span class="hljs-built_in">Length</span>(offset)+ eps)) );<br>&#125;<br></code></pre></td></tr></table></figure> æœ¬åº”è¯¥æ˜¯<span class="math inline">\(\nabla z(p) \cdot(p-q)\)</span>å³æ¢¯åº¦ç‚¹ä¹˜åç§»ï¼Œæ¢¯åº¦å’Œåç§»éƒ½æ˜¯äºŒç»´å‘é‡ã€‚ä½†æ˜¯è¿™é‡Œçš„å†™æ³•æ˜¯ï¼Œå–æ¢¯åº¦ä¸­è¾ƒå¤§çš„ä¸€ä¸ªåå¯¼æ•°ä½œä¸ºä¸€ç»´æ¢¯åº¦å€¼ç„¶åä¹˜ä¸Šåç§»å‘é‡çš„é•¿åº¦ã€‚å…¶ç»“æœç›¸å·®ä¸å¤§ï¼Œè‡³äºè®ºæ–‡æºç ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç®—ç›®å‰ä¸å¾—è€ŒçŸ¥ï¼Œä¸¤ç§ç®—æ³•å¾—åˆ°çš„ç»“æœæˆ‘éƒ½çœ‹äº†ä¸€ä¸‹å‡ ä¹æ²¡åŒºåˆ«ï¼Œè¯»è€…æœ‰å…´è¶£å¯ä»¥å»è¯•ä¸‹ã€‚</p><h4 id="normal">Normal</h4><p>æ³•çº¿æƒé‡æ¯”è¾ƒç®€å•ï¼Œæ³•çº¿å¤¹è§’å°æƒé‡å¤§ï¼Œåä¹‹æƒé‡å°ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br /><span class="math display">\[w_{n}=max(0,n(p)\cdot n(q))^{\sigma_{n}}\]</span> <spanclass="math inline">\(\sigma_{n}\)</span>æŒ‰ç»éªŒæ¥è¯´ä¸º<code>128</code>æ•ˆæœæ¯”è¾ƒå¥½ï¼Œç”¨æ¥æ§åˆ¶æ³•çº¿çš„æƒé‡ã€‚<br />ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">Denoiser_SVGF::normalWeight</span><span class="hljs-params">(<span class="hljs-type">const</span> Float3 &amp;center_normal, <span class="hljs-type">const</span> Float3 &amp;normal)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">pow</span>(std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">0.0</span>, <span class="hljs-built_in">Dot</span>(center_normal, normal)), m_phiNormal);<br>&#125;<br></code></pre></td></tr></table></figure></p><h4 id="luminance">Luminance</h4><p>äº®åº¦è¾¹ç¼˜åœæ­¢å‡½æ•°çš„ä¸€ä¸ªå…³é”®æ–¹é¢æ˜¯å®ƒèƒ½å¤Ÿé€šè¿‡å…¶å±€éƒ¨æ ‡å‡†å·®é‡æ–°å½’ä¸€åŒ–äº®åº¦ï¼Œæ¥è‡ªåŠ¨é€‚åº”æ‰€æœ‰äº®åº¦ã€‚ä½†æ˜¯ï¼Œåœ¨ä½æ ·æœ¬æ•°ä¸‹æ“ä½œä¼šåœ¨æˆ‘ä»¬å¯¹æ–¹å·®å’Œæ ‡å‡†å·®çš„ä¼°è®¡ä¸­å¼•å…¥ä¸ç¨³å®šæ€§ï¼›è¿™å¯èƒ½ä¼šå¼•å…¥èµ°æ ·ç°è±¡ã€‚ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>3 * 3</code>é«˜æ–¯æ ¸å¯¹æ–¹å·®å›¾åƒè¿›è¡Œé¢„æ»¤æ³¢ï¼Œè¿™æ˜¾è‘—æé«˜äº†é‡å»ºè´¨é‡ã€‚äº®åº¦è¾¹ç¼˜åœæ­¢å‡½æ•°å˜ä¸ºï¼š<br /><span class="math display">\[w_{l}=exp(-\dfrac{|l_{i}(p)-l_{i}(q)|}{\sigma_{l}\sqrt{g_{3\times3}(Var(l_{i}(p)))}+\epsilon})\]</span> æ ¹æ®ç»éªŒ<spanclass="math inline">\(\sigma_{l}\)</span>ä¸º<code>4</code>æ•ˆæœæ¯”è¾ƒå¥½ï¼Œç”¨äºæ§åˆ¶äº®åº¦çš„å½±å“ã€‚<br />ç”±äºäº®åº¦æ–¹å·®å¾€å¾€ä¼šéšç€åç»­è¿­ä»£è€Œå‡å°‘ï¼Œå› æ­¤<spanclass="math inline">\(w_{l}\)</span>çš„å½±å“ä¼šéšç€æ¯æ¬¡è¿­ä»£è€Œå¢åŠ ï¼Œä»è€Œé˜²æ­¢è¿‡åº¦æ¨¡ç³Šã€‚<br />éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªé«˜æ–¯é¢„æ»¤æ³¢å™¨ä»…ç”¨äºé©±åŠ¨äº®åº¦è¾¹ç¼˜åœæ­¢å‡½æ•°ï¼Œè€Œä¸ç”¨äºä¼ æ’­åˆ°å°æ³¢å˜æ¢ä¸‹çš„ä¸€æ¬¡è¿­ä»£çš„æ–¹å·®ä¸­ã€‚<br />ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">Denoiser_SVGF::computeVarianceCenter</span><span class="hljs-params">(<span class="hljs-type">const</span> Float3&amp; ipos,<span class="hljs-type">const</span> <span class="hljs-type">int</span> width,<span class="hljs-type">const</span> <span class="hljs-type">int</span> height)</span> </span>&#123;<br>    <span class="hljs-type">float</span> sum = <span class="hljs-number">0.f</span>;<br>    <br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> kernel[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>] = &#123;&#123;<span class="hljs-number">1.0</span> / <span class="hljs-number">4.0</span>, <span class="hljs-number">1.0</span> / <span class="hljs-number">8.0</span>&#125;, &#123;<span class="hljs-number">1.0</span> / <span class="hljs-number">8.0</span>, <span class="hljs-number">1.0</span> / <span class="hljs-number">16.0</span>&#125;&#125;;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> radius = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yy = -radius; yy &lt;= radius; yy++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xx = -radius; xx &lt;= radius; xx++) &#123;<br>            Float3 p = ipos + <span class="hljs-built_in">Float3</span>(xx, yy,<span class="hljs-number">0</span>);<br>            p.x = std::<span class="hljs-built_in">fmin</span>(std::<span class="hljs-built_in">fmax</span>(p.x, <span class="hljs-number">0.0</span>), width - <span class="hljs-number">1.0</span>);<br>            p.y = std::<span class="hljs-built_in">fmin</span>(std::<span class="hljs-built_in">fmax</span>(p.y, <span class="hljs-number">0.0</span>), height - <span class="hljs-number">1.0</span>);<br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> k = kernel[std::<span class="hljs-built_in">abs</span>(xx)][std::<span class="hljs-built_in">abs</span>(yy)];<br>            sum += <span class="hljs-built_in">m_curFrameVariance</span>(p.x,p.y) * k;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> variance = <span class="hljs-built_in">computeVarianceCenter</span>(ipos,width,height);<br><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">Denoiser_SVGF::luminanceWeight</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">float</span> center_lum, <span class="hljs-type">const</span> <span class="hljs-type">float</span> lum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-type">const</span> <span class="hljs-type">float</span> variance</span></span><br><span class="hljs-params"><span class="hljs-function">)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> eps = <span class="hljs-number">1e-10</span>;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">exp</span>( (-std::<span class="hljs-built_in">fabs</span>(center_lum - lum)) /<br>               (m_phiColor * std::<span class="hljs-built_in">sqrt</span>(std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">0.0</span>, variance) + eps)));<br>&#125;<br></code></pre></td></tr></table></figure> <code>kernel</code>æ˜¯ <spanclass="math inline">\(\sigma\)</span>ä¸º0.8çš„é«˜æ–¯æ»¤æ³¢æ ¸ï¼Œä¸Šæ–‡æœ‰æåˆ°ã€‚</p><h3 id="edge-avoiding-a-trous-wavelet-transform">Edge-avoiding A-trouswavelet transform</h3><p><code>Reconstruction Filter</code>çš„æœ€åæœ€é‡è¦çš„ä¸€æ­¥ï¼Œ<code>Reproject</code>ï¼ˆTemporalFilteringï¼‰ä»¥åŠ<code>Variance Estimation</code>éƒ½æ˜¯ä¸ºäº†è¿™ä¸€æ­¥åšé“ºå«ã€‚ä¸Šæ–‡è¯´åˆ°å…‰æ …åŒ–çš„<code>G-buffer</code>ä¸åŒ…å«éšæœºå™ªå£°ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨<code>G-buffer</code>æ¥å®šä¹‰è¾¹ç¼˜åœæ­¢å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯ä»¥ç”¨æ¥é‰´åˆ«åƒç´ æ˜¯å¦åœ¨åŒä¸€è¡¨é¢ï¼Œä»è€Œè¿›è¡Œç›¸äº’è´¡çŒ®ã€‚è¯¥è®ºæ–‡çš„å®ç°ä¹Ÿä½¿ç”¨äº†<code>A-trous wavelet</code>æ–¹æ³•ï¼ˆä¸Šæ–‡æœ‰æåŠï¼‰ï¼Œæƒé‡å‡½æ•°<spanclass="math inline">\(w(p,q)\)</span>ä½¿ç”¨çš„æ˜¯ä¸€ä¸ª<code>5 * 5</code>çš„è”åˆåŒè¾¹æ»¤æ³¢æ ¸ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br /><span class="math display">\[\hat{c}_{i+1}(p)=\dfrac{\sum_{q\in\Omega}h(q)\cdotw(p,q)\cdot\hat{c}_{i}(q)}{\sum_{q\in\Omega}h(q)\cdot w(p,q)}\]</span></p><p><spanclass="math inline">\(h(q)\)</span>æ˜¯ä¸€ä¸ªç±»é«˜æ–¯æ»¤æ³¢æ ¸ï¼Œè®ºæ–‡å’Œæœ¬æ­¤å®ç°ä½¿ç”¨çš„<spanclass="math inline">\(h(q)\)</span>æƒé‡ç³»æ•°ä¸å¤ªä¸€æ ·ä¸è¿‡æ²¡å…³ç³»ï¼Œéƒ½æ˜¯éšè·ç¦»è¡°å‡çš„å‡½æ•°å°±è¡Œã€‚<spanclass="math inline">\(\Omega\)</span>æ˜¯æ»¤æ³¢å™¨ä¸­è¢«æ”¶é›†çš„åƒç´ é›†åˆï¼ˆå°±æ˜¯æ¯ä¸€è¶Ÿä¸­è¸©åˆ°çš„åƒç´ ç‚¹çš„é›†åˆï¼‰<br /><span class="math inline">\(\hat{c}_{i+1}(p)\)</span>å’Œ <spanclass="math inline">\(\hat{c}_{i}(q)\)</span>åˆ™æ˜¯æ»¤æ³¢åçš„è¾“å‡ºé¢œè‰²ä»¥åŠpç‚¹é™„è¿‘qç‚¹çš„åƒç´ é¢œè‰²ã€‚</p><p>è¯¥è®ºæ–‡æ–°é¢–çš„æƒé‡å‡½æ•° <spanclass="math inline">\(w(p,q)\)</span>ä½¿ç”¨çš„æ˜¯æ·±åº¦ã€ä¸–ç•Œç©ºé—´æ³•çº¿ä»¥åŠ<code>Filter</code>åè¾“å…¥çš„<code>Luminance</code>ï¼Œå…¬å¼å¦‚ä¸‹ï¼š<br /><span class="math display">\[w_{i}(p,q)=w_{z}\cdot w_{n}\cdot w_{l}\]</span> è¿™å‡ ä¸ªå‡½æ•°åœ¨ä¸Šä¸€èŠ‚æˆ‘å·²ç»è¯¦ç»†è§£é‡Šäº†ã€‚</p><p>åœ¨åº”ç”¨<code>A-trous wavelet</code>è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šåŸºäºäº®åº¦æ–¹å·®çš„å±€éƒ¨ä¼°è®¡æ¥è°ƒæ•´äº®åº¦è¾¹ç¼˜åœæ­¢å‡½æ•°ã€‚ç„¶åæ ¹æ®<code>A-trous wavelet</code>æ¥<code>Filter</code>æ—¶é—´ä¸Šç´¯è®¡çš„é¢œè‰²ï¼Œå¹¶å‡è®¾æˆ‘ä»¬é‡‡æ ·åˆ°çš„æ–¹å·®æ ·æœ¬æ˜¯ä¸ç›¸å…³çš„ï¼ˆç›¸äº’ç‹¬ç«‹ï¼‰ï¼Œåˆ™æˆ‘ä»¬å‘ä¸‹ä¸€æ¬¡<code>A-trous wavelet</code>ä¼ é€’æ–¹å·®çš„å…¬å¼ä¸ºï¼š<br /><span class="math display">\[Var(\hat{c}_{i+1}(p))=\dfrac{\sum_{q\in\Omega}h(q)^{2}\cdotw(p,q)^{2}\cdot Var(\hat{c}_{i}(q))}{(\sum_{q\in\Omega}h(q)\cdotw(p,q))^{2}}\]</span>æˆ‘ä»¬ä¼šä½¿ç”¨è¿™ä¸ªç»“æœæ¥æ§åˆ¶ä¸‹ä¸€æ¬¡<code>A-trous wavelet</code>çš„è¾¹ç¼˜åœæ­¢å‡½æ•°ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Denoiser_SVGF::ATrousWaveletFilter</span><span class="hljs-params">(<span class="hljs-type">const</span> FrameInfo &amp;frameInfo,<span class="hljs-type">const</span> <span class="hljs-type">int</span> stepSize)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> height = frameInfo.m_beauty.m_height;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> width = frameInfo.m_beauty.m_width;<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> kernelWeights[<span class="hljs-number">3</span>] = &#123;<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span> / <span class="hljs-number">3.0</span>, <span class="hljs-number">1.0</span> / <span class="hljs-number">6.0</span>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> SVGF</span><br>            <span class="hljs-type">const</span> Float3 ipos = <span class="hljs-built_in">Float3</span>(x, y, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">const</span> Float3 illuminationCenter = <span class="hljs-built_in">m_accColor</span>(ipos.x, ipos.y);<br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> lIlluminationCenter = <span class="hljs-built_in">Luminance</span>(illuminationCenter);<br><br>            <span class="hljs-comment">//variance,filtered using 3 * 3 gaussin blur</span><br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> var = <span class="hljs-built_in">computeVarianceCenter</span>(ipos,width,height);<br><br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> zCenter = frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x, ipos.y);<br>            <span class="hljs-type">const</span> Float3 nCenter = frameInfo.<span class="hljs-built_in">m_normal</span>(ipos.x, ipos.y);<br><br>            <span class="hljs-type">float</span> dgrad_x = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">1e-8</span>, std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x + <span class="hljs-number">1</span>, ipos.y) - zCenter)) * stepSize;<br>            <span class="hljs-type">float</span> dgrad_y = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">1e-8</span>, std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x, ipos.y + <span class="hljs-number">1</span>) - zCenter)) * stepSize;<br>            <br>            <span class="hljs-type">float</span> maxDgrad = std::<span class="hljs-built_in">fmax</span>(dgrad_x, dgrad_y);<br><br>            <span class="hljs-comment">//explicitly store/accumulate center pixel with weight 1 to prevent issues</span><br>            <span class="hljs-comment">//with the edge-stopping functions</span><br>            <span class="hljs-type">float</span> sumWIllumination = <span class="hljs-number">1.0</span>;<br>            <span class="hljs-type">float</span> sumVariance = <span class="hljs-built_in">m_curFrameVariance</span>(ipos.x, ipos.y);<br>            Float3 sumIllumination = illuminationCenter;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yy = <span class="hljs-number">-2</span>; yy &lt;= <span class="hljs-number">2</span>; yy++) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xx = <span class="hljs-number">-2</span>; xx &lt;= <span class="hljs-number">2</span>; xx++) &#123;<br>                    <span class="hljs-type">const</span> Float3 p = ipos + <span class="hljs-built_in">Float3</span>(xx, yy,<span class="hljs-number">0</span>) * stepSize;<br>                    <span class="hljs-type">bool</span> inside = <span class="hljs-literal">false</span>;<br>                    <span class="hljs-keyword">if</span> (p.x &gt;= <span class="hljs-number">0</span> &amp;&amp; p.y &gt;= <span class="hljs-number">0</span> &amp;&amp; p.x &lt; width &amp;&amp; p.y &lt; height)<br>                        inside = <span class="hljs-literal">true</span>;<br><br>                    <span class="hljs-type">const</span> <span class="hljs-type">float</span> kernel = kernelWeights[std::<span class="hljs-built_in">abs</span>(xx)] * kernelWeights[std::<span class="hljs-built_in">abs</span>(yy)];<br><br>                    <span class="hljs-keyword">if</span> (inside &amp;&amp;<br>                        (xx != <span class="hljs-number">0</span> ||<br>                         yy != <span class="hljs-number">0</span>)) <span class="hljs-comment">// skip center pixel, it is already accumulated</span><br>                    &#123;<br>                        <span class="hljs-type">const</span> Float3 illuminationP = <span class="hljs-built_in">m_accColor</span>(p.x,p.y);<br>                        <span class="hljs-type">const</span> <span class="hljs-type">float</span> lIlluminationP = <span class="hljs-built_in">Luminance</span>(illuminationP);<br>                        <span class="hljs-type">const</span> <span class="hljs-type">float</span> zP = frameInfo.<span class="hljs-built_in">m_depth</span>(p.x,p.y);<br>                        <span class="hljs-type">const</span> Float3 nP = frameInfo.<span class="hljs-built_in">m_normal</span>(p.x,p.y);<br>                        <span class="hljs-type">const</span> <span class="hljs-type">float</span> varP = <span class="hljs-built_in">m_curFrameVariance</span>(p.x,p.y);<br><br>                        <span class="hljs-comment">// calculate the normal, depth and luminance weights</span><br>                        <span class="hljs-type">float</span> nw = <span class="hljs-built_in">normalWeight</span>(nCenter, nP);<br>                        <span class="hljs-type">float</span> dw = <span class="hljs-built_in">depthWeight</span>(zCenter, zP, maxDgrad, xx, yy);<br>                        <span class="hljs-type">float</span> lw = <span class="hljs-built_in">luminanceWeight</span>(lIlluminationCenter, lIlluminationP, var);<br><br>                        <span class="hljs-type">const</span> <span class="hljs-type">float</span> wIllumination = nw * dw * lw * kernel;<br><br>                        <span class="hljs-comment">// alpha channel contains the variance, therefore the weights need</span><br>                        <span class="hljs-comment">// to be squared, see paper for the formula(4.3 (1) (2))</span><br>                        sumWIllumination += wIllumination;<br>                        sumIllumination += <span class="hljs-built_in">Float3</span>(wIllumination) * illuminationP;<br>                        sumVariance += wIllumination * wIllumination * varP;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// renormalization is different for variance, check paper for the formula</span><br>            <span class="hljs-built_in">m_tmpColor</span>(ipos.x, ipos.y) = sumIllumination / sumWIllumination;<br>            <span class="hljs-built_in">m_tmpCurFrameVar</span>(ipos.x, ipos.y) = sumVariance / (sumWIllumination * sumWIllumination);<br>        &#125;<br>    &#125;<br>    std::<span class="hljs-built_in">swap</span>(m_tmpColor,m_accColor);<br>    std::<span class="hljs-built_in">swap</span>(m_tmpCurFrameVar,m_curFrameVariance);<br>&#125;<br></code></pre></td></tr></table></figure> <code>Step Size</code>ä¸º<spanclass="math inline">\(2^{i},i\in([0,4] \cap \mathbb{Z})\)</span></p><p>Cornell Boxæ•ˆæœå¦‚ä¸‹ï¼š<br /><img src="/img/00019/box-svgf.gif" alt="24" /><br />Pink Roomæ•ˆæœå¦‚ä¸‹:<br /><img src="/img/00019/pinkroom-svgf.gif" alt="25" /><br />è¿™æ˜¯é™å™ªå‰çš„å›¾ç‰‡ï¼š<br /><img src="/img/00019/image-10.png" alt="26" /><br /><img src="/img/00019/image-11.png" alt="27" /></p>]]></content>
    
    
    <categories>
      
      <category>Games202</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Games202 Hw4 IBL and Kulla Conty</title>
    <link href="/2023/07/01/00018.%20Games202%20Hw4/"/>
    <url>/2023/07/01/00018.%20Games202%20Hw4/</url>
    
    <content type="html"><![CDATA[<h1 id="æœ€ç»ˆæ•ˆæœå›¾">æœ€ç»ˆæ•ˆæœå›¾</h1><p>æ¯ç»„ä¸‹é¢ä¸€æ’çƒæ˜¯æ²¡ç”¨<code>Kulla Conty</code>çš„å¯¹ç…§ç»„ï¼Œæ‰€æœ‰çƒçš„é‡‘å±åº¦éƒ½ä¸º<code>1</code>,ç²—ç³™åº¦æœ€å°<code>0.05</code>ï¼Œæœ€å¤§<code>0.95</code>,å¯ä»¥æ˜æ˜¾çœ‹åˆ°å¯¹ç…§ç»„éšç€ç²—ç³™åº¦å¢å¤§ï¼Œä¼šè¶Šæ¥è¶Šæš—ï¼Œè€Œä½¿ç”¨äº†<code>Kulla Conty</code>çš„å®éªŒç»„ï¼Œäº®åº¦ä¸ä¼šéšç€ç²—ç³™åº¦çš„å¢åŠ è€Œè¡°å‡ï¼Œä¸ºäº†ä½¿ç°è±¡æ›´æ˜æ˜¾è¿™é‡Œå§<code>HDR tonemapping</code>åŠŸèƒ½ç¦ç”¨äº†ï¼<img src="/img/00018/result.png" alt="0" /><br />ä¸‹é¢æ˜¯é‡‘æè´¨çš„<code>Kulla-Conty Approximation</code>æ•ˆæœï¼š<br /><img src="/img/00018/image-15.png" alt="1" /></p><h1 id="ä½œä¸šæ€»è§ˆ">ä½œä¸šæ€»è§ˆ</h1><ol type="1"><li>å®ç°é¢„è®¡ç®—<span class="math inline">\(E(\mu)\)</span></li><li>å®ç°é¢„è®¡ç®—<span class="math inline">\(E_{avg}\)</span></li><li>æ­£ç¡®å®ç°PBRæè´¨</li><li>æ­£ç¡®å®ç°Kulla-Contyæè´¨</li><li>æé«˜1ï¼šå®ç°é‡è¦æ€§é‡‡æ ·çš„é¢„è®¡ç®—æ–¹æ³•<br /></li><li>æé«˜2ï¼šåœ¨é¢„è®¡ç®—<spanclass="math inline">\(E(\mu)\)</span>æ—¶ï¼Œä½¿ç”¨<code>Split Sum</code>å®Œæˆé¢„è®¡ç®—å·¥ä½œ</li></ol><p>ä¸ªäººæ‰©å±•éƒ¨åˆ†ï¼š<code>Image Based Lighting</code></p><h1 id="æºç ">æºç </h1><p>æš‚æœªå…¬å¼€</p><h1 id="webglä»£ç æ¡†æ¶çš„ç†è§£">Webglä»£ç æ¡†æ¶çš„ç†è§£</h1><p>è¿™éƒ¨åˆ†ä»£ç ä¸»è¦è§£é‡Šæˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œå¤ªè¿‡äºç»†èŠ‚çš„åœ°æ–¹æœ¬èŠ‚å†…å®¹ä¸åšè§£é‡Šï¼Œåªå»ç†è§£é‚£äº›èƒ½å¸®åŠ©æˆ‘å®ç°æƒ³è¦æ•ˆæœçš„ä»£ç ã€‚</p><h2 id="æ¨¡å‹åŠ è½½">æ¨¡å‹åŠ è½½</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> pbrSphere1Transform = <span class="hljs-title function_">setTransform</span>(<span class="hljs-number">360</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">180</span>, <span class="hljs-number">180</span>, <span class="hljs-number">180</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-number">0</span>);<br><span class="hljs-title function_">loadGLTF</span>(renderer, <span class="hljs-string">&#x27;assets/ball/&#x27;</span>, <span class="hljs-string">&#x27;ball&#x27;</span>, <span class="hljs-string">&#x27;PBRMaterial&#x27;</span>, pbrSphere1Transform,irradianceMap,prefilterMap,pbrBrdfLutObj,metallic,<span class="hljs-number">0.95</span>);<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">loadGLTF</span>(<span class="hljs-params">renderer, path, name, objMaterial, transform,irradianceMap,prefilterMap,pbrBrdfLut, metallic=<span class="hljs-number">1.0</span>, roughness=<span class="hljs-number">0.2</span></span>)&#123;<br>    ...<br><span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">GLTFLoader</span>(manager)<br>.<span class="hljs-title function_">setPath</span>(path)<br>.<span class="hljs-title function_">load</span>(name + <span class="hljs-string">&#x27;.gltf&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf</span>) &#123;<br>gltf.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">child</span>) &#123;<br><span class="hljs-keyword">if</span> (child.<span class="hljs-property">isMesh</span>) &#123;<br>                    ...<br><span class="hljs-keyword">let</span> colorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Texture</span>(renderer.<span class="hljs-property">gl</span>);<br>...<br>                    <span class="hljs-comment">//gold : 0.94423,0.77611,0.37217</span><br>                    <span class="hljs-keyword">let</span> kd = [<span class="hljs-number">1.00</span>,<span class="hljs-number">1.00</span>, <span class="hljs-number">1.00</span>]; <span class="hljs-comment">//albedo</span><br>                    colorMap.<span class="hljs-title class_">CreateConstantTexture</span>(renderer.<span class="hljs-property">gl</span>, kd, <span class="hljs-literal">true</span>);<br><span class="hljs-keyword">let</span> material;<br><span class="hljs-keyword">switch</span> (objMaterial) &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;KullaContyMaterial&#x27;</span>:<br>material = <span class="hljs-title function_">buildKullaContyMaterial</span>(colorMap,metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut,kullaContyBrdflut,kullaContyEavglut,<span class="hljs-string">&quot;./src/shaders/kullaContyShader/KullaContyVertex.glsl&quot;</span>, <span class="hljs-string">&quot;./src/shaders/kullaContyShader/KullaContyFragment.glsl&quot;</span>);<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;PBRMaterial&#x27;</span>:<br>material = <span class="hljs-title function_">buildPBRMaterial</span>(colorMap,metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut,<span class="hljs-string">&quot;./src/shaders/pbrShader/PBRVertex.glsl&quot;</span>, <span class="hljs-string">&quot;./src/shaders/pbrShader/PBRFragment.glsl&quot;</span>);<br><span class="hljs-keyword">break</span>;<br>&#125;<br>material.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">let</span> meshRender = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshRender</span>(renderer.<span class="hljs-property">gl</span>, mesh, data,objMaterial);<br>renderer.<span class="hljs-title function_">addMeshRender</span>(meshRender);<br>&#125;);<br>&#125;<br>&#125;);<br>&#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¨¡å‹åŠ è½½ä¸»è¦å°±çœ‹è¿™éƒ¨åˆ†ï¼Œæ‰“äº†çœç•¥çš„éƒ¨åˆ†ä¸éœ€è¦å»ç†è§£ã€‚<br /><code>colorMap</code>è·å–åˆ›å»ºçš„çº¹ç†<code>ID</code>,<code>kD</code>æ˜¯<code>albedo</code>ï¼Œåªä¸ºäº†è§‚å¯Ÿèƒ½é‡æŸå¤±å’Œè¡¥å……ç›´æ¥å¡«<code>1.0</code>å°±è¡Œï¼Œ<code>CreateConstantTexture</code>ç”¨<code>albedo</code>åˆ›å»ºä¸€å¼ å®½é«˜ä¸º<code>1</code>çš„çº¹ç†ã€‚<br /><code>buildKullaContyMaterial</code>æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå‡½æ•°æ‰§è¡Œå®Œæˆåå°±ä¼šè¿›å…¥å›è°ƒéƒ¨åˆ†<code>material.then((data))</code>,<code>data</code>æ‰æ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚<br /><code>child.isMesh</code>ä¼šåˆ¤æ–­æ¨¡å‹çš„å­èŠ‚ç‚¹æ˜¯å¦ä¸º<code>mesh</code>èŠ‚ç‚¹ï¼Œç»è¿‡<code>debug</code>å‘ç°ï¼Œè¯¥<code>ball</code>æ¨¡å‹æœ‰<code>4</code>ä¸ªå­èŠ‚ç‚¹ï¼Œä¹Ÿå°±è¯´ä¼šè¿›å…¥å›è°ƒéƒ¨åˆ†<code>material.then((data))</code>4æ¬¡ã€‚</p><h2 id="shaderç¼–è¯‘">shaderç¼–è¯‘</h2><p>åœ¨ç†è§£æ¡†æ¶<code>shader</code>ç¼–è¯‘ä¹‹å‰éœ€è¦æŠŠæè´¨ç±»å‹ç†Ÿæ‚‰ä¸€ä¸‹ï¼Œä»¥<code>PBRMaterial.js</code>ä¸ºä¾‹:<br /><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Material</span> &#123;<br>    #flatten_uniforms;<br>    #flatten_attribs;<br>    #vsSrc;<br>    #fsSrc;<br>    <span class="hljs-comment">// Uniforms is a map, attribs is a Array</span><br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">uniforms, attribs, vsSrc, fsSrc, frameBuffer</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">uniforms</span> = uniforms;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">attribs</span> = attribs;<br>        <span class="hljs-variable language_">this</span>.#vsSrc = vsSrc;<br>        <span class="hljs-variable language_">this</span>.#fsSrc = fsSrc;<br><br>        <span class="hljs-variable language_">this</span>.#flatten_uniforms = [<span class="hljs-string">&#x27;uViewMatrix&#x27;</span>,<span class="hljs-string">&#x27;uModelMatrix&#x27;</span>, <span class="hljs-string">&#x27;uProjectionMatrix&#x27;</span>, <span class="hljs-string">&#x27;uCameraPos&#x27;</span>, <span class="hljs-string">&#x27;uLightPos&#x27;</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k <span class="hljs-keyword">in</span> uniforms) &#123;<br>            <span class="hljs-variable language_">this</span>.#flatten_uniforms.<span class="hljs-title function_">push</span>(k);<br>        &#125;<br>        <span class="hljs-variable language_">this</span>.#flatten_attribs = attribs;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> = frameBuffer;<br>    &#125;<br>    <span class="hljs-title function_">setMeshAttribs</span>(<span class="hljs-params">extraAttribs</span>) &#123;<br>    <br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; extraAttribs.<span class="hljs-property">length</span>; i++) &#123;<br>            <span class="hljs-variable language_">this</span>.#flatten_attribs.<span class="hljs-title function_">push</span>(extraAttribs[i]);<br>        &#125;<br>    &#125;<br>    <span class="hljs-title function_">compile</span>(<span class="hljs-params">gl</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shader</span>(gl, <span class="hljs-variable language_">this</span>.#vsSrc, <span class="hljs-variable language_">this</span>.#fsSrc,<br>            &#123;<br>                <span class="hljs-attr">uniforms</span>: <span class="hljs-variable language_">this</span>.#flatten_uniforms,<br>                <span class="hljs-attr">attribs</span>: <span class="hljs-variable language_">this</span>.#flatten_attribs<br>            &#125;);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PBRMaterial</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Material</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">albedo, metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut, vertexShader, fragmentShader</span>) &#123;<br>        <span class="hljs-variable language_">super</span>(&#123;<br>            <span class="hljs-string">&#x27;uAlbedoMap&#x27;</span>:          &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;texture&#x27;</span>, <span class="hljs-attr">value</span>: albedo &#125;,<br>            <span class="hljs-string">&#x27;uMetallic&#x27;</span>:        &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;1f&#x27;</span>, <span class="hljs-attr">value</span>: metallic &#125;,<br>            ...<br>            <span class="hljs-comment">// &#x27;uLightPos[4]&#x27;: &#123; type: &#x27;3fv&#x27;, value: null &#125;,</span><br>            <span class="hljs-comment">// &#x27;uLightColors[4]&#x27;: &#123; type: &#x27;3fv&#x27;, value: null &#125;,</span><br>        &#125;, [], vertexShader, fragmentShader);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildPBRMaterial</span>(<span class="hljs-params">albedo, metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut, vertexPath, fragmentPath</span>) &#123;<br>    <span class="hljs-keyword">let</span> vertexShader = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getShaderString</span>(vertexPath);<br>    <span class="hljs-keyword">let</span> fragmentShader = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getShaderString</span>(fragmentPath);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PBRMaterial</span>(albedo, metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut, vertexShader, fragmentShader);<br>&#125;<br></code></pre></td></tr></table></figure>å„ç§æè´¨ç±»éƒ½æ˜¯ç»§æ‰¿è‡ªçˆ¶ç±»<code>Material</code>,å­ç±»éƒ¨åˆ†åªè´Ÿè´£å¡«å†™å¯¹åº”<code>shader</code>éœ€è¦<code>uniform</code>çš„å˜é‡ï¼Œå­ç±»ç”¨<code>super</code>å…³é”®å­—æ¥å¯¹çˆ¶ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œéšåå¡«å†™<code>uniform</code>æ•°æ®å…¨éƒ¨è¢«ä¿å­˜å…¥çˆ¶ç±»ç§æœ‰å˜é‡<code>#flatten_uniforms</code>ä¸­ï¼Œçˆ¶ç±»è¿˜åŒ…å«äº†ä¸€äº›å¸¸ç”¨<code>uniform</code>å˜é‡<code>'uViewMatrix','uModelMatrix'...</code>,è¿™äº›åå­—åœ¨ä¸åŒçš„<code>vertex</code>å’Œ<code>fragment</code>ä¸­åå­—éƒ½æ˜¯ç»Ÿä¸€çš„,å¯è‡ªè¡Œä¿®æ”¹ï¼Œæ•°ç»„<code>uniform</code>å˜é‡éœ€è¦è‡ªå·±æ‰‹åŠ¨è®¾ç½®ï¼Œæ¡†æ¶æ²¡æœ‰å¯¹è¿™ç±»å˜é‡è¿›è¡Œè§£æã€‚<br /><code>this.#vsSrc</code>å’Œ<code>this.#fsSrc</code>ä¿å­˜çš„<code>shader</code>æ–‡ä»¶è·¯å¾„ï¼Œ<code>#this.attribs</code>ä¿å­˜çš„<code>vertexShader</code>çš„<code>location</code>å˜é‡åå­—ï¼Œæ¯”å¦‚:<br /><code>layout (location = 0) in vec3 aVertexPosition;</code>ä¸­çš„<code>aVertexPosition</code>ï¼Œæ‰€ä»¥åœ¨<code>vertexShader</code>ä¸­ä¸è¦æ›´æ”¹å®ƒçš„åå­—ï¼Œåå­—éƒ½æ˜¯æ¥æºäº<code>mesh</code>èŠ‚ç‚¹ï¼Œåœ¨<code>MeshRender.js</code>æ–‡ä»¶ä¸­ä¼šåˆ¤æ–­<code>mesh</code>èŠ‚ç‚¹æ˜¯å¦åŒ…å«è¯¥å±æ€§åå­—ï¼Œæœ‰çš„è¯å°±è°ƒç”¨è¯¥æè´¨çš„<code>setMeshAttribs</code>å‡½æ•°å°†åå­—å­˜å…¥<code>#this.attribs</code>ã€‚<br />åœ¨è°ƒç”¨<code>compile()</code>å‡½æ•°çš„æ—¶å€™ï¼Œ<code>shader</code>è·¯å¾„ï¼Œ<code>uniform</code>å˜é‡åï¼Œ<code>attribs</code>å˜é‡åå­—ä¼šä¸€åŒä¼ å…¥<code>new</code>å‡ºæ¥çš„<code>shader</code>å¯¹è±¡ã€‚<br /><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Shader</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">gl, vsSrc, fsSrc, shaderLocations</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span> = gl;<br>        <span class="hljs-keyword">const</span> vs = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compileShader</span>(vsSrc, gl.<span class="hljs-property">VERTEX_SHADER</span>);<br>        <span class="hljs-keyword">const</span> fs = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compileShader</span>(fsSrc, gl.<span class="hljs-property">FRAGMENT_SHADER</span>);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">program</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addShaderLocations</span>(&#123;<br>            <span class="hljs-attr">glShaderProgram</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">linkShader</span>(vs, fs),<br>        &#125;, shaderLocations);<br>    &#125;<br>    <span class="hljs-title function_">compileShader</span>(<span class="hljs-params">shaderSource, shaderType</span>) &#123;<br>        <span class="hljs-keyword">const</span> gl = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span>;<br>        <span class="hljs-keyword">var</span> shader = gl.<span class="hljs-title function_">createShader</span>(shaderType);<br>        ...<br>        <span class="hljs-keyword">return</span> shader;<br>    &#125;;<br>    <span class="hljs-title function_">linkShader</span>(<span class="hljs-params">vs, fs</span>) &#123;<br>        <span class="hljs-keyword">const</span> gl = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span>;<br>        <span class="hljs-keyword">var</span> prog = gl.<span class="hljs-title function_">createProgram</span>();<br>        ...<br>        <span class="hljs-keyword">return</span> prog;<br>    &#125;;<br>    <span class="hljs-title function_">addShaderLocations</span>(<span class="hljs-params">result, shaderLocations</span>) &#123;<br>        <span class="hljs-keyword">const</span> gl = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span>;<br>        result.<span class="hljs-property">uniforms</span> = &#123;&#125;;<br>        result.<span class="hljs-property">attribs</span> = &#123;&#125;;<br>        <span class="hljs-keyword">if</span> (shaderLocations &amp;&amp; shaderLocations.<span class="hljs-property">uniforms</span> &amp;&amp; shaderLocations.<span class="hljs-property">uniforms</span>.<span class="hljs-property">length</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shaderLocations.<span class="hljs-property">uniforms</span>.<span class="hljs-property">length</span>; ++i) &#123;<br>                result.<span class="hljs-property">uniforms</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(result.<span class="hljs-property">uniforms</span>, &#123;<br>                    [shaderLocations.<span class="hljs-property">uniforms</span>[i]]: gl.<span class="hljs-title function_">getUniformLocation</span>(result.<span class="hljs-property">glShaderProgram</span>, shaderLocations.<span class="hljs-property">uniforms</span>[i]),<br>                &#125;);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (shaderLocations &amp;&amp; shaderLocations.<span class="hljs-property">attribs</span> &amp;&amp; shaderLocations.<span class="hljs-property">attribs</span>.<span class="hljs-property">length</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shaderLocations.<span class="hljs-property">attribs</span>.<span class="hljs-property">length</span>; ++i) &#123;<br>                result.<span class="hljs-property">attribs</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(result.<span class="hljs-property">attribs</span>, &#123;<br>                    [shaderLocations.<span class="hljs-property">attribs</span>[i]]: gl.<span class="hljs-title function_">getAttribLocation</span>(result.<span class="hljs-property">glShaderProgram</span>, shaderLocations.<span class="hljs-property">attribs</span>[i]),<br>                &#125;);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>shaderå¯¹è±¡åœ¨æ„é€ å‡½æ•°ä¸­å°±å®Œæˆäº†æ‰€æœ‰äº‹æƒ…ï¼Œ<code>gl.createProgram()</code>è¿™ä¸ªå‡½æ•°è¿”å›shaderçš„IDï¼Œè¯¥IDå­˜å‚¨åœ¨<code>addShaderLocations()</code>è¿™ä¸ªå‡½æ•°ä¸­resultå¯¹è±¡é‡Œé¢ï¼Œ<code>&#123; glShaderProgram: this.linkShader(vs, fs) &#125;</code>è¿™é‡Œæ˜¯å¯¹resultå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œåé¢åˆåŠ äº†ä¸¤ä¸ªæˆå‘˜å˜é‡<code>result.uniforms</code>å’Œ<code>result.attribs</code>ã€‚<br />é‡ç‚¹æ˜¯è¿™ä¸ªå‡½æ•°<code>addShaderLocations()</code>,<code>result.uniforms</code>å’Œ<code>result.attribs</code>å­˜å‚¨çš„æ˜¯ä¸€ç³»åˆ—é”®å€¼å¯¹ï¼Œ<code>key</code>æ˜¯ä¹‹å‰ä¼ å…¥çš„uniformå˜é‡åï¼Œ<code>value</code>æ˜¯locationåå¾—åˆ°ID,<code>result.attribs</code>åŒç†ã€‚<br />æ‰€ä»¥åœ¨<code>MeshRender</code>å¯¹è±¡ä¸­ï¼Œè¿›è¡Œ<code>gl.useProgram()</code>,<code>gl.uniform()</code>,<code>gl.enableVertexAttribArray()</code>æ“ä½œæ—¶ï¼Œåªéœ€è¦æ‰€ä»¥ç”¨å˜é‡åæ¥ç´¢å¼•<code>shader.program</code>çš„shaderIDï¼ŒuniformID,attribsIDä»¥åŠå³å¯,è¯¥<code>program</code>å°±å¯¹åº”ä¸Šé¢è¯´çš„<code>result</code>çš„å†…å®¹ã€‚<br />çŸ¥é“è¿™äº›ä»¥åæˆ‘ä»¬å°±å¯ä»¥è‡ªè¡Œå¯¹shaderè¿›è¡Œ<code>uniform</code>,å’Œ<code>useProgram</code>æ“ä½œ,å¯¹äºéœ€è¦æ‰‹åŠ¨è®¾ç½®<code>uniformå˜é‡</code>å¦‚ä¸‹ï¼š<br /><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> l = <span class="hljs-number">0</span>; l &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">lights</span>.<span class="hljs-property">length</span>; l++) &#123;<br>    ...<br>    <span class="hljs-comment">// Camera pass</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>.<span class="hljs-property">length</span>; i++) &#123;<br>        <br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>[i].<span class="hljs-property">materialName</span> == <span class="hljs-string">&quot;KullaContyMaterial&quot;</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>[i].<span class="hljs-property">materialName</span> == <span class="hljs-string">&quot;PBRMaterial&quot;</span>)&#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable constant_">ID</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>[i].<span class="hljs-property">shader</span>.<span class="hljs-property">program</span>.<span class="hljs-property">glShaderProgram</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span>.<span class="hljs-title function_">useProgram</span>(<span class="hljs-variable constant_">ID</span>);<br>            gl.<span class="hljs-title function_">uniform3fv</span>(gl.<span class="hljs-title function_">getUniformLocation</span>(<br>                <span class="hljs-variable constant_">ID</span>, <span class="hljs-string">&quot;uLightPos&quot;</span> + <span class="hljs-string">&quot;[&quot;</span> + l + <span class="hljs-string">&quot;]&quot;</span>), <br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">lights</span>[l].<span class="hljs-property">entity</span>.<span class="hljs-property">lightPos</span>);<br>            gl.<span class="hljs-title function_">uniform3fv</span>(gl.<span class="hljs-title function_">getUniformLocation</span>(<br>                <span class="hljs-variable constant_">ID</span>, <span class="hljs-string">&quot;uLightColors&quot;</span> + <span class="hljs-string">&quot;[&quot;</span> + l + <span class="hljs-string">&quot;]&quot;</span>), <br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">lights</span>[l].<span class="hljs-property">entity</span>.<span class="hljs-property">lightRadiance</span>);<br>        &#125;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>[i].<span class="hljs-title function_">draw</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">camera</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>å¥½çš„ï¼Œæ¡†æ¶æ ¸å¿ƒçš„ä¸œè¥¿å¤§æ¦‚éƒ½è®²å®Œäº†ï¼Œå…¶ä»–çš„åœ°æ–¹æ ¹æ®ä¸Šé¢è¯´çš„å†…å®¹ï¼Œå¤šçœ‹å‡ éå°±æ²¡ä»»ä½•é—®é¢˜äº†ï¼Œä¸‹é¢è®²ä¸‹IBLã€‚</p><h1 id="ibl">IBL</h1><p>IBLçš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š<br /><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//ibl</span><br><span class="hljs-keyword">let</span> envCubemap,irradianceMap,prefilterMap;<br><span class="hljs-keyword">let</span> pbrBrdfLutObj;<br><span class="hljs-keyword">let</span> hdrObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Texture</span>(gl);<br><span class="hljs-comment">//åŠ è½½HDRæ–‡ä»¶</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadTexture</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">RGBELoader</span>().<span class="hljs-title function_">load</span>(<span class="hljs-string">&quot;assets/winter_sky_1k.hdr&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">texture</span>) &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;HDR Loaded&quot;</span>);<br><span class="hljs-title function_">resolve</span>(texture);<br>&#125;);<br>&#125;);<br>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">integral</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">let</span> hdrData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadTexture</span>();<br><span class="hljs-keyword">let</span> data = hdrData.<span class="hljs-property">image</span>.<span class="hljs-property">data</span>;<br><span class="hljs-keyword">let</span> width = hdrData.<span class="hljs-property">image</span>.<span class="hljs-property">width</span>;<br><span class="hljs-keyword">let</span> height = hdrData.<span class="hljs-property">image</span>.<span class="hljs-property">height</span>;<br>gl.<span class="hljs-title function_">bindTexture</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, hdrObj.<span class="hljs-property">texture</span>);<br>gl.<span class="hljs-title function_">texImage2D</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, <span class="hljs-number">0</span>, gl.<span class="hljs-property">RGBA</span>, width, height, <span class="hljs-number">0</span>, gl.<span class="hljs-property">RGBA</span>, gl.<span class="hljs-property">UNSIGNED_BYTE</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data));<br><span class="hljs-comment">////debug texture</span><br><span class="hljs-comment">// gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,</span><br><span class="hljs-comment">// new Uint8Array([0, 0, 255, 255]));</span><br>gl.<span class="hljs-title function_">texParameteri</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, gl.<span class="hljs-property">TEXTURE_WRAP_S</span>, gl.<span class="hljs-property">CLAMP_TO_EDGE</span>);<br>gl.<span class="hljs-title function_">texParameteri</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, gl.<span class="hljs-property">TEXTURE_WRAP_T</span>, gl.<span class="hljs-property">CLAMP_TO_EDGE</span>);<br>gl.<span class="hljs-title function_">texParameteri</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, gl.<span class="hljs-property">TEXTURE_MIN_FILTER</span>, gl.<span class="hljs-property">LINEAR</span>);<br>gl.<span class="hljs-title function_">texParameteri</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, gl.<span class="hljs-property">TEXTURE_MAG_FILTER</span>, gl.<span class="hljs-property">LINEAR</span>);<br>gl.<span class="hljs-title function_">bindTexture</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, <span class="hljs-literal">null</span>);<br><span class="hljs-title function_">getErrorMessage</span>(gl,<span class="hljs-string">&quot;engine.js&quot;</span>);<br><span class="hljs-keyword">let</span> ibl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">IBL</span>(gl,hdrObj.<span class="hljs-property">texture</span>);<br><span class="hljs-keyword">await</span> ibl.<span class="hljs-title function_">init</span>();<br>envCubemap = ibl.<span class="hljs-title function_">caculateEnvCubemap</span>();<br>irradianceMap = ibl.<span class="hljs-title function_">caculateIrradianceMap</span>();<br>prefilterMap = ibl.<span class="hljs-title function_">caculatePrefilterMap</span>();<br>pbrBrdfLutObj = ibl.<span class="hljs-title function_">caculateLut</span>();<br>&#125;<br><span class="hljs-keyword">await</span> <span class="hljs-title function_">integral</span>();<br></code></pre></td></tr></table></figure>ä¸»è¦å°±æ˜¯åŠ è½½<code>HDR</code>æ–‡ä»¶ï¼Œå°†<code>HDR</code>çš„å†…å®¹è½½å…¥ä¸€å¼ <code>2Dçº¹ç†</code>ä¸­(hdrObj)ï¼Œç„¶åæ ¹æ®çº¹ç†ç”Ÿæˆ<code>environmentCubemap</code>(envCubemap),ç„¶åæ ¹æ®<code>Cubemap</code>é¢„è®¡ç®—æ¼«åå°„é¡¹(irradianceMap)çš„å…‰ç…§éƒ¨åˆ†ï¼Œé•œé¢åå°„é¡¹çš„å…‰ç…§éƒ¨åˆ†(prefilterMap)ä»¥åŠå¯¹BRDFæœ¬èº«çš„é¢„è®¡ç®—(pbrBrdfLutObj)ï¼Œç„¶ååœ¨shaderä¸­ç›´æ¥æŸ¥è¡¨å®Œæˆç¯å¢ƒå…‰<code>Cook-Torrance</code>åå°„æ¨¡å‹çš„ç§¯åˆ†ã€‚<br />æ³¨æ„<code>gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE,new Uint8Array(data));</code>è¿™ä¸ªå‡½æ•°è¯»å–æ•°æ®çš„ç±»å‹ä¸èƒ½åƒ<code>Opengl</code>é‚£æ ·å¡«<code>gl.FLOAT</code>,ä¸ç„¶ä¼šæŠ¥é”™,å¯ä»¥ç”¨è¿™ä¸ªå‡½æ•°æ¥æ£€æµ‹<code>getErrorMessage()</code>ã€‚å¦‚æœéå¾—ä½¿ç”¨<code>gl.Float</code>å¯ä»¥åƒä½œä¸šä¸‰é‚£æ ·æ·»åŠ <code>gl.getExtension('EXT_color_buffer_float')</code>æ‰©å±•ã€‚</p><h2 id="ä»ç­‰è·æŸ±çŠ¶æŠ•å½±åˆ°ç«‹æ–¹ä½“è´´å›¾">ä»ç­‰è·æŸ±çŠ¶æŠ•å½±åˆ°ç«‹æ–¹ä½“è´´å›¾</h2><p><code>HDR</code>æ–‡ä»¶è½½å…¥<code>2Dçº¹ç†</code>åå°±æ˜¯<code>ç­‰è·æŸ±çŠ¶æŠ•å½±å›¾(Equirectangular Map)</code>,æˆ‘ä»¬è¦åšçš„å°±æ˜¯å°†è¿™å¼ <code>2Dçº¹ç†</code>è½¬æ¢æˆ<code>Cubemap</code>ã€‚<br />è¿™é‡Œç”¨<a href="https://en.wikipedia.org/wiki/UV_mapping">UVmapping</a>ä¸­çš„æŠ€æœ¯,ä»çƒé¢ä¸Šæ‰¾åˆ°UVåæ ‡ã€‚ä»<code>ç¬›å¡å°”åæ ‡ç³»</code>è½¬<code>çƒåæ ‡ç³»</code>ç„¶åæ˜ å°„åˆ°<code>[0,1]</code>åŒºé—´å»é‡‡æ ·ç­‰è·æŸ±çŠ¶å›¾ï¼Œåœ¨å³æ‰‹åæ ‡ç³»è¿›è¡Œï¼Œ<code>phi</code>é€†æ—¶é’ˆæ—‹è½¬ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br /><span class="math display">\[\begin{align}u=0.5+\frac{\arctan(p_{z},p_{x})}{2\pi}  \\v=0.5+\frac{\arcsin(p_{y})}{\pi}  \tag{1}\end{align}\]</span> è§£é‡Šå¦‚ä¸‹ï¼š<br /><img src="/img/00018/uv-mapping.png" alt="2" /> ä»£ç å¦‚ä¸‹:<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> vec2 invAtan = <span class="hljs-built_in">vec2</span>(<span class="hljs-number">0.1591</span>, <span class="hljs-number">0.3183</span>);<br><span class="hljs-comment">// hdræ–‡ä»¶å­˜å‚¨æ¯ä¸ªæµ®ç‚¹å€¼çš„æ–¹å¼</span><br><span class="hljs-comment">// æ¯ä¸ªé€šé“å­˜å‚¨ 8 ä½ï¼Œå†ä»¥ alpha é€šé“å­˜æ”¾æŒ‡æ•°</span><br><span class="hljs-comment">// å› æ­¤åˆ©ç”¨è¿™ç§æ–¹å¼è§£ç </span><br><span class="hljs-function">vec3 <span class="hljs-title">hdrDecode</span><span class="hljs-params">(vec4 encoded)</span></span>&#123;<br>    <span class="hljs-type">float</span> exponent = encoded.a * <span class="hljs-number">256.0</span> - <span class="hljs-number">128.0</span>;<br>    vec3 mantissa = encoded.rgb;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exp2</span>(exponent) * mantissa;<br>&#125;<br><span class="hljs-function">vec2 <span class="hljs-title">SampleSphericalMap</span><span class="hljs-params">(vec3 v)</span></span><br><span class="hljs-function"></span>&#123;<br>    vec2 uv = <span class="hljs-built_in">vec2</span>(<span class="hljs-built_in">atan</span>(v.z, v.x), <span class="hljs-built_in">asin</span>(v.y));<br>    uv *= invAtan;<br>    uv += <span class="hljs-number">0.5</span>;<br>    <span class="hljs-keyword">return</span> uv;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    vec2 uv = <span class="hljs-built_in">SampleSphericalMap</span>(<span class="hljs-built_in">normalize</span>(WorldPos));<br>    vec4 enCodeColor = <span class="hljs-built_in">texture</span>(uEquirectangularMap,uv).rgba;<br>    vec3 deCodeColor = <span class="hljs-built_in">hdrDecode</span>(enCodeColor);<br>    fragColor = <span class="hljs-built_in">vec4</span>(<span class="hljs-built_in">vec3</span>(deCodeColor), <span class="hljs-number">1.0</span>);<br>&#125;<br></code></pre></td></tr></table></figure></p><h2id="ç¯å¢ƒå…‰cook-torranceåå°„æ–¹ç¨‹çš„é¢„è®¡ç®—">ç¯å¢ƒå…‰Cook-Torranceåå°„æ–¹ç¨‹çš„é¢„è®¡ç®—</h2><p>å¿«é€Ÿæµè§ˆä¸€ä¸‹åå°„æ–¹ç¨‹ï¼š<br /><span class="math display">\[L_{o}(p,w_{o})=\int_{\Omega}^{}(kd\frac{c}{\pi}+ks\frac{DFG}{4(w_{o}\cdotn)(w_{i}\cdot n)})L_{i}(p,w_{i})n\cdot w_{i}dw_{i} \tag{2}\]</span> è¯¥å…¬å¼çš„è§£é‡Šå¯ä»¥å‚è€ƒ<ahref="https://learnopengl-cn.github.io/07%20PBR/01%20Theory/">OpenglPbr</a>ã€‚å€¼å¾—ä¸€æçš„æ˜¯å…¬å¼ä¸­<code>ks</code>å’Œ<code>Fresnel</code>é¡¹æŒ‡ä»£çš„åŒä¸€ä»¶äº‹æƒ…ï¼Œæ‰€ä»¥<code>ks</code>å¯ä»¥çœç•¥ï¼Œå…¶ä¸­<code>o</code>ä»£è¡¨å‡ºå°„æ–¹å‘ä¹Ÿå°±æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„æ–¹å‘ï¼Œ<code>i</code>æ˜¯å…¥å°„æ–¹å‘å³å…‰ç…§æ–¹å‘ã€‚</p><h3 id="æ¼«åå°„å…‰ç…§çš„é¢„è®¡ç®—">æ¼«åå°„å…‰ç…§çš„é¢„è®¡ç®—</h3><p>ä»”ç»†è§‚å¯Ÿä¼šå‘ç°<code>BRDF</code>çš„æ¼«åå°„<code>kd</code>å’Œé•œé¢<code>ks</code>é¡¹æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç§¯åˆ†åˆ†æˆä¸¤éƒ¨åˆ†ï¼š<span class="math display">\[L_{o}(p,w_{o})=\int_{\Omega}(kd\frac{c}{\pi})L_{i}(p,w_{i})n\cdotw_{i}dw_{i}+\int_{\Omega}(\frac{DFG}{4(w_{o}\cdot n)(w_{i}\cdotn)})L_{i}(p,w_{i})n\cdot w_{i}dw_{i} \tag{3}\]</span>å‰è¿™éƒ¨åˆ†æ‰æ˜¯æœ¬èŠ‚çš„é‡ç‚¹ï¼Œè®©æˆ‘ä»¬åœ¨åŒ–ç®€ä¸€ä¸‹(é¢œè‰²<code>c</code>,æ¼«åå°„ç‡<code>kd</code>,å’Œ<code>Ï€</code>åœ¨æ•´ä¸ªç§¯åˆ†æ˜¯å¸¸æ•°)ï¼š<br /><span class="math display">\[L_{o}(p,w_{o})=(kd\frac{c}{\pi})\int_{\Omega}L_{i}(p,w_{i})n\cdotw_{i}dw_{i} \tag{4}\]</span>ç»è¿‡ç®€åŒ–æœ‰å¯ä»¥å‘ç°ï¼Œç§¯åˆ†ç›®å‰åªè·Ÿ<code>wi</code>æœ‰å…³(å‡è®¾ç‰©ä½“ä¸Šçš„ç‚¹pä½äºç«‹æ–¹ä½“ä¸­é—´ï¼Œ<code>N</code>ä¸º<code>p</code>ä¸ç«‹æ–¹ä½“ä¸ŠæŸç‚¹çš„è¿çº¿)ï¼Œç”±äºæ˜¯æ¼«åå°„åœ¨åŠçƒä¸Šçš„ç§¯åˆ†ï¼Œå…¶å…¥å°„æ–¹å‘æ˜¯å‡åŒ€çš„æ¥è‡ªåŠçƒçš„å››é¢å…«æ–¹ã€‚<br />ç§¯åˆ†å‚è€ƒ<code>Opengl</code>çš„æ–¹æ³•ï¼šå¯¹äºç«‹æ–¹ä½“è´´å›¾çš„æ¯ä¸ªçº¹ç´ ï¼Œåœ¨<code>çº¹ç´ æ‰€ä»£è¡¨çš„æ–¹å‘</code>çš„åŠçƒÎ©å†…ç”Ÿæˆå›ºå®šæ•°é‡çš„é‡‡æ ·å‘é‡ï¼Œå¹¶å¯¹é‡‡æ ·ç»“æœå–å¹³å‡å€¼ã€‚æ•°é‡å›ºå®šçš„é‡‡æ ·å‘é‡å°†å‡åŒ€åœ°åˆ†å¸ƒåœ¨åŠçƒå†…éƒ¨ã€‚æ³¨æ„ï¼Œç§¯åˆ†æ˜¯è¿ç»­å‡½æ•°ï¼Œåœ¨é‡‡æ ·å‘é‡æ•°é‡å›ºå®šçš„æƒ…å†µä¸‹ç¦»æ•£åœ°é‡‡æ ·åªæ˜¯ä¸€ç§è¿‘ä¼¼è®¡ç®—æ–¹æ³•ï¼Œæˆ‘ä»¬é‡‡æ ·çš„å‘é‡è¶Šå¤šï¼Œå°±è¶Šæ¥è¿‘æ­£ç¡®çš„ç»“æœã€‚<br />çº¹ç´ æ‰€ä»£è¡¨çš„æ–¹å‘çš„åŠçƒ<code>Î©</code>å†…ç”Ÿæˆå›ºå®šæ•°é‡çš„é‡‡æ ·å‘é‡ï¼Œå›¾è§£å¦‚ä¸‹ï¼š<br /><img src="/img/00018/irradiance.png" alt="3" /><br />åå°„æ–¹ç¨‹çš„ç§¯åˆ†<code>âˆ«</code>æ˜¯å›´ç»•ç«‹ä½“è§’<code>dw</code>æ—‹è½¬ï¼Œè€Œè¿™ä¸ªç«‹ä½“è§’ç›¸å½“éš¾ä»¥å¤„ç†ã€‚ä¸ºäº†é¿å…å¯¹éš¾å¤„ç†çš„ç«‹ä½“è§’æ±‚ç§¯åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨çƒåæ ‡<code>Î¸</code>å’Œ<code>Ï•</code>æ¥ä»£æ›¿ç«‹ä½“è§’ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br /><span class="math display">\[\begin{align}L_{o}(p,\phi_{o},\theta_{o})=kd\frac{c}{\pi}\int_{\phi=0}^{2\pi}\int_{\theta=0}^{\frac{1}{2}\pi}L_{i}(p,\phi_{i},\theta_{i})\cos(\theta_{i})\sin(\theta_{i})d\thetad\phi\\=kd\frac{c}{\pi}\frac{2\pi}{n1}\frac{\pi}{2\cdotn2}\sum_{m=0}^{n1}\sum_{n=0}^{n2}L_{i}(p,\phi_{m},\theta_{n})\cos(\theta_{n})\sin(\theta_{n})\\=kd\frac{c\pi}{n1\cdotn2}\sum_{m=0}^{n1}\sum_{n=0}^{n2}L_{i}(p,\phi_{m},\theta_{n})\cos(\theta_{n})\sin(\theta_{n})\tag{5}\end{align}\]</span>è¯¥ç»“æœç”±è’™ç‰¹å¡æ´›ç§¯åˆ†æ‰€å¾—ï¼Œ<code>Ï†</code>çš„æ¦‚ç‡å¯†åº¦ä¸º<code>1/2PI</code>ï¼Œ<code>Î¸</code>çš„æ¦‚ç‡å¯†åº¦ä¸º<code>2/PI</code>ï¼Œå…¶ä¸­æ·»åŠ çš„<code>sin(Î¸)</code>æ˜¯ä¸ºäº†æƒè¡¡è¾ƒé«˜åŠçƒåŒºåŸŸçš„è¾ƒå°é‡‡æ ·åŒºåŸŸçš„è´¡çŒ®åº¦å¦‚å›¾ï¼š<br /><img src="/img/00018/image.png" alt="4" /><br />ç»™å®šæ¯ä¸ªç‰‡æ®µçš„ç§¯åˆ†çƒåæ ‡ï¼Œå¯¹åŠçƒè¿›è¡Œç¦»æ•£é‡‡æ ·ï¼Œè¿‡ç¨‹ä»£ç å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> <span class="hljs-type">float</span> PI = <span class="hljs-number">3.14159265359</span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    vec3 N = <span class="hljs-built_in">normalize</span>(WorldPos);<br>    vec3 irradiance = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);   <br>    <span class="hljs-comment">// tangent space calculation from origin point</span><br>    vec3 up    = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>);<br>    vec3 right = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">cross</span>(up, N));<br>    up         = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">cross</span>(N, right));<br>    <span class="hljs-type">float</span> sampleDelta = <span class="hljs-number">0.025</span>;<br>    <span class="hljs-type">float</span> nrSamples = <span class="hljs-number">0.0f</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">float</span> phi = <span class="hljs-number">0.0</span>; phi &lt; <span class="hljs-number">2.0</span> * PI; phi += sampleDelta)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">float</span> theta = <span class="hljs-number">0.0</span>; theta &lt; <span class="hljs-number">0.5</span> * PI; theta += sampleDelta)<br>        &#123;<br>            <span class="hljs-comment">// spherical to cartesian (in tangent space)</span><br>            vec3 tangentSample = <span class="hljs-built_in">vec3</span>(<span class="hljs-built_in">sin</span>(theta) * <span class="hljs-built_in">cos</span>(phi),  <span class="hljs-built_in">sin</span>(theta) * <span class="hljs-built_in">sin</span>(phi), <span class="hljs-built_in">cos</span>(theta));<br>            <span class="hljs-comment">// tangent space to world</span><br>            vec3 sampleVec = tangentSample.x * right + tangentSample.y * up + tangentSample.z * N; <br>            irradiance += <span class="hljs-built_in">texture</span>(uEnvironmentMap, sampleVec).rgb * <span class="hljs-built_in">cos</span>(theta) * <span class="hljs-built_in">sin</span>(theta);<br>            nrSamples++;<br>        &#125;<br>    &#125;<br>    irradiance = PI * irradiance * (<span class="hljs-number">1.0</span> / <span class="hljs-built_in">float</span>(nrSamples));<br>    FragColor = <span class="hljs-built_in">vec4</span>(irradiance, <span class="hljs-number">1.0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>çƒåæ ‡ç³»è½¬ç¬›å¡å°”åæ ‡ç³»ï¼Œå¾—åˆ°çš„æ˜¯åˆ‡çº¿ç©ºé—´çš„å‘é‡ï¼Œéœ€è¦ç”¨<code>TBN</code>çŸ©é˜µå°†è¯¥å‘é‡è½¬è‡³ä¸–ç•Œç©ºé—´ã€‚æœ€åå¾—åˆ°æ¼«åå°„è¾ç…§åº¦è´´å›¾å¦‚ä¸‹ï¼š<br /><img src="/img/00018/image-1.png" alt="5" /><br />ç³Šçš„å¾ˆï¼Œæ ¹æœ¬æ²¡æœ‰ç»†èŠ‚å¯è¨€ã€‚</p><h3 id="splitsumå’Œggxé‡è¦æ€§é‡‡æ ·">SplitSumå’ŒGGXé‡è¦æ€§é‡‡æ ·</h3><p>ä¸ºäº†ç†è§£ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹åå°„æ–¹ç¨‹ï¼Œä½†è¿™æ¬¡åªå…³æ³¨é•œé¢åå°„éƒ¨åˆ†ï¼ˆåœ¨ä¸Šä¸€èŠ‚ä¸­å·²ç»å‰¥ç¦»äº†æ¼«åå°„éƒ¨åˆ†ï¼‰ï¼š<br /><span class="math display">\[L_{o}(p,w_{o})=\int_{\Omega}(\frac{DFG}{4(w_{o}\cdot n)(w_{i}\cdotn)})L_{i}(p,w_{i})n\cdot w_{i}dw_{i} \tag{6}\]</span>å¯¹è¿™éƒ¨åˆ†ç§¯åˆ†è¿›è¡Œé¢„è®¡ç®—æœ‰ä¸ªæ£˜æ‰‹çš„åœ°æ–¹ï¼Œå®ƒä¸ä»…ä¾èµ–<code>wi</code>è¿˜ä¾èµ–<code>wo</code>ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å§<code>wi</code>å’Œ<code>wo</code>çš„æ¯ç§ç»„åˆéƒ½è¿›è¡Œé¢„è®¡ç®—(wi(Î¸ï¼ŒÏ†),wo(Î¸ï¼ŒÏ†),F0,roughness,ä¸€å…±å…­ä¸ªç»´åº¦ä¹Ÿæ— æ³•é¢„è®¡ç®—)ï¼Œæ‰€ä»¥<code>Epic Games</code>æå‡ºäº†ä¸€ä¸ªæ–°çš„è§£å†³æ–¹æ³•<ahref="http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf">splitsum</a>ï¼š<br /><span class="math display">\[\begin{align}\int_{\Omega}(\frac{DFG}{4(w_{o}\cdot n)(w_{i}\cdotn)})L_{i}(p,w_{i})n\cdot w_{i}dw_{i}\\\approx\frac{1}{N}\sum_{k=1}^{N}\frac{L_{i}(p,w_{ik})f_{r}(p,w_{ik},w_{ok})\cos(\theta_{ik})}{p(w_{ik},w_{ok})}\\\approx(\frac{1}{N}\sum_{k=1}^{N}L_{i}(p,w_{ik}))(\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{ik},w_{ok})\cos(\theta_{ik})}{p(w_{ik},w_{ok})})\tag{7}\end{align}\]</span>è¯¥å¼å­å·¦è¾¹æ˜¯ä¸€ä¸ªæ±‚å’Œï¼Œå³è¾¹æ˜¯è’™ç‰¹å¡æ´›ç§¯åˆ†ï¼Œå·¦å³åˆ†åˆ«ä¸ºä¸¤ç»´åº¦ï¼Œå¯ä»¥ç›´æ¥æŸ¥è¡¨ã€‚å·¦è¾¹wiæ˜¯ä¸¤ç»´åº¦å¥½ç†è§£ï¼Œå³è¾¹ä¸¤ç»´åº¦æˆ‘åœ¨åé¢ç« èŠ‚è§£é‡Šã€‚æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™ä¸¤éƒ¨åˆ†è¿›è¡Œé¢„è®¡ç®—å°±å¯ä»¥è§£å†³ä¸Šé¢æ£˜æ‰‹çš„éƒ¨åˆ†ã€‚<br />ä½†æ˜¯å®ƒä»¬éƒ½æ˜¯å»ºç«‹åœ¨<code>GGXé‡è¦æ€§é‡‡æ ·</code>çš„åŸºç¡€ä¸Šï¼Œå…ˆä»‹ç»ä¸€ä¸‹é‡è¦æ€§é‡‡æ ·ï¼š<br />æˆ‘ä»¬ä½¿ç”¨çƒé¢åæ ‡ç”Ÿæˆå‡åŒ€åˆ†å¸ƒåœ¨åŠçƒ<code>Î©</code>ä¸Šçš„é‡‡æ ·å‘é‡ï¼Œä»¥å¯¹ç¯å¢ƒè´´å›¾è¿›è¡Œå·ç§¯ã€‚è™½ç„¶è¿™ä¸ªæ–¹æ³•éå¸¸é€‚ç”¨äºè¾ç…§åº¦ï¼Œä½†å¯¹äºé•œé¢åå°„æ•ˆæœè¾ƒå·®ã€‚é•œé¢åå°„ä¾èµ–äºè¡¨é¢çš„ç²—ç³™åº¦ï¼Œåå°„å…‰çº¿å¯èƒ½æ¯”è¾ƒæ¾æ•£ï¼Œä¹Ÿå¯èƒ½æ¯”è¾ƒç´§å¯†ï¼Œä½†æ˜¯ä¸€å®šä¼šå›´ç»•ç€åå°„å‘é‡<code>r</code>ï¼Œé™¤éè¡¨é¢æåº¦ç²—ç³™:<br /><img src="/img/00018/image-2.png" alt="6" /><br />æ‰€æœ‰å¯èƒ½å‡ºå°„çš„åå°„å…‰æ„æˆçš„å½¢çŠ¶ç§°ä¸ºé•œé¢æ³¢ç“£ã€‚éšç€ç²—ç³™åº¦çš„å¢åŠ ï¼Œé•œé¢æ³¢ç“£çš„å¤§å°å¢åŠ ï¼›éšç€å…¥å°„å…‰æ–¹å‘ä¸åŒï¼Œå½¢çŠ¶ä¼šå‘ç”Ÿå˜åŒ–ã€‚å› æ­¤ï¼Œé•œé¢æ³¢ç“£çš„å½¢çŠ¶é«˜åº¦ä¾èµ–äºæè´¨ã€‚åœ¨å¾®è¡¨é¢æ¨¡å‹é‡Œç»™å®šå…¥å°„å…‰æ–¹å‘ï¼Œåˆ™é•œé¢æ³¢ç“£æŒ‡å‘å¾®å¹³é¢çš„åŠå‘é‡çš„åå°„æ–¹å‘ã€‚è€ƒè™‘åˆ°å¤§å¤šæ•°å…‰çº¿æœ€ç»ˆä¼šåå°„åˆ°ä¸€ä¸ªåŸºäºåŠå‘é‡çš„é•œé¢æ³¢ç“£å†…ï¼Œé‡‡æ ·æ—¶ä»¥ç±»ä¼¼çš„æ–¹å¼é€‰å–é‡‡æ ·å‘é‡æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å…¶ä½™çš„å‘é‡éƒ½è¢«æµªè´¹æ‰äº†ã€‚æ ¹æ®è¡¨é¢ç²—ç³™åº¦ç”Ÿæˆæ³•çº¿<code>N</code>ï¼Œç„¶åä»¥é•œé¢åå°„çš„å½¢å¼è®¡ç®—å‡ºé‡‡æ ·æ–¹å‘çš„è¿‡ç¨‹ç§°ä¸º<code>é‡è¦æ€§é‡‡æ ·</code>ã€‚<br />è¦ç†è§£é‡è¦æ€§é‡‡æ ·éœ€è¦å…ˆç†è§£<ahref="https://en.wikipedia.org/wiki/Inverse_transform_sampling">é€†å˜æ¢é‡‡æ ·</a>ï¼Œé€†å˜æ¢é‡‡æ ·æ˜¯ç”¨rangeä¸º[0,1]ä¹‹é—´çš„å‡åŒ€éšæœºæ•°æ¥ç”Ÿæˆæœä»pdfçš„æ ·æœ¬ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š<br />1.ä»å‡åŒ€åˆ†å¸ƒ<code>U[0,1]</code>ä¸­äº§ç”Ÿä¸€ä¸ªéšæœºæ•°<code>ui</code><br />2.è®¡ç®—<spanclass="math inline">\(x_{i}=F_{X}^{-1}(u_{i})\)</span>ä½œä¸ºé‡‡æ ·ç»“æœ<br />å…¶ä¸­<spanclass="math inline">\(F_{X}(x)\)</span>ä¸º<code>CDF</code>(ç´¯ç§¯åˆ†å¸ƒå‡½æ•°)æ‰€æœ‰çš„<code>CDF</code>ä¸­ï¼Œåœ¨<code>x</code>è¶‹è¿‘æœ€å°å€¼æ—¶ï¼Œ<code>CDF</code>è¶‹è¿‘äº<code>0</code>ï¼Œå½“<code>x</code>è¶‹è¿‘æœ€å¤§å€¼æ—¶ï¼Œ<code>CDF</code>è¶‹è¿‘ä¸<code>1</code>ã€‚<br /><spanclass="math inline">\(f_{X}(x)\)</span>ä¸ºéšæœºå˜é‡<code>X</code>çš„<code>pdf</code>(æ¦‚ç‡å¯†åº¦å‡½æ•°)ã€‚è¿™æ˜¯å®ƒä»¬çš„å…³ç³»<spanclass="math inline">\(F_{X}(x)=\int_{-\infty}^{x}f_{X}(u)du\)</span><br /><spanclass="math inline">\(F_{X}^{-1}(x)\)</span>ä¸º<code>cdf</code>çš„åå‡½æ•°ï¼Œåªæœ‰å•è°ƒéå‡çš„å‡½æ•°æ‰æœ‰åå‡½æ•°ã€‚<code>GGXé‡è¦æ€§é‡‡æ ·</code>ç”¨çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸º<ahref="https://www.reedbeta.com/blog/hows-the-ndf-really-defined/">D(h)dot(n,h)</a>ï¼Œå…¶åœ¨çƒåæ ‡ç³»ä¸‹çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š<span class="math display">\[p_{h}(\theta,\phi)=\frac{\alpha^{2}\cos(\theta)\sin(\theta)}{\pi((\alpha^{2}-1)\cos^{2}(\theta)+1)^{2}}\tag{8}\]</span> åˆ†åˆ«æ±‚Î¸å’ŒÏ†çš„è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°(pdf)ï¼š <spanclass="math display">\[\begin{align}p_{h}(\theta)=\int_{0}^{2\pi}p_{h}(\theta,\phi)d\phi=\frac{2\alpha^{2}\cos(\theta)\sin(\theta)}{((\alpha^{2}-1)\cos^{2}(\theta)+1)^{2}}\tag{9}\end{align}\]</span> <span class="math display">\[\begin{align}p_{h}(\phi)=\int_{0}^{\frac{\pi}{2}}\frac{\alpha^{2}\cos(\theta)\sin(\theta)}{\pi((\alpha^2-1)\cos^{2}(\theta)+1)^{2}}d\theta\\=-\frac{\alpha^{2}}{2\pi}\int_{0}^{\frac{\pi}{2}}\frac{-2\cos(\theta)\sin(\theta)}{((\alpha^2-1)\cos^{2}(\theta)+1)^{2}}d\theta\\=\frac{\alpha^{2}}{2\pi}\int_{\frac{\pi}{2}}^{0}\frac{1}{((\alpha^2-1)\cos^{2}(\theta)+1)^{2}}d(\cos^{2}\theta)\\=\frac{\alpha^{2}}{2\pi}\int_{0}^{1}\frac{1}{((\alpha^{2}-1)t+1)^{2}}dt\\\end{align}\]</span> ä»¤<code>x=(Î±^2-1)t+1</code> <span class="math display">\[\begin{align}=\frac{\alpha^{2}}{2\pi(\alpha^2-1)}\int_{1}^{\alpha^2}\frac{1}{x^{2}}dx\\=\frac{\alpha^{2}}{2\pi(1-\alpha^2)}\frac{1}{x}\vert_{1}^{\alpha^2} \\=\frac{1}{2\pi} \tag{10}\end{align}\]</span> å†åˆ†åˆ«æ±‚<code>Î¸</code>å’Œ<code>Ï†</code>çš„ç´¯è®¡åˆ†å¸ƒå‡½æ•°(cdf):<span class="math display">\[P_{h}(\phi)=\int_{0}^{\phi}\frac{1}{2\pi}dt=\frac{\phi}{2\pi} \tag{11}\]</span> <span class="math display">\[\begin{align}P_{h}(\theta)=\int_{0}^{\theta}\frac{2\alpha^{2}\cos(t)\sin(t)}{((\alpha^{2}-1)\cos^{2}(t)+1)^{2}}dt\\=\alpha^{2}\int_{\theta}^{0}\frac{1}{((\alpha^2-1)\cos^{2}(t)+1)^{2}}d(\cos^{2}(t))\\=\frac{\alpha^2}{\alpha^2-1}\int_{\alpha^2}^{(\alpha^2-1)\cos^{2}(\theta)+1}-\frac{1}{x^{2}}dx\\=\frac{\alpha^2}{\alpha^2-1}\frac{1}{x}\vert_{\alpha^{2}}^{(\alpha^2-1)\cos^{2}(\theta)+1}\\=\frac{\alpha^{2}}{\alpha^{2}-1}\cdot(\frac{1}{(\alpha^2-1)\cos^{2}(\theta)+1}-\frac{1}{\alpha^{2}}) \tag{12}\end{align}\]</span>åå‡½æ•°å°±æ˜¯å‡½æ•°å€¼åŸŸ<code>Y</code>å’Œå®šä¹‰åŸŸ<code>X</code>çš„æ˜ å°„å…³ç³»ç¿»è½¬ä¸€ä¸‹ã€‚å‡åŒ€çš„ä»<code>U[0,1]</code>ä¸­å–å‡ºä¸¤ä¸ªéšæœºæ•°<spanclass="math inline">\(X_{1}\)</span>å’Œ<spanclass="math inline">\(X_{2}\)</span>,åˆ™æˆ‘ä»¬è¦çš„é‡‡æ ·<code>Î¸</code>å’Œ<code>Ï†</code>ä¸ºï¼š<br /><span class="math display">\[\phi=2\pi X_{1} \tag{13}\]</span> <span class="math display">\[\theta=\arccos\sqrt{\frac{1-X_{2}}{X_{2}(\alpha^{2}-1)+1}} \tag{14}\]</span> å¯¹åº”ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">ImportanceSampleGGX</span><span class="hljs-params">(vec2 Xi, vec3 N, <span class="hljs-type">float</span> roughness)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-type">float</span> a = roughness*roughness;<br><span class="hljs-type">float</span> phi = <span class="hljs-number">2.0</span> * PI * Xi.x;<br><span class="hljs-type">float</span> cosTheta = <span class="hljs-built_in">sqrt</span>((<span class="hljs-number">1.0</span> - Xi.y) / (<span class="hljs-number">1.0</span> + (a*a - <span class="hljs-number">1.0</span>) * Xi.y));<br><span class="hljs-type">float</span> sinTheta = <span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1.0</span> - cosTheta*cosTheta);<br><span class="hljs-comment">// from spherical coordinates to cartesian coordinates - halfway vector</span><br>vec3 H;<br>H.x = <span class="hljs-built_in">cos</span>(phi) * sinTheta;<br>H.y = <span class="hljs-built_in">sin</span>(phi) * sinTheta;<br>H.z = cosTheta;<br><span class="hljs-comment">// from tangent-space H vector to world-space sample vector</span><br>vec3 up          = <span class="hljs-built_in">abs</span>(N.z) &lt; <span class="hljs-number">0.999</span> ? <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>) : <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>);<br>vec3 tangent   = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">cross</span>(up, N));<br>vec3 bitangent = <span class="hljs-built_in">cross</span>(N, tangent);<br>vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">normalize</span>(sampleVec);<br>&#125;<br></code></pre></td></tr></table></figure> ### é•œé¢åå°„å…‰ç…§çš„é¢„è®¡ç®—</p><p>ä¸ŠèŠ‚å†…å®¹æåˆ°ç”¨<code>Split Sum</code>æ¥åˆ†å‰²é•œé¢åå°„çš„å…‰ç…§å’ŒBRDFéƒ¨åˆ†ä»¥é¿å…å»æ±‚wiå’Œwoæ‰€æœ‰ç»„åˆä¸‹çš„ç§¯åˆ†ã€‚æœ¬èŠ‚é‡è¦ç‚¹æ”¾åœ¨é•œé¢åå°„å…‰ç…§çš„é¢„è®¡ç®—ï¼Œæˆ‘ä»¬å†çœ‹ä¸‹è¿™éƒ¨åˆ†çš„å…¬å¼ï¼š<br /><span class="math display">\[\frac{1}{N}\sum_{k=1}^{N}L_{i}(p,w_{ik}) \tag{15}\]</span>è¿™é‡Œå¯ä»¥çœ‹åšæ˜¯ä¸€æ¬¡æ±‚å’Œå–å¹³å‡ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¿™é‡Œçš„wiä¸ä»…éœ€è¦<code>GGXé‡è¦æ€§é‡‡æ ·</code>å¾—åˆ°çš„ç¬¦åˆ<code>D(h)dot(n,h)æ¦‚ç‡å¯†åº¦å‡½æ•°</code>çš„å¾®è¡¨é¢æ³•çº¿æ–¹å‘ï¼Œè¿˜éœ€è¦è§†è§’æ–¹å‘<code>V</code>,ä½†æ˜¯æˆ‘ä»¬å¹¶ä¸èƒ½æå‰çŸ¥é“<code>V</code>æ˜¯ä»€ä¹ˆæ–¹å‘ï¼Œè¿™é‡Œ<code>Epic Games</code>å†ä¸€æ¬¡å‡è®¾ï¼Œå³<code>v=r=n</code>ã€‚è¿™ç§å„å‘åŒæ€§å‡è®¾æ˜¯ç¬¬äºŒä¸ªè¿‘ä¼¼æ¥æºï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™æ„å‘³åœ¨æ å…¥å°„è§’æ—¶ä¸ä¼šå¾—åˆ°é•¿åå°„æ•ˆæœï¼š<br /><img src="/img/00018/image-3.png" alt="7" /><br />ä¸åˆ†è£‚å’Œè¿‘ä¼¼ç›¸æ¯”ï¼Œè¿™å®é™…ä¸Šæ˜¯æˆ‘ä»¬<code>IBL</code>è§£çš„è¾ƒå¤§è¯¯å·®æºã€‚ä»£ç ä¸­é€šè¿‡<code>cosÎ¸lk</code>åŠ æƒå¯ä»¥è·å¾—æ›´å¥½çš„ç»“æœï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    vec3 N = <span class="hljs-built_in">normalize</span>(WorldPos);<br>    <span class="hljs-comment">// make the simplifying assumption that V equals R equals the normal </span><br>    vec3 R = N;<br>    vec3 V = R;<br>    <span class="hljs-type">const</span> uint SAMPLE_COUNT = <span class="hljs-number">1024u</span>;<br>    vec3 prefilteredColor = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);<br>    <span class="hljs-type">float</span> totalWeight = <span class="hljs-number">0.0</span>;<br>    <span class="hljs-keyword">for</span>(uint i = <span class="hljs-number">0u</span>; i &lt; SAMPLE_COUNT; ++i)<br>    &#123;<br>        <span class="hljs-comment">// generates a sample vector that&#x27;s biased towards the preferred alignment direction (importance sampling).</span><br>        vec2 Xi = <span class="hljs-built_in">Hammersley</span>(i, SAMPLE_COUNT);<br>        vec3 H = <span class="hljs-built_in">ImportanceSampleGGX</span>(Xi, N, uRoughness);<br>        vec3 L  = <span class="hljs-built_in">normalize</span>(<span class="hljs-number">2.0</span> * <span class="hljs-built_in">dot</span>(V, H) * H - V);<br>        <span class="hljs-comment">//COS weight can increase image quality</span><br>        <span class="hljs-type">float</span> NdotL = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N, L), <span class="hljs-number">0.0</span>);<br>        <span class="hljs-keyword">if</span>(NdotL &gt; <span class="hljs-number">0.0</span>)<br>        &#123;<br>            <span class="hljs-comment">// sample from the environment&#x27;s mip level based on roughness/pdf</span><br>            <span class="hljs-type">float</span> D   = <span class="hljs-built_in">DistributionGGX</span>(N, H, uRoughness);<br>            <span class="hljs-type">float</span> NdotH = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N, H), <span class="hljs-number">0.0</span>);<br>            <span class="hljs-type">float</span> HdotV = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(H, V), <span class="hljs-number">0.0</span>);<br>            <span class="hljs-type">float</span> pdf = D * NdotH / (<span class="hljs-number">4.0</span> * HdotV) + <span class="hljs-number">0.0001</span>; <br>            <span class="hljs-type">float</span> resolution = <span class="hljs-number">512.0</span>; <span class="hljs-comment">// resolution of source cubemap (per face)</span><br>            <span class="hljs-type">float</span> saTexel  = <span class="hljs-number">4.0</span> * PI / (<span class="hljs-number">6.0</span> * resolution * resolution);<br>            <span class="hljs-type">float</span> saSample = <span class="hljs-number">1.0</span> / (<span class="hljs-built_in">float</span>(SAMPLE_COUNT) * pdf + <span class="hljs-number">0.0001</span>);<br>            <span class="hljs-comment">//sample solid angle ratio to pixel solid angle</span><br>            <span class="hljs-type">float</span> mipLevel = uRoughness == <span class="hljs-number">0.0</span> ? <span class="hljs-number">0.0</span> : <span class="hljs-number">0.5</span> * <span class="hljs-built_in">log2</span>(saSample / saTexel);        <br>            prefilteredColor += <span class="hljs-built_in">textureLod</span>(uEnvironmentMap, L, mipLevel).rgb * NdotL;<br>            totalWeight      += NdotL;<br>        &#125;<br>    &#125;<br>    prefilteredColor = prefilteredColor / totalWeight;<br>    FragColor = <span class="hljs-built_in">vec4</span>(prefilteredColor, <span class="hljs-number">1.0</span>);<br>&#125;<br></code></pre></td></tr></table></figure> ä»£ç ä¸­çš„<code>pdf</code>æ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹ï¼Œå›¾ç‰‡æ¥æºäº<ahref="https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.pdf">2007å¹´è®ºæ–‡</a>ï¼š<br /><span class="math display">\[p_{o}(\theta,\phi)=p_{h}(\theta,\phi)\cdot\lVert\frac{\partialw_{h}}{\partial w_{o}}\rVert \tag{16}\]</span> <img src="/img/00018/pdf-derivation.png" alt="8" /><br /><span class="math display">\[\begin{align}\lVert\frac{\partial w_{h}}{\partial w_{o}}\rVert=\frac{\vert o\cdoth\vert}{\lVert\vec{h}\rVert^{2}} \\=\frac{\vert o\cdot h\vert}{\lVert 2(o\cdot h)h\rVert^{2}}=\frac{\vert o\cdot h\vert}{4(o\cdot h)^{2}\lVerth\rVert^{2}}=\frac{1}{4\vert o\cdot h\vert} \tag{17}\end{align}\]</span>å…¶ä¸­<code>i</code>ï¼Œ<code>o</code>å’Œ<code>æ²¡ç®­å¤´çš„h</code>ï¼Œéƒ½æ˜¯å½’ä¸€åŒ–åçš„å‘é‡ã€‚è¿™åªæ˜¯åå°„æ¨¡å‹çš„<code>pdf</code>ï¼Œä»¥åŒæ ·çš„è®¡ç®—æ–¹æ³•è®ºæ–‡ä½œè€…è¿˜ç»™å‡ºäº†æŠ˜å°„çš„<code>pdf</code>ï¼Œæ„Ÿå…´è¶£å¯ä»¥å»çœ‹ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œæ¨å¯¼æ¶‰åŠçš„iï¼Œoå’Œä»£ç ä¸­çš„vï¼ŒLæ²¡å…³ç³»ï¼Œåªæ˜¯å•çº¯ç”¨æ¥æ¨å¯¼çš„,ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬è§†<code>i</code>ä¸ºå…‰ç…§æ–¹å‘ï¼Œ<code>o</code>ä¸ºè§†è§’æ–¹å‘ã€‚</p><p>ä»£ç ä¸­<ahref="https://developer.nvidia.com/gpugems/gpugems3/part-iii-rendering/chapter-20-gpu-based-importance-sampling">é‡‡æ ·</a>æ˜¯å¯¹<code>uEnvironmentMap</code>çš„<code>mipmap</code>æ¥é‡‡æ ·ï¼Œè€Œä¸æ˜¯ç›´æ¥å»è·å–æ¸…æ™°åº¦æœ€é«˜çš„<code>uEnvironmentMap</code>,è¿™æ ·åšçš„åŸå› æ˜¯<code>pdf</code>è¶Šä½ï¼Œæ ·æœ¬æ‰€å¯¹åº”çš„ç¯å¢ƒè´´å›¾ä¸­å¹³å‡åƒç´ æ•°å°±è¶Šå¤šï¼Œä½¿ç”¨çš„<code>mipmap</code>å±‚çº§åº”è¯¥è¶Šå¤§ï¼Œè¿™å¯ä»¥åšåˆ°å°‘é‡‡æ ·æ•°é‡è¾¾åˆ°å¤šé‡‡æ ·æ•°é‡çš„æ•ˆæœï¼Œå¹¶å‡å°‘ä¼ªå½±ã€‚æˆ‘ä»¬ç”¨ä¸æ ·æœ¬ç›¸å…³çš„å®ä½“è§’æ¥å®šä¹‰è¿™ç§å…³ç³»ï¼Œè®¡ç®—æ–¹æ³•æ˜¯<code>pdf</code>ä¸æ ·æœ¬æ€»æ•°<code>N</code>ä¹‹é—´ä¹˜ç§¯çš„å€’æ•°ï¼š<br /><span class="math display">\[\Omega_{s}=\frac{1}{N\cdot p_{L}(\theta,\phi)} \tag{18}\]</span>è¯¥å¼å­è¡¨ç¤ºé‡‡æ ·æ–¹å‘æ‰€å¯¹åº”çš„ç¯å¢ƒè´´å›¾ä¸­åƒç´ æ•°çš„å¤šå°‘(é‡‡æ ·ç«‹ä½“è§’çš„å¤§å°)ã€‚æˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ç«‹æ–¹ä½“è´´å›¾ä¸­ä¸€ä¸ªåƒç´ å¯¹åº”çš„ç«‹ä½“è§’æ˜¯å¤šå¤§,æˆ‘ä»¬è¿™é‡Œæ˜¯æ±‚å•ä½çƒè¡¨é¢ç§¯æ¯”ä¸Šç«‹æ–¹ä½“åˆ†è¾¨ç‡ï¼š<br /><span class="math display">\[\Omega_{p}=\frac{d(u)}{w\cdot h} \tag{19}\]</span>åŸæ–‡è¿™ä¸ª<code>d(u)</code>æ˜¯è®¡ç®—ä»åŠçƒçš„å•ä½é¢ç§¯åˆ°çº¹ç†ä¸Šçš„å•ä½é¢ç§¯çš„å˜åŒ–é€Ÿç‡ï¼ˆæ¢å¥è¯è¯´ï¼Œè®¡ç®—æ˜ å°„çš„ç•¸å˜ç‡ï¼‰ï¼ŒåŸæ–‡<code>d(u)</code>æ˜¯åº”ç”¨åœ¨å¦ä¸€ç§é‡‡æ ·æ–¹å¼ï¼Œä¸æ˜¯åœ¨ç«‹æ–¹ä½“è´´å›¾ä¸Šé¢è¿›è¡Œçš„é‡‡æ ·ï¼Œå’Œæˆ‘ä»¬è¿™é‡Œä¸ä¸€æ ·ï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥ç®—ç«‹æ–¹ä½“è´´å›¾ä¸Šä¸€ä¸ªåƒç´ å¯¹åº”çš„ç«‹ä½“è§’å¤§å°å°±è¡Œã€‚é‚£<code>d(u)</code>ç›´æ¥å°±æ˜¯å•ä½çƒçš„è¡¨é¢ç§¯<code>4Ï€</code>ã€‚<br />æœ€åç”¨ä¸‹é¢è¿™ä¸ªå…¬å¼è®¡ç®—<code>mipmap</code>å±‚æ•°ï¼š<br /><span class="math display">\[level=max[\frac{1}{2}\log_{2}\frac{\Omega_{s}}{\Omega_{p}},0] \tag{20}\]</span>æœ€åè®¡ç®—å®Œçš„<code>prefilteredColor</code>æ ¹æ®ç²—ç³™åº¦<code>[0,1]</code>ï¼Œåˆ†åˆ«å­˜å…¥<code>prefilterMap</code>çš„<code>5</code>å±‚<code>mipmap</code>ä¸­ï¼Œåœ¨æœ€å<code>shading</code>è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®ç²—ç³™åº¦æ¥è·å–<code>prefilteredColor</code>å±‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š<br /><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js">gl.<span class="hljs-title function_">bindFramebuffer</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>, captureFBO);<br><span class="hljs-keyword">const</span> maxMipLevels = <span class="hljs-number">5</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> mip = <span class="hljs-number">0</span>; mip &lt; maxMipLevels; ++mip)<br>&#123;<br>    <span class="hljs-comment">// reisze framebuffer according to mip-level size.</span><br>    <span class="hljs-keyword">let</span> mipWidth  = <span class="hljs-number">128</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">0.5</span>, mip);<br>    <span class="hljs-keyword">let</span> mipHeight = <span class="hljs-number">128</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">0.5</span>, mip);<br>    gl.<span class="hljs-title function_">bindRenderbuffer</span>(gl.<span class="hljs-property">RENDERBUFFER</span>, captureRBO);<br>    gl.<span class="hljs-title function_">renderbufferStorage</span>(gl.<span class="hljs-property">RENDERBUFFER</span>, gl.<span class="hljs-property">DEPTH_COMPONENT24</span>, mipWidth, mipHeight);<br>    gl.<span class="hljs-title function_">viewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, mipWidth, mipHeight);<br>    <span class="hljs-keyword">let</span> roughness = mip / (maxMipLevels - <span class="hljs-number">1</span>);<br>    gl.<span class="hljs-title function_">uniform1f</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prefilterShader</span>.<span class="hljs-property">program</span>.<span class="hljs-property">uniforms</span>[<span class="hljs-string">&quot;uRoughness&quot;</span>],roughness);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; ++i)<br>    &#123;<br>        gl.<span class="hljs-title function_">uniformMatrix4fv</span>(<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prefilterShader</span>.<span class="hljs-property">program</span>.<span class="hljs-property">uniforms</span>[<span class="hljs-string">&quot;uViewMatrix&quot;</span>],<br>            <span class="hljs-literal">false</span>,<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureViews</span>[i]);<br>        gl.<span class="hljs-title function_">framebufferTexture2D</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>, gl.<span class="hljs-property">COLOR_ATTACHMENT0</span>, gl.<span class="hljs-property">TEXTURE_CUBE_MAP_POSITIVE_X</span> + i, <span class="hljs-variable language_">this</span>.<span class="hljs-property">prefilterMap</span>, mip);<br>        gl.<span class="hljs-title function_">clear</span>(gl.<span class="hljs-property">COLOR_BUFFER_BIT</span> | gl.<span class="hljs-property">DEPTH_BUFFER_BIT</span>);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderCube</span>();<br>    &#125;<br>&#125;<br>gl.<span class="hljs-title function_">bindFramebuffer</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>, <span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure> ä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œä¼šå¾—åˆ°ä¸‹é¢çš„å›¾ç‰‡ï¼š<br /><img src="/img/00018/image-6.png" alt="9" /></p><h3 id="é¢„è®¡ç®—brdf">é¢„è®¡ç®—BRDF</h3><p>æœ‰äº†ä¸Šé¢çš„åŸºç¡€ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°±æ¯”è¾ƒç®€å•äº†ï¼Œå¿«é€Ÿçœ‹ä¸€éå…¬å¼ï¼š<br /><span class="math display">\[\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{ik},w_{ok})\cos(\theta_{ik})}{p(w_{ik},w_{ok})}\tag{21}\]</span>ä¸Šæ–‡è¯´åˆ°é•œé¢åå°„æ–¹ç¨‹æœ‰å…­ä¸ªç»´åº¦<code>wi(Î¸ï¼ŒÏ†)</code>,<code>wo(Î¸ï¼ŒÏ†)</code>,<code>F0</code>,<code>roughness</code>,ç”±äºå…‰ç…§éƒ¨åˆ†æˆ‘ä»¬å·²ç»å¤„ç†è¿‡äº†ï¼Œè€Œæ­¤æ—¶<code>BRDF</code>çš„<code>wi</code>å’Œ<code>wo</code>éƒ½æ˜¯å’Œ<code>n</code>ç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œé‚£è¿™é‡Œ<code>BRDF</code>å°±åªå‰©ä¸‹<code>4</code>ä¸ªç»´åº¦<code>wiÂ·n</code>,<code>woÂ·n</code>,<code>F0</code>,<code>roughness</code>,ç”±äºé‡è¦æ€§é‡‡æ ·å¯ä»¥ç”±<code>wo</code>ç”Ÿæˆæœä»<code>D(h)dot(n,h)</code>æ¦‚ç‡å¯†åº¦å‡½æ•°çš„<code>wi</code>ï¼Œåˆ™ç»´åº¦å¯ä»¥å†é™åˆ°3ä¸ª<code>woÂ·n</code>,<code>F0</code>,<code>roughness</code>ï¼Œå†å°†<code>Fresnel</code>é¡¹æ‹†åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œ<code>F0</code>ä¹Ÿå¯ä»¥ç§»å‡ºç§¯åˆ†èŒƒå›´ï¼Œç»´åº¦å†é™åˆ°2ä¸ª<code>woÂ·n</code>,<code>roughness</code>ï¼Œè¿™æ ·å°±å¯ä»¥æ„‰å¿«çš„æ‰“è¡¨äº†ğŸ˜†ï¼ä¸‹é¢æ˜¯æ‹†åˆ†è¿‡ç¨‹ï¼Œæˆ‘è¿™é‡ŒæŠŠ<code>k</code>è§’æ ‡å»æ‰äº†æ–¹ä¾¿è§‚çœ‹ï¼š<br /><span class="math display">\[\begin{align}\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})\cos(\theta_{i})}{p(w_{i},w_{o})}\\=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})F(w_{o},h)\cos(\theta_{i})}{F(w_{o},h)p(w_{i},w_{o})}\\=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}(F0+(1-F0)(1-w_{o}\cdoth)^{5})\cos(\theta_{i})\end{align}\]</span> è¿™é‡Œç”¨<code>Î±</code>ä»£æ›¿<code>(1-woÂ·h)^5</code>:<br /><span class="math display">\[\begin{align}=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}(F0+(1-F0)\alpha)\cos(\theta_{i})\\=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}(F0*(1-\alpha)+\alpha)\cos(\theta_{i})\\=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}F0*(1-\alpha)\cos(\theta_{i})+\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}\alpha\cos(\theta_{i})\tag{22}\end{align}\]</span> å¯ä»¥çœ‹åˆ°è¿™ä¸¤éƒ¨åˆ†éƒ½åŒ…å«ä¸€ä¸ªå…±åŒé¡¹ï¼š<br /><span class="math display">\[\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}\cos(\theta_{i})\]</span>æˆ‘ä»¬å°†å…¶åŒ–ç®€ä¸€ä¸‹,å…¶ä¸­<code>pdf=D * NdotH / (4.0 * VdotH)</code>ï¼š<br /><span class="math display">\[\begin{align}=\frac{DG\cos(\theta_{i})}{4\cos(\theta_{o})\cos(\theta_{i})}\frac{4(o\cdoth)}{D(n\cdot h)} \\=\frac{G(o\cdot h)}{(o\cdot n)(n\cdot h)} \tag{23}\end{align}\]</span> å¸¦å…¥(22)å¼ä¸­å¾—ï¼š<br /><span class="math display">\[F0*\frac{1}{N}\sum_{k=1}^{N}\frac{G(o\cdot h)}{(o\cdot n)(n\cdoth)}(1-(1-(w_{o}\cdot h)^{5}))+\frac{1}{N}\sum_{k=1}^{N}\frac{G(o\cdoth)}{(o\cdot n)(n\cdot h)}(1-(w_{o}\cdot h)^{5}) \tag{24}\]</span> ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec2 <span class="hljs-title">IntegrateBRDF</span><span class="hljs-params">(<span class="hljs-type">float</span> NdotV, <span class="hljs-type">float</span> roughness)</span></span><br><span class="hljs-function"></span>&#123;<br>    vec3 V;<br>    V.x = <span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1.0</span> - NdotV*NdotV);<br>    V.y = <span class="hljs-number">0.0</span>;<br>    V.z = NdotV;<br>    <span class="hljs-type">float</span> A = <span class="hljs-number">0.0</span>;<br>    <span class="hljs-type">float</span> B = <span class="hljs-number">0.0</span>; <br>    vec3 N = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);<br>    <span class="hljs-type">const</span> uint SAMPLE_COUNT = <span class="hljs-number">1024u</span>;<br>    <span class="hljs-keyword">for</span>(uint i = <span class="hljs-number">0u</span>; i &lt; SAMPLE_COUNT; ++i)<br>    &#123;<br>        <span class="hljs-comment">// generates a sample vector that&#x27;s biased towards the</span><br>        <span class="hljs-comment">// preferred alignment direction (importance sampling).</span><br>        vec2 Xi = <span class="hljs-built_in">Hammersley</span>(i, SAMPLE_COUNT);<br>        vec3 H = <span class="hljs-built_in">ImportanceSampleGGX</span>(Xi, N, roughness);<br>        vec3 L = <span class="hljs-built_in">normalize</span>(<span class="hljs-number">2.0</span> * <span class="hljs-built_in">dot</span>(V, H) * H - V);<br>        <span class="hljs-type">float</span> NdotL = <span class="hljs-built_in">max</span>(L.z, <span class="hljs-number">0.0</span>);<br>        <span class="hljs-type">float</span> NdotH = <span class="hljs-built_in">max</span>(H.z, <span class="hljs-number">0.0</span>);<br>        <span class="hljs-type">float</span> VdotH = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(V, H), <span class="hljs-number">0.0</span>);<br>        <span class="hljs-keyword">if</span>(NdotL &gt; <span class="hljs-number">0.0</span>)<br>        &#123;<br>            <span class="hljs-type">float</span> G = <span class="hljs-built_in">GeometrySmith</span>(N, V, L, roughness);<br>            <span class="hljs-type">float</span> G_Vis = (G * VdotH) / (NdotH * NdotV);<br>            <span class="hljs-type">float</span> Fc = <span class="hljs-built_in">pow</span>(<span class="hljs-number">1.0</span> - VdotH, <span class="hljs-number">5.0</span>);<br>            <span class="hljs-comment">//pdf = D * NdotH / (4.0 * HdotV); </span><br>            A += (<span class="hljs-number">1.0</span> - Fc) * G_Vis;<br>            B += Fc * G_Vis;<br>        &#125;<br>    &#125;<br>    A /= <span class="hljs-built_in">float</span>(SAMPLE_COUNT);<br>    B /= <span class="hljs-built_in">float</span>(SAMPLE_COUNT);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec2</span>(A, B);<br>&#125;<br></code></pre></td></tr></table></figure> å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä¼šå¾—åˆ°è¿™æ ·ä¸€å¼ çº¹ç†ï¼š<br /><img src="/img/00018/image-4.png" alt="10" /><br />ä»£ç ä¸­debugå‡ºçš„æ ·å­å¦‚ä¸‹ï¼š<br /><img src="/img/00018/image-5.png" alt="11" /></p><h2 id="å®Œæˆiblåå°„">å®ŒæˆIBLåå°„</h2><p>å¯¹ä¸Šé¢å®Œæˆçš„ä¸‰éƒ¨åˆ†é¢„è®¡ç®—çº¹ç†è¿›è¡ŒæŸ¥è¡¨ï¼Œå³ç¯å¢ƒå…‰Cook-Torranceåå°„æ–¹ç¨‹çš„ç§¯åˆ†å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">fresnelSchlickRoughness</span><span class="hljs-params">(vec3 F0, vec3 V, vec3 N,<span class="hljs-type">float</span> roughness)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> F0 + (<span class="hljs-built_in">max</span>(<span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span> - roughness), F0) - F0) * <span class="hljs-built_in">pow</span>(<span class="hljs-number">1.0</span> - <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N,V),<span class="hljs-number">0.0</span>), <span class="hljs-number">5.0</span>);<br>&#125; <br>...<br><span class="hljs-comment">//ä»¥ç¯å¢ƒå…‰ä½œä¸ºIBL</span><br>vec3 F = <span class="hljs-built_in">fresnelSchlickRoughness</span>(F0,V,N,uRoughness);<br>vec3 kD = (<span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>) - F) * (<span class="hljs-number">1.0</span> - uMetallic);<br><span class="hljs-comment">//æ¼«åå°„å…‰ç…§é¡¹</span><br>vec3 irradiance = <span class="hljs-built_in">texture</span>(uIrradianceMap,N).rgb;<br>vec3 diffuse = irradiance * albedo;<br><span class="hljs-comment">//ä»¥ç¡®ä¿ä¸ä¼šå¯¹ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„mipçº§åˆ«é‡‡æ ·</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> MAX_REFLECTION_LOD = <span class="hljs-number">4.0</span>;<br><span class="hljs-comment">//é•œé¢åå°„å…‰ç…§é¡¹</span><br>vec3 prefilteredColor = <span class="hljs-built_in">textureLod</span>(uPrefilterMap,R,uRoughness * MAX_REFLECTION_LOD).rgb;<br><span class="hljs-comment">//BRDFé¡¹</span><br>vec2 brdf = <span class="hljs-built_in">texture</span>(uPbrBrdfLUT,<span class="hljs-built_in">vec2</span>(<span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N,V),<span class="hljs-number">0.0</span>),uRoughness)).rg;<br><span class="hljs-comment">//split sum</span><br>vec3 specular = prefilteredColor * (F0 * brdf.r + brdf.g);<br><span class="hljs-comment">//ç¯å¢ƒå…‰Cook-Torranceåå°„æ–¹ç¨‹çš„ç§¯åˆ†å€¼</span><br>vec3 ambient = (kD * diffuse + specular) * uAo;<br></code></pre></td></tr></table></figure>ä½¿ç”¨<code>fresnelSchlickRoughness</code>å‡½æ•°ï¼Œæ˜¯ç”±äºç¯å¢ƒå…‰æ¥è‡ªåœ¨åŠçƒå†…æ‰€æœ‰å›´ç»•ç€æ³•çº¿<code>N</code>çš„æ–¹å‘ï¼Œæ²¡æœ‰å•ä¸€çš„åŠå‘é‡å»å†³å®šè²æ¶…å°”å› å­ã€‚ä¸ºäº†ä»ç„¶èƒ½æ¨¡æ‹Ÿè²æ¶…å°”ï¼Œè¿™é‡Œé‡‡ç”¨äº†æ³•çº¿å’Œè§†çº¿çš„å¤¹è§’ã€‚ä¹‹å‰çš„ç®—æ³•é‡‡ç”¨äº†å—è¡¨é¢ç²—ç³™åº¦å½±å“çš„å¾®å¹³é¢åŠå‘é‡ï¼Œä½œä¸ºè²æ¶…å°”æ–¹ç¨‹çš„è¾“å…¥ã€‚è¿™é‡Œæˆ‘ä»¬åŠ å…¥ç²—ç³™åº¦æ¥æƒè¡¡è¿™ä¸€æŸå¤±ã€‚<br />ç„¶åå°†<code>ambient</code>åŠ åˆ°æ­£å¸¸çš„<code>PBR</code>æ¨¡å‹ä¸Šå°±å¤§åŠŸå‘Šæˆäº†ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp">vec3 albedo = <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">texture</span>(uAlbedoMap, vTexCoords).rgb,<span class="hljs-built_in">vec3</span>(<span class="hljs-number">2.2</span>));<br><br>vec3 N = <span class="hljs-built_in">normalize</span>(vNormal);<br>vec3 V = <span class="hljs-built_in">normalize</span>(uCameraPos - vWorldPos);<br>vec3 R = <span class="hljs-built_in">reflect</span>(-V, N);<br><br>vec3 F0 = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.04</span>); <br>F0 = <span class="hljs-built_in">mix</span>(F0, albedo, uMetallic);<br>vec3 Lo = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);<br><span class="hljs-keyword">for</span> (uint i = <span class="hljs-number">0u</span>;i &lt; <span class="hljs-number">4u</span>;++i)&#123;<br>    vec3 L = <span class="hljs-built_in">normalize</span>(uLightPos[i] - vWorldPos);<br>    vec3 H = <span class="hljs-built_in">normalize</span>(V + L);<br>    <span class="hljs-comment">// float distance = length(uLightPos[i] - vWorldPos);</span><br>    <span class="hljs-comment">// float attenuation = 1.0 / (distance * distance); </span><br>    vec3 radiance = uLightColors[i] * <span class="hljs-number">1.0</span>;<br>    <span class="hljs-comment">//Cook-Torrance BRDF</span><br>    <span class="hljs-type">float</span> NDF = <span class="hljs-built_in">DistributionGGX</span>(N, H, uRoughness);   <br>    <span class="hljs-type">float</span> G   = <span class="hljs-built_in">GeometrySmith</span>(N, V, L, uRoughness); <br>    vec3 F    = <span class="hljs-built_in">fresnelSchlick</span>(F0, V, H);<br>    <span class="hljs-type">float</span> NdotL = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N,L),<span class="hljs-number">0.0</span>);<br>    <span class="hljs-type">float</span> NdotV = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N,V),<span class="hljs-number">0.0</span>);<br>    vec3 numerator    = NDF * G * F; <br>    <span class="hljs-type">float</span> denominator = <span class="hljs-built_in">max</span>((<span class="hljs-number">4.0</span> * NdotL * NdotV), <span class="hljs-number">0.0000001</span>);<br>    vec3 specular = numerator / denominator;<br>    <span class="hljs-comment">//Reference opengl pbr</span><br>    vec3 diffuse = (<span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>)-F) * (<span class="hljs-number">1.0</span> - uMetallic) * albedo / PI;<br>    <span class="hljs-comment">// Lo += ( diffuse + specular) * radiance * NdotL;</span><br>    Lo += (specular) * radiance * NdotL;<br>&#125;<br>...<br>vec3 color = ambient + Lo;<br><span class="hljs-comment">// HDR tonemapping</span><br>color = color / (color + <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>));<br><span class="hljs-comment">// gamma correct</span><br>color = <span class="hljs-built_in">pow</span>(color, <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>/<span class="hljs-number">2.2</span>)); <br>FragColor = <span class="hljs-built_in">vec4</span>(color, <span class="hljs-number">1.0</span>);<br></code></pre></td></tr></table></figure>ä¸ºäº†å¯¹æ¯”<code>kulla Conty</code>æ–¹æ³•è¿™é‡Œå§<code>diffuse</code>é¡¹å»æ‰ã€‚ä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œä¼šå¾—åˆ°ä¸‹é¢çš„æ•ˆæœï¼š<br /><img src="/img/00018/image-7.png" alt="12" /></p><h1 id="kulla-conty-approximation">Kulla Conty Approximation</h1><h2 id="é¢„è®¡ç®—eÎ¼å’Œe_avg">é¢„è®¡ç®—E(Î¼)å’ŒE_avg</h2><p>åœ¨å¼•å…¥<code>Kulla Conty</code>æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹<code>Cook-Torrance</code>åå°„æ–¹ç¨‹çš„<code>G</code>é¡¹ï¼š<br /><img src="/img/00018/image-8.png" alt="13" /><br /><code>G</code>é¡¹è€ƒè™‘äº†å¾®è¡¨é¢æ¨¡å‹çš„è‡ªé®æŒ¡ç°è±¡ï¼Œåœ¨å‚ç›´è§’åº¦çœ‹å¾®è¡¨é¢æ—¶ï¼Œå‡ ä¹æ²¡æœ‰è‡ªé®æŒ¡ç°è±¡ï¼Œè€Œåœ¨æ å°„è§’æ–¹å‘çœ‹å‘å¾®è¡¨é¢æ—¶ï¼Œè‡ªé®æŒ¡ç°è±¡å°±ä¼šå¾ˆä¸¥é‡ï¼Œè¿™æ˜¯ç¬¦åˆç‰©ç†ç°è±¡çš„ã€‚ä½†æ˜¯<code>G</code>é¡¹åªè€ƒè™‘äº†å…‰çº¿åœ¨å¾®è¡¨é¢ä¸Šä¸€æ¬¡åå°„åçš„ç»“æœï¼Œè¿™å°±å¯¼è‡´å¿…å®šä¼šæœ‰ä¸€éƒ¨åˆ†å‚ä¸åç»­å¼¹å°„çš„å…‰çº¿æœªè¢«è€ƒè™‘è¿›å»ï¼Œå½“ç²—ç³™åº¦è¶Šé«˜ï¼Œæ²Ÿå£‘è¶Šå¤§åç»­å¼¹å°„çš„å…‰çº¿å æ¯”è¶Šå¤§èƒ½é‡æŸå¤±å°±è¶Šå¤šã€‚è€Œ<code>kulla conty</code>æ–¹æ³•å°±æ˜¯ä¸ºäº†å¼¥è¡¥è¿™éƒ¨åˆ†æŸå¤±çš„èƒ½é‡ã€‚</p><p>è€ƒè™‘<code>Kulla Conty</code>æ–¹æ³•æ—¶ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“æœ‰å¤šå°‘èƒ½é‡ä¸¢å¤±äº†ï¼Œå¦‚æœåªè€ƒè™‘ä¸€æ¬¡åå°„ï¼Œé‚£ä¸¢å¤±çš„èƒ½é‡å°±æ˜¯<code>1 - ä¸€æ¬¡åå°„</code>ã€‚è€Œå¾®è¡¨é¢åå°„æ¨¡å‹æœ¬æ¥ä¹Ÿå°±æ˜¯åªè€ƒè™‘äº†ä¸€æ¬¡çš„åå°„ï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰å…¥å°„æ–¹å‘<code>Li</code>çš„<code>radiance</code>éƒ½ä¸º<code>1</code>ï¼Œåˆ™ä¸€æ¬¡åå°„åæˆ‘ä»¬èƒ½çœ‹åˆ°çš„èƒ½é‡ä¸ºï¼š<span class="math display">\[E(p,w_o)=\int_{\Omega+}\frac{DG}{4(w_o\cdot n)(w_i\cdot n)}n\cdotw_idw_i \tag{25}\]</span>ç”±äºè¿™é‡Œè€ƒè™‘çš„å…¨åå°„ï¼Œ<code>F</code>è‡ªç„¶å°±<code>1</code>ï¼Œç„¶åæˆ‘ä»¬è®¾<code>Î¼i=cos(wi)</code>:<br /><span class="math display">\[E(\mu_o)=\int_{0}^{2\pi}\int_{0}^{1}f(\mu_o,\mu_i,\phi)\mu_id\mu_id\phi\tag{26}\]</span>è¿™é‡Œ<code>Î¸</code>ç”±<code>Ï€/2</code>åˆ°<code>0</code>ã€‚é—«è€å¸ˆè¯¾ä¸Šè®²çš„æ˜¯ç”¨<code>sinÎ¸</code>å»æ›¿æ¢ï¼Œä½†æ˜¯åé¢è®¡ç®—<code>sinÎ¸</code>è¯´ä¸é€šï¼Œè€Œä¸è®º<code>sinÎ¸</code>æ›¿æ¢è¿˜æ˜¯<code>conÎ¸</code>ï¼Œå…¶æ¨å¯¼å‡ºçš„å…¬å¼éƒ½æ˜¯ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯<code>sinÎ¸</code>ï¼Œ<code>Î¸</code>ç”±<code>0</code>åˆ°<code>Ï€/2</code>ã€‚</p><p>å¾—åˆ°äº†<code>E(Î¼o)</code>åï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥è®¾è®¡å¦ä¸€ä¸ª<code>BRDF</code>ä½¿å¾—å…¶ç§¯åˆ†çš„ç»“æœä¸º<code>1-E(Î¼o)</code>ï¼Œç„¶åå°†ç»“æœåŠ åˆ°åŸæœ‰çš„<code>BRDF</code>ä¸Šé¢ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰èƒ½é‡æŸå¤±äº†ã€‚<br />è¿™ä¸ªæ–°è®¾è®¡çš„<code>BRDF</code>å°±æ˜¯ï¼š<br /><span class="math display">\[f_{ms}(\mu_o,\mu_i)=\frac{(1-E(\mu_o))(1-E(\mu_i))}{\pi(1-E_{avg})}\tag{27}\]</span>å…¶ä¸­<code>E_avg</code>æ˜¯å‡½æ•°<code>E(Î¼)</code>åœ¨åŒºé—´<code>[0,1]</code>çš„å¹³å‡å€¼ï¼š<br /><span class="math display">\[\begin{align}E_{avg}=\frac{\int_{0}^{1}E(\mu)\mu d\mu}{\int_{0}^{1}\mu d\mu} \\=2\int_{0}^{1}E(\mu)\mu d\mu \tag{28}\end{align}\]</span> å…¶æ­£ç¡®æ€§å‚è€ƒè¯¾å ‚ä¸Šç»™çš„è¿‡ç¨‹ï¼š <img src="/img/00018/image-9.png"alt="14" /><br />è¯¥æ–°è®¾è®¡çš„<code>BRDF</code>ä¸­æœ‰ä¸¤ä¸ªç§¯åˆ†å€¼ï¼Œæˆ‘ä»¬åŒæ ·é‡‡ç”¨æ‰“è¡¨çš„å½¢å¼ï¼ŒæŠŠç§¯åˆ†å€¼å­˜åˆ°ä¸€å¼ çº¹ç†ä¸­ã€‚<code>E(Î¼)</code>çš„ç§¯åˆ†å€¼æˆ‘ä»¬åŒæ ·ä½¿ç”¨é‡è¦æ€§é‡‡æ ·æ¥ä¿è¯ç»“æœçš„æ­£ç¡®æ€§ï¼Œå…¶ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Vec3f <span class="hljs-title">IntegrateBRDF</span><span class="hljs-params">(Vec3f V, <span class="hljs-type">float</span> roughness)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> sample_count = <span class="hljs-number">1024</span>;<br>    <span class="hljs-type">float</span> A = <span class="hljs-number">0.0</span>;<br>    <span class="hljs-type">float</span> B = <span class="hljs-number">0.0</span>;<br>    Vec3f N = <span class="hljs-built_in">Vec3f</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; sample_count; i++) &#123;<br>        Vec2f Xi = <span class="hljs-built_in">Hammersley</span>(i, sample_count);<br>        Vec3f H = <span class="hljs-built_in">ImportanceSampleGGX</span>(Xi, N, roughness);<br>        Vec3f L = <span class="hljs-built_in">normalize</span>(H * <span class="hljs-number">2.0f</span> * <span class="hljs-built_in">dot</span>(V, H) - V);<br>        <span class="hljs-type">float</span> NoL = std::<span class="hljs-built_in">max</span>(L.z, <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-type">float</span> NoH = std::<span class="hljs-built_in">max</span>(H.z, <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-type">float</span> VoH = std::<span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(V, H), <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-type">float</span> NoV = std::<span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N, V), <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> To calculate (fr * ni) / p_o here - Bonus 1</span><br>        <span class="hljs-type">float</span> Fc = <span class="hljs-built_in">pow</span>(<span class="hljs-number">1.0f</span> - VoH, <span class="hljs-number">5.0f</span>);<br>        <span class="hljs-type">float</span> G = <span class="hljs-built_in">GeometrySmith</span>(roughness, NoV, NoL);<br>        <span class="hljs-type">float</span> G_Vis  = VoH * G / (NoV * NoH);<br><br>        <span class="hljs-comment">// //no split sum </span><br>        <span class="hljs-comment">// A += G_Vis;</span><br><br>        <span class="hljs-comment">// Split Sum - Bonus 2</span><br>        A += (<span class="hljs-number">1.0</span> - Fc) * G_Vis;<br>        B += Fc * G_Vis;<br>    &#125;<br>    <span class="hljs-comment">// return &#123; A / sample_count, A / sample_count, A / sample_count &#125;; // No split sum version</span><br>    <span class="hljs-keyword">return</span> &#123; A / sample_count, B / sample_count, <span class="hljs-number">0.0</span> &#125;;  <span class="hljs-comment">// Split sum</span><br>&#125;<br></code></pre></td></tr></table></figure>å…¶å®è¿™é‡Œä¸¥è°¨æ¥è¯´ä¸å«<code>Split Sum</code>ï¼Œè¯¥æ–¹æ³•æ˜¯å¯¹å…‰ç…§çš„å‰¥ç¦»ï¼Œæˆ‘åœ¨ä¸Šé¢ç« èŠ‚æœ‰æåˆ°ã€‚ä½†æ˜¯ä½œä¸šè¦æ±‚æœ‰<code>Split Sum</code>çš„æé«˜éƒ¨åˆ†ï¼Œæˆ‘çŒœæµ‹åº”è¯¥æ˜¯æƒ³è®©æˆ‘ä»¬è¿™æ ·å®ç°å§ã€‚ä½†æ˜¯ä»”ç»†è€ƒè™‘çš„è¯å…¶å®ä¹Ÿæ²¡å¿…è¦è¿™ä¹ˆå®ç°ï¼Œå› ä¸ºè®¡ç®—ä¸€æ¬¡åå°„çš„èƒ½é‡ï¼Œå…¶<code>Fresenl</code>é¡¹ä¸º<code>1</code>å³å…¨åå°„ï¼Œè¿™é‡Œä¹Ÿä¸éœ€è¦å°†<code>F0</code>å‰¥ç¦»æ¥ä½¿å‚æ•°é™ç»´ã€‚å°±è¿™æ ·å§ï¼Œè¿™æ ·å¾—åˆ°çš„çº¹ç†å¦‚ä¸‹ï¼š<br />Split Sum<br /><img src="/img/00018/image-10.png" alt="15" /><br />Not Split Sum<br /><img src="/img/00018/image-11.png" alt="16" /></p><p><code>E_avg</code>çš„é¢„è®¡ç®—å°±æ¯”è¾ƒç®€å•äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Vec3f <span class="hljs-title">IntegrateEmu</span><span class="hljs-params">(Vec3f V, <span class="hljs-type">float</span> roughness, <span class="hljs-type">float</span> NdotV, Vec3f Ei)</span> </span>&#123;<br>    Vec3f Eavg = <span class="hljs-built_in">Vec3f</span>(<span class="hljs-number">0.0f</span>);<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> sample_count = <span class="hljs-number">1024</span>;<br>    Vec3f N = <span class="hljs-built_in">Vec3f</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; sample_count; i++) &#123;<br>        Vec2f Xi = <span class="hljs-built_in">Hammersley</span>(i, sample_count);<br>        Vec3f H = <span class="hljs-built_in">ImportanceSampleGGX</span>(Xi, N, roughness);<br>        Vec3f L = <span class="hljs-built_in">normalize</span>(H * <span class="hljs-number">2.0f</span> * <span class="hljs-built_in">dot</span>(V, H) - V);<br>        <span class="hljs-type">float</span> NoL = std::<span class="hljs-built_in">max</span>(L.z, <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-comment">// float pdf = 1;//è·Ÿroughnessæ²¡å…³ç³»</span><br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> To calculate Eavg here</span><br>        Eavg +=  Ei * <span class="hljs-number">2.0f</span> * NoL ;<span class="hljs-comment">//Ei * 2.0f * NoL, NoL : cos thetai</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> Eavg / sample_count;<br>&#125;<br></code></pre></td></tr></table></figure> å¾—åˆ°çº¹ç†å¦‚ä¸‹ï¼š<br />Split Sum<br /><img src="/img/00018/image-12.png" alt="17" /><br />Not Split Sum<br /><img src="/img/00018/image-13.png" alt="18" /></p><h2 id="å®Œæˆkulla-conty-approximation">å®ŒæˆKulla ContyApproximation</h2><p>æˆ‘ä»¬æ‹¿åˆ°å·²ç»é¢„è®¡ç®—å¥½çš„<code>E(Î¼)</code>å’Œ<code>E_avg</code>ï¼Œç°åœ¨å°±å¯ä»¥å°†æ–°è®¾è®¡çš„<code>BRDF</code>ç§¯åˆ†å€¼ç®—å‡ºæ¥äº†ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//split sum</span><br><span class="hljs-function">vec3 <span class="hljs-title">MultiScatterBRDF</span><span class="hljs-params">(<span class="hljs-type">float</span> NdotL, <span class="hljs-type">float</span> NdotV, vec3 F)</span></span><br><span class="hljs-function"></span>&#123;<br>  vec3 albedo = <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">texture</span>(uAlbedoMap, vTexCoords).rgb,<span class="hljs-built_in">vec3</span>(<span class="hljs-number">2.2</span>));<br><br>  <span class="hljs-comment">// A split-sum result in which R-channel repesent F interger term</span><br>  vec3 E_o = <span class="hljs-built_in">texture</span>(uKullaContyBrdflut, <span class="hljs-built_in">vec2</span>(NdotL, uRoughness)).xyz;<br>  vec3 E_i = <span class="hljs-built_in">texture</span>(uKullaContyBrdflut, <span class="hljs-built_in">vec2</span>(NdotV, uRoughness)).xyz;<br>  <span class="hljs-comment">// Split sum result add here.</span><br>  vec3 Emu_o = F * E_o.x + <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>) * E_o.y;<br>  vec3 Emu_i = F * E_i.x + <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>) * E_i.y;<br>  vec3 E_avg = <span class="hljs-built_in">texture</span>(uKullaContyEavglut, <span class="hljs-built_in">vec2</span>(<span class="hljs-number">0</span>, uRoughness)).xyz;<br>  vec3 E_avgss = F * E_avg.x + <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>) * E_avg.y;<br>  ... <br>  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> To calculate fms and missing energy here</span><br>  vec3 F_ms = (<span class="hljs-number">1.0</span> - Emu_o) * (<span class="hljs-number">1.0</span> - Emu_i) / (PI * (<span class="hljs-number">1.0</span> - E_avgss));<br>  ...<br>  <span class="hljs-keyword">return</span> F_ms;<br>&#125;<br></code></pre></td></tr></table></figure>ç›®å‰æ¥è¯´ï¼Œè¿˜åªèƒ½è¡¥å¿<code>albedo</code>ä¸º<code>1</code>æƒ…å†µä¸‹çš„èƒ½é‡ã€‚å¦‚æœç‰©ä½“æœ¬èº«è‡ªå¸¦é¢œè‰²ï¼Œé‚£è¿˜è¦è€ƒè™‘å› ä¸ºç‰©ä½“æœ¬èº«å¸æ”¶èƒ½é‡è€Œå¼•èµ·çš„èƒ½é‡æŸå¤±ã€‚é¦–å…ˆè¦å®šä¸€ä¸ªå¹³å‡<code>Fresenl</code>é¡¹ï¼Œæ¥è¡¨ç¤ºä¸åŒå…¥å°„æ–¹å‘ä¸‹æ‰“åˆ°å¾®è¡¨é¢ï¼Œå¹³å‡è¢«åå°„å‡ºå»çš„èƒ½é‡å æ¯”å¤šå°‘ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br /><span class="math display">\[\begin{align}F_{avg}=\frac{\int_{0}^{1}F(\mu)\mu d\mu}{\int_{0}^{1}\mu d\mu} \\=2\int_{0}^{1}F(\mu)\mu d\mu \tag{29}\end{align}\]</span> è¿™ç¯‡<ahref="https://blog.selfshadow.com/publications/s2017-shading-course/imageworks/s2017_pbs_imageworks_slides_v2.pdf">è®ºæ–‡</a>ä¸­ï¼Œç»™å‡ºäº†è¯¥å…¬å¼ç¡¬ç¼–ç ä¸‹çš„ä»£ç ï¼š<br /><img src="/img/00018/image-14.png" alt="19" /><br />å…¶ä¸­<code>r</code>æ˜¯<code>albedo</code>ï¼Œå…¥å°„è§’ä¸º0åº¦æ—¶ç»™çš„å€¼ã€‚<code>g</code>æ˜¯<code>EdgeTint</code>è¾¹ç¼˜è‰²è°ƒï¼Œå…¥å°„è§’ä¸º80åº¦ç»™çš„å€¼ã€‚è¿™ç¯‡<ahref="https://groups.google.com/g/alshaders/c/IZTbaqJMQBo">æ–‡ç« </a>æ•™äº†æˆ‘ä»¬æ€ä¹ˆç”Ÿæˆè¿™ä¸¤ä¸ªå€¼ï¼Œæˆ‘ç”Ÿæˆäº†é‡‘æè´¨çš„<code>R</code>å’Œ<code>G</code>ã€‚<code>R(0.94423,0.77611,0.37217)</code>ï¼Œ<code>G(0.94806,0.86104,0.60760)</code>ã€‚</p><p>æœ‰äº†<code>å¹³å‡Fresenl</code>é¡¹ï¼Œæˆ‘ä»¬ç°åœ¨ä»æ–°è®¤è¯†ä¸€ä¸‹<code>E_avg</code>ï¼šå«ä¹‰ä¸ºä¸è€ƒè™‘è²æ¶…å°”é¡¹æ—¶ï¼Œä¸åŒå…¥å°„è§’åº¦æ‰“åˆ°å¾®è¡¨é¢æ—¶ï¼Œç¦»å¼€è¡¨é¢åå¹³å‡èƒ½è¢«ä½ çœ‹åˆ°çš„èƒ½é‡ã€‚</p><p>é‚£è€ƒè™‘ä¸Šç‰©ä½“æœ¬èº«ä¼šå¸æ”¶çš„é¢œè‰²ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°ä¸€æ¬¡åå°„åçš„å¹³å‡èƒ½é‡ä¸º<spanclass="math inline">\(F_{avg}E_{avg}\)</span>ï¼Œåˆ™å‘ç”Ÿä¸€æ¬¡åå°„åæ²¡æœ‰å‡ºå»çš„å¹³å‡èƒ½é‡ä¸º<spanclass="math inline">\(F_{avg}(1-E_{avg})\)</span>ï¼Œç„¶åè¿™éƒ¨åˆ†èƒ½é‡å†æ¬¡å‘ç”Ÿåå°„åæˆ‘ä»¬èƒ½çœ‹åˆ°çš„å¹³å‡èƒ½é‡ä¸º<spanclass="math inline">\(F_{avg}(1-E_{avg})F_{avg}E_{avg}\)</span>ï¼Œæ€»ç»“å‡º<code>K</code>æ¬¡åå°„åæˆ‘ä»¬èƒ½çœ‹åˆ°çš„å¹³å‡èƒ½é‡ä¸º<spanclass="math inline">\(F_{avg}^{k}(1-E_{avg})^{k}F_{avg}E_{avg}\)</span>ï¼Œæœ€åå°†è¿™éƒ¨åˆ†èƒ½é‡å…¨éƒ¨åŠ èµ·æ¥ï¼Œå°±æ˜¯ä¸€ä¸ªçº§æ•°ï¼Œå…¶æ•°å­¦å…¬å¼ä¸ºï¼š<br /><span class="math display">\[((F_{avg}(1-E_{avg}))^{0}+(F_{avg}^{}(1-E_{avg}))^{1}+(F_{avg}(1-E_{avg}))^{k})*F_{avg}E_{avg}\tag{30}\]</span>å‰é¢éƒ¨åˆ†æ˜¯ä¸€ä¸ªç­‰æ¯”æ•°åˆ—ï¼Œç”±äº<code>F_avg</code>å’Œ<code>1-E_avg</code>éƒ½æ˜¯å°äº<code>1</code>çš„æ•°ï¼Œæ‰€ä»¥ç»“æœä¸ºï¼š<br /><span class="math display">\[=\frac{F_{avg}E_{avg}}{1-F_{avg}(1-E_{avg})} \tag{31}\]</span>è¯¾å ‚ä¸Šçš„è®²è§£å›¾ç‰‡å¦‚ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„<code>one bounce</code>æŒ‡çš„æ˜¯ä¸¤æ¬¡åå°„ï¼š<br /><img src="/img/00018/image-16.png" alt="20" /><br />è¿™ä¸ªå…¬å¼å°±æ˜¯é¢œè‰²é¡¹ï¼Œæˆ‘ä»¬ç›´æ¥ä¹˜ä¸Šä¹‹å‰æ²¡æœ‰è€ƒè™‘é¢œè‰²æ—¶çš„èƒ½é‡è¡¥å¿é¡¹ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">MultiScatterBRDF</span><span class="hljs-params">(<span class="hljs-type">float</span> NdotL, <span class="hljs-type">float</span> NdotV)</span></span><br><span class="hljs-function"></span>&#123;<br>  vec3 albedo = <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">texture</span>(uAlbedoMap, vTexCoords).rgb,<span class="hljs-built_in">vec3</span>(<span class="hljs-number">2.2</span>));<br>  vec3 E_o = <span class="hljs-built_in">texture</span>(uKullaContyBrdflut, <span class="hljs-built_in">vec2</span>(NdotL, uRoughness)).xyz;<br>  vec3 E_i = <span class="hljs-built_in">texture</span>(uKullaContyBrdflut, <span class="hljs-built_in">vec2</span>(NdotV, uRoughness)).xyz;<br>  vec3 E_avg = <span class="hljs-built_in">texture</span>(uKullaContyEavglut, <span class="hljs-built_in">vec2</span>(<span class="hljs-number">0</span>, uRoughness)).xyz;<br>  <span class="hljs-comment">//gold</span><br>  vec3 edgetint = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.94806</span>,<span class="hljs-number">0.86104</span>,<span class="hljs-number">0.60760</span>);<br>  vec3 F_avg = <span class="hljs-built_in">AverageFresnel</span>(albedo, edgetint);<br>  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> To calculate fms and missing energy here</span><br>  vec3 F_ms = (<span class="hljs-number">1.0</span> - E_o) * (<span class="hljs-number">1.0</span> - E_i) / (PI * (<span class="hljs-number">1.0</span> - E_avg));<br>  vec3 F_add = F_avg * E_avg / (<span class="hljs-number">1.0</span> - F_avg * (<span class="hljs-number">1.0</span> - E_avg));<br>  <span class="hljs-keyword">return</span> F_add * F_ms;<br>&#125;<br></code></pre></td></tr></table></figure> æ•ˆæœå¦‚ä¸‹ï¼š<br /><img src="/img/00018/image-15.png" alt="21" /></p>]]></content>
    
    
    <categories>
      
      <category>Games202</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Games202 Hw3 Screen Space Ray Tracing</title>
    <link href="/2023/06/10/00017.%20Games202%20Hw3/"/>
    <url>/2023/06/10/00017.%20Games202%20Hw3/</url>
    
    <content type="html"><![CDATA[<h1 id="æ•ˆæœå›¾">æ•ˆæœå›¾</h1><p>ç”±äºæµ‹è¯•æ—¶æˆ‘ç”µè„‘çš„GPUæ˜¯åŠå…¬æœ¬çš„æ ¸æ˜¾ï¼ˆGPU AMD Radeon(TM)530ï¼‰ï¼Œå¸§ç‡å¾ˆä½ï¼Œæˆ‘å°±åœ¨æ¯”è¾ƒç®€å•çš„ç¯å¢ƒï¼ˆcube1ï¼‰ä¸‹æ¯”è¾ƒå®ƒä»¬çš„çº¯é•œé¢åå°„å·®å¼‚ã€‚</p><p>World Space SSR<br /><img src="/img/00017/world-fps.png" alt="1" /><br />Efficient GPU SSR<br /><img src="/img/00017/texture-fps.png" alt="2" /><br />Hierarchical-Z SSR<br /><img src="/img/00017/hiz-fps.png" alt="3" /><br />å¯ä»¥çœ‹åˆ°<code>Hierarchical-Z SSR</code>çš„å¸§ç‡æœ€é«˜ï¼Œæ˜¯<code>World Space SSR</code>å¸§ç‡çš„4å€ï¼Œå…¶æ¬¡æ˜¯<code>Efficient GPU SSR</code>æ˜¯<code>World Space SSR</code>å¸§ç‡çš„2å€ã€‚</p><h1 id="ä½œä¸šæ€»è§ˆ">ä½œä¸šæ€»è§ˆ</h1><ol type="1"><li>å®ç°ç›´æ¥å…‰ç…§ã€‚<br /></li><li>å®ç°Screen Space Ray Tracingã€‚<br /></li><li>å®ç°é—´æ¥å…‰ç…§ã€‚<br /></li><li>Bonus 1ï¼šå®ç°Mipmapä¼˜åŒ–çš„ Screen Space Ray Tracingã€‚</li></ol><p>ä¸ªäººæ‰©å±•ï¼š<code>Efficient GPU Screen-Space Ray Tracing</code></p><h1 id="æºç ">æºç </h1><p>æš‚æœªå…¬å¼€ã€‚</p><h1 id="å‰è¨€">å‰è¨€</h1><p>æœ¬æ–‡é‡ç‚¹æ”¾åœ¨ç®—æ³•æœ¬èº«ï¼Œæºç ä¸­ç›¸å…³åœ°æ–¹æ³¨é‡Šå¾ˆæ˜ç¡®ï¼Œå¯¹äºæ¡†æ¶çš„ç†è§£ä¸å†åšè¿‡å¤šè§£é‡Šã€‚<br />æœ¬æ¬¡SSRç®—æ³•æ€»å…±æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«World Space Ray Marching SSR,<ahref="https://jcgt.org/published/0003/04/04/paper.pdf">Efficient GPUSSR</a>å’Œ<ahref="https://sugulee.wordpress.com/2021/01/19/screen-space-reflections-implementation-and-optimization-part-2-hi-z-tracing-method/">Hierarchical-ZSSR</a>ã€‚</p><h1 id="å®ç°">å®ç°</h1><h2 id="world-space-ray-marching-ssr">World Space Ray Marching SSR</h2><p>æœ¬æ¬¡ä½œä¸šçš„åŸºç¡€éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œç®—æ³•æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œæ‰€ä»¥è¿™é‡Œå°±é™„å¸¦å°†<code>SSR Pass</code>çš„å‡†å¤‡å·¥ä½œä¸€å¹¶è®²ä¸€ä¸‹ï¼Œè¿™ä¹Ÿä¸ºåé¢çš„ç®—æ³•åšå¥½å‡†å¤‡ã€‚</p><h3 id="ç›´æ¥å…‰ç…§">ç›´æ¥å…‰ç…§</h3><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹æ¸²æŸ“æ–¹ç¨‹ï¼Œè¿™é‡Œä»¥<code>SSAO</code>ä¸ºä¾‹è®²è§£ä¸€ä¸‹<code>Visibility</code>æ€ä¹ˆå¤„ç†ï¼š<br /><img src="/img/00017/image.png" alt="4" /><br />é€šè¿‡ä¸Šå›¾æ‰€è¯´çš„<code>The RTR Approximation</code>ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°<code>Visibility</code>æ‹†å‡ºåçš„æ–¹ç¨‹ï¼š<br /><span class="math display">\[\begin{align}&amp;L_o(p,w_o)=\int_{\Omega+}L_i(p,w_i)f_r(p,w_i,w_o)V(p,w_i)\cos\theta_idw_i \\&amp; \approx \frac{\rho}{\pi}\cdotL_i(p)\cdot\pi\cdot\frac{\int_{\Omega+}V(p,w_i)\cos\theta_i dw_i}{\pi}\tag{1}\end{align}\]</span>ä½†<code>SSAO</code>è€ƒè™‘çš„æ˜¯<code>diffuse</code>ç‰©ä½“å±€éƒ¨èŒƒå›´å†…ä¸å¸¦é¢œè‰²çš„å…¨å±€å…‰ç…§ï¼Œå…¶ç§¯åˆ†åŸŸåœ¨å„ä¸ªæ–¹å‘ä¸Šéƒ½å¯èƒ½æœ‰è´¡çŒ®ï¼Œæ‰€ä»¥è¿™é‡Œè¦ç®—ç§¯åˆ†å€¼ã€‚<br />è€Œæˆ‘ä»¬è¦å®ç°çš„ç›´æ¥å…‰ç…§æ˜¯æ¥è‡ªå¹³è¡Œå…‰ï¼Œå¹³è¡Œå…‰å’Œç‚¹å…‰æºçš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼š<br />å…‰æºçš„æ–¹å‘æ˜¯ç¡®å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¹³è¡Œå…‰å’Œç‚¹å…‰æºåˆ°ç€è‰²ç‚¹åªä¼šæœ‰ä¸€æ¡å…‰çº¿æœ‰è´¡çŒ®ï¼Œå…¶ä»–æ–¹å‘ä¸Šçš„è´¡çŒ®ä¸º<code>0</code>ã€‚é‚£æˆ‘ä»¬ä¹Ÿå°±ä¸ç”¨ç§¯åˆ†äº†ï¼Œä¸Šè¿°æ¸²æŸ“æ–¹ç¨‹ç›´æ¥ä¸ºï¼š<br /><span class="math display">\[\begin{align}L_o(p,w_o)=L_i(p,w_i)f_r(p,w_i,w_o)V(p,w_i)\cos\theta_i\end{align} \tag{2}\]</span> æ‰€ä»¥ä»£ç å®ç°å°±ç®€å•äº†ï¼Œå¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//ç›´æ¥å…‰ç…§</span><br><span class="hljs-comment">//L = V * Le * brdf * cos</span><br>vec3 L_Normal = <span class="hljs-built_in">GetGBufferNormalWorld</span>(screenUV);<br>L = <span class="hljs-built_in">EvalDiffuse</span>(screenUV) * <span class="hljs-built_in">EvalDirectionalLight</span>(screenUV) * <span class="hljs-built_in">max</span>(<span class="hljs-number">0.</span>, <span class="hljs-built_in">dot</span>(L_Normal, wi));<br></code></pre></td></tr></table></figure><code>V</code>é¡¹åŒ…å«åœ¨<code>EvalDirectionalLight</code>å‡½æ•°ä¸­ã€‚</p><p>å¯ä»¥çœ‹åˆ°<code>Normal</code>ç­‰ä¿¡æ¯æ˜¯ä»<code>Gbuffer</code>ä¸­è·å¾—çš„ï¼Œ<code>Gbuffer</code>çº¹ç†å¯ä»¥ç†è§£æˆæ˜¯å¸§ç¼“å†²çš„<code>Color Attachment</code>ï¼Œæˆ‘ä»¬ç°åœ¨åˆ›å»ºä¸€ä¸ªå¸§ç¼“å†²ï¼Œå¹¶ä¸ºå®ƒæä¾›<code>4</code>ä¸ª<code>Color Attachment</code>:<br /><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FBO</span>&#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">gl, GBufferNum, width, height</span>)&#123;<br>        ...<br>        <span class="hljs-keyword">function</span> <span class="hljs-title function_">CreateAndBindColorTargetTexture</span>(<span class="hljs-params">fbo, attachment, width, height</span>) &#123;<br>            <span class="hljs-comment">//åˆ›å»ºçº¹ç†å¯¹è±¡å¹¶è®¾ç½®å…¶å°ºå¯¸å’Œå‚æ•°</span><br>            <span class="hljs-keyword">var</span> texture = gl.<span class="hljs-title function_">createTexture</span>();<br>            ...<br>            gl.<span class="hljs-title function_">bindTexture</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, texture);<br>            gl.<span class="hljs-title function_">texImage2D</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, <span class="hljs-number">0</span>, gl.<span class="hljs-property">RGBA32F</span>, width, height, <span class="hljs-number">0</span>, gl.<span class="hljs-property">RGBA</span>, gl.<span class="hljs-property">FLOAT</span>, <span class="hljs-literal">null</span>);<br>            ...<br>            gl.<span class="hljs-title function_">framebufferTexture2D</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>, attachment, gl.<span class="hljs-property">TEXTURE_2D</span>, texture, <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">return</span> texture;<br>        &#125;;<br>        ...<br>        <span class="hljs-comment">//åˆ›å»ºå¸§ç¼“å†²åŒºå¯¹è±¡å¹¶ç»‘å®š</span><br>        <span class="hljs-keyword">var</span> framebuffer = gl.<span class="hljs-title function_">createFramebuffer</span>();<br>        gl.<span class="hljs-title function_">bindFramebuffer</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>, framebuffer);<br>        <span class="hljs-comment">//åœ¨JavaScriptä¸­ï¼Œå¯¹è±¡æ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥éšæ—¶æ·»åŠ å±æ€§å’Œæ–¹æ³•</span><br>    framebuffer.<span class="hljs-property">attachments</span> = [];<br>    framebuffer.<span class="hljs-property">textures</span> = []<br>        ...<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-title class_">GBufferNum</span>; i++) &#123;<br>            <span class="hljs-keyword">var</span> attachment = gl.<span class="hljs-property">COLOR_ATTACHMENT0</span> + i;<br>    <span class="hljs-comment">// var texture = CreateAndBindColorTargetTexture(framebuffer, attachment);</span><br>            <span class="hljs-keyword">var</span> texture = <span class="hljs-title class_">CreateAndBindColorTargetTexture</span>(framebuffer, attachment, width, height, <span class="hljs-number">0</span>);<br>    framebuffer.<span class="hljs-property">attachments</span>.<span class="hljs-title function_">push</span>(attachment);<br>    framebuffer.<span class="hljs-property">textures</span>.<span class="hljs-title function_">push</span>(texture);<br><br>            <span class="hljs-keyword">if</span>(gl.<span class="hljs-title function_">checkFramebufferStatus</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>) != gl.<span class="hljs-property">FRAMEBUFFER_COMPLETE</span>)<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gl.<span class="hljs-title function_">checkFramebufferStatus</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>));<br>    &#125;<br>    <span class="hljs-comment">// * Tell the WEBGL_draw_buffers extension which FBO attachments are</span><br>    <span class="hljs-comment">//   being used. (This extension allows for Multiple Render Targets.)</span><br>        gl.<span class="hljs-title function_">drawBuffers</span>(framebuffer.<span class="hljs-property">attachments</span>);<br>        ...<br>        <span class="hljs-keyword">return</span> framebuffer;<br>    &#125;<br>&#125;<br>camera.<span class="hljs-property">fbo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">FBO</span>(gl, <span class="hljs-number">4</span>);<br><span class="hljs-keyword">const</span> directionLight = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectionalLight</span>(lightRadiance, lightPos, lightDir, lightUp, renderer.<span class="hljs-property">gl</span>);<br></code></pre></td></tr></table></figure>å…¶ä¸­<code>ShadowBuffer</code>åœ¨åˆ›å»ºæ–¹å‘å…‰å¯¹è±¡æ—¶è¢«åˆ›å»ºï¼Œè€Œ<code>Gbuffer</code>é™„åŠ åœ¨ç›¸æœºå¯¹è±¡ä¸Šï¼Œ<code>Gbuffer</code>åŒ…å«çš„<code>4</code>å¼ çº¹ç†å¦‚ä¸‹ï¼š<br /><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-keyword">void</span></span>) &#123;<br>  vec3 kd = <span class="hljs-title function_">texture</span>(uKd, vTextureCoord).<span class="hljs-property">rgb</span>;<br>  <span class="hljs-comment">//albedo </span><br>  <span class="hljs-title class_">Frag0</span> = <span class="hljs-title function_">vec4</span>(kd, <span class="hljs-number">1.0</span>);<br>  <span class="hljs-comment">//depth not linear</span><br>  <span class="hljs-title class_">Frag1</span> = <span class="hljs-title function_">vec4</span>(<span class="hljs-title function_">vec3</span>(gl_FragCoord.<span class="hljs-property">z</span>), <span class="hljs-number">1.0</span>);<br>  <span class="hljs-comment">//world space normal(uNt)</span><br>  <span class="hljs-title class_">Frag2</span> = <span class="hljs-title function_">vec4</span>(<span class="hljs-title class_">ApplyTangentNormalMap</span>(), <span class="hljs-number">1.0</span>);<br>  <span class="hljs-comment">//shadow value 0 or 1</span><br>  <span class="hljs-title class_">Frag3</span> = <span class="hljs-title function_">vec4</span>(<span class="hljs-title function_">vec3</span>(<span class="hljs-title class_">SimpleShadowMap</span>(vPosWorld.<span class="hljs-property">xyz</span>, <span class="hljs-number">1e-4</span>)), <span class="hljs-number">1.0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><code>Gbuffer</code>å‡†å¤‡å¥½ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ç›´æ¥å…‰çš„æ•ˆæœäº†ï¼š<br /><img src="/img/00017/image-1.png" alt="5" /></p><h3 id="screen-space-ray-tracing">Screen Space Ray Tracing</h3><p><code>SSR</code>å°±æ˜¯åœ¨å±å¹•ç©ºé—´ä¸Šåšå®æ—¶å…¨å±€å…‰ç…§çš„ä¸€ç§æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯åœ¨å±å¹•ç©ºé—´åš<code>Ray Tracing</code>ï¼Œè€Œä¸”æˆ‘ä»¬ä¸éœ€è¦çŸ¥é“ä¸‰ç»´ç‰©ä½“çš„ä¸‰è§’å½¢ä»¥åŠåŠ é€Ÿç»“æ„ç­‰ï¼Œåªéœ€è¦å±å¹•ç©ºé—´çš„ä¿¡æ¯å³<code>Gbuffer</code>çš„å†…å®¹å°±å¯ä»¥å®Œæˆ<code>Ray Tracing</code>ï¼Œä¹Ÿå°±æ˜¯å¾—åˆ°åœºæ™¯æœ€å¤–çš„ä¸€å±‚å£³ï¼Œç„¶åå’Œè¿™å±‚å£³æ±‚äº¤ã€‚ç¢°åˆ°äº¤ç‚¹åï¼Œè¿˜è¦ç®—äº¤ç‚¹å¯¹<code>ShadingPoint</code>çš„è´¡çŒ®ã€‚</p><p>å…·ä½“å®ç°æ­¥éª¤å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br /><img src="/img/00017/image-2.png" alt="6" /><br />æ ¹æ®<code>BRDF</code>çš„<code>lobe</code>ï¼Œç”Ÿæˆä¸€æ ¹æˆ–å¤šæ ¹å…‰çº¿ï¼Œæˆ‘ä»¬å‡è®¾è¿™é‡Œæ˜¯é•œé¢åå°„ï¼Œé‚£å°±åªéœ€è¦è€ƒè™‘ä¸€æ ¹åå°„å…‰çº¿ï¼Œç„¶åä»¥å›ºå®šæ­¥é•¿æ²¿ç€åå°„å…‰çº¿è¿›è¡Œæ­¥è¿›ï¼Œæ¯æ¬¡æ­¥è¿›éƒ½éœ€è¦æ£€æŸ¥æ­¥è¿›åå…‰çº¿çš„æ·±åº¦å’Œåœºæ™¯çš„æ·±åº¦ï¼Œç›´åˆ°å…‰çº¿æ·±åº¦å¤§äºç­‰äºåœºæ™¯æ·±åº¦ï¼Œå°±è·å–è¯¥äº¤ç‚¹å¤„çš„<code>albedo</code>ï¼Œç„¶åæ ¹æ®æ¸²æŸ“æ–¹ç¨‹è¿›è¡Œ<code>Shading</code>ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">RayMarch</span><span class="hljs-params">(vec3 ori, vec3 dir, out vec3 hitPos)</span> </span>&#123;<br>  <span class="hljs-type">float</span> step = <span class="hljs-number">0.02</span>;<br>  <span class="hljs-type">const</span> <span class="hljs-type">int</span> totalStepTimes = <span class="hljs-number">1000</span>; <br>  <span class="hljs-type">int</span> curStepTimes = <span class="hljs-number">0</span>;<br>  vec3 stepDir = <span class="hljs-built_in">normalize</span>(dir) * step;<br>  vec3 curPos = ori;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> curStepTimes = <span class="hljs-number">0</span>; curStepTimes &lt; totalStepTimes; curStepTimes++)<br>  &#123;<br>    <span class="hljs-type">float</span> curDepth = <span class="hljs-built_in">GetDepth</span>(curPos);<br>    vec2 curScreenUV = <span class="hljs-built_in">GetScreenCoordinate</span>(curPos);<br>    <span class="hljs-type">float</span> gBufferDepth = <span class="hljs-built_in">GetGBufferDepth</span>(curScreenUV);<br><br>    <span class="hljs-keyword">if</span>(curDepth - gBufferDepth &gt; <span class="hljs-number">0.0001</span>)&#123;<br>      hitPos = curPos;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-comment">//o + t * d</span><br>    curPos += stepDir;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-comment">// test Screen Space Ray Tracing </span><br><span class="hljs-function">vec3 <span class="hljs-title">EvalReflect</span><span class="hljs-params">(vec3 wi, vec3 wo, vec2 uv)</span> </span>&#123;<br>  vec3 worldNormal = <span class="hljs-built_in">GetGBufferNormalWorld</span>(uv);<br>  vec3 relfectDir = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">reflect</span>(-wo, worldNormal));<br>  vec3 hitPos;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">RayMarch</span>(vPosWorld.xyz, relfectDir, hitPos))&#123;<br>      vec2 screenUV = <span class="hljs-built_in">GetScreenCoordinate</span>(hitPos);<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetGBufferDiffuse</span>(screenUV);<br>  &#125;<br>  <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);<br>  &#125;<br>&#125;<br><span class="hljs-comment">//test</span><br>L = <span class="hljs-built_in">EvalReflect</span>(wi,wo,screenUV);<br></code></pre></td></tr></table></figure>å½“ç„¶æˆ‘ä»¬è¿™é‡Œåªæ˜¯æµ‹è¯•<code>SSR</code>æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œï¼Œæ²¡æœ‰è€ƒè™‘æ¸²æŸ“æ–¹ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œ<code>EvalReflect</code>åªæ˜¯ç®€å•çš„è¿”å›äº¤ç‚¹å¤„çš„<code>Albedo</code>ã€‚ä¸€åˆ‡æ­£å¸¸çš„è¯å°±ä¼šå¾—åˆ°ä¸‹é¢çš„å›¾ç‰‡ï¼š<br /><img src="/img/00017/world-space.png" alt="7" /></p><h3 id="é—´æ¥å…‰ç…§">é—´æ¥å…‰ç…§</h3><p>æœ‰äº†ä¸Šé¢çš„åŸºç¡€ï¼Œé—´æ¥å…‰ç…§å°±æ˜¯ç›´æ¥ç®—æ¸²æŸ“æ–¹ç¨‹çš„ç§¯åˆ†å€¼ã€‚<br />åœ¨ç®—ç§¯åˆ†ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“é‡‡æ ·æ–¹å‘ä»¥åŠå®ƒçš„<code>Pdf</code>ï¼Œç„¶åç”¨è’™ç‰¹å¡æ´›ç§¯åˆ†æ¥è®¡ç®—ã€‚è¿™é‡Œå¯¹äºå…°ä¼¯ç‰¹æè´¨ç›´æ¥ä½¿ç”¨<code>Cos-weighted</code>é‡‡æ ·ã€‚å…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š<br />ä½¿ç”¨<code>Cos-weighted</code>é‡‡æ ·ï¼Œæ„å‘³ç€<code>Pdf</code>å’Œ<code>Cos</code>é¡¹æˆæ­£æ¯”ï¼Œå³<code>pdf(w)=c*cosÎ¸</code>ï¼Œåˆ™ï¼š<br /><span class="math display">\[\begin{align}&amp; \int_{\Omega^+}pdf(w)dw=1 \\&amp; \int_{\Omega^+}c\cdot\cos\theta dw=1 \\&amp; \int_{0}^{2\pi}\int_{0}^{\pi/2}c\cdot\cos\theta\sin\theta d\thetad\phi \\&amp; =\int_{0}^{2\pi}\int_{0}^{\pi/2}c\cdot\sin\theta d\sin\theta d\phi\\&amp; =\int_{0}^{2\pi}c\cdot \frac{\sin^2\theta}{2}\vert_{0}^{\pi/2}d\phi \\&amp; =c\cdot\pi \tag{3}\end{align}\]</span>åˆ™c=1/Ï€ï¼Œpdf=cosÎ¸/Ï€ã€‚é‡‡æ ·æ–¹å‘è¿˜æ˜¯ç”¨é€†å˜æ¢é‡‡æ ·çš„æ–¹å¼æ¥è·å–ï¼š<br />åˆ†åˆ«æ±‚å…¶è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼š<br /><span class="math display">\[\begin{align}&amp; p(\theta)=\int_{0}^{2\pi}\frac{\cos\theta\sin\theta}{\pi}d\phi \\&amp; =2\cos\theta\sin\theta \\&amp; p(\phi)=\int_{0}^{\pi/2}\frac{\cos\theta\sin\theta}{\pi}d\theta \\&amp; =\frac{\sin^2\theta}{2\pi}\vert_{0}^{\pi/2} \\&amp; =\frac{1}{2\pi} \tag{4}\end{align}\]</span> åˆ†åˆ«æ±‚å…¶ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼š<br /><span class="math display">\[\begin{align}&amp; P(\theta)=\int_{0}^{\theta}2\cos\theta\sin\theta d\theta \\&amp; =\sin^2\theta \\&amp; =1-\cos^2\theta \\&amp; P(\phi)=\int_{0}^{\phi}\frac{1}{2\pi}d\phi \\&amp; =\frac{\phi}{2\pi} \tag{5}\end{align}\]</span> å‡åŒ€çš„ä»<code>U[0,1]</code>ä¸­å–å‡ºä¸¤ä¸ªéšæœºæ•°<spanclass="math inline">\(X_{1}\)</span>å’Œ<spanclass="math inline">\(X_{2}\)</span>,åˆ™æˆ‘ä»¬è¦çš„é‡‡æ ·<code>Î¸</code>å’Œ<code>Ï†</code>ä¸ºï¼š<br /><span class="math display">\[\begin{align}\theta=\arccos(\sqrt{1-X_1}) \\\phi=2\pi X_2 \tag{6}\end{align}\]</span> åˆ™é‡‡æ ·æ–¹å‘vec(x,y,z)ä¸ºï¼š<br /><span class="math display">\[\begin{align}&amp; x=\sin\theta\cos\phi=\sqrt{X_1}\cos(2\pi X_2) \\&amp; y=\sin\theta\sin\phi=\sqrt{X_1}\sin(2\pi X_2) \\&amp; z=\cos\theta=\sqrt{1-X_1} \tag{7}\end{align}\]</span> å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">SampleHemisphereCos</span><span class="hljs-params">(inout <span class="hljs-type">float</span> s, out <span class="hljs-type">float</span> pdf)</span> </span>&#123;<br>  vec2 uv = <span class="hljs-built_in">Rand2</span>(s);<br>  <span class="hljs-type">float</span> z = <span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1.0</span> - uv.x);<br>  <span class="hljs-type">float</span> phi = uv.y * TWO_PI;<br>  <span class="hljs-type">float</span> sinTheta = <span class="hljs-built_in">sqrt</span>(uv.x);<br>  vec3 dir = <span class="hljs-built_in">vec3</span>(sinTheta * <span class="hljs-built_in">cos</span>(phi), sinTheta * <span class="hljs-built_in">sin</span>(phi), z);<br>  pdf = z * INV_PI;<br>  <span class="hljs-keyword">return</span> dir;<br>&#125;<br></code></pre></td></tr></table></figure>è·å¾—çš„é‡‡æ ·æ–¹å‘è¿˜éœ€è¦é€šè¿‡TBNçŸ©é˜µå°†å…¶ä»åˆ‡çº¿ç©ºé—´è½¬æ¢åˆ°ä¸–ç•Œç©ºé—´ï¼Œæœ‰äº†é‡‡æ ·æ–¹å‘å’Œ<code>Pdf</code>ï¼Œç”¨è’™ç‰¹å¡æ´›å…¬å¼è®¡ç®—ç§¯åˆ†å€¼ï¼š<br /><span class="math display">\[\begin{align}L_o(p,w_o)\approx\frac{1}{N}\sum_{k=1}^{N}\frac{L_{i}(p,w_{i})f_{r}(p,w_{i},w_{o})\cos(\theta_{i})}{p(w_{i},w_{o})}\tag{8}\end{align}\]</span> ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//ç›´æ¥å…‰ç…§</span><br><span class="hljs-comment">//L = V * Le * brdf * cos</span><br>vec3 L_Normal = <span class="hljs-built_in">GetGBufferNormalWorld</span>(screenUV);<br>L = <span class="hljs-built_in">EvalDiffuse</span>(screenUV) * <span class="hljs-built_in">EvalDirectionalLight</span>(screenUV) * <span class="hljs-built_in">max</span>(<span class="hljs-number">0.</span>, <span class="hljs-built_in">dot</span>(L_Normal, wi));<br><span class="hljs-comment">//é—´æ¥å…‰</span><br>vec3 L_ind = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SAMPLE_NUM; i++)&#123;<br>  <span class="hljs-type">float</span> pdf;<br>  vec3 localDir = <span class="hljs-built_in">SampleHemisphereCos</span>(s, pdf);<br>  vec3 L_ind_Normal = <span class="hljs-built_in">GetGBufferNormalWorld</span>(screenUV);<br>  vec3 b1, b2;<br>  <span class="hljs-built_in">LocalBasis</span>(L_ind_Normal, b1, b2);<br>  vec3 dir = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">mat3</span>(b1, b2, L_ind_Normal) * localDir);<br>  <span class="hljs-comment">//world space pos</span><br>  vec3 hitPos;<br>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">RayMarch</span>(worldPos, dir, hitPos))&#123;<br>    vec2 hitScreenUV = <span class="hljs-built_in">GetScreenCoordinate</span>(hitPos);<br>    <span class="hljs-comment">//castRay =  V * Le * brdf * cos.</span><br>    vec3 hitNormal = <span class="hljs-built_in">GetGBufferNormalWorld</span>(hitScreenUV);<br>    vec3 castRay = <span class="hljs-built_in">EvalDiffuse</span>(hitScreenUV) * <span class="hljs-built_in">EvalDirectionalLight</span>(hitScreenUV) * <span class="hljs-built_in">max</span>(<span class="hljs-number">0.</span>, <span class="hljs-built_in">dot</span>(hitNormal, wi));<br>    <span class="hljs-comment">//L_ind += castRay * brdf * cos / pdf</span><br>    L_ind += castRay * <span class="hljs-built_in">EvalDiffuse</span>(screenUV) * <span class="hljs-built_in">max</span>(<span class="hljs-number">0.</span>, <span class="hljs-built_in">dot</span>(L_ind_Normal, dir)) / pdf;<br>  &#125;<br>&#125;<br>L_ind /= <span class="hljs-built_in">float</span>(SAMPLE_NUM);<br>L = L + L_ind;<br></code></pre></td></tr></table></figure>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œ<code>World Space Ray Marching SSR</code>çš„æ•ˆæœå¦‚ä¸‹ï¼š<br /><img src="/img/00017/image-3.png" alt="8" /><br />è¦æƒ³å¾—åˆ°ä¸é”™çš„æ•ˆæœéœ€è¦ç”¨å®æ—¶å…‰è¿½é™å™ªæˆ–è€…æé«˜é‡‡æ ·æ•°é‡ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å­¦å®Œå®æ—¶å…‰è¿½é™å™ªååº”ç”¨äºæ­¤ï¼Œæˆ‘ç”µè„‘ä¸è¡Œå°±ä¸æŠ˜è…¾äº†ã€‚ä¸‹é¢æ˜¯æ´ç©´çš„æ•ˆæœï¼š<br /><img src="/img/00017/image-4.png" alt="9" /></p><h2 id="efficient-gpu-ssr">Efficient GPU SSR</h2><h3 id="digital-differential-analyzer">Digital DifferentialAnalyzer</h3><p><code>Efficient GPU SSR</code>çš„æ ¸å¿ƒæ€æƒ³æ˜¯<code>DDA</code>(DigitalDifferential Analyzer)ï¼Œè¯¥ç®—æ³•æ˜¯ç”¨æ•°å€¼æ–¹æ³•æ±‚è§£å¾®åˆ†æ–¹ç¨‹ã€‚<br />æˆ‘ä»¬ç®€å•å›é¡¾ä¸€ä¸‹<code>DDA</code>æ€æƒ³ï¼š<br />ç»™å®šç†æƒ³ç›´çº¿çš„èµ·ç‚¹åæ ‡ä¸º<spanclass="math inline">\(P_0(x_0,y_0)\)</span>ç»ˆç‚¹åæ ‡ä¸º<spanclass="math inline">\(P_1(x_1,y_1)\)</span>ï¼Œç”¨æ–œæˆªå¼è¡¨ç¤ºçš„ç›´çº¿æ–¹ç¨‹ä¸ºï¼š<br /><span class="math display">\[\begin{align}y=kx+b \tag{9}\end{align}\]</span> å…¶ä¸­ç›´çº¿çš„æ–œç‡ä¸º<span class="math inline">\(k=\frac{\Deltay}{\Delta x}\)</span>ï¼Œ<span class="math inline">\(\Deltax=x_1-x_0\)</span>ä¸ºæ°´å¹³æ–¹å‘ä½ç§»ï¼Œ<span class="math inline">\(\Deltay=y_1-y_0\)</span>ä¸ºå‚ç›´æ–¹å‘ä½ç§»ï¼Œbä¸ºyè½´ä¸Šçš„æˆªè·ã€‚<br />åœ¨DDAç®—æ³•ä¸­ï¼Œå¸¸æ ¹æ®<span class="math inline">\(\Delta x\)</span>å’Œ<spanclass="math inline">\(\Deltay\)</span>çš„å¤§å°æ¥ç¡®å®šç»˜å›¾çš„ä¸»ä½ç§»æ–¹å‘ï¼Œåœ¨ä¸»ä½ç§»æ–¹å‘ä¸Šæ‰§è¡Œçš„æ˜¯<spanclass="math inline">\(\pm 1\)</span>ï¼Œé€‰å®š<spanclass="math inline">\(\Delta\)</span>è¾ƒå¤§æ–¹å‘ä¸ºä¸»æ–¹å‘ä½¿å¾—æ–œç‡kæ»¡è¶³<spanclass="math inline">\(0\leqk\leq1\)</span>ï¼ˆè‹¥Î´yå¤§äºÎ´xåˆ™äº¤æ¢å®ƒä»¬çš„å€¼ï¼‰ï¼š<br /><img src="/img/00017/image-5.png" alt="10" /><br />ç¡®å®šä¸»æ–¹å‘åï¼Œä¸Šé¢9å¼çš„å¾®åˆ†è¡¨ç¤ºä¸ºï¼š <span class="math display">\[\begin{align}\frac{\text{d}y}{\text{d}x}=\frac{\Delta y}{\Delta x}=\frac{\deltay}{\delta x}=k \tag{10}\end{align}\]</span> å…¶æœ‰é™å·®åˆ†è¿‘ä¼¼è§£ä¸ºï¼š<br /><span class="math display">\[\begin{equation}\left\lbrace\begin{aligned}&amp; x_{i+1}=x_i+\delta x=x_i+1 \\&amp; y_{i+1}=y_i+\delta y=y_i+k\delta x=y_i+k\end{aligned}\right.\end{equation}\]</span> <span class="math inline">\(\Deltax\)</span>æ¯æ¬¡æ­¥è¿›ä¸€ä¸ªåƒç´ ï¼Œæ ¹æ®ä¸Šä¸€æ¬¡çš„ç‚¹ä½<spanclass="math inline">\((x_iï¼Œy_i)\)</span>å°±å¯ä»¥ç¡®å®šå½“å‰çš„ç‚¹<spanclass="math inline">\((x_{i+1},y_{i+1})\)</span>ã€‚æœ€åå°†æ±‚å¾—çš„ç‚¹ä½è¿›è¡Œ<spanclass="math inline">\(\text{int}(y_{i+1}+0.5)\)</span>å–æ•´å³å¯å¾—åˆ°å¯¹åº”çš„åƒç´ ã€‚æœ€åå¾—åˆ°çš„æ•ˆæœå¦‚å›¾ï¼š<br /><img src="/img/00017/image-6.png" alt="11" /></p><h3 id="an-efficient-gpu-dda-solution">An Efficient GPU DDASolution</h3><p>å¯¹äº<code>3D</code>ç©ºé—´ä¸­å¤§å¤šæ•°åå°„å…‰çº¿ï¼Œ<code>3D</code>çº¿æ€§é‡‡æ ·å¹¶ä¸ç­‰åŒäº<code>2D</code>çº¿æ€§é‡‡æ ·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å› æ­¤ï¼Œå³ä½¿æ­¥é•¿å·²ç»å–çš„å¾ˆå°ï¼Œä¸€æ¬¡æ­¥è¿›å¯èƒ½ä¹Ÿä¼šè·³è¿‡å±å¹•ä¸Šçš„å¤šä¸ªåƒç´ ç‚¹ï¼ˆè¿™é‡Œæ˜¯è¯¯å·®çš„ä¸»è¦æ¥æºï¼‰ï¼Œè€Œä¸”ä¼šå‡ºç°å¤šæ¬¡æ­¥è¿›éƒ½æ˜¯å¯¹åŒä¸€ä¸ªåƒç´ ç‚¹é‡‡æ ·çš„æƒ…å†µï¼ˆä½æ•ˆçš„ä¸»è¦åŸå› ï¼‰ã€‚<br /><img src="/img/00017/image-8.png" alt="12" /><br />å³è¾¹çš„æ•ˆæœæ˜¯æˆ‘ä»¬è¿™ä¸€èŠ‚çš„ä¸»è¦å†…å®¹ã€‚</p><p>é‡ç‚¹æ˜¯<code>RayMarching</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„è¾“å…¥æ˜¯<code>ViewSpace</code>ä¸‹çš„åå°„æ–¹å‘ä»¥åŠå®ƒçš„èµ·ç‚¹ï¼Œä¸ºäº†æ–¹ä¾¿è¿™é‡Œè¿˜æ˜¯ä»¥çº¯é•œé¢åå°„ä¸ºä¾‹ï¼Œå…¨å±€å…‰ç…§å‚è€ƒ<code>World Space Ray Marching SSR</code>å¯ä»¥å®ç°ã€‚è·å–è¿™ä¸¤ä¸ªå‚æ•°çš„ä»£ç å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">EvalReflect</span><span class="hljs-params">(vec3 wo,vec2 screenUV)</span> </span>&#123;<br>  vec3 normalWS = <span class="hljs-built_in">GetGBufferNormalWorld</span>(screenUV);<br>  vec3 reflectDir = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">reflect</span>(-wo,normalWS));<br>  vec3 rayOriginWS = vPosWorld.xyz;<br>  vec3 rayEndWS = rayOriginWS + reflectDir * <span class="hljs-number">1.0</span>;<br>  vec3 rayOriginVS = <span class="hljs-built_in">projectToViewSpace</span>(rayOriginWS);<br>  vec3 rayEndVS    = <span class="hljs-built_in">projectToViewSpace</span>(rayEndWS);<br>  vec3 reflectDirVS = <span class="hljs-built_in">normalize</span>(rayEndVS - rayOriginVS);<br>  Ray ray;<br>  ray.Origin = rayOriginVS;<br>  ray.Direction = reflectDirVS;<br><br>  Result result = <span class="hljs-built_in">RayMarching</span>(ray);<br>  <span class="hljs-keyword">if</span>(result.IsHit)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">GetGBufferDiffuse</span>(result.UV / <span class="hljs-built_in">vec2</span>(windowWidth,windowHeight)).xyz;<br>&#125;<br>  <span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><code>3D</code>çº¿æ®µå…‰æ …åŒ–ä¸<code>2D</code>çº¿æ®µå…‰æ …åŒ–éå¸¸ç›¸ä¼¼ã€‚å…‰æ …åŒ–å¯ä»¥å¾ˆå®¹æ˜“åœ°æ²¿è¿­ä»£æ–¹å‘å¯¹ä»»ä½•å±æ€§è¿›è¡Œçº¿æ€§æ’å€¼ã€‚å¦‚æœå±æ€§å¤„äºé½æ¬¡ç©ºé—´ï¼Œåˆ™ç»“æœå°†çº¿æ€§æ’å€¼<code>3D</code>ç©ºé—´ä¸­å¯¹åº”çš„å±æ€§å€¼ã€‚å…·ä½“æ¥è¯´ï¼Œè®¾ç‚¹<code>Q</code>ä¸ºå°„çº¿ä¸Šçš„ä¸€ä¸ª<code>3D</code>ç‚¹ï¼Œ<code>H = MÂ·(Q,1)</code>ä¸ºå…¶å·¦ä¹˜é€è§†æŠ•å½±çŸ©é˜µ<code>M</code>çš„é½æ¬¡é€è§†æŠ•å½±ã€‚å±æ€§<code>k = 1/(HÂ·(0,0,0,1))</code>å’Œ<code>QÂ·k</code>å¯ä»¥åœ¨<code>2D</code>ä¸­çº¿æ€§æ’å€¼ã€‚å› æ­¤ï¼Œå¦‚æœæŠŠè¯¥ç‚¹å’Œé½æ¬¡<code>w</code>çš„å€’æ•°çœ‹ä½œæ˜¯æ²¿<code>2D</code>çº¿çš„å‡½æ•°ï¼Œé‚£ä¹ˆ<code>âˆ‚(QÂ·k) / âˆ‚x</code>ï¼Œ<code>âˆ‚k / âˆ‚x</code>ï¼Œ<code>âˆ‚(QÂ·k) / âˆ‚y</code>ï¼Œå’Œ<code>âˆ‚k / âˆ‚y</code>åœ¨å±å¹•ç©ºé—´ä¸­éƒ½æ˜¯å¸¸æ•°ã€‚</p><p>å…¶ä¸­<code>âˆ‚(QÂ·k) / âˆ‚x</code>ï¼Œ<code>âˆ‚k / âˆ‚x</code>ï¼Œ<code>âˆ‚(QÂ·k) / âˆ‚y</code>ï¼Œå’Œ<code>âˆ‚k / âˆ‚y</code>æ˜¯å‡½æ•°<code>QÂ·k</code>çš„åå¾®åˆ†è¡¨ç¤ºã€‚<br /><code>âˆ‚(QÂ·k) / âˆ‚x</code>è¡¨ç¤ºå‡½æ•° QÂ·k å¯¹ x çš„åå¾®åˆ†ï¼Œå³æ”¹å˜ x æ—¶ QÂ·kçš„å˜åŒ–æƒ…å†µã€‚<br /><code>âˆ‚k / âˆ‚x</code>è¡¨ç¤ºå‡½æ•° k å¯¹ x çš„åå¾®åˆ†ï¼Œå³æ”¹å˜ x æ—¶ kçš„å˜åŒ–æƒ…å†µã€‚<br /><code>âˆ‚(QÂ·k) / âˆ‚y</code>è¡¨ç¤ºå‡½æ•° QÂ·k å¯¹ y çš„åå¾®åˆ†ï¼Œå³æ”¹å˜ y æ—¶ QÂ·kçš„å˜åŒ–æƒ…å†µã€‚<br /><code>âˆ‚k / âˆ‚y</code>è¡¨ç¤ºå‡½æ•° k å¯¹ y çš„åå¾®åˆ†ï¼Œå³æ”¹å˜ y æ—¶ kçš„å˜åŒ–æƒ…å†µã€‚</p><p>åœ¨ä»»æ„<code>2D</code>çº¿æ®µä¸Šçš„ç‚¹<spanclass="math inline">\(Q(xï¼Œy)\)</span>ï¼Œå…¶å¯¹åº”çš„ä¸‰ç»´ç‚¹ä¸º<spanclass="math inline">\(Q&#39;\)</span>:<br /><span class="math display">\[\begin{align}&amp; Q&#39;(x,y)=\frac{(QÂ·k)(x,y)}{k(x,y)} \\&amp; Q&#39;(z)=\frac{(QÂ·k)(z)}{k(z)} \tag{11}\end{align}\]</span>æœ‰äº†3Dæ·±åº¦ä¿¡æ¯åï¼Œæˆ‘ä»¬å°±å¯ä»¥å’ŒGbufferä¸­çš„æ·±åº¦ä¿¡æ¯è¿›è¡Œæ¯”å¯¹äº†ã€‚åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬éœ€è¦çŸ¥é“<code>âˆ‚(QÂ·k) / âˆ‚x</code>ï¼Œ<code>âˆ‚k / âˆ‚x</code>åå¾®åˆ†çš„æ•°å€¼è¡¨ç¤ºï¼Œè€ŒGbufferä¸­çš„æ·±åº¦ä¿¡æ¯è¯»å–éœ€è¦å¦ä¸€ä¸ªåå¾®åˆ†<code>âˆ‚y / âˆ‚x</code>ã€‚</p><p>åœ¨ä¸Šé¢æœ‰æåˆ°åœ¨çº¿æ€§æƒ…å†µä¸‹ï¼Œåå¾®åˆ†çš„å€¼éƒ½æ˜¯å¸¸æ•°ï¼Œåˆ™ï¼š<br /><span class="math display">\[\begin{align}&amp; \frac{âˆ‚(QÂ·k)}{âˆ‚x}=\frac{\Delta(QÂ·k)}{\Delta x}=\frac{\delta(QÂ·k)}{\delta x}=dQ \\&amp; \frac{âˆ‚k}{âˆ‚x}=\frac{\Delta k}{\Delta x}=dK \\&amp; \frac{âˆ‚y}{âˆ‚x}=\frac{\Delta y}{\Delta x}=dP \tag{12}\end{align}\]</span>ä¸ºäº†æ–¹ä¾¿è¿™é‡Œå¸¸æ•°åˆ†åˆ«å–åä¸º<code>dQ</code>ï¼Œ<code>dK</code>ï¼Œ<code>dP</code>ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯åï¼Œæˆ‘ä»¬æƒ³è¦çš„å±æ€§å°±å¯ä»¥é€šè¿‡å¢é‡æ¥ç®—å¾—äº†ï¼Œå‡è®¾<code>Q</code>ä¸º<code>(QÂ·k)</code>çš„åˆ«åï¼Œåˆ™<spanclass="math inline">\(Q_{i+1}.z=Q_i.z+Î´Q_i.z=Q_i.z+\delta x\cdotdQ\)</span>ï¼Œå…¶ä¸­<code>Î´x==1</code>ï¼Œç›¸åº”çš„<spanclass="math inline">\(k_{i+1}=k_i+dK\)</span>ã€‚<br />ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Result</span><br>&#123;<br>  <span class="hljs-type">bool</span> IsHit;<br>  vec2 UV;<br>  ...<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Query</span><span class="hljs-params">(<span class="hljs-type">float</span> depth, vec2 uv)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">float</span> depth1 = -<span class="hljs-built_in">LinearizeDepth</span>(<span class="hljs-built_in">texelFetch</span>(uGDepth,<span class="hljs-built_in">ivec2</span>(uv),<span class="hljs-number">0</span>).r);<br>  <span class="hljs-keyword">return</span> depth &lt; depth1;<br>&#125;<br><span class="hljs-comment">//DDA,æ•°å€¼æ–¹æ³•æ±‚è§£å¾®åˆ†æ–¹ç¨‹çš„ç®—æ³•</span><br><span class="hljs-function">Result <span class="hljs-title">RayMarching</span><span class="hljs-params">(Ray ray)</span></span><br><span class="hljs-function"></span>&#123;<br>Result result;<br>  <span class="hljs-comment">//endPos ä¸èƒ½è¶…å‡ºè¿‘å¹³é¢ï¼Œå¦åˆ™åå°„å‡ºçš„é¢œè‰²æ˜¯é”™è¯¯çš„ã€‚è¶…è¿‡çš„è¯originæ²¿diråˆ°è¿‘å¹³é¢çš„è·ç¦» = originåˆ°è¿‘å¹³é¢çš„æœ€çŸ­è·ç¦» / cosÎ¸ï¼ŒcosÎ¸ = dir.z / r;</span><br>  <span class="hljs-type">float</span> rayLength = ((ray.Origin.z + ray.Direction.z * maxDistance) &gt; -uZBufferParams.x) ?<br>  (-uZBufferParams.x - ray.Origin.z) / ray.Direction.z : maxDistance;<br><br>vec3 V0 = ray.Origin;<br>vec3 V1 = ray.Origin + ray.Direction * rayLength;<br>  <span class="hljs-comment">//å°†viewSpaceä¸‹çš„originå’ŒendPosè½¬åˆ°ClipSpace</span><br>vec4 H0 = <span class="hljs-built_in">projectToClipSpace</span>(V0);<br>vec4 H1 = <span class="hljs-built_in">projectToClipSpace</span>(V1);<br><br><span class="hljs-type">float</span> k0 = <span class="hljs-number">1.0</span> / H0.w;<br>  <span class="hljs-type">float</span> k1 = <span class="hljs-number">1.0</span> / H1.w;<br>vec3 Q0 = V0 * k0; <br>  vec3 Q1 = V1 * k1;<br><br><span class="hljs-comment">// NDC-space</span><br>  vec2 P0 = H0.xy * k0;<br>  vec2 P1 = H1.xy * k1;<br>vec2 Size = <span class="hljs-built_in">vec2</span>(windowWidth,windowHeight);<br><span class="hljs-comment">//Screen Space</span><br>P0 = (P0 + <span class="hljs-number">1.0</span>) / <span class="hljs-number">2.0</span> * Size;<br>P1 = (P1 + <span class="hljs-number">1.0</span>) / <span class="hljs-number">2.0</span> * Size;<br><br>vec2 Delta = P1 - P0;<br><br>  <span class="hljs-comment">//æ˜¯å¦é‡æ–°æ’åºï¼Œæˆ‘ä»¬åªå¤„ç†Deltaè¾ƒå¤§æƒ…å†µ</span><br><span class="hljs-type">bool</span> Permute = <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(Delta.x) &lt; <span class="hljs-built_in">abs</span>(Delta.y)) &#123; <br>      Permute = <span class="hljs-literal">true</span>;<br>      Delta = Delta.yx; P0 = P0.yx; P1 = P1.yx; <br>  &#125;<br><span class="hljs-type">float</span> StepDir = <span class="hljs-built_in">sign</span>(Delta.x);<br>  <span class="hljs-type">float</span> Invdx = StepDir / Delta.x;<br><br>  <span class="hljs-comment">//åå¾®åˆ†çš„æ•°å€¼è¡¨ç¤ºæ³•</span><br>  vec3  dQ = (Q1 - Q0) * Invdx;<br>  <span class="hljs-type">float</span> dk = (k1 - k0) * Invdx;<br>  vec2  dP = <span class="hljs-built_in">vec2</span>(StepDir, Delta.y * Invdx);<br><span class="hljs-type">float</span> stride = <span class="hljs-number">2.0</span>;<span class="hljs-comment">//å¯è°ƒ</span><br>  dP *= stride; dQ *= stride; dk *= stride;<br>  <span class="hljs-type">float</span> jitter = <span class="hljs-number">1.0</span>;<span class="hljs-comment">//å¯è°ƒ</span><br>  P0 += dP * jitter; Q0 += dQ * jitter; k0 += dk * jitter;<br><br><span class="hljs-type">float</span> Step = <span class="hljs-number">0.0</span>;<br><span class="hljs-type">float</span> MaxStep = <span class="hljs-number">1000.0</span>;<br><span class="hljs-type">float</span> EndX = P1.x * StepDir;<br><br><span class="hljs-type">float</span> k = k0;<br>vec3 Q = Q0;<br>  vec2 P = P0;<br><span class="hljs-keyword">for</span>(;((P.x * StepDir) &lt;= EndX) &amp;&amp; <br>      Step &lt; MaxStep;<br>      Step+=<span class="hljs-number">1.0</span>,P += dP, Q.z += dQ.z, k += dk)<br>&#123;<br>result.UV = Permute ? P.yx : P;<br><span class="hljs-type">float</span> depth;<br>    <span class="hljs-comment">//At any 2D point (x,y), the corresponding 3D point is Qâ€˜(x,y)=(QÂ·k)(x,y) / k(x,y)ï¼ŒQâ€™(z)=(QÂ·k)(z) / k(z)</span><br>depth = Q.z / k;<br><span class="hljs-keyword">if</span>(result.UV.x &gt; windowWidth || result.UV.x &lt; <span class="hljs-number">0.0</span> || result.UV.y &gt; windowHeight || result.UV.y &lt; <span class="hljs-number">0.0</span>)<br><span class="hljs-keyword">break</span>;<br>result.IsHit = <span class="hljs-built_in">Query</span>(depth, result.UV);<br>    <span class="hljs-keyword">if</span> (result.IsHit)<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>å…¶ä¸­éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ<code>rayLength</code>å…‰çº¿çš„é•¿åº¦ä¸èƒ½è¶…è¿‡è¿‘å¹³é¢ï¼Œå¦åˆ™ä¼šå‡ºé”™ï¼Œå…‰çº¿é•¿åº¦è¶…å‡ºäº†è¿‘å¹³é¢çš„èŒƒå›´åˆ™ç”¨ä¸‹é¢ç­‰å¼è¿›è¡Œçº¦æŸ:<br /><code>originæ²¿diråˆ°è¿‘å¹³é¢çš„è·ç¦» = originåˆ°è¿‘å¹³é¢çš„æœ€çŸ­è·ç¦» / cosÎ¸</code>ï¼Œ<code>cosÎ¸ = dir.z / r</code>ï¼ˆcartesianto spherical in tangent spaceï¼‰ã€‚<br />å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå°†ä¼šå¾—åˆ°ä¸‹é¢æ•ˆæœå›¾ï¼š<br /><img src="/img/00017/image-7.png" alt="13" /></p><h2 id="hierarchical-z-ssr">Hierarchical-Z SSR</h2><p><code>Hi-Z</code>æ˜¯ä¸ºäº†ä¼˜åŒ–çº¿æ€§æ­¥è¿›çš„ç®—æ³•ï¼Œå› ä¸ºæ­¥é•¿æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æ—¶é—´éƒ½æµªè´¹åœ¨äº†æ²¡æœ‰ç¢°æ’çš„ç©ºé—´ä¸­ã€‚<br /><img src="/img/00017/image-9.png" alt="14" /><br />è€Œ<code>Hi-Z</code>ä¼šæ ¹æ®è¯•æ¢æ­¥æ¥åˆ¤æ–­ä¸‹ä¸€æ¬¡æ­¥é•¿çš„è·ç¦»ï¼Œå¦‚æœè¯•æ¢æ­¥æ²¡æœ‰ä¸åœºæ™¯ç›¸äº¤ï¼Œé‚£ä¸‹ä¸€æ¬¡æ­¥è¿›çš„è·ç¦»å°±æ›´å¤§ï¼Œè¿™æ ·æ±‚å¾—çš„äº¤ç‚¹æ‰€ä½¿ç”¨çš„æ­¥è¿›æ¬¡æ•°æ›´å°‘ï¼Œåœ¨ä¿è¯å‡†ç¡®ç‡çš„æƒ…å†µä¸‹ï¼Œæ•ˆç‡ä¹Ÿå¾—åˆ°äº†æå¤§çš„æå‡ï¼</p><p><code>Hi-Z</code>æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ª<code>Depth Mipmap</code>åŠ é€Ÿç»“æ„ï¼Œç§°ä¸º<code>Hi-Z buffer</code>ã€‚è¯¥ç»“æ„æœ¬è´¨ä¸Šæ˜¯åœºæ™¯æ·±åº¦çš„å››å‰æ ‘ï¼Œå…¶ä¸­æ¯ä¸ªå››å‰æ ‘å±‚çº§ä¸­çš„æ¯ä¸ªå•å…ƒæ ¼éƒ½è¢«è®¾ç½®ä¸ºä¸Šä¸€å±‚çº§ä¸­<code>4</code>ä¸ªå•å…ƒæ ¼çš„æœ€å°å€¼ï¼ˆæˆ–æœ€å¤§å€¼ï¼Œå–å†³äºzè½´æ–¹å‘ï¼‰ã€‚<br /><img src="/img/00017/image-10.png" alt="15" /><br />å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¡Œæˆ–åˆ—ä¸æ˜¯å¶æ•°ï¼Œé‡‡æ ·éœ€è¦é¢å¤–å¤šåŠ ä¸€åˆ—æˆ–ä¸€è¡Œï¼Œå¦‚æœéƒ½æ˜¯å¥‡æ•°ï¼Œé‚£ä¹ˆè¿˜è¦é¢å¤–å¤šè€ƒè™‘ä¸€ä¸ªå³ä¸Šè§’çš„åƒç´ ï¼Œå¦‚å›¾ï¼š<br /><img src="/img/00017/image-11.png" alt="16" /><br />è¿™éƒ¨åˆ†ä»£ç æ¯”è¾ƒæ•£å°±ä¸åˆ—å‡ºæ¥äº†ï¼Œç†è§£äº†è¿™ä¸ªè¿‡ç¨‹ï¼Œå®ç°å°±ä¸éš¾äº†ã€‚<br /><code>Depth Mipmap</code>å¯ä»¥ç”¨å¦ä¸€ä¸ª<code>Pass</code>æ¥çœ‹æ¯ä¸€å±‚æ•ˆæœï¼Œæ•ˆæœå¦‚ä¸‹ï¼š<br /><img src="/img/00017/depth-mipmap.gif" alt="17" /><br />è¶Šé»‘è¡¨ç¤ºè¶Šè¿‘ï¼Œçº¯ç™½è‰²å°±æ˜¯æ·±åº¦ä¸º<code>1.0</code>çš„æƒ…å†µæ— é™è¿œã€‚</p><p>æœ‰äº†<code>Depth Mipmap</code>ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å±å¹•ç©ºé—´çš„èµ·ç‚¹å’Œæ–¹å‘ã€‚è·å–è¿™äº›æ•°æ®çš„è¿‡ç¨‹å’Œä¸Šä¸€èŠ‚å·®ä¸å¤šï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">EvalReflect</span><span class="hljs-params">(vec3 wo,vec2 screenUV)</span> </span>&#123;<br>  <span class="hljs-comment">//ä»ä¸–ç•Œåæ ‡ä¸­æ¢å¤Tsä¸­çš„åŸç‚¹å’Œåå°„æ–¹å‘</span><br>  vec3 normalWS = <span class="hljs-built_in">GetGBufferNormalWorld</span>(screenUV);<br>  vec3 reflectDir = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">reflect</span>(-wo,normalWS));<br>  vec3 rayOriginWS = vPosWorld.xyz;<br>  vec3 rayEndWS = rayOriginWS + reflectDir * <span class="hljs-number">1.0</span>;<br>  vec3 rayOriginVS = <span class="hljs-built_in">projectToViewSpace</span>(rayOriginWS);<br>  vec3 rayEndVS    = <span class="hljs-built_in">projectToViewSpace</span>(rayEndWS);<br>  vec4 rayOriginCS = <span class="hljs-built_in">projectToClipSpace</span>(rayOriginVS);<br>  vec4 rayEndCS    = <span class="hljs-built_in">projectToClipSpace</span>(rayEndVS);<br>  rayOriginCS = rayOriginCS.xyzw / rayOriginCS.w;<br>  rayEndCS    = rayEndCS.xyzw / rayEndCS.w;<br>  vec3 rayOriginTS = (<span class="hljs-built_in">vec3</span>(rayOriginCS) + <span class="hljs-number">1.0</span>) * <span class="hljs-number">0.5</span>;<br>  vec3 rayEndTS = (<span class="hljs-built_in">vec3</span>(rayEndCS) + <span class="hljs-number">1.0</span>) * <span class="hljs-number">0.5</span>;<br>  vec3 reflectDirTS = <span class="hljs-built_in">normalize</span>(rayEndTS - rayOriginTS);<br>  <span class="hljs-type">float</span> outMaxDistance = reflectDirTS.x &gt;= <span class="hljs-number">0.0</span> ? (<span class="hljs-number">1.0</span> - rayOriginTS.x) / reflectDirTS.x  : -rayOriginTS.x / reflectDirTS.x;<br>  outMaxDistance = <span class="hljs-built_in">min</span>(outMaxDistance, reflectDirTS.y &lt; <span class="hljs-number">0.0</span> ? (-rayOriginTS.y / reflectDirTS.y) : ( (<span class="hljs-number">1.0</span>-rayOriginTS.y) / reflectDirTS.y));<br>  outMaxDistance = <span class="hljs-built_in">min</span>(outMaxDistance, reflectDirTS.z &lt; <span class="hljs-number">0.0</span> ? (-rayOriginTS.z / reflectDirTS.z) : ((<span class="hljs-number">1.0</span>-rayOriginTS.z)/reflectDirTS.z));<br>  SSRay ray;<br>  ray.rayPosInTS = rayOriginTS;<br>  ray.rayDirInTS = reflectDirTS;<br>  ray.maxDistance = outMaxDistance;<br><br>  vec3 hitPos;<br>  vec3 reflectedColor = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.</span>);<br>  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">FindIntersection_HiZ</span>(ray, hitPos)) &#123;<br>    reflectedColor = <span class="hljs-built_in">GetGBufferDiffuse</span>(hitPos.xy);<br>  &#125;<br>  <span class="hljs-keyword">return</span> reflectedColor;<br>&#125;<br></code></pre></td></tr></table></figure>è¿™é‡Œ<code>outMaxDistance</code>æ˜¯é˜²æ­¢åå°„ç»ˆç‚¹è¶…å‡ºå±å¹•è€Œæµªè´¹æ€§èƒ½ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯é‡å¤´æˆï¼Œ<code>FindIntersection_HiZ</code>å‡½æ•°çš„å®ç°ã€‚<br />è¯¥å‡½æ•°æ ¸å¿ƒåœ°æ–¹å°±æ˜¯è¯•æ¢æ­¥å¦‚ä½•ç¡®å®šä¸‹æ¬¡æ­¥è¿›çš„è·ç¦»ï¼Œå…ˆè¯´ä¸‹è¿™é‡Œè¯•æ¢æ­¥æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Œæˆ‘å…ˆæŠŠç›¸å…³ä»£ç è´´å‡ºæ¥ï¼Œä»¥ä¾¿å‚è€ƒå’Œè§£é‡Šã€‚<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">intersectDepthPlane</span><span class="hljs-params">(in vec3 o, in vec3 d, <span class="hljs-type">float</span> t)</span></span>&#123;<br>  <span class="hljs-keyword">return</span> o + d * t;<br>&#125;<br>...<br>vec3 start = ss_ray.rayPosInTS;<br>vec3 rayDir = ss_ray.rayDirInTS;<br><span class="hljs-type">float</span> maxTraceDistance = ss_ray.maxDistance;<br>vec3 ray = start;<br><span class="hljs-type">float</span> minZ = ray.z;<br><span class="hljs-type">float</span> maxZ = ray.z + rayDir.z * maxTraceDistance;<br><span class="hljs-type">float</span> deltaZ = (maxZ - minZ);<br>vec3 o = ray;<br>vec3 d = rayDir * maxTraceDistance;<br>...<br><span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹æ‰€åœ¨å•å…ƒæ ¼çš„GbufferDepth</span><br><span class="hljs-type">float</span> cell_minZ = <span class="hljs-built_in">getMinimumDepthPlane</span>((oldCellIdx + <span class="hljs-number">0.5</span>) / cellCount, level);    <br><span class="hljs-comment">//è¯•æ¢æ­¥ï¼šæ­¥è¿›èµ·ç‚¹çš„æ·±åº¦å°äºGbufferDepthï¼Œåˆ™æ­¥è¿›åˆ°ray.z &gt;= gbufferDepthçš„åœ°æ–¹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ–°çš„tmpRay.xyè¶…è¿‡1.0ï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯è¯•æ¢æ­¥ï¼Œå®é™…æ­¥è¿›æ˜¯ç”¨intersectCellBoundaryè¿™ä¸ªå‡½æ•°å®Œæˆã€‚</span><br>vec3 tmpRay = (cell_minZ &gt; ray.z) ? <span class="hljs-built_in">intersectDepthPlane</span>(o, d, (cell_minZ - minZ) / deltaZ) : ray;<br></code></pre></td></tr></table></figure>ä»¥åå°„èµ·ç‚¹<code>ray</code>ä¸ºä¾‹ï¼Œæˆ‘ä»¬å‡è®¾è¿™é‡Œ<code>ray</code>å·²ç»å‘<code>rayDir</code>æ­¥è¿›äº†ä¸€å°æ®µè·ç¦»ä»¥é˜²æ­¢è‡ªç›¸äº¤ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸‹<code>intersectDepthPlane</code>è¿™ä¸ªå‡½æ•°ï¼Œä»¥å…¬å¼<code>o+t*d</code>æ¥ç¡®å®šæ­¥è¿›åçš„ç‚¹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„<code>d</code>æŒ‡ä»£çš„æ˜¯éå•ä½å‘é‡ï¼Œå³ï¼š<code>å…‰çº¿ç»ˆç‚¹ - å…‰çº¿èµ·ç‚¹</code>ã€‚è€Œ<code>t</code>åˆ™æ˜¯ä¸€ä¸ªå½’ä¸€åŒ–çš„ç³»æ•°åœ¨<code>[0,1]</code>ä¹‹é—´ï¼Œæœ‰äº†<code>t</code>è¿™ä¸ªç³»æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç²¾ç¡®çš„å¾—åˆ°èµ·ç‚¹æ²¿å…‰çº¿æ­¥è¿›åçš„ç‚¹ã€‚<br />ä¸‹é¢ç”¨å›¾ä¾‹çš„å½¢å¼è¿›ä¸€æ­¥è§£é‡Šè¯•æ¢æ­¥ï¼š<br /><img src="/img/00017/image-12.png" alt="18" /><br />å¯ä»¥çœ‹åˆ°å¦‚æœèµ·ç‚¹<code>A</code>è¦è¯•æ¢åœ°èµ°ä¸€æ­¥ï¼Œè¿™ä¸€æ­¥æœ‰å¯èƒ½ä¼šç›´æ¥è·¨å‡ºå±å¹•ï¼ˆå‡è®¾ç™½è‰²çº¿æ¡ä»£è¡¨å±å¹•çš„ä½ç½®ï¼‰ï¼Œæˆ–è€…è·¨è¿‡äº†å¤šä¸ªåƒç´ ï¼Œä»è€Œé”™è¿‡ä¸­é—´å¯èƒ½ä¼šç›¸äº¤çš„ç‚¹ã€‚æˆ‘ä»¬ä»è¯•æ¢æ­¥ä¸­å¾—åˆ°çš„ä¿¡æ¯å°±æ˜¯ï¼Œå®ƒè¿™ä¸€æ­¥æ˜¯å¦è·¨è¿‡äº†èµ·ç‚¹<code>A</code>æ‰€åœ¨çš„åƒç´ ï¼Œå¦‚æœè·¨è¿‡äº†èµ·ç‚¹<code>A</code>æ‰€åœ¨çš„å•å…ƒæ ¼(åƒç´ )ï¼Œé‚£æˆ‘ä»¬å°±ç”¨å¦ä¸€ä¸ªå‡½æ•°ä½¿å¾—èµ·ç‚¹<code>A</code>æ­¥è¿›åˆ°ä¸‹ä¸€ä¸ªå•å…ƒæ ¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„å•å…ƒæ ¼å’Œ<code>Depth Mipmap</code>å±‚çº§æŒ‚é’©çš„ï¼Œå±‚çº§è¶Šå¤§ï¼Œä¸€ä¸ªå•å…ƒæ ¼çš„æ­¥é•¿å°±è¶Šå¤§ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬è§£é‡Šä¸€ä¸‹å¦‚ä½•è®©èµ·ç‚¹<code>A</code>æ­¥è¿›åˆ°ä¸‹ä¸€ä¸ªå•å…ƒæ ¼ï¼Œè¿˜æ˜¯å…ˆçœ‹ä¸‹ç›¸å…³ä»£ç ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">FindIntersection_HiZ</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  in SSRay ss_ray,</span></span><br><span class="hljs-params"><span class="hljs-function">  out vec3 intersection</span></span><br><span class="hljs-params"><span class="hljs-function">)</span> </span>&#123;<br>  vec3 start = ss_ray.rayPosInTS;<br>  vec3 rayDir = ss_ray.rayDirInTS;<br>  <span class="hljs-type">float</span> maxTraceDistance = ss_ray.maxDistance;<br><br>  vec2 crossStep = <span class="hljs-built_in">vec2</span>(rayDir.x &gt;= <span class="hljs-number">0.0</span> ? <span class="hljs-number">1.0</span> : <span class="hljs-number">-1.0</span>, rayDir.y &gt;= <span class="hljs-number">0.0</span> ? <span class="hljs-number">1.0</span> : <span class="hljs-number">-1.0</span>);<br>  vec2 crossOffset = crossStep / <span class="hljs-built_in">vec2</span>(windowWidth,windowHeight) / <span class="hljs-number">128.</span>;<br>  <span class="hljs-comment">//å‡è®¾reflectDirä¸ä¸å±å¹•çš„å®½é«˜å¹³è¡Œ,å¦‚æœæ˜¯å‘å‰æ­¥è¿›ä¸€ä¸ªå•å…ƒæ ¼çš„è·ç¦»ï¼Œboundary = (rayCell + crossStep )/ cell_count + crossOffset,å…¶ä¸­crossOffset &gt; 0.</span><br>  <span class="hljs-comment">//å¦‚æœæ˜¯å‘åæ­¥è¿›ä¸€ä¸ªå•å…ƒæ ¼çš„è·ç¦»ï¼Œboundary = (rayCell + vec(0,0) )/ cell_count + crossOffset,å…¶ä¸­crossOffset &lt; 0.</span><br>  crossStep = <span class="hljs-built_in">saturate</span>(crossStep);<br><br>  vec3 ray = start;<br>  <span class="hljs-type">float</span> minZ = ray.z;<br>  <span class="hljs-type">float</span> maxZ = ray.z + rayDir.z * maxTraceDistance;<br>  <span class="hljs-type">float</span> deltaZ = (maxZ - minZ);<br><br>  vec3 o = ray;<br>  vec3 d = rayDir * maxTraceDistance;<br><br>  <span class="hljs-type">int</span> startLevel = <span class="hljs-number">2</span>;<br>  <span class="hljs-type">int</span> stopLevel = <span class="hljs-number">0</span>;<br><br>  vec2 startCellCount = <span class="hljs-built_in">vec2</span>(<span class="hljs-built_in">getCellCount</span>(startLevel));<br>  <span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹æ‰€åœ¨çš„å•å…ƒæ ¼ã€‚</span><br>  vec2 rayCell = <span class="hljs-built_in">getCell</span>(ray.xy, startCellCount);<br>  <span class="hljs-comment">//é˜²æ­¢è‡ªç›¸äº¤ã€‚</span><br>  ray = <span class="hljs-built_in">intersectCellBoundary</span>(o, d, rayCell, startCellCount, crossStep, crossOffset * <span class="hljs-number">128.</span> * <span class="hljs-number">2.</span> );<br><br>  <span class="hljs-type">int</span> level = startLevel;<br>  <span class="hljs-type">int</span> iter = <span class="hljs-number">0</span>;<br>  ...<br><br>  <span class="hljs-keyword">while</span>( level &gt;= stopLevel &amp;&amp; ray.z &lt;= maxZ  &amp;&amp; ++iter &lt; <span class="hljs-number">1000</span>)&#123;<br>    <span class="hljs-comment">//è·å–çº¹ç†åˆ†è¾¨ç‡</span><br>    vec2 cellCount = <span class="hljs-built_in">vec2</span>(<span class="hljs-built_in">getCellCount</span>(level));<br>    <span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹æ‰€åœ¨çš„å•å…ƒæ ¼ç´¢å¼•</span><br>    vec2 oldCellIdx = <span class="hljs-built_in">getCell</span>(ray.xy, cellCount);<br>    <span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹æ‰€åœ¨å•å…ƒæ ¼çš„GbufferDepth</span><br>    <span class="hljs-type">float</span> cell_minZ = <span class="hljs-built_in">getMinimumDepthPlane</span>((oldCellIdx + <span class="hljs-number">0.5</span>) / cellCount, level);<br>    <span class="hljs-keyword">if</span>(cell_minZ == <span class="hljs-number">1.0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<span class="hljs-comment">//è§£å†³SSRæµ‹è¯•çš„é—®é¢˜</span><br>    <span class="hljs-comment">//è¯•æ¢æ­¥ï¼šæ­¥è¿›èµ·ç‚¹çš„æ·±åº¦å°äºGbufferDepthï¼Œåˆ™æ­¥è¿›åˆ°ray.z &gt;= gbufferDepthçš„åœ°æ–¹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ–°çš„tmpRay.xyè¶…è¿‡1.0ï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯è¯•æ¢æ­¥ï¼Œå®é™…æ­¥è¿›æ˜¯ç”¨intersectCellBoundaryè¿™ä¸ªå‡½æ•°å®Œæˆã€‚</span><br>    vec3 tmpRay = (cell_minZ &gt; ray.z) ? <span class="hljs-built_in">intersectDepthPlane</span>(o, d, (cell_minZ - minZ) / deltaZ) : ray;<br>    <span class="hljs-comment">//æ­¤æ¬¡è¯•æ¢æ­¥ç»ˆç‚¹æ‰€åœ¨å•å…ƒæ ¼çš„ç´¢å¼•</span><br>    vec2 newCellIdx = <span class="hljs-built_in">getCell</span>(tmpRay.xy, cellCount);<br>    <span class="hljs-comment">//å¦‚æœåˆ°äº†ç¬¬0å±‚çº§ï¼Œé‚£ä¹ˆè¯´æ˜é©¬ä¸Šå¿«è¦åˆ°äº¤ç‚¹å¤„äº†ï¼Œæ¯”è¾ƒæ·±åº¦å·®å€¼ï¼Œå¦‚æœå·®å€¼å¤§äºæŸä¸ªé˜ˆå€¼ï¼ˆ0.0017ï¼‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨å½“å‰å±‚çº§æ­¥è¿›ä¸€ä¸ªå•å…ƒæ ¼ã€‚</span><br>    <span class="hljs-type">float</span> thickness = level == <span class="hljs-number">0</span> ? (ray.z - cell_minZ) : <span class="hljs-number">0.</span>;<br>    <span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹ä¸åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼ä¸ºtrueã€‚</span><br>    <span class="hljs-type">bool</span> crossed  = (thickness &gt; MAX_THICKNESS)|| <span class="hljs-built_in">crossedCellBoundary</span>(oldCellIdx, newCellIdx);<br>    <span class="hljs-comment">//æ­¥è¿›ï¼šä¸åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼ åˆ™å¯»æ‰¾æœ€è¿‘çš„ä¸€ä¸ªå•å…ƒæ ¼è¿›è¡Œæ­¥è¿›,åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼åˆ™æ­¥è¿›åˆ°è¯•æ¢æ­¥çš„åœ°æ–¹ã€‚</span><br>    ray = crossed ? <span class="hljs-built_in">intersectCellBoundary</span>(o, d, oldCellIdx, cellCount, crossStep, crossOffset) : tmpRay;<br>    <span class="hljs-comment">//ä¸åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼ åˆ™æ­¥è¿›è·ç¦»å†æ¬¡å¢å¤§ï¼Œåœ¨åŒä¸€ä¸ªå•å…ƒæ ¼åˆ™è·ç¦»å‡å°ã€‚</span><br>    level = crossed ? <span class="hljs-built_in">min</span>(MAX_MIPMAP_LEVEL, level + <span class="hljs-number">1</span>): level - <span class="hljs-number">1</span>;<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç”¨<code>tmpRay</code>æ¥æ”¶äº†è¯•æ¢æ­¥çš„ä½ç½®ã€‚ä¸‹é¢åˆ™æ˜¯é€šè¿‡<code>crossedCellBoundary(oldCellIdx, newCellIdx)</code>æ¥åˆ¤æ–­<code>tmpRay</code>æ˜¯å¦å’Œèµ·ç‚¹<code>A</code>åœ¨ç›¸åŒå•å…ƒæ ¼ã€‚å¦‚æœä¸åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼åˆ™<code>crossed</code>ä¸º<code>true</code>ï¼Œæˆ‘ä»¬éœ€è¦ç”¨<code>intersectCellBoundary</code>æ¥ä½¿èµ·ç‚¹<code>A</code>æ­¥è¿›åˆ°ä¸‹ä¸€ä¸ªå•å…ƒæ ¼ã€‚<code>intersectCellBoundary</code>å‡½æ•°çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">intersectCellBoundary</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  vec3 o, </span></span><br><span class="hljs-params"><span class="hljs-function">  vec3 d, </span></span><br><span class="hljs-params"><span class="hljs-function">  vec2 rayCell, </span></span><br><span class="hljs-params"><span class="hljs-function">  vec2 cell_count, </span></span><br><span class="hljs-params"><span class="hljs-function">  vec2 crossStep, </span></span><br><span class="hljs-params"><span class="hljs-function">  vec2 crossOffset</span></span><br><span class="hljs-params"><span class="hljs-function">)</span></span>&#123;<br>  <span class="hljs-comment">//å…‰çº¿æ‰€åœ¨å•å…ƒæ ¼çš„ä¸‹ä¸€ä¸ªå•å…ƒæ ¼</span><br>  vec2 index = rayCell + crossStep;<br>  <span class="hljs-comment">//ä¸‹ä¸€ä¸ªå•å…ƒæ ¼çš„è¾¹ç•Œï¼Œæ ¹æ®å½“å‰levelçš„å•å…ƒæ ¼æ•°é‡å†³å®š</span><br>  vec2 boundary = index / cell_count;<br>  <span class="hljs-comment">//è¾¹ç•Œåç§»ä¸€ç‚¹ï¼Œé˜²æ­¢æ­¥è¿›æ—¶è½åœ¨è¾¹ç•Œä¸Šã€‚</span><br>  boundary += crossOffset;<br>  <span class="hljs-comment">//æ­¥è¿›çš„è·ç¦»</span><br>  vec2 delta = boundary - o.xy;<br>  <span class="hljs-comment">//æ ‡å‡†åŒ–</span><br>  delta /= d.xy;<br>  <span class="hljs-comment">//é€‰æ‹©æœ€å°è¢«æ ‡å‡†åŒ–åçš„æ­¥è¿›å€¼ï¼Œä»£è¡¨æœç€ ç¦»ç°åœ¨å…‰çº¿æ‰€åœ¨å•å…ƒæ ¼æœ€è¿‘çš„ä¸€ä¸ªå•å…ƒæ ¼ æ­¥è¿›</span><br>  <span class="hljs-type">float</span> t = <span class="hljs-built_in">min</span>(delta.x, delta.y);<br>  <span class="hljs-comment">//æ­¥è¿›åçš„ç‚¹</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">intersectDepthPlane</span>(o, d, t);<br>&#125;<br></code></pre></td></tr></table></figure>æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªå‡½æ•°ç›¸å…³çš„å‚æ•°ï¼Œ<code>o</code>ä¸ºæ­¥è¿›èµ·ç‚¹çš„ä½ç½®,<code>d</code>ä¸ºéå•ä½å‘é‡,<code>rayCell</code>ä¸ºèµ·ç‚¹Aæ‰€åœ¨çš„å•å…ƒæ ¼,<code>cell_count</code>ä¸ºå½“å‰DepthMipmapå±‚çº§çš„åˆ†è¾¨ç‡,<code>crossStep</code>ä¸ºè¯¥å•å…ƒæ ¼å‘ä¸‹ä¸€ä¸ªå•å…ƒæ ¼æ­¥è¿›çš„å‘é‡,<code>crossOffset</code>ä¸ºå¾®å°åç§»é˜²æ­¢æ­¥è¿›åçš„ç‚¹è½åœ¨è¾¹ç•Œä¸Šã€‚ä¸‹é¢æˆ‘è¿˜æ˜¯ç”¨å›¾ä¾‹çš„å½¢å¼è¿›ä¸€æ­¥è§£é‡Šè¿™ä¸ªå‡½æ•°å¦‚ä½•å·¥ä½œçš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¿½ç•¥zå€¼ï¼š<br /><img src="/img/00017/image-13.png" alt="19" /><br />è¿™é‡Œ<code>o(0,0.125)</code>ä¸ºå…‰çº¿èµ·ç‚¹ï¼Œ<code>endPos(1,0.5)</code>ä¸ºå…‰çº¿ç»ˆç‚¹ï¼Œ<code>c(0.45,0.3)</code>ä¸ºæ­¥è¿›èµ·ç‚¹ï¼Œæˆ‘ä»¬è¦æ±‚çš„ç‚¹ä¸º<code>nextc</code>ã€‚å…‰çº¿èµ·ç‚¹<code>c</code>æ‰€åœ¨çš„å•å…ƒæ ¼<code>rayCell(1,1)</code>ï¼Œè¿™é‡Œå› ä¸º<code>d(1,0.375)</code>çš„ä¸¤ä¸ªåˆ†é‡éƒ½å¤§äºé›¶æ‰€ä»¥<code>crossStep</code>ä¸º<code>(1,1)</code>ï¼Œ<code>cell_count</code>åˆ™æ˜¯å½“å‰å±‚çº§çš„åˆ†è¾¨ç‡ä¸º<code>(4,4)</code>ã€‚<br /><code>rayCell</code>æ ¹æ®<code>crossStep</code>ï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå•å…ƒæ ¼ï¼Œå³ç´«è‰²ç‚¹æ‰€åœ¨ä½ç½®ï¼ˆè¿™é‡Œå¿½ç•¥äº†åç§»å€¼ï¼‰ã€‚ç„¶åé™¤ä»¥<code>cell_count</code>å¾—åˆ°å®ƒä»¬çš„ç›¸å¯¹ä½ç½®å³<code>boundary(0.5,0.5)</code>ã€‚<br />å†é€šè¿‡å…¬å¼<code>(boundary - o.xy) / d.xy</code>æ¥ç¡®å®šå½’ä¸€åŒ–çš„ç³»æ•°<code>t</code>ï¼Œé€šè¿‡å›¾ä¾‹å’Œè®¡ç®—æˆ‘ä»¬å¾ˆå®¹æ˜“çš„è§‚å¯Ÿåˆ°ï¼Œæ­¤æ—¶<code>x</code>åˆ†é‡çš„ç³»æ•°<code>t</code>æ˜¯<code>y</code>åˆ†é‡çš„<code>0.5</code>å€ï¼Œå³å…‰çº¿<code>d</code>éœ€è¦èµ°åˆ°<code>endPos</code>ï¼Œ<code>nextc</code>çš„<code>y</code>åˆ†é‡æ‰å’Œ<code>boundary</code>çš„<code>y</code>åˆ†é‡ç›¸ç­‰ï¼Œè€Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œé€‰æ‹©ç³»æ•°ç›¸å¯¹è¾ƒå°çš„æ¥æ­¥è¿›ï¼Œè¿™æ ·é€šè¿‡å…¬å¼<code>o+t*d</code>å°±å¯ä»¥å‡†ç¡®å¾—åˆ°æ­¥è¿›åˆ°ä¸‹ä¸€ä¸ªå•å…ƒæ ¼çš„ç›¸å¯¹åæ ‡äº†ï¼ˆè¿™é‡Œçº¢è‰²ç‚¹å’Œè“è‰²ç‚¹åº”è¯¥åœ¨å…‰çº¿<code>d</code>ä¸Šé¢ï¼Œè¿™é‡Œä¸ºäº†å–å€¼æ–¹ä¾¿æ²¡æœ‰ç”»åœ¨ä¸€èµ·ï¼‰ã€‚<br />åŒç†å½“æ­¥è¿›èµ·ç‚¹å‘åæ–¹å‘æ­¥è¿›æ—¶ï¼Œå°†<code>o</code>å’Œ<code>endPos</code>åè¿‡æ¥ï¼Œå¹¶ä¸”<code>crossStep</code>ä¸º<code>(0,0)</code>æ—¶ä¹Ÿå¯ä»¥å¾—åˆ°æ­¥è¿›åçš„ç‚¹ï¼Œè¿™é‡Œå°±ä¸å†è§£é‡Šäº†ã€‚</p><p>è¿˜æœ‰æœ€åä¸€ä»¶äº‹æƒ…æ²¡åšï¼Œæˆ‘ä»¬ä¸Šé¢è®¨è®ºçš„æƒ…å†µåªé€‚ç”¨äºå‘å‰è¿½è¸ªï¼Œå¦‚æœå‘åè¿½è¸ªï¼Œå³å‘<code>nearPlane</code>æ­¥è¿›ï¼Œç›´æ¥ç”¨ä¸Šé¢çš„ç®—æ³•ä¼šå‡ºé”™ã€‚è¿™æ˜¯å› ä¸ºè¯•æ¢æ­¥å‡½æ•°<code>intersectDepthPlane(o, d, (cell_minZ - minZ) / deltaZ)</code>ï¼Œå¤„ç†ä¸äº†å‘åæ­¥è¿›çš„æƒ…å†µï¼Œæˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ª<code>cell_minZ</code>å˜é‡ï¼Œå¦‚æœæ˜¯å‘åæ­¥è¿›ï¼Œè¿™ä¸ªå˜é‡çš„å€¼åªä¼šä¸€ç›´é€’å‡ï¼Œç›¸åº”çš„ç³»æ•°<code>t</code>ä¹Ÿä¼šä¸€ç›´é€’å‡ï¼Œä»è€Œæ— æ³•å®Œæˆè¯•æ¢æ­¥æ­¥è¿›çš„å·¥ä½œã€‚ä½†æ˜¯å¹¸è¿çš„æ˜¯ï¼Œå‘åè¿½è¸ªçš„æƒ…å†µæ¯”å‘å‰è¿½è¸ªç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨ä¸€ä¸ªæ–¹å‘å¸ƒå°”å˜é‡æ¥æ§åˆ¶ç®—æ³•æµç¨‹ã€‚<br />åœ¨æ¯æ¬¡è¿­ä»£ä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°äº†æ­¥è¿›èµ·ç‚¹æ‰€å¯¹åº”çš„<code>Depth Mipmap</code>åœºæ™¯æ·±åº¦<code>cell_minZ</code>ï¼Œå½“åœºæ™¯æ·±åº¦å¤§äºæ­¥è¿›èµ·ç‚¹æ·±åº¦æ—¶ï¼Œæˆ‘ä»¬å°±è°ƒç”¨<code>intersectCellBoundary</code>æ¥æ­¥è¿›åˆ°ä¸‹ä¸€ä¸ªå•å…ƒæ ¼ï¼Œè€Œä¸éœ€è¦ç»è¿‡è¯•æ¢æ­¥æ¥å†³å®šã€‚<br />æ•´ä¸ª<code>Hi-z</code>ç®—æ³•ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">FindIntersection_HiZ</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">  in SSRay ss_ray,</span></span><br><span class="hljs-params"><span class="hljs-function">  out vec3 intersection</span></span><br><span class="hljs-params"><span class="hljs-function">)</span> </span>&#123;<br>  vec3 start = ss_ray.rayPosInTS;<br>  vec3 rayDir = ss_ray.rayDirInTS;<br>  <span class="hljs-type">float</span> maxTraceDistance = ss_ray.maxDistance;<br><br>  vec2 crossStep = <span class="hljs-built_in">vec2</span>(rayDir.x &gt;= <span class="hljs-number">0.0</span> ? <span class="hljs-number">1.0</span> : <span class="hljs-number">-1.0</span>, rayDir.y &gt;= <span class="hljs-number">0.0</span> ? <span class="hljs-number">1.0</span> : <span class="hljs-number">-1.0</span>);<br>  vec2 crossOffset = crossStep / <span class="hljs-built_in">vec2</span>(windowWidth,windowHeight) / <span class="hljs-number">128.</span>;<br>  <span class="hljs-comment">//å‡è®¾reflectDirä¸ä¸å±å¹•çš„å®½é«˜å¹³è¡Œ,å¦‚æœæ˜¯å‘å‰æ­¥è¿›ä¸€ä¸ªå•å…ƒæ ¼çš„è·ç¦»ï¼Œboundary = (rayCell + crossStep )/ cell_count + crossOffset,å…¶ä¸­crossOffset &gt; 0.</span><br>  <span class="hljs-comment">//å¦‚æœæ˜¯å‘åæ­¥è¿›ä¸€ä¸ªå•å…ƒæ ¼çš„è·ç¦»ï¼Œboundary = (rayCell + vec(0,0) )/ cell_count + crossOffset,å…¶ä¸­crossOffset &lt; 0.</span><br>  crossStep = <span class="hljs-built_in">saturate</span>(crossStep);<br><br>  vec3 ray = start;<br>  <span class="hljs-type">float</span> minZ = ray.z;<br>  <span class="hljs-type">float</span> maxZ = ray.z + rayDir.z * maxTraceDistance;<br>  <span class="hljs-type">float</span> deltaZ = (maxZ - minZ);<br><br>  vec3 o = ray;<br>  vec3 d = rayDir * maxTraceDistance;<br><br>  <span class="hljs-type">int</span> startLevel = <span class="hljs-number">2</span>;<br>  <span class="hljs-type">int</span> stopLevel = <span class="hljs-number">0</span>;<br><br>  vec2 startCellCount = <span class="hljs-built_in">vec2</span>(<span class="hljs-built_in">getCellCount</span>(startLevel));<br>  <span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹æ‰€åœ¨çš„å•å…ƒæ ¼ã€‚</span><br>  vec2 rayCell = <span class="hljs-built_in">getCell</span>(ray.xy, startCellCount);<br>  <span class="hljs-comment">//é˜²æ­¢è‡ªç›¸äº¤ã€‚</span><br>  ray = <span class="hljs-built_in">intersectCellBoundary</span>(o, d, rayCell, startCellCount, crossStep, crossOffset * <span class="hljs-number">128.</span> * <span class="hljs-number">2.</span> );<br><br>  <span class="hljs-type">int</span> level = startLevel;<br>  <span class="hljs-type">int</span> iter = <span class="hljs-number">0</span>;<br>  <span class="hljs-type">bool</span> isBackwardRay = rayDir.z &lt; <span class="hljs-number">0.</span>;<br>  <span class="hljs-type">float</span> Dir = isBackwardRay ? <span class="hljs-number">-1.</span> : <span class="hljs-number">1.</span>;<br>  <span class="hljs-keyword">while</span>( level &gt;= stopLevel &amp;&amp; ray.z * Dir &lt;= maxZ * Dir &amp;&amp; ++iter &lt; <span class="hljs-number">1000</span>)&#123;<br>    <span class="hljs-comment">//è·å–çº¹ç†åˆ†è¾¨ç‡</span><br>    vec2 cellCount = <span class="hljs-built_in">vec2</span>(<span class="hljs-built_in">getCellCount</span>(level));<br>    <span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹æ‰€åœ¨çš„å•å…ƒæ ¼ç´¢å¼•</span><br>    vec2 oldCellIdx = <span class="hljs-built_in">getCell</span>(ray.xy, cellCount);<br>    <span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹æ‰€åœ¨å•å…ƒæ ¼çš„GbufferDepth</span><br>    <span class="hljs-type">float</span> cell_minZ = <span class="hljs-built_in">getMinimumDepthPlane</span>((oldCellIdx + <span class="hljs-number">0.5</span>) / cellCount, level);<br>    <span class="hljs-keyword">if</span>(cell_minZ == <span class="hljs-number">1.0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<span class="hljs-comment">//è§£å†³SSRæµ‹è¯•çš„é—®é¢˜</span><br>    <span class="hljs-comment">//è¯•æ¢æ­¥ï¼šæ­¥è¿›èµ·ç‚¹çš„æ·±åº¦å°äºGbufferDepthï¼Œåˆ™æ­¥è¿›åˆ°ray.z &gt;= gbufferDepthçš„åœ°æ–¹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ–°çš„tmpRay.xyè¶…è¿‡1.0ï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯è¯•æ¢æ­¥ï¼Œå®é™…æ­¥è¿›æ˜¯ç”¨intersectCellBoundaryè¿™ä¸ªå‡½æ•°å®Œæˆã€‚</span><br>    vec3 tmpRay = ((cell_minZ &gt; ray.z) &amp;&amp; !isBackwardRay) ? <span class="hljs-built_in">intersectDepthPlane</span>(o, d, (cell_minZ - minZ) / deltaZ) : ray;<br>    <span class="hljs-comment">//æ­¤æ¬¡è¯•æ¢æ­¥ç»ˆç‚¹æ‰€åœ¨å•å…ƒæ ¼çš„ç´¢å¼•</span><br>    vec2 newCellIdx = <span class="hljs-built_in">getCell</span>(tmpRay.xy, cellCount);<br>    <span class="hljs-comment">//å¦‚æœåˆ°äº†ç¬¬0å±‚çº§ï¼Œé‚£ä¹ˆè¯´æ˜é©¬ä¸Šå¿«è¦åˆ°äº¤ç‚¹å¤„äº†ï¼Œæ¯”è¾ƒæ·±åº¦å·®å€¼ï¼Œå¦‚æœå·®å€¼å¤§äºæŸä¸ªé˜ˆå€¼ï¼ˆ0.0017ï¼‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨å½“å‰å±‚çº§æ­¥è¿›ä¸€ä¸ªå•å…ƒæ ¼ã€‚</span><br>    <span class="hljs-type">float</span> thickness = level == <span class="hljs-number">0</span> ? (ray.z - cell_minZ) : <span class="hljs-number">0.</span>;<br>    <span class="hljs-comment">//æ­¥è¿›èµ·ç‚¹å’Œç»ˆç‚¹ä¸åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼ä¸ºtrueã€‚</span><br>    <span class="hljs-type">bool</span> crossed  = (isBackwardRay &amp;&amp; (cell_minZ &gt; ray.z))||(thickness &gt; MAX_THICKNESS)|| <span class="hljs-built_in">crossedCellBoundary</span>(oldCellIdx, newCellIdx);<br>    <span class="hljs-comment">//æ­¥è¿›ï¼šä¸åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼ åˆ™å¯»æ‰¾æœ€è¿‘çš„ä¸€ä¸ªå•å…ƒæ ¼è¿›è¡Œæ­¥è¿›,åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼åˆ™æ­¥è¿›åˆ°è¯•æ¢æ­¥çš„åœ°æ–¹ã€‚</span><br>    <span class="hljs-comment">//å‰å‘è¿½è¸ªä¸é€‚åˆç”¨åœ¨åå‘è¿½è¸ªï¼Œå¦‚æœæ˜¯backwardRayï¼Œæ²¡æœ‰è¯•æ¢æ­¥ã€‚cell_minZ &gt; ray.zä¸ºtrueåˆ™æ­¥è¿›åˆ°ä¸‹ä¸€ä¸ªå•å…ƒæ ¼level + 1ï¼Œfalseåˆ™ä¿ç•™å½“å‰çŠ¶æ€level - 1ï¼›</span><br>    ray = crossed ? <span class="hljs-built_in">intersectCellBoundary</span>(o, d, oldCellIdx, cellCount, crossStep, crossOffset) : tmpRay;<br>    <span class="hljs-comment">//ä¸åœ¨åŒä¸€ä¸ªå•å…ƒæ ¼ åˆ™æ­¥è¿›è·ç¦»å†æ¬¡å¢å¤§ï¼Œåœ¨åŒä¸€ä¸ªå•å…ƒæ ¼åˆ™è·ç¦»å‡å°ã€‚</span><br>    level = crossed ? <span class="hljs-built_in">min</span>(MAX_MIPMAP_LEVEL, level + <span class="hljs-number">1</span>): level - <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-type">bool</span> intersected = (level &lt; stopLevel);<br>  intersection = intersected ? ray : <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);<br>  <span class="hljs-keyword">return</span> intersected;<br>&#125;<br></code></pre></td></tr></table></figure>è¿™é‡Œ<code>thickness</code>æ˜¯ä¸ºäº†è®©å…‰çº¿ç©¿è¿‡ç‰©ä½“ã€‚ä¸ç„¶æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€äº›é”™è¯¯çš„ç»“æœã€‚</p><p>è¿™èŠ‚çš„å†…å®¹å°†çš„æœ‰ç‚¹<code>HighLevel</code>ï¼Œæ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒ<ahref="https://sugulee.wordpress.com/2021/01/19/screen-space-reflections-implementation-and-optimization-part-2-hi-z-tracing-method/">Hierarchical-ZSSR</a>ã€‚<br />å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå°±ä¼šå¾—åˆ°ä¸‹é¢çš„æ•ˆæœï¼š<br /><img src="/img/00017/image-14.png" alt="20" /><br />å…¨å±€å…‰ç…§å¦‚ä½•å¤„ç†åœ¨ä¸Šé¢<code>World Space Ray Marching SSR</code>å·²ç»è®²è¿‡ï¼Œè¿™é‡Œåªéœ€è¦ç…§ç€åšå°±è¡Œã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Games202</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Games202 Hw3 Precomputed Radiance Transfer</title>
    <link href="/2023/05/29/00016.%20Games202%20Hw3/"/>
    <url>/2023/05/29/00016.%20Games202%20Hw3/</url>
    
    <content type="html"><![CDATA[<h1 id="æ•ˆæœå›¾">æ•ˆæœå›¾</h1><p><img src="/img/00016/PRT.gif" alt="0" /><br /><code>GI</code>æ˜¯ä¸¤æ¬¡<code>Bounce</code>çš„æ•ˆæœï¼Œ<code>DI</code>æ˜¯ç›´æ¥å…‰ç…§çš„æ•ˆæœã€‚</p><h1 id="ä½œä¸šæ€»è§ˆ">ä½œä¸šæ€»è§ˆ</h1><ol type="1"><li>é¢„è®¡ç®—ç¯å¢ƒå…‰ç…§ã€‚<br /></li><li>é¢„è®¡ç®—<code>Diffuse Unshadowed LT</code>ï¼ˆæœ¬æ–‡ä¸è®²ï¼‰ã€‚<br /></li><li>é¢„è®¡ç®—<code>Diffuse Shadowed LT</code>ã€‚<br /></li><li>ä½¿ç”¨é¢„è®¡ç®—çš„æ•°æ®ã€‚<br /></li><li><code>Bonus 1</code>ï¼šæ­£ç¡®å®ç°é¢„è®¡ç®—<code>Diffuse Inter-reflection</code>ã€‚<br /></li><li><code>Bonus 2</code>ï¼šæ­£ç¡®å®ç°<code>SH</code>æ—‹è½¬ï¼ˆæœªå®ç°ï¼‰ã€‚</li></ol><h1 id="æºç ">æºç </h1><p>æš‚æœªå…¬å¼€ã€‚</p><h1 id="å‰è¨€">å‰è¨€</h1><p>æœ¬æ–‡é‡ç‚¹æ”¾åœ¨ç®—æ³•æœ¬èº«ï¼Œæºç ä¸­ç›¸å…³åœ°æ–¹æ³¨é‡Šå¾ˆæ˜ç¡®ï¼Œå¯¹äºæ¡†æ¶çš„ç†è§£ä¸å†åšè¿‡å¤šè§£é‡Šã€‚<br />é¢„è®¡ç®—å…‰ä¼ è¾“ï¼ˆPrecomputed RadianceTransferï¼‰çš„ä¸»è¦ç›®æ ‡æ˜¯åœ¨å¤æ‚å…‰ç…§ç¯å¢ƒä¸‹å®ç°å®æ—¶æ¸²æŸ“ã€‚å®ƒå…¶ä¸­çš„ä¸€ç§æ–¹æ³•æ˜¯åŸºäºçƒé¢è°æ³¢å‡½æ•°ï¼ˆ<ahref="https://en.wikipedia.org/wiki/Spherical_harmonics">Sphericalharmonics</a>ï¼‰æ¥å®Œæˆç¯å¢ƒå…‰çš„é¢„è®¡ç®—ä»¥åŠå…‰ä¼ è¾“çš„é¢„è®¡ç®—ï¼Œç„¶åå°†å®ƒä»¬æŠ•å½±åå¾—åˆ°çš„çƒé¢è°æ³¢ç³»æ•°è¿›è¡Œç‚¹ä¹˜å°±å¯ä»¥å¾—åˆ°å…¨å±€å…‰ç…§çš„æ•ˆæœã€‚é™¤äº†ä½¿ç”¨çƒé¢è°æ³¢å‡½æ•°ä»¥å¤–è¿˜æœ‰å…¶ä»–çš„æ–¹æ³•ï¼Œå…¶ä¸­å¦ä¸€ç§æ˜¯ä½¿ç”¨å°æ³¢å˜ï¼ˆ<ahref="https://en.wikipedia.org/wiki/Wavelet_transform">Wavelettransform</a>ï¼‰æ¢æ¥è¿›è¡Œé¢„è®¡ç®—ï¼Œå°æ³¢å˜æ¢èƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†é«˜é¢‘ç»†èŠ‚ã€‚æœ¬æ–‡ä¼šè®²çƒé¢è°æ³¢å‡½æ•°åœ¨<code>PRT</code>ä¸­çš„åº”ç”¨ä»¥åŠå®ƒçš„è®¡ç®—æ–¹æ³•ï¼Œå¦‚æœå¯¹å°æ³¢å˜æ¢æ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚</p><h1 id="å®ç°">å®ç°</h1><p>åœ¨è®²è§£ä½œä¸šçš„å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç†è§£ä¸€ä¸‹<code>Spherical Harmonic</code>å’Œ<code>Precomputed Radiance Transfer</code>çš„å…³ç³»ï¼Œä»¥ä¾¿åé¢ç†è§£ä¸Šæ²¡æœ‰å›°éš¾ã€‚</p><h2 id="relationship-between-sh-and-prt">Relationship between SH andPRT</h2><p>çƒé¢è°æ³¢å‡½æ•°æ˜¯ä¸€ç³»åˆ—å®šä¹‰åœ¨çƒé¢ä¸Šçš„äºŒç»´åŸºå‡½æ•°ï¼ˆå…³äºæ–¹å‘(Î¸ï¼ŒÏ†)çš„å‡½æ•°ï¼‰ï¼Œè¿™äº›åŸºå‡½æ•°åˆç”±ä¼´éšå‹’è®©å¾·å¤šé¡¹å¼ï¼ˆ<ahref="https://en.wikipedia.org/wiki/Associated_Legendre_polynomials">AssociatedLegendrepolynomials</a>ï¼‰ç»„æˆçš„ã€‚ä¼´éšå‹’è®©å¾·å¤šé¡¹å¼æ˜¯å‹’è®©å¾·æ–¹ç¨‹çš„ä¸€ç±»è§£ï¼Œè€Œå‹’è®©å¾·æ–¹ç¨‹åˆ™æ˜¯ä¸€ç»„åå¾®åˆ†æ–¹ç¨‹ï¼Œæˆ‘ä»¬å°±ç®€å•ç†è§£æˆä¸€ç§æ•°å­¦å·¥å…·å°±è¡Œã€‚<br />åé¢å¯¹çƒé¢è°æ³¢åŸºå‡½æ•°çš„æ•°å­¦è¡¨è¾¾å¼ä»¥<spanclass="math inline">\(B(w)\)</span>æ¥è¡¨ç¤ºã€‚<br />ç°åœ¨çš„é—®é¢˜æ˜¯æˆ‘ä»¬è¯¥æ€ä¹ˆç”¨è¿™ä¸ªæ•°å­¦å·¥å…·æ¥å¸®æˆ‘ä»¬é¢„è®¡ç®—ç¯å¢ƒå…‰ä»¥åŠå…‰ä¼ è¾“ã€‚é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯ä»å‚…é‡Œå¶å˜æ¢è¯´èµ·ï¼š<br /><img src="/img/00016/image.png" alt="1" /><br /><code>f(x)</code>å‡½æ•°å¯ä»¥ç”±è‹¥å¹²ä¸ª<code>sin</code>å’Œ<code>cos</code>å‡½æ•°æ¥é€¼è¿‘ï¼Œè¿™é‡Œå› ä¸º<code>f(x)</code>æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯å¶å‡½æ•°ï¼Œ<code>sin</code>é¡¹å…¨æ˜¯é›¶äº†ã€‚è¿™é‡Œ<code>t,3t,5t...</code>æ˜¯ç”¨æ¥æ§åˆ¶<code>cos</code>çš„é¢‘ç‡ï¼Œè€Œ<spanclass="math inline">\(\frac{2A}{\pi}\)</span>è¿™ç§ç³»æ•°æ˜¯æ§åˆ¶ç›¸ä½ï¼Œè¿™æ ·ç”±æ— ç©·ä¸ª<code>cos</code>ç»„æˆçš„å‡½æ•°å¯ä»¥æ— é™é€¼è¿‘åŸå‡½æ•°<code>f(x)</code>ã€‚ä¸€ä¸ªå‡½æ•°å¯ä»¥è¡¨ç¤ºæˆå…¶ä»–å‡½æ•°çš„çº¿æ€§ç»„åˆï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§°äº›å‡½æ•°ä¸º<code>åŸºå‡½æ•°</code>ã€‚è¿™é‡ŒåŸºå‡½æ•°å‰é¢ä¹˜ä¸Šä¸€ä¸ªç³»æ•°ç„¶ååŠ èµ·æ¥å°±å¯ä»¥å¾—åˆ°åŸå‡½æ•°äº†:<br /><span class="math display">\[\begin{align}f(x)=\sum_{i}c_i\cdot B_i(x) \tag{1}\end{align}\]</span>è¿™äº›ç³»æ•°å¯ä»¥ç”±æŠ•å½±æ“ä½œå¾—åˆ°ï¼Œä¹Ÿå°±æ˜¯ä¸¤ç§å‡½æ•°<code>f(w)</code>,<code>B(w)</code>çš„ä¹˜ç§¯å†ç§¯åˆ†ï¼š<br /><span class="math display">\[\begin{align}c_i=\int_{\Omega}f(w)B_i(w)\text{d}w \tag{2}\end{align}\]</span>è¿™é‡Œ<code>f(w)</code>å°±æ˜¯æˆ‘ä»¬è¦çš„<code>åŸå‡½æ•°</code>ï¼Œ<code>B(w)</code>åˆ™æ˜¯ä¸€ç³»åˆ—<code>çƒé¢è°æ³¢åŸºå‡½æ•°</code>ã€‚åªè¦æœ‰ä¸¤ç§å‡½æ•°å­˜åœ¨è¿™æ ·çš„ä¸€ç§è®¡ç®—æ–¹å¼ï¼Œæˆ‘ä»¬ä¹Ÿè®¤ä¸ºè¿™å­˜åœ¨ä¸€å®šçš„æ»¤æ³¢æ„ä¹‰ã€‚è€Œæ»¤æ³¢åå¾—åˆ°çš„å€¼ï¼Œè¯¥å€¼çš„é¢‘ç‡ç”±<code>f(w)</code>å’Œ<code>B(w)</code>ä¸­æœ€ä½é¢‘çš„å‡½æ•°å†³å®šã€‚</p><p>çƒé¢è°æ³¢åŸºå‡½æ•°çš„å¯è§†åŒ–å¦‚ä¸‹ï¼š<br /><img src="/img/00016/image-1.png" alt="2" /><br />å…¶ä¸­å‰<code>n</code>å±‚çš„åŸºå‡½æ•°ä¸ªæ•°ä¸º<code>n^2</code>ï¼Œé¢œè‰²è¡¨åŸºå‡½æ•°çš„å€¼ï¼Œè¶Šè“çš„åœ°æ–¹å€¼è¶Šå¤§ï¼Œè¶Šé»„çš„åœ°æ–¹å…¶ç»å¯¹å€¼è¶Šå¤§ã€‚è€Œé¢‘ç‡å°±æ˜¯è¿™äº›å€¼çš„å˜åŒ–ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å‡½æ•°é¢‘ç‡æ¯”ä¸Šé¢çš„å‡½æ•°è¦å¤§ã€‚<code>l</code>å±‚æ•°è¶Šå¤§ç”¨åˆ°çš„åŸºå‡½æ•°è¶Šå¤šï¼Œå°±èƒ½è¡¨ç¤ºåŸå‡½æ•°æ›´é«˜é¢‘çš„å†…å®¹ï¼Œä½†æ˜¯å¦‚æœåŸå‡½æ•°æœ¬æ¥å°±å¾ˆä½é¢‘ï¼Œæˆ–è€…å› ä¸ºè¯¥å‡½æ•°<code>f(x)</code>ä¸ä¸€ä¸ªå¾ˆä½é¢‘çš„å‡½æ•°<code>g(x)</code>è¿›è¡Œä¹˜ç§¯å†ç§¯åˆ†ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦ç”¨å‰å‡ å±‚çš„åŸºå‡½æ•°å°±å¯ä»¥æ¢å¤å‡ºåŸå‡½æ•°ã€‚<br />æ‰€ä»¥æˆ‘ä»¬ç”¨çƒé¢è°æ³¢åŸºå‡½æ•°æ¥æ¢å¤<code>Diffuse</code>ç‰©ä½“çš„å…‰ç…§å°±éå¸¸åˆé€‚ï¼Œ<code>Diffuse</code>ç‰©ä½“çš„<code>BRDF</code>æ˜¯ä¸€ä¸ªå¸¸æ•°<spanclass="math inline">\(\frac{c}{\pi}\)</span>ï¼Œè€Œæ‰€éœ€è¦çš„å…‰ç…§ä¹Ÿä¸éœ€è¦å¾ˆé«˜é¢‘ã€‚å®éªŒè¡¨æ˜ï¼Œç”¨å‰ä¸‰å±‚çš„åŸºå‡½æ•°æ¢å¤å‡ºçš„å…‰ç…§ä¿¡æ¯å°±å¯ä»¥ä½¿<code>Diffuse</code>ç‰©ä½“çš„<code>Shading</code>ç»“æœéå¸¸æ­£ç¡®ï¼Œå¹³å‡è¯¯å·®å°äº<code>3%</code>:<br /><img src="/img/00016/image-2.png" alt="3" /><br />éœ€è¦æ³¨æ„çš„æ˜¯çƒé¢è°æ³¢åŸºå‡½æ•°æ˜¯ç”¨æ¥æ¢å¤å…‰ç…§å’Œå…‰ä¼ è¾“ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¸²æŸ“æ–¹ç¨‹ï¼š<br /><img src="/img/00016/image-3.png" alt="4" /><br /><code>Lighting</code>éƒ¨åˆ†å’Œ<code>Light transport</code>éƒ¨åˆ†éƒ½å¯ä»¥é€šè¿‡çƒé¢è°æ³¢åŸºå‡½æ•°æ¥è¿‘ä¼¼ã€‚å¯¹äº<code>Lighting</code>éƒ¨åˆ†ï¼Œç”±äºåŸºå‡½æ•°æ˜¯å›ºå®šçš„ï¼Œåªè¦æˆ‘ä»¬æ±‚å‡ºäº†åœºæ™¯å…‰ç…§å¯¹åº”çš„åŸºå‡½æ•°ç³»æ•°ï¼Œåœ¨åœºæ™¯åˆ‡æ¢æ—¶ï¼Œ<code>shading</code>ç»“æœä¹Ÿå¯ä»¥å‘ç”Ÿæ”¹å˜ã€‚ä½†æ˜¯<code>Light transport</code>éƒ¨åˆ†ï¼Œç”±äºé¢„è®¡ç®—æ—¶ï¼Œæ¯ä¸€ä¸ª<code>Shading point</code>çœ‹å‘åœºæ™¯çš„<code>visibility</code>é¡¹éœ€è¦å›ºå®šä½ï¼Œæ‰€ä»¥åœºæ™¯ä¸­çš„ç‰©ä½“ä¸èƒ½å‘ç”Ÿæ”¹åŠ¨ï¼Œè¿™æ˜¯ä¸€ä¸ªç¼ºç‚¹ã€‚</p><p>å¯¹äºè¿™æ ·ä¸€ä¸ªæ¸²æŸ“æ–¹ç¨‹ï¼Œæˆ‘ä»¬å‡è®¾å…‰æºå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œåœºæ™¯ä¸­çš„ç‰©ä½“éƒ½ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>Lighting</code>å’Œ<code>Light transport</code>æŠ•å½±åˆ°çƒé¢è°æ³¢åŸºå‡½æ•°ä¸Šï¼Œç„¶åè¿›è¡Œé¢„è®¡ç®—ï¼Œå¾—åˆ°ä»–ä»¬çš„åŸºå‡½æ•°ç³»æ•°ï¼Œæœ€åç”¨è¿™äº›ç³»æ•°æ¥è®¡ç®—<code>shading</code>çš„ç»“æœï¼Œè¿™å°±æ˜¯<code>PRT</code>åšçš„äº‹æƒ…ã€‚<br />ç°åœ¨çš„é—®é¢˜æ˜¯æˆ‘ä»¬æ€ä¹ˆé€šè¿‡è¿™äº›åŸºå‡½æ•°ç³»æ•°æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„<code>Shading</code>ç»“æœï¼Œæˆ‘ä»¬æ¥æ·±å…¥äº†è§£ä¸€ä¸‹æ¸²æŸ“æ–¹ç¨‹ç»è¿‡æŠ•å½±çš„å½¢å¼ï¼Œè¿™é‡Œä»¥<code>Diffuse</code>ç‰©ä½“çš„æ¸²æŸ“æ–¹ç¨‹ä¸ºä¾‹ï¼š<br /><img src="/img/00016/image-4.png" alt="5" /><br />è¿™é‡Œ<span class="math inline">\(f_r(p,w_i,w_o)\)</span>ä¸ºå¸¸æ•°<spanclass="math inline">\(\frac{c}{\pi}\)</span>ï¼Œæ•´ä¸ªå³è¾¹æ©™è‰²æ¡†å†…çš„å‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªäºŒç»´çš„çƒé¢å‡½æ•°ï¼Œå› ä¸º<code>Diffuse</code>ç‰©ä½“åœ¨ä»»ä½•æ–¹å‘çœ‹åˆ°ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼Œå³è·Ÿ<code>W_o</code>æ— å…³ã€‚å°†<code>Lighting</code>å’Œ<code>Light transport</code>ç”¨åŸºå‡½æ•°ç³»æ•°å’ŒåŸºå‡½æ•°çš„è¡¨è¾¾å¼å¸¦å…¥æ–¹ç¨‹ä¸­å¾—ï¼š<br /><span class="math display">\[\begin{align}&amp;L_o(p,w_o)=\int_{\Omega+}L_i(p,w_i)f_r(p,w_i,w_o)cos\theta_iV(p,w_i)\text{d}w_i\\&amp; =\int_{\Omega+}\sum_pl_pB_p(w_i)\sum_qt_qB_q(w_i) \\&amp; =\sum_p\sum_ql_pt_q\int_{\Omega+}B_p(w_i)B_q(w_i)\text{d}w_i\tag{3}\end{align}\]</span>è¿™é‡Œæ±‚å’Œçš„ç§¯åˆ†å’Œç§¯åˆ†çš„æ±‚å’Œåœ¨å›¾å½¢å­¦ä¸­å¤§å¤šæ•°æƒ…å†µéƒ½æ˜¯å¯ä»¥äº¤æ¢çš„ã€‚<br />ç”±äºçƒé¢è°æ³¢åŸºå‡½æ•°æ˜¯ä¸€ç»„æ ‡å‡†æ­£äº¤åŸºå‡½æ•°ï¼Œæ‰€ä»¥å…¶å…·å¤‡ä¸€ä¸‹æ€§è´¨ï¼š<br /><span class="math display">\[\begin{align}&amp; \int_{\Omega+}B_i(w)B_j(w)\text{d}w=0,i\neq j \\&amp; \int_{\Omega+}B_i(w)B_j(w)\text{d}w=1,i=j \tag{4}\end{align}\]</span> æ‰€ä»¥ä¸Šé¢<code>3</code>å¼å¯ä»¥å†™æˆä»¥ä¸‹å½¢å¼ï¼š<br /><span class="math display">\[\begin{align}&amp; =\sum_p\sum_ql_pt_q\int_{\Omega+}B_p(w_i)B_q(w_i)\text{d}w_i \\&amp; =\sum_il_it_i \tag{5}\end{align}\]</span>å¦‚æœ<code>Lighting</code>å’Œ<code>Light transport</code>æŠ•å½±åˆ°çƒé¢è°æ³¢åŸºå‡½æ•°çš„å‰<code>3</code>å±‚ï¼Œåˆ™æœ€åå¾—åˆ°çš„åŸºå‡½æ•°ç³»æ•°<code>l_i</code>å’Œ<code>t_i</code>,éƒ½æ˜¯<code>9</code>ç»´å‘é‡ï¼Œåœ¨æœ€å<code>shading</code>æ—¶ï¼Œåƒç´ æ˜¾ç¤ºå‡ºæ¥çš„é¢œè‰²å°±æ˜¯å®ƒä»¬çš„ç‚¹ä¹˜ç»“æœã€‚</p><h2 id="calculate-the-real-basis-spherical-harmonics">Calculate the realbasis spherical harmonics</h2><p>ä¸Šé¢å°èŠ‚æˆ‘ä»¬å·²ç»å¤§è‡´ç†è§£äº†çƒé¢è°æ³¢åŸºå‡½æ•°æ˜¯å¦‚ä½•ç”¨æ¥é¢„è®¡ç®—å…‰ç…§å’Œå…‰ä¼ è¾“ï¼Œä½†æ˜¯å¯¹äºè¿™ä¸ªåŸºå‡½æ•°æ˜¯æ€ä¹ˆæ¥çš„ï¼Œæˆ‘æƒ³å¾ˆå¤šäººè·Ÿæˆ‘ä¸€æ ·æœ‰äº›ç–‘æƒ‘ã€‚è¿™ä¸€å°èŠ‚æˆ‘ä»¬å°±æ¥çœ‹ä¸‹å…·ä½“çš„ä¸€ä¸ªåŸºå‡½æ•°æ˜¯æ€ä¹ˆæ ·ç®—å¾—çš„ï¼Œä»¥åå¦‚æœéœ€è¦ç”¨åˆ°é«˜å±‚åŸºå‡½æ•°ï¼Œèƒ½è‡ªå·±é€šè¿‡ç¨‹åºç®—å‡ºæ¥ã€‚ä¸‹é¢å†…å®¹å¤§éƒ¨åˆ†æ¥è‡ªç»´åŸºç™¾ç§‘ï¼Œæˆ‘åªæ˜¯åšå¥½äº†æ•´ç†å·¥ä½œæ–¹ä¾¿å¤§å®¶ç†è§£ã€‚</p><p><code>SHå‡½æ•°</code>é€šå¸¸æ˜¯åœ¨å¤æ•°åŸŸä¸Šå®šä¹‰çš„ï¼Œè€Œå®æ•°åŸŸçš„<code>SHåŸºå‡½æ•°</code>åˆå¯ä»¥ç”±å¤æ•°åŸŸä¸Šå®šä¹‰çš„<code>SHå‡½æ•°</code>ç®—å¾—ï¼Œ<code>SHåŸºå‡½æ•°</code>åˆ™æ˜¯ç”±<code>ä¼´éšå‹’è®©å¾·å¤šé¡¹å¼</code>ä»¥åŠ<code>å½’ä¸€åŒ–ç³»æ•°</code>ç»„æˆï¼š<br />The real spherical harmonics<br /><img src="/img/00016/image-5.png" alt="6" /><br />The complex spherical harmonics<br /><img src="/img/00016/image-6.png" alt="7" /><br />The real basis spherical harmonics<br /><img src="/img/00016/image-7.png" alt="8" /><br />å…¶ä¸­<spanclass="math inline">\(P_{l}^{m}(cos\theta)\)</span>ä¸º<code>ä¼´éšå‹’è®©å¾·å¤šé¡¹å¼</code>ï¼Œå®ƒæ˜¯<code>å‹’è®©å¾·åå¾®åˆ†æ–¹ç¨‹</code>çš„ä¸€ç»„è§£ï¼Œå…¶é—­å¼ä¸ºï¼š<br /><img src="/img/00016/image-8.png" alt="9" /><br />å…¶ä¸­åé¢ä¸¤ä¸ªæ‹¬å·æ‹¬èµ·æ¥çš„ä¸œè¥¿å«åš<ahref="%5BBinomial%20coefficient%5D(https://en.wikipedia.org/wiki/Binomial_coefficient#Generalization_and_connection_to_the_binomial_series)">äºŒé¡¹å¼ç³»æ•°</a>ï¼Œå…¶é˜¶ä¹˜å¼å¦‚ä¸‹ï¼š<br /><img src="/img/00016/image-9.png" alt="10" /><br />ä¸Šé¢å¼å­çš„æ¥æºæˆ–å®šä¹‰å•¥çš„ï¼Œæˆ‘ä»¬å°±ä¸åœ¨ç»†ç©¶äº†ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯è¦ææ‡‚<code>å®åŸŸSHåŸºå‡½æ•°</code>æ€ä¹ˆç®—ï¼</p><p>è¿™ä¸ªä¼´éšå‹’è®©å¾·å¤šé¡¹å¼çš„é—­å¼æœ‰ç‚¹å¤æ‚ï¼Œå¯ä»¥ç”¨æ¥è®¡ç®—ï¼Œä½†æ˜¯å¦‚æœç”¨è®¡ç®—æœºæ¥ç®—çš„è¯è¿™ä¸ªå¼å­ä¸æ˜¯å¾ˆå‹å¥½ï¼Œä½†æ˜¯åœ¨<code>l</code>å’Œ<code>m</code>ç›¸ç­‰æ—¶ï¼Œå®ƒå¯ä»¥å†™æˆå¦ä¸€ç§è¡¨è¾¾å¼ï¼Œä¸‹é¢å¼å­<ahref="https://mathworld.wolfram.com/AssociatedLegendrePolynomial.html">æ¥æºäºæ­¤</a>ï¼š<br /><span class="math display">\[\begin{align}P_{m}^{m}=(-1)^m(2m-1)!!(1-x^2)^{\frac{m}{2}} \tag{6}\end{align}\]</span> <span class="math display">\[\begin{align}P_{m+1}^{m}=x(2m+1)P_{m}^{m} \tag{7}\end{align}\]</span> æœ‰äº†è¿™ä¸¤ä¸ªé€’æ¨å…¬å¼ï¼Œé«˜å±‚<spanclass="math inline">\(P_{l}^{m}(x)\)</span>ï¼Œå°±å¯ä»¥é€šè¿‡ç¨‹åºæ¥é€’æ¨ç”Ÿæˆï¼Œå½“ç„¶æˆ‘è¿™é‡Œæ²¡æœ‰ç”¨ä»£ç æ¥å®ç°è¿™ä¸ªç®—æ³•ï¼Œç­‰åˆ°ä»€ä¹ˆæ—¶å€™è¦ç”¨çš„æ—¶å€™å†æ¥å®ç°ä¹Ÿä¸è¿ŸğŸ˜ã€‚</p><p>å¥½äº†è™½ç„¶æ²¡æœ‰ç”¨ä»£ç æ¥å®ç°è¿™éƒ¨åˆ†å†…å®¹ï¼Œä½†æ˜¯æˆ‘å¯ä»¥æ‰‹ç®—ä¸€ä¸ªä¾‹å­ï¼Œæ¥ç†ä¸€ä¸‹é€»è¾‘ï¼Œå°±ä»¥<code>Real spherical harmonics</code>çš„<spanclass="math inline">\(Y_{1,-1}\)</span>ä¸ºä¾‹ï¼Œä¾‹å­å¯ä»¥åœ¨<ahref="https://en.wikipedia.org/wiki/Table_of_spherical_harmonics">è¿™é‡Œ</a>æ‰¾åˆ°ï¼š<br /><img src="/img/00016/image-10.png" alt="11" />å°†l=1,m=-1å¸¦å…¥åˆ°ä¸Šé¢<code>The real spherical harmonics</code>å¾—ï¼š<br /><span class="math display">\[\begin{align}Y_{1,-1}=\frac{i}{\sqrt{2}}(Y_{1}^{-1}+Y_{1}^{1}) \tag{7}\end{align}\]</span> å…¶ä¸­<span class="math inline">\(Y_{1}^{-1}\)</span>å’Œ<spanclass="math inline">\(Y_{1}^{1}\)</span>æ˜¯å¤æ•°åŸŸçš„<code>SHå‡½æ•°</code>ï¼Œæ ¹æ®æ¬§æ‹‰å…¬å¼å’Œ<code>SH</code>åŸºå‡½æ•°å…¬å¼ä»¥åŠä¼´éšå‹’è®©å¾·å…¬å¼ï¼Œåˆ†åˆ«è®¡ç®—å®ƒä»¬ï¼š<br /><span class="math display">\[\begin{align}\text{e}^{\pm i\phi}=\cos\phi\pm i\sin\phi \tag{8}\end{align}\]</span> <span class="math display">\[\begin{align}&amp;Y_{1}^{-1}=\frac{1}{\sqrt{2}}(-\sqrt{\frac{3}{4\pi}})\cdot(-(1-\cos^2\theta)^{\frac{1}{2}})\cdot(\cos(\phi)-i\sin(\phi))\\&amp;Y_{1}^{-1}=\frac{1}{2}\sqrt{\frac{3}{2\pi}}\sin\theta\cdot\text{e}^{-i\phi}\tag{9}\end{align}\]</span> <span class="math display">\[\begin{align}&amp;Y_{1}^{1}=-\frac{1}{\sqrt{2}}(-\sqrt{\frac{3}{4\pi}})\cdot(-(1-\cos^2\theta)^{\frac{1}{2}})\cdot(\cos(\phi)+i\sin(\phi))\\&amp;Y_{1}^{1}=-\frac{1}{2}\sqrt{\frac{3}{2\pi}}\sin\theta\cdot\text{e}^{i\phi}\tag{10}\end{align}\]</span>å†æ ¹æ®çƒåæ ‡è½¬ç¬›å¡å°”åæ ‡å…¬å¼ï¼Œå¾—åˆ°å¤æ•°åŸŸç¬›å¡å°”åæ ‡ç³»ä¸‹çš„<code>SHå‡½æ•°</code>ï¼š<br /><img src="/img/00016/image-11.png" alt="12" /><br /><span class="math display">\[\begin{align}&amp;Y_{1}^{-1}=\frac{1}{2}\sqrt{\frac{3}{2\pi}}\sin\theta\cdot\text{e}^{-i\phi}\\&amp; Y_{1}^{-1}=\frac{1}{2}\sqrt{\frac{3}{2\pi}}\frac{x-iy}{r} \tag{11}\end{align}\]</span> <span class="math display">\[\begin{align}&amp;Y_{1}^{1}=-\frac{1}{2}\sqrt{\frac{3}{2\pi}}\sin\theta\cdot\text{e}^{i\phi}\\&amp; Y_{1}^{1}=-\frac{1}{2}\sqrt{\frac{3}{2\pi}}\frac{x+iy}{r} \tag{12}\end{align}\]</span>å°†ä¸Šé¢<code>11</code>å¼å’Œ<code>12</code>å¼å¸¦å…¥åˆ°<code>7</code>å¼ä¸­ï¼š<br /><span class="math display">\[\begin{align}&amp; Y_{1,-1}=\frac{i}{\sqrt{2}}(Y_{1}^{-1}+Y_{1}^{1}) \\&amp;Y_{1,-1}=\frac{i}{\sqrt{2}}(\frac{1}{2}\sqrt{\frac{3}{2\pi}}\frac{x-iy}{r}-\frac{1}{2}\sqrt{\frac{3}{2\pi}}\frac{x+iy}{r})\\&amp; Y_{1,-1}=\frac{1}{\sqrt{2}}\sqrt{\frac{3}{2\pi}}\frac{-i^2y}{r} \\&amp; Y_{1,-1}=\sqrt{\frac{3}{4\pi}}\frac{y}{r} \tag{13}\end{align}\]</span></p><p>è¿™æ ·å°±å¾—åˆ°äº†å›¾å½¢å­¦ä¸­ç»å¸¸ç”¨<code>SHå‡½æ•°</code>ã€‚æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªå¼å­ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">HardcodedSH1n1</span><span class="hljs-params">(<span class="hljs-type">const</span> Eigen::Vector3d&amp; d)</span> </span>&#123;<br>  <span class="hljs-comment">// -sqrt(3/(4pi)) * y</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">-0.488603</span> * d.<span class="hljs-built_in">y</span>();<br>&#125;<br></code></pre></td></tr></table></figure>è¿™é‡Œ<code>r</code>=1ï¼Œä½†æ˜¯æˆ‘ç›®å‰è¿˜ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦åŠ è´Ÿå·ğŸ˜‘ï¼Œå¯èƒ½æ˜¯<code>cubemap</code>æ–¹å‘å‘é‡çš„åæ ‡ç³»å’Œ<code>SHå‡½æ•°</code>çš„åæ ‡ç³»ä¸åŒå¯¼è‡´çš„ã€‚</p><h2 id="é¢„è®¡ç®—ç¯å¢ƒå…‰ç…§">é¢„è®¡ç®—ç¯å¢ƒå…‰ç…§</h2><p>è¿™éƒ¨åˆ†è¿˜æ˜¯æ ¹æ®ä¸Šé¢<code>2</code>å¼æŠ•å½±å…¬å¼æ¥ç®—ç¯å¢ƒå…‰ç…§çš„<code>SH</code>ç³»æ•°ï¼Œè¿™é‡Œå°†å®ƒè½¬æ¢ä¸ºé»æ›¼å’Œæ±‚å…¶ç§¯åˆ†:<br /><span class="math display">\[\begin{align}&amp; SH_{coeff}=\int_{S}L_{env}(w_i)SH(w_i)\text{d}w_i \\&amp; \widehat{SH_{coeff}}=\sum_iL_{env}(w_i)SH(w_i)\Delta w_i \tag{14}\end{align}\]</span> è¿™é‡Œç”¨é»æ›¼å’Œçš„æ–¹å¼æ±‚ç§¯åˆ†çš„å¥½å¤„æ˜¯ï¼Œ<ahref="https://www.rorydriscoll.com/2012/01/15/cubemap-texel-solid-angle/">æœ‰ä¸ªåŠæ³•</a>å¯ä»¥ç²¾ç¡®æ±‚å‡ºåƒç´ æŠ•å½±åˆ°å•ä½çƒä¸Šçš„é¢ç§¯ï¼Œå¦‚å›¾ï¼š<br /><img src="/img/00016/image-12.png" alt="13" /><br />æˆ‘è¿™é‡Œç®€å•æ¦‚è¿°ä¸€ä¸‹å®ƒè¿™ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆå¤„ç†çš„ã€‚é¦–å…ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡æ¡†æ¶ç»™çš„æ–¹æ³•æ±‚å‡ºæ¯ä¸ªåƒç´ å¯¹åº”çš„å‘é‡ï¼ˆæœªå½’ä¸€åŒ–ï¼‰ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//ç´¢å¼•åƒç´ å¯¹åº”çš„æ–¹å‘</span><br>Eigen::Vector3f dir = cubemapDirs[i * width * height + y * width + x];<br></code></pre></td></tr></table></figure> ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°è¯¥å‘é‡å½’ä¸€åŒ–åçš„è¡¨è¾¾å¼ï¼š<br /><span class="math display">\[\begin{align}\vec{p}=\frac{(x,y,1)}{\sqrt{x^2+y^2+1}} \tag{15}\end{align}\]</span> è¿™ä¸ªå‘é‡çš„<code>z</code>åˆ†é‡å¦‚ä¸‹ï¼š<br /><span class="math display">\[\begin{align}&amp; p_z=\frac{1}{\sqrt{x^2+y^2+1}} \\&amp; =(x^2+y^2+1)^{-\frac{1}{2}} \\&amp; =u^{-\frac{1}{2}}\tag{16}\end{align}\]</span>ç„¶åé€šè¿‡é“¾å¼æ³•åˆ™ï¼Œå¯¹å®ƒè¿›è¡Œæ±‚åå¯¼ï¼Œå¾—åˆ°è¯¥<code>z</code>åˆ†é‡æ²¿<code>x</code>è½´çš„å˜åŒ–ç‡ï¼š<br /><span class="math display">\[\begin{align}&amp;\frac{\partial{p_z}}{\partial{x}}=\frac{\partial{p_z}}{\partial{u}}\frac{\partial{u}}{\partial{x}}\\&amp; =-\frac{x}{(x^2+y^2+1)^{\frac{3}{2}}}\tag{17}\end{align}\]</span>æœ‰äº†<code>z</code>åˆ†é‡çš„åå¯¼ï¼Œ<code>x</code>åˆ†é‡å¯ä»¥è¡¨ç¤ºä¸ºï¼š<br /><span class="math display">\[\begin{align}&amp; p_x=\frac{x}{\sqrt{x^2+y^2+1}} \\&amp; =xp_z\end{align} \tag{18}\]</span> å¯¹å…¶æ±‚åå¯¼å¯ä»¥ç”¨ä¹˜ç§¯æ³•åˆ™å†™æˆä»¥ä¸‹å½¢å¼ï¼š<br /><span class="math display">\[\begin{align}&amp;\frac{\partial{p_x}}{\partial{x}}=p_z\frac{\partial{x}}{\partial{x}}+x\frac{\partial{p_z}}{\partial{x}}\\&amp; =\frac{y^2+1}{(x^2+y^2+1)^{\frac{3}{2}}}\end{align} \tag{19}\]</span> <code>y</code>åˆ†é‡ä¹Ÿå¯ä»¥ç”¨ç›¸åŒæ–¹å¼æ±‚åå¯¼ï¼š<br /><span class="math display">\[\begin{align}&amp; p_y=\frac{y}{\sqrt{x^2+y^2+1}}=yp_z \\&amp;\frac{\partial{p_y}}{\partial{x}}=p_z\frac{\partial{y}}{\partial{x}}+y\frac{\partial{p_z}}{\partial{x}}\\&amp; =-\frac{xy}{(x^2+y^2+1)^{\frac{3}{2}}}\end{align} \tag{19}\]</span> ä»¥ç›¸åŒæ–¹å¼å¯ä»¥æ±‚å¾—è¯¥å‘é‡æ²¿<code>y</code>è½´çš„å˜åŒ–ç‡ï¼š<br /><span class="math display">\[\begin{align}&amp;\frac{\partial{\vec{p}}}{\partial{x}}=\frac{(y^2+1,-xy,-x)}{(x^2+y^2+1)^{\frac{3}{2}}}\\&amp;\frac{\partial{\vec{p}}}{\partial{y}}=\frac{(-xy,x^2+1,-y)}{(x^2+y^2+1)^{\frac{3}{2}}}\end{align} \tag{20}\]</span>ç„¶åç®—<code>x</code>è½´çš„å˜åŒ–ç‡å‰ä¹˜<code>y</code>è½´å˜åŒ–ç‡ï¼Œå¾—åˆ°å‰ä¹˜åçš„å‘é‡ï¼Œå†æ±‚å®ƒçš„æ¨¡å°±æ˜¯åŸç‚¹å’Œå˜åŒ–ç‚¹é—´çš„å¾®åˆ†é¢ç§¯ï¼š<br /><span class="math display">\[\begin{align}&amp;\vec{r}=\frac{\partial{\vec{p}}}{\partial{x}}\times\frac{\partial{\vec{p}}}{\partial{y}}\\&amp; =\frac{(x,y,1)}{(x^2+y^2+1)^2}\end{align} \tag{21}\]</span> <span class="math display">\[\begin{align}&amp; \partial{A}=\sqrt{\vec{r}\cdot\vec{r}} \\&amp; =\frac{1}{(x^2+y^2+1)^{\frac{3}{2}}}\end{align} \tag{22}\]</span>æœ€åä¸€æ­¥æ˜¯åœ¨åƒç´ ç©ºé—´å†…å¯¹å¾®åˆ†é¢ç§¯è¿›è¡Œç§¯åˆ†ï¼Œä»¥è·å¾—åƒç´ æŠ•å½±åˆ°å•ä½çƒä¸Šçš„ç«‹ä½“è§’ã€‚æˆ‘ä»¬å¯ä»¥è®¡ç®—åŸç‚¹<code>(0,0)</code>åˆ°<code>cubemap</code>ä¸Šçš„æŸä¸ªç‚¹<code>(s,t)</code>çš„ç§¯åˆ†å€¼ï¼š<br /><span class="math display">\[\begin{align}&amp;f(s,t)=\int_{y=0}^{t}\int_{x=0}^{s}\frac{1}{(x^2+y^2+1)^{\frac{3}{2}}}\text{d}x\text{d}y\\&amp; =\tan^{-1}\frac{st}{\sqrt{s^2+t^2+1}}\end{align} \tag{23}\]</span>æœ‰äº†è¿™ä¸ªå…¬å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†ä¸¤ä¸ªå³å¯¹è§’<code>A</code>å’Œ<code>C</code>çš„é¢ç§¯åŠ åœ¨ä¸€èµ·ï¼Œå‡å»å·¦å¯¹è§’<code>B</code>å’Œ<code>D</code>çš„é¢ç§¯æ¥è®¡ç®—ä»»ä½•åƒç´ æŠ•å½±åˆ°å•ä½çƒçš„ç«‹ä½“è§’ï¼š<br /><img src="/img/00016/image-13.png" alt="14" /><br />å¯¹åº”çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">CalcPreArea</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">float</span> &amp;x, <span class="hljs-type">const</span> <span class="hljs-type">float</span> &amp;y)</span></span>&#123;<br>    <span class="hljs-comment">//atan2çš„ä¼˜åŠ¿æ˜¯å¯ä»¥æ­£ç¡®å¤„ç†å¼‚å¸¸çš„æƒ…å†µ</span><br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">atan2</span>(x * y, std::<span class="hljs-built_in">sqrt</span>(x * x + y * y + <span class="hljs-number">1.0</span>));<br>&#125;<br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">CalcArea</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">float</span> &amp;u_, <span class="hljs-type">const</span> <span class="hljs-type">float</span> &amp;v_, <span class="hljs-type">const</span> <span class="hljs-type">int</span> &amp;width,</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-type">const</span> <span class="hljs-type">int</span> &amp;height)</span></span>&#123;<br>    <span class="hljs-comment">// transform from [0,1] to [-1,1]</span><br>    <span class="hljs-comment">// ( 0.5 is for texel center addressing)</span><br>    <span class="hljs-type">float</span> u = (<span class="hljs-number">2.0</span> * (u_ + <span class="hljs-number">0.5</span>) / width) - <span class="hljs-number">1.0</span>;<br>    <span class="hljs-type">float</span> v = (<span class="hljs-number">2.0</span> * (v_ + <span class="hljs-number">0.5</span>) / height) - <span class="hljs-number">1.0</span>;<br><br>    <span class="hljs-type">float</span> invResolutionW = <span class="hljs-number">1.0</span> / width;<br>    <span class="hljs-type">float</span> invResolutionH = <span class="hljs-number">1.0</span> / height;<br><br>    <span class="hljs-comment">// u and v are the [-1,1] texture coordinate on the current face.</span><br>    <span class="hljs-comment">// get projected area for this texel</span><br>    <span class="hljs-type">float</span> x0 = u - invResolutionW;<br>    <span class="hljs-type">float</span> y0 = v - invResolutionH;<br>    <span class="hljs-type">float</span> x1 = u + invResolutionW;<br>    <span class="hljs-type">float</span> y1 = v + invResolutionH;<br>    <span class="hljs-type">float</span> angle = <span class="hljs-built_in">CalcPreArea</span>(x0, y0) - <span class="hljs-built_in">CalcPreArea</span>(x0, y1) -<br>                    <span class="hljs-built_in">CalcPreArea</span>(x1, y0) + <span class="hljs-built_in">CalcPreArea</span>(x1, y1);<br><br>    <span class="hljs-keyword">return</span> angle;<br>&#125;<br></code></pre></td></tr></table></figure> å›åˆ°ä¸Šé¢<code>14</code>å¼ï¼š<br /><span class="math display">\[\begin{align}&amp; \widehat{SH_{coeff}}=\sum_iL_{env}(w_i)SH(w_i)\Delta w_i\end{align}\]</span>æœ‰äº†ç«‹ä½“è§’çš„é¢ç§¯ï¼Œæ¡†æ¶ä¹Ÿæä¾›äº†ç¯å¢ƒå…‰çš„<code>RGB</code>å€¼ä»¥åŠç¡¬ç¼–ç çš„<code>SH</code>å‡½æ•°ï¼Œå®ç°å°±æ˜¯ä¸‹é¢çš„ä»£ç ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++)&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++)&#123;<br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> here you need to compute light sh of each pixel of each face of cubemap </span><br><br>        <span class="hljs-comment">//ç´¢å¼•åƒç´ å¯¹åº”çš„æ–¹å‘</span><br>        Eigen::Vector3f dir = cubemapDirs[i * width * height + y * width + x];<br>        <span class="hljs-comment">//åƒç´ çš„ç´¢å¼•</span><br>        <span class="hljs-type">int</span> index = (y * width + x) * channel;<br>        <span class="hljs-comment">//RGBå€¼</span><br>        <span class="hljs-function">Eigen::Array3f <span class="hljs-title">Le</span><span class="hljs-params">(images[i][index + <span class="hljs-number">0</span>], images[i][index + <span class="hljs-number">1</span>],</span></span><br><span class="hljs-params"><span class="hljs-function">                            images[i][index + <span class="hljs-number">2</span>])</span></span>;<br><br>        <span class="hljs-comment">// Edit Start</span><br>        <span class="hljs-keyword">auto</span> delta_w = <span class="hljs-built_in">CalcArea</span>(x, y, width, height);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> l = <span class="hljs-number">0</span>; l &lt;= SHOrder; l++) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> m = -l; m &lt;= l; m++) &#123;<br>                <span class="hljs-comment">//è·å–åŸºå‡½æ•°</span><br>                <span class="hljs-keyword">auto</span> basic_sh_proj = sh::<span class="hljs-built_in">EvalSH</span>(l, m, Eigen::<span class="hljs-built_in">Vector3d</span>(dir.<span class="hljs-built_in">x</span>(), dir.<span class="hljs-built_in">y</span>(), dir.<span class="hljs-built_in">z</span>()).<span class="hljs-built_in">normalized</span>());<br>                <span class="hljs-comment">//è®¡ç®—leåœ¨åŸºå‡½æ•°ä¸Šçš„æŠ•å½±ï¼Œå¹¶ä¸”ç”¨é»æ›¼å’Œè¿‘ä¼¼ç§¯åˆ†</span><br>                SHCoeffiecents[sh::<span class="hljs-built_in">GetIndex</span>(l, m)] += Le * basic_sh_proj * delta_w;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// Edit End</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure> æœ€åç”Ÿæˆçš„<code>SHCoeffiecents</code>å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp">    R               G               B<br><span class="hljs-number">1.91613</span>         <span class="hljs-number">1.71772</span>         <span class="hljs-number">1.07797</span><br><span class="hljs-number">-0.0591127</span>      <span class="hljs-number">-0.0574315</span>      <span class="hljs-number">-0.0346851</span><br><span class="hljs-number">-3.8612e-05</span>     <span class="hljs-number">-2.09015e-05</span>    <span class="hljs-number">-1.35017e-05</span><br><span class="hljs-number">0.439589</span>        <span class="hljs-number">-0.431271</span>       <span class="hljs-number">-0.0800766</span><br><span class="hljs-number">-0.0306302</span>      <span class="hljs-number">0.0319348</span>       <span class="hljs-number">0.00328068</span><br><span class="hljs-number">0.0758103</span>       <span class="hljs-number">0.0710374</span>       <span class="hljs-number">0.0591078</span><br><span class="hljs-number">0.311676</span>        <span class="hljs-number">0.269456</span>        <span class="hljs-number">0.309399</span><br><span class="hljs-number">-4.15644e-05</span>    <span class="hljs-number">6.26793e-05</span>     <span class="hljs-number">3.12488e-05</span><br><span class="hljs-number">-0.541544</span>       <span class="hljs-number">-0.468526</span>       <span class="hljs-number">-0.536088</span><br></code></pre></td></tr></table></figure></p><h2 id="é¢„è®¡ç®—å…‰ä¼ è¾“">é¢„è®¡ç®—å…‰ä¼ è¾“</h2><p>åœ¨ä¸Šä¸€èŠ‚æˆ‘ä»¬å·²ç»å°†ç¯å¢ƒå…‰ç…§æŠ•å½±åˆ°SHå‡½æ•°ä¸Šï¼Œå¾—åˆ°äº†å¯¹åº”çš„<code>SHCoeffiecents</code>ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†å¯¹äºæœ‰è‡ªé˜´å½±çš„<code>Shadowed</code>æ¼«åå°„ä¼ è¾“ï¼Œé¢„è®¡ç®—æ–¹ç¨‹å¤šäº†ä¸€é¡¹å¯è§æ€§(Visibilityterm)ï¼š<br /><span class="math display">\[\begin{align}L_{DS}=\frac{c}{\pi}\int_{S}V(w_i)max(N_x\cdot w_i,0)\text{d}w_i\end{align} \tag{24}\]</span>å¯¹äºè¿™ä¸ªå¼å­ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨è’™ç‰¹å¡æ´›æ¥æ±‚ç§¯åˆ†ï¼Œè¿™é‡Œ<code>S</code>è¡¨ç¤ºæ•´ä¸ªçƒï¼Œå…¶å®æˆ‘è§‰å¾—ç”¨åŠçƒçš„<code>Cos weight</code>æ›´å¥½ï¼Œä½†æ˜¯å½“æ—¶æ˜¯ç›´æ¥å®ç°çš„æ•´çƒé‡‡æ ·ï¼Œåé¢å°±ä¸€ç›´æ²¡æ”¹äº†ã€‚æ‰€ä»¥ç°åœ¨è¿˜æ˜¯ä»¥æ•´çƒä¸ºä¾‹æ¥è®²è§£é‡‡æ ·è¿‡ç¨‹ï¼Œ<code>Cos weight</code>ç±»ä¼¼å…¶è¿‡ç¨‹ï¼š<br />å•ä½çƒä¸Šçš„ä¸€ä¸ªé‡‡æ ·ç‚¹è½åœ¨<code>dw_i</code>çš„æ¦‚ç‡å¯†åº¦å‡½æ•°è®¾ä¸º<spanclass="math inline">\(P(w_i)\)</span>ï¼š<br />å¯¹äºè¿™ä¸ª<code>PDF</code>ï¼Œåœ¨æ•´çƒèŒƒå›´å†…ç§¯åˆ†ä¸º<code>1</code>ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç­‰å¼ï¼š<br /><span class="math display">\[\begin{align}\int_{\phi}\int_{\theta}P(w_i)\text{d}w_i=1\end{align} \tag{25}\]</span>ç”±äº<code>dw</code>åœ¨æ•´çƒèŒƒå›´å†…ç§¯åˆ†çš„ç»“æœæ˜¯<code>4Ï€R^2</code>ï¼Œå•ä½æ•´çƒåˆ™æ˜¯<code>4Ï€</code>ï¼Œ<code>PDF</code>çš„å€¼ä¸º<code>1/4Ï€</code>ï¼Œåˆ™ä¸Šè¿°å¼å­å¯ä»¥å†™æˆï¼š<br /><span class="math display">\[\begin{align}\int_{\phi}\int_{\theta}\frac{1}{4\pi}\sin\theta\text{d}\theta\text{d}\phi=1\end{align} \tag{26}\]</span> åˆ†åˆ«è®¡ç®—å®ƒä»¬çš„è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼š<br /><span class="math display">\[\begin{align}&amp;P(\theta)=\int_{0}^{2\pi}\frac{1}{4\pi}\sin\theta\text{d}\phi=\frac{\sin\theta}{2}\\&amp; P(\phi)=\int_{0}^{\pi}\frac{1}{4\pi}\sin\theta\text{d}\theta \\&amp; =-\frac{1}{4\pi}\cos\theta|_{0}^{\pi} \\&amp; =\frac{1}{2\pi}\end{align} \tag{26}\]</span> åˆ†åˆ«è®¡ç®—å®ƒä»¬çš„ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼š<br /><span class="math display">\[\begin{align}&amp; F(\theta)=\int_{0}^{\theta}\frac{\sin\theta}{2}\text{d}\theta \\&amp; =-\frac{\cos\theta}{2}|_{0}^{\theta} \\&amp; =\frac{1-\cos\theta}{2} \\&amp;F(\phi)=\int_{0}^{\phi}\frac{1}{2\pi}\text{d}\phi=\frac{\phi}{2\pi}\end{align} \tag{27}\]</span> å‡åŒ€çš„ä»<code>U[0,1]</code>ä¸­å–å‡ºä¸¤ä¸ªéšæœºæ•°<spanclass="math inline">\(X_{1}\)</span>å’Œ<spanclass="math inline">\(X_{2}\)</span>,åˆ™æˆ‘ä»¬è¦çš„é‡‡æ ·<code>Î¸</code>å’Œ<code>Ï†</code>ä¸ºï¼š<span class="math display">\[\begin{align}&amp; F^{-1}(\theta)=\theta=\arccos(1-2X_1) \\&amp; F^{-1}(\phi)=\phi=2\pi X_2\end{align} \tag{27}\]</span> è¿™ç§æ–¹å¼å¾—åˆ°çš„é‡‡æ ·ç‚¹å¦‚ä¸‹ï¼š<br /><img src="/img/00016/image-14.png" alt="15" /><br />æœ‰äº†é‡‡æ ·æ–¹å‘ï¼Œå°±å¯ä»¥ç®—ç§¯åˆ†å€¼äº†ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> t = <span class="hljs-number">0</span>; t &lt; sample_side; t++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> p = <span class="hljs-number">0</span>; p &lt; sample_side; p++) &#123;<br>        <span class="hljs-comment">//åˆ†å±‚é‡‡æ ·ï¼Œä½¿é‡‡æ ·ç‚¹æ›´åŠ å‡åŒ€ã€‚</span><br>        <span class="hljs-type">double</span> x1 = (t + nori::<span class="hljs-built_in">genRandomFloat</span>()) / sample_side;<br>        <span class="hljs-type">double</span> x2 = (p + nori::<span class="hljs-built_in">genRandomFloat</span>()) / sample_side;<br><br>        <span class="hljs-type">double</span> phi = <span class="hljs-number">2.0</span> * M_PI * x1;<br>        <span class="hljs-type">double</span> theta = <span class="hljs-built_in">acos</span>(<span class="hljs-number">2.0</span> * x2 - <span class="hljs-number">1.0</span>);<br><br>        <span class="hljs-type">double</span> func_value = <span class="hljs-built_in">func</span>(phi, theta);<br><br>        <span class="hljs-comment">// evaluate the SH basis functions up to band O, scale them by the</span><br>        <span class="hljs-comment">// function&#x27;s value and accumulate them over all generated samples</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> l = <span class="hljs-number">0</span>; l &lt;= order; l++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> m = -l; m &lt;= l; m++) &#123;<br>            <span class="hljs-type">double</span> sh = <span class="hljs-built_in">EvalSH</span>(l, m, phi, theta);<br>            <span class="hljs-comment">//è’™ç‰¹å¡æ´›ç§¯åˆ†</span><br>            <span class="hljs-type">double</span> pdf = <span class="hljs-number">1.0</span> / (<span class="hljs-number">4</span> * M_PI);<br>            (*coeffs)[<span class="hljs-built_in">GetIndex</span>(l, m)] += <span class="hljs-number">1</span> / M_PI * func_value * sh / pdf / sample_count;<br>        &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><code>func_value</code>å°±æ˜¯æ¸²æŸ“æ–¹ç¨‹ä¸­<code>Cos</code>å€¼ï¼Œå¦‚æœé¡¶ç‚¹å‘å¤–å‘å°„å…‰çº¿æ—¶æ²¡æœ‰è¢«æŒ¡ä½åˆ™<code>func_value == dot(N,w)</code>ï¼ŒæŒ¡ä½äº†å°±æ˜¯<code>0</code>ã€‚è‡³äºè¿™é‡Œ<code>Î¸</code>ä¸ºä»€ä¹ˆå’Œä¸Šé¢çš„å…¬å¼ä¸ä¸€æ ·ï¼Œæˆ‘å½“æ—¶æ˜¯ç›´æ¥ç”¨çš„<ahref="https://www.bogotobogo.com/Algorithms/uniform_distribution_sphere.php">è¿™ç¯‡æ–‡ç« </a>ç®—å‡ºæ¥çš„ç»“æœï¼Œç°åœ¨è¿‡æ¥å†™åšå®¢æ—¶å‘ç°ä»–ç®—é”™äº†ï¼Œä¸è¿‡ä¸å½±å“æœ€åçš„ç»“æœï¼Œå°±æ˜¯Î¸å€¼äº’è¡¥ã€‚</p><h2 id="é¢„è®¡ç®—é—´æ¥å…‰ä¼ è¾“">é¢„è®¡ç®—é—´æ¥å…‰ä¼ è¾“</h2><p>æœ‰äº†ç›´æ¥å…‰çš„å…‰ä¼ è¾“ï¼Œé—´æ¥å…‰çš„å…‰ä¼ è¾“å°±å¥½åŠäº†ï¼Œä½†æ˜¯ç›´æ¥çœ‹ä½œä¸šæ–‡æ¡£ç»™çš„å…¬å¼å®¹æ˜“è¢«è¯¯å¯¼ï¼Œä¸è¿‡å¥½åœ¨å®ƒä¸‹é¢ç»™å‡ºäº†è§£é‡Šï¼Œæˆ‘è¿™é‡Œå°±ä¸åˆ—å…¬å¼äº†ï¼Œçœ‹ä¸‹å®ƒçš„è§£é‡Šï¼š<br />1. å¯¹äºæ¯ä¸ªé¡¶ç‚¹ï¼Œè®¡ç®—å®ƒçš„<spanclass="math inline">\(L_{DS}\)</span>ï¼Œåœ¨ä¸Šä¸€èŠ‚å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å·²ç»åšäº†è¿™ä¸ªäº‹æƒ…ï¼Œå¯ä»¥æ‹¿æ¥å¤ç”¨ã€‚2.ä»å½“å‰é¡¶ç‚¹å‘å°„å…‰çº¿ï¼Œå¦‚æœå½“å‰å…‰çº¿ä¸å…¶ä»–ä¸‰è§’å½¢ç›¸äº¤ï¼Œåˆ™åœ¨äº¤ç‚¹å¤„æ±‚å‡ºé‡å¿ƒåæ ‡æ’å€¼åçš„çƒé¢è°æ³¢ç³»æ•°ï¼Œè¿™ä¸ªç³»æ•°å°±è¡¨ç¤ºé—´æ¥å…‰ç…§çš„çƒé¢è°æ³¢ç³»æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®ä¸ç”¨ç®—ç§¯åˆ†å€¼ã€‚3. å¯¹äºè¿™ä¸ªåå°„å›æ¥çš„é—´æ¥å…‰ï¼Œä¹˜ä»¥å‡ ä½•é¡¹<code>dot(N,w_i)</code>ã€‚ 4.ä»¥å½“å‰å°„çº¿ä¸ºäº¤ç‚¹ï¼Œä»ç¬¬<code>2</code>æ­¥è®¡ç®—ä»¥å½“å‰äº¤ç‚¹ä¸ºåˆè¯•é¡¶ç‚¹çš„<spanclass="math inline">\(L_{DS}\)</span>ï¼Œé‡å¤è¿™ä¸ªæ­¥éª¤ç›´åˆ°<code>Bounce</code>æ¬¡æ•°åˆ°è¾¾é¢„è®¾å€¼ï¼Œç„¶åç»“æŸé€’å½’ã€‚å®ç°å¦‚ä¸‹ï¼š<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;<br>std::unique_ptr&lt;std::vector&lt;<span class="hljs-type">double</span>&gt;&gt; <span class="hljs-built_in">computeInterreflectionSH</span>(Eigen::MatrixXf* directTSHCoeffs, <br>                                                            <span class="hljs-type">const</span> Point3f&amp; pos, <span class="hljs-type">const</span> Normal3f&amp; normal, T&amp;&amp; Lds,<br>                                                            <span class="hljs-type">const</span> Scene* scene, <span class="hljs-type">int</span> bounces)<br>&#123;<br>    std::unique_ptr&lt;std::vector&lt;<span class="hljs-type">double</span>&gt;&gt; <span class="hljs-built_in">coeffs</span>(<span class="hljs-keyword">new</span> std::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">double</span>&gt;());<br>    coeffs-&gt;<span class="hljs-built_in">assign</span>(SHCoeffLength, <span class="hljs-number">0.0</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; coeffs-&gt;<span class="hljs-built_in">size</span>(); i++)&#123;<br>        (*coeffs)[i] += Lds[i];<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (bounces &gt;= m_Bounce)<br>        <span class="hljs-keyword">return</span> coeffs;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> sample_side = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&gt;(<span class="hljs-built_in">floor</span>(<span class="hljs-built_in">sqrt</span>(m_SampleCount)));<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> t = <span class="hljs-number">0</span>; t &lt; sample_side; t++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> p = <span class="hljs-number">0</span>; p &lt; sample_side; p++) &#123;<br>            <span class="hljs-type">double</span> x1 = (t + nori::<span class="hljs-built_in">genRandomFloat</span>()) / sample_side;<br>            <span class="hljs-type">double</span> x2 = (p + nori::<span class="hljs-built_in">genRandomFloat</span>()) / sample_side;<br>            <span class="hljs-type">double</span> phi = <span class="hljs-number">2.0</span> * M_PI * x1;<br>            <span class="hljs-type">double</span> theta = <span class="hljs-built_in">acos</span>(<span class="hljs-number">2.0</span> * x2 - <span class="hljs-number">1.0</span>);<br><br>            Eigen::Array3d d = sh::<span class="hljs-built_in">ToVector</span>(phi, theta);<br>            <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> wi = <span class="hljs-built_in">Vector3f</span>(d.<span class="hljs-built_in">x</span>(), d.<span class="hljs-built_in">y</span>(), d.<span class="hljs-built_in">z</span>());<br>            <span class="hljs-type">double</span> pdf = <span class="hljs-number">1.0</span> / (<span class="hljs-number">4</span> * M_PI);<br>            <span class="hljs-type">double</span> H = wi.<span class="hljs-built_in">normalized</span>().<span class="hljs-built_in">dot</span>(normal);<br>            Intersection its;<br>            <span class="hljs-keyword">if</span> (H &gt; <span class="hljs-number">0.0</span> &amp;&amp; scene-&gt;<span class="hljs-built_in">rayIntersect</span>(<span class="hljs-built_in">Ray3f</span>(pos, wi.<span class="hljs-built_in">normalized</span>()), its))&#123;<br>                MatrixXf normals = its.mesh-&gt;<span class="hljs-built_in">getVertexNormals</span>();<br>                Point3f idx = its.tri_index;<br>                Point3f hitPos = its.p;<br>                Vector3f bary = its.bary;<br>                <span class="hljs-comment">//åˆ©ç”¨é‡å¿ƒåæ ‡æ’å€¼ä¸‰è§’å½¢å„é¡¶ç‚¹çš„æ³•å‘é‡</span><br>                Normal3f hitNormal =<br>                    <span class="hljs-built_in">Normal3f</span>(normals.<span class="hljs-built_in">col</span>(idx.<span class="hljs-built_in">x</span>()).<span class="hljs-built_in">normalized</span>() * bary.<span class="hljs-built_in">x</span>() +<br>                        normals.<span class="hljs-built_in">col</span>(idx.<span class="hljs-built_in">y</span>()).<span class="hljs-built_in">normalized</span>() * bary.<span class="hljs-built_in">y</span>() +<br>                        normals.<span class="hljs-built_in">col</span>(idx.<span class="hljs-built_in">z</span>()).<span class="hljs-built_in">normalized</span>() * bary.<span class="hljs-built_in">z</span>())<br>                    .<span class="hljs-built_in">normalized</span>();<br>                <span class="hljs-comment">//é‡å¿ƒåæ ‡æ’å€¼ä¸‰è§’å½¢å„é¡¶ç‚¹çš„(V * brdf * wiDotN)æŠ•å½±åˆ°çƒè°åŸºå‡½æ•°åå¾—åˆ°çš„coeffså€¼</span><br>                <span class="hljs-keyword">auto</span> interpolateSH = <br>                        directTSHCoeffs-&gt;<span class="hljs-built_in">col</span>(idx.<span class="hljs-built_in">x</span>()) * bary.<span class="hljs-built_in">x</span>() +<br>                        directTSHCoeffs-&gt;<span class="hljs-built_in">col</span>(idx.<span class="hljs-built_in">y</span>()) * bary.<span class="hljs-built_in">y</span>() +<br>                        directTSHCoeffs-&gt;<span class="hljs-built_in">col</span>(idx.<span class="hljs-built_in">z</span>()) * bary.<span class="hljs-built_in">z</span>();<br>                <span class="hljs-keyword">auto</span> nextBouncesCoeffs = <span class="hljs-built_in">computeInterreflectionSH</span>(directTSHCoeffs, hitPos, hitNormal, interpolateSH ,scene, bounces + <span class="hljs-number">1</span>);<br><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; SHCoeffLength; i++)&#123;<br>                    <span class="hljs-comment">//é‡‡æ ·åˆ°æŠ•å½±åçš„coeffesä¹˜ä»¥cosåšæƒé‡ï¼Œè¿™é‡Œä¸æ˜¯è’™ç‰¹å¡æ´›ç§¯åˆ†ã€‚</span><br>                    (*coeffs)[i] +=  (*nextBouncesCoeffs)[i] * H / m_SampleCount;<br>                    <span class="hljs-comment">// (*coeffs)[i] += 1 / M_PI * (*nextBouncesCoeffs)[i] * H / pdf / m_SampleCount;//Incorrect method</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> coeffs;<br>&#125;<br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> leave for bonus</span><br>m_InterTransportSHCoeffs.<span class="hljs-built_in">resize</span>(SHCoeffLength, mesh-&gt;<span class="hljs-built_in">getVertexCount</span>());<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; mesh-&gt;<span class="hljs-built_in">getVertexCount</span>(); i++)&#123;<br>    <span class="hljs-type">const</span> Point3f&amp; v = mesh-&gt;<span class="hljs-built_in">getVertexPositions</span>().<span class="hljs-built_in">col</span>(i);<br>    <span class="hljs-type">const</span> Normal3f&amp; n = mesh-&gt;<span class="hljs-built_in">getVertexNormals</span>().<span class="hljs-built_in">col</span>(i).<span class="hljs-built_in">normalized</span>();<br>    <span class="hljs-keyword">auto</span> indirectCoeffs = <span class="hljs-built_in">computeInterreflectionSH</span>(&amp;m_TransportSHCoeffs, v, n,m_TransportSHCoeffs.<span class="hljs-built_in">col</span>(i), scene, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; SHCoeffLength; j++)&#123;<br>        m_InterTransportSHCoeffs.<span class="hljs-built_in">col</span>(i).<span class="hljs-built_in">coeffRef</span>(j) = (*indirectCoeffs)[j];<br>    &#125;<br>&#125;<br>m_TransportSHCoeffs = m_InterTransportSHCoeffs;<br></code></pre></td></tr></table></figure> æ•ˆæœå¦‚ä¸‹ï¼š<br /><img src="/img/00016/PRT.gif" alt="16" /><br />è¯»è€…æœ‰æ—¶é—´å¯ä»¥ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªç®—æ³•ï¼Œå§å¯¹æ•´çƒçš„é‡‡æ ·æ”¹æˆ<code>cos weight</code>åŠçƒé‡‡æ ·ï¼Œé€Ÿåº¦æ›´å¿«æ•ˆæœæ›´å¥½ã€‚</p><h2 id="ä½¿ç”¨é¢„è®¡ç®—çš„æ•°æ®è¿›è¡Œshading">ä½¿ç”¨é¢„è®¡ç®—çš„æ•°æ®è¿›è¡ŒShading</h2><p>æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¸Šé¢5å¼çš„ç»“æœï¼š<br /><span class="math display">\[\begin{align}&amp; L_o(p,w_o)=\sum_il_it_i\end{align}\]</span>åœ¨<code>webgl</code>ä¸­è¦åšçš„äº‹æƒ…å°±æ˜¯å°†é¢„è®¡ç®—çš„<code>SHCoeffiecents</code>å‘é‡ï¼Œä¼ å…¥åˆ°é¡¶ç‚¹ç€è‰²å™¨é‡Œï¼Œç„¶åé€ç‚¹ç›¸ä¹˜å†æ±‚å’Œï¼Œå°±æ˜¯æˆ‘ä»¬è¦çš„é¢œè‰²å€¼ã€‚æœ€ååšä¸€ä¸‹<code>Gamma Correction</code>å’Œ<code>Tone Mapping</code>å°†çº¿æ€§ç©ºé—´çš„é¢œè‰²è½¬æ¢åˆ°sRGBç©ºé—´ã€‚<br /><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp">attribute vec3 aVertexPosition;<br>attribute vec3 aNormalPosition;<br><span class="hljs-comment">//å…‰ä¼ è¾“æŠ•å½±åˆ°å‰ä¸‰å±‚SHå‡½æ•°å¾—åˆ°çš„ç³»æ•°ï¼Œä¸€ä¸ªé¡¶ç‚¹åŒ…å«9ä¸ªç³»æ•°ï¼Œç”¨mat3æ¥å­˜å‚¨ã€‚</span><br>attribute mat3 aPrecomputeLT;<br><span class="hljs-comment">//å…‰ç…§æŠ•å½±åˆ°å‰ä¸‰å±‚SHå‡½æ•°å¾—åˆ°çš„ç³»æ•°ï¼Œä¸€ä¸ªé¡¶ç‚¹åŒ…å«27ä¸ªç³»æ•°ï¼ŒRå¯¹åº”9ä¸ªï¼ŒGå¯¹åº”9ä¸ªï¼ŒBå¯¹åº”9ä¸ªï¼Œç”¨ä¸‰ä¸ªmat3æ¥å­˜å‚¨</span><br>uniform mat3 uPrecomputeL[<span class="hljs-number">3</span>];<br>varying highp vec3 vColor;<br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">L_dot_LT</span><span class="hljs-params">(mat3 PrecomputeL, mat3 PrecomputeLT)</span> </span>&#123;<br>  vec3 L_0 = PrecomputeL[<span class="hljs-number">0</span>];<br>  vec3 L_1 = PrecomputeL[<span class="hljs-number">1</span>];<br>  vec3 L_2 = PrecomputeL[<span class="hljs-number">2</span>];<br>  vec3 LT_0 = PrecomputeLT[<span class="hljs-number">0</span>];<br>  vec3 LT_1 = PrecomputeLT[<span class="hljs-number">1</span>];<br>  vec3 LT_2 = PrecomputeLT[<span class="hljs-number">2</span>];<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">dot</span>(L_0, LT_0) + <span class="hljs-built_in">dot</span>(L_1, LT_1) + <span class="hljs-built_in">dot</span>(L_2, LT_2);<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)&#123;<br>    <span class="hljs-comment">//RGBå¯¹åº”çš„SHç³»æ•°åˆ†åˆ«åšç‚¹ä¹˜ï¼Œå¾—åˆ°æœ€åRGBå€¼ã€‚</span><br>    vColor[i] = <span class="hljs-built_in">L_dot_LT</span>(uPrecomputeL[i],aPrecomputeLT);<br>  &#125;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>è¿™ä¸ª<code>Gamma Correction</code>å’Œ<code>Tone Mapping</code>åœ¨<code>Nori</code>æ¡†æ¶ä¸­æœ‰ä¸ªAPIå·²ç»å®ç°ï¼Œæˆ‘ä»¬ç”¨å®ƒé‚£ä¸ªå°±è¡Œï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Color3f <span class="hljs-title">Color3f::toSRGB</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>&#123;<br>    Color3f result;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">3</span>; ++i) &#123;<br>        <span class="hljs-type">float</span> value = <span class="hljs-built_in">coeff</span>(i);<br>        <span class="hljs-keyword">if</span> (value &lt;= <span class="hljs-number">0.0031308f</span>)<br>            result[i] = <span class="hljs-number">12.92f</span> * value;<br>        <span class="hljs-keyword">else</span><br>            result[i] = (<span class="hljs-number">1.0f</span> + <span class="hljs-number">0.055f</span>)<br>                * std::<span class="hljs-built_in">pow</span>(value, <span class="hljs-number">1.0f</span>/<span class="hljs-number">2.4f</span>) -  <span class="hljs-number">0.055f</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure></p>]]></content>
    
    
    <categories>
      
      <category>Games202</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†</title>
    <link href="/2022/02/19/00006.%20c++%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B%E4%B9%8B%E8%99%9A%E8%A1%A8%EF%BC%8C%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88%E7%AD%89/"/>
    <url>/2022/02/19/00006.%20c++%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B%E4%B9%8B%E8%99%9A%E8%A1%A8%EF%BC%8C%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88%E7%AD%89/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><blockquote><p><strong>æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚</strong><br />ä¸Šä¸¤ç¯‡æ–‡ç« å°†c++çš„æ ¸å¿ƒéƒ¨ä»¶ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/value_category">Valuecategories</a>ï¼‰è®²æ¸…æ¥šäº†ï¼Œè¿™ç¯‡æ–‡ç« å°†ä¼šå¸¦å¤§å®¶åˆ†æc++å¯¹è±¡æ¨¡å‹çš„åº•å±‚åŸç†ã€‚ç¬”è€…è¿™é‡Œç”¨çš„ç¼–è¯‘å™¨æ˜¯<code>clang version 10.0.0-4ubuntu1</code>ï¼Œä¸åŒç¼–è¯‘å™¨å¯¹æ•°æ®å¸ƒå±€çš„å¤„ç†å¯èƒ½ä¼šä¸åŒï¼ˆã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹ä¸­å·²é˜è¿°åŸå› ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ï¼‰ã€‚å‹æƒ…æç¤ºï¼šæœ¬æ–‡ç« æ¶‰åŠ<code>ATTå¼</code>å’Œ<code>intelå¼</code>æ±‡ç¼–ä»£ç çš„ç›¸å…³çŸ¥è¯†ã€‚</p></blockquote><hr /><h1 id="è™šè¡¨å’Œè™šè¡¨æŒ‡é’ˆvtbl-vptr">è™šè¡¨å’Œè™šè¡¨æŒ‡é’ˆï¼ˆvtbl &amp; vptrï¼‰</h1><blockquote><ul><li>æ¯ä¸ªclassäº§ç”Ÿå‡ºä¸€å †æŒ‡å‘virtualfunctionçš„æŒ‡é’ˆï¼Œæ”¾åœ¨è¡¨æ ¼ä¹‹ä¸­ï¼Œè¿™ä¸ªè¡¨æ ¼è¢«ç§°ä¸ºvirtual tableï¼ˆvtblï¼‰ã€‚</li><li>æ¯ä¸€ä¸ªclass objectè¢«å®‰æ’ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ç›¸å…³çš„virtualtableã€‚é€šå¸¸è¿™ä¸ªæŒ‡é’ˆè¢«ç§°ä¸ºvptrã€‚vptrçš„è®¾å®šï¼ˆsettingï¼‰å’Œé‡ç½®ï¼ˆresettingï¼‰éƒ½ç”±æ¯ä¸€ä¸ªclassçš„constructorã€destructorå’Œcopyassignmentè¿ç®—ç¬¦è‡ªåŠ¨å®Œæˆã€‚æ¯ä¸€ä¸ªclassæ‰€å…³è”çš„type_infoobjectï¼ˆç”¨ä»¥æ”¯æŒruntime type identificationï¼ŒRTTIï¼‰ä¹Ÿç»ç”±virtualtableè¢«æŒ‡å‡ºæ¥ï¼Œé€šå¸¸æ”¾åœ¨è¡¨æ ¼çš„ç¬¬ä¸€ä¸ªslotï¼ˆclang++ä¸æ˜¯æ”¾åœ¨ç¬¬ä¸€ä¸ªslotï¼Œæ–‡ç« åé¢ä¼šè®²åˆ°ï¼‰ã€‚</li></ul></blockquote><hr /><blockquote><p>æ¥ä¸‹æ¥ç¬”è€…å†™ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹æ¥å¸®å¤§å®¶åˆ†æclang++ç¼–è¯‘å™¨ä¸‹çš„vtbl &amp;vptrã€‚ ## é¦–å…ˆå’±ä»¬æ¥çœ‹ä¸‹vptræ”¾åœ¨å¯¹è±¡çš„ä»€ä¹ˆä½ç½®ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> <br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">testfunc</span><span class="hljs-params">()</span></span>&#123;&#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//è™šå‡½æ•°è¡¨æŒ‡é’ˆä½ç½®åˆ†æ</span><br>    <span class="hljs-comment">//ç±»ï¼šæœ‰è™šå‡½æ•°ï¼Œè¿™ä¸ªç±»ä¼šäº§ç”Ÿä¸€ä¸ªè™šå‡½æ•°è¡¨ã€‚</span><br>    <span class="hljs-comment">//ç±»å¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆï¼ˆvptrï¼‰ä¼šæŒ‡å‘è¿™ä¸ªè™šå‡½æ•°è¡¨çš„å¼€å§‹åœ°å€ã€‚</span><br>    A obj;<br>    <span class="hljs-type">int</span> objLen = <span class="hljs-built_in">sizeof</span>(obj);<br>    std::cout&lt;&lt; objLen &lt;&lt; std::endl; <span class="hljs-comment">//x86-64 16å­—èŠ‚</span><br><br>    <span class="hljs-comment">/*p1è·å–å¯¹è±¡é¦–åœ°å€ï¼Œp2è·å–å¯¹è±¡æ•°æ®æˆå‘˜içš„åœ°å€ï¼Œä¸¤è€…éƒ½ä»¥ä½å±‚æ¬¡char *å»è§£é‡Šï¼Œä»¥ä¾¿ç”¨æ—è§‚è€…è§’åº¦å»æ¯”è¾ƒ*/</span><br>    <span class="hljs-type">char</span> *p1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(&amp;obj);<span class="hljs-comment">//reinterpret_casté€šå¸¸ä¸ºè¿ç®—å¯¹è±¡çš„ä½æ¨¡å¼æä¾›è¾ƒä½å±‚æ¬¡ä¸Šçš„é‡æ–°è§£é‡Šã€‚</span><br>    <span class="hljs-type">char</span> *p2 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(&amp;(obj.i));<br>    <span class="hljs-keyword">if</span>(p1 == p2)<span class="hljs-comment">//è¯´æ˜obj.iå’Œobjçš„ä½ç½®ç›¸åŒï¼Œè¯´æ˜iåœ¨å¯¹è±¡objå†…å­˜å¸ƒå±€çš„ä¸Šè¾¹ã€‚è™šå‡½æ•°è¡¨æŒ‡é’ˆvptråœ¨ä¸‹è¾¹</span><br>    &#123;<br>        std::cout&lt;&lt; <span class="hljs-string">&quot;è™šå‡½æ•°è¡¨æŒ‡é’ˆä½äºå¯¹è±¡å†…å­˜çš„ æœ«å°¾ &quot;</span> &lt;&lt;std::endl;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        std::cout&lt;&lt; <span class="hljs-string">&quot;è™šå‡½æ•°è¡¨æŒ‡é’ˆä½äºå¯¹è±¡å†…å­˜çš„ å¼€å¤´ &quot;</span> &lt;&lt;std::endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br /><img src="/img/00006/1.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" /> å¯ä»¥çœ‹åˆ°<code>obj</code>å¯¹è±¡çš„å¤§å°æ˜¯16å­—èŠ‚ï¼Œ<code>vptr</code>ä½äºå¯¹è±¡çš„å¼€å¤´ã€‚</p></blockquote><hr /><blockquote><h2id="æ¥ä¸‹é‡Œå’±ä»¬ä¸èµ°virtualæœºåˆ¶ç›´æ¥ä»è™šè¡¨ä¸­è·å–è™šå‡½æ•°å¹¶ä¸”è¿è¡Œå¯¹åº”è™šå‡½æ•°">æ¥ä¸‹é‡Œå’±ä»¬ä¸èµ°virtualæœºåˆ¶ï¼Œç›´æ¥ä»è™šè¡¨ä¸­è·å–è™šå‡½æ•°å¹¶ä¸”è¿è¡Œå¯¹åº”è™šå‡½æ•°ã€‚</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;Base::f()&quot;</span> &lt;&lt; std::endl; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;Base::g()&quot;</span> &lt;&lt; std::endl; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;Base::h()&quot;</span> &lt;&lt; std::endl; &#125;<br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derive</span> : <span class="hljs-keyword">public</span> Base<br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;Derive::g()&quot;</span> &lt;&lt; std::endl; &#125;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    Derive* pd = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derive</span>();<span class="hljs-comment">//æ´¾ç”Ÿç±»æŒ‡é’ˆã€‚</span><br>    <span class="hljs-type">long</span>* pd_cast = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(pd);<span class="hljs-comment">//è·å–è¾ƒä½å±‚æ¬¡ä¸Šçš„é‡æ–°è§£é‡Šã€‚</span><br>    <span class="hljs-type">long</span>* vptr_pd = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*pd_cast);<br>    <span class="hljs-comment">/*è§£å¼•ç”¨æ´¾ç”Ÿç±»æŒ‡é’ˆå¾—åˆ°è™šè¡¨æŒ‡é’ˆï¼Œè€Œä¸æ˜¯å¾—åˆ°æ´¾ç”Ÿç±»ï¼Œå› ä¸ºåšäº†ä½æ¨¡å¼çš„ä½å±‚æ¬¡è½¬æ¢ã€‚</span><br><span class="hljs-comment">    å¾—åˆ°è™šè¡¨æŒ‡é’ˆåï¼Œå°†è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚</span><br><span class="hljs-comment">    ä½¿ç”¨longè¿‡æ¸¡ï¼Œæ˜¯å› ä¸ºlongåœ¨32ä½ç¼–è¯‘å™¨å’Œ64ä½ç¼–è¯‘å™¨æ‰€å ç”¨çš„ç©ºé—´å¤§å°å’ŒæŒ‡é’ˆæ˜¯ä¸€æ ·çš„*/</span><br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vptr_pd[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,vptr_pd[i]);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*Func)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹</span><br>    Func f_pd = (Func)vptr_pd[<span class="hljs-number">0</span>];<br>    Func g_pd = (Func)vptr_pd[<span class="hljs-number">1</span>];<br>    Func h_pd = (Func)vptr_pd[<span class="hljs-number">2</span>];<br><br>    <span class="hljs-built_in">f_pd</span>();<br>    <span class="hljs-built_in">g_pd</span>();<br>    <span class="hljs-built_in">h_pd</span>();<br><br>    Base* pb = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Base</span>();<span class="hljs-comment">//æ´¾ç”Ÿç±»æŒ‡é’ˆã€‚</span><br>    <span class="hljs-type">long</span>* pb_cast = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(pb);<br>    <span class="hljs-type">long</span>* vptr_pb = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*pb_cast);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vptr_pb[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,vptr_pb[i]);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*Func)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹</span><br>    Func f_pb = (Func)vptr_pb[<span class="hljs-number">0</span>];<br>    Func g_pb = (Func)vptr_pb[<span class="hljs-number">1</span>];<br>    Func h_pb = (Func)vptr_pb[<span class="hljs-number">2</span>];<br><br>    <span class="hljs-built_in">f_pb</span>();<br>    <span class="hljs-built_in">g_pb</span>();<br>    <span class="hljs-built_in">h_pb</span>();<br><br>    <span class="hljs-keyword">delete</span> pd;<br>    <span class="hljs-keyword">delete</span> pb;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿è¡Œç»“æœä¸ºï¼š <img src="/img/00006/2.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />æˆ–è€…ç”¨GDBå‘½ä»¤æ‰“å°å‡ºvtblçš„æ ·å­ï¼š <code>gefâ¤  info vtbl pd</code> <imgsrc="/img/00006/3.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />å’Œä¸Šé¢ä»£ç è¿è¡Œçš„ç»“æœä¸€è‡´ï¼å€¼å¾—å…³æ³¨çš„ä¸€ç‚¹æ˜¯ï¼Œ<code>vtbl</code>æ˜¯å­˜åœ¨äºåªè¯»æ•°æ®æ®µï¼Œè€Œ<code>vptr</code>åœ¨å †ä¸­ï¼ˆ<code>vptr</code>ä¹Ÿå¯ä»¥åœ¨æ ˆä¸­ï¼‰ã€‚ä¸‹é¢ç”¨ä¸€å¼ å›¾æ¥æè¿°ä¸Šè¿°ä»£ç çš„è¡Œä¸ºï¼š <img src="/img/00006/4.png"alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />--------------------------------------------------------</p></blockquote><blockquote><h2 id="vptr-vtblçš„åˆ›å»ºæ—¶æœºä»¥åŠvptråˆå§‹åŒ–é—®é¢˜">vptr &amp;vtblçš„åˆ›å»ºæ—¶æœºä»¥åŠvptråˆå§‹åŒ–é—®é¢˜</h2><p>å¼•ç”¨ã€Šæ·±åº¦æ¢ç´¢C++å¯¹è±¡æ¨¡å‹ã€‹p45ä¸­çš„ä¸€æ®µè¯ï¼šä¸‹é¢ä¸¤ä¸ªæ‰©å¼ è¡ŒåŠ¨ä¼šåœ¨ç¼–è¯‘æœŸé—´å‘ç”Ÿï¼š - ä¸€ä¸ªvirtual functiontableä¼šè¢«ç¼–è¯‘å™¨äº§ç”Ÿå‡ºæ¥ï¼Œå†…æ”¾classçš„virtual functionsåœ°å€ -åœ¨æ¯ä¸€ä¸ªclass objectä¸­ï¼Œä¸€ä¸ªé¢å¤–çš„pointermemberä¼šè¢«ç¼–è¯‘å™¨åˆæˆå‡ºæ¥ï¼Œå†…å«ç›¸å…³çš„class vtblçš„åœ°å€</p><p>åœ¨c++ä¸­ï¼Œvirtualfunctionså¯ä»¥åœ¨ç¼–è¯‘æ—¶æœŸè·çŸ¥ã€‚æ­¤å¤–ï¼Œè¿™ä¸€ç»„åœ°å€æ˜¯å›ºå®šä¸å˜çš„ï¼Œæ‰§è¡ŒæœŸä¸å¯èƒ½æ–°å¢æˆ–æ›¿æ¢å®ƒã€‚ç”±äºç¨‹åºæ‰§è¡Œæ—¶ï¼Œè¡¨æ ¼çš„å¤§å°å’Œå†…å®¹éƒ½ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥å…¶æ„å»ºå’Œå­˜å–çš†å¯ä»¥ç”±ç¼–è¯‘å™¨å®Œå…¨æŒæ¡ï¼Œä¸éœ€è¦æ‰§è¡ŒæœŸçš„ä»»ä½•ä»‹å…¥ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯<code>vptrçš„åˆå§‹åŒ–</code>é—®é¢˜ï¼šè¿™é‡Œç¬”è€…å°±ä¸å¸¦å¤§å®¶ç”»å †æ ˆå›¾ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼ ç›¸å…³ATTå¼åæ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs apache">    <span class="hljs-attribute">Derive</span>* pd = new Derive();//æ´¾ç”Ÿç±»æŒ‡é’ˆã€‚<br>  <span class="hljs-attribute">401222</span>:bf <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       mov    $<span class="hljs-number">0</span>x8,%edi<br>  <span class="hljs-attribute">401227</span>:e8 <span class="hljs-number">64</span> fe ff ff       callq  <span class="hljs-number">401090</span> &lt;operator new(unsigned long)@plt&gt;<br>  <span class="hljs-attribute">40122c</span>:<span class="hljs-number">31</span> f6                xor    %esi,%esi<br>  <span class="hljs-attribute">40122e</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             mov    %rax,%rcx<br>  <span class="hljs-attribute">401231</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             mov    %rcx,%rdi<br>  <span class="hljs-attribute">401234</span>:ba <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       mov    $<span class="hljs-number">0</span>x8,%edx<br>  <span class="hljs-attribute">401239</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> <span class="hljs-number">80</span>          mov    %rax,-<span class="hljs-number">0</span>x80(%rbp)<br>  <span class="hljs-attribute">40123d</span>:e8 <span class="hljs-number">0</span>e fe ff ff       callq  <span class="hljs-number">401050</span> &lt;memset@plt&gt;<br>  <span class="hljs-attribute">401242</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">7</span>d <span class="hljs-number">80</span>          mov    -<span class="hljs-number">0</span>x80(%rbp),%rdi<br>  <span class="hljs-attribute">401246</span>:e8 <span class="hljs-number">95</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">4013</span>e0 &lt;Derive::Derive()&gt;<br>  <span class="hljs-attribute">40124b</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">80</span>          mov    -<span class="hljs-number">0</span>x80(%rbp),%rax<br>  <span class="hljs-attribute">40124f</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <br>  <span class="hljs-attribute">00000000004013e0</span> &lt;Derive::Derive()&gt;:<br><span class="hljs-attribute">class</span> Derive : public Base<br>  <span class="hljs-attribute">4013e0</span>:<span class="hljs-number">55</span>                   push   %rbp<br>  <span class="hljs-attribute">4013e1</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             mov    %rsp,%rbp<br>  <span class="hljs-attribute">4013e4</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> ec <span class="hljs-number">10</span>          sub    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">4013e8</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">4013ec</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">4013f0</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             mov    %rax,%rcx<br>  <span class="hljs-attribute">4013f3</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             mov    %rcx,%rdi<br>  <span class="hljs-attribute">4013f6</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <span class="hljs-attribute">4013fa</span>:e8 <span class="hljs-number">21</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">401420</span> &lt;Base::Base()&gt;<br>  <span class="hljs-attribute">4013ff</span>:<span class="hljs-number">48</span> b8 <span class="hljs-number">70</span> <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> movabs $<span class="hljs-number">0</span>x402070,%rax<br>  <span class="hljs-attribute">401406</span>:<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <br>  <span class="hljs-attribute">401409</span>:<span class="hljs-number">48</span> <span class="hljs-number">05</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    add    $<span class="hljs-number">0</span>x10,%rax<br>  <span class="hljs-attribute">40140f</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d f0          mov    -<span class="hljs-number">0</span>x10(%rbp),%rcx<br>  <span class="hljs-attribute">401413</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">01</span>             mov    %rax,(%rcx)<br>  <span class="hljs-attribute">401416</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> c4 <span class="hljs-number">10</span>          add    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">40141a</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br>  <span class="hljs-attribute">40141b</span>:c3                   retq   <br>  <span class="hljs-attribute">40141c</span>:<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">40</span> <span class="hljs-number">00</span>          nopl   <span class="hljs-number">0</span>x0(%rax)<br><br><span class="hljs-attribute">0000000000401420</span> &lt;Base::Base()&gt;:<br><span class="hljs-attribute">class</span> Base<br>  <span class="hljs-attribute">401420</span>:<span class="hljs-number">55</span>                   push   %rbp<br>  <span class="hljs-attribute">401421</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             mov    %rsp,%rbp<br>  <span class="hljs-attribute">401424</span>:<span class="hljs-number">48</span> b8 d0 <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> movabs $<span class="hljs-number">0</span>x4020d0,%rax<br>  <span class="hljs-attribute">40142b</span>:<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <br>  <span class="hljs-attribute">40142e</span>:<span class="hljs-number">48</span> <span class="hljs-number">05</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    add    $<span class="hljs-number">0</span>x10,%rax<br>  <span class="hljs-attribute">401434</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">401438</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d f8          mov    -<span class="hljs-number">0</span>x8(%rbp),%rcx<br>  <span class="hljs-attribute">40143c</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">01</span>             mov    %rax,(%rcx)<br>  <span class="hljs-attribute">40143f</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br>  <span class="hljs-attribute">401440</span>:c3                   retq   <br>  <span class="hljs-attribute">401441</span>:<span class="hljs-number">66</span> <span class="hljs-number">2</span>e <span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">84</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> nopw   %cs:<span class="hljs-number">0</span>x0(%rax,%rax,<span class="hljs-number">1</span>)<br>  <span class="hljs-attribute">401448</span>:<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <br>  <span class="hljs-attribute">40144b</span>:<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">44</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       nopl   <span class="hljs-number">0</span>x0(%rax,%rax,<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>--------------------------------------------------------</p></blockquote><blockquote><p><img src="/img/00006/5.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />è¯¥å›¾å¯¹åº”<code>mov    %rax,-0x80(%rbp)</code>æ‰§è¡Œå®Œã€‚å·²ç»å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šnewè¡¨è¾¾å¼é€šè¿‡<code>operator new(unsigned long)</code>è¿™ä¸ªåŠ¨æ€å‡½æ•°ç”³è¯·äº†é¦–åœ°å€ä¸º<code>0x0000000000416eb0</code>çš„å †å†…å­˜ï¼Œå¹¶å°†å…¶èµ‹ç»™äº†æ ˆç©ºé—´ä¸º<code>rbp-0x80ï¼ˆ0x00007fffffffe060ï¼‰</code>çš„åœ°å€ä¸­ï¼Œä¸‹ä¸€æ¡åæ±‡ç¼–ä»£ç å°†ä¼šä¸ºé¦–åœ°å€ä¸º<code>0x0000000000416eb0</code>çš„å †å†…å­˜è¿›è¡Œå†…å­˜åˆå§‹åŒ–ã€‚ï¼ˆå»¶è¿Ÿç»‘å®š:åŠ¨æ€å‡½æ•°æ¯”é™æ€å‡½æ•°ç»‘å®šè¦æ™šé™æ€å‡½æ•°åœ¨<code>a.out</code>ç”Ÿæˆçš„æ—¶å€™åœ°å€å·²ç»è¢«ç»‘å®šåŠ¨æ€å‡½æ•°éœ€è¦åŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åç”¨åŠ¨æ€åº“é‡Œé¢çš„å‡½æ•°åœ°å€æ›¿æ¢æ‰ç±»ä¼¼äºåæ±‡ç¼–å‡ºæ¥çš„<code>@plt</code>ï¼Œä¹‹åå¾—åˆ°åŠ¨æ€å‡½æ•°çš„åœ°å€è¿›è¡Œè°ƒç”¨ã€‚ï¼‰</p></blockquote><hr /><blockquote><p><img src="/img/00006/6.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />è¯¥å›¾å¯¹åº”<code>0x40143c &lt;Base::Base()+28&gt; mov    QWORD PTR [rcx], rax</code>æ‰§è¡Œå®Œã€‚å·²ç»å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šè°ƒç”¨äº†<code>Deriveåˆæˆé»˜è®¤æ„é€ å‡½æ•°</code>ï¼Œå¹¶ä¸”åœ¨å…¶ä¸­åˆè°ƒç”¨äº†<code>Baseåˆæˆé»˜è®¤æ„é€ å‡½æ•°</code>ï¼Œé¦–åœ°å€ä¸º<code>0x0000000000416eb0</code>çš„å †å†…å­˜æŒ‡é’ˆèµ‹ç»™äº†ç¬¬ä¸€å‚æ•°å¯„å­˜å™¨<code>rdi</code>ï¼Œ<code>0x4020d0ç«‹å³æ•°</code>ï¼ˆBaseè™šè¡¨åœ°å€ï¼‰èµ‹ç»™äº†ä¸´æ—¶å¯„å­˜å™¨<code>rax</code>ï¼Œ<code>rdi</code>å¯„å­˜å™¨åˆå°†å †å†…å­˜æŒ‡é’ˆèµ‹ç»™äº†Baseåˆæˆé»˜è®¤æ„é€ å‡½æ•°çš„<code>rbp-0x8</code>åœ°å€ä¸Šï¼Œæœ€åç”±<code>rax</code>å¯„å­˜å™¨å°†Baseè™šè¡¨åœ°å€èµ‹ç»™äº†å †å†…å­˜æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ä¸­ã€‚è‡³æ­¤newå‡ºæ¥çš„Deriveç±»å¯¹è±¡çš„<code>vptr</code>å·²ç»è·å–åˆ°Baseç±»çš„è™šè¡¨åœ°å€ï¼ˆæ³¨æ„ç°åœ¨è¿˜æ²¡æœ‰è·å–åˆ°Deriveç±»çš„è™šè¡¨åœ°å€ï¼‰ã€‚</p></blockquote><hr /><blockquote><p><img src="/img/00006/7.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />è¯¥å›¾å¯¹åº”<code>0x401413 &lt;Derive::Derive()+51&gt; mov    QWORD PTR [rcx], rax</code>æ‰§è¡Œå®Œã€‚å·²ç»å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼š<code>Baseçš„åˆæˆé»˜è®¤æ„é€ å‡½æ•°</code>å·²<code>return</code>ï¼Œæ¥ç€<code>0x402070ç«‹å³æ•°</code>èµ‹ç»™äº†<code>rax</code>å¯„å­˜å™¨ï¼Œ<code>rax</code>å°†å…¶å€¼åŠ ä¸Š<code>0x10</code>åå°±å¾—åˆ°äº†Deriveç±»çš„è™šè¡¨åœ°å€ã€‚ç„¶å<code>rax</code>å°†è¯¥åœ°å€èµ‹ç»™äº†å †å†…å­˜æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ä¸­ã€‚è‡³æ­¤ä¼´éšç€<code>Deriveåˆæˆé»˜è®¤æ„é€ å‡½æ•°</code>çš„ç»“æŸï¼Œnewå‡ºæ¥çš„Deriveç±»å¯¹è±¡çš„<code>vptr</code>è·å¾—äº†è‡ªå·±çš„è™šè¡¨åœ°å€ã€‚</p></blockquote><hr /><h3 id="vptråˆå§‹åŒ–å°ç»“">vptråˆå§‹åŒ–å°ç»“</h3><blockquote><p>å¯ä»¥å‘ç°ï¼Œ<code>vptrçš„åˆå§‹åŒ–</code>å¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±è·å¾—äº†è‡ªå·±çš„è™šè¡¨åœ°å€ï¼Œè€Œæ˜¯ä¼´éšçˆ¶ç±»åˆæˆé»˜è®¤æ„é€ å‡½æ•°çš„ç»“æŸï¼Œå…ˆè·å¾—çˆ¶ç±»è™šè¡¨åœ°å€ï¼Œç„¶åä¼´éšè‡ªèº«åˆæˆé»˜è®¤æ„é€ å‡½æ•°çš„ç»“æŸï¼Œå†è·å¾—è‡ªèº«è™šè¡¨åœ°å€ã€‚</p></blockquote><hr /><h2id="ç¼–è¯‘å™¨ä¼šåˆæˆå‡ºnontrivial-default-constructorçš„4ç§æƒ…å†µæ·±åº¦æ¢ç´¢cå¯¹è±¡æ¨¡å‹p40">ç¼–è¯‘å™¨ä¼šåˆæˆå‡ºnontrivialdefault constructorçš„4ç§æƒ…å†µï¼ˆã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p40ï¼‰</h2><blockquote><ul><li>å¸¦æœ‰default constructorçš„member class object</li></ul><p>å¦‚æœä¸€ä¸ªclassæ²¡æœ‰ä»»ä½•constructorï¼Œä½†å®ƒå†…å«ä¸€ä¸ªmemberobjectï¼Œè€Œåè€…æœ‰default constructorï¼Œé‚£ä¹ˆè¿™ä¸ªclassçš„implicit defaultconstructorå°±æ˜¯nontrivialï¼Œç¼–è¯‘å™¨éœ€è¦ä¸ºè¯¥classåˆæˆå‡ºä¸€ä¸ªdefaultconstructorã€‚ - å¸¦æœ‰default constructorçš„base class</p><p>å¦‚æœä¸€ä¸ªæ²¡æœ‰ä»»ä½•constructorçš„classæ´¾ç”Ÿè‡ªä¸€ä¸ªå¸¦æœ‰defaultconstructorçš„base classï¼Œé‚£ä¹ˆè¿™ä¸ªderived classçš„defaultconstructorä¼šè¢«è§†ä¸ºnontrivialï¼Œå¹¶å› æ­¤éœ€è¦è¢«åˆæˆå‡ºæ¥ã€‚å®ƒå°†è°ƒç”¨ä¸Šä¸€å±‚baseclassesçš„default constructorï¼ˆæ ¹æ®å®ƒä»¬çš„å£°æ˜é¡ºåºï¼‰ã€‚ - å¸¦æœ‰ä¸€ä¸ªvirtualfunctionçš„class</p><p>å¯¹äºé‚£äº›æœªå£°æ˜ä»»ä½•constructorçš„classesï¼Œç¼–è¯‘å™¨ä¼šä¸ºå®ƒä»¬åˆæˆä¸€ä¸ªdefaultconstructorï¼Œä»¥ä¾¿æ­£ç¡®åœ°åˆå§‹åŒ–æ¯ä¸€ä¸ªclass objectçš„vptrã€‚ -å¸¦æœ‰ä¸€ä¸ªvirtual base classçš„class</p><p>Virtual base classçš„å®ç°æ–¹æ³•åœ¨ä¸åŒç¼–è¯‘å™¨ä¹‹é—´æœ‰æå¤§çš„å·®å¼‚ã€‚ç„¶è€Œï¼Œæ¯ä¸€ç§å®ç°æ–¹æ³•çš„å…±åŒç‚¹åœ¨äºå¿…é¡»ä½¿virtualbase classåœ¨å…¶æ¯ä¸€ä¸ªderived classobjectä¸­çš„ä½ç½®ï¼Œèƒ½å¤Ÿäºæ‰§è¡ŒæœŸå‡†å¤‡å¦¥å½“ã€‚åœ¨æœªå£°æ˜ä»»ä½•constructorçš„derivedclass objectä¸­ï¼Œç¼–è¯‘å™¨å¿…é¡»ä¸ºå®ƒåˆæˆä¸€ä¸ªdefaultconstructorï¼Œå¹¶å®‰æ’é‚£äº›â€œå…è®¸æ¯ä¸€ä¸ªvirtual baseclassçš„æ‰§è¡ŒæœŸå­˜å–æ“ä½œâ€çš„ä»£ç ã€‚</p></blockquote><hr /><h1id="å¤šé‡ç»§æ‰¿ä¸‹çš„virtual-functionthunkä»¥åŠç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šåŠ¨æ€ç»‘å®š">å¤šé‡ç»§æ‰¿ä¸‹çš„virtualfunctionï¼Œthunkï¼Œä»¥åŠç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰</h1><blockquote><p>åœ¨å¤šé‡ç»§æ‰¿ä¸­æ”¯æŒvirtual functionï¼Œå…¶å¤æ‚åº¦å›´ç»•åœ¨ç¬¬äºŒä¸ªä»¥åŠåç»§çš„baseclassesèº«ä¸Šï¼Œä»¥åŠâ€œå¿…é¡»åœ¨æ‰§è¡ŒæœŸè°ƒæ•´thisæŒ‡é’ˆâ€è¿™ä¸€ç‚¹ï¼Œä»¥ä¸‹é¢çš„classä½“ç³»ä¸ºä¾‹ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::g()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><span class="hljs-comment">//åŸºç±»2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">i</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::i()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»1çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">i</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»2çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::i()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br><br>    <span class="hljs-comment">//æˆ‘ä»¬è‡ªå·±çš„è™šå‡½æ•°</span><br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">myFunc1</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::myFunc1()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-comment">//éè™šå‡½æ•°</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">myFunc2</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::myFunc2()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br><br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    std::cout &lt;&lt; <span class="hljs-built_in">sizeof</span>(Base1) &lt;&lt; std::endl;<br>    std::cout &lt;&lt; <span class="hljs-built_in">sizeof</span>(Base2) &lt;&lt; std::endl;<br>    std::cout &lt;&lt; <span class="hljs-built_in">sizeof</span>(Derived) &lt;&lt; std::endl;<br><br>    Derived ins;<br>    Base1&amp; b1 = ins;<span class="hljs-comment">//ä¸ºäº†æ”¯æŒå¤šæ€ã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹p25ã€‹</span><br>    Base2&amp; b2 = ins;<br>    Derived&amp; d = ins;<br><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*Func)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<br>    <span class="hljs-comment">/*è·å¾—Base1ç±»çš„ç¬¬è™šè¡¨æŒ‡é’ˆ*/</span><br>    Base1 temp1;<br>    <span class="hljs-type">long</span>* base1_cast = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(&amp;temp1);<span class="hljs-comment">//é‡æ–°è§£é‡Šç±»å¯¹è±¡,è·å¾—è™šè¡¨æŒ‡é’ˆçš„åœ°å€ã€‚</span><br>    <span class="hljs-type">long</span>* base1_vptr = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*base1_cast);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-comment">//æ‰“å°è™šå‡½æ•°åœ°å€</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base1_vptr[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,base1_vptr[i]);<br>        ((Func)base1_vptr[i])();<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">/*è·å¾—Base2ç±»çš„ç¬¬è™šè¡¨æŒ‡é’ˆ*/</span><br>    Base2 temp2;<br>    <span class="hljs-type">long</span>* base2_cast = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(&amp;temp2);<span class="hljs-comment">//é‡æ–°è§£é‡Šç±»å¯¹è±¡,è·å¾—ç¬¬è™šè¡¨æŒ‡é’ˆçš„åœ°å€ã€‚</span><br>    <span class="hljs-type">long</span>* base2_vptr = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*base2_cast);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-comment">//æ‰“å°è™šå‡½æ•°åœ°å€</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base2_vptr[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,base2_vptr[i]);<br>        ((Func)base2_vptr[i])();<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">/*è·å¾—derivedç±»çš„ç¬¬ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆ*/</span><br>    <span class="hljs-type">long</span>* ins_cast1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(&amp;ins);<span class="hljs-comment">//é‡æ–°è§£é‡Šç±»å¯¹è±¡,è·å¾—ç¬¬ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆçš„åœ°å€ã€‚</span><br>    <span class="hljs-type">long</span>* vptr1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*ins_cast1);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-comment">//æ‰“å°è™šå‡½æ•°åœ°å€</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vptr1[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,vptr1[i]);<br>        ((Func)vptr1[i])();<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">/*è·å¾—derivedç±»çš„ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆ*/</span><br>    <span class="hljs-type">long</span>* ins_cast2 = ins_cast1 + <span class="hljs-number">1</span>;<span class="hljs-comment">//åç§»åˆ°ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆçš„åœ°å€ä¸Š</span><br>    <span class="hljs-type">long</span>* vptr2 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*ins_cast2);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-comment">//æ‰“å°è™šå‡½æ•°åœ°å€</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vptr2[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,vptr2[i]);<br>        ((Func)vptr2[i])();<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">//åŠ¨æ€ç»‘å®š</span><br>    b1.<span class="hljs-built_in">f</span>();<br>    b2.<span class="hljs-built_in">i</span>();<br>    d.<span class="hljs-built_in">f</span>();<br>    d.<span class="hljs-built_in">i</span>();<br>    d.<span class="hljs-built_in">g</span>();<br>    d.<span class="hljs-built_in">myFunc1</span>();<br>    <span class="hljs-comment">//ç¼–è¯‘æœŸç»‘å®š</span><br>    d.<span class="hljs-built_in">myFunc2</span>();<br>&#125;<br></code></pre></td></tr></table></figure>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„å­ç±»ä¼šæœ‰ä¸¤ä¸ªè™šæŒ‡é’ˆï¼Œä¸¤å¼ è™šè¡¨ï¼Œç¬¬ä¸€å¼ è™šè¡¨æ˜¯é‡å†™çˆ¶ç±»è™šå‡½æ•°ã€è‡ªèº«è™šå‡½æ•°ä»¥åŠbase1è™šå‡½æ•°å…±äº«çš„è™šè¡¨ï¼Œç¬¬äºŒå¼ åˆ™æ˜¯é’ˆå¯¹base2çš„ã€‚ä¸‹é¢æ¥çœ‹ä¸‹è¿è¡Œç»“æœï¼š<img src="/img/00006/8.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />é‡å†™çš„çˆ¶ç±»è™šå‡½æ•°ï¼š<code>f()</code>ï¼Œ<code>i()</code>ã€è‡ªèº«è™šå‡½æ•°ï¼š<code>myFunc1()</code>ã€base1è™šå‡½æ•°ï¼š<code>g()</code>éƒ½åœ¨ç¬¬ä¸€å¼ è™šè¡¨ã€‚è€Œç¬¬äºŒå¼ è™šè¡¨ä¸­ï¼Œ<code>h()</code>çš„å‡ºç°å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯è¿™ä¸ªè¢«é‡å†™çš„çˆ¶ç±»è™šå‡½æ•°<code>i()</code>ï¼Œä¸ºä»€ä¹ˆä¼šå†æ¬¡å‡ºç°å‘¢ï¼Ÿï¼Œä¸åº”è¯¥åªåœ¨è¡¨ä¸€å‡ºç°å—ï¼Ÿè¿™é‡Œè¡¨äºŒä¸­è¢«é‡å†™çš„çˆ¶ç±»è™šå‡½æ•°<code>i()</code>ï¼Œå…¶çœŸåå«<code>nonvirtual thunk</code>å‡½æ•°ã€‚å’±ä»¬ç”¨æŒ‡ä»¤æ¥æ›´æ¸…æ™°çš„è§‚å¯ŸDerivedç±»å¯¹è±¡insçš„ä¸¤å¼ è™šè¡¨ï¼š ï¼ˆæ³¨æ„ï¼šå¿…é¡»åœ¨æ”¯æŒå¤šæ€çš„æƒ…å†µä¸‹è§‚å¯ŸDerivedç±»å¯¹è±¡insï¼Œå…·ä½“åŸå› è¯·å‚è€ƒã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p13ï¼‰<img src="/img/00006/9.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />ä¸Šæ–‡è¯´è¿‡â€œå¿…é¡»åœ¨æ‰§è¡ŒæœŸè°ƒæ•´thisæŒ‡é’ˆâ€ï¼Œè€Œthunkå‡½æ•°çš„çœŸæ­£ç›®çš„ä¸ºï¼š -ä»¥é€‚å½“çš„offsetå€¼è°ƒæ•´thisæŒ‡é’ˆ - è·³åˆ°virtual functionå»</p><p>å…¶å®thunkå‡½æ•°å°±æ˜¯ä¸€æ®µassemblyä»£ç ï¼Œä¸‹é¢æˆ‘ä¼šå¸¦å¤§å®¶ä¸€èµ·æ­å¼€thunkå‡½æ•°çš„çœŸæ­£é¢çº±ï¼é¦–å…ˆè¦æƒ³çŸ¥é“thunkå‡½æ•°å¹²äº†ä»€ä¹ˆï¼Œå°±è¦æƒ³ä¸ªåŠæ³•å»è°ƒç”¨å®ƒï¼Œç„¶åè·Ÿè¸ªè¿›å»ã€‚æˆ‘ä»¬ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­æœ‰ä¸€è¡Œä»£ç ï¼š<code>b2.i();</code>ä¼šè°ƒç”¨thunkå‡½æ•°ã€‚åŸå› æ˜¯<code>Base2&amp; b2 = ins;</code>ä¸­ï¼Œb2çš„thisæŒ‡é’ˆæŒ‡å‘çš„inså¯¹è±¡çš„ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨inså¯¹è±¡çš„è¢«é‡å†™çˆ¶ç±»è™šå‡½æ•°<code>i()</code>æ—¶ï¼Œéœ€è¦è°ƒæ•´thisæŒ‡é’ˆã€‚å…·ä½“åˆ†æè¿‡ç¨‹å¦‚ä¸‹ï¼š <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache">    <span class="hljs-attribute">b2</span>.i();<br>  <span class="hljs-attribute">401553</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d8          mov    -<span class="hljs-number">0</span>x28(%rbp),%rax//rbp-<span class="hljs-number">0</span>x28é‡Œé¢å­˜ç€b2çš„thisæŒ‡é’ˆï¼ŒæŒ‡å‘inså¯¹è±¡çš„ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆ<br>  <span class="hljs-attribute">401557</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx//å°†insè™šè¡¨äºŒçš„ç¬¬ä¸€ä¸ªè™šå‡½æ•°æŒ‡é’ˆèµ‹ç»™äº†rcxå¯„å­˜å™¨<br>  <span class="hljs-attribute">40155a</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi//å°†b2çš„thisæŒ‡é’ˆå­˜åˆ°rdiå¯„å­˜å™¨ä½œä¸ºthunkå‡½æ•°çš„ç¬¬ä¸€å‚æ•°<br>  <span class="hljs-attribute">40155d</span>:ff <span class="hljs-number">51</span> <span class="hljs-number">08</span>             callq  *<span class="hljs-number">0</span>x8(%rcx)//åç§»<span class="hljs-number">0</span>x8å­—èŠ‚åè°ƒç”¨thunkå‡½æ•°ï¼Œ*<span class="hljs-number">0</span>x8(%rcx)çš„å€¼ä¸º<span class="hljs-number">0</span>x4017f0<br><br><span class="hljs-attribute">00000000004017f0</span> &lt;non-virtual thunk to Derived::i()&gt;:<br>  <span class="hljs-attribute">4017f0</span>:<span class="hljs-number">55</span>                   push   %rbp<br>  <span class="hljs-attribute">4017f1</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             mov    %rsp,%rbp<br>  <span class="hljs-attribute">4017f4</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)//å°†b2çš„thisæŒ‡é’ˆå­˜æ”¾åˆ°è¯¥thunkå‡½æ•°rbp-<span class="hljs-number">0</span>x8çš„åœ°å€ä¸­<br>  <span class="hljs-attribute">4017f8</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          mov    -<span class="hljs-number">0</span>x8(%rbp),%rax//å°†b2çš„thisæŒ‡é’ˆå­˜æ”¾åˆ°raxä¸´æ—¶å¯„å­˜å™¨ä¸­<br>  <span class="hljs-attribute">4017fc</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> c0 f8          add    $<span class="hljs-number">0</span>xfffffffffffffff8,%rax//thisæŒ‡é’ˆçš„å€¼ï¼ˆ<span class="hljs-number">0</span>x00007fffffffe120ï¼‰åŠ ä¸Š<span class="hljs-number">0</span>xfffffffffffffff8ï¼Œå› ä¸ºæº¢å‡ºï¼Œç›¸å½“äº<span class="hljs-number">0</span>x00007fffffffe120-<span class="hljs-number">0</span>x8ï¼Œç»“æœä¸º<span class="hljs-number">0</span>x00007fffffffe118å³inså¯¹è±¡çš„é¦–åœ°å€<br>  <span class="hljs-attribute">401800</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi//å°†åç§»åçš„thisæŒ‡é’ˆå­˜åˆ°rdiç¬¬ä¸€å‚æ•°å¯„å­˜å™¨ä¸­ï¼Œä½œä¸º&lt;Derived::i()&gt;çš„å‚æ•°<br>  <span class="hljs-attribute">401803</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br>  <span class="hljs-attribute">401804</span>:e9 <span class="hljs-number">27</span> ff ff ff       jmpq   <span class="hljs-number">401730</span> &lt;Derived::i()&gt;<br>  <span class="hljs-attribute">401809</span>:<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> nopl   <span class="hljs-number">0</span>x0(%rax)<br></code></pre></td></tr></table></figure>åé¢å°±æ˜¯è°ƒç”¨è™šå‡½æ•°<code>&lt;Derived::i()&gt;</code>åçš„è¿‡ç¨‹ï¼Œä¸å†èµ˜è¿°ã€‚ç»è¿‡åˆ†æï¼Œå¯ä»¥å‘ç°thunkå‡½æ•°å°±åšäº†ä¸¤ä»¶äº‹ï¼Œä»¥é€‚å½“çš„<code>offset</code>å€¼è°ƒæ•´thisæŒ‡é’ˆï¼Œè·³åˆ°virtualfunctionå»ã€‚å’Œä¸Šé¢è¯´çš„ä¸¤ç‚¹å®Œå…¨ä¸€è‡´ã€‚</p></blockquote><hr /><h2id="ç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šåŠ¨æ€ç»‘å®š">ç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰</h2><blockquote><p>è¿˜æ˜¯ç”¨ä¸Šé¢çš„ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°å­ç±»ä¸­æœ‰å®šä¹‰ä¸€ä¸ªéè™šå‡½æ•°ã€‚å’±ä»¬å°±æ¥çœ‹ä¸‹ä»€ä¹ˆæ˜¯è¿è¡ŒæœŸç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„åŒºåˆ«æ˜¯ä»€ä¹ˆã€‚åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹ç»‘å®šçš„æ¦‚å¿µï¼šè°ƒç”¨ä»£ç è·Ÿå‡½æ•°åœ°å€ä»€ä¹ˆæ—¶å€™å…³è”åˆ°ä¸€èµ·ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//ç¼–è¯‘æœŸç»‘å®š</span><br>d.<span class="hljs-built_in">myFunc2</span>();<br></code></pre></td></tr></table></figure> <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">d</span>.myFunc2();<br><span class="hljs-attribute">401596</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">7</span>d d0          mov    -<span class="hljs-number">0</span>x30(%rbp),%rdi<br><span class="hljs-attribute">40159a</span>:e8 d1 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">401670</span> &lt;Derived::myFunc2()&gt;<br></code></pre></td></tr></table></figure><code>ç¼–è¯‘æœŸç»‘å®š</code>ï¼šè°ƒç”¨ä»£ç è·Ÿå‡½æ•°åœ¨ç¼–è¯‘æœŸå°±å…³è”åˆ°ä¸€èµ·ã€‚å¯ä»¥çœ‹åˆ°å‡½æ•°è°ƒç”¨æ˜¯ç›´æ¥è°ƒç”¨æŒ‡å®šåœ°å€çš„å‡½æ•°ï¼Œè€Œä¸”æœºå™¨ç ä¼šå‡ºç°E8çš„å­—æ ·ï¼Œè¡¨ç¤ºç›´æ¥è°ƒç”¨ï¼Œä¿—ç§°<code>E8CALL</code>ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//åŠ¨æ€ç»‘å®š</span><br>b1.<span class="hljs-built_in">f</span>();<br>b2.<span class="hljs-built_in">i</span>();<br>d.<span class="hljs-built_in">f</span>();<br>d.<span class="hljs-built_in">i</span>();<br>d.<span class="hljs-built_in">g</span>();<br>d.<span class="hljs-built_in">myFunc1</span>();<br></code></pre></td></tr></table></figure> <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs apache"> <span class="hljs-attribute">b1</span>.f();<br><span class="hljs-attribute">401540</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d e0          mov    -<span class="hljs-number">0</span>x20(%rbp),%rcx<br><span class="hljs-attribute">401544</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">11</span>             mov    (%rcx),%rdx<br><span class="hljs-attribute">401547</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             mov    %rcx,%rdi<br><span class="hljs-attribute">40154a</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">85</span> <span class="hljs-number">20</span> ff ff ff mov    %rax,-<span class="hljs-number">0</span>xe0(%rbp)<br><span class="hljs-attribute">401551</span>:ff <span class="hljs-number">12</span>                callq  *(%rdx)<br>  <span class="hljs-attribute">b2</span>.i();<br><span class="hljs-attribute">401553</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d8          mov    -<span class="hljs-number">0</span>x28(%rbp),%rax<br><span class="hljs-attribute">401557</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">40155a</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">40155d</span>:ff <span class="hljs-number">51</span> <span class="hljs-number">08</span>             callq  *<span class="hljs-number">0</span>x8(%rcx)<br>  <span class="hljs-attribute">d</span>.f();<br><span class="hljs-attribute">401560</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">401564</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">401567</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">40156a</span>:ff <span class="hljs-number">11</span>                callq  *(%rcx)<br>  <span class="hljs-attribute">d</span>.i();<br><span class="hljs-attribute">40156c</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">401570</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">401573</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">401576</span>:ff <span class="hljs-number">51</span> <span class="hljs-number">10</span>             callq  *<span class="hljs-number">0</span>x10(%rcx)<br>  <span class="hljs-attribute">d</span>.g();<br><span class="hljs-attribute">401579</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">40157d</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             mov    %rax,%rcx<br><span class="hljs-attribute">401580</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">00</span>             mov    (%rax),%rax<br><span class="hljs-attribute">401583</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             mov    %rcx,%rdi<br><span class="hljs-attribute">401586</span>:ff <span class="hljs-number">50</span> <span class="hljs-number">08</span>             callq  *<span class="hljs-number">0</span>x8(%rax)<br>  <span class="hljs-attribute">d</span>.myFunc1();<br><span class="hljs-attribute">401589</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">40158d</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">401590</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">401593</span>:ff <span class="hljs-number">51</span> <span class="hljs-number">18</span>             callq  *<span class="hljs-number">0</span>x18(%rcx)<br></code></pre></td></tr></table></figure><code>åŠ¨æ€ç»‘å®š</code>ï¼šè°ƒç”¨ä»£ç è·Ÿå‡½æ•°åœ¨è¿è¡ŒæœŸæ‰èƒ½å…³è”åˆ°ä¸€èµ·ã€‚é€šè¿‡ä¸Šé¢çš„åæ±‡ç¼–ä»£ç å¯ä»¥å‘ç°ï¼Œå‡½æ•°çš„è°ƒç”¨åœ°å€æ˜¯åŸºäºæŸä¸ªå¯„å­˜å™¨çš„åç§»å€¼è€Œç¡®å®šçš„ï¼Œæ— æ³•åœ¨ç¼–è¯‘æœŸç¡®å®šã€‚è€Œä¸”åœ¨å‡½æ•°è°ƒç”¨æœºå™¨ç ä¸­ä¼šå‡ºç°ffçš„å­—æ ·ï¼Œè¡¨ç¤ºé—´æ¥è°ƒç”¨ï¼Œä¿—ç§°<code>FFCALL</code>ã€‚åŠ¨æ€ç»‘å®šè¿˜æœ‰ä¸€ä¸ªåˆ«åå«<code>å¤šæ€</code>ï¼Œåªæœ‰è™šå‡½æ•°æ‰èƒ½æ˜¯åŠ¨æ€ç»‘å®šã€‚</p></blockquote><hr /><h1id="å¤šé‡ç»§æ‰¿ä¸‹çš„æˆå‘˜å¸ƒå±€ä»¥åŠthisæŒ‡é’ˆåç§»">å¤šé‡ç»§æ‰¿ä¸‹çš„æˆå‘˜å¸ƒå±€ä»¥åŠthisæŒ‡é’ˆåç§»</h1><blockquote><p>ç»è¿‡ä¸Šæ–‡çš„åˆ†æï¼Œæˆ‘ä»¬å·²ç»ç†ŸçŸ¥å¤šé‡ç»§æ‰¿ä¸‹è™šæœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚è¿™ä¸€å°èŠ‚ï¼Œæˆ‘å°†å¸¦å¤§å®¶åˆ†æçˆ¶ç±»å«æˆå‘˜å˜é‡æ—¶å¤šé‡ç»§æ‰¿çš„æˆå‘˜å¸ƒå±€ã€‚åœ¨çˆ¶ç±»æŒ‡é’ˆæ”¯æŒå¤šæ€æ—¶ä¼šå‘ç”ŸthisæŒ‡é’ˆåç§»ï¼ŒdeletethisæŒ‡é’ˆåç§»åçš„çˆ¶ç±»æŒ‡é’ˆä¼šå¯¼è‡´å¼‚å¸¸ã€‚è¯´çš„æœ‰ç‚¹ç¹çï¼Œä¸è¦ç´§ï¼Œå’±ä»¬çœ‹ä¸‹æ–‡ï¼šä»£ç ç¤ºä¾‹ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//åŸºç±»1</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base1</span>():<span class="hljs-built_in">b1</span>(<span class="hljs-number">1</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-type">int</span> b1;<br>&#125;;<br><span class="hljs-comment">//åŸºç±»2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base2</span>():<span class="hljs-built_in">b2</span>(<span class="hljs-number">2</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-type">int</span> b2;<br>&#125;;<br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Derived</span>():<span class="hljs-built_in">m</span>(<span class="hljs-number">3</span>),<span class="hljs-built_in">n</span>(<span class="hljs-number">4</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»1çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-type">int</span> m;<br>    <span class="hljs-type">int</span> n;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derivedç±»çš„å¤§å°%d\n&quot;</span>,<span class="hljs-built_in">sizeof</span>(Derived));<br>    <span class="hljs-comment">//æ‰“å°æˆå‘˜å˜é‡çš„åç§»å€¼</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derived::b1 = %d\n&quot;</span>,&amp;Derived::b1);<span class="hljs-comment">//b1æ˜¯åŸºäºBase1çš„åç§»</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derived::b2 = %d\n&quot;</span>,&amp;Derived::b2);<span class="hljs-comment">//b2æ˜¯åŸºäºBase2çš„åç§»</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derived::m = %d\n&quot;</span>,&amp;Derived::m);<span class="hljs-comment">//måŸºäºDerivedçš„åç§»</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derived::n = %d\n&quot;</span>,&amp;Derived::n);<span class="hljs-comment">//nåŸºäºDerivedçš„åç§»</span><br><br>    Derived obj;<br>    Base1 *pbase1 = &amp;obj;<span class="hljs-comment">//thisæŒ‡é’ˆæ²¡æœ‰è°ƒæ•´ã€‚</span><br>    Base2 *pbase2 = &amp;obj;<span class="hljs-comment">//thisæŒ‡é’ˆå‘ä¸‹è°ƒæ•´0x10å­—èŠ‚ã€‚</span><br><br>    <span class="hljs-comment">//ç°åœ¨æˆ‘ä»¬çŸ¥é“Base2åœ¨æ”¯æŒå¤šæ€æ—¶ä¼šè°ƒæ•´thisæŒ‡é’ˆã€‚å¦‚æœæˆ‘ä»¬çš„objæ˜¯newå‡ºæ¥çš„ï¼Œå½“æˆ‘ä»¬ç”¨deleteå»åˆ é™¤pbase2æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</span><br>    Base2 *new_pbase2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    <span class="hljs-comment">//delete new_pbase2;å¼‚å¸¸</span><br>    <span class="hljs-built_in">delete</span> (Derived*)new_pbase2;<span class="hljs-comment">//è®©ç¼–è¯‘å™¨é‡æ–°è°ƒæ•´thisæŒ‡é’ˆï¼Œå†deleteæ‰ã€‚</span><br>&#125;<br></code></pre></td></tr></table></figure> è¿è¡Œç»“æœå¦‚ä¸‹ï¼š <img src="/img/00006/10.png"alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />æ ¹æ®æ•°æ®æˆå‘˜çš„åç§»å€¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¯¥ç±»çš„æˆå‘˜å¸ƒå±€ï¼š <imgsrc="/img/00006/11.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />ç”¨GDBæ‰“å°å‡ºç©ºé—´å¸ƒå±€ï¼Œä»¥åŠè™šè¡¨å†…çš„è™šå‡½æ•°ï¼š <img src="/img/00006/12.png"alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" /> å’Œä¸Šè¿°è¯´æ˜ä¸€è‡´ï¼å€¼å¾—å…³æ³¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼ŒBase2åœ¨æ”¯æŒå¤šæ€æ—¶ä¼šè°ƒæ•´thisæŒ‡é’ˆã€‚å¦‚æœæˆ‘ä»¬çš„objæ˜¯newå‡ºæ¥çš„ï¼Œå½“æˆ‘ä»¬ç”¨deleteå»åˆ é™¤pbase2æ—¶ä¼šæŠ¥å¼‚å¸¸ï¼Œå…¶åŸå› åœ¨äºç›´æ¥deleteè°ƒæ•´åçš„thisæŒ‡é’ˆæ— æ³•å°†newå‡ºæ¥çš„derivedç±»å¯¹è±¡å®Œæ•´åˆ é™¤ã€‚é™¤éæˆ‘ä»¬å°†è¯¥thisæŒ‡é’ˆç»§ç»­è°ƒæ•´åˆ°derivedç±»å¯¹è±¡çš„å¼€å¤´ï¼Œæˆ–è€…åœ¨çˆ¶ç±»å’ŒåŸºç±»ä¸­æ·»åŠ virtualææ„å‡½æ•°ã€‚ä¸‹ä¸€å°èŠ‚å’±ä»¬ç»§ç»­æ·±å…¥æ¢è®¨å¤šé‡ç»§æ‰¿ä¸‹virtualææ„å‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠè™šè¡¨å¯¹åº”çš„å˜åŒ–ï¼</p></blockquote><hr /><h1id="å¤šé‡ç»§æ‰¿ä¸‹virtualææ„å‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠè™šè¡¨çš„å˜åŒ–">å¤šé‡ç»§æ‰¿ä¸‹virtualææ„å‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠè™šè¡¨çš„å˜åŒ–</h1><blockquote><p>ç»§ä¸Šä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“å¤šé‡ç»§æ‰¿ä¸‹æ•°æ®æˆå‘˜çš„åˆ†å¸ƒï¼Œä¸ºäº†æ›´å¥½çš„è§£å†³deletethisæŒ‡é’ˆåç§»åçš„çˆ¶ç±»æŒ‡é’ˆï¼Œæˆ‘ä»¬å¿…é¡»åœ¨çˆ¶ç±»å’ŒåŸºç±»ä¸­æ·»åŠ virtualææ„å‡½æ•°ã€‚è¿™æ ·ç¼–è¯‘å™¨å°±ä¼šä¸ºè™šè¡¨å¤šåŠ å‡ ä¸ªæ§½ï¼Œç›®çš„åœ¨äºå¸®åŠ©thisæŒ‡é’ˆåç§»åçš„çˆ¶ç±»æŒ‡é’ˆå›è°ƒåˆ°derivedç±»å¯¹è±¡çš„å¼€å¤´ï¼Œè¿›è€Œå®Œæˆdeleteã€‚ç¤ºä¾‹ä»£ç å’Œä¸Šä¸€å°èŠ‚å·®ä¸å¤šï¼Œå¦‚ä¸‹ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//åŸºç±»1</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base1</span>():<span class="hljs-built_in">b1</span>(<span class="hljs-number">1</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base1</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> b1;<br>&#125;;<br><span class="hljs-comment">//åŸºç±»2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base2</span>():<span class="hljs-built_in">b2</span>(<span class="hljs-number">2</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base2</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> b2;<br>&#125;;<br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Derived</span>():<span class="hljs-built_in">m</span>(<span class="hljs-number">3</span>),<span class="hljs-built_in">n</span>(<span class="hljs-number">4</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»1çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Derived</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> m;<br>    <span class="hljs-type">int</span> n;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    Derived *new_pderived = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    <span class="hljs-comment">//æ‰“å°ç¬¬ä¸€å¼ è™šè¡¨</span><br>    <span class="hljs-type">long</span>* pderived_cast1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(new_pderived);<span class="hljs-comment">//é‡æ–°è§£é‡Šç±»å¯¹è±¡,è·å¾—è™šè¡¨æŒ‡é’ˆçš„åœ°å€ã€‚</span><br>    <span class="hljs-type">long</span>* pderived_vptr1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*pderived_cast1);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pderived_vptr1[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,pderived_vptr1[i]);<br>    &#125;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-comment">//æ‰“å°ç¬¬äºŒå¼ è™šè¡¨</span><br>    <span class="hljs-type">long</span>* pderived_cast2 = pderived_cast1 + <span class="hljs-number">2</span>;<span class="hljs-comment">//åç§»åˆ°ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆçš„åœ°å€ä¸Š</span><br>    <span class="hljs-type">long</span>* pderived_vptr2 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*pderived_cast2);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pderived_vptr2[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,pderived_vptr2[i]);<br>    &#125;<br>    <span class="hljs-keyword">delete</span> new_pderived;<br><br>    Base2 *new_pbase2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    <span class="hljs-keyword">delete</span> new_pbase2;<br>&#125;<br></code></pre></td></tr></table></figure>å…¶å¯¹åº”çš„åæ±‡ç¼–ä»£ç å¦‚ä¸‹(æˆ‘å°†æœ‰ç”¨çš„éƒ¨åˆ†è´´åœ¨ä¸‹é¢)ï¼š <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs apache">    <span class="hljs-attribute">Base2</span> *new_pbase2 = new Derived();<br>  <span class="hljs-attribute">40136e</span>:e8 <span class="hljs-number">0</span>d fd ff ff       callq  <span class="hljs-number">401080</span> &lt;operator new(unsigned long)@plt&gt;<br>  <span class="hljs-attribute">401373</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             mov    %rax,%rcx<br>  <span class="hljs-attribute">401376</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c2             mov    %rax,%rdx<br>  <span class="hljs-attribute">401379</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br>  <span class="hljs-attribute">40137c</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d <span class="hljs-number">88</span>          mov    %rcx,-<span class="hljs-number">0</span>x78(%rbp)<br>  <span class="hljs-attribute">401380</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">55</span> <span class="hljs-number">80</span>          mov    %rdx,-<span class="hljs-number">0</span>x80(%rbp)<br>  <span class="hljs-attribute">401384</span>:e8 <span class="hljs-number">87</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">401410</span> &lt;Derived::Derived()&gt;<br>  <span class="hljs-attribute">401389</span>:e9 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       jmpq   <span class="hljs-number">40138</span>e &lt;main+<span class="hljs-number">0</span>x16e&gt;<br>  <span class="hljs-attribute">40138e</span>:<span class="hljs-number">31</span> c0                xor    %eax,%eax<br>  <span class="hljs-attribute">401390</span>:<span class="hljs-number">89</span> c1                mov    %eax,%ecx<br>  <span class="hljs-attribute">401392</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">55</span> <span class="hljs-number">80</span>          mov    -<span class="hljs-number">0</span>x80(%rbp),%rdx<br>  <span class="hljs-attribute">401396</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> fa <span class="hljs-number">00</span>          cmp    $<span class="hljs-number">0</span>x0,%rdx<br>  <span class="hljs-attribute">40139a</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">8</span>d <span class="hljs-number">78</span> ff ff ff mov    %rcx,-<span class="hljs-number">0</span>x88(%rbp)<br>  <span class="hljs-attribute">4013a1</span>:<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">11</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    je     <span class="hljs-number">4013</span>b8 &lt;main+<span class="hljs-number">0</span>x198&gt;<br>  <span class="hljs-attribute">4013a7</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">80</span>          mov    -<span class="hljs-number">0</span>x80(%rbp),%rax<br>  <span class="hljs-attribute">4013ab</span>:<span class="hljs-number">48</span> <span class="hljs-number">05</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    add    $<span class="hljs-number">0</span>x10,%rax<br>  <span class="hljs-attribute">4013b1</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">85</span> <span class="hljs-number">78</span> ff ff ff mov    %rax,-<span class="hljs-number">0</span>x88(%rbp)<br>  <span class="hljs-attribute">4013b8</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">85</span> <span class="hljs-number">78</span> ff ff ff mov    -<span class="hljs-number">0</span>x88(%rbp),%rax<br>  <span class="hljs-attribute">4013bf</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> a8          mov    %rax,-<span class="hljs-number">0</span>x58(%rbp)<br>    <span class="hljs-attribute">delete</span> new_pbase2;<br>  <span class="hljs-attribute">4013c3</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> a8          mov    -<span class="hljs-number">0</span>x58(%rbp),%rax<br>  <span class="hljs-attribute">4013c7</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> f8 <span class="hljs-number">00</span>          cmp    $<span class="hljs-number">0</span>x0,%rax<br>  <span class="hljs-attribute">4013cb</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">85</span> <span class="hljs-number">70</span> ff ff ff mov    %rax,-<span class="hljs-number">0</span>x90(%rbp)<br>  <span class="hljs-attribute">4013d2</span>:<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    je     <span class="hljs-number">4013</span>e8 &lt;main+<span class="hljs-number">0</span>x1c8&gt;<br>  <span class="hljs-attribute">4013d8</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">85</span> <span class="hljs-number">70</span> ff ff ff mov    -<span class="hljs-number">0</span>x90(%rbp),%rax<br>  <span class="hljs-attribute">4013df</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br>  <span class="hljs-attribute">4013e2</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br>  <span class="hljs-attribute">4013e5</span>:ff <span class="hljs-number">51</span> <span class="hljs-number">10</span>             callq  *<span class="hljs-number">0</span>x10(%rcx)<br>  <span class="hljs-attribute">4013e8</span>:<span class="hljs-number">8</span>b <span class="hljs-number">45</span> fc             mov    -<span class="hljs-number">0</span>x4(%rbp),%eax<br>  <span class="hljs-attribute">4013eb</span>:<span class="hljs-number">48</span> <span class="hljs-number">81</span> c4 <span class="hljs-number">90</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> add    $<span class="hljs-number">0</span>x90,%rsp<br>  <span class="hljs-attribute">4013f2</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br>  <span class="hljs-attribute">4013f3</span>:c3                   retq  <br><br><span class="hljs-attribute">0000000000401540</span> &lt;Derived::~Derived()&gt;:<br>    <span class="hljs-attribute">virtual</span> ~Derived() &#123;&#125;<br>  <span class="hljs-attribute">401540</span>:<span class="hljs-number">55</span>                   push   %rbp<br>  <span class="hljs-attribute">401541</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             mov    %rsp,%rbp<br>  <span class="hljs-attribute">401544</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> ec <span class="hljs-number">10</span>          sub    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">401548</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">40154c</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">401550</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             mov    %rax,%rcx<br>  <span class="hljs-attribute">401553</span>:<span class="hljs-number">48</span> <span class="hljs-number">81</span> c1 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> add    $<span class="hljs-number">0</span>x10,%rcx<br>  <span class="hljs-attribute">40155a</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             mov    %rcx,%rdi<br>  <span class="hljs-attribute">40155d</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <span class="hljs-attribute">401561</span>:e8 aa <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">401710</span> &lt;Base2::~Base2()&gt;<br>  <span class="hljs-attribute">401566</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f0          mov    -<span class="hljs-number">0</span>x10(%rbp),%rax<br>  <span class="hljs-attribute">40156a</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br>  <span class="hljs-attribute">40156d</span>:e8 <span class="hljs-number">1</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">401690</span> &lt;Base1::~Base1()&gt;<br>  <span class="hljs-attribute">401572</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> c4 <span class="hljs-number">10</span>          add    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">401576</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br>  <span class="hljs-attribute">401577</span>:c3                   retq   <br>  <span class="hljs-attribute">401578</span>:<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">84</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> nopl   <span class="hljs-number">0</span>x0(%rax,%rax,<span class="hljs-number">1</span>)<br>  <span class="hljs-attribute">40157f</span>:<span class="hljs-number">00</span> <br><br><span class="hljs-attribute">0000000000401580</span> &lt;Derived::~Derived()&gt;:<br>  <span class="hljs-attribute">401580</span>:<span class="hljs-number">55</span>                   push   %rbp<br>  <span class="hljs-attribute">401581</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             mov    %rsp,%rbp<br>  <span class="hljs-attribute">401584</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> ec <span class="hljs-number">10</span>          sub    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">401588</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">40158c</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">401590</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br>  <span class="hljs-attribute">401593</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <span class="hljs-attribute">401597</span>:e8 a4 ff ff ff       callq  <span class="hljs-number">401540</span> &lt;Derived::~Derived()&gt;<br>  <span class="hljs-attribute">40159c</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f0          mov    -<span class="hljs-number">0</span>x10(%rbp),%rax<br>  <span class="hljs-attribute">4015a0</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br>  <span class="hljs-attribute">4015a3</span>:e8 b8 fa ff ff       callq  <span class="hljs-number">401060</span> &lt;operator delete(void*)@plt&gt;<br>  <span class="hljs-attribute">4015a8</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> c4 <span class="hljs-number">10</span>          add    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">4015ac</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br>  <span class="hljs-attribute">4015ad</span>:c3                   retq   <br>  <span class="hljs-attribute">4015ae</span>:<span class="hljs-number">66</span> <span class="hljs-number">90</span>                xchg   %ax,%ax<br><br><span class="hljs-attribute">0000000000401610</span> &lt;non-virtual thunk to Derived::~Derived()&gt;:<br>  <span class="hljs-attribute">401610</span>:<span class="hljs-number">55</span>                   push   %rbp<br>  <span class="hljs-attribute">401611</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             mov    %rsp,%rbp<br>  <span class="hljs-attribute">401614</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">401618</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">40161c</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> c0 f0          add    $<span class="hljs-number">0</span>xfffffffffffffff0,%rax<br>  <span class="hljs-attribute">401620</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br>  <span class="hljs-attribute">401623</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br>  <span class="hljs-attribute">401624</span>:e9 <span class="hljs-number">17</span> ff ff ff       jmpq   <span class="hljs-number">401540</span> &lt;Derived::~Derived()&gt;<br>  <span class="hljs-attribute">401629</span>:<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> nopl   <span class="hljs-number">0</span>x0(%rax)<br><br><span class="hljs-attribute">0000000000401630</span> &lt;non-virtual thunk to Derived::~Derived()&gt;:<br>  <span class="hljs-attribute">401630</span>:<span class="hljs-number">55</span>                   push   %rbp<br>  <span class="hljs-attribute">401631</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             mov    %rsp,%rbp<br>  <span class="hljs-attribute">401634</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">401638</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">40163c</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> c0 f0          add    $<span class="hljs-number">0</span>xfffffffffffffff0,%rax<br>  <span class="hljs-attribute">401640</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br>  <span class="hljs-attribute">401643</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br>  <span class="hljs-attribute">401644</span>:e9 <span class="hljs-number">37</span> ff ff ff       jmpq   <span class="hljs-number">401580</span> &lt;Derived::~Derived()&gt;<br>  <span class="hljs-attribute">401649</span>:<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> nopl   <span class="hljs-number">0</span>x0(%rax)<br></code></pre></td></tr></table></figure>å› ä¸ºvirtualææ„å‡½æ•°çš„åŠ å…¥ï¼Œæˆ‘å°†æ‰“å°çš„æ­¥éª¤ç®€åŒ–äº†ï¼Œå¦åˆ™æ˜¾ç¤ºä¼šæ··ä¹±ã€‚è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<img src="/img/00006/13.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />è¿™ç§æƒ…å†µä¸‹GDBæ‰“å°å‡ºæ¥çš„è™šè¡¨å†…å®¹æœ‰é”™è¯¯ï¼Œæˆ–è€…æ˜¯å®ƒæ•…æ„éšç’ï¼Œå…¶åŸå› ä¸å¾—è€ŒçŸ¥ï¼Œæˆ‘å°†è¡¥å……åçš„ç»“æœè´´åœ¨è¿™é‡Œï¼š<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">&gt;gefâ¤  info vtbl *new_pderived<br>&gt;vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;Derived&#x27;</span> @ <span class="hljs-number">0</span>x4020b0 (subobject @ <span class="hljs-number">0</span>x416eb0):<br>&gt;<span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x401500 &lt;Derived::<span class="hljs-built_in">f</span>()&gt;<br>&gt;<span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x401540 &lt;Derived::~<span class="hljs-built_in">Derived</span>()&gt;<br>&gt;<span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x401580 &lt;Derived::~<span class="hljs-built_in">Derived</span>()&gt;<br>&gt;<span class="hljs-selector-attr">[3]</span>: <span class="hljs-number">0</span>x4015b0 &lt;Derived::<span class="hljs-built_in">h</span>()&gt;<br>&gt;vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;Base2&#x27;</span> @ <span class="hljs-number">0</span>x4020e0 (subobject @ <span class="hljs-number">0</span>x416ec0):<br>&gt;<span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x4015f0 &lt;non-virtual thunk to Derived::<span class="hljs-built_in">h</span>()&gt;<br>&gt;<span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x401610 &lt;non-virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……ä¸Šçš„</span><br>&gt;<span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x401630 &lt;non-virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……ä¸Šçš„</span><br></code></pre></td></tr></table></figure>æˆ‘ä»¬é‡ç‚¹å…³æ³¨æœ€åä¸¤è¡Œï¼š<code>Base2 *new_pbase2 = new Derived();delete new_pbase2;</code>çœ‹ç¼–è¯‘å¦‚ä½•å®ŒæˆthisæŒ‡é’ˆçš„å›è°ƒï¼š<img src="/img/00006/14.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />åæ±‡ç¼–ä»£ç è¿è¡Œåˆ°<code>0x4013c3 &lt;main+419&gt;       mov    rax, QWORD PTR [rbp-0x58]</code>ä¹‹å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šDerivedç±»å¯¹è±¡åœ¨<code>0x416eb0</code>å †å†…å­˜åœ°å€ä¸Šè¿›è¡Œæ„é€ ï¼Œ<code>0x416eb0+0x10</code>åçš„å †æŒ‡é’ˆï¼ˆBase2ç±»å¯¹è±¡çš„thisæŒ‡é’ˆï¼‰å­˜å‚¨åœ¨<code>$rbp-0x58</code>ï¼ˆ0x7fffffffe0d8ï¼‰æ ˆå†…å­˜ä¸­ã€‚è¿™ä¸€è¿‡ç¨‹çš„ç»“æœæˆ‘ç”¨ä¸€å¼ å›¾è¿›è¡Œè¡¨è¾¾ï¼š<img src="/img/00006/15.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" /></p></blockquote><blockquote><p><img src="/img/00006/16.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />è¯¥å›¾åœ¨<code>0x4013e5 &lt;main+453&gt;       call   QWORD PTR [rcx+0x10]</code>è¿˜æœªæ‰§è¡Œæ—¶å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šç¼–è¯‘å™¨å°†Base2ç±»å¯¹è±¡çš„thisæŒ‡é’ˆå­˜å‚¨åœ¨<code>rdi</code>å‚æ•°å¯„å­˜å™¨ä¸­ï¼Œä½œä¸º<code>&lt;non-virtual thunk to Derived::~Derived()&gt;</code>å‡½æ•°ï¼ˆ<code>rcx+0x10</code>ï¼‰çš„ç¬¬ä¸€å‚æ•°ã€‚è¯¥å‡½æ•°æŒ‡é’ˆæŒ‡å‘æ–‡æœ¬æ®µ<code>0x401630</code>å¤„ã€‚<img src="/img/00006/17.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />åæ±‡ç¼–ä»£ç è¿è¡Œåˆ°<code>0x401644 &lt;non-virtual+0&gt;  jmp    0x401580 &lt;Derived::~Derived()&gt;</code>ä¹‹å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šrdiå‚æ•°å¯„å­˜å™¨å°†å…¶å€¼ä¿å­˜åˆ°<code>rax</code>ä¸´æ—¶å¯„å­˜å™¨ä¸­ï¼Œ<code>rax</code>å°†è¯¥å€¼ï¼ˆ<code>0x416ec0</code>ï¼‰åŠ ä¸Š<code>0xfffffffffffffff0</code>ï¼Œç”±äºæº¢å‡ºï¼Œç›¸å½“äº<code>-0x10</code>ï¼Œå¾—åˆ°çš„æ–°å€¼ï¼ˆ<code>0x416eb0</code>ï¼‰å­˜å‚¨åˆ°<code>rax</code>å¯„å­˜å™¨ä¸­ã€‚éšåè°ƒç”¨å¸¦<code>operator delete(void*)</code>çš„virtualææ„å‡½æ•°ã€‚è‡³æ­¤å®ŒæˆthisæŒ‡é’ˆå›è°ƒï¼Œdeleteå¯ä»¥æ­£å¸¸é”€æ¯æ‰newå‡ºæ¥Derivedç±»å¯¹è±¡ã€‚</p></blockquote><hr /><h1id="å¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†ä»¥åŠå­ç±»æˆå‘˜å¸ƒå±€">å¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå­ç±»æˆå‘˜å¸ƒå±€</h1><blockquote><p>åœ¨åˆ†æä¹‹å‰ï¼Œå’±ä»¬å…ˆå›é¡¾ä¸€ä¸‹ã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p120æå‡ºæ¥çš„ä¸€ä¸ªé—®é¢˜ï¼šæ¯ä¸€ä¸ªå¯¹è±¡å¿…é¡»é’ˆå¯¹å…¶æ¯ä¸€ä¸ªvirtual baseclassèƒŒè´Ÿä¸€ä¸ªé¢å¤–çš„æŒ‡é’ˆï¼Œç„¶è€Œç†æƒ³ä¸Šæˆ‘ä»¬å´å¸Œæœ›classobjectæœ‰å›ºå®šçš„è´Ÿæ‹…ï¼Œä¸å› ä¸ºå…¶virtual baseclassesçš„ä¸ªæ•°è€Œæœ‰æ‰€å˜åŒ–ã€‚æƒ³æƒ³çœ‹è¿™è¯¥å¦‚ä½•è§£å†³ï¼Ÿ -ä¸€èˆ¬è€Œè¨€æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ã€‚Microsoft ç¼–è¯‘å™¨å¼•å…¥æ‰€è°“çš„virtual base classtableã€‚æ¯ä¸€ä¸ªclass objectå¦‚æœæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªvirtual baseclassesï¼Œå°±ä¼šç”±ç¼–è¯‘å™¨å®‰æ’ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘virtual base classtableã€‚è‡³äºçœŸæ­£çš„virtual base classæŒ‡é’ˆï¼Œå½“ç„¶æ˜¯è¢«æ”¾åœ¨è¯¥è¡¨æ ¼ä¸­ã€‚ -ç¬¬äºŒä¸ªè§£å†³æ–¹æ³•ï¼Œæ˜¯åœ¨virtual function table ä¸­æ”¾ç½®virtual base class çš„offsetï¼ˆè€Œä¸æ˜¯ç¬¬ä¸€ç§åŠæ³•ä¸­è¯´çš„virtual baseclassæŒ‡é’ˆï¼‰ã€‚ç¼–è¯‘å™¨å¯ä»¥é€šè¿‡virtual functiontableçš„æ­£è´Ÿå€¼æ¥ç´¢å¼•è¯¥offsetã€‚å¦‚æœæ˜¯æ­£å€¼ï¼Œæ˜¾ç„¶ç´¢å¼•åˆ°çš„æ˜¯virtualfunctionï¼›å¦‚æœæ˜¯è´Ÿå€¼ï¼Œåˆ™æ˜¯ç´¢å¼•åˆ°virtual base class offsetsã€‚</p><p>æ­£å¦‚ä¸Šé¢ç¬¬äºŒç§æ–¹æ³•æ‰€è¿°ï¼Œclangç¼–è¯‘å™¨é‡‡å–çš„å°±æ˜¯åŸºäºvtblçš„offsetæ¥è·å–è™šåŸºç±»çš„thisæŒ‡é’ˆï¼Œè¿›è€Œå®Œæˆè™šåŸºç±»æ•°æ®æˆå‘˜çš„è®¿é—®ã€‚å’±ä»¬æ¥çœ‹å…·ä½“åˆ†æè¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š å…ˆè®¾è®¡ä¸€ä¸ªè±å½¢ç»§æ‰¿çš„Derivedç±»ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//çˆ·çˆ·ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">grandpa</span><span class="hljs-comment">//ç±»åé¦–å­—æ¯å¿˜è®°å¤§å†™äº†ï¼ŒæŠ±æ­‰</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">grandpa</span>():<span class="hljs-built_in">pa</span>(<span class="hljs-number">1</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;grandpa::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;grandpa::g()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">grandpa</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> pa;<br>&#125;;<br><span class="hljs-comment">//çˆ¶ç±»1</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span>:<span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> grandpa<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base1</span>():<span class="hljs-built_in">b1</span>(<span class="hljs-number">2</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">i</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::i()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base1</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> b1;<br>&#125;;<br><span class="hljs-comment">//çˆ¶ç±»2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span>:<span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> grandpa<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base2</span>():<span class="hljs-built_in">b2</span>(<span class="hljs-number">3</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">j</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::j()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">k</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::k()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base2</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> b2;<br>&#125;;<br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Derived</span>():<span class="hljs-built_in">m</span>(<span class="hljs-number">4</span>),<span class="hljs-built_in">n</span>(<span class="hljs-number">5</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ·çˆ·ç±»çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»1çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">j</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»2çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::j()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">l</span><span class="hljs-params">()</span><span class="hljs-comment">//derivedç±»è‡ªå·±çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::l()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Derived</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> m;<br>    <span class="hljs-type">int</span> n;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    Derived *new_pderived = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    new_pderived-&gt;pa = <span class="hljs-number">11</span>;<br>    <span class="hljs-keyword">delete</span> new_pderived;<br><br>    Base1 *new_pbase1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    new_pbase1-&gt;pa = <span class="hljs-number">11</span>;<br>    <span class="hljs-keyword">delete</span> new_pbase1;<br><br>    Base2 *new_pbase2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    new_pbase2-&gt;pa = <span class="hljs-number">11</span>;<br>    <span class="hljs-keyword">delete</span> new_pbase2;<br>&#125;<br></code></pre></td></tr></table></figure> éœ€è¦ç”¨åˆ°çš„åæ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š <figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs apache">  <span class="hljs-attribute">Derived</span> *new_pderived = new Derived();<br><span class="hljs-attribute">401227</span>:e8 <span class="hljs-number">44</span> fe ff ff       callq  <span class="hljs-number">401070</span> &lt;operator new(unsigned long)@plt&gt;<br><span class="hljs-attribute">40122c</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             mov    %rax,%rcx<br><span class="hljs-attribute">40122f</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c2             mov    %rax,%rdx<br><span class="hljs-attribute">401232</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">401235</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d c8          mov    %rcx,-<span class="hljs-number">0</span>x38(%rbp)<br><span class="hljs-attribute">401239</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">55</span> c0          mov    %rdx,-<span class="hljs-number">0</span>x40(%rbp)<br><span class="hljs-attribute">40123d</span>:e8 <span class="hljs-number">7</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">4013</span>c0 &lt;Derived::Derived()&gt;<br><span class="hljs-attribute">401242</span>:e9 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       jmpq   <span class="hljs-number">401247</span> &lt;main+<span class="hljs-number">0</span>x37&gt;<br><span class="hljs-attribute">401247</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> c0          mov    -<span class="hljs-number">0</span>x40(%rbp),%rax<br><span class="hljs-attribute">40124b</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <span class="hljs-attribute">new_pderived</span>-&gt;pa = <span class="hljs-number">11</span>;<br><span class="hljs-attribute">40124f</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d f0          mov    -<span class="hljs-number">0</span>x10(%rbp),%rcx<br><span class="hljs-attribute">401253</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">11</span>             mov    (%rcx),%rdx<br><span class="hljs-attribute">401256</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">52</span> e8          mov    -<span class="hljs-number">0</span>x18(%rdx),%rdx<br><span class="hljs-attribute">40125a</span>:c7 <span class="hljs-number">44</span> <span class="hljs-number">11</span> <span class="hljs-number">08</span> <span class="hljs-number">0</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> movl   $<span class="hljs-number">0</span>xb,<span class="hljs-number">0</span>x8(%rcx,%rdx,<span class="hljs-number">1</span>)<br><span class="hljs-attribute">401261</span>:<span class="hljs-number">00</span> <br>  <span class="hljs-attribute">delete</span> new_pderived;<br><span class="hljs-attribute">401262</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d f0          mov    -<span class="hljs-number">0</span>x10(%rbp),%rcx<br><span class="hljs-attribute">401266</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> f9 <span class="hljs-number">00</span>          cmp    $<span class="hljs-number">0</span>x0,%rcx<br><span class="hljs-attribute">40126a</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d b8          mov    %rcx,-<span class="hljs-number">0</span>x48(%rbp)<br><span class="hljs-attribute">40126e</span>:<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    je     <span class="hljs-number">401281</span> &lt;main+<span class="hljs-number">0</span>x71&gt;<br><span class="hljs-attribute">401274</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> b8          mov    -<span class="hljs-number">0</span>x48(%rbp),%rax<br><span class="hljs-attribute">401278</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">40127b</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">40127e</span>:ff <span class="hljs-number">51</span> <span class="hljs-number">18</span>             callq  *<span class="hljs-number">0</span>x18(%rcx)<br><span class="hljs-attribute">401281</span>:bf <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       mov    $<span class="hljs-number">0</span>x38,%edi<br><br>  <span class="hljs-attribute">Base1</span> *new_pbase1 = new Derived();<br><span class="hljs-attribute">401286</span>:e8 e5 fd ff ff       callq  <span class="hljs-number">401070</span> &lt;operator new(unsigned long)@plt&gt;<br><span class="hljs-attribute">40128b</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             mov    %rax,%rcx<br><span class="hljs-attribute">40128e</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c2             mov    %rax,%rdx<br><span class="hljs-attribute">401291</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">401294</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d b0          mov    %rcx,-<span class="hljs-number">0</span>x50(%rbp)<br><span class="hljs-attribute">401298</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">55</span> a8          mov    %rdx,-<span class="hljs-number">0</span>x58(%rbp)<br><span class="hljs-attribute">40129c</span>:e8 <span class="hljs-number">1</span>f <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">4013</span>c0 &lt;Derived::Derived()&gt;<br><span class="hljs-attribute">4012a1</span>:e9 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       jmpq   <span class="hljs-number">4012</span>a6 &lt;main+<span class="hljs-number">0</span>x96&gt;<br><span class="hljs-attribute">4012a6</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> a8          mov    -<span class="hljs-number">0</span>x58(%rbp),%rax<br><span class="hljs-attribute">4012aa</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> d8          mov    %rax,-<span class="hljs-number">0</span>x28(%rbp)<br>  <span class="hljs-attribute">new_pbase1</span>-&gt;pa = <span class="hljs-number">11</span>;<br><span class="hljs-attribute">4012ae</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d8          mov    -<span class="hljs-number">0</span>x28(%rbp),%rax<br><span class="hljs-attribute">4012b2</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">4012b5</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">49</span> e8          mov    -<span class="hljs-number">0</span>x18(%rcx),%rcx<br><span class="hljs-attribute">4012b9</span>:c7 <span class="hljs-number">44</span> <span class="hljs-number">08</span> <span class="hljs-number">08</span> <span class="hljs-number">0</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> movl   $<span class="hljs-number">0</span>xb,<span class="hljs-number">0</span>x8(%rax,%rcx,<span class="hljs-number">1</span>)<br><span class="hljs-attribute">4012c0</span>:<span class="hljs-number">00</span> <br>  <span class="hljs-attribute">delete</span> new_pbase1;<br><span class="hljs-attribute">4012c1</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d8          mov    -<span class="hljs-number">0</span>x28(%rbp),%rax<br><span class="hljs-attribute">4012c5</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> f8 <span class="hljs-number">00</span>          cmp    $<span class="hljs-number">0</span>x0,%rax<br><span class="hljs-attribute">4012c9</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> a0          mov    %rax,-<span class="hljs-number">0</span>x60(%rbp)<br><span class="hljs-attribute">4012cd</span>:<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    je     <span class="hljs-number">4012</span>e0 &lt;main+<span class="hljs-number">0</span>xd0&gt;<br><span class="hljs-attribute">4012d3</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> a0          mov    -<span class="hljs-number">0</span>x60(%rbp),%rax<br><span class="hljs-attribute">4012d7</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">4012da</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">4012dd</span>:ff <span class="hljs-number">51</span> <span class="hljs-number">18</span>             callq  *<span class="hljs-number">0</span>x18(%rcx)<br><span class="hljs-attribute">4012e0</span>:bf <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       mov    $<span class="hljs-number">0</span>x38,%edi<br><br>  <span class="hljs-attribute">Base2</span> *new_pbase2 = new Derived();<br><span class="hljs-attribute">4012e5</span>:e8 <span class="hljs-number">86</span> fd ff ff       callq  <span class="hljs-number">401070</span> &lt;operator new(unsigned long)@plt&gt;<br><span class="hljs-attribute">4012ea</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             mov    %rax,%rcx<br><span class="hljs-attribute">4012ed</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c2             mov    %rax,%rdx<br><span class="hljs-attribute">4012f0</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">4012f3</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d <span class="hljs-number">98</span>          mov    %rcx,-<span class="hljs-number">0</span>x68(%rbp)<br><span class="hljs-attribute">4012f7</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">55</span> <span class="hljs-number">90</span>          mov    %rdx,-<span class="hljs-number">0</span>x70(%rbp)<br><span class="hljs-attribute">4012fb</span>:e8 c0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       callq  <span class="hljs-number">4013</span>c0 &lt;Derived::Derived()&gt;<br><span class="hljs-attribute">401300</span>:e9 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       jmpq   <span class="hljs-number">401305</span> &lt;main+<span class="hljs-number">0</span>xf5&gt;<br><span class="hljs-attribute">401305</span>:<span class="hljs-number">31</span> c0                xor    %eax,%eax<br><span class="hljs-attribute">401307</span>:<span class="hljs-number">89</span> c1                mov    %eax,%ecx<br><span class="hljs-attribute">401309</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">55</span> <span class="hljs-number">90</span>          mov    -<span class="hljs-number">0</span>x70(%rbp),%rdx<br><span class="hljs-attribute">40130d</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> fa <span class="hljs-number">00</span>          cmp    $<span class="hljs-number">0</span>x0,%rdx<br><span class="hljs-attribute">401311</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d <span class="hljs-number">88</span>          mov    %rcx,-<span class="hljs-number">0</span>x78(%rbp)<br><span class="hljs-attribute">401315</span>:<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">0</span>e <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    je     <span class="hljs-number">401329</span> &lt;main+<span class="hljs-number">0</span>x119&gt;<br><span class="hljs-attribute">40131b</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">90</span>          mov    -<span class="hljs-number">0</span>x70(%rbp),%rax<br><span class="hljs-attribute">40131f</span>:<span class="hljs-number">48</span> <span class="hljs-number">05</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    add    $<span class="hljs-number">0</span>x10,%rax<br><span class="hljs-attribute">401325</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> <span class="hljs-number">88</span>          mov    %rax,-<span class="hljs-number">0</span>x78(%rbp)<br><span class="hljs-attribute">401329</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">88</span>          mov    -<span class="hljs-number">0</span>x78(%rbp),%rax<br><span class="hljs-attribute">40132d</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> d0          mov    %rax,-<span class="hljs-number">0</span>x30(%rbp)<br>  <span class="hljs-attribute">new_pbase2</span>-&gt;pa = <span class="hljs-number">11</span>;<br><span class="hljs-attribute">401331</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">401335</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">401338</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">49</span> e8          mov    -<span class="hljs-number">0</span>x18(%rcx),%rcx<br><span class="hljs-attribute">40133c</span>:c7 <span class="hljs-number">44</span> <span class="hljs-number">08</span> <span class="hljs-number">08</span> <span class="hljs-number">0</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> movl   $<span class="hljs-number">0</span>xb,<span class="hljs-number">0</span>x8(%rax,%rcx,<span class="hljs-number">1</span>)<br><span class="hljs-attribute">401343</span>:<span class="hljs-number">00</span> <br>  <span class="hljs-attribute">delete</span> new_pbase2;<br><span class="hljs-attribute">401344</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">401348</span>:<span class="hljs-number">48</span> <span class="hljs-number">83</span> f8 <span class="hljs-number">00</span>          cmp    $<span class="hljs-number">0</span>x0,%rax<br><span class="hljs-attribute">40134c</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> <span class="hljs-number">80</span>          mov    %rax,-<span class="hljs-number">0</span>x80(%rbp)<br><span class="hljs-attribute">401350</span>:<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    je     <span class="hljs-number">401363</span> &lt;main+<span class="hljs-number">0</span>x153&gt;<br><span class="hljs-attribute">401356</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">80</span>          mov    -<span class="hljs-number">0</span>x80(%rbp),%rax<br><span class="hljs-attribute">40135a</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             mov    (%rax),%rcx<br><span class="hljs-attribute">40135d</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             mov    %rax,%rdi<br><span class="hljs-attribute">401360</span>:ff <span class="hljs-number">51</span> <span class="hljs-number">18</span>             callq  *<span class="hljs-number">0</span>x18(%rcx)<br><span class="hljs-attribute">401363</span>:<span class="hljs-number">8</span>b <span class="hljs-number">45</span> fc             mov    -<span class="hljs-number">0</span>x4(%rbp),%eax<br><span class="hljs-attribute">401366</span>:<span class="hljs-number">48</span> <span class="hljs-number">81</span> c4 <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> add    $<span class="hljs-number">0</span>x80,%rsp<br><span class="hljs-attribute">40136d</span>:<span class="hljs-number">5</span>d                   pop    %rbp<br><span class="hljs-attribute">40136e</span>:c3                   retq   <br><span class="hljs-attribute">40136f</span>:<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> e8          mov    %rax,-<span class="hljs-number">0</span>x18(%rbp)<br><span class="hljs-attribute">401373</span>:<span class="hljs-number">89</span> <span class="hljs-number">55</span> e4             mov    %edx,-<span class="hljs-number">0</span>x1c(%rbp)<br><span class="hljs-attribute">401376</span>:<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">7</span>d c8          mov    -<span class="hljs-number">0</span>x38(%rbp),%rdi<br></code></pre></td></tr></table></figure>Derivedç±»çš„vtblå†…å®¹å¦‚ä¸‹(ç¼–è¯‘å™¨æ²¡æœ‰å®Œå…¨æ‰“å°å‡ºæ¥ï¼Œç¬”è€…å°†è¡¥å……åçš„åˆ—åœ¨ä¸‹é¢)ï¼š<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs stylus">gefâ¤  info vtbl *new_pderived<br>vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;Derived&#x27;</span> @ <span class="hljs-number">0</span>x402020 (subobject @ <span class="hljs-number">0</span>x416eb0):<br><span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x401850 &lt;Derived::<span class="hljs-built_in">h</span>()&gt;<br><span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x4015b0 &lt;Base1::<span class="hljs-selector-tag">i</span>()&gt;<br><span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x401890 &lt;Derived::~<span class="hljs-built_in">Derived</span>()&gt;<br><span class="hljs-selector-attr">[3]</span>: <span class="hljs-number">0</span>x4018d0 &lt;Derived::~<span class="hljs-built_in">Derived</span>()&gt;<br><span class="hljs-selector-attr">[4]</span>: <span class="hljs-number">0</span>x401900 &lt;Derived::<span class="hljs-built_in">f</span>()&gt;<br><span class="hljs-selector-attr">[5]</span>: <span class="hljs-number">0</span>x401940 &lt;Derived::<span class="hljs-built_in">j</span>()&gt;<br><span class="hljs-selector-attr">[6]</span>: <span class="hljs-number">0</span>x401980 &lt;Derived::<span class="hljs-built_in">l</span>()&gt;<br>vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;Base2&#x27;</span> @ <span class="hljs-number">0</span>x402070 (subobject @ <span class="hljs-number">0</span>x416ec0):<br><span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x4019c0 &lt;non-virtual thunk to Derived::<span class="hljs-built_in">j</span>()&gt;<br><span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x401760 &lt;Base2::<span class="hljs-built_in">k</span>()&gt;<br><span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x4019e0 &lt;non-virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……çš„</span><br><span class="hljs-selector-attr">[3]</span>: <span class="hljs-number">0</span>x401a00 &lt;non-virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……çš„</span><br>vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;grandpa&#x27;</span> @ <span class="hljs-number">0</span>x4020b8 (subobject @ <span class="hljs-number">0</span>x416ed8):<br><span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x401a20 &lt;virtual thunk to Derived::<span class="hljs-built_in">f</span>()&gt;<br><span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x4016a0 &lt;grandpa::<span class="hljs-built_in">g</span>()&gt;<br><span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x401a40 &lt;virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……çš„</span><br><span class="hljs-selector-attr">[3]</span>: <span class="hljs-number">0</span>x401a60 &lt;virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……çš„</span><br></code></pre></td></tr></table></figure>è‡³äºä¸ºä»€ä¹ˆBase2ç±»å’Œgrandpaç±»ä¼šå¤šå‡ºä¸¤ä¸ªthunkå‡½æ•°ï¼Œä¸Šä¸€å°èŠ‚å·²ç»åˆ†æè¿‡ã€‚è¿™é‡Œè¡¥å……ä¸€ç‚¹ï¼Œå› ä¸ºDerivedç±»å¯¹è±¡çš„æ•°æ®å¸ƒå±€æœ€ä¸Šé¢æ˜¯Base1ç±»å¯¹è±¡ï¼Œä¸­é—´æ˜¯Base2ç±»å¯¹è±¡ï¼Œvirtualgrandpaå¯¹è±¡æ°¸è¿œæ˜¯åœ¨æœ€ä¸‹é¢ã€‚è¿™æ ·å°±å¯¼è‡´Base2ç±»åœ¨æ”¯æŒå¤šæ€æ—¶è°ƒç”¨è¢«é‡å†™çš„è™šå‡½æ•°ä»¥åŠè°ƒç”¨Derivedç±»çš„virtualææ„å‡½æ•°æ—¶ï¼Œéœ€è¦è°ƒæ•´thisæŒ‡é’ˆã€‚grandpaç±»é“ç†ä¸€æ ·ã€‚å’±ä»¬ç”¨GDBæŸ¥çœ‹Derivedç±»å¯¹è±¡çš„å†…å­˜å¸ƒå±€ï¼Œå¹¶ç”¨å›¾ç”»æ–¹å¼ç›´è§‚è¡¨è¾¾å‡ºæ¥ï¼š <imgsrc="/img/00006/18.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /> <imgsrc="/img/00006/19.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />ä¸Šå›¾ä¸­ï¼Œç¬”è€…å°†offsetå‡ºç°çš„åœ°æ–¹æ˜ç¡®æ ‡æ˜å‡ºæ¥äº†ï¼Œä¸‹é¢å’±ä»¬å°±æ¥çœ‹ä¸‹ç¼–è¯‘æ˜¯å¦‚ä½•å–å‡ºè¿™ä¸ªoffsetsçš„ï¼<img src="/img/00006/20.png" alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" />åæ±‡ç¼–ä»£ç <code>0x401256 &lt;main+70&gt;        mov    rdx, QWORD PTR [rdx-0x18]</code>è¿˜æœªæ‰§è¡Œæ—¶ï¼Œå‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šDerivedç±»å¯¹è±¡åœ¨<code>0x416eb0</code>å †å†…å­˜ä¸­è¿›è¡Œäº†æ„é€ ã€‚new_pderivedæŒ‡é’ˆçš„åœ°å€ä¸º<code>rbp-0x10</code>ï¼Œå®ƒæŒ‡å‘<code>0x416eb0</code>å †å†…å­˜ã€‚ç¼–è¯‘å™¨å°†Derivedç±»<code>vptr1</code>æŒ‡å‘çš„è™šè¡¨åœ°å€å­˜å‚¨åˆ°<code>rdx</code>ä¸­ã€‚æ¥ä¸‹æ¥å°†ä¼šå‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šç¼–è¯‘å™¨å°†è¯¥è™šè¡¨åœ°å€åç§»<code>-0x18</code>å­—èŠ‚å¹¶è·å–è¯¥åœ°å€ä¸­çš„å†…å®¹ï¼ˆ<code>offset</code>ï¼‰ï¼Œå°†å…¶å€¼ï¼ˆ<code>0x28</code>ï¼‰å­˜å…¥<code>rdx</code>å¯„å­˜å™¨ä¸­ã€‚æœ€åå°†<code>åè¿›åˆ¶11</code>å­˜å…¥thisæŒ‡é’ˆåç§»åçš„åœ°å€ä¸­ï¼ˆ<code>rcx+rdx*1+0x8</code>ï¼š<code>0x416eb0+0x28*1+0x8 = 0x416ee0</code>ï¼Œå³<code>pa</code>çš„åœ°å€ï¼‰ã€‚<img src="/img/00006/21.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />ä»£ç æ®µ<code>new_pbase1-&gt;pa = 11;</code>å’Œ<code>new_pbase2-&gt;pa = 11;</code>åŒæ ·ä¼šå‡ºç°å–<code>offset</code>è¿›è¡Œåç§»åï¼Œç„¶åå­˜å–grandpaçš„æˆå‘˜å˜é‡paçš„æƒ…å†µã€‚<code>new_pbase1-&gt;pa</code>å–åˆ°çš„<code>offset</code>å€¼å’Œ<code>new_pderived-&gt;pa</code>ä¸€æ ·æ˜¯<code>0x28</code>ã€‚è€Œ<code>new_pbase2-&gt;pa</code>å–åˆ°çš„å€¼ä¸º<code>0x18</code>ã€‚<img src="/img/00006/22.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />å¦‚æœæ˜¯è™šåŸºç±»grandpaåœ¨æ”¯æŒå¤šæ€æ—¶ï¼Œä¸”<code>new_pgrandpa-&gt;pa</code>è¿›è¡Œå­˜å–æ“ä½œï¼Œåˆ™ä¸ç”¨åç§»thisæŒ‡é’ˆï¼Œä¹Ÿå°±ä¸éœ€è¦å–<code>offset</code>ã€‚è¯¥è™šåŸºç±»çš„è™šè¡¨ä¸­ä¹Ÿæ²¡æœ‰å­˜<code>offset</code>ã€‚<img src="/img/00006/23.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />å¯ä»¥çœ‹åˆ°<code>0x4020b8-0x18</code>åœ°å€ä¸Šçš„å€¼æ˜¯ä¸ªç‰›é©¬å€¼ ğŸ¤ª--------------------------------------------------------</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>C++</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>C++11,14,17ä¸­autoå’Œdecltypeç›¸å…³çŸ¥è¯†åŠæ‹“å±•</title>
    <link href="/2022/02/09/00005.%20C++11,14,17%E4%B8%ADauto%E5%92%8Cdecltype%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E5%8F%8A%E6%8B%93%E5%B1%95/"/>
    <url>/2022/02/09/00005.%20C++11,14,17%E4%B8%ADauto%E5%92%8Cdecltype%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E5%8F%8A%E6%8B%93%E5%B1%95/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><blockquote><p><strong>æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚</strong><br />è¿™ç¯‡æ–‡ç« æ˜¯ä¸Šç¯‡æ–‡ç« ã€Š<ahref="https://blog.csdn.net/Howl_1/article/details/122625409">C++prvalueï¼Œxvalueå’Œlvalueçš„ç›¸å…³çŸ¥è¯†</a>ã€‹çš„ç»­ä½œï¼Œä¸Šæ¬¡æˆ‘ä»¬å·²ç»æŠŠprvalueï¼Œxvalueå’Œlvalueè¯´æ¸…æ¥šäº†ï¼Œæœ¬ç¯‡æ–‡ç« å°±æ¥æ¢è®¨ä¸€ä¸‹prvalueï¼Œxvalueå’Œlvalueä¸decltypeä¹‹é—´çš„è”ç³»ã€‚é¡ºä¾¿å’±ä»¬ä¹ŸæŠŠautoç±»å‹è¯´æ˜ç¬¦ä¹Ÿéƒ½æ‹“å±•ä¸€ä¸‹ã€‚</p></blockquote><hr /><h1id="ä»åˆå§‹åŒ–å™¨å’Œè¡¨è¾¾å¼ä¸­æ¨å¯¼-deduction-from-initializers-and-expressions">ä»åˆå§‹åŒ–å™¨å’Œè¡¨è¾¾å¼ä¸­æ¨å¯¼ï¼ˆDeduction from Initializers and Expressionsï¼‰</h1><blockquote><p>C++11åŒ…æ‹¬å£°æ˜ä¸€ä¸ªç±»å‹æ˜¯ä»å…¶åˆå§‹åŒ–å™¨æ¨å¯¼å‡ºå˜é‡ç±»å‹çš„èƒ½åŠ›ï¼ˆautoï¼‰ã€‚å®ƒè¿˜æä¾›äº†ä¸€ç§æœºåˆ¶æ¥è¡¨ç¤ºå·²å‘½åå¯¹è±¡ï¼ˆå˜é‡æˆ–å‡½æ•°ï¼‰æˆ–è¡¨è¾¾å¼çš„ç±»å‹ï¼ˆdecltypeï¼‰ã€‚è¿™äº›è®¾æ–½åŸæ¥éå¸¸æ–¹ä¾¿ï¼Œè€ŒC++14å’ŒC++17åœ¨è¿™ä¸ªä¸»é¢˜ä¸Šå¢åŠ äº†é¢å¤–çš„å˜ä½“ã€‚</p></blockquote><hr /><h1 id="autoç±»å‹è¯´æ˜ç¬¦">autoç±»å‹è¯´æ˜ç¬¦</h1><blockquote><p>ç¼–ç¨‹æ—¶å¸¸å¸¸éœ€è¦æŠŠè¡¨è¾¾å¼çš„å€¼èµ‹ç»™å˜é‡ï¼Œè¿™å°±è¦æ±‚åœ¨å£°æ˜å˜é‡çš„æ—¶å€™æ¸…æ¥šåœ°çŸ¥é“è¡¨è¾¾å¼çš„ç±»å‹ã€‚c++11æ–°æ ‡å‡†å¼•å…¥äº†autoç±»å‹è¯´æ˜ç¬¦ï¼Œç”¨å®ƒå°±èƒ½è®©ç¼–è¯‘å™¨æ›¿æˆ‘ä»¬å»åˆ†æè¡¨è¾¾å¼æ‰€å±çš„ç±»å‹ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-comment">//ç”±val1å’Œval2ç›¸åŠ çš„ç»“æœå¯ä»¥æ¨æ–­å‡ºitemçš„ç±»å‹</span><br>&gt;<span class="hljs-keyword">auto</span> item = val1 + val2; <span class="hljs-comment">// itemåˆå§‹åŒ–ä¸ºval1å’Œval2ç›¸åŠ çš„ç»“æœ</span><br></code></pre></td></tr></table></figure> æ­¤å¤„ç¼–è¯‘å™¨å°†æ ¹æ®<code>val1</code>å’Œ<code>val2</code>ç›¸åŠ çš„ç»“æœæ¥æ¨æ–­<code>item</code>çš„ç±»å‹ã€‚å¦‚æœ<code>val1</code>å’Œ<code>val2</code>æ˜¯ç±»<code>sales_item</code>çš„å¯¹è±¡ï¼Œåˆ™<code>item</code>çš„ç±»å‹å°±æ˜¯<code>sales_item</code>;å¦‚æœè¿™ä¸¤ä¸ªå˜é‡çš„ç±»å‹æ˜¯<code>double</code>ï¼Œåˆ™<code>item</code>çš„ç±»å‹å°±æ˜¯<code>double</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p></blockquote><hr /><h2 id="å¤åˆç±»å‹å¸¸é‡å’Œauto">å¤åˆç±»å‹ï¼Œå¸¸é‡å’Œauto</h2><blockquote><p>ç¼–è¯‘å™¨æ¨æ–­å‡ºæ¥çš„autoç±»å‹æœ‰æ—¶å€™å’Œåˆå§‹å€¼çš„ç±»å‹å¹¶ä¸å®Œå…¨ä¸€æ ·ï¼Œç¼–è¯‘å™¨ä¼šé€‚å½“åœ°æ”¹å˜ç»“æœç±»å‹ä½¿å…¶æ›´ç¬¦åˆåˆå§‹åŒ–è§„åˆ™ã€‚</p><p>é¦–å…ˆï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ï¼Œä½¿ç”¨å¼•ç”¨å…¶å®æ˜¯ä½¿ç”¨å¼•ç”¨çš„å¯¹è±¡ï¼Œç‰¹åˆ«æ˜¯å½“å¼•ç”¨è¢«ç”¨ä½œåˆå§‹å€¼æ—¶,çœŸæ­£å‚ä¸åˆå§‹åŒ–çš„å…¶å®æ˜¯å¼•ç”¨å¯¹è±¡çš„å€¼ã€‚æ­¤æ—¶ç¼–è¯‘å™¨ä»¥å¼•ç”¨å¯¹è±¡çš„ç±»å‹ä½œä¸ºautoçš„ç±»å‹:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>,&amp;r = i;<br>&gt;<span class="hljs-keyword">auto</span> a = r;<br>&gt;<span class="hljs-comment">// açš„ç±»å‹ä¸ºint(ræ˜¯içš„åˆ«åï¼Œè€Œiæ˜¯ä¸€ä¸ªæ•´æ•°ï¼‰</span><br></code></pre></td></tr></table></figure>å…¶æ¬¡ï¼Œautoä¸€èˆ¬ä¼šå¿½ç•¥æ‰<code>é¡¶å±‚const</code>ï¼ŒåŒæ—¶<code>åº•å±‚const</code>åˆ™ä¼šä¿ç•™ä¸‹æ¥ï¼Œæ¯”å¦‚å½“åˆå§‹å€¼æ˜¯ä¸€ä¸ªæŒ‡å‘å¸¸é‡çš„æŒ‡é’ˆæ—¶:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-type">const</span> <span class="hljs-type">int</span> ci = i, &amp;cr = ci;<br>&gt;<span class="hljs-keyword">auto</span> b = ci;<span class="hljs-comment">// bçš„ç±»å‹ä¸ºintï¼ˆciçš„é¡¶å±‚const ç‰¹æ€§è¢«å¿½ç•¥æ‰äº†)</span><br>&gt;<span class="hljs-keyword">auto</span> c = cr;<span class="hljs-comment">// cçš„ç±»å‹ä¸ºintï¼ˆ cræ˜¯ciçš„åˆ«åï¼Œciæœ¬èº«æ˜¯ä¸€ä¸ªé¡¶å±‚const )</span><br>&gt;<span class="hljs-keyword">auto</span> d = &amp;i;<span class="hljs-comment">// dæ˜¯ä¸€ä¸ªæ•´å‹æŒ‡é’ˆ(int *)</span><br>&gt;<span class="hljs-keyword">auto</span> e = &amp;ci;<span class="hljs-comment">// eæ˜¯ä¸€ä¸ªæŒ‡å‘æ•´æ•°å¸¸é‡çš„æŒ‡é’ˆï¼ˆconst int *ï¼‰ï¼ˆå¯¹å¸¸é‡å¯¹è±¡å–å®Œåœ°å€åï¼Œå¸¸é‡å¯¹è±¡çš„é¡¶å±‚conståœ¨autoå¤„è½¬å˜ä¸ºåº•å±‚const)</span><br></code></pre></td></tr></table></figure>å¦‚æœå¸Œæœ›æ¨æ–­å‡ºçš„autoç±»å‹æ˜¯ä¸€ä¸ª<code>é¡¶å±‚const</code>ï¼Œéœ€è¦æ˜ç¡®æŒ‡å‡º:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> f = ci;<span class="hljs-comment">// ciçš„æ¨æ¼”ç±»å‹æ˜¯intï¼Œfæ˜¯const int</span><br></code></pre></td></tr></table></figure> è¿˜å¯ä»¥å°†å¼•ç”¨çš„ç±»å‹è®¾ä¸ºautoï¼Œæ­¤æ—¶åŸæ¥çš„åˆå§‹åŒ–è§„åˆ™ä»ç„¶é€‚ç”¨:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">auto</span> &amp;g = ci;<span class="hljs-comment">// gæ˜¯ä¸€ä¸ªæ•´å‹å¸¸é‡å¼•ç”¨ï¼Œç»‘å®šåˆ°ci</span><br>&gt;<span class="hljs-keyword">auto</span> &amp;h = <span class="hljs-number">42</span>;<span class="hljs-comment">//é”™è¯¯:ä¸èƒ½ä¸ºéå¸¸é‡å¼•ç”¨ç»‘å®šå­—é¢å€¼(42çš„ç±»å‹ä¸ºintï¼Œå·¦å€¼å¼•ç”¨ä¸èƒ½ç»‘å®šåˆ°å³å€¼)</span><br>&gt;<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span> &amp;j=<span class="hljs-number">42</span>;<span class="hljs-comment">//æ­£ç¡®:å¯ä»¥ä¸ºå¸¸é‡å¼•ç”¨ç»‘å®šå­—é¢å€¼ï¼ˆ42å‘ç”Ÿä¸´æ—¶ç‰©åŒ–ï¼Œäº§ç”Ÿä¸€ä¸ªxvalueçš„ä¸´æ—¶å¯¹è±¡è®©å¸¸é‡å¼•ç”¨ç»‘å®šï¼‰</span><br></code></pre></td></tr></table></figure>è®¾ç½®ä¸€ä¸ªç±»å‹ä¸ºautoçš„å¼•ç”¨æ—¶ï¼Œåˆå§‹å€¼ä¸­çš„é¡¶å±‚å¸¸é‡å±æ€§ä»ç„¶ä¿ç•™ã€‚å’Œå¾€å¸¸ä¸€æ ·ï¼Œå¦‚æœæˆ‘ä»¬ç»™åˆå§‹å€¼ç»‘å®šä¸€ä¸ªå¼•ç”¨(<code>auto &amp;g = ci;</code>)ï¼Œåˆ™æ­¤æ—¶çš„constå°±ä¸æ˜¯<code>é¡¶å±‚const</code>äº†ï¼ˆgçš„ç±»å‹ä¸º<code>const int &amp;</code>ï¼Œæ­¤å¤„çš„constä¸º<code>åº•å±‚const</code>ï¼‰ã€‚è¦åœ¨ä¸€æ¡è¯­å¥ä¸­å®šä¹‰å¤šä¸ªå˜é‡ï¼Œåˆ‡è®°ï¼Œç¬¦å·<code>&amp;</code>å’Œ<code>*</code>åªä»å±äºæŸä¸ªå£°æ˜ç¬¦ï¼Œè€ŒéåŸºæœ¬æ•°æ®ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤åˆå§‹å€¼å¿…é¡»æ˜¯åŒä¸€ç§ç±»å‹:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">auto</span> k = ci, &amp;l = i;<span class="hljs-comment">// kæ˜¯intï¼Œlæ˜¯int&amp;</span><br>&gt;<span class="hljs-keyword">auto</span> &amp;m = ci,*p = &amp;ci;<span class="hljs-comment">// mæ˜¯å¯¹æ•´å‹å¸¸é‡çš„å¼•ç”¨ï¼ˆconst int &amp;ï¼‰ï¼Œpæ˜¯æŒ‡å‘æ•´å‹å¸¸é‡çš„æŒ‡é’ˆï¼ˆconst int *ï¼‰ã€‚</span><br>&gt;<span class="hljs-keyword">auto</span> &amp;n= i, *p2 = &amp;ci;<span class="hljs-comment">//é”™è¯¯:içš„åŸºæœ¬æ•°æ®ç±»å‹æ˜¯intè€Œ&amp;ciçš„åŸºæœ¬æ•°æ®ç±»å‹æ˜¯const int</span><br></code></pre></td></tr></table></figure>ä»¥ä¸Šéƒ¨åˆ†ä¸ºautoç±»å‹è¯´æ˜ç¬¦çš„åŸºç¡€éƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†ä¾‹å­ä¸ºã€Šc++primerã€‹p61é¡µçš„ï¼Œæˆ‘åœ¨å…¶åŸºç¡€ä¸Šæ·»åŠ äº†æ³¨é‡Šä»¥åŠå¯¹å…¶è¿›è¡Œéƒ¨åˆ†ä¿®æ”¹ï¼Œä»¥ä¾¿è¯»è€…èƒ½å¿«é€Ÿé¢†æ‚Ÿå…¶å«ä¹‰ã€‚å…¶ä»–åŸºç¡€éƒ¨åˆ†è‹¥æœ‰ä¸æ‡‚è¯·è‡ªè¡Œè¡¥å……ï¼Œä¸å†èµ˜è¿°ã€‚</p></blockquote><hr /><h2 id="è¿›ä¸€æ­¥æ¢è®¨autoç±»å‹è¯´æ˜ç¬¦">è¿›ä¸€æ­¥æ¢è®¨autoç±»å‹è¯´æ˜ç¬¦</h2><blockquote><p>autoç±»å‹è¯´æ˜ç¬¦å¯ç”¨äºè®¸å¤šåœ°æ–¹ï¼ˆä¸»è¦æ˜¯namespaceä½œç”¨åŸŸå’Œlocalä½œç”¨åŸŸï¼‰ï¼Œä»¥ä»å…¶åˆå§‹åŒ–å™¨æ¨å¯¼å˜é‡çš„ç±»å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œautoè¢«ç§°ä¸ºå ä½ç¬¦ç±»å‹ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/auto">a placeholdertype</a>ï¼‰(å¦ä¸€ç§å ä½ç¬¦ç±»å‹<code>deltype(auto)</code>ï¼Œæ–‡ç« åé¢å°†ä¼šæè¿°)ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> Container&gt; <br>&gt;<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">useContainer</span><span class="hljs-params">(Container <span class="hljs-type">const</span>&amp; container)</span> </span><br><span class="hljs-function">&gt;</span>&#123; <br><span class="hljs-keyword">auto</span> pos = container.<span class="hljs-built_in">begin</span>(); <span class="hljs-comment">//autoç¤ºä¾‹ä¸€</span><br><span class="hljs-keyword">while</span> (pos != &gt;container.<span class="hljs-built_in">end</span>()) <br>&#123; <br><span class="hljs-keyword">auto</span>&amp; element = *pos++; <span class="hljs-comment">//autoç¤ºä¾‹äºŒ</span><br>â€¦ <span class="hljs-comment">// operate on the element </span><br>&#125; <br>&gt;&#125;<br></code></pre></td></tr></table></figure>ä¸Šé¢ç¤ºä¾‹ä¸­autoçš„ä¸¤ç§ä½¿ç”¨æ¶ˆé™¤äº†ç¼–å†™ä¸¤ç§é•¿ä¸”å¯èƒ½å¤æ‚çš„ç±»å‹ï¼Œå³å®¹å™¨çš„è¿­ä»£å™¨ç±»å‹å’Œè¿­ä»£å™¨çš„å€¼ç±»å‹ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">typename</span> Container::const_iterator pos = container.<span class="hljs-built_in">begin</span>();<br>â€¦<br><span class="hljs-keyword">typename</span> std::iterator_traits&lt;<span class="hljs-keyword">typename</span> Container::iterator&gt;::reference element = *pos++;<br></code></pre></td></tr></table></figure>è‡ªåŠ¨æ¨å¯¼ä½¿ç”¨ä¸æ¨¡æ¿å‚æ•°æ¨å¯¼ç›¸åŒçš„æœºåˆ¶ã€‚autoç±»å‹è¯´æ˜ç¬¦å¯ä»¥è¢«ä¸€ä¸ªè™šæ„çš„æ¨¡æ¿ç±»å‹å‚æ•°<code>T</code>å–ä»£ï¼Œç„¶åæ¨å¯¼ç»§ç»­è¿›è¡Œï¼Œå°±å¥½åƒè¯¥å˜é‡æ˜¯ä¸€ä¸ªå‡½æ•°å½¢å‚ï¼Œå®ƒçš„åˆå§‹åŒ–å™¨ç›¸å½“äºå‡½æ•°å®å‚ã€‚å¯¹äºç¬¬ä¸€ä¸ªautoç¤ºä¾‹ï¼Œå®ƒå¯¹åº”äºä»¥ä¸‹æƒ…å†µï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt; <br>&gt;<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deducePos</span><span class="hljs-params">(T pos)</span></span>; <br>&gt;<span class="hljs-built_in">deducePos</span>(container.<span class="hljs-built_in">begin</span>());<br></code></pre></td></tr></table></figure>è¿™é‡Œ<code>T</code>çœ‹ä½œ<code>auto</code>ï¼Œæ˜¯è¦è¢«æ¨å¯¼å‡ºçš„ç±»å‹ã€‚è¿™æ ·åšçš„ç›´æ¥åæœä¹‹ä¸€æ˜¯ï¼Œautoç±»å‹çš„å˜é‡æ°¸è¿œä¸ä¼šæ˜¯å¼•ç”¨ç±»å‹ã€‚åœ¨ç¬¬äºŒä¸ªautoç¤ºä¾‹ä¸­ä½¿ç”¨<code>auto&amp;</code>è¯´æ˜äº†å¦‚ä½•ç”Ÿæˆä¸€ä¸ªå¼•ç”¨ç±»å‹çš„æ¨å¯¼ã€‚å…¶æ¨å¯¼ç›¸å½“äºä»¥ä¸‹å‡½æ•°æ¨¡æ¿å’Œè°ƒç”¨ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt; <span class="hljs-title">deduceElement</span><span class="hljs-params">(T&amp; element)</span></span>;<br>&gt;<span class="hljs-built_in">deduceElement</span>(*pos++);<br></code></pre></td></tr></table></figure>åœ¨è¿™é‡Œï¼Œ<code>element</code>æ€»æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¹¶ä¸”å®ƒçš„åˆå§‹åŒ–å™¨ä¸èƒ½ç”Ÿæˆä¸€ä¸ªä¸´æ—¶å¯¹è±¡ã€‚</p></blockquote><hr /><h3 id="autoä¸å³å€¼å¼•ç”¨">autoä¸å³å€¼å¼•ç”¨</h3><blockquote><p>ä¹Ÿå¯ä»¥å°†autoä¸å³å€¼å¼•ç”¨ç»„åˆèµ·æ¥ï¼Œä½†è¿™æ ·åšä½¿å…¶è¡Œä¸ºåƒä¸€ä¸ªè½¬å‘çš„å¼•ç”¨ï¼ˆaforwarding referenceï¼‰ï¼Œä¾‹å¦‚ï¼š auto&amp;&amp; fr = â€¦;æˆ‘ä»¬è¿˜æ˜¯åŸºäºå‡½æ•°æ¨¡æ¿æ¥çœ‹å¾…å®ƒï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt; <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">(T&amp;&amp; fr)</span></span>;<span class="hljs-comment">// auto replaced by template parameter T</span><br></code></pre></td></tr></table></figure> è§£é‡Šå¦‚ä¸‹ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-type">int</span> x; <br>&gt;<span class="hljs-keyword">auto</span>&amp;&amp; rr = <span class="hljs-number">42</span>; <span class="hljs-comment">// OK: rvalue reference binds to an rvalue </span><br>&gt;ä¸ª(<span class="hljs-keyword">auto</span> = <span class="hljs-type">int</span>)<br>&gt;<span class="hljs-keyword">auto</span>&amp;&amp; lr = x; <span class="hljs-comment">// Also OK:reference collapsing makes. lr an lvalue reference</span><br>&gt;ä¸ª(<span class="hljs-keyword">auto</span> = <span class="hljs-type">int</span>&amp;)<br></code></pre></td></tr></table></figure>è¿™ç§æŠ€æœ¯ç»å¸¸ç”¨äºä»£ç ä¸­ç»‘å®šå‡½æ•°æˆ–æ“ä½œç¬¦è°ƒç”¨çš„ç»“æœå¯¹è±¡ï¼Œä¸”ä¸çŸ¥é“ç»“æœå¯¹è±¡çš„å€¼ç±»åˆ«(lvaluevs.rvarue)ï¼Œè¿›è€Œä¸å¿…å¤åˆ¶è¯¥ç»“æœå¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œå®ƒé€šå¸¸æ˜¯åœ¨åŸºäºèŒƒå›´çš„å¾ªç¯ä¸­å£°æ˜è¿­ä»£å€¼çš„é¦–é€‰æ–¹æ³•ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> Container&gt; <br>&gt;<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">(Container c)</span></span><br><span class="hljs-function">&gt;</span>&#123; <br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp;&amp; x: c) &#123; â€¦ &#125; <br>&gt;&#125;<br></code></pre></td></tr></table></figure>è¿™é‡Œæˆ‘ä»¬ä¸çŸ¥é“å®¹å™¨è¿­ä»£æ¥å£çš„ç­¾å( the signatures of the containerâ€™siterationinterfaces)ï¼Œä½†æ˜¯é€šè¿‡ä½¿ç”¨<code>auto&amp;&amp;</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿¡æˆ‘ä»¬æ­£åœ¨éå†çš„å€¼æ²¡æœ‰äº§ç”Ÿé¢å¤–çš„å‰¯æœ¬ã€‚å¦‚æœéœ€è¦å®Œç¾è½¬å‘ç»‘å®šå€¼ï¼Œåˆ™å¯ä»¥åƒå¾€å¸¸ä¸€æ ·åœ¨å˜é‡ä¸Šè°ƒç”¨<code>std::forward&lt;T&gt;()</code>ã€‚è¿™ä½¿å¾—ä¸€ç§â€œå»¶è¿Ÿâ€çš„å®Œç¾è½¬å‘æˆä¸ºå¯èƒ½ã€‚æœ‰å…³ç¤ºä¾‹ï¼Œè¯·å‚è§ã€Šc++template 2ndã€‹p167ã€‚é™¤äº†å¼•ç”¨ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ç»„åˆautoè¯´æ˜ç¬¦æ¥åˆ›å»ºconstå¯¹è±¡ã€æŒ‡é’ˆã€æˆå‘˜æŒ‡é’ˆç­‰ç­‰ï¼Œä½†autoå¿…é¡»å£°æ˜æˆâ€œmainâ€ç±»å‹è¯´æ˜ç¬¦ï¼ˆåŸºæœ¬æ•°æ®ç±»å‹ï¼‰ã€‚å®ƒä¸èƒ½åµŒå¥—åœ¨æ¨¡æ¿å‚æ•°ä¸­æˆ–è·Ÿåœ¨åŸºæœ¬æ•°æ®ç±»å‹åé¢çš„å£°æ˜éƒ¨åˆ†ä¸­ï¼ˆpart of the declarator that follows the typespecifierï¼‰ã€‚å…·ä½“è¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt; <span class="hljs-keyword">struct</span> <span class="hljs-title class_">X</span> &#123; T <span class="hljs-type">const</span> m; &#125;; <br>&gt;<span class="hljs-keyword">auto</span> <span class="hljs-type">const</span> N = <span class="hljs-number">400u</span>; <span class="hljs-comment">// OK: constant of type </span><br><br>&gt;<span class="hljs-keyword">auto</span>* gp = (<span class="hljs-type">void</span>*)<span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// OK: gp has type void* </span><br><br>&gt;X&lt;<span class="hljs-keyword">auto</span>&gt; xa = <span class="hljs-built_in">X</span>&lt;<span class="hljs-type">int</span>&gt;(); <span class="hljs-comment">// ERROR: auto in template </span><br><br>&gt;<span class="hljs-type">int</span> <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>::*pm2 = &amp;X&lt;<span class="hljs-type">int</span>&gt;::m; <span class="hljs-comment">// ERROR: auto is &gt;part of the â€œdeclaratorâ€</span><br></code></pre></td></tr></table></figure>æœ€åä¸¤ä¸ªä¾‹å­ä¸è®©é€šè¿‡çš„åŸå› åœ¨äºC++å§”å‘˜ä¼šè®¤ä¸ºï¼Œé¢å¤–çš„å®æ–½æˆæœ¬å’Œæ»¥ç”¨æ½œåŠ›è¶…è¿‡äº†å¥½å¤„â˜¹ï¸ã€‚</p></blockquote><hr /><h3 id="æ¨å¯¼è¿”å›ç±»å‹-c14">æ¨å¯¼è¿”å›ç±»å‹ c++14</h3><blockquote><p>C++14å¢åŠ äº†å¦ä¸€ç§æƒ…å†µï¼Œå…¶ä¸­å¯æ¨å¯¼autoå ä½ç¬¦ç±»å‹å¯ä»¥å‡ºç°åœ¨å‡½æ•°è¿”å›ç±»å‹ä¸­ã€‚ä¾‹å¦‚ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; &#125;<br></code></pre></td></tr></table></figure>å®šä¹‰ä¸€ä¸ªè¿”å›ç±»å‹ä¸ºint(42)çš„å‡½æ•°ã€‚è¿™ä¹Ÿå¯ä»¥ä½¿ç”¨åç½®è¿”å›ç±»å‹çš„è¯­æ³•æ¥è¡¨ç¤ºï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> -&gt; <span class="hljs-keyword">auto</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; &#125;<br></code></pre></td></tr></table></figure>åœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ªautoå®£å‘Šæœ‰å°¾ç½®è¿”å›ç±»å‹ï¼Œè€Œç¬¬äºŒä¸ªautoæ˜¯è¦æ¨å¯¼å‡ºçš„å ä½ç¬¦ç±»å‹ã€‚ä½†æ˜¯ç›´æ¥è¿™ä¹ˆå†™ä¼šæ˜¾å¾—å¾ˆå†—é•¿ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>lambda</code>ä¹Ÿå­˜åœ¨ç›¸åŒçš„æœºåˆ¶ï¼šå¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šè¿”å›ç±»å‹ï¼Œåˆ™lambdaçš„è¿”å›ç±»å‹ä¼šåƒautoä¸€æ ·è¢«æ¨å¯¼å‡ºæ¥ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">auto</span> lm = [] (<span class="hljs-type">int</span> x) &#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">f</span>(x); &#125;; <br><span class="hljs-comment">// same as:auto lm = [] (int x) -&gt; auto &#123; return f(x); &#125;;</span><br></code></pre></td></tr></table></figure> å‡½æ•°å¯ä»¥å•ç‹¬å£°æ˜ã€‚å¯¹äºè¿”å›ç±»å‹æ˜¯è¢«æ¨å¯¼å‡ºæ¥çš„å‡½æ•°ä¹Ÿä¸€æ ·ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// forward declaration </span><br>&gt;<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; &#125;<br></code></pre></td></tr></table></figure> ä½†æ˜¯ï¼Œåœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œforwarddeclarationçš„ç”¨é€”éå¸¸æœ‰é™ï¼Œå› ä¸ºè¯¥å®šä¹‰å¿…é¡»åœ¨ä½¿ç”¨è¯¥å‡½æ•°çš„ä»»ä½•åœ°æ–¹éƒ½å¯è§ã€‚ä¹Ÿè®¸ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæä¾›å¸¦æœ‰â€œresolvedâ€è¿”å›ç±»å‹çš„forwarddeclarationæ˜¯æ— æ•ˆçš„ã€‚ä¾‹å¦‚ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">known</span><span class="hljs-params">()</span></span>; <br>&gt;<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">known</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; &#125; <span class="hljs-comment">//ERROR: incompatible return type</span><br></code></pre></td></tr></table></figure>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæå‰å£°æ˜ä¸€ä¸ªå…·æœ‰æ¨å¯¼è¿”å›ç±»å‹çš„å‡½æ•°ï¼Œåªæœ‰åœ¨èƒ½å¤Ÿå°†æˆå‘˜å‡½æ•°å®šä¹‰ç§»åŠ¨åˆ°ç±»å®šä¹‰ä¹‹å¤–æ—¶æ‰æœ‰ç”¨ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">struct</span> <span class="hljs-title class_">S</span> &#123; <br><span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span>; <span class="hljs-comment">// the definition will follow the class definition </span><br>&gt;&#125;;<br>&gt;<span class="hljs-function"><span class="hljs-keyword">auto</span> <span class="hljs-title">S::f</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-number">42</span>; &#125;<br></code></pre></td></tr></table></figure></p></blockquote><hr /><h3id="å¯æ¨å¯¼çš„éç±»å‹å‚æ•°deducible-nontype-parameteruntil-c17">å¯æ¨å¯¼çš„éç±»å‹å‚æ•°ï¼ˆDeducibleNontype Parameterï¼‰until c++17</h3><blockquote><p>åœ¨C++17ä¹‹å‰ï¼Œéç±»å‹æ¨¡æ¿å‚æ•°å¿…é¡»ç”¨ç‰¹å®šçš„ç±»å‹æ¥å£°æ˜ã€‚ä½†æ˜¯ï¼Œè¯¥ç±»å‹å¯ä»¥æ˜¯ä¸€ä¸ªæ¨¡æ¿å‚æ•°ç±»å‹ã€‚ä¾‹å¦‚ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, T V&gt; <span class="hljs-keyword">struct</span> <span class="hljs-title class_">S</span>; <br>&gt;S&lt;<span class="hljs-type">int</span>, <span class="hljs-number">42</span>&gt;* ps;<br></code></pre></td></tr></table></figure>åœ¨æœ¬ä¾‹ä¸­ï¼Œå¿…é¡»æŒ‡å®šéç±»å‹æ¨¡æ¿å‚æ•°çš„ç±»å‹ï¼Œå³åœ¨42ä¹‹å¤–æŒ‡å®šintï¼Œå¯èƒ½éå¸¸ç¹çã€‚å› æ­¤ï¼ŒC++17å¢åŠ äº†å£°æ˜éç±»å‹æ¨¡æ¿å‚æ•°çš„èƒ½åŠ›ï¼Œè¿™äº›å‚æ•°çš„å®é™…ç±»å‹æ˜¯ä»ç›¸åº”çš„æ¨¡æ¿å‚æ•°æ¨å¯¼å‡ºæ¥çš„ã€‚å®ƒä»¬å£°æ˜å¦‚ä¸‹ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">auto</span> V&gt; <span class="hljs-keyword">struct</span> <span class="hljs-title class_">S</span>;<br>&gt;S&lt;<span class="hljs-number">42</span>&gt;* ps;<span class="hljs-comment">//è¿™æ ·çš„è¯å°±ç®€æ´å¤šäº†</span><br></code></pre></td></tr></table></figure>è¿™é‡Œ<code>S&lt;42&gt;</code>çš„Vç±»å‹è¢«æ¨æ–­ä¸ºintï¼Œå› ä¸º<code>42</code>çš„ç±»å‹ä¸º<code>int</code>ã€‚å¦‚æœæˆ‘ä»¬å†™çš„æ˜¯<code>S&lt;42u&gt;</code>ï¼Œ<code>V</code>çš„ç±»å‹å°±ä¼šè¢«æ¨å¯¼ä¸º<code>æ— ç¬¦å·int</code>ï¼ˆã€Šc++template 2ndã€‹p294ï¼‰ã€‚è¯·æ³¨æ„ï¼Œå¯¹éç±»å‹æ¨¡æ¿å‚æ•°çš„ç±»å‹çš„ä¸€èˆ¬çº¦æŸä»ç„¶æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;S&lt;<span class="hljs-number">3.14</span>&gt;* pd;<span class="hljs-comment">// ERROR: floating-point nontype argument</span><br></code></pre></td></tr></table></figure>æœ€åautoåªåœ¨c++17ä¸­è¢«å…è®¸ç”¨åœ¨æ¨¡æ¿å‚æ•°ä¸­ï¼Œc++20å¼€å§‹è¢«ç§»é™¤ï¼ŒåŸå› æ˜¯å¼Šå¤§äºåˆ©ï¼Œæ»¥ç”¨å®ƒä¼šè®©ç¨‹åºå˜å¾—æ›´éš¾è¯»æ‡‚ã€‚</p></blockquote><hr /><h1id="ç”¨decltypeè¡¨ç¤ºè¡¨è¾¾å¼çš„ç±»å‹expressing-the-type-of-an-expression-with-decltype">ç”¨decltypeè¡¨ç¤ºè¡¨è¾¾å¼çš„ç±»å‹ï¼ˆExpressingthe Type of an Expression with decltypeï¼‰</h1><blockquote><p>è™½ç„¶autoé¿å…äº†å†™å‡ºå˜é‡çš„ç±»å‹çš„éœ€è¦ï¼Œä½†å®ƒä¸å®¹æ˜“å…è®¸äººä»¬ä½¿ç”¨è¯¥å˜é‡çš„ç±»å‹(ä¸èƒ½ç¡®å®šä¸ºæŸä¸€æŒ‡å®šç±»å‹)ã€‚deltypeå…³é”®å­—è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼šå®ƒå…è®¸ç¨‹åºå‘˜è¡¨è¾¾è¡¨è¾¾å¼æˆ–å£°æ˜çš„ç²¾ç¡®ç±»å‹ã€‚ä½†æ˜¯ï¼Œç¨‹åºå‘˜åº”è¯¥å°å¿ƒdecltypeç±»å‹äº§ç”Ÿçš„<code>ç»†å¾®å·®åˆ«</code>ï¼Œè¿™å–å†³äºä¼ é€’çš„å‚æ•°æ˜¯ä¸€ä¸ªå£°æ˜å®šä¹‰å‡ºçš„å®ä½“ï¼ˆegï¼š<code>int a;</code>//è¿™é‡Œaå±äºè¢«å®šä¹‰å‡ºçš„å®ä½“ï¼‰è¿˜æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆegï¼š<code>1+1;</code>//è¿™é‡Œ1+1è¿™ä¸ªæ•´ä½“æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼‰ï¼š-å¦‚æœ<code>e</code>æ˜¯å®ä½“çš„åç§°ï¼ˆå¦‚å˜é‡ã€å‡½æ•°ç­¾åã€æšä¸¾å™¨æˆ–æ•°æ®æˆå‘˜ï¼‰æˆ–ç±»æˆå‘˜è®¿é—®è¿‡ç¨‹ï¼Œåˆ™<code>delltype(e)</code>ç”Ÿæˆè¯¥å®ä½“çš„å£°æ˜ç±»å‹æˆ–è¡¨ç¤ºç±»æˆå‘˜çš„ç±»å‹ã€‚å› æ­¤ï¼Œdecltypeç±»å‹å¯ä»¥ç”¨æ¥æ£€æŸ¥å˜é‡çš„ç±»å‹ã€‚å½“å¸Œæœ›ç²¾ç¡®åŒ¹é…ç°æœ‰å£°æ˜çš„ç±»å‹æ—¶ï¼Œè¿™ä¸€ç‚¹å¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å˜é‡<code>y1</code>å’Œ<code>y2</code>ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">auto</span> x = â€¦; <br><span class="hljs-keyword">auto</span> y1 = x + <span class="hljs-number">1</span>; <br><span class="hljs-keyword">decltype</span>(x) y2 = x + <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>æ ¹æ®<code>x</code>çš„åˆå§‹åŒ–å™¨ï¼Œ<code>y1</code>å¯èƒ½å…·æœ‰ä¹Ÿå¯èƒ½ä¸å…·æœ‰ä¸<code>x</code>ç›¸åŒçš„ç±»å‹ï¼šå®ƒå–å†³äº<code>+</code>çš„è¡Œä¸ºã€‚å¦‚æœ<code>x</code>è¢«æ¨å¯¼å‡ºä¸º<code>int</code>ï¼Œ<code>y1</code>ä¹Ÿä¼šæ˜¯<code>int</code>ã€‚å¦‚æœ<code>x</code>è¢«æ¨å¯¼ä¸º<code>char</code>ï¼Œé‚£ä¹ˆ<code>y1</code>å°†æ˜¯<code>int</code>ï¼Œå› ä¸º<code>char</code>ä¸<code>1</code>çš„å’Œæ˜¯<code>int</code>ã€‚åœ¨<code>y2</code>ç±»å‹ä¸­ä½¿ç”¨<code>deltype(x)</code>ç¡®ä¿å®ƒå§‹ç»ˆå…·æœ‰ä¸<code>x</code>ç›¸åŒçš„ç±»å‹ã€‚## prvalue,xvalueå’Œlvalueä¸decltypeçš„å…³ç³»ï¼š -å¦‚æœ<code>e</code>æ˜¯ä»»ä½•å…¶ä»–è¡¨è¾¾å¼ï¼Œåˆ™<code>deltype(e)</code>å°†ç”Ÿæˆä¸€ä¸ªåæ˜ è¯¥è¡¨è¾¾å¼çš„ç±»å‹(type)å’Œå€¼ç±»åˆ«(valuecategory)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š ä¸€ If e is an lvalue of type <code>T</code>,decltype(e) produces <code>T&amp;</code>. ä¸€ If e is an xvalue of type<code>T</code>, decltype(e) produces <code>T&amp;&amp;</code>. ä¸€ If eis a prvalue of type <code>T</code>, decltype(e) produces<code>T</code>. å‚è€ƒã€Šc++ template 2ndã€‹çš„é™„å½•Bå¯ä»¥äº†è§£æ›´å¤švaluecategoryçš„çŸ¥è¯†ã€‚</p></blockquote><hr /><blockquote><p>è¿™ç§ç»†å¾®å·®åˆ«å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¾‹å­æ¥è¯æ˜ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">g</span> <span class="hljs-params">(std::string&amp;&amp; s)</span></span><br><span class="hljs-function">&gt;</span>&#123;<br><span class="hljs-comment">// check the type of s:</span><br>std::is_lvalue_reference&lt;<span class="hljs-keyword">decltype</span>(s)&gt;::value; <span class="hljs-comment">// false</span><br>std::is_rvalue_reference&lt;<span class="hljs-keyword">decltype</span>(s)&gt;::value; <span class="hljs-comment">// true (s as declared)</span><br>std::is_same&lt;<span class="hljs-keyword">decltype</span>(s),std::string&amp;&gt;::value; <span class="hljs-comment">// false</span><br>std::is_same&lt;<span class="hljs-keyword">decltype</span>(s),std::string&amp;&amp;&gt;::value; <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// check the value category of s used as expression:</span><br>std::is_lvalue_reference&lt;<span class="hljs-keyword">decltype</span>((s))&gt;::value; <span class="hljs-comment">// true (s is an lvalue)</span><br>std::is_rvalue_reference&lt;<span class="hljs-keyword">decltype</span>((s))&gt;::value; <span class="hljs-comment">// false</span><br>std::is_same&lt;<span class="hljs-keyword">decltype</span>((s)),std::string&amp;&gt;::value; <span class="hljs-comment">// true (T&amp; signals an lvalue)</span><br>std::is_same&lt;<span class="hljs-keyword">decltype</span>((s)),std::string&amp;&amp;&gt;::value; <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure>åœ¨å‰å››ä¸ªè¡¨è¾¾å¼ä¸­ï¼Œä¸ºå˜é‡<code>s</code>è°ƒç”¨delctypeï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">decltype</span>(s) <span class="hljs-comment">//declared type of entity e designated by s</span><br></code></pre></td></tr></table></figure>è¿™æ„å‘³ç€deltypeäº§ç”Ÿäº†<code>s</code>çš„å£°æ˜ç±»å‹<code>std::sting&amp;&amp;</code>ã€‚åœ¨æœ€åå››ä¸ªè¡¨è¾¾å¼ä¸­ï¼Œdecltypeç±»å‹æ„é€ çš„æ“ä½œæ•°ä¸ä»…ä»…æ˜¯ä¸€ä¸ªåç§°ï¼Œå› ä¸ºåœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œè¯¥è¡¨è¾¾å¼éƒ½æ˜¯<code>(s)</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨æ‹¬å·è¡¨ç¤ºçš„åç§°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥ç±»å‹å°†åæ˜ <code>(s)</code>çš„å€¼ç±»åˆ«ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">decltype</span>((s)) <span class="hljs-comment">//check the value category of (s)</span><br></code></pre></td></tr></table></figure>æˆ‘ä»¬çš„è¡¨è¾¾å¼æŒ‡çš„æ˜¯ä¸€ä¸ªå˜é‡ï¼Œå› æ­¤æ˜¯ä¸€ä¸ª<code>lvalue</code>ï¼šæ ¹æ®ä¸Šé¢çš„è§„åˆ™ï¼Œè¿™æ„å‘³ç€<code>decltype((s))</code>æ˜¯å¯¹<code>std::string</code>çš„æ™®é€šå¼•ç”¨(lvaluereference)ã€‚è¿™æ˜¯C++ä¸­ä¸ºæ•°ä¸å¤šçš„ç”¨æ‹¬å·è¡¨ç¤ºè¡¨è¾¾å¼ä¼šæ”¹å˜ç¨‹åºå«ä¹‰çš„åœ°æ–¹ä¹‹ä¸€ï¼Œè€Œä¸æ˜¯å½±å“æ“ä½œç¬¦çš„å…³è”æ€§ã€‚decltypeç±»å‹è®¡ç®—ä»»æ„è¡¨è¾¾å¼eçš„ç±»å‹ï¼Œè¿™ä¸€äº‹å®åœ¨ä¸åŒçš„åœ°æ–¹éƒ½æœ‰å¸®åŠ©ã€‚å…·ä½“æ¥è¯´ï¼Œ<code>deltype(e)</code>ä¿ç•™äº†å…³äºè¡¨è¾¾å¼çš„è¶³å¤Ÿä¿¡æ¯ï¼Œå¯ä»¥ä½¿å®ƒæè¿°è¿”å›è¡¨è¾¾å¼<code>e</code>æœ¬èº«çš„å‡½æ•°çš„è¿”å›ç±»å‹ï¼šdeltypeè®¡ç®—è¯¥è¡¨è¾¾å¼çš„ç±»å‹ï¼Œä½†å®ƒä¹Ÿå°†è¡¨è¾¾å¼çš„å€¼ç±»åˆ«ä¼ æ’­ç»™å‡½æ•°çš„è°ƒç”¨è€…ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªç®€å•çš„è½¬å‘å‡½æ•°g()ï¼Œå®ƒè¿”å›è°ƒç”¨f()çš„ç»“æœï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;??? <span class="hljs-built_in">f</span>(); <br>&gt;<span class="hljs-keyword">decltype</span>(<span class="hljs-built_in">f</span>()) <span class="hljs-built_in">g</span>() &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">f</span>(); <br>&#125;<br></code></pre></td></tr></table></figure><code>g()</code>çš„è¿”å›ç±»å‹å–å†³äº<code>f()</code>çš„è¿”å›ç±»å‹ã€‚å¦‚æœ<code>f()</code>è¿”å›<code>int&amp;</code>ï¼Œé‚£ä¹ˆè®¡ç®—<code>g()</code>çš„è¿”å›ç±»å‹å°†é¦–å…ˆç¡®å®šè¡¨è¾¾å¼<code>f()</code>å…·æœ‰ç±»å‹<code>int</code>ã€‚è¿™ä¸ªè¡¨è¾¾å¼æ˜¯ä¸€ä¸ª<code>lvalue</code>ï¼Œå› ä¸º<code>f()</code>è¿”å›ä¸€ä¸ªå·¦å€¼å¼•ç”¨ï¼Œå› æ­¤å£°æ˜çš„è¿”å›ç±»å‹å˜ä¸º<code>int&amp;</code>ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœ<code>f()</code>çš„è¿”å›ç±»å‹æ˜¯å³å€¼å¼•ç”¨ç±»å‹ï¼Œåˆ™è°ƒç”¨<code>f()</code>å°†æ˜¯<code>xvalue</code>ï¼Œdecltypeå°†ç”Ÿæˆä¸<code>f()</code>è¿”å›çš„ç±»å‹å®Œå…¨åŒ¹é…çš„å³å€¼å¼•ç”¨ç±»å‹ã€‚æœ¬è´¨ä¸Šï¼Œè¿™ç§å½¢å¼çš„decltypeç±»å‹é‡‡ç”¨äº†ä»»æ„è¡¨è¾¾å¼çš„ä¸»è¦ç‰¹å¾â€”â€”å®ƒçš„ç±»å‹å’Œå€¼ç±»åˆ«â€”â€”å¹¶ä»¥ä¸€ç§èƒ½å¤Ÿå®Œç¾è½¬å‘è¿”å›å€¼çš„æ–¹å¼åœ¨ç±»å‹ç³»ç»Ÿä¸­å¯¹å®ƒä»¬è¿›è¡Œç¼–ç ã€‚å½“ value-producing<code>auto</code>çš„æ¨å¯¼ä¸è¶³æ—¶ï¼Œdecltypeä¹Ÿå¯èƒ½å¾ˆæœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæœªçŸ¥è¿­ä»£å™¨ç±»å‹çš„å˜é‡<code>pos</code>ï¼Œå¹¶ä¸”æˆ‘ä»¬å¸Œæœ›åˆ›å»ºä¸€ä¸ªå˜é‡å…ƒç´ æ¥å¼•ç”¨<code>pos</code>å­˜å‚¨çš„å…ƒç´ ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">auto</span> element = *pos;<span class="hljs-comment">//è¿™å°†å§‹ç»ˆæœ‰å…ƒç´ çš„å‰¯æœ¬äº§ç”Ÿã€‚</span><br>&gt;<span class="hljs-keyword">auto</span>&amp; element = *pos;<span class="hljs-comment">//å¼•ç”¨poså­˜å‚¨çš„å…ƒç´ ï¼</span><br></code></pre></td></tr></table></figure> æˆ‘ä»¬å°†æ€»æ˜¯ä¼šæ”¶åˆ°ä¸€ä¸ªå¯¹å…ƒç´ çš„å¼•ç”¨ï¼Œä½†æ˜¯å¦‚æœè¿­ä»£å™¨çš„æ“ä½œç¬¦<code>*</code>è¿”å›ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆç¨‹åºå°†ä¼šå¤±è´¥ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨decltypeç±»å‹ï¼Œä»¥ä¿æŒè¿­ä»£å™¨çš„è¿ç®—ç¬¦<code>*</code>çš„å€¼æˆ–å¼•ç”¨æ€§ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">decltype</span>(*pos) element = *pos;<br></code></pre></td></tr></table></figure>æ˜¯ä½¿ç”¨å†…ç½®ç±»å‹è§£å¼•ç”¨<code>pos</code>æ—¶<code>ä½¿ç”¨å¼•ç”¨</code>ï¼ˆ*posè¡¨è¾¾å¼çš„ç»“æœä¸ºå·¦å€¼ï¼Œåˆ™decltypeæ¨æ–­å‡ºæ¥çš„ç±»å‹ä¸ºå·¦å€¼å¼•ç”¨ï¼ï¼‰ï¼Œæ˜¯è¿­ä»£å™¨çš„æ“ä½œç¬¦<code>*</code>è¿”å›ä¸€ä¸ªå€¼æ—¶<code>å¤åˆ¶å€¼</code>ã€‚å®ƒçš„ä¸»è¦ç¼ºé™·æ˜¯å®ƒéœ€è¦å°†åˆå§‹åŒ–å™¨è¡¨è¾¾å¼å†™å…¥ä¸¤æ¬¡ï¼šä¸€æ¬¡åœ¨decltypeä¸­ï¼ˆä¸è®¡ç®—å®ƒï¼‰ï¼Œå¦ä¸€æ¬¡åœ¨å®é™…çš„åˆå§‹åŒ–å™¨ä¸­ã€‚C++14å¼•å…¥äº†<code>decltype(auto)</code>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°†è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚</p></blockquote><hr /><h1 id="decltypeauto-c14">decltype(auto) c++14</h1><blockquote><p>C++14å¢åŠ äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒæ˜¯autoå’Œdecltypeçš„ç»„åˆï¼š<code>decltype(auto)</code>ã€‚ä¸autoç±»å‹è¯´æ˜ç¬¦ä¸€æ ·ï¼Œå®ƒæ˜¯ä¸€ä¸ª<code>å ä½ç¬¦ç±»å‹</code>ï¼Œå¹¶ä¸”å˜é‡ã€è¿”å›ç±»å‹æˆ–æ¨¡æ¿å‚æ•°çš„ç±»å‹æ˜¯ç”±ç›¸å…³è¡¨è¾¾å¼çš„ç±»å‹(initializer,return value, or templateargument)ç¡®å®šçš„ã€‚ä½†æ˜¯ï¼Œä¸ä»…ä½¿ç”¨autoä¸åŒï¼Œå®ƒä½¿ç”¨æ¨¡æ¿å‚æ•°æ¨æ–­çš„è§„åˆ™æ¥ç¡®å®šæ„Ÿå…´è¶£çš„ç±»å‹ï¼Œå®é™…çš„ç±»å‹æ˜¯é€šè¿‡å°†decltypeç›´æ¥åº”ç”¨äºè¡¨è¾¾å¼æ¥ç¡®å®šçš„ã€‚ä¸¾ä¾‹è¯´æ˜äº†è¿™ä¸€ç‚¹ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-type">int</span> i = <span class="hljs-number">42</span>; <span class="hljs-comment">// i has type int</span><br>&gt;<span class="hljs-type">int</span> <span class="hljs-type">const</span>&amp; ref = i; <span class="hljs-comment">// ref has type int const&amp; and refers to i</span><br>&gt;<span class="hljs-keyword">auto</span> x = ref; <span class="hljs-comment">// x has type int and is a new independent object</span><br>&gt;<span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) y = ref; <span class="hljs-comment">// y has type int const&amp; and also refers to i</span><br></code></pre></td></tr></table></figure><code>y</code>çš„ç±»å‹æ˜¯é€šè¿‡å°†decltypeåº”ç”¨åˆ°åˆå§‹åŒ–å™¨è¡¨è¾¾å¼ä¸­å¾—åˆ°çš„ï¼Œè¿™é‡Œæ˜¯<code>ref</code>ï¼Œå®ƒæ˜¯<code>int const&amp;</code>ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œautoç±»å‹æ¨å¯¼çš„è§„åˆ™äº§ç”Ÿçš„åˆ™æ˜¯ç±»å‹<code>int</code>ã€‚å¦ä¸€ä¸ªç¤ºä¾‹æ˜¾ç¤ºäº†ç´¢å¼•<code>std::vector</code>(ç´¢å¼•å‡ºæ¥çš„æ˜¯ä¸€ä¸ªlvalueã€Šc++primerã€‹p121)æ—¶çš„å·®å¼‚ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;std::vector&lt;<span class="hljs-type">int</span>&gt; v = &#123; <span class="hljs-number">42</span> &#125;;<br>&gt;<span class="hljs-keyword">auto</span> x = v[<span class="hljs-number">0</span>]; <span class="hljs-comment">// x denotes a new object of type int</span><br>&gt;<span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) y = v[<span class="hljs-number">0</span>]; <span class="hljs-comment">// y is a reference (type int&amp;)ï¼ˆBecause [ ] operator produces an lvalueï¼‰</span><br></code></pre></td></tr></table></figure> è¿™å¾ˆå¥½åœ°è§£å†³äº†å‰é¢ç¤ºä¾‹ä¸­çš„å†—ä½™å†™æ³•ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">decltype</span>(*pos) element = *pos;<span class="hljs-comment">//Redundant writing</span><br>&gt;<span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) element = *pos;<span class="hljs-comment">//which can now be rewritten as</span><br></code></pre></td></tr></table></figure>å®ƒé€šå¸¸ç”¨åœ¨è¿”å›ç±»å‹ä¸Šã€‚å‚è€ƒä»¥ä¸‹ç¤ºä¾‹ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> C&gt; <span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapt</span><br>&gt;&#123;<br>C container;<br>â€¦<br><span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) <span class="hljs-keyword">operator</span>[] (std::<span class="hljs-type">size_t</span> idx) &#123;<br><span class="hljs-keyword">return</span> container[idx];<br>&#125;<br>&gt;&#125;;<br></code></pre></td></tr></table></figure>å¦‚æœ<code>container[idx]</code>ç”Ÿæˆä¸€ä¸ª<code>lvalue</code>ï¼Œæˆ‘ä»¬å¸Œæœ›å°†è¯¥å·¦å€¼ä¼ é€’ç»™è°ƒç”¨è€…ï¼ˆä»–å¯èƒ½å¸Œæœ›è·å–å…¶åœ°å€æˆ–ä¿®æ”¹å®ƒï¼‰ï¼šè¿™éœ€è¦ä¸€ä¸ªå·¦å€¼å¼•ç”¨ç±»å‹ï¼Œè¿™æ­£æ˜¯<code>decltype(auto)</code>è§£æåˆ°çš„ç±»å‹ã€‚å¦‚æœç”Ÿæˆå‡ºæ¥çš„æ˜¯<code>prvalue</code>(å†…ç½®ä¸‹è¡¨è¿ç®—ç¬¦åªå¯èƒ½äº§ç”Ÿ<code>lvalue</code>å’Œ<code>xvalue</code>ï¼Œè¿™é‡Œè¯´çš„æ˜¯å¦‚æœï¼ŒåŸå› åœ¨ã€Š<ahref="https://blog.csdn.net/Howl_1/article/details/122625409">C++prvalueï¼Œxvalueå’Œlvalueçš„ç›¸å…³çŸ¥è¯†</a>ã€‹ä¸­å·²é˜è¿°)ï¼Œåˆ™å¼•ç”¨ç±»å‹å°†å¯¼è‡´æ‚¬ç©ºå¼•ç”¨(danglingreferences)ï¼Œä½†å¹¸è¿çš„æ˜¯ï¼Œ<code>deltype(auto)</code>å°†ç”Ÿæˆè¿™ç§æƒ…å†µä¸‹çš„å¯¹è±¡ç±»å‹ï¼ˆè€Œä¸æ˜¯å¼•ç”¨ç±»å‹ï¼‰ã€‚</p><hr /><h2id="åœ¨é€’å½’æ¨¡æ¿ä¸­å»¶è¿Ÿè¿”å›ç±»å‹æ¨æ–­delaying-return-type-deduction-in-recursive-templates">åœ¨é€’å½’æ¨¡æ¿ä¸­å»¶è¿Ÿè¿”å›ç±»å‹æ¨æ–­ï¼ˆ<ahref="https://stackoverflow.com/questions/24109737/what-are-some-uses-of-decltypeauto#Delaying-return-type-deduction-in-recursive-templates">Delayingreturn type deduction in recursive templates</a>ï¼‰</h2><p>å½“æ¨¡æ¿çš„è¿”å›ç±»å‹è¢«æŒ‡å®šä¸º<code>decltype(iter(Int&lt;i-1&gt;&#123;&#125;))</code>è€Œä¸æ˜¯<code>decltype(auto)</code>æ—¶ï¼Œåœ¨æ¨¡æ¿å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ä¼šé‡åˆ°æ— é™é€’å½’ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-type">int</span> i&gt; <br>&gt;<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Int</span> &#123;&#125;;<br><br>&gt;<span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">iter</span><span class="hljs-params">(Int&lt;<span class="hljs-number">0</span>&gt;)</span> -&gt; Int&lt;0&gt;</span>;<span class="hljs-comment">//é€’å½’æ¨¡æ¿ç»“æŸåœ°æ–¹çš„å£°æ˜</span><br><br>&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-type">int</span> i&gt;<span class="hljs-comment">//éç±»å‹å‚æ•°ï¼ˆNontype Parameterï¼‰ã€Šc++primerã€‹p580</span><br>&gt;<span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> <span class="hljs-title">iter</span><span class="hljs-params">(Int&lt;i&gt;)</span> -&gt; <span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) </span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">iter</span>(Int&lt;i<span class="hljs-number">-1</span>&gt;&#123;&#125;);<br>&gt;&#125;<br>&gt;<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br><span class="hljs-keyword">decltype</span>(<span class="hljs-built_in">iter</span>(Int&lt;<span class="hljs-number">10</span>&gt;&#123;&#125;)) a;<br>&gt;&#125;<br></code></pre></td></tr></table></figure>è¿™é‡Œä½¿ç”¨<code>decltype(auto)</code>æ¥å»¶è¿Ÿè¿”å›ç±»å‹æ¨¡æ¿å®ä¾‹åŒ–çš„æ¨æ–­,ä»è€Œè§£å†³è¿”å›ç±»å‹å®ä¾‹åŒ–è¿‡æ—©å¼•å‘æ— é™é€’å½’çš„é—®é¢˜ã€‚</p><hr /><p>ä¸autoä¸åŒï¼Œ<code>delltype(auto)</code>ä¸å…è®¸ä¿®æ”¹å…¶ç±»å‹çš„è¯´æ˜ç¬¦æˆ–å£°æ˜ç¬¦æ“ä½œç¬¦ã€‚ä¾‹å¦‚ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>)* p = (<span class="hljs-type">void</span>*)<span class="hljs-literal">nullptr</span>; <span class="hljs-comment">// invalid</span><br>&gt;<span class="hljs-type">int</span> <span class="hljs-type">const</span> N = <span class="hljs-number">100</span>;<br>&gt;<span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) <span class="hljs-type">const</span> NN = N*N; <span class="hljs-comment">// invalid</span><br></code></pre></td></tr></table></figure> è¿˜è¦æ³¨æ„ï¼Œåˆå§‹åŒ–å™¨ä¸­çš„åœ†æ‹¬å·å¯èƒ½å¾ˆé‡è¦: <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-type">int</span> x;<br>&gt;<span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) z = x; <span class="hljs-comment">// object of type int</span><br>&gt;<span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) r = (x); <span class="hljs-comment">// reference of type int&amp;</span><br></code></pre></td></tr></table></figure>è¿™å°¤å…¶æ„å‘³ç€æ‹¬å·å¯èƒ½ä¼šä¸¥é‡å½±å“<code>return statements</code>çš„æœ‰æ•ˆæ€§ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span>;<br>&gt;â€¦<br>&gt;<span class="hljs-function"><span class="hljs-keyword">decltype</span>(<span class="hljs-keyword">auto</span>) <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-type">int</span> r = <span class="hljs-built_in">g</span>();<br><span class="hljs-keyword">return</span> (r); <span class="hljs-comment">// run-time ERROR: returns reference to temporary</span><br>&gt;&#125;<br></code></pre></td></tr></table></figure> untilC++17ï¼Œ<code>decltype(auto)</code>ä¹Ÿå¯ä»¥ç”¨äºå¯æ¨å¯¼çš„<code>éç±»å‹å‚æ•°</code>ï¼Œç”±äºåé¢c++20å°†å…¶å‰”é™¤ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸ç»§ç»­æ·±å…¥æ¢è®¨äº†ï¼ŒåŸå› æ˜¯ä¸€æ ·ï¼Œå¼Šå¤§äºåˆ©ï¼Œæ»¥ç”¨å°†å¯¼è‡´ç¨‹åºéš¾ä»¥ç†è§£ã€‚</p></blockquote><hr /><blockquote><p>æœ€åé—®å¤§å®¶ä¸€ä¸ªå°é—®é¢˜ï¼Œautoä¼šä¸ä¼šè®¡ç®—å‡ºè¡¨è¾¾å¼ç»“æœçš„å€¼ï¼Ÿï¼Œdecltypeä¼šä¸ä¼šè®¡ç®—å‡ºè¡¨è¾¾å¼ç»“æœçš„å€¼ï¼Ÿï¼Œdecltype(auto)å‘¢ï¼Ÿç›¸ä¿¡å¤§å®¶çœ‹å®Œæœ¬ç¯‡æ–‡ç« åï¼Œè¿™äº›é—®é¢˜å°±ä¼šä¸æ”»è‡ªç ´äº†ğŸ™‚ ã€‚å¦‚æœæœ¬ç¯‡æ–‡ç« å¸®æ‚¨è§£å†³äº†ç†è®ºä¸Šéš¾ä»¥ç†è§£çš„é—®é¢˜ï¼Œè®°å¾—ç‚¹ä¸ªèµå“¦ï¼</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>C++</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç”¨åæ±‡ç¼–åˆ†æc++RVOå¼€å¯å’Œå…³é—­æ—¶çš„åº•å±‚åŸç†ä»¥åŠC++prvalueï¼Œxvalueå’Œlvalueçš„ç›¸å…³çŸ¥è¯†</title>
    <link href="/2022/01/28/00004.%20%E7%94%A8%E5%8F%8D%E6%B1%87%E7%BC%96%E5%88%86%E6%9E%90c++RVO%E5%BC%80%E5%90%AF%E5%92%8C%E5%85%B3%E9%97%AD%E6%97%B6%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8AC++prvalue%EF%BC%8Cxvalue%E5%92%8Clvalue%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/01/28/00004.%20%E7%94%A8%E5%8F%8D%E6%B1%87%E7%BC%96%E5%88%86%E6%9E%90c++RVO%E5%BC%80%E5%90%AF%E5%92%8C%E5%85%B3%E9%97%AD%E6%97%B6%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8AC++prvalue%EF%BC%8Cxvalue%E5%92%8Clvalue%E7%9A%84%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><blockquote><p><strong>æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚</strong><br />æœ¬ç¯‡æ–‡ç« ä¸»è¦è®²è¿°C++prvalueï¼Œxvalueå’Œlvalueçš„ç›¸å…³çŸ¥è¯†ï¼Œä¼šç”¨åˆ°éƒ¨åˆ†intelå¼å’ŒATTå¼æ±‡ç¼–çš„çŸ¥è¯†ã€‚æˆ‘ä¼šåœ¨æ–‡ç« æœ«å°¾ç»™å‡ºæµ‹è¯•ä»£ç çš„åæ±‡ç¼–ä»£ç ä»¥åŠå³å€¼å¼•ç”¨ï¼ˆRvaluereferencesï¼‰å®˜æ–¹æ–‡æ¡£ ğŸ˜ƒã€‚--------------------------------------------------------</p></blockquote><h1 id="ä¸‰äº”æ³•åˆ™">ä¸‰äº”æ³•åˆ™</h1><blockquote><p>ä¸‰äº”æ³•åˆ™ï¼šæœ‰ææ„å°±åº”è¯¥æœ‰æ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—æ³•ï¼ˆ3ï¼‰ã€‚c++11ä¸‹ï¼Œä¸€ä¸ªç±»è¿˜å¯ä»¥æœ‰ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼ˆ3+2ï¼‰ã€‚ä¸‰äº”æ³•åˆ™æ—¶å€™ä¸€èˆ¬æƒ…å†µï¼Œå¦‚æœä¸æƒ³æŸä¸ªå‡½æ•°è¢«æ™®é€šæˆ–è€…å‹å…ƒä½¿ç”¨å¯ä»¥å°†å…¶å®šä¹‰ä¸º=deleteæˆ–è€…åœ¨privateé‡Œé¢å£°æ˜ä½†ä¸å®šä¹‰ï¼Œå…·ä½“å‚è€ƒC++primer p449ã€‚ç§»åŠ¨å‡½æ•°çš„å‡ºç°æé«˜äº†ç±»å†…å­˜è½¬è®©çš„æ•ˆç‡ï¼Œè€Œæ”¯æ‰¿è¿™ä¸€æŠ€æœ¯çš„åŸºç¡€å°±æ˜¯prvalue,xvalue,lvalue.(xvalueå’Œprvalueç»Ÿç§°ä¸ºrvalueï¼Œlvalueå’Œxvalueç»Ÿç§°ä¸ºglvalueã€‚åªéœ€è¦è®°ä½ä¸Šé¢è¯´çš„ä¸‰ç§å°±å¯ä»¥ï¼Œè¿™ä¸¤ä¸ªç»Ÿç§°å¯ä»¥ä¸ç”¨è®°)ã€‚è¿™ä¸‰ç§å€¼çš„å‡ºç°åœºåˆå’Œç‰¹ç‚¹åœ¨åæ–‡è¯¦ç»†è¯´æ˜ã€‚--------------------------------------------------------</p></blockquote><h1id="æœªå¼€å¯rvoä¼˜åŒ–ä¸xvalueå’Œprvalueçš„å…³ç³»">æœªå¼€å¯RVOä¼˜åŒ–ä¸xvalueå’Œprvalueçš„å…³ç³»</h1><blockquote><p>å…³é—­RVOçš„æ–¹æ³•:eg:<code>clang++ -g -fno-elide-constructors /home/dengye/test/test.cpp -o /home/dengye/test/test</code>å…ˆè®¾è®¡ä¸€ä¸ªä¸‰äº”æ³•åˆ™çš„ç±»ï¼Œå†åˆ†æå…³é—­å’Œå¼€å¯RVOæ—¶ç¨‹åºçš„å †æ ˆåˆ†å¸ƒå›¾ã€‚åºŸè¯ä¸å¤šè¯´å¼€æ•´ï¼</p></blockquote><p>## æµ‹è¯•ä»£ç  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">B</span>(<span class="hljs-type">int</span> val=<span class="hljs-number">0</span>):<span class="hljs-built_in">bVal</span>(val)&#123;&#125;<br>    <span class="hljs-comment">// B(const B&amp; tmp):bVal(tmp.bVal)&#123;&#125;</span><br>    ~<span class="hljs-built_in">B</span>()&#123;&#125;<br>    <span class="hljs-type">int</span> bVal;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Foo</span>(<span class="hljs-type">int</span> tmp = <span class="hljs-number">0</span>):<span class="hljs-built_in">ptrb</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">B</span>(tmp))<br>    &#123;<br>        std::cout&lt;&lt;<span class="hljs-string">&quot;æ„é€ å‡½æ•°&quot;</span>&lt;&lt;std::endl;<br>    &#125;<br>    <span class="hljs-built_in">Foo</span>(<span class="hljs-type">const</span> Foo&amp; src):<span class="hljs-built_in">ptrb</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">B</span>(*(src.ptrb)))<span class="hljs-comment">//ä¼šç»§ç»­è°ƒç”¨Bçš„æ‹·è´æ„é€ å‡½æ•°</span><br>    &#123;<br>        std::cout&lt;&lt;<span class="hljs-string">&quot;æ‹·è´æ„é€ å‡½æ•°&quot;</span>&lt;&lt;std::endl;<br>    &#125;<br>    Foo&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> Foo&amp; src)<br>    &#123;<br>        std::cout&lt;&lt;<span class="hljs-string">&quot;æ‹·è´èµ‹å€¼å‡½æ•°&quot;</span>&lt;&lt;std::endl;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == &amp;src)<br>            <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<span class="hljs-comment">//é˜²æ­¢è‡ªå·±ç»™è‡ªå·±èµ‹å€¼ã€‚</span><br>        <span class="hljs-keyword">delete</span> ptrb;<span class="hljs-comment">//å…ˆæŠŠè‡ªå·±çš„è¿™å—å†…å­˜å¹²æ‰</span><br>        ptrb = <span class="hljs-keyword">new</span> <span class="hljs-built_in">B</span>(*(src.ptrb));<br>        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;    <br>    &#125;<br>    <span class="hljs-built_in">Foo</span>(Foo&amp;&amp; src) <span class="hljs-keyword">noexcept</span> :<span class="hljs-built_in">ptrb</span>(src.ptrb)<span class="hljs-comment">//noexcept:é€šçŸ¥æ ‡å‡†åº“æˆ‘ä»¬è¿™ä¸ªç§»åŠ¨æ„é€ å‡½æ•°ä¸æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼ˆå¦‚æœç¼–è¯‘å™¨ç¡®è®¤å‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒå°±èƒ½æ‰§è¡ŒæŸäº›ç‰¹æ®Šçš„ä¼˜åŒ–æ“ä½œï¼Œè€Œè¿™äº›æ“ä½œä¸é€‚åˆç”¨äºå¯èƒ½å‡ºé”™çš„ä»£ç ï¼‰ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸Œæœ›åœ¨vectoré‡æ–°åˆ†é…å†…å­˜è¿™ç±»æƒ…å†µä¸‹å¯¹æˆ‘ä»¬è‡ªå®šä¹‰ç±»å‹çš„å¯¹è±¡è¿›è¡Œç§»åŠ¨è€Œä¸æ˜¯æ‹·è´ï¼Œå°±å¿…é¡»æ˜¾å¼åœ°å‘Šè¯‰æ ‡å‡†åº“æˆ‘ä»¬çš„ç§»åŠ¨æ„é€ å‡½æ•°å¯ä»¥å®‰å…¨ä½¿ç”¨ã€‚ã€Šc++primerã€‹p474ï¼Œ690ã€‚</span><br>    &#123;<br>        std::cout&lt;&lt;<span class="hljs-string">&quot;ç§»åŠ¨æ„é€ å‡½æ•°&quot;</span>&lt;&lt;std::endl;        <br>        src.ptrb = <span class="hljs-literal">nullptr</span>;<span class="hljs-comment">//è®°å¾—å°†åŸæ¥æŒ‡å‘å †å†…å­˜çš„æŒ‡é’ˆç½®ç©º.</span><br>    &#125;<br>    Foo&amp; <span class="hljs-keyword">operator</span>=(Foo&amp;&amp; src) <span class="hljs-keyword">noexcept</span><br>    &#123;<br>        std::cout&lt;&lt;<span class="hljs-string">&quot;ç§»åŠ¨èµ‹å€¼å‡½æ•°&quot;</span>&lt;&lt;std::endl;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == &amp;src)<br>            <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>        <span class="hljs-keyword">delete</span> ptrb;<br>        ptrb = src.ptrb;<span class="hljs-comment">//è¿™é‡Œä¸éœ€è¦åœ¨newï¼Œç›´æ¥ä»srcé‚£é‡Œæ‹¿æ¥</span><br>        src.ptrb = <span class="hljs-literal">nullptr</span>;<span class="hljs-comment">//è®°å¾—ç½®ç©º</span><br>        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;<br>    &#125;<br>    ~<span class="hljs-built_in">Foo</span>()<br>    &#123;<br>        std::cout&lt;&lt;<span class="hljs-string">&quot;ææ„å‡½æ•°&quot;</span>&lt;&lt;std::endl;<br>        <span class="hljs-keyword">delete</span> ptrb;<span class="hljs-comment">//åˆ ä¸€ä¸ªç©ºæŒ‡é’ˆæ²¡ä»»ä½•ååº”</span><br>    &#125;<br>    B *ptrb;<br>&#125;;<br><span class="hljs-function">Foo <span class="hljs-title">RVO_test</span><span class="hljs-params">(<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">Foo <span class="hljs-title">foo</span><span class="hljs-params">(val)</span></span>;<br>    <span class="hljs-keyword">return</span> foo;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    Foo fooRvo = <span class="hljs-built_in">RVO_test</span>(<span class="hljs-number">100</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>&gt;åœ¨åˆ†æä¹‹å‰æˆ‘å…ˆæŠŠè¯¥ç¨‹åºçš„å†…å­˜åˆ†å¸ƒå›¾ç”»å‡ºæ¥å¸®å¤§å®¶ç†è§£ï¼Œè§ä¸‹å›¾ï¼š</p><p><img src="/img/00004/1.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />&gt;åƒè¿™ç§randomoffsetçš„å‡ºç°ï¼Œå°±æ˜¯ä¸ºäº†é¿å…æº¢å‡ºæ”»å‡»ã€‚ç”»è¿™å¼ å›¾è¦ç”¨åˆ°<code>nm</code>å‘½ä»¤ï¼ˆå¯»æ‰¾ä»£ç æ®µï¼Œbssæ®µå’Œdataæ®µçš„èµ·å§‹åœ°å€ï¼‰ï¼Œgdbçš„<code>vmmap</code>å‘½ä»¤ï¼ˆå¯»æ‰¾å †æ ˆçš„èµ·å§‹å’Œç»“æŸåœ°å€ï¼‰ã€‚ç°è‰²éƒ¨åˆ†è¡¨ç¤ºè¿™äº›èŒƒå›´åœ¨è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ä¸å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡æœ‰ä¸ºè¿™äº›åŒºåŸŸåˆ›å»ºé¡µè¡¨ï¼ˆpagetableï¼‰ã€‚ --------------------------------------------------------</p><h2 id="åæ±‡ç¼–é…åˆå †æ ˆå›¾åˆ†ææµç¨‹">åæ±‡ç¼–é…åˆå †æ ˆå›¾åˆ†ææµç¨‹</h2><p><strong>å‹æƒ…æé†’ï¼šè¯·é…åˆé™„ä»¶ä¸­çš„åæ±‡ç¼–ä»£ç è¿›è¡Œåˆ†æã€‚</strong> <imgsrc="/img/00004/2.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /> <imgsrc="/img/00004/3.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p><blockquote><p>åˆ°è¾¾è¿™ä¸€æ­¥ä»¥å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šmainå‡½æ•°å¼€è¾Ÿå‡ºäº†0x20å­—èŠ‚çš„ç©ºé—´ï¼Œå°†rbp-0x18çš„åœ°å€ï¼ˆä¸´æ—¶å¯¹è±¡prvalueï¼‰ç»™äº†rdiï¼Œç„¶åå°†0x64ç»™äº†esiï¼Œæ¥ç€è°ƒç”¨äº†RVO_test(int)å‡½æ•°ï¼Œè¿˜æ²¡pushrbpã€‚</p></blockquote><hr /><figure><img src="/img/00004/4.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><figure><img src="/img/00004/5.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><h2id="åˆ°è¾¾è¿™ä¸€æ­¥ä»¥å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰rvo_testintå‡½æ•°å¼€è¾Ÿäº†0x30å­—èŠ‚çš„ç©ºé—´rdiå¯„å­˜å™¨å­˜ç€ä¸´æ—¶å¯¹è±¡prvalueçš„åœ°å€ç„¶åå°†å…¶èµ‹ç»™äº†rbp-0x8rbp-0x20rbp-0x28åˆå°†0x64èµ‹ç»™äº†rbp-0xcå½¢å‚valæœ€ååœ¨ä¸´æ—¶å¯¹è±¡fooçš„åœ°å€ä¸Šè¿›è¡Œäº†æ„é€ ">&gt;åˆ°è¾¾è¿™ä¸€æ­¥ä»¥å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šRVO_test(int)å‡½æ•°å¼€è¾Ÿäº†0x30å­—èŠ‚çš„ç©ºé—´ï¼Œrdiå¯„å­˜å™¨å­˜ç€ä¸´æ—¶å¯¹è±¡prvalueçš„åœ°å€ï¼Œç„¶åå°†å…¶èµ‹ç»™äº†rbp-0x8ï¼Œrbp-0x20ï¼Œrbp-0x28ï¼Œåˆå°†0x64èµ‹ç»™äº†rbp-0xcï¼ˆå½¢å‚valï¼‰ï¼Œæœ€ååœ¨ä¸´æ—¶å¯¹è±¡fooçš„åœ°å€ä¸Šè¿›è¡Œäº†æ„é€ ã€‚</h2><figure><img src="/img/00004/6.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><figure><img src="/img/00004/7.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><blockquote><p>åˆ°è¾¾è¿™ä¸€æ­¥ä»¥å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šç¼–è¯‘å™¨å°†rbp-0x18ï¼ˆå±€éƒ¨å¯¹è±¡fooï¼‰çš„å†…å®¹ç§»åŠ¨åˆ°äº†ä¸´æ—¶å¯¹è±¡çš„é‡Œé¢ã€‚æ­¤æ—¶å±€éƒ¨å¯¹è±¡çš„æŒ‡é’ˆæ•°æ®æˆå‘˜æŒ‡å‘ç©ºï¼Œåœ¨RVO_test(int)å‡½æ•°è¿”å›æ—¶ï¼Œä¼šææ„è¿™ä¸ªå±€éƒ¨å¯¹è±¡ï¼Œè€Œdeleteä¸€ä¸ªç©ºæŒ‡é’ˆæ²¡ä»»ä½•ååº”ã€‚æœ€åRVO_test(int)å‡½æ•°å°†rbp-0x28åœ°å€ä¸Šçš„å†…å®¹èµ‹ç»™raxä½œä¸ºè¿”å›å€¼ã€‚</p></blockquote><hr /><figure><img src="/img/00004/8.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><figure><img src="/img/00004/9.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><h2id="åˆ°è¾¾è¿™ä¸€æ­¥ä»¥å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰rvo_testintå‡½æ•°å›æ”¶äº†0x30å­—èŠ‚çš„ç©ºé—´pop-rbpæ—¶ä¼šå°†ä¿å­˜çš„mainå‡½æ•°çš„rbpåœ°å€å–å‡ºæ¥æ”¾åˆ°rbpæ ˆåŸºå€å¯„å­˜å™¨é‡Œé¢åŒæ—¶rspä¼š8æŒ‡å‘è¦è·³è½¬çš„ä»£ç æ®µæœ€åä¸€æ­¥æ²¡æ‰§è¡Œä¸éš¾çœ‹å‡ºretæ˜¯è®©ripæŒ‡ä»¤å¯„å­˜å™¨æŒ‡å‘rspçš„å†…å®¹å³è·³è½¬åˆ°main29">&gt;åˆ°è¾¾è¿™ä¸€æ­¥ä»¥å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šRVO_test(int)å‡½æ•°å›æ”¶äº†0x30å­—èŠ‚çš„ç©ºé—´ï¼Œpoprbpæ—¶ä¼šå°†ä¿å­˜çš„mainå‡½æ•°çš„rbpåœ°å€å–å‡ºæ¥æ”¾åˆ°rbpæ ˆåŸºå€å¯„å­˜å™¨é‡Œé¢ï¼ŒåŒæ—¶rspä¼š+8ï¼ŒæŒ‡å‘è¦è·³è½¬çš„ä»£ç æ®µã€‚æœ€åä¸€æ­¥æ²¡æ‰§è¡Œï¼Œä¸éš¾çœ‹å‡ºretæ˜¯è®©ripæŒ‡ä»¤å¯„å­˜å™¨æŒ‡å‘rspçš„å†…å®¹ï¼Œå³è·³è½¬åˆ°&lt;main+29&gt;ã€‚</h2><figure><img src="/img/00004/10.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><figure><img src="/img/00004/11.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><blockquote><p>åˆ°è¾¾è¿™ä¸€æ­¥ä»¥å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šä¸´æ—¶å¯¹è±¡çš„å†…å®¹è¢«ç§»åŠ¨èµ‹å€¼å‡½æ•°è½¬ç§»åˆ°äº†mainå‡½æ•°çš„å±€éƒ¨å¯¹è±¡fooRvoã€‚ç„¶åä¸´æ—¶å¯¹è±¡å°±è¢«ææ„äº†ï¼Œæ¥ç€mainå‡½æ•°å°†è¿”å›å€¼0èµ‹ç»™rbp-0x4æ‰€æŒ‡çš„ç©ºé—´ï¼Œæœ€åfooRvoå¯¹è±¡ä¹Ÿè¢«ææ„ã€‚ç¨‹åºéšä¹‹ç»“æŸã€‚</p></blockquote><hr /><h2 id="å°ç»“">å°ç»“</h2><blockquote><p>æ— RVOè¿”å›ä¼˜åŒ–ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆä¸€ä¸ªprvalueæˆ–è€…xvalueçš„<ahref="https://en.cppreference.com/w/cpp/language/implicit_conversion">ä¸´æ—¶å¯¹è±¡ï¼ˆTemporarymaterializationï¼‰</a>ï¼ˆã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p267ï¼‰ï¼Œå–å†³äºprvalueæ˜¯å¦å‡ºç°åœ¨ä¸¢å¼ƒå€¼è¡¨è¾¾å¼ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/expressions#Discarded-value_expressions">Discarded-valueexpressions</a>ï¼‰é‡Œã€‚åƒè¿™æ ·å†™<code>Foo fooRvo = RVO_test(100);</code>RVO_test(100)äº§ç”Ÿçš„ä¸´æ—¶å¯¹è±¡å°±æ˜¯prvalueï¼Œè¿™ç§prvalueè¢«ç§°ä¸º"æœ‰ä¸€ä¸ªç»“æœå¯¹è±¡"ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/value_category">suchprvalue is said to have a resultobject</a>ï¼‰ã€‚è€Œè¿™æ ·å†™<code>Foo fooRvo;fooRvo = RVO_test(100);</code>RVO_test(100)äº§ç”Ÿçš„ä¸´æ—¶å¯¹è±¡å°±æ˜¯xvalueï¼ŒåŸå› å°±æ˜¯prvalueå‡ºç°åœ¨äº†ä¸¢å¼ƒå€¼è¡¨è¾¾å¼é‡Œã€‚è¿™ç§è¡¨è¾¾å¼åŒ…æ‹¬äº†ä»»ä½•å®Œæ•´è¡¨è¾¾å¼è¯­å¥ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/expressions#Discarded-value_expressions">Suchexpressions include the full expression of any expressionstatement</a>ï¼‰ã€‚ç„¶åä¸´æ—¶å¯¹è±¡çš„åœ°å€ä¼šè¢«ä¼ å…¥åˆ°RVO_test(int)å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°ä¸­çš„å±€éƒ¨å¯¹è±¡fooåœ¨è¿”å›æ—¶è§¦å‘ç§»åŠ¨æ„é€ å‡½æ•°å°†fooçš„å†…å­˜è½¬è®©ç»™ä¸´æ—¶å¯¹è±¡ã€‚ä¸ºä»€ä¹ˆä¼šè§¦å‘ç§»åŠ¨æ„é€ å‡½æ•°å‘¢ï¼Ÿå½’åŠŸäºreturnè¯­å¥ï¼Œä¸€ä¸ªæ‹·è´æ“ä½œå‘ç”Ÿåœ¨returnè¯­å¥æ—¶ï¼Œä¼šè¢«å¿½ç•¥æˆ–è€…è¢«å¯¹å¾…æˆrvalueï¼Œç›®çš„åœ¨äºé€‰æ‹©ä¸€ä¸ªé‡è½½åçš„æ„é€ å‡½æ•°ï¼ˆNote:Acopy operation associated with a return statement may be elided orconsidered as an rvalue for the purpose of overload resolution inselecting a constructor (12.8). â€”end note,æœ¬å¥å­å‡ºè‡ª<ahref="https://en.cppreference.com/w/cpp/compiler_support/11">c++æ ‡å‡†æ‰‹å†Œæ–‡æ¡£-N2118çš„6.6.3- The returnstatement</a>ï¼‰ã€‚ç”±äºå³å€¼å¼•ç”¨å¯ä»¥æ¥å—ä¸€ä¸ªrvalueï¼Œè¿™ä¸ªè¢«returnè½¬åŒ–åçš„rvalueé€‰æ‹©äº†ç§»åŠ¨æ„é€ å‡½æ•°ã€‚è‡³æ­¤ä¸´æ—¶å¯¹è±¡è¢«æ„é€ å‡ºæ¥ï¼ŒRVO_test(int)å‡½æ•°çš„å±€éƒ¨å¯¹è±¡fooè¢«ææ„ã€‚è€Œä¸´æ—¶å¯¹è±¡prvalueï¼Œç”±äºèµ‹å€¼è¿ç®—ç¬¦çš„å­˜åœ¨ï¼Œä¼šå»è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œï¼ˆç»†å¿ƒçš„å°ä¼™ä¼´è‚¯å®šè¦é—®ä¸ºå•¥ä¸æ˜¯è°ƒç”¨é‡è½½åçš„ç§»åŠ¨èµ‹å€¼å‡½æ•°ï¼Œå¾ˆç®€å•ï¼èµ‹å€¼è¿ç®—ç¬¦åœ¨å®šä¹‰å¤„è¡¨ç°å‡ºæ¥çš„å½¢å¼ä¸ºæ„é€ è€Œä¸æ˜¯æ‹·è´ï¼‰ã€‚å¾…mainå‡½æ•°ä¸­çš„fooRvoå¯¹è±¡è¢«æ„é€ å‡ºæ¥åï¼Œä¸´æ—¶å¯¹è±¡ä¹Ÿè¢«ææ„ã€‚æœ€åfooRvoå¯¹è±¡è¢«ææ„ã€‚. è¿™æ˜¯clangç¼–è¯‘å™¨ä¸‹è¿è¡Œå®Œä»£ç çš„ç»“æœ:<br /><img src="/img/00004/12.png" alt="è¿™æ˜¯è¿è¡Œå®Œä»£ç çš„ç»“æœ" /></p><p>æ³¨æ„ï¼šMSVCç¼–è¯‘æœ‰æ¥ä½è¿™ä¸ªæ°‘é—´æ¦‚å¿µï¼Œä¹Ÿå°±è¯´<code>Foo fooRvo = RVO_test(100);</code>è¿™æ¡è¯­å¥ä¸­ï¼ŒRVO_testäº§ç”Ÿçš„ä¸´æ—¶å¯¹è±¡ä¼šè¢«fooRvoå¯¹è±¡æ¥ä½ï¼Œä»è€Œä¸æ‰§è¡Œå¯¹ä¸´æ—¶å¯¹è±¡çš„ææ„ã€‚æˆ–è€…è¯´fooRvoçš„ç©ºé—´å’Œä¸´æ—¶å¯¹è±¡çš„ç©ºé—´åˆäºŒä¸ºä¸€äº†ã€‚æˆ‘å¹³æ—¶å†™ä»£ç éƒ½æ˜¯ç”¨çš„clangç¼–è¯‘å™¨ï¼Œä»¥å‰åˆšå¼€å§‹å­¦c++æ˜¯åœ¨MSVCæ‰€ä»¥è¿™é‡Œå°±ç¨å¾®æåŠä¸€ä¸‹MSVCçš„ä¸åŒä¹‹å¤„ã€‚. è¿™æ˜¯MSVCç¼–è¯‘å™¨ä¸‹è¿è¡Œå®Œä»£ç çš„ç»“æœï¼š<br /><img src="/img/00004/13.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />--------------------------------------------------------</p></blockquote><h1 id="å¼€å¯rvoä¼˜åŒ–">å¼€å¯RVOä¼˜åŒ–</h1><blockquote><p>ä»£ç è¿˜æ˜¯ç”¨ä¸Šé¢çš„ä»£ç </p><p><img src="/img/00004/14.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /> <imgsrc="/img/00004/15.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p></blockquote><blockquote><p>ä¸Šé¢å·²ç»å¸¦ç€å¤§å®¶åˆ†æè¿‡ä¸€éäº†ï¼Œè¿™é‡Œå°±ç›´æ¥è·³åˆ°æœ€åçœ‹ç»“æœã€‚å¯¹æ¯”å…³é—­RVOæ¥è¯´ï¼ŒRVO_test(int)å‡½æ•°çš„å±€éƒ¨å¯¹è±¡å°±æ˜¯ç›´æ¥æ„é€ åˆ°fooRvoå¯¹è±¡é‡Œé¢å»äº†ï¼Œä¸­é—´ä¸€ä¸ªç§»åŠ¨æ„é€ éƒ½æ²¡æœ‰ã€‚é€šè¿‡åˆ†æåæ±‡ç¼–ä»£ç ä¸éš¾å‘ç°ï¼Œå®ƒä¸ºäº†ä¼˜åŒ–è¿”å›å±€éƒ¨å¯¹è±¡ï¼Œç›´æ¥è®©fooRvoå¯¹è±¡çš„å†…å­˜æ¥ç®¡äº†å±€éƒ¨å¯¹è±¡fooçš„ï¼Œå¯ä»¥è¯´æ˜¯åˆäºŒä¸ºä¸€äº†ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå±€éƒ¨å¯¹è±¡fooä¸€å®šè¦æ‰§è¡Œææ„å‡½æ•°å‘€ï¼åˆ«æ€¥ï¼Œå®ƒè¿™é‡Œå¦™æ‰‹å›æ˜¥ä¸€æ‰‹ï¼Œå°†ä¸€å­—èŠ‚çš„æ ‡å¿—ä½æ”¾åœ¨äº†RVO_test(int)å‡½æ•°çš„æ ˆå¸§ä¸­ï¼Œç„¶åé€šè¿‡åˆ¤æ–­æ ‡å¿—ä½è·³è¿‡å¯¹å±€éƒ¨å¯¹è±¡fooçš„ææ„å‡½æ•°æ‰§è¡Œã€‚è¿™ç©æ„å„¿æœ‰ç‚¹åƒåŠ äº†ifçš„gotoğŸ˜ƒã€‚ . è¿™æ˜¯clangç¼–è¯‘å™¨ä¸‹è¿è¡Œå®Œä»£ç çš„ç»“æœ:<br /><img src="/img/00004/16.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><br />æœ‰å…³ä¸´æ—¶å¯¹è±¡çš„è®¤è¯†å¯ä»¥å‚è€ƒã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p267</p></blockquote><hr /><h1 id="xvalueprvalueå’Œlvalue">xvalue,prvalueå’Œlvalue</h1><blockquote><p>è¿™é‡Œç¬”è€…å°±å¸®å¤§å®¶æŠŠå‘å¡«ä¸Šï¼Œç›¸ä¿¡å¤§å®¶å¯¹ä¸Šé¢æµ‹è¯•ä»£ç åˆ†æè¿‡åä¼šå¯¹prvalueå’Œxvalueæœ‰ä¸ªåˆæ­¥çš„å°è±¡ï¼Œå³å‡½æ•°è¿”å›æ—¶å¯èƒ½ä¼šæ¶‰åŠåˆ°å®ƒä»¬ã€‚å¯¹äºè¿™ä¸‰ç§å€¼çš„æ¦‚è¿°ï¼šæ¯ä¸€ä¸ªc++çš„è¡¨è¾¾å¼ï¼ˆä½œç”¨åœ¨è¿ç®—å¯¹è±¡ä¸Šçš„é‡è½½æ“ä½œç¬¦ï¼Œå­—é¢å¸¸é‡ï¼Œä¸€ä¸ªå˜é‡åï¼Œ"a= b"ï¼ˆan assignmentexpressionï¼‰ï¼Œetc.ï¼‰éƒ½ä¼šæœ‰ä¸¤ä¸ªç‹¬ç«‹çš„å±æ€§ï¼šä¸€ç§ç±»å‹ï¼Œä¸€ä¸ªå€¼çš„ç±»åˆ«ã€‚æ¯ä¸ªè¡¨è¾¾å¼éƒ½æœ‰ä¸€äº›éå¼•ç”¨ç±»å‹ï¼Œå¹¶ä¸”æ¯ä¸ªè¡¨è¾¾å¼éƒ½æ°å¥½å±äºä¸‰ä¸ªä¸»è¦å€¼ç±»åˆ«ä¸­çš„ä¸€ä¸ª:prvalueã€xvalueå’Œlvalueã€‚è¿™ä¸‰ç§å€¼æ²¡æœ‰ä¸€ä¸ªç¡®åˆ‡çš„å®šä¹‰ï¼Œæˆ–è€…è¯´ä½ è¦åºŸå¾ˆå¤§åŠŸå¤«å»å®šä¹‰å®ƒä»¬ï¼Œäº¦æˆ–è€…æè¿°ä¸ªå¤§æ¦‚å³å¯ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹è¿™ä¸‰ç§å€¼ç±»å‹çš„æ¦‚è¦å®šä¹‰ä»¥åŠç‰¹æ€§ï¼ˆå®Œæ•´è¯·å‚è€ƒ<ahref="https://en.cppreference.com/w/cpp/language/value_category">Valuecategories</a>ï¼‰ï¼šï¼ˆè¡¥å……ä¸€å¥ï¼Œæ£€æµ‹è¡¨è¾¾å¼çš„å€¼ç±»åˆ«çš„ç›¸å…³ä»£ç ï¼Œæˆ‘æ”¾åœ¨äº†é™„å½•ä¸­ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡ŒéªŒè¯æ„Ÿåˆ°ç–‘æƒ‘çš„åœ°æ–¹ï¼‰- lvaluelvalueï¼šæ‰€è°“å·¦å€¼ï¼Œä»å†å²çš„è§’åº¦æ¥è€ƒè™‘ï¼Œå®ƒå¯ä»¥å‡ºç°åœ¨ä¸€ä¸ªèµ‹å€¼è¡¨è¾¾å¼çš„å·¦è¾¹ã€‚èµ„æºå¯ä»¥è¢«é‡ç”¨ï¼ˆresourcescan be reusedï¼‰ã€‚æœ‰ç©ºé—´åœ°å€ä½†ä¸èƒ½è¢«ç§»åŠ¨ - ä¸€èˆ¬æœ‰åå­—ï¼Œé™¤äº† unamedlvalueï¼ˆ<code>*ptr</code>æ˜¯ä¸€ä¸ªæ²¡æœ‰åå­—çš„lvalueï¼Œä¸€ä¸ªè¿”å›å€¼ä¸ºlvaluereferenceçš„å‡½æ•°è°ƒç”¨è¡¨è¾¾å¼ä¹Ÿæ˜¯æ²¡åå­—çš„lvalueï¼‰ï¼Œå¦‚æœæœ‰å•ç‹¬çš„ä¸€ä¸ªidentifier æ¥è¡¨ç¤ºå®ƒï¼Œå®ƒä¸€å®šæ˜¯ lvalue - å¯ä»¥ç”¨ &amp;ç¬¦å·å–å…¶åœ°å€ï¼Œé™¤äº†bit fieldï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/bit_field">The type ofa bit field can only be integral or enumeration type.</a>ï¼‰ -ä¸€ä¸ªå‡½æ•°æˆ–è€…é‡è½½æ“ä½œç¬¦çš„è¿”å›å€¼ä¸ºlvalue reference ä¾‹å¦‚<code>std::getline(std::cin, str) or std::cout &lt;&lt; 1 or str1 = str2 or ++iter</code>- å…¶ç”Ÿå‘½å‘¨æœŸä¸ºå…¶æ‰€åœ¨çš„ scope - ä¸€äº›å†…ç½®æ“ä½œç¬¦è¡¨è¾¾å¼å†…ç½®å‰è‡ªå¢è‡ªå‡ï¼Œè§£å¼•ç”¨ï¼Œå†…ç½®ä¸‹æ ‡è¡¨è¾¾å¼ï¼ˆ<code>a[n]</code>æ˜¯ä¸€ä¸ªlvalueçš„æƒ…å†µä¸‹ï¼‰ï¼Œç±»ç±»å‹çš„å†…ç½®æˆå‘˜è®¿é—®è¡¨è¾¾å¼ï¼ˆé™¤äº†è®¿é—®æšä¸¾æ•°æ®æˆå‘˜å’Œéé™æ€æˆå‘˜å‡½æ•°ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹ä¾‹è¯·å‚è€ƒ<ahref="https://en.cppreference.com/w/cpp/language/value_category">Primarycategories</a>ï¼‰ï¼Œé€—å·è¡¨è¾¾å¼ï¼ˆæœ€å³è¾¹çš„æ“ä½œæ•°ä¸ºlvalueçš„æƒ…å†µä¸‹ï¼‰ï¼Œä¸‰å…ƒæ¡ä»¶è¡¨è¾¾å¼ï¼ˆç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªæ“ä½œæ•°ä¸ºlvalueçš„æƒ…å†µä¸‹ï¼‰- å°†è¡¨è¾¾å¼å¼ºåˆ¶è½¬æ¢ä¸ºå·¦å€¼å¼•ç”¨ç±»å‹å’Œå³å€¼å¼•ç”¨å‡½æ•°ç½²åç±»å‹ï¼ˆ<ahref="https://en.cppreference.com/book/intro/functions">The signature ofa function</a>ï¼‰ ä¾‹å¦‚ <code>static_cast&lt;int&amp;&gt;(x)</code> ä¾‹å¦‚<code>static_cast&lt;void (&amp;&amp;)(int)&gt;(x)</code> - åœ¨æ‰€æœ‰literal ä¸­ï¼Œåªæœ‰ string literal æ˜¯lvalueï¼š<code>cout &lt;&lt; &amp;"dy" &lt;&lt; endl</code>;ï¼ˆå…¶ä»–literal æ˜¯ rvalueï¼š<code>cout &lt;&lt; &amp;'d' &lt;&lt; endl</code>;éæ³•ï¼‰ ## lvalueçš„ç‰¹æ€§ï¼š -å¯ä»¥é€šè¿‡å–å€è¿ç®—ç¬¦è·å–å…¶åœ°å€ï¼Œ<code>&amp;++i[1]</code> and<code>&amp;std::endl</code>åƒè¿™æ ·çš„è¡¨è¾¾å¼éƒ½æ˜¯åˆæ³•çš„ -å¯ä¿®æ”¹çš„å·¦å€¼å¯ç”¨ä½œå†…ç½®èµ‹å€¼å’Œ<ahref="https://en.cppreference.com/w/cpp/language/operator_assignment#Builtin_compound_assignment">å†…ç½®å¤åˆèµ‹å€¼è¿ç®—</a>ç¬¦çš„å·¦æ“ä½œæ•°- å¯ä»¥ç”¨æ¥åˆå§‹åŒ–å·¦å€¼å¼•ç”¨ï¼Œè¿™ä¸ªå·¦å€¼å¼•ç”¨å°†æ˜¯lvalueçš„åˆ«åã€‚ -lvalueå¯ä»¥è¢«éšå¼åœ°è½¬æ¢ä¸ºprvalueå°±åƒlvalue-to-rvalue, array-to-pointer,orfunction-to-pointerçš„éšå¼è½¬æ¢ã€‚ï¼ˆ<code>int ival1 = 1;int ival2 = -ival1;</code>ï¼Œè¿™é‡Œå‡å·å¯ä»¥lvalueéšå¼è½¬æ¢æˆprvalueï¼‰- å¯ä»¥æ˜¯å¤šæ€çš„ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/object#Polymorphic_objects">Polymorphic</a>ï¼‰ï¼Œå®ƒæ‰€å¯¹åº”çš„<ahref="https://en.cppreference.com/w/cpp/language/type#Dynamic_type">åŠ¨æ€ç±»å‹</a>å’Œé™æ€ç±»å‹å¯ä»¥ä¸ä¸€æ ·ï¼Œä¾‹å¦‚ï¼šä¸€ä¸ªæŒ‡å‘å­ç±»çš„çˆ¶ç±»æŒ‡é’ˆ- å¯ä»¥æ˜¯<ahref="https://en.cppreference.com/w/cpp/language/type#Incomplete_type">ä¸å®Œæ•´ç±»å‹</a>ï¼Œåªè¦è¡¨è¾¾å¼å…è®¸ã€‚ä¾‹å¦‚ï¼šç”±å‰ç½®å£°æ˜ä½†æœªå®šä¹‰çš„ç±»ç±»å‹- xvaluexvalueï¼šä¸€ä¸ªå°†è¦åˆ°æœŸçš„å€¼ï¼ˆç”Ÿå‘½å‘¨æœŸè¢«å»¶é•¿ï¼‰ï¼Œèµ„æºå¯ä»¥è¢«é‡ç”¨çš„å¯¹è±¡ã€‚æœ‰ç©ºé—´åœ°å€å¯ä»¥è¢«ç§»åŠ¨ã€‚- ä¸€ä¸ªå‡½æ•°è°ƒç”¨æˆ–è€…é‡è½½æ“ä½œç¬¦å‡½æ•°è¡¨è¾¾å¼çš„è¿”å›å€¼ä¸ºrvalue reference ä¾‹å¦‚<code>std::move(x)</code>ï¼› - å°†è¡¨è¾¾å¼çš„ç±»å‹å¼ºåˆ¶è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ç±»å‹ã€‚ä¾‹å¦‚<code>(int&amp;&amp;)a</code>ï¼Œ<code>static_cast&lt;int&amp;&amp;&gt;(a)</code>ã€‚- å†…ç½®ä¸‹æ ‡è¡¨è¾¾å¼ï¼ˆ<code>a[n]</code>ä¸ºä¸€ä¸ªxvalueçš„æƒ…å†µä¸‹ï¼‰ã€‚ -ç±»ç±»å‹çš„å†…ç½®æˆå‘˜è®¿é—®è¡¨è¾¾å¼ã€‚ ä¾‹å¦‚<code>a.m</code>æ˜¯ä¸€ä¸ªxvalueï¼Œaæ˜¯xvalueï¼Œmæ˜¯éå¼•ç”¨ç±»å‹çš„éé™æ€æ•°æ®æˆå‘˜ã€‚ ä»¥åŠ<code>a.*mp</code>æ˜¯ä¸€ä¸ª xvalueã€‚aæ˜¯xvalueï¼Œmp å«åš pointer to datamemberï¼ˆã€Šc++primerã€‹p739ï¼‰ã€‚ -ä¸‰å…ƒæ¡ä»¶è¡¨è¾¾å¼ï¼ˆç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªæ“ä½œæ•°ä¸ºxvalueçš„æƒ…å†µä¸‹ï¼‰ -æŒ‡å®šä¸´æ—¶å¯¹è±¡çš„ä»»ä½•è¡¨è¾¾å¼ï¼ˆé™¤äº†prvalue initializes anobjectçš„æƒ…å†µï¼‰(since C++17) ## xvalueçš„ç‰¹æ€§ï¼š -å¯ä»¥è¢«ç»‘å®šåˆ°å³å€¼å¼•ç”¨å’Œconstå·¦å€¼å¼•ç”¨ï¼ŒåŒæ—¶ç”Ÿå‘½å‘¨æœŸè¢«å»¶é•¿åˆ°è¿™ä¸ªå¼•ç”¨çš„ä½œç”¨åŸŸç»“æŸ- xvalueå¯ä»¥å…·æœ‰å¤šæ€æ€§ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/object#Polymorphic_objects">Polymorphic</a>ï¼‰- éç±»ç±»å‹çš„xvalueå¯ä»¥è¢«constå’Œvolatileä¿®é¥°ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/cv">cv typequalifiers</a>ï¼‰ - xvalueå¯ä»¥è¢«éšå¼åœ°è½¬æ¢ä¸ºprvalueå°±åƒlvalue-to-rvalue,array-to-pointer, or function-to-pointerçš„éšå¼è½¬æ¢ï¼ˆ<code>int ival = 1;if((int&amp;&amp;)ival)&#123;putchar('Y');&#125;</code>xvalueè¢«éšå¼è½¬æ¢æˆäº†prvalueï¼‰- å¯ä»¥æ˜¯ä¸å®Œæ•´ç±»å‹ - ä¸èƒ½è¢«å–åœ°å€ï¼ˆé€šè¿‡å†…ç½®å–åœ°å€è¿ç®—ç¬¦ï¼‰ -ä¸èƒ½æ˜¯å†…ç½®èµ‹å€¼å’Œ<ahref="https://en.cppreference.com/w/cpp/language/operator_assignment#Builtin_compound_assignment">å†…ç½®å¤åˆèµ‹å€¼è¿ç®—</a>ç¬¦çš„å·¦æ“ä½œæ•°-å½“ä½œç”¨åœ¨å‡½æ•°å‚æ•°æ—¶ï¼Œæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½éƒ½å¯ç”¨ï¼Œä¸€ä¸ªæ˜¯å³å€¼å¼•ç”¨å‚æ•°ï¼Œå¦ä¸€ä¸ªæ˜¯constå·¦å€¼å¼•ç”¨å‚æ•°ï¼Œä¸€ä¸ªxrvalueä¼šç»‘å®šåˆ°å‚æ•°ä¸ºå³å€¼å¼•ç”¨çš„é‡è½½å‡½æ•°ä¸Šï¼ˆå› æ­¤ï¼Œæ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°éƒ½å­˜åœ¨æ—¶ï¼Œä¸€ä¸ªxrvalueä¼šå»è°ƒç”¨ç§»åŠ¨æ„é€ è€Œä¸æ˜¯æ‹·è´æ„é€ ï¼ŒåŒç†ä½œç”¨äºæ‹·è´å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼‰- prvalueprvalueï¼šä¸€ä¸ªå°†è¦æ¶ˆäº¡çš„å€¼ï¼ˆç”Ÿå‘½å‘¨æœŸé©¬ä¸Šç»“æŸï¼‰ï¼Œèµ„æºä¸å¯ä»¥è¢«é‡ç”¨ï¼ˆæƒ³è¦è¢«é‡ç”¨å¿…é¡»è½¬åŒ–æˆxvalueï¼‰çš„å¯¹è±¡ã€‚ä¸€éƒ¨åˆ†æœ‰ç©ºé—´åœ°å€ä½†é©¬ä¸Šå°±ä¼šè¢«å›æ”¶ï¼ˆç©ºé—´åœ°å€å¯ä»¥è¢«åé¢çš„æ–°æ•°æ®è¦†ç›–ï¼‰ï¼Œä¸€éƒ¨åˆ†æ²¡æœ‰ç©ºé—´åœ°å€ã€‚å¯ä»¥è¢«ç§»åŠ¨ã€‚- æ‰€æœ‰ literalsï¼šbool literal (ä¾‹å¦‚<code>true</code>)ï¼Œinteger literal(ä¾‹å¦‚ <code>42</code>) ç­‰ç­‰ï¼ˆæ— ç©ºé—´åœ°å€ï¼‰ã€‚ -å®è´¨ä¸Šçš„å‡½æ•°è°ƒç”¨ï¼š(<strong>return non-reference</strong>)ï¼ˆæœ‰ç©ºé—´åœ°å€ï¼‰<code>f()</code>function call <img src="/img/00004/17.png"alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p><p><code>a.f()</code>static or non-static member function<code>A()</code> åŒ…æ‹¬å„ç§æ„é€ å‡½æ•° <code>str1 + str2</code> é‡è½½ operatorä¹Ÿç›¸å½“äºå‡½æ•°è°ƒç”¨ <code>functor()</code> (å¯¹åº” operator() é‡è½½)<code>[]&#123;&#125;()</code>lambda (å¯¹åº” operator() é‡è½½) -ä¸€äº›å†…ç½®æ“ä½œç¬¦äº§ç”Ÿçš„è¿ç®—ç»“æœï¼ˆæ— ç©ºé—´åœ°å€ï¼‰ï¼š <code>a++</code> è‡ªå¢è‡ªå‡<code>a+b</code> åŠ å‡ä¹˜é™¤ <code>a&amp;b</code> ä½è¿ç®—<code>a&amp;&amp;b</code> é€»è¾‘è¿ç®— <code>a&lt;b</code> å…³ç³»è¿ç®—<code>&amp;a</code> å–åœ°å€ <code>a, b</code> comma expression (å¦‚æœb æ˜¯rvalue) <code>(int)a</code> æˆ– static_cast&lt; int&gt;(a) å¼ºåˆ¶ç±»å‹è½¬æ¢<code>a ? b : c</code>ï¼ˆç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªæ“ä½œæ•°ä¸ºrvalueçš„æƒ…å†µä¸‹ï¼‰ -enumerator æšä¸¾å€¼ï¼ˆæ— ç©ºé—´åœ°å€ï¼‰ï¼š <code>enum &#123; yes, no &#125;;</code> ä¸­çš„yes, no <code>a.m</code> æˆ– <code>p-&gt;m</code>ï¼Œå…¶ä¸­ m æ˜¯ memberenumerator - æ™®é€šæˆå‘˜å‡½æ•°æœ¬èº«ï¼ˆ<ahref="https://en.cppreference.com/book/intro/functions">The signature ofa function</a>ï¼‰ï¼ˆæ— ç©ºé—´åœ°å€ï¼‰ <code>a.m</code> æˆ– <code>p-&gt;m</code>æˆ– <code>a.*pm</code> æˆ– <code>p-&gt;*pm</code>ï¼Œå…¶ä¸­ m å’Œ pméƒ½å¯¹åº”æ™®é€šæˆå‘˜å‡½æ•°(non-static) - this æŒ‡é’ˆï¼ˆæœ‰ç©ºé—´åœ°å€ï¼‰è¢«å½“åšå‚æ•°ä¼ è¿›å»æ”¾åœ¨æ ˆå¸§ä¸Šã€‚ ## prvalueçš„ç‰¹æ€§ï¼š - ä¸ä¼šæ˜¯å¤šæ€çš„ -éç±»éæ•°ç»„çš„prvalueä¸èƒ½è¢«cv-qualifiedä¿®é¥°ï¼Œé™¤éå®ƒä¸ºäº†è¢«ç»‘å®šåˆ°ä¸€ä¸ªcv-qualifiedçš„å¼•ç”¨ç±»å‹ä¸Šè€Œè½¬æ¢åŒ–æˆxvalue(since C++17)ï¼Œ ä¾‹å¦‚ï¼š<code>const int&amp; i = 1ï¼›</code>(æ³¨æ„ï¼šä¸€ä¸ªå‡½æ•°è°ƒç”¨æˆ–è€…å¼ºåˆ¶ç±»å‹è½¬æ¢è¡¨è¾¾å¼ä¼šå¯¼è‡´ç”Ÿæˆä¸€ä¸ªéç±»cv-qualifiedç±»å‹ï¼Œä½†æ˜¯cv-qualifieré€šå¸¸ä¼šç«‹å³è¢«å‰¥ç¦»ã€‚)- prvalueä¸èƒ½æœ‰ä¸å®Œæ•´çš„ç±»å‹ï¼ˆä½¿ç”¨decltypeæŒ‡ç¤ºç¬¦æ—¶ä¹Ÿä¸èƒ½æœ‰ï¼Œé™¤äº†voidï¼‰ -prvalueä¸èƒ½æœ‰æŠ½è±¡ç±»ç±»å‹æˆ–è€…an arraythereofï¼ˆä¸å¤ªæ‡‚å®˜æ–¹è¦è¡¨è¾¾çš„æ„æ€ï¼Œæ‰€ä»¥å°±ä»¥è‹±æ–‡æ–¹å¼æ”¾åœ¨è¿™é‡Œä¾›å¤§å®¶å‚è€ƒï¼‰â˜¹ï¸- ä¸èƒ½è¢«å–åœ°å€ï¼ˆé€šè¿‡å†…ç½®å–åœ°å€è¿ç®—ç¬¦ï¼‰ - ä¸èƒ½æ˜¯å†…ç½®èµ‹å€¼å’Œ<ahref="https://en.cppreference.com/w/cpp/language/operator_assignment#Builtin_compound_assignment">å†…ç½®å¤åˆèµ‹å€¼è¿ç®—</a>ç¬¦çš„å·¦æ“ä½œæ•°-å½“ä½œç”¨åœ¨å‡½æ•°å‚æ•°æ—¶ï¼Œæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½éƒ½å¯ç”¨ï¼Œä¸€ä¸ªæ˜¯å³å€¼å¼•ç”¨å‚æ•°ï¼Œå¦ä¸€ä¸ªæ˜¯constå·¦å€¼å¼•ç”¨å‚æ•°ï¼Œä¸€ä¸ªprvalueä¼šç»‘å®šåˆ°å‚æ•°ä¸ºå³å€¼å¼•ç”¨çš„é‡è½½å‡½æ•°ä¸Šï¼ˆå› æ­¤ï¼Œæ‹·è´å’Œç§»åŠ¨æ„é€ å‡½æ•°éƒ½å­˜åœ¨æ—¶ï¼Œä¸€ä¸ªprvalueä¼šå»è°ƒç”¨ç§»åŠ¨æ„é€ è€Œä¸æ˜¯æ‹·è´æ„é€ ï¼ŒåŒç†ä½œç”¨äºæ‹·è´å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼‰</p></blockquote><hr /><h1 id="temporary-materialization">Temporary materialization</h1><blockquote><p>ç»è¿‡å¯¹xvalue,prvalueå’Œlvalueå¯¹è®¤è¯†åï¼Œå’±ä»¬æ¥èŠèŠä¸´æ—¶å¯¹è±¡ï¼Œé™¤äº†xvalueå¯ä»¥è¢«ç§°ä¸ºä¸´æ—¶å¯¹è±¡ï¼Œprvalueåœ¨æŸäº›æƒ…å†µä¸‹ä¹Ÿå¯ä»¥è¢«ç§°ä¸ºä¸´æ—¶å¯¹è±¡ã€‚ä»ä¸€ä¸ªä»»ä½•å®Œæ•´ç±»å‹Tçš„prvalueè½¬æ¢ä¸ºç›¸åŒç±»å‹Tçš„xvalueçš„è¿‡ç¨‹è¢«ç§°ä¸ºä¸´æ—¶ç‰©åŒ–ï¼ˆTemporarymaterializationï¼‰ã€‚è¯¥è½¬æ¢å°†prvalueä½œä¸ºå…¶ç»“æœå¯¹è±¡æ±‚å€¼ï¼Œä»è€Œå°†prvalueåˆå§‹åŒ–ä¸ºTç±»å‹çš„ä¸´æ—¶å¯¹è±¡ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªè¡¨ç¤ºä¸´æ—¶å¯¹è±¡çš„xvalue(sinceC++17)ã€‚å¦‚æœTæ˜¯ä¸€ä¸ªç±»æˆ–è€…ç±»ç±»å‹çš„æ•°ç»„ï¼Œå®ƒå¿…é¡»å…·æœ‰å¯è®¿é—®ä¸”æœªåˆ é™¤çš„ææ„å‡½æ•°ã€‚Temporary materialization ä¼šå‘ç”Ÿåœ¨ä¸‹åˆ—æƒ…å†µä¸­ï¼š<strong>(sinceC++17)</strong> - ç»‘å®šä½œç”¨äºprvalueæ—¶<code>int&amp;&amp; c = 1;const int&amp; c = 1;</code>cç»‘å®šçš„æ˜¯ä¸€ä¸ªxvalue- åœ¨ä¸€ä¸ªprvalueç±»ä¸Šä½¿ç”¨æˆå‘˜è®¿é—®è¿ç®—ç¬¦æ—¶ <code>A().m;</code>pvalue A()è‡ªåŠ¨å˜æˆä¸€ä¸ª xvlaue <code>A().*mp;</code> pvalue A() è‡ªåŠ¨å˜æˆä¸€ä¸ª xvlaue- prvalueæ•°ç»„è½¬å˜æˆä¸€ä¸ªæŒ‡é’ˆæˆ–è¢«ç»‘å®šæ—¶ï¼Œæˆ–è€…ç”¨ä¸‹æ ‡è®¿é—®ä¸€ä¸ªprvalueæ•°ç»„1.prvalueæ•°ç»„è¢«ç»‘å®šæ—¶<code>int (&amp;&amp; a)[2] = (int[])&#123;1, 2&#125;;</code>2.prvalueæ•°ç»„è½¬å˜æˆä¸€ä¸ªæŒ‡é’ˆæ—¶<code>[](int* iptr)&#123;std::cout&lt;&lt;*iptr;&#125;((int[])&#123;1,2&#125;);</code>å¯¹äºä¸€ä¸ªå¯¹è±¡æˆ–è€…ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¦‚æœå¯ä»¥å¯¹å…¶ä½¿ç”¨è°ƒç”¨è¿ç®—ç¬¦ï¼Œåˆ™ç§°å®ƒä¸ºå¯è°ƒç”¨å¯¹è±¡(ã€Šc++primerã€‹p345)3.ç”¨ä¸‹æ ‡è®¿é—®ä¸€ä¸ªprvalueæ•°ç»„æ—¶ <code>((int[])&#123;1, 2&#125;)[0];</code> -å½“ä»å¸¦æ‹¬å·çš„åˆ—è¡¨åˆå§‹åŒ–åˆå§‹åŒ–std::initializer_list<T>ç±»å‹çš„å¯¹è±¡æ—¶;ã€Šc++primerã€‹p197 - typidä½œç”¨äºä¸€ä¸ªprvalueæ—¶ ã€Šc++primerã€‹p732 -sizeofä½œç”¨äºä¸€ä¸ªprvalueæ—¶ - å½“ä¸€ä¸ªprvalueå‡ºç°åœ¨ä¸¢å¼ƒå€¼è¡¨è¾¾å¼ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/expressions#Discarded-value_expressions">Discarded-valueexpressions</a>ï¼‰ ä¸Šæ–‡ç ”ç©¶å¼€å¯RVOæ—¶è®²è¿‡ã€‚ -æ³¨æ„ï¼šå½“ä»ç›¸åŒç±»å‹çš„prvalueåˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶(é€šè¿‡ç›´æ¥åˆå§‹åŒ–æˆ–å¤åˆ¶åˆå§‹åŒ–)ä¸ä¼šå‘ç”Ÿä¸´æ—¶ç‰©åŒ–:è¿™æ ·çš„å¯¹è±¡æ˜¯ç›´æ¥ä»åˆå§‹åŒ–å™¨åˆå§‹åŒ–çš„ã€‚è¿™ç¡®ä¿äº†â€œæ‹·è´å‰¯æœ¬çš„çœç•¥(RVOçš„å·¥ä½œæœºåˆ¶)â€ã€‚ï¼ˆä¸Šæ–‡ç ”ç©¶å¼€å¯RVOæ—¶è®²è¿‡ï¼Œprvalueå¯ä»¥ç”¨æ¥åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ç§prvalueè¢«ç§°ä¸º"æœ‰ä¸€ä¸ªç»“æœå¯¹è±¡"ï¼ˆ<ahref="https://en.cppreference.com/w/cpp/language/value_category">suchprvalue is said to have a result object</a>ï¼‰ï¼‰ <imgsrc="/img/00004/18.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p><p>é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼ä»ä¸€ä¸ªä»»ä½•å®Œæ•´ç±»å‹Tçš„prvalueè½¬æ¢ä¸ºç›¸åŒç±»å‹Tçš„xvalueçš„è¿‡ç¨‹è¢«ç§°ä¸ºä¸´æ—¶ç‰©åŒ–ä»ä¸€ä¸ªä»»ä½•å®Œæ•´ç±»å‹Tçš„prvalueè½¬æ¢ä¸ºç›¸åŒç±»å‹Tçš„xvalueçš„è¿‡ç¨‹è¢«ç§°ä¸ºä¸´æ—¶ç‰©åŒ–ä»ä¸€ä¸ªä»»ä½•å®Œæ•´ç±»å‹Tçš„prvalueè½¬æ¢ä¸ºç›¸åŒç±»å‹Tçš„xvalueçš„è¿‡ç¨‹è¢«ç§°ä¸ºä¸´æ—¶ç‰©åŒ–</p></blockquote><hr /><h1 id="å¼•ç”¨æŠ˜å ä¸‡èƒ½å¼•ç”¨å¼•ç”¨å¡Œç¼©">å¼•ç”¨æŠ˜å ï¼ˆä¸‡èƒ½å¼•ç”¨ï¼Œå¼•ç”¨å¡Œç¼©ï¼‰</h1><blockquote><p>ä¸Šé¢è¯´è¿‡ç§»åŠ¨æ“ä½œçš„å‡ºç°æé«˜äº†ç±»å†…å­˜è½¬è®©çš„æ•ˆç‡ï¼Œè€Œæ”¯æ‰¿è¿™ä¸€æŠ€æœ¯çš„åŸºç¡€å°±æ˜¯prvalue,xvalue,lvalueã€‚ä½†å³å€¼å¼•ç”¨æ‰æ˜¯ç§»åŠ¨æ“ä½œèƒ½å®ç°çš„æ ¹æœ¬åŸå› ã€‚è¿™é‡Œå’±ä»¬å¥½å¥½è®²ä¸€è®²å³å€¼å¼•ç”¨çš„ç›¸å…³çŸ¥è¯†å¼•ç”¨æŠ˜å ï¼ˆå…³äºå³å€¼å¼•ç”¨çš„åŸºç¡€çŸ¥è¯†è¯·å‚çœ‹ã€Šc++primerã€‹p471è¿™é‡Œä¸å¤šèµ˜è¿°ï¼‰ã€‚å¼•ç”¨æŠ˜å çš„ä¸¤ä¸ªè§„åˆ™è¢«ç§°ä¸ºC++è¯­è¨€åœ¨æ­£å¸¸ç»‘å®šè§„åˆ™ä¹‹å¤–å®šä¹‰çš„ä¸¤ä¸ªä¾‹å¤–è§„åˆ™ï¼Œå…è®¸è¿™ç§ç»‘å®šã€‚è€Œè¿™ä¸¤ä¸ªä¾‹å¤–è§„åˆ™æ˜¯moveè¿™ç§æ ‡å‡†æ¨¡æ¿åº“è®¾æ–½æ­£ç¡®å·¥ä½œçš„åŸºç¡€ã€‚å…ˆä»‹ç»ä¸€ä¸‹å®ƒçš„ä¸¤ä¸ªè§„åˆ™ï¼š -.è§„åˆ™ä¸€ï¼šå¯¹äºä¸€ä¸ªç»™å®šç±»å‹<code>T</code>ï¼Œå½“æˆ‘ä»¬å°†ä¸€ä¸ªå·¦å€¼ä¼ ç»™æ¨¡æ¿å‡½æ•°çš„å³å€¼å¼•ç”¨å‚æ•°æ—¶ï¼Œç¼–è¯‘å™¨æ¨æ–­æ¨¡æ¿ç±»å‹å‚æ•°Tä¸ºå·¦å€¼å¼•ç”¨ç±»å‹ï¼ˆT&amp;ï¼‰ï¼Œä¾‹å¦‚å¯¹äº<code>int</code>ç±»å‹çš„å·¦å€¼æ—¶ï¼Œæ¨æ–­<code>T</code>ä¸º<code>int&amp;</code>ï¼›å½“æˆ‘ä»¬å°†ä¸€ä¸ªå³å€¼ä¼ è¿›å»æ—¶ï¼Œ<code>T</code>è¢«æ¨æ–­å‡ºæ¥çš„ç±»å‹ä¸º<code>T</code>ï¼Œä¾‹å¦‚å¯¹äº<code>int</code>ç±»å‹çš„å³å€¼æ—¶ï¼Œæ¨æ–­<code>T</code>ä¸º<code>int</code>ã€‚-ä¾‹å¤–è§„åˆ™äºŒï¼šå¦‚æœæˆ‘ä»¬é—´æ¥åˆ›å»ºäº†ä¸€ä¸ªå¼•ç”¨çš„å¼•ç”¨ï¼Œåˆ™è¿™äº›å¼•ç”¨å½¢æˆäº†å¼•ç”¨æŠ˜å ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸èƒ½ç›´æ¥åˆ›å»ºå¼•ç”¨çš„å¼•ç”¨ï¼Œä½†æ˜¯å¯ä»¥é—´æ¥åˆ›å»ºï¼ˆå¦‚ç±»å‹åˆ«åå’Œæ¨¡æ¿å‚æ•°ï¼‰ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¼•ç”¨çš„å¼•ç”¨ä¼šæŠ˜å ä¸ºæ™®é€šçš„å·¦å€¼å¼•ç”¨ï¼ˆT&amp;&amp;ã€T&amp; &amp;&amp;ã€ T&amp;&amp;&amp;éƒ½ä¼šæŠ˜å æˆç±»å‹T&amp;ï¼‰ï¼Œå³å€¼å¼•ç”¨å’Œå³å€¼å¼•ç”¨ï¼Œåˆ™æŠ˜å æˆå³å€¼å¼•ç”¨ï¼ˆT&amp;&amp;&amp;&amp;æŠ˜å æˆT&amp;&amp;ï¼‰ã€‚ã€Šc++primerã€‹p608</p></blockquote><hr /><h2id="å¯¹ä¸Šé¢ä¸¤ä¸ªè§„åˆ™ç†Ÿç»ƒåæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ ‡å‡†åº“moveå‡½æ•°">å¯¹ä¸Šé¢ä¸¤ä¸ªè§„åˆ™ç†Ÿç»ƒåï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹æ ‡å‡†åº“moveå‡½æ•°:</h2><blockquote><p>è™½ç„¶ä¸èƒ½ç›´æ¥å°†ä¸€ä¸ªå³å€¼å¼•ç”¨ç»‘å®šåˆ°ä¸€ä¸ªå·¦å€¼ä¸Šï¼Œä½†å¯ä»¥ç”¨moveè·å¾—ä¸€ä¸ªç»‘å®šåˆ°å·¦å€¼ä¸Šçš„xvalueã€‚ç”±äºmoveæœ¬è´¨ä¸Šå¯ä»¥æ¥å—ä»»ä½•ç±»å‹çš„å®å‚ï¼Œå› æ­¤æˆ‘ä»¬ä¸ä¼šæƒŠè®¶äºä»–ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ã€‚- std::moveæ˜¯å¦‚ä½•å®šä¹‰çš„ <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;<br>&gt;<span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">typename</span> std::remove_reference&lt;T&gt;::type&amp;&amp;<br>&gt;<span class="hljs-built_in">move</span>(T&amp;&amp; t) <span class="hljs-keyword">noexcept</span><br>&gt;&#123; <br>&gt;<span class="hljs-keyword">return</span> <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">typename</span> std::remove_reference&lt;T&gt;::type&amp;&amp;&gt;(t); <br>&gt;&#125;<br></code></pre></td></tr></table></figure>åœ¨è¿”å›ç±»å‹å’Œç±»å‹è½¬æ¢ä¸­ä¹Ÿè¦ç”¨åˆ°<code>typename</code>ï¼ˆã€Šc++primerã€‹p593ï¼‰ã€‚<code>std::remove_reference&lt;T&gt;::type</code>çš„ç”¨å¤„å°±æ˜¯å»é™¤ç±»å‹çš„å¼•ç”¨ï¼ˆã€Šc++primerã€‹p605ï¼‰ã€‚<code>static_cast</code>é™æ€ç±»å‹è½¬æ¢ï¼ˆã€Šc++primerã€‹p145ï¼‰ã€‚- std::moveæ˜¯å¦‚ä½•å·¥ä½œçš„</p><p>è¿™æ®µä»£ç å¾ˆçŸ­ï¼Œä½†å…¶ä¸­æœ‰äº›å¾®å¦™ä¹‹å¤„ã€‚é¦–å…ˆï¼Œmoveçš„å‡½æ•°å‚æ•°<code>T&amp;&amp;</code>æ˜¯ä¸€ä¸ªæŒ‡å‘æ¨¡æ¿ç±»å‹å‚æ•°çš„å³å€¼å¼•ç”¨ã€‚é€šè¿‡å¼•ç”¨æŠ˜å ï¼Œæ­¤å‚æ•°å¯ä»¥ä¸ä»»ä½•ç±»å‹çš„å®å‚åŒ¹é…ã€‚ç‰¹åˆ«æ˜¯ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥ä¼ é€’ç»™moveä¸€ä¸ªå·¦å€¼ï¼Œä¹Ÿå¯ä»¥ä¼ é€’ç»™å®ƒä¸€ä¸ªå³å€¼:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-function">string <span class="hljs-title">s1</span> <span class="hljs-params">( <span class="hljs-string">&quot;hi! &quot;</span>)</span>,s2</span>;<br>&gt;s2 = std::<span class="hljs-built_in">move</span> (<span class="hljs-built_in">string</span> ( <span class="hljs-string">&quot;bye!&quot;</span>) );<span class="hljs-comment">//æ­£ç¡®:ä»ä¸€ä¸ªå³å€¼ç§»åŠ¨æ•°æ®</span><br>&gt;s2 = std::<span class="hljs-built_in">move</span>(s1);<span class="hljs-comment">//æ­£ç¡®:ä½†åœ¨èµ‹å€¼ä¹‹åï¼Œs1çš„å€¼æ˜¯ä¸ç¡®å®šçš„(å†…å®¹è¢«ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ç§»åŠ¨è¿‡)ã€‚</span><br></code></pre></td></tr></table></figure>åœ¨ç¬¬ä¸€ä¸ªèµ‹å€¼ä¸­ï¼Œä¼ é€’ç»™moveçš„å®å‚æ˜¯stringçš„æ„é€ å‡½æ•°çš„å³å€¼ç»“æœã€‚åœ¨<code>std::move(string("bye!"))</code>ä¸­:1. æ¨æ–­å‡ºçš„Tçš„ç±»å‹ä¸ºstringã€‚ 2. å› æ­¤remove_referenceç”¨stringè¿›è¡Œå®ä¾‹åŒ–ã€‚3. remove_reference<string>çš„typeæˆå‘˜æ˜¯stringã€‚ 4.moveçš„è¿”å›ç±»å‹æ˜¯string&amp;&amp;ã€‚ 5.moveçš„å‡½æ•°å‚æ•°tçš„ç±»å‹ä¸ºstring&amp;&amp;ã€‚</p><p>å› æ­¤ï¼Œè¿™ä¸ªè°ƒç”¨å®ä¾‹åŒ–move<string>ï¼Œå³å‡½æ•°<code>string&amp;&amp; move(string &amp;&amp;t)</code></p><p>å‡½æ•°ä½“è¿”å›<code>static_cast&lt;string&amp;&amp;&gt;(t)</code>ã€‚<code>t</code>çš„ç±»å‹å·²ç»æ˜¯<code>string&amp;&amp;</code>,äºæ˜¯ç±»å‹è½¬æ¢ä»€ä¹ˆéƒ½ä¸åšã€‚å› æ­¤ï¼Œæ­¤è°ƒç”¨çš„ç»“æœå°±æ˜¯å®ƒæ‰€æ¥å—çš„å³å€¼å¼•ç”¨ï¼ˆè¿”å›å€¼ä¸ºå³å€¼å¼•ç”¨ç±»å‹æœ‰ä¸´æ—¶å¯¹è±¡äº§ç”Ÿï¼‰ã€‚..ç°åœ¨è€ƒè™‘ç¬¬äºŒä¸ªèµ‹å€¼ï¼Œå®ƒè°ƒç”¨äº†<code>std::move ()</code>ã€‚åœ¨æ­¤è°ƒç”¨ä¸­ï¼Œä¼ é€’ç»™moveçš„å®å‚æ˜¯ä¸€ä¸ªå·¦å€¼ã€‚è¿™æ ·:1. æ¨æ–­å‡ºçš„Tçš„ç±»å‹ä¸ºstring&amp; (string çš„å¼•ç”¨ï¼Œè€Œéæ™®é€šstring)ã€‚ 2.å› æ­¤ï¼Œremove referenceç”¨string&amp;è¿›è¡Œå®ä¾‹åŒ–ã€‚ 3. removereference&lt;string&amp;&gt;çš„typeæˆå‘˜æ˜¯stringã€‚ 4.moveçš„è¿”å›ç±»å‹ä»æ˜¯string&amp;&amp; ã€‚ 5.moveçš„å‡½æ•°å‚æ•°tå®ä¾‹åŒ–ä¸ºstring&amp; &amp;&amp;ï¼Œä¼šæŠ˜å ä¸ºstring&amp;ã€‚</p><p>å› æ­¤ï¼Œè¿™ä¸ªè°ƒç”¨å®ä¾‹åŒ–<code>move&lt;string&amp;&gt;</code>ï¼Œå³<code>string&amp;&amp;  move(string &amp;t)</code>è¿™æ­£æ˜¯æˆ‘ä»¬æ‰€å¯»æ±‚çš„â€”æˆ‘ä»¬å¸Œæœ›å°†ä¸€ä¸ªå³å€¼å¼•ç”¨ç»‘å®šåˆ°ä¸€ä¸ªå·¦å€¼ã€‚è¿™ä¸ªå®ä¾‹çš„å‡½æ•°ä½“è¿”å›<code>static_cast&lt;string&amp;&amp;&gt;(t)</code>ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œ<code>t</code>çš„ç±»å‹ä¸º<code>string&amp;</code>ï¼Œcastå°†å…¶è½¬æ¢ä¸º<code>string&amp;&amp;</code>(å¼ºè½¬ä¼´éšä¸´æ—¶å¯¹è±¡xvalueçš„äº§ç”Ÿå…¶ç©ºé—´åœ°å€ä¸<code>std::move()</code>å‡½æ•°äº§ç”Ÿçš„ä¸´æ—¶å¯¹è±¡xvalueçš„ç©ºé—´åœ°å€ç›¸åŒ)ã€‚<img src="/img/00004/19.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />å°†å³å€¼å¼•ç”¨ç»‘å®šåˆ°ä¸€ä¸ªè¢«å¼ºè½¬æˆxvalueçš„å·¦å€¼ï¼Œè¿™ä¸€ç‰¹æ€§è¢«ç§°ä¸ºæˆªæ–­ã€‚ï¼ˆã€Šc++primerã€‹p612ï¼‰### std::move()å‡½æ•°æ€»ç»“è¯´ç™½äº†<code>std::move()</code>å‡½æ•°å°±æ˜¯å°†ä¸€ä¸ªprvalueæˆ–è€…lvalueè½¬å˜æˆxvalueçš„è¿‡ç¨‹ï¼Œè¿™æ ·ä¸ç®¡æ˜¯prvalueè¿˜æ˜¯lvalueéƒ½å¯ä»¥è¢«å³å€¼å¼•ç”¨æ¥å—ã€‚</p></blockquote><hr /><h2id="æ¥ä¸‹æ¥å’±ä»¬æ¥åˆ†ææ ‡å‡†åº“forwardå‡½æ•°">æ¥ä¸‹æ¥å’±ä»¬æ¥åˆ†ææ ‡å‡†åº“forwardå‡½æ•°:</h2><blockquote><p>åœ¨åˆ†æforwardæºç ä¹‹å‰ï¼Œå’±ä»¬å…ˆæ¥çœ‹çœ‹forwardå®Œæˆäº†ä¸€ä¸ªä»€ä¹ˆæ ·çš„åŠŸèƒ½ã€‚æˆ‘ä»¬çŸ¥é“æŸäº›å‡½æ•°éœ€è¦å°†å…¶ä¸€ä¸ªæˆ–å¤šä¸ªå®å‚è¿åŒç±»å‹ä¸å˜åœ°è½¬å‘ç»™å…¶ä»–å‡½æ•°ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿æŒè¢«è½¬å‘å®å‚çš„æ‰€æœ‰æ€§è´¨,åŒ…æ‹¬å®å‚ç±»å‹æ˜¯å¦æ˜¯<code>const</code>çš„ä»¥åŠå®å‚æ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼ã€‚ä½œä¸ºä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå¯è°ƒç”¨è¡¨è¾¾å¼å’Œä¸¤ä¸ªé¢å¤–å®å‚ã€‚æˆ‘ä»¬çš„å‡½æ•°å°†è°ƒç”¨ç»™å®šçš„å¯è°ƒç”¨å¯¹è±¡ï¼Œå°†ä¸¤ä¸ªé¢å¤–å‚æ•°é€†åºä¼ é€’ç»™å®ƒã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬çš„ç¿»è½¬å‡½æ•°çš„æ¨¡æ ·:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//æ¥å—ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡å’Œå¦å¤–ä¸¤ä¸ªå‚æ•°çš„æ¨¡æ¿</span><br><span class="hljs-comment">//å¯¹â€œç¿»è½¬â€çš„å‚æ•°è°ƒç”¨ç»™å®šçš„å¯è°ƒç”¨å¯¹è±¡</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> F, <span class="hljs-keyword">typename</span> T1,<span class="hljs-keyword">typename</span> T2&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">flip2</span><span class="hljs-params">(F f,T1 &amp;&amp;t1,T2 &amp;&amp;t2)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">f</span> (t2,t1);<br>)<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">(<span class="hljs-type">int</span> v1,<span class="hljs-type">int</span> &amp;v2)</span></span><br><span class="hljs-function"></span>&#123;<br>std::cout &lt;&lt; v1 &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; ++v2 &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>é€šè¿‡å°†ä¸€ä¸ªå‡½æ•°å‚æ•°å®šä¹‰ä¸ºä¸€ä¸ªæŒ‡å‘æ¨¡æ¿ç±»å‹å‚æ•°çš„å³å€¼å¼•ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä¿æŒå…¶å¯¹åº”å®å‚çš„æ‰€æœ‰ç±»å‹ä¿¡æ¯ã€‚è€Œä½¿ç”¨å¼•ç”¨å‚æ•°(æ— è®ºæ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼)ä½¿å¾—æˆ‘ä»¬å¯ä»¥ä¿æŒ<code>const</code>å±æ€§ï¼Œå› ä¸ºåœ¨å¼•ç”¨ç±»å‹ä¸­çš„<code>const</code>æ˜¯åº•å±‚çš„ã€‚å¦‚æœæˆ‘ä»¬å°†å‡½æ•°å‚æ•°å®šä¹‰ä¸º<code>T1&amp;&amp;</code>å’Œ<code>T2&amp;&amp;</code>,é€šè¿‡å¼•ç”¨æŠ˜å ï¼Œå°±å¯ä»¥ä¿æŒç¿»è½¬åå®å‚çš„å·¦å€¼/å³å€¼å±æ€§ï¼ˆå¯¹åº”å®å‚çš„<code>const</code>å±æ€§å’Œå·¦å€¼/å³å€¼å±æ€§å°†å¾—åˆ°ä¿æŒï¼‰:ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨<code>flip2(fï¼Œjï¼Œ42)</code>ï¼Œå°†ä¼ é€’ç»™å‚æ•°<code>t1</code>ä¸€ä¸ªå·¦å€¼<code>j</code>ã€‚ä½†æ˜¯ï¼Œåœ¨<code>flip2</code>ä¸­ï¼Œæ¨æ–­å‡ºçš„<code>T1</code>çš„ç±»å‹ä¸º<code>int&amp;</code>ï¼Œè¿™æ„å‘³ç€<code>t1</code>çš„ç±»å‹ä¼šæŠ˜å ä¸º<code>int&amp;</code>ã€‚ç”±äºæ˜¯å¼•ç”¨ç±»å‹ï¼Œ<code>t1</code>è¢«ç»‘å®šåˆ°<code>j</code>ä¸Šã€‚å½“<code>flip2</code>è°ƒç”¨<code>f</code>æ—¶ï¼Œ<code>f</code>ä¸­çš„å¼•ç”¨å‚æ•°<code>v2</code>è¢«ç»‘å®šåˆ°<code>t1</code>ï¼Œä¹Ÿå°±æ˜¯è¢«ç»‘å®šåˆ°<code>j</code>ã€‚å½“<code>f</code>é€’å¢<code>v2</code>æ—¶ï¼Œå®ƒä¹ŸåŒæ—¶æ”¹å˜äº†<code>j</code>çš„å€¼ã€‚. ç°åœ¨ï¼Œå’±ä»¬ä¸ç”¨å¯è°ƒç”¨å¯¹è±¡<code>f</code>ï¼Œç”¨<code>g</code>ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//æ¥å—ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡å’Œå¦å¤–ä¸¤ä¸ªå‚æ•°çš„æ¨¡æ¿</span><br><span class="hljs-comment">//å¯¹â€œç¿»è½¬â€çš„å‚æ•°è°ƒç”¨ç»™å®šçš„å¯è°ƒç”¨å¯¹è±¡</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> F, <span class="hljs-keyword">typename</span> T1,<span class="hljs-keyword">typename</span> T2&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">flip2</span><span class="hljs-params">(F f,T1 &amp;&amp;t1,T2 &amp;&amp;t2)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">g</span>(t2,t1);<br>)<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;&amp;i, <span class="hljs-type">int</span>&amp; j)</span></span><br><span class="hljs-function"></span>&#123;<br>std::cout &lt;&lt; i &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; j &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>å¦‚æœæˆ‘ä»¬è¯•å›¾é€šè¿‡<code>flip2</code>è°ƒç”¨<code>g</code>ï¼Œåˆ™å‚æ•°<code>t2</code>å°†è¢«ä¼ é€’ç»™<code>g</code>çš„å³å€¼å¼•ç”¨å‚æ•°ã€‚å³ä½¿æˆ‘ä»¬ä¼ é€’ä¸€ä¸ªå³å€¼ç»™<code>flip2</code>:<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">flip2</span>(g, iï¼Œ<span class="hljs-number">42</span>);<span class="hljs-comment">//é”™è¯¯:ä¸èƒ½ä»ä¸€ä¸ªå·¦å€¼å®ä¾‹åŒ–int&amp;&amp;</span><br></code></pre></td></tr></table></figure>ä¼ é€’ç»™<code>g</code>çš„å°†æ˜¯<code>flip2</code>ä¸­åä¸º<code>t2</code>çš„å‚æ•°ã€‚å‡½æ•°å‚æ•°ä¸å…¶ä»–ä»»ä½•å˜é‡ä¸€æ ·ï¼Œéƒ½æ˜¯å·¦å€¼è¡¨è¾¾å¼ã€‚å› æ­¤ï¼Œ<code>flip2</code>ä¸­å¯¹<code>g</code>çš„è°ƒç”¨å°†ä¼ é€’ç»™<code>g</code>çš„å³å€¼å¼•ç”¨å‚æ•°ä¸€ä¸ªå·¦å€¼ã€‚ .åœ¨è°ƒç”¨ä¸­ä½¿ç”¨<code>std::forward</code>ä¿æŒç±»å‹ä¿¡æ¯ .æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªåä¸ºforwardçš„æ–°æ ‡å‡†åº“è®¾æ–½æ¥ä¼ é€’<code>flip2</code>çš„å‚æ•°,å®ƒèƒ½ä¿æŒåŸå§‹å®å‚çš„ç±»å‹ã€‚ç±»ä¼¼move,forwardå®šä¹‰åœ¨å¤´æ–‡ä»¶utilityä¸­ã€‚ä¸moveä¸åŒ,forwardå¿…é¡»é€šè¿‡æ˜¾å¼æ¨¡æ¿å®å‚æ¥è°ƒç”¨ã€‚forwardè¿”å›è¯¥æ˜¾å¼å®å‚ç±»å‹çš„å³å€¼å¼•ç”¨ã€‚å³ï¼Œ<code>forward&lt;T&gt;</code>çš„è¿”å›ç±»å‹æ˜¯<code>T&amp;&amp;</code>ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨forwardä¼ é€’é‚£äº›å®šä¹‰ä¸ºæ¨¡æ¿ç±»å‹å‚æ•°çš„å³å€¼å¼•ç”¨çš„å‡½æ•°å‚æ•°ã€‚é€šè¿‡å…¶è¿”å›ç±»å‹ä¸Šçš„å¼•ç”¨æŠ˜å ï¼Œforwardå¯ä»¥ä¿æŒç»™å®šå®å‚çš„å·¦å€¼/å³å€¼å±æ€§(forwardå¯ä»¥ä¿æŒå®å‚ç±»å‹çš„æ‰€æœ‰ç»†èŠ‚)ã€‚ä½¿ç”¨forwardï¼Œæˆ‘ä»¬å¯ä»¥å†æ¬¡é‡å†™ç¿»è½¬å‡½æ•°: <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> F,<span class="hljs-keyword">typename</span> T1,<span class="hljs-keyword">typename</span> T2&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">flip</span><span class="hljs-params">(F f,T1 &amp;&amp;t1,T2 &amp;&amp;t2)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">g</span>(std::forward&lt;T2&gt;(t2),std::forward&lt;T1&gt;(t1)) ;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;&amp;i, <span class="hljs-type">int</span>&amp; j)</span></span><br><span class="hljs-function"></span>&#123;<br>std::cout &lt;&lt; i &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; j &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>å¦‚æœæˆ‘ä»¬è°ƒç”¨<code>flip(g, iï¼Œ42)</code>ï¼Œ<code>i</code>å°†ä»¥<code>int&amp;</code>ç±»å‹ä¼ é€’ç»™<code>g</code>ï¼Œ<code>42</code>å°†ä»¥<code>int&amp;&amp;</code>ç±»å‹çš„<code>xvalue</code>ä¼ é€’ç»™<code>g</code>ã€‚ï¼ˆprimeræ²¡è¯´æ¸…æ¥šï¼Œå•çº¯å› ä¸º42æ˜¯int&amp;&amp;ç±»å‹æ˜¯æ— æ³•ä¼ ç»™å¯è°ƒç”¨å¯¹è±¡gã€‚lvalueå¯ä»¥æ˜¯int&amp;&amp;ç±»å‹ï¼Œxvalueä¹Ÿå¯ä»¥æ˜¯int&amp;&amp;ç±»å‹ï¼Œä½†æ˜¯lvalueä¸èƒ½ä¼ ç»™å³å€¼å¼•ç”¨ï¼Œè€Œxvalueå¯ä»¥ã€‚ï¼‰</p></blockquote><hr /><blockquote><p>ç°åœ¨å’±ä»¬çŸ¥é“forwardæ˜¯å¹²ä»€ä¹ˆçš„äº†ã€‚åºŸè¯ä¸å¤šè¯´ç›´æ¥åˆ†æå®ƒçš„æºç ï¼Œçœ‹çœ‹å®ƒå¦‚ä½•ä¿æŒå®å‚ç±»å‹çš„æ‰€æœ‰ç»†èŠ‚ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> _Tp&gt;</span><br><span class="hljs-function"><span class="hljs-keyword">constexpr</span> _Tp&amp;&amp;</span><br><span class="hljs-function"><span class="hljs-title">forward</span><span class="hljs-params">(<span class="hljs-keyword">typename</span> std::remove_reference&lt;_Tp&gt;::type&amp; <span class="hljs-type">_t</span>)</span> <span class="hljs-keyword">noexcept</span></span><br><span class="hljs-function"></span>&#123; <br><span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;_Tp&amp;&amp;&gt;(<span class="hljs-type">_t</span>); <br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> _Tp&gt;</span><br><span class="hljs-function"><span class="hljs-keyword">constexpr</span> _Tp&amp;&amp;</span><br><span class="hljs-function"><span class="hljs-title">forward</span><span class="hljs-params">(<span class="hljs-keyword">typename</span> std::remove_reference&lt;_Tp&gt;::type&amp;&amp; <span class="hljs-type">_t</span>)</span> <span class="hljs-keyword">noexcept</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">static_assert</span>(!std::is_lvalue_reference&lt;_Tp&gt;::value, <span class="hljs-string">&quot;template argument&quot;</span><br>    <span class="hljs-string">&quot; substituting _Tp is an lvalue reference type&quot;</span>);    <br><span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;_Tp&amp;&amp;&gt;(<span class="hljs-type">_t</span>);<br>&#125;<br></code></pre></td></tr></table></figure><code>std::forward</code>æœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„é‡è½½ï¼Œä¸€ä¸ªç”¨äºå·¦å€¼ä¸€ä¸ªç”¨äºå³å€¼ã€‚ä¸è¿‡å’±ä»¬ä¸€èˆ¬ç”¨çš„æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå› ä¸ºç”¨åœ¨å½¢å‚ä¸Šï¼Œå½¢å‚ä¸ç®¡æ€ä¹ˆæ ·éƒ½æ˜¯ä¸ªå·¦å€¼ã€‚é‚£æˆ‘ä»¬å°±åªåˆ†æç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„æƒ…å†µï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> F,<span class="hljs-keyword">typename</span> T1,<span class="hljs-keyword">typename</span> T2&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">flip</span><span class="hljs-params">(F f,T1 &amp;&amp;t1,T2 &amp;&amp;t2)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">g</span>(std::forward&lt;T2&gt;(t2),std::forward&lt;T1&gt;(t1)) ;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;&amp;i, <span class="hljs-type">int</span>&amp; j)</span></span><br><span class="hljs-function"></span>&#123;<br>std::cout &lt;&lt; i &lt;&lt; <span class="hljs-string">&quot; &quot;</span> &lt;&lt; j &lt;&lt; std::endl;<br>&#125;<br></code></pre></td></tr></table></figure>å°±æ‹¿ä¸Šé¢è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨<code>flip(g, iï¼Œ42)</code>ã€‚<code>T2</code>å°†è¢«æ¨å¯¼æˆ<code>int</code>ï¼Œ<code>t2</code>çš„ç±»å‹ä¸º<code>int&amp;&amp;</code>ã€‚è°ƒç”¨<code>std::forward&lt;T2&gt;(t2)</code>æ—¶ï¼Œforwardå‡½æ•°å°†è¢«å®ä¾‹åŒ–æˆï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span>&amp;&amp;</span><br><span class="hljs-function"><span class="hljs-title">forward</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; <span class="hljs-type">_t</span>)</span> <span class="hljs-keyword">noexcept</span></span><br><span class="hljs-function"></span>&#123; <br>   <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&amp;&amp;&gt;(<span class="hljs-type">_t</span>); <br>&#125;<br></code></pre></td></tr></table></figure><code>_t</code>çš„ç±»å‹ä¸º<code>int&amp;</code>ï¼Œreturnæ—¶<code>_t</code>è¢«å¼ºåˆ¶è½¬æ¢æˆ<code>int&amp;&amp;</code>ï¼Œæ­¤æ—¶å¼ºè½¬äº§ç”Ÿçš„<code>xvalue</code>å’Œforwardå‡½æ•°ç”±è¿”å›ç±»å‹<code>int&amp;&amp;</code>è€Œäº§ç”Ÿçš„<code>xvalue</code>åœ¨åŒä¸€ç©ºé—´åœ°å€ã€‚<code>xvalue</code>å¯ä»¥è¢«å‡½æ•°<code>g</code>çš„å½¢å‚<code>i</code>æ‰€æ¥å—ï¼Œå®Œæˆ<code>flip</code>å®å‚<code>42</code>çš„ç±»å‹ä¿æŒã€‚</p><p><code>T1</code>å°†è¢«æ¨å¯¼æˆ<code>int&amp;</code>ï¼Œ<code>t1</code>çš„ç±»å‹è¢«æŠ˜å æˆ<code>int&amp;</code>ã€‚è°ƒç”¨<code>std::forward&lt;T1&gt;(t1)</code>æ—¶ï¼Œforwardå‡½æ•°å°†è¢«å®ä¾‹åŒ–æˆï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span>&amp;</span><br><span class="hljs-function"><span class="hljs-title">forward</span><span class="hljs-params">(<span class="hljs-type">int</span>&amp; <span class="hljs-type">_t</span>)</span> <span class="hljs-keyword">noexcept</span></span><br><span class="hljs-function"></span>&#123; <br>   <span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">int</span>&amp;&gt;(<span class="hljs-type">_t</span>); <br>&#125;<br></code></pre></td></tr></table></figure>è¿”å›ç±»å‹æŠ˜å æˆ<code>int&amp;</code>ã€‚<code>t1</code>ä¼ å…¥<code>flip</code>ä¸­æ˜¯å·¦å€¼å¼•ç”¨ä¼ å…¥ï¼Œè¢«forwardè½¬æ¢åä¹Ÿæ˜¯å·¦å€¼å¼•ç”¨ã€‚å®Œæˆç±»å‹ä¿æŒã€‚</p></blockquote><hr /><h3 id="stdforwardæ€»ç»“">std::forwardæ€»ç»“</h3><blockquote><p>ä¸éš¾çœ‹å‡ºforwardå‡½æ•°è·Ÿmoveå‡½æ•°çš„å·¥ä½œåŸç†éƒ½ä¸€æ ·ï¼Œç”¨çš„å¼•ç”¨æŠ˜å æŠ€æœ¯ã€‚ -forwardå°†gå‡½æ•°çš„å³å€¼å¼•ç”¨ç±»å‹å®å‚ä»å·¦å€¼è½¬æ¢æˆå³å€¼ï¼Œä¿æŒrvalueèƒ½è¢«int&amp;&amp;æ¥æ”¶çš„æ€§è´¨ï¼ˆå¯è°ƒç”¨å¯¹è±¡çš„å½¢å‚ç±»å‹ä¸ºint&amp;&amp;ï¼Œæ¥å—å®å‚å€¼çš„ç±»å‹ä¸ºrvalueï¼‰ã€‚-è€Œgå‡½æ•°çš„å·¦å€¼å¼•ç”¨ç±»å‹å®å‚ï¼Œè¿›å…¥forwardæ˜¯å·¦å€¼å¼•ç”¨è¿›å…¥ï¼Œå‡½æ•°è¿”å›ä¹Ÿæ˜¯å·¦å€¼å¼•ç”¨ä¼ å‡ºï¼Œæ²¡å˜åŒ–ã€‚-æœ€ågå‡½æ•°çš„å½¢å‚ä¸ºintç±»å‹æ—¶ï¼Œæ¥å—å®å‚å€¼çš„ç±»å‹ä¸ºlvalueæˆ–rvalueã€‚forwardä¸ç®¡æ€ä¹ˆè½¬æ¢ï¼Œå®ƒéƒ½å¯ä»¥æ¥å—ã€‚</p><p>è¿™å°±æ˜¯æ‰€è°“çš„ç±»å‹ä¿æŒï¼ˆå¯èƒ½å™è¿°çš„ä¸æ˜¯ç‰¹åˆ«è¯¦ç»†ï¼Œæ¯•ç«Ÿè¿‡ç¨‹æœ‰ç‚¹å¤æ‚ï¼Œåªæ˜¯èµ·ä¸€ä¸ªæŠ›ç –å¼•ç‰çš„ä½œç”¨ï¼Œå¤§å®¶å¯ä»¥ä¸‹å»è‡ªå·±æ£é¼“æ£é¼“ï¼‰ã€‚.</p></blockquote><hr /><h2id="æœ€åå’±ä»¬æ¥çœ‹ä¸‹moveå’Œforwordçš„ä¸åŒä¹‹å¤„">æœ€åå’±ä»¬æ¥çœ‹ä¸‹moveå’Œforwordçš„ä¸åŒä¹‹å¤„ã€‚</h2><blockquote><p>std::moveå‡½æ•°çš„æºç ï¼š <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;<br>&gt;<span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">typename</span> std::remove_reference&lt;T&gt;::type&amp;&amp;<br>&gt;<span class="hljs-built_in">move</span>(T&amp;&amp; t) <span class="hljs-keyword">noexcept</span><br>&gt;&#123; <br><span class="hljs-keyword">return</span> <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">typename</span> std::remove_reference&lt;T&gt;::type&amp;&amp;&gt;(t); <br>&gt;&#125;<br></code></pre></td></tr></table></figure> std::forwardå‡½æ•°çš„æºç ï¼š<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> _Tp&gt;<br>&gt;<span class="hljs-keyword">constexpr</span> _Tp&amp;&amp;<br>&gt;forward(<span class="hljs-keyword">typename</span> std::remove_reference&lt;_Tp&gt;::type&amp; <span class="hljs-type">_t</span>) <span class="hljs-keyword">noexcept</span><br>&gt;&#123; <br><span class="hljs-keyword">return</span> <span class="hljs-built_in">static_cast</span>&lt;_Tp&amp;&amp;&gt;(<span class="hljs-type">_t</span>); <br>&gt;&#125;<br></code></pre></td></tr></table></figure>ä¸éš¾å‘ç°ï¼Œmoveå‡½æ•°çš„<code>std::remove_reference&lt;T&gt;::type</code>ï¼Œæ”¾åœ¨è¿”å›ç±»å‹å’Œ<code>static_cast&lt;&gt;</code>ä¸­ï¼Œè€Œä¸”åé¢éƒ½æ˜¯ç›´æ¥æ¥ä¸Šä¸¤ä¸ª<code>&amp;&amp;</code>ã€‚ä»–è¿™æ ·å†™çš„ç›®çš„åœ¨äºï¼Œä¸ç®¡<code>t</code>æ¥å—çš„æ˜¯ä¸€ä¸ªå³å€¼è¿˜æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œè¿”å›å‡ºæ¥å€¼çš„ç±»å‹æ°¸è¿œéƒ½æ˜¯å³å€¼ã€‚æ°¸è¿œèƒ½è¢«<code>int&amp;&amp;</code>æ¥å—ã€‚è€Œforwardå‡½æ•°çš„<code>std::remove_reference&lt;T&gt;::type</code>ï¼Œæ”¾åœ¨å½¢å‚<code>_t</code>ä¸Šï¼Œè€Œä¸”è¿”å›ç±»å‹å’Œ<code>static_cast&lt;&gt;</code>éƒ½ç”¨äº†å¼•ç”¨æŠ˜å æŠ€æœ¯ï¼Œå€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯moveå‡½æ•°ä¸éœ€è¦æ˜¾ç¤ºæŒ‡å®šæ¨¡æ¿çš„ç±»å‹ï¼Œè€Œforwardå‡½æ•°éœ€è¦æ˜¾ç¤ºæŒ‡å®šå®å‚ç±»å‹ã€‚forwardå‡½æ•°çš„å½¢å‚ä¸€å®šæ˜¯å¼•ç”¨ä¼ å…¥ï¼Œè€Œä¸”è¿”å›ç±»å‹å’Œ<code>static_cast&lt;&gt;</code>å¯ä»¥æ ¹æ®å®å‚ç±»å‹åŠ¨æ€æ”¹å˜ã€‚forwardå‡½æ•°çš„å®å‚ç±»å‹ä¸º<code>int&amp;&amp;</code>ï¼Œåˆ™è¿”å›ç±»å‹ä¸º<code>int&amp;&amp;</code>ï¼Œè¿”å›å‡ºå»çš„å°±æ˜¯ä¸€ä¸ª<code>xvalue</code>ã€‚forwardå‡½æ•°çš„å®å‚ç±»å‹ä¸º<code>int&amp;</code>ï¼Œåˆ™è¿”å›ç±»å‹ä¹Ÿä¸º<code>int&amp;</code>ï¼Œè¿”å›å‡ºå»çš„å’Œä¼ å…¥è¿›æ¥çš„éƒ½æ˜¯å®å‚çš„å¼•ç”¨ã€‚--------------------------------------------------------</p></blockquote><h1 id="é™„ä»¶">é™„ä»¶</h1><blockquote><p>æ³¨æ„ï¼šä¸‹é¢çš„æ–‡ä»¶ä¸‹è½½éƒ½æ˜¯å…è´¹çš„ï¼Œ0ç§¯åˆ†ä¸‹è½½ï¼Œåˆ«è¢«VIPå­—æ ·å“åˆ°äº†è›¤ ğŸ¤— <ahref="https://download.csdn.net/download/Howl_1/77241824">å³å€¼å¼•ç”¨ç›¸å…³æ–‡æ¡£</a><ahref="https://download.csdn.net/download/Howl_1/77242257">æµ‹è¯•ä»£ç çš„åæ±‡ç¼–ä»£ç </a></p></blockquote><h1 id="é™„å½•">é™„å½•</h1><blockquote><p>æ‘˜å–è‡ªã€Šc++ template 2ndã€‹é™„å½•ä¸­çš„å†…å®¹ï¼Œå¯ä»¥ç”¨æ¥æ£€æŸ¥è¡¨è¾¾å¼çš„å€¼ç±»åˆ«ï¼ˆvalue category of the expressionï¼šprvalueï¼Œxvalueæˆ–lvalueï¼‰ã€‚<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp">&gt;<span class="hljs-meta">#<span class="hljs-keyword">define</span> ISXVALUE(x) \</span><br><span class="hljs-meta">std::is_rvalue_reference<span class="hljs-string">&lt;decltype((x))&gt;</span>::value</span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">define</span> ISLVALUE(x)\</span><br><span class="hljs-meta">std::is_lvalue_reference<span class="hljs-string">&lt;decltype((x))&gt;</span>::value</span><br>&gt;<span class="hljs-meta">#<span class="hljs-keyword">define</span> CHEECK_VALUE_CATOGORIES(x) \</span><br><span class="hljs-meta"><span class="hljs-keyword">if</span>(ISXVALUE(x)) printf(<span class="hljs-string">&quot;%s is a xvalue\n&quot;</span>,#x);\</span><br><span class="hljs-meta"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(ISLVALUE(x)) printf(<span class="hljs-string">&quot;%s is a lvalue\n&quot;</span>,#x);\</span><br><span class="hljs-meta"><span class="hljs-keyword">else</span> printf(<span class="hljs-string">&quot;%s is a prvalue\n&quot;</span>,#x);</span><br></code></pre></td></tr></table></figure></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>C++</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨tcpdumpè§‚å¯ŸTCPå¤´éƒ¨ä¿¡æ¯å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹</title>
    <link href="/2021/07/25/00003.%20%E4%BD%BF%E7%94%A8tcpdump%E8%A7%82%E5%AF%9FTCP%E5%A4%B4%E9%83%A8%E4%BF%A1%E6%81%AF%EF%BC%88%E8%A1%A5%E5%85%85TCP%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%B8%B8%E7%94%A8%E7%9F%A5%E8%AF%86%EF%BC%89/"/>
    <url>/2021/07/25/00003.%20%E4%BD%BF%E7%94%A8tcpdump%E8%A7%82%E5%AF%9FTCP%E5%A4%B4%E9%83%A8%E4%BF%A1%E6%81%AF%EF%BC%88%E8%A1%A5%E5%85%85TCP%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%B8%B8%E7%94%A8%E7%9F%A5%E8%AF%86%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><blockquote><p><strong>æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚</strong><br />æœ¬æ¬¡å®éªŒæ˜¯ç›®çš„åœ¨äºå¼„æ¸…tcpå¤´éƒ¨ä¿¡æ¯å’Œä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹çš„ç»†èŠ‚ï¼Œå¹¶ä¸”è¡¥å……ä¸€äº›tcpåè®®çš„å¸¸ç”¨çŸ¥è¯†ã€‚è¯»æœ¬æ–‡éœ€è¦ä¸€äº›å‰ç½®çŸ¥è¯†ï¼Œå…·ä½“è¯·å‚ç…§ã€Šlinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹p32-p37ã€‚å®éªŒæµ‹è¯•æœºæ˜¯é˜¿é‡Œäº‘ECSæœåŠ¡å™¨å’Œæœ¬åœ°è™šæ‹Ÿæœºã€‚ä¸åŒäºä¹¦æœ¬ä¸Šï¼Œå®ƒçš„æµ‹è¯•æœºæ˜¯åœ¨åŒä¸€å±€åŸŸç½‘å†…ã€‚--------------------------------------------------------</p></blockquote><h1 id="å®éªŒå¼€å§‹">å®éªŒå¼€å§‹</h1><ul><li><p>ã€€<font color='red'>åœ¨æœåŠ¡å™¨ä¸Šå°†echoæœåŠ¡æ‰“å¼€ï¼Œå…·ä½“è¯·çœ‹ç¬”è€…å†™çš„tcpdumpè§‚å¯ŸARPé€šä¿¡è¿‡ç¨‹ï¼Œè¿™é‡Œä¸å¤šèµ˜è¿°ã€‚</font></p></li><li><p>ã€€<font color='red'> åœ¨æœ¬åœ°è™šæ‹Ÿæœºä¸Šå¼€å¯ä¸¤ä¸ªç»ˆç«¯ </font></p></li><li><p>ã€€<font color='red'> ç›‘å¬ç»ˆç«¯</font></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ubuntu:/<span class="hljs-comment"># tcpdump -S -i ens33 -ntx &#x27;(src 192.168.1.7 and dst 120.79.72.214) or (src 120.79.72.214 and dst 192.168.1.7)&#x27;</span><br>tcpdump: verbose output suppressed, use -v or -vv <span class="hljs-keyword">for</span> full protocol decode<br>listening on ens33, link-type EN10MB (Ethernet), capture size 262144 bytes<br></code></pre></td></tr></table></figure><blockquote><p>-Såºå·å’Œç¡®è®¤å·ä»¥ç»å¯¹å€¼å½¢å¼æ˜¾ç¤ºï¼ˆå¦‚æœæ˜¯ç›¸å¯¹å€¼æ˜¾ç¤ºï¼Œåˆ™ä»ç¬¬ä¸‰ä¸ªæŠ¥æ–‡å¼€å§‹ï¼Œseqå’Œackç›¸å¯¹ISNçš„åç§»ï¼‰,-i ç›‘å¬æŒ‡å®šç½‘ç»œæ¥å£ens33ï¼Œ-næŒ‡å®šå°†æ¯ä¸ªç›‘å¬åˆ°æ•°æ®åŒ…ä¸­çš„åŸŸåè½¬æ¢æˆIPåœ°å€åæ˜¾ç¤ºï¼Œ-tåœ¨è¾“å‡ºçš„æ¯ä¸€è¡Œä¸æ‰“å°æ—¶é—´æˆ³, -xæŠŠåè®®å¤´å’ŒåŒ…å†…å®¹éƒ½åŸåŸæœ¬æœ¬çš„æ˜¾ç¤ºå‡ºæ¥ï¼ˆtcpdumpä¼šä»¥16è¿›åˆ¶å’ŒASCIIçš„å½¢å¼æ˜¾ç¤ºï¼‰ã€‚åé¢srcè¡¨ç¤ºæºipï¼Œdstè¡¨ç¤ºç›®çš„ipï¼Œè¿™æ ·å†™å¯ä»¥èµ·åˆ°ä¸€ä¸ªæ»¤åŒ…çš„ä½œç”¨ã€‚</p></blockquote><ul><li>ã€€<font color='red'> æµ‹è¯•ç»ˆç«¯</font></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ubuntu:/home/marvel<span class="hljs-comment"># telnet 120.79.72.214 7</span><br>Trying 120.79.72.214...<br>Connected to 120.79.72.214.<br>Escape character is <span class="hljs-string">&#x27;^]&#x27;</span>.<br>1<br>1<br>^]<br>telnet&gt; q<br>Connection closed.<br>root@ubuntu:/home/marvel<span class="hljs-comment"># </span><br><br></code></pre></td></tr></table></figure><ul><li>ã€€<font color='red'> ç›‘å¬ç»ˆç«¯</font></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@ubuntu:/home/marvel<span class="hljs-comment"># tcpdump -S -i ens33 -ntx &#x27;(src 192.168.1.7 and dst 120.79.72.214) or (src 120.79.72.214 and dst 192.168.1.7)&#x27;</span><br>tcpdump: verbose output suppressed, use -v or -vv <span class="hljs-keyword">for</span> full protocol decode<br>listening on ens33, link-type EN10MB (Ethernet), capture size 262144 bytes<br>1ï¼‰IP 192.168.1.7.39804 &gt; 120.79.72.214.7: Flags [S], <span class="hljs-built_in">seq</span> 3843050562, win 64240, options [mss 1460,sackOK,TS val 2363801315 ecr 0,nop,wscale 7], length 0<br>0x0000:  4510 003c 3496 4000 4006 8341 c0a8 0107<br>0x0010:  784f 48d6 9b7c 0007 e510 4c42 0000 0000<br>0x0020:  a002 faf0 8303 0000 0204 05b4 0402 080a<br>0x0030:  8ce4 bee3 0000 0000 0103 0307<span class="hljs-comment">#60å­—èŠ‚ï¼ˆ16ä½ï¼Œä¸¤å­—èŠ‚ï¼Œä¸€ç»„ï¼Œä¸€å…±30ç»„ï¼‰ï¼ŒåŒæ­¥æŠ¥æ–‡</span><br>2ï¼‰IP 120.79.72.214.7 &gt; 192.168.1.7.39804: Flags [S.], <span class="hljs-built_in">seq</span> 3051969109, ack 3843050563, win 65160, options [mss 1400,sackOK,TS val 743316774 ecr 2363801315,nop,wscale 7], length 0<br>0x0000:  4514 003c 0000 4000 3406 c3d3 784f 48d6<br>0x0010:  c0a8 0107 0007 9b7c b5e9 5a55 e510 4c43<br>0x0020:  a012 fe88 547b 0000 0204 0578 0402 080a<br>0x0030:  2c4e 1d26 8ce4 bee3 0103 0307<span class="hljs-comment">#60å­—èŠ‚ï¼ˆ16ä½ï¼Œä¸¤å­—èŠ‚ï¼Œä¸€ç»„ï¼Œä¸€å…±30ç»„ï¼‰ï¼ŒåŒæ­¥ç¡®è®¤æŠ¥æ–‡</span><br>3ï¼‰IP 192.168.1.7.39804 &gt; 120.79.72.214.7: Flags [.], ack 3051969110, win 502, options [nop,nop,TS val 2363801340 ecr 743316774], length 0<br>0x0000:  4510 0034 3497 4000 4006 8348 c0a8 0107<br>0x0010:  784f 48d6 9b7c 0007 e510 4c43 b5e9 5a56<br>0x0020:  8010 01f6 82fb 0000 0101 080a 8ce4 befc<br>0x0030:  2c4e 1d26<span class="hljs-comment">#52å­—èŠ‚ï¼ˆ16ä½ï¼Œä¸¤å­—èŠ‚ï¼Œä¸€ç»„ï¼Œä¸€å…±26ç»„ï¼‰ï¼Œç¡®è®¤æŠ¥æ–‡</span><br>4ï¼‰IP 192.168.1.7.39804 &gt; 120.79.72.214.7: Flags [P.], <span class="hljs-built_in">seq</span> 3843050563:3843050566, ack 3051969110, win 502, options [nop,nop,TS val 2363810557 ecr 743316774], length 3<br>0x0000:  4510 0037 3498 4000 4006 8344 c0a8 0107<br>0x0010:  784f 48d6 9b7c 0007 e510 4c43 b5e9 5a56<br>0x0020:  8018 01f6 82fe 0000 0101 080a 8ce4 e2fd<br>0x0030:  2c4e 1d26 310d 0a<span class="hljs-comment">#55å­—èŠ‚ï¼Œlengthï¼ˆæ•°æ®é•¿åº¦ï¼‰=55-52ï¼Œ</span><br>5ï¼‰IP 120.79.72.214.7 &gt; 192.168.1.7.39804: Flags [.], ack 3843050566, win 510, options [nop,nop,TS val 743326016 ecr 2363810557], length 0<br>0x0000:  4514 0034 d00d 4000 3406 f3cd 784f 48d6<br>0x0010:  c0a8 0107 0007 9b7c b5e9 5a56 e510 4c46<br>0x0020:  8010 01fe 375f 0000 0101 080a 2c4e 4140<br>0x0030:  8ce4 e2fd<span class="hljs-comment">#52å­—èŠ‚ï¼Œç¡®è®¤æŠ¥æ–‡</span><br>6ï¼‰IP 120.79.72.214.7 &gt; 192.168.1.7.39804: Flags [P.], <span class="hljs-built_in">seq</span> 3051969110:3051969113, ack 3843050566, win 510, options [nop,nop,TS val 743326016 ecr 2363810557], length 3<br>0x0000:  4514 0037 d00e 4000 3406 f3c9 784f 48d6<br>0x0010:  c0a8 0107 0007 9b7c b5e9 5a56 e510 4c46<br>0x0020:  8018 01fe fc46 0000 0101 080a 2c4e 4140<br>0x0030:  8ce4 e2fd 310d 0a<span class="hljs-comment">#55å­—èŠ‚ï¼Œlengthï¼ˆæ•°æ®é•¿åº¦ï¼‰=55-52ã€‚</span><br>7ï¼‰IP 192.168.1.7.39804 &gt; 120.79.72.214.7: Flags [.], ack 3051969113, win 502, options [nop,nop,TS val 2363810582 ecr 743326016], length 0<br>0x0000:  4510 0034 3499 4000 4006 8346 c0a8 0107<br>0x0010:  784f 48d6 9b7c 0007 e510 4c46 b5e9 5a59<br>0x0020:  8010 01f6 82fb 0000 0101 080a 8ce4 e316<br>0x0030:  2c4e 4140<span class="hljs-comment">#52å­—èŠ‚</span><br>8ï¼‰IP 192.168.1.7.39804 &gt; 120.79.72.214.7: Flags [F.], <span class="hljs-built_in">seq</span> 3843050566, ack 3051969113, win 502, options [nop,nop,TS val 2363813862 ecr 743326016], length 0<br>0x0000:  4510 0034 349a 4000 4006 8345 c0a8 0107<br>0x0010:  784f 48d6 9b7c 0007 e510 4c46 b5e9 5a59<br>0x0020:  8011 01f6 82fb 0000 0101 080a 8ce4 efe6<br>0x0030:  2c4e 4140<span class="hljs-comment">#52å­—èŠ‚ï¼Œ</span><br>9ï¼‰IP 120.79.72.214.7 &gt; 192.168.1.7.39804: Flags [F.], <span class="hljs-built_in">seq</span> 3051969113, ack 3843050567, win 510, options [nop,nop,TS val 743329323 ecr 2363813862], length 0<br>0x0000:  4514 0034 d00f 4000 3406 f3cb 784f 48d6<br>0x0010:  c0a8 0107 0007 9b7c b5e9 5a59 e510 4c47<br>0x0020:  8011 01fe 1d86 0000 0101 080a 2c4e 4e2b<br>0x0030:  8ce4 efe6<span class="hljs-comment">#52å­—èŠ‚</span><br>10ï¼‰IP 192.168.1.7.39804 &gt; 120.79.72.214.7: Flags [.], ack 3051969114, win 502, options [nop,nop,TS val 2363813889 ecr 743329323], length 0<br>0x0000:  4510 0034 349b 4000 4006 8344 c0a8 0107<br>0x0010:  784f 48d6 9b7c 0007 e510 4c47 b5e9 5a5a<br>0x0020:  8010 01f6 82fb 0000 0101 080a 8ce4 f001<br>0x0030:  2c4e 4e2b<span class="hljs-comment">#52å­—èŠ‚</span><br>^C<br>10 packets captured<br>10 packets received by filter<br>0 packets dropped by kernel<br>root@ubuntu:/home/marvel<span class="hljs-comment"># </span><br><br></code></pre></td></tr></table></figure><figure><img src="/img/00003/tcpä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹.png"alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><figcaption aria-hidden="true">åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><blockquote><p>è¿™é‡Œé¢ä¿¡æ¯é‡å·¨å¤§ï¼Œå¾…æˆ‘ä»¬æ¥æ…¢æ…¢åˆ†æé‡Œé¢çš„ç»†èŠ‚ï¼ ## 1. å»¶è¿Ÿç¡®è®¤1ï¼‰-3ï¼‰æ˜¯3æ¬¡æ¡æ‰‹ï¼Œ8ï¼‰-10ï¼‰æ˜¯4æ¬¡æŒ¥æ‰‹ï¼Œä½†æ˜¯è¿™é‡Œåªæœ‰ä¸‰æ®µæŠ¥æ–‡æ®µã€‚åŸå› æ˜¯ï¼Œ<strong>å»¶è¿Ÿç¡®è®¤</strong>ï¼Œå³æœåŠ¡å™¨ä¸ä¼šé©¬ä¸Šç¡®è®¤æ”¶åˆ°çš„æ•°æ®ï¼Œè€Œæ˜¯åœ¨ä¸€æ®µå»¶è¿Ÿæ—¶é—´åæŸ¥çœ‹æœ¬ç«¯æ˜¯å¦æœ‰æ•°æ®è¦å‘é€ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å’Œç¡®è®¤ä¿¡æ¯ä¸€èµ·å‘å‡ºã€‚å»¶è¿Ÿç¡®è®¤å¯ä»¥å‡å°‘å‘é€tcpæŠ¥æ–‡æ®µçš„æ•°é‡ã€‚è¿™é‡Œçš„å››æ¬¡æŒ¥æ‰‹ä¸­æœåŠ¡å™¨çš„ç¡®è®¤æŠ¥æ–‡å’Œç»“æŸæŠ¥æ–‡ä¸€æ¬¡æ€§å‘é€ç»™å®¢æˆ·ç«¯äº†ã€‚ï¼ˆä¹¦ä¸Šæ˜¯åœ¨å±€åŸŸç½‘å†…è¿›è¡Œçš„ï¼Œæ²¡æœ‰å»¶è¿Ÿç¡®è®¤ï¼‰</p><h2 id="åºå·seqå’Œç¡®è®¤å·ackä¹‹é—´çš„å…³ç³»">2.åºå·ï¼ˆseqï¼‰å’Œç¡®è®¤å·ï¼ˆackï¼‰ä¹‹é—´çš„å…³ç³»</h2><p>åºå·çš„ç›¸å¯¹å€¼æ˜¯ç›¸å¯¹äºè‡ªèº«å‘å‡ºç¬¬ä¸€ä¸ªtcpæŠ¥æ–‡æ®µä¸­çš„seqç¡®è®¤å·çš„ç›¸å¯¹å€¼æ˜¯ç›¸å¯¹äºå¯¹æ–¹å‘å‡ºç¬¬ä¸€ä¸ªtcpæŠ¥æ–‡æ®µä¸­çš„seqï¼ˆä»¥ç»å¯¹å€¼æ˜¾ç¤ºçš„å°±ä¸ç”¨ç®¡å•¦ï¼‰åºå·çš„å€¼é™¤äº†ä¸¤æ¬¡å¼€å¤´çš„åŒæ­¥æŠ¥æ–‡æ˜¯ç”±ç³»ç»Ÿåˆå§‹åŒ–ä¸ºæŸä¸ªéšæœºISNã€‚<strong>å…¶ä»–åºå·ä¸ºä¸Šä¸€æ¡å¯¹æ–¹å‘é€æŠ¥æ–‡æ®µçš„ç¡®è®¤å·</strong>ï¼Œç”±å›¾ä¸­çš„çº¢è‰²çº¿æ¡ä¸ºä»£è¡¨ï¼ˆä¸€æ¥ä¸€å›ï¼‰ã€‚å¦‚æœæ˜¯ä¸€æ–¹è¿ç»­å‘é€æŠ¥æ–‡æ®µï¼ˆè¿ç»­å»æ²¡å›ï¼‰ï¼Œ<strong>åˆ™åºåˆ—å·ä¸ºISNåŠ ä¸Šè¯¥æŠ¥æ–‡æ®µæ‰€æºå¸¦æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨æ•´ä¸ªå­—èŠ‚æµä¸­çš„åç§»</strong>ï¼ˆè¿™ä¸€ç‚¹æœ¬æ–‡æœªæ¶‰åŠï¼Œè¯»è€…åœ¨è§‚å¯Ÿå…¶ä»–å¤æ‚é€šä¿¡è¿‡ç¨‹ä¸­è‚¯å®šä¼šç¢°åˆ°ï¼‰ã€‚ç¡®è®¤å·çš„å€¼ï¼Œå¦‚æœæ˜¯åœ¨ä¸‰æ¬¡æ¡æ‰‹1ï¼‰-3ï¼‰å’Œå››æ¬¡æŒ¥æ‰‹8ï¼‰-10ï¼‰ä¸­ï¼Œåˆ™ack=å¯¹æ–¹å‘é€æŠ¥æ–‡æ®µçš„seq+1ï¼›<strong>å¦‚æœæ˜¯åœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­4ï¼‰-7ï¼‰,ack=ä¸Šä¸€æ¡å¯¹æ–¹å‘é€æŠ¥æ–‡æ®µçš„seq+æ•°æ®é•¿åº¦ã€‚ä¾‹å¦‚æœ¬ä¾‹ä¸­æŠ¥æ–‡æ®µ5ï¼‰çš„ç¡®è®¤å·ï¼ˆ3843050566ï¼‰=ä¸Šä¸€æ¡å¯¹æ–¹å‘é€æŠ¥æ–‡æ®µçš„seqï¼ˆ3843050563ï¼‰+å®ƒçš„æ•°æ®å­—èŠ‚ï¼ˆ3ï¼‰</strong>,å¾—åˆ°çš„ä¹Ÿå°±æ˜¯æŠ¥æ–‡æ®µ4ï¼‰seq3843050563:3843050566ï¼Œå†’å·åé¢é‚£ä¸ªå€¼ã€‚å†’å·åé¢çš„å€¼æ˜¯ç”±tcpdumpè‡ªè¡Œæ·»åŠ çš„ï¼Œå…¶å€¼åˆšå¥½ä¸ºæ¥æ”¶ç«¯ackçš„å€¼ã€‚æ€»ç»“ï¼š<strong>åºåˆ—å·çš„ç›¸å¯¹å€¼æ˜¯å¯¹å­—èŠ‚æµçš„æ ‡è¯†ï¼Œæ ¹æ®åºåˆ—å·çš„å·®å€¼å¯ä»¥ç¡®å®šä¸¤ä¸ªæ•°æ®æŠ¥ä¹‹é—´æ•°æ®çš„å¤§å°</strong>ã€‚## 3.TS valå’Œecrçš„å…³ç³»è¿™ä¸¤è€…çš„å…³ç³»å¾ˆå°‘æœ‰äººæåŠï¼Œå’±ä»¬ç›´æ¥çœ‹ç»´åŸºç™¾ç§‘çš„è§£é‡Š</p><p>There are two timestamp fields: <strong>TS valï¼ša 4-byte sendertimestamp value (my timestamp)</strong> <strong>ecrï¼ša 4-byte echo replytimestamp value (the most recent timestamp received from you).</strong><strong>TCP timestamps are used in an algorithm known as ProtectionAgainst Wrapped Sequence numbers, or PAWS (see RFC 1323 fordetails)</strong>. PAWS is used when the receive window crosses thesequence number wraparound boundary. In the case where a packet waspotentially retransmitted it answers the question: <strong>"Is thissequence number in the first 4 GB or the second?" And the timestamp isused to break the tie</strong>.TCPæ—¶é—´æˆ³é€‰é¡¹æœ‰åŠ©äºåœ¨ä¼ è¾“éå¸¸å¤§çš„æ•°æ®æµæ—¶ä¿æŠ¤åŒ…è£…åºåˆ—ã€‚TCPä¸­çš„åºåˆ—å·å­—æ®µåªæœ‰32ä½ï¼Œæ‰€ä»¥åºåˆ—å·å¤§äº2^32-1ä¹‹åï¼Œåºåˆ—å·ä¼šç»•å›å¼€å§‹ã€‚å¦ä¸€ä¸ªä½œç”¨è®¡ç®—RTTå€¼ã€‚ The Timestamp option can be used to measure theround-trip time (RTT) of every packet that is acknowledged. This is doneby including a Timestamp Value TSval in every segment that is sent.These TSval values are echoed by the opposite side of the connection inthe Timestamp Echo Reply TSecr field. So, when a segment is ACKed, thesender of that segment can simply subtract their current timestamp fromthe TSecr value to compute an accurate Round Trip Time (RTT)measurement. RTT = å½“å‰æ—¶é—´ -æ•°æ®åŒ…ä¸­Timestampé€‰é¡¹çš„å›æ˜¾æ—¶é—´ï¼ˆè¿™ä¸ªå›æ˜¾æ—¶é—´æ˜¯è¯¥æ•°æ®åŒ…å‘å‡ºå»çš„æ—¶é—´ï¼‰ ##4. TCPçŠ¶æ€è½¬ç§»ï¼ˆä¹¦ä¸Šp41-p42åŸè¯ï¼‰ <imgsrc="/img/00003/tcpçŠ¶æ€è½¬ç§»å›¾.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p><p><strong>é‡ç‚¹æŒæ¡ESTABLISHED,FIN_WAIT_2&lt;--&gt;CLOSE_WAIT,TIME_WAIT(2MSL)</strong>==é¦–å…ˆ==è®¨è®ºæœåŠ¡å™¨çš„å…¸å‹çŠ¶æ€è½¬ç§»è¿‡ç¨‹(<strong>è™šçº¿è·¯å¾„</strong>)ï¼Œæ­¤æ—¶è¯´çš„è¿æ¥çŠ¶æ€éƒ½æ˜¯æŒ‡è¯¥è¿æ¥çš„æœåŠ¡å™¨ç«¯çš„çŠ¶æ€ã€‚æœåŠ¡å™¨é€šè¿‡listenç³»ç»Ÿè°ƒç”¨<strong>è¿›å…¥LISTENçŠ¶æ€</strong>ï¼Œè¢«åŠ¨ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼Œå› æ­¤æ‰§è¡Œçš„æ˜¯æ‰€è°“çš„è¢«åŠ¨æ‰“å¼€ã€‚æœåŠ¡å™¨ä¸€æ—¦ç›‘å¬åˆ°æŸä¸ªè¿æ¥è¯·æ±‚ï¼ˆæ”¶åˆ°åŒæ­¥æŠ¥æ–‡æ®µï¼‰ï¼Œå°±å°†è¯¥è¿æ¥æ”¾å…¥å†…æ ¸ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶å‘å®¢æˆ·ç«¯å‘é€å¸¦SYNæ ‡å¿—çš„ç¡®è®¤æŠ¥æ–‡æ®µã€‚æ­¤æ—¶è¯¥è¿æ¥<strong>å¤„äºSYN_RCVDçŠ¶æ€</strong>ã€‚å¦‚æœæœåŠ¡å™¨æˆåŠŸåœ°æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€å›çš„ç¡®è®¤æŠ¥æ–‡æ®µï¼Œåˆ™è¯¥è¿æ¥è½¬<strong>ç§»åˆ°ESTABLISHED</strong>ã€‚ESTABLISHEDçŠ¶æ€æ˜¯è¿æ¥åŒæ–¹èƒ½å¤Ÿè¿›è¡ŒåŒå‘æ•°æ®ä¼ è¾“çš„çŠ¶æ€ã€‚å½“å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥æ—¶ï¼ŒæœåŠ¡å™¨é€šè¿‡è¿”å›ç¡®è®¤æŠ¥æ–‡æ®µä½¿è¿æ¥<strong>è¿›å…¥CLOSE_WAITçŠ¶æ€</strong>ã€‚è¿™ä¸ªçŠ¶æ€çš„å«ä¹‰å¾ˆæ˜ç¡®ï¼šç­‰å¾…æœåŠ¡å™¨åº”ç”¨ç¨‹åºå…³é—­è¿æ¥ã€‚é€šå¸¸ï¼ŒæœåŠ¡å™¨æ£€æµ‹åˆ°å®¢æˆ·ç«¯å…³é—­è¿æ¥åï¼Œä¹Ÿä¼šç«‹å³ç»™å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªç»“æŸæŠ¥æ–‡æ®µæ¥å…³é—­è¿æ¥ã€‚è¿™å°†ä½¿è¿æ¥<strong>è½¬ç§»åˆ°LAST_ACKçŠ¶æ€</strong>ï¼Œä»¥ç­‰å¾…å®¢æˆ·ç«¯å¯¹ç»“æŸæŠ¥æ–‡æ®µçš„æœ€åä¸€æ¬¡ç¡®è®¤ã€‚ä¸€æ—¦ç¡®è®¤å®Œæˆï¼Œè¿æ¥å½»åº•å…³é—­äº†ã€‚==å…¶æ¬¡==è®¨è®ºå®¢æˆ·ç«¯ï¼ˆ<strong>ç²—é»‘çº¿</strong>ï¼‰ï¼Œå®¢æˆ·ç«¯é€šè¿‡connectç³»ç»Ÿè°ƒç”¨ï¼ˆè§ç¬¬5ç« ï¼‰ä¸»åŠ¨ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚connectç³»ç»Ÿè°ƒç”¨é¦–å…ˆç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªåŒæ­¥æŠ¥æ–‡æ®µï¼Œä½¿è¿æ¥<strong>è½¬ç§»åˆ°SYN_SENTçŠ¶æ€</strong>ã€‚connectè°ƒç”¨å¤±è´¥å°†ä½¿è¿æ¥ç«‹å³è¿”å›åˆ°åˆå§‹çš„CLOSEDçŠ¶æ€ã€‚å¦‚æœå®¢æˆ·ç«¯æˆåŠŸæ”¶åˆ°æœåŠ¡å™¨çš„åŒæ­¥æŠ¥æ–‡æ®µå’Œç¡®è®¤ï¼Œåˆ™connectè°ƒç”¨æˆåŠŸè¿”å›ï¼Œè¿æ¥<strong>è½¬ç§»è‡³ESTABLISHEDçŠ¶æ€</strong>ã€‚å½“å®¢æˆ·ç«¯æ‰§è¡Œä¸»åŠ¨å…³é—­æ—¶ï¼Œå®ƒå°†å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªç»“æŸæŠ¥æ–‡æ®µï¼ŒåŒæ—¶è¿æ¥<strong>è¿›å…¥FIN_WAIT_1çŠ¶æ€</strong>ï¼ˆåˆ°è¾¾è¿™ä¸ªçŠ¶æ€æ—¶ï¼Œä¼šå‘é€FINå‘Šè¯‰å¯¹æ–¹æˆ‘è¦å…³é—­è¿æ¥ï¼‰ã€‚è‹¥æ­¤æ—¶å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨ä¸“é—¨ç”¨äºç¡®è®¤ç›®çš„çš„ç¡®è®¤æŠ¥æ–‡æ®µï¼ˆæ¯”å¦‚å›¾3-6ä¸­çš„TCPæŠ¥æ–‡æ®µ5)ï¼Œåˆ™è¿æ¥<strong>è½¬ç§»è‡³FIN_WAIT_2çŠ¶æ€</strong>ï¼ˆè¿™ä¸ªçŠ¶æ€ä¹Ÿç§°ä¸ºåŠå…³é—­çŠ¶æ€ï¼Œå³å®¢æˆ·ç«¯å°†è‡ªå·±çš„å†™bufferå…³é—­äº†ï¼Œä½†æ˜¯è¯»bufferè¿˜åœ¨ï¼‰ã€‚å½“å®¢æˆ·ç«¯å¤„äºFIN_WAIT_2çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨å¤„äºCLOSE_WAITçŠ¶æ€ï¼Œè¿™ä¸€å¯¹çŠ¶æ€æ˜¯å¯èƒ½å‘ç”ŸåŠå…³é—­çš„çŠ¶æ€ã€‚æ­¤æ—¶å¦‚æœæœåŠ¡å™¨ä¹Ÿå…³é—­è¿æ¥ï¼ˆå‘é€ç»“æŸæŠ¥æ–‡æ®µ)ï¼Œåˆ™å®¢æˆ·ç«¯å°†ç»™äºˆç¡®è®¤å¹¶<strong>è¿›å…¥TIME_WAITçŠ¶æ€</strong>ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€å®¢æˆ·ç«¯è¦ç­‰å¾…2MSLï¼ˆæŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼‰ï¼Œæ‰èƒ½å®Œå…¨å…³é—­ã€‚## 5. FIN_WAIT_2çŠ¶æ€(åŠå…³é—­çŠ¶æ€)</p><p>å¤„äºFIN_WAIT_2çŠ¶æ€çš„å®¢æˆ·ç«¯éœ€è¦ç­‰å¾…æœåŠ¡å™¨å‘é€ç»“æŸæŠ¥æ–‡æ®µï¼Œæ‰èƒ½è½¬ç§»è‡³TIME_WAITçŠ¶æ€ï¼Œå¦åˆ™å®ƒå°†ä¸€ç›´åœç•™åœ¨è¿™ä¸ªçŠ¶æ€ã€‚<strong>å¦‚æœä¸æ˜¯ä¸ºäº†åœ¨åŠå…³é—­çŠ¶æ€ä¸‹ç»§ç»­æ¥æ”¶æ•°æ®ï¼Œè¿æ¥é•¿æ—¶é—´åœ°åœç•™åœ¨FIN_WAIT_2çŠ¶æ€å¹¶æ— ç›Šå¤„</strong>ã€‚è¿æ¥åœç•™åœ¨FIN_WAIT_2çŠ¶æ€çš„æƒ…å†µå¯èƒ½å‘ç”Ÿåœ¨:å®¢æˆ·ç«¯æ‰§è¡ŒåŠå…³é—­åï¼Œæœªç­‰æœåŠ¡å™¨å…³é—­è¿æ¥å°±å¼ºè¡Œé€€å‡ºäº†ã€‚æ­¤æ—¶å®¢æˆ·ç«¯è¿æ¥ç”±å†…æ ¸æ¥æ¥ç®¡ï¼Œå¯ç§°ä¹‹ä¸º<strong>å­¤å„¿è¿æ¥</strong>ï¼ˆå’Œå­¤å„¿è¿›ç¨‹ç±»ä¼¼)ã€‚Linuxä¸ºäº†é˜²æ­¢å­¤å„¿è¿æ¥é•¿æ—¶é—´å­˜ç•™åœ¨å†…æ ¸ä¸­ï¼Œå®šä¹‰äº†ä¸¤ä¸ªå†…æ ¸å˜é‡:l/proc/sys/net/ipv4/tcp_max_orphanså’Œ/proc/syslnet/ipv4/tcp_fin_timeoutã€‚å‰è€…æŒ‡å®šå†…æ ¸èƒ½æ¥ç®¡çš„å­¤å„¿è¿æ¥æ•°ç›®ï¼Œåè€…æŒ‡å®šå­¤å„¿è¿æ¥åœ¨å†…æ ¸ä¸­ç”Ÿå­˜çš„æ—¶é—´ã€‚## 6. TIME_WAITçŠ¶æ€ TIME_WAITçŠ¶æ€å­˜åœ¨çš„åŸå› æœ‰ä¸¤ ä¸€ï¼šå¯é åœ°ç»ˆæ­¢TCPè¿æ¥ã€‚<strong>TIME_WAITçŠ¶æ€ä¸º2MSLå¯ä»¥ä¿è¯æœ€ç³Ÿç³•æƒ…å†µä¹Ÿå¯ä»¥æ”¶åˆ°è¶…æ—¶é‡ä¼ çš„FINæŠ¥æ–‡</strong>ï¼ˆç¡®è®¤æŠ¥æ–‡åŠè·¯å—å±ï¼Œæœ€å¤§å­˜æ´»æ—¶é—´MSLï¼Œé‡ä¼ çš„FINæŠ¥æ–‡åˆ°å®¢æˆ·ç«¯èŠ±è´¹çš„æœ€å¤§æ—¶é—´MSLï¼Œå³æ”¶åˆ°é‡ä¼ çš„FINæŠ¥æ–‡å°äºç­‰äº2MSLï¼‰ã€‚äºŒï¼šä¿è¯è®©è¿Ÿæ¥çš„TCPæŠ¥æ–‡æ®µæœ‰è¶³å¤Ÿçš„æ—¶é—´è¢«è¯†åˆ«å¹¶ä¸¢å¼ƒã€‚æˆ‘ä»¬åè¿‡æ¥æ€è€ƒï¼Œå¦‚æœæ²¡æœ‰TIME_WAITçŠ¶æ€ï¼Œåˆ™åº”ç”¨ç¨‹åºèƒ½å¤Ÿç«‹å³åˆ›ç«‹ä¸€ä¸ªå’Œåˆšå…³é—­çš„è¿æ¥ç›¸ä¼¼çš„è¿æ¥ï¼ˆå…·æœ‰ç›¸åŒIPï¼Œå’Œç«¯å£å·ï¼‰ã€‚è¿™ä¸ªæ–°çš„ï¼Œå’ŒåŸæ¥ç›¸ä¼¼çš„è¿æ¥è¢«ç§°ä¸ºåŸæ¥è¿æ¥çš„åŒ–èº«ã€‚<strong>æ–°çš„åŒ–èº«å¯èƒ½æ¥æ”¶åˆ°å±äºåŸæ¥çš„è¿æ¥çš„ï¼Œæºå¸¦åº”ç”¨ç¨‹åºæ•°æ®çš„TCPæŠ¥æ–‡æ®µï¼ˆè¿Ÿåˆ°çš„æŠ¥æ–‡æ®µï¼‰</strong>ï¼Œè¿™æ˜¾ç„¶ä¸åº”è¯¥å‘ç”Ÿçš„ã€‚## 7. ç»†è¯´4ï¼‰TCPæŠ¥æ–‡æ®µçš„è¯¦ç»†ä¿¡æ¯ <imgsrc="/img/00003/tcpæŠ¥æ–‡æ®µè¯¦ç»†ä¿¡æ¯.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />1.è¯¥æŠ¥æ–‡æ®µæ˜¯ä¸€ä¸ªæ•°æ®æŠ¥æ–‡æ®µ. Flags[P.]:æç¤ºæ¥æ”¶ç«¯åº”ç”¨ç¨‹åºåº”è¯¥ç«‹å³ä»TCPæ¥æ”¶ç¼“å†²åŒºä¸­è¯»èµ°æ•°æ®ï¼Œä¸ºåç»­æ•°æ®è…¾å‡ºç©ºé—´; seqæ˜¯åºåˆ—å·ï¼Œâ€œ:â€åé¢çš„æ•°å€¼æ˜¯ä¸‹æ¡æ¥æ”¶æ–¹ç¡®è®¤æŠ¥æ–‡çš„ç¡® è®¤å·; ackæ˜¯ç¡®è®¤å·;winæ˜¯çª—å¤§å°ï¼Œæ˜¯TCPæµé‡æ§åˆ¶çš„-ä¸€ä¸ªæ‰‹æ®µï¼Œå¦‚æœæ˜¯ä¸€ä¸ªRWND (æ¥æ”¶é€šå‘Šçª—å£)ï¼Œå®ƒå‘Šè¯‰å¯¹æ–¹æœ¬ç«¯çš„TCPæ¥æ”¶ç¼“å†²åŒºè¿˜èƒ½å®¹çº³å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼Œè¿™æ ·å¯ä»¥æ§åˆ¶å‘é€æ•°æ®çš„é€Ÿåº¦; optionsåé¢å†è¯´;lengthæ˜¯æŒ‡æ•°æ®é•¿åº¦ï¼Œæ²¡åŒ…æ‹¬å¤´éƒ¨é•¿åº¦ï¼Œå³æ•´ä¸ªæŠ¥æ–‡é•¿åº¦å‡å»å¤´ éƒ¨é•¿åº¦ã€‚2.åå…­è¿›åˆ¶æ•°æ®å…·ä½“åˆ†æã€‚(16ä½ä¸€ ç»„ï¼Œä¸€ç»„ä¸¤å­—èŠ‚)</p><p><img src="/img/00003/ipå¤´éƒ¨.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><imgsrc="/img/00003/ipv4å¤´éƒ¨ç»“æ„.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" />ç”±äºIPçš„é€‰é¡¹å¾ˆå°‘ç”¨åˆ°ï¼Œæ‰€ä»¥åŸºæœ¬ä¸Šéƒ½æ˜¯20å­—èŠ‚ã€‚</p><table><thead><tr class="header"><th>åå…­è¿›åˆ¶</th><th>åè¿›åˆ¶</th><th>äºŒè¿›åˆ¶</th><th>IPå¤´éƒ¨ä¿¡æ¯</th></tr></thead><tbody><tr class="odd"><td>0x4</td><td>4</td><td></td><td>IPç‰ˆæœ¬å·</td></tr><tr class="even"><td>0x5</td><td>5</td><td></td><td>å¤´éƒ¨é•¿åº¦ä¸º5ä¸ª32ä½ï¼ˆ20å­—èŠ‚ï¼‰</td></tr><tr class="odd"><td>0x10</td><td>16</td><td>0001 0000</td><td>TOSé€‰é¡¹ä¸­æœ€å°å»¶æ—¶æœåŠ¡è¢«å¼€å¯</td></tr><tr class="even"><td>0x0037</td><td>55</td><td></td><td>æ•°æ®æŠ¥æ€»é•¿åº¦ï¼Œ55å­—èŠ‚</td></tr><tr class="odd"><td>0x3498</td><td></td><td></td><td>æ•°æ®æŠ¥æ ‡è¯†</td></tr><tr class="even"><td>0x4</td><td>4</td><td>0100ï¼ˆå‰ä¸‰ä½æœ‰ç”¨ï¼‰</td><td>è®¾ç½®äº†ç¦æ­¢åˆ†ç‰‡æ ‡å¿—</td></tr><tr class="odd"><td>0x000</td><td>0</td><td></td><td>åˆ†ç‰‡åç§»</td></tr><tr class="even"><td>0x40</td><td>64</td><td></td><td>TTLè¢«è®¾ä¸º64</td></tr><tr class="odd"><td>0x06</td><td>6</td><td></td><td>åè®®å­—æ®µä¸º6ï¼Œè¡¨ç¤ºä¸Šå±‚åè®®æ˜¯TCPåè®®</td></tr><tr class="even"><td>0x8344</td><td></td><td></td><td>IPå¤´éƒ¨æ ¡éªŒå’Œ</td></tr><tr class="odd"><td>0xc0a8 0107</td><td></td><td>11000000.10101000.00000001.00000111</td><td>32ä½æºç«¯IPåœ°å€ 192.168.1.7</td></tr><tr class="even"><td>0x784f 48d6</td><td></td><td>01111000.01001111.01001000.11010110</td><td>32ä½ç›®çš„ç«¯IPåœ°å€ 120.79.72.214</td></tr></tbody></table></blockquote><p><img src="/img/00003/tcpå¤´éƒ¨.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><imgsrc="/img/00003/tcpå¤´éƒ¨é€‰é¡¹.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p><table><thead><tr class="header"><th>åå…­è¿›åˆ¶</th><th>åè¿›åˆ¶</th><th>äºŒè¿›åˆ¶</th><th>TCPå¤´éƒ¨ä¿¡æ¯</th></tr></thead><tbody><tr class="odd"><td>0x9b7c</td><td>39804</td><td></td><td>æºç«¯å£å·</td></tr><tr class="even"><td>0x0007</td><td>7</td><td></td><td>ç›®çš„ç«¯å£å·</td></tr><tr class="odd"><td>0xe510 4c43</td><td></td><td></td><td>åºåˆ—å·</td></tr><tr class="even"><td>0xb5e9 5a56</td><td></td><td></td><td>ç¡®è®¤å·</td></tr><tr class="odd"><td>0x8</td><td>8</td><td></td><td>TCPå¤´éƒ¨é•¿åº¦ä¸º8ä¸ª32ä½ï¼ˆ32å­—èŠ‚ï¼‰</td></tr><tr class="even"><td>0x018</td><td></td><td>00011000ï¼ˆåé¢6ä½æœ‰æ•ˆï¼‰</td><td>ACKå’ŒPSHæ ‡å¿—ä½å¼€å¯</td></tr><tr class="odd"><td>0x01f6</td><td>502</td><td></td><td>çª—å£å¤§å°</td></tr><tr class="even"><td>0x82fe</td><td></td><td></td><td>16ä½æ ¡éªŒå’Œ</td></tr><tr class="odd"><td>0x0000</td><td></td><td></td><td>æ²¡è®¾ç½®URGæ ‡å¿—ï¼Œç´§æ€¥æŒ‡é’ˆæ­¤å¤„æ— æ„ä¹‰</td></tr><tr class="even"><td>0x0101</td><td></td><td></td><td>ä¸¤æ¬¡kindçš„å€¼å‡ä¸º1ï¼Œä¸¤æ¬¡nopæ“ä½œï¼Œä¸€èˆ¬ç”¨äºå°†TCPé€‰é¡¹çš„æ€»é•¿åº¦å¡«å……ä¸º4å­—èŠ‚çš„æ•´æ•°å€</td></tr><tr class="odd"><td>0x080a</td><td></td><td></td><td>kind=8ï¼Œlength=10ï¼ˆ10å­—èŠ‚ï¼‰ï¼Œæ—¶é—´æˆ³é€‰é¡¹ï¼Œè¾ƒä¸ºå‡†ç¡®çš„è®¡ç®—é€šä¿¡åŒæ–¹ä¹‹é—´çš„RTTï¼ˆå›è·¯æ—¶é—´ï¼‰</td></tr><tr class="even"><td>0x8ce4 e2fd</td><td>2363810557</td><td></td><td>æ—¶é—´æˆ³</td></tr><tr class="odd"><td>0x2c4e 1d26</td><td>743316774</td><td></td><td>å›æ˜¾åº”ç­”æ—¶é—´æˆ³</td></tr></tbody></table><p><img src="/img/00003/æ•°æ®æ®µ.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /> |åå…­è¿›åˆ¶| åè¿›åˆ¶| äºŒè¿›åˆ¶| æ•°æ®æ®µä¿¡æ¯| |--|--|--|--| | 0x31| 49| |å­—ç¬¦â€˜1â€™| | 0x0d| 13| | å›è½¦ç¬¦| | 0x0a| 10| | æ¢è¡Œç¬¦| &gt;ä¸€å…±ä¸‰ä¸ªå­—èŠ‚ã€‚&gt;## 8.Flags[p.],Flags[F.],Flags[.]ä¸­çš„ç‚¹çš„å«ä¹‰&gt;[.]è¿™ä¸ªç‚¹çš„å«ä¹‰é€šå¸¸æ˜¯è¡¨ç¤ºACK(è¿™ä¸ªACKå’Œç¡®è®¤å·ä¸åŒï¼Œè¿™æ˜¯æ ‡å¿—ä½)ï¼Œè¿˜å¯ä»¥è¡¨ç¤ºURG&gt;<strong>Flags[F.]ã€Flags[p.]å’ŒFlags[.]è¿™é‡Œçš„ç‚¹è¡¨ç¤ºçš„å°±æ˜¯ACKæ ‡å¿—ä½å¼€å¯</strong>ã€‚&gt;## 9.MSS(æœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦)&gt;TCPæ¨¡å—é€šå¸¸å°†MSSè®¾ç½®ä¸ºã€MTUï¼ˆæœ€å¤§ä¼ è¾“å•å…ƒï¼‰-40ã€‘å­—èŠ‚ï¼Œ40å­—èŠ‚æ˜¯TCPå’ŒIPçš„å¤´éƒ¨æ€»å’Œã€‚è¿™æ ·æºå¸¦TCPæŠ¥æ–‡æ®µçš„IPæ•°æ®æŠ¥çš„é•¿åº¦å°±ä¸ä¼šè¶…è¿‡MTUï¼ˆå‡è®¾TCPå’ŒIPå¤´éƒ¨ä¸åŒ…å«é€‰é¡¹å­—æ®µï¼‰ï¼Œä»è€Œé¿å…æœ¬æœºå‘ç”ŸIPåˆ†ç‰‡ã€‚ä»¥å¤ªç½‘çš„MSSå€¼æ˜¯1460ï¼ˆ1500-40ï¼‰å­—èŠ‚ã€‚# å¤ä½æŠ¥æ–‡æ®µ &gt;æºå¸¦RSTæ ‡å¿—çš„æŠ¥æ–‡æ®µï¼Œå³å¤ä½æŠ¥æ–‡æ®µã€‚&gt;äº§ç”Ÿå¤ä½æŠ¥æ–‡æ®µçš„å››ç§æƒ…å†µ &gt;1.å½“å®¢æˆ·ç«¯è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„ç«¯å£æ—¶ã€‚&gt;2.å®¢æˆ·ç«¯ç¨‹åºå‘æœåŠ¡å™¨çš„æŸä¸ªç«¯å£å‘èµ·è¿æ¥ï¼Œè€Œè¯¥ç«¯å£ä»è¢«å¤„äºTIME_WAITçŠ¶æ€çš„è¿æ¥æ‰€å ç”¨æ—¶ã€‚&gt;3.å¼‚å¸¸ç»ˆæ­¢è¿æ¥ï¼ŒTCPæä¾›äº†å¼‚å¸¸ç»ˆæ­¢ä¸€ä¸ªè¿æ¥çš„æ–¹æ³•ï¼Œå³ç»™å¯¹æ–¹å‘é€ä¸€ä¸ªå¤ä½æŠ¥æ–‡æ®µï¼Œä¸€æ—¦å‘é€äº†å¤ä½æŠ¥æ–‡æ®µï¼Œå‘é€ç«¯æ‰€æœ‰æ’é˜Ÿç­‰å¾…å‘é€çš„æ•°æ®éƒ½å°†è¢«ä¸¢å¼ƒã€‚&gt;4.æœåŠ¡å™¨ï¼ˆæˆ–å®¢æˆ·ç«¯ï¼‰å…³é—­æˆ–è€…å¼‚å¸¸ç»ˆæ­¢äº†è¿æ¥ï¼Œè€Œå¯¹æ–¹æ²¡æ¥æ”¶åˆ°ç»“æŸæŠ¥æ–‡æ®µï¼ˆæ¯”å¦‚ç½‘ç»œæ•…éšœï¼‰ï¼Œæ­¤æ—¶ï¼Œå®¢æˆ·ç«¯ï¼ˆæˆ–æœåŠ¡å™¨ï¼‰è¿˜ç»´æŒç€åŸæ¥çš„è¿æ¥ã€‚è¿™ç§çŠ¶æ€ç§°ä¸ºåŠæ‰“å¼€çŠ¶æ€ï¼Œå¤„äºè¿™ç§çŠ¶æ€çš„è¿æ¥ç§°ä¸ºåŠæ‰“å¼€è¿æ¥ã€‚å¦‚æœå®¢æˆ·ç«¯ï¼ˆæˆ–æœåŠ¡å™¨ï¼‰å¾€å¤„äºåŠæ‰“å¼€çŠ¶æ€çš„è¿æ¥å†™å…¥æ•°æ®ï¼Œåˆ™å¯¹æ–¹å°†å›åº”ä¸€ä¸ªå¤ä½æŠ¥æ–‡æ®µã€‚# TCPè¶…æ—¶é‡ä¼ &gt;TCPæ¨¡å—ä¸ºæ¯ä¸ªTCPæŠ¥æ–‡æ®µéƒ½ç»´æŠ¤ä¸€ä¸ªé‡ä¼ å®šæ—¶å™¨ï¼Œè¯¥å®šæ—¶å™¨åœ¨TCPæŠ¥æ–‡æ®µç¬¬ä¸€æ¬¡è¢«å‘é€æ—¶å¯åŠ¨ã€‚å¦‚æœè¶…æ—¶æ—¶é—´å†…æœªæ”¶åˆ°æ¥æ”¶æ–¹çš„åº”ç­”ï¼ŒTCPæ¨¡å—å°†é‡ä¼ TCPæŠ¥æ–‡æ®µå¹¶é‡ç½®å®šæ—¶å™¨ã€‚è‡³äºä¸‹æ¬¡é‡ä¼ çš„è¶…æ—¶æ—¶é—´å¦‚ä½•é€‰æ‹©ï¼Œä»¥åŠæœ€å¤šæ‰§è¡Œå¤šå°‘æ¬¡é‡ä¼ ï¼Œå°±æ˜¯TCPçš„é‡ä¼ ç­–ç•¥ã€‚å…¶å®è·ŸTCPè¶…æ—¶é‡è¿çš„ç­–ç•¥ç›¸ä¼¼ï¼Œåœ¨5æ¬¡é‡ä¼ å‡å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œåº•å±‚çš„IPå’ŒARPå¼€å§‹æ¥ç®¡ï¼Œç›´åˆ°å®¢æˆ·ç«¯æ”¾å¼ƒè¿æ¥ä¸ºæ­¢ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>C++Aæ˜Ÿå¯»è·¯çš„å®ç°</title>
    <link href="/2021/02/07/00002.%20C++A%E6%98%9F%E5%AF%BB%E8%B7%AF%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <url>/2021/02/07/00002.%20C++A%E6%98%9F%E5%AF%BB%E8%B7%AF%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><blockquote><p><strong>æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚</strong><br />æœ¬æ–‡ä¸»è¦è®²çš„Aæ˜Ÿå¯»è·¯çš„ä»£ç å®ç°ï¼Œå¯¹Aæ˜Ÿå¯»è·¯æœ‰ä¸€å®šçš„äº†è§£åå†æ¥é˜…è¯»æœ¬æ–‡æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚æœ¬æ–‡è¿˜ç”¨åˆ°äº†å›¾å½¢åº“ï¼Œç¼–è¯‘å™¨ä¸ºvs2019ã€‚å›¾å½¢åº“æ²¡æœ‰çš„å¯ä»¥å»å®˜æ–¹ç½‘ç«™ä¸‹è½½ï¼Œæ­¥éª¤å¾ˆç®€å•ä¸‹è½½ç›´æ¥å®‰è£…å³å¯ã€‚Aæ˜Ÿå¯»è·¯çš„æµç¨‹ 1.å‡†å¤‡å­˜å‚¨çš„è·¯å¾„å’Œç»ˆç‚¹æ ‡å¿—ä½ã€‚ 2.å°†èµ·ç‚¹æ”¾å…¥closeList3.å°†èµ·ç‚¹å‘¨å›´çš„æ ¼å­æ”¾å…¥openlist 4.å¯»æ‰¾æœ€å°å’Œå€¼Få’Œç»ˆç‚¹5.æ‰¾åˆ°åå°†å®ƒå­˜å…¥closeliståŒæ—¶å°†å®ƒä»openlistä¸­å‰”é™¤6.ä»ç»ˆç‚¹æ ‡å¿—ä½å¼€å§‹å¾€çˆ¶äº²èŠ‚ç‚¹éå†ï¼Œå­˜å…¥è·¯å¾„ä¸­ã€‚ 7.è¾“å‡ºè·¯å¾„ã€‚å‰©ä¸‹çš„è§£é‡Šå…¨åœ¨ä»£ç æ³¨é‡Šä¸­ã€‚--------------------------------------------------------</p></blockquote><h1 id="main.cpp">main.cpp</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;easyx.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;list&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;AStart.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;Level.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;Draw.h&quot;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LevelMap</span>:<span class="hljs-keyword">public</span> Level<br>&#123;<br><span class="hljs-keyword">public</span>:<br>vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; level;<br><span class="hljs-comment">// é€šè¿‡ Level ç»§æ‰¿</span><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">isValid</span><span class="hljs-params">(Pos v)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> !((v.x&lt;<span class="hljs-number">0</span>||v.y&lt;<span class="hljs-number">0</span>)||<br>v.x&gt; level[v.x].<span class="hljs-built_in">size</span>()||v.y&gt; level.<span class="hljs-built_in">size</span>()||<br>level[v.y][v.x]==<span class="hljs-number">1</span>);<br>&#125;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>vector &lt; vector&lt;<span class="hljs-type">int</span>&gt;&gt; vec = &#123;<span class="hljs-comment">//15*15</span><br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&#125;,<span class="hljs-comment">//â–¶x </span><br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#123;<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&#125;,<br><span class="hljs-comment">//â–¼y</span><br>&#125;;<br>LevelMap lm;<br>lm.level = vec;<br><span class="hljs-function">AStart <span class="hljs-title">a</span><span class="hljs-params">(lm)</span></span>;<br><span class="hljs-function">Draw <span class="hljs-title">draw</span><span class="hljs-params">(<span class="hljs-number">600</span>, vec)</span></span>;<br>draw.<span class="hljs-built_in">update</span>();<br>list&lt;Pos&gt; path;<br>Pos start&#123; <span class="hljs-number">-1</span>,<span class="hljs-number">-1</span> &#125;;<br>Pos end&#123; <span class="hljs-number">-1</span>,<span class="hljs-number">-1</span> &#125;;<br><span class="hljs-type">int</span> x;<span class="hljs-comment">//ä»é¼ æ ‡çš„ä½ç½®è½¬æ¢åˆ°</span><br><span class="hljs-type">int</span> y;<span class="hljs-comment">//è´´å›¾éœ€è¦æ›´æ”¹çš„ä½ç½®</span><br><span class="hljs-type">bool</span> flag=<span class="hljs-literal">false</span>;<span class="hljs-comment">//èµ·ç‚¹å’Œç»ˆç‚¹çš„æ ‡å¿—ä½</span><br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<br>&#123;<br>draw.level = lm.level;<br>draw.<span class="hljs-built_in">update</span>();<br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)<br>&#123;<br>MOUSEMSG msg = <span class="hljs-built_in">GetMouseMsg</span>();<br>x = msg.x / draw.<span class="hljs-built_in">getSize</span>();<br>y = msg.y / draw.<span class="hljs-built_in">getSize</span>();<br><span class="hljs-keyword">if</span> (msg.uMsg == WM_RBUTTONDOWN)<span class="hljs-comment">//å³é”®æŒ‰ä¸‹ï¼Œè·¯å˜å¢™ï¼Œå¢™å˜è·¯ã€‚</span><br>&#123;<br>lm.level[y][x] = draw.level[y][x] =<br>draw.level[y][x] == Draw::road ? Draw::wall : Draw::road;<br>draw.<span class="hljs-built_in">update</span>();<br>&#125;<br><span class="hljs-keyword">if</span> (msg.uMsg == WM_LBUTTONDOWN)<span class="hljs-comment">//å·¦é”®æŒ‰ä¸‹è®¾ç½®èµ·ç‚¹ç»ˆç‚¹å‡†å¤‡å¯»è·¯ã€‚</span><br>&#123;<span class="hljs-comment">//è¿™é‡Œä¸èƒ½å°†lm.levelæ”¹å˜ï¼Œéœ€è¦è¿˜åŸç”¨ã€‚</span><br><span class="hljs-keyword">if</span> (!flag &amp;&amp; draw.level[y][x] == Draw::road)<br>&#123;<br>start.x = x;<br>start.y = y;<br>draw.level[y][x] = Draw::visit;<br>flag = <span class="hljs-literal">true</span>;<br>draw.<span class="hljs-built_in">update</span>();<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (draw.level[y][x] == Draw::road)<br>&#123;<br>end.x = x;<br>end.y = y;<br>draw.level[y][x] = Draw::end;<br>path = a.<span class="hljs-built_in">find</span>(start, end);<br>flag = <span class="hljs-literal">false</span>;<br>draw.<span class="hljs-built_in">update</span>();<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; e : path)<br>&#123;<br>draw.level[e.y][e.x] = Draw::visit;<br>draw.<span class="hljs-built_in">update</span>();<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">test</span>();<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="level.h">Level.h</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Pos</span><br>&#123;<br><span class="hljs-type">int</span> x;<br><span class="hljs-type">int</span> y;<br><span class="hljs-built_in">Pos</span>(<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>, <span class="hljs-type">int</span> y = <span class="hljs-number">0</span>):<span class="hljs-built_in">x</span>(x),<span class="hljs-built_in">y</span>(y)&#123;&#125;<br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Level</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-comment">//å¤–éƒ¨è§„åˆ™</span><br><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">isValid</span><span class="hljs-params">(Pos v)</span> </span>= <span class="hljs-number">0</span>;<br>&#125;;<br><br></code></pre></td></tr></table></figure><h1 id="draw.h">Draw.h</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-comment">//å–åˆ«å</span><br><span class="hljs-keyword">using</span> Vec2r = std::vector&lt;std::vector&lt;<span class="hljs-type">int</span>&gt;&gt;;<br><br><span class="hljs-comment">//ç»˜åˆ¶åœ°å›¾çš„ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Draw</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>  <span class="hljs-comment">/*ä½¿ç”¨å›¾å½¢åº“çš„æ¥å£å®ç°åœ°å›¾ç»˜åˆ¶</span><br><span class="hljs-comment">   *length  å±å¹•é•¿åº¦</span><br><span class="hljs-comment">    level   åœ°å›¾å…³å¡</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-built_in">Draw</span>(<span class="hljs-type">int</span> length, Vec2r&amp; level);<br>  ~<span class="hljs-built_in">Draw</span>();<br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">  0 è·¯</span><br><span class="hljs-comment">  1 å¢™</span><br><span class="hljs-comment">  2 èµ°è¿‡çš„è·¯å¾„</span><br><span class="hljs-comment">  3 ç»ˆç‚¹</span><br><span class="hljs-comment">  */</span><br>  <span class="hljs-keyword">enum</span> &#123;<br>road=<span class="hljs-number">0</span>,<br>wall,<br>visit,<br>end,<br>  &#125;; <br>  Vec2r level;   <span class="hljs-comment">//ç»˜åˆ¶çš„åœ°å›¾ä¸Š</span><br><br>  <span class="hljs-comment">//åœ°å›¾æ›´æ–°å‡½æ•°</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">()</span></span>;<br><br>  <span class="hljs-comment">//è·å–ç“¦ç‰‡å¤§å°</span><br>  <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getSize</span><span class="hljs-params">()</span></span>;<br><br><span class="hljs-keyword">protected</span>:<br><br>  <span class="hljs-type">int</span> length;    <span class="hljs-comment">//å®½åº¦å’Œé«˜åº¦</span><br>  <span class="hljs-type">int</span> size;    <span class="hljs-comment">//æ¯ä¸ªç“¦ç‰‡çš„å¤§å°</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">draw</span><span class="hljs-params">()</span></span>;              <span class="hljs-comment">//ç»˜åˆ¶åœ°å›¾</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">text</span><span class="hljs-params">()</span></span>;              <span class="hljs-comment">//ç»˜åˆ¶æ–‡æœ¬</span><br>  <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rect</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>;   <span class="hljs-comment">//ç»˜åˆ¶ç“¦ç‰‡</span><br><br>&#125;;<br></code></pre></td></tr></table></figure><h1 id="draw.cpp">Draw.cpp</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Draw.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;easyx.h&gt;</span><span class="hljs-comment">//å›¾å½¢åº“æ–‡ä»¶</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br>Draw::<span class="hljs-built_in">Draw</span>(<span class="hljs-type">int</span> length, Vec2r&amp; level)<br>  :<span class="hljs-built_in">length</span>(length)<br>&#123;<br>  <span class="hljs-built_in">initgraph</span>(length, length, EW_SHOWCONSOLE);<span class="hljs-comment">//åˆå§‹åŒ–å›¾å½¢åº“,EW_SHOWCONSOLEè¡¨ç¤ºæ˜¾ç¤ºæ§åˆ¶å°</span><br>  size = length / level.<span class="hljs-built_in">size</span>();<span class="hljs-comment">//åŠ¨æ€è®¡ç®—å°æ–¹å—çš„å®½åº¦</span><br>  <span class="hljs-keyword">this</span>-&gt;level=level;<span class="hljs-comment">//ä»å¤–éƒ¨ä¼ å…¥åœ°å›¾</span><br>&#125;<br><br>Draw::~<span class="hljs-built_in">Draw</span>()<br>&#123;<br>  <span class="hljs-built_in">closegraph</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Draw::update</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">draw</span>();<br>  <span class="hljs-built_in">text</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Draw::getSize</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Draw::draw</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-built_in">BeginBatchDraw</span>();<span class="hljs-comment">//å¼€å§‹æ‰¹é‡ç”»å›¾</span><br>  <span class="hljs-built_in">cleardevice</span>();<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; level.<span class="hljs-built_in">size</span>(); i++)<span class="hljs-comment">//level.size()ç­‰äº7ï¼Œ</span><br>  &#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; level[i].<span class="hljs-built_in">size</span>(); j++)<span class="hljs-comment">//level[i].size()ç­‰äº7,è¿™é‡Œä¸æ‡‚æ˜¯å› ä¸ºäºŒç»´vectoræ²¡ç†è§£é€ã€‚</span><br>&#123;<br>  <span class="hljs-keyword">if</span> (level[i][j] == road)<span class="hljs-comment">//è·¯</span><br>  &#123;<br><span class="hljs-built_in">setfillcolor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0xdd</span>, <span class="hljs-number">0xdd</span>, <span class="hljs-number">0xdd</span>)); <span class="hljs-comment">//è®¾ç½®è·¯çš„é¢œè‰²</span><br>  &#125;<br>  <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span> (level[i][j] == wall)&#123;  <span class="hljs-comment">//å¢™</span><br><span class="hljs-built_in">setfillcolor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0x33</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xcc</span>));<br>  &#125;<br>  <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span> (level[i][j] == visit) &#123;  <span class="hljs-comment">//èµ°è¿‡çš„è·¯</span><br><span class="hljs-built_in">setfillcolor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0x33</span>, <span class="hljs-number">0xcc</span>, <span class="hljs-number">0x33</span>));<br>  &#125;<br>  <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span> (level[i][j] == end) &#123;  <span class="hljs-comment">//ç»ˆç‚¹</span><br><span class="hljs-built_in">setfillcolor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0xff</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x33</span>));<br>  &#125;<br>  <span class="hljs-built_in">rect</span>(j, i);<span class="hljs-comment">//ç»˜åˆ¶ç“¦ç‰‡ï¼Œjä»£è¡¨x  iä»£è¡¨y.</span><br>&#125;<br>  &#125;<br>  <span class="hljs-built_in">EndBatchDraw</span>();<span class="hljs-comment">//ç»“æŸæ‰¹é‡ç”»å›¾</span><br>&#125;<br><span class="hljs-comment">//ç»˜åˆ¶ç“¦ç‰‡</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Draw::rect</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> </span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">fillrectangle</span>(x * size, y * size, (x + <span class="hljs-number">1</span>) * size, (y + <span class="hljs-number">1</span>) * size);<br><span class="hljs-comment">/*void fillrectangle(</span><br><span class="hljs-comment">int left,</span><br><span class="hljs-comment">int top,</span><br><span class="hljs-comment">int right,</span><br><span class="hljs-comment">int bottom</span><br><span class="hljs-comment">);*/</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Draw::text</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  string m;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; level.<span class="hljs-built_in">size</span>(); i++)<br>  &#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; level[i].<span class="hljs-built_in">size</span>(); j++)<br>&#123;<br>  <span class="hljs-keyword">if</span> (level[i][j] == road)<span class="hljs-comment">//è·¯</span><br>  &#123;<br>m += <span class="hljs-string">&quot;  &quot;</span>; <span class="hljs-comment">//è®¾ç½®è·¯çš„é¢œè‰²</span><br>  &#125; <br>  <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span> (level[i][j] == wall) <br>  &#123;  <span class="hljs-comment">//å¢™</span><br>m += <span class="hljs-string">&quot;+ &quot;</span>;<br>  &#125; <br>  <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span> (level[i][j] == visit) <br>  &#123;  <span class="hljs-comment">//èµ°è¿‡çš„è·¯</span><br>m += <span class="hljs-string">&quot;. &quot;</span>;<br>  &#125; <br>  <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span> (level[i][j] == end) <br>  &#123;  <span class="hljs-comment">//ç»ˆç‚¹</span><br>m += <span class="hljs-string">&quot;= &quot;</span>;<br>  &#125;<br>&#125;<br>m += <span class="hljs-string">&quot;\n&quot;</span>;<br>  &#125;<br>  <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;cls&quot;</span>);  <span class="hljs-comment">//è°ƒç”¨å‘½ä»¤æ¸…å±</span><br>  cout &lt;&lt; m &lt;&lt; endl;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="astart.h">Astart.h</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Level.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;list&gt;</span></span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>Pos v;<span class="hljs-comment">//èŠ‚ç‚¹åæ ‡</span><br><span class="hljs-type">int</span> G;<span class="hljs-comment">//ä»èµ·ç‚¹åˆ°å½“å‰ä½ç½®çš„ä»£ä»·ï¼›</span><br><span class="hljs-type">int</span> H;<span class="hljs-comment">//ä»å½“å‰ä½ç½®åˆ°ç»ˆç‚¹çš„é¢„ä¼°ä»£ä»·ï¼›</span><br>Node* pre;<span class="hljs-comment">//æ ‘çš„çˆ¶äº²èŠ‚ç‚¹</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getF</span><span class="hljs-params">()</span> </span>&#123; <span class="hljs-keyword">return</span> G + H; &#125;<span class="hljs-comment">//ä»£ä»·å’Œå€¼</span><br><span class="hljs-built_in">Node</span>(Pos v, <span class="hljs-type">int</span> G, <span class="hljs-type">int</span> H, Node* pre = <span class="hljs-literal">nullptr</span>) :<span class="hljs-built_in">v</span>(v), <span class="hljs-built_in">G</span>(G), <span class="hljs-built_in">H</span>(H), <span class="hljs-built_in">pre</span>(pre) &#123;&#125;<br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AStart</span> <br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">AStart</span>(Level&amp; level) :<span class="hljs-built_in">level</span>(level) &#123;&#125;<span class="hljs-comment">//å¤šæ€ä¸èƒ½ç”¨åŸºç±»å®ä¾‹åŒ–å¯¹è±¡è¿™é‡Œçš„å¼•ç”¨ä¸èƒ½æ‰</span><br><span class="hljs-function">std::list&lt;Pos&gt; <span class="hljs-title">find</span><span class="hljs-params">(Pos start, Pos end)</span></span>;<br><span class="hljs-keyword">private</span>:<br>Level&amp; level;<span class="hljs-comment">//å¤šæ€</span><br>Pos end;<span class="hljs-comment">//ä¿å­˜ç»ˆç‚¹åæ ‡</span><br>std::list&lt;Node*&gt; openLsit;<span class="hljs-comment">//å‡†å¤‡è¦èµ°çš„è·¯ä½†æ˜¯æ²¡æœ‰èµ°ï¼›</span><br>std::list&lt;Node*&gt; closeList;<span class="hljs-comment">//èµ°è¿‡çš„è·¯ï¼Œæ­£åœ¨èµ°çš„è·¯ï¼›</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addRound</span><span class="hljs-params">(Node* now)</span></span>;<span class="hljs-comment">//å°†èŠ‚ç‚¹å‘¨å›´çš„èŠ‚ç‚¹åŠ å…¥openlist</span><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">getH</span><span class="hljs-params">(Pos now)</span></span>;<span class="hljs-comment">//è·å–èŠ‚ç‚¹ä½ç½®ä¸ç»ˆç‚¹çš„é¢„ä¼°è·ç¦»</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check</span><span class="hljs-params">(Pos v)</span></span>;<span class="hljs-comment">//æ£€æŸ¥è¯¥åæ ‡èƒ½ä¸èƒ½åŠ å…¥openlist</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">findList</span><span class="hljs-params">(Pos v)</span></span>;<span class="hljs-comment">//æ£€æŸ¥è¯¥åæ ‡æ˜¯å¦åœ¨openlistæˆ–è€…closelistä¸­</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">destory</span><span class="hljs-params">()</span></span>;<span class="hljs-comment">//é‡Šæ”¾å†…å­˜ã€‚</span><br>&#125;;<br></code></pre></td></tr></table></figure><h1 id="astart.cpp">Astart.cpp</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;AStart.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-function">std::list&lt;Pos&gt; <span class="hljs-title">AStart::find</span><span class="hljs-params">(Pos start, Pos end)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">this</span>-&gt;end = end;<br>    std::list&lt;Pos&gt; path;<br>    closeList.<span class="hljs-built_in">push_back</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Node</span>(start, <span class="hljs-number">0</span>, <span class="hljs-built_in">getH</span>(start)));<br>    Node* endNode = <span class="hljs-literal">nullptr</span>;<span class="hljs-comment">//ç»ˆç‚¹åˆ°è¾¾æ ‡å¿—ä½,åŒæ—¶ä¸ºéå†çˆ¶äº²èŠ‚ç‚¹åšå‡†å¤‡</span><br>    <br>    <span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;<span class="hljs-comment">//åšå¾ªç¯çš„åˆ¤æ–­æ¡ä»¶ç”¨çš„</span><br>    <span class="hljs-keyword">while</span> (length &lt; closeList.<span class="hljs-built_in">size</span>()&amp;&amp;!endNode)<br>    &#123;<br>        length = closeList.<span class="hljs-built_in">size</span>();<br>        <span class="hljs-built_in">addRound</span>(closeList.<span class="hljs-built_in">back</span>());<br>        <br>        <span class="hljs-comment">//æ‰¾åˆ°openListé‡Œé¢å’Œå€¼æœ€å°çš„node</span><br>        <span class="hljs-keyword">auto</span> it = openLsit.<span class="hljs-built_in">begin</span>();<span class="hljs-comment">//é»˜è®¤æœ€å°çš„æ˜¯openListçš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±å°†å…¶æ›¿æ¢ã€‚</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> i = openLsit.<span class="hljs-built_in">begin</span>(); i != openLsit.<span class="hljs-built_in">end</span>(); i++)<br>        &#123;<br>            <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹</span><br>            <span class="hljs-keyword">if</span> ((*i)-&gt;v.x == end.x &amp;&amp; (*i)-&gt;v.y == end.y)<br>            &#123;<br>                endNode=*i;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-comment">//æ‰¾åˆ°æœ€å°çš„å’Œå€¼F</span><br>            <span class="hljs-keyword">if</span> ((*it)-&gt;<span class="hljs-built_in">getF</span>() &gt; (*i)-&gt;<span class="hljs-built_in">getF</span>())<br>            &#123;<br>                it = i;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//å°†æ‰¾åˆ°çš„æœ€å°å’Œå€¼Fçš„èŠ‚ç‚¹æ”¾å…¥closeListä¸­,åŒæ—¶éœ€è¦å°†æ­¤èŠ‚ç‚¹ä»openlistä¸­å‰”é™¤ï¼›</span><br>        <span class="hljs-keyword">if</span> (it != openLsit.<span class="hljs-built_in">end</span>())<br>        &#123;<br>            closeList.<span class="hljs-built_in">push_back</span>((*it));<br>            openLsit.<span class="hljs-built_in">erase</span>(it);<br>        &#125;<br>        <span class="hljs-comment">//breakåå°†è·¯å¾„ä»ç»ˆç‚¹å¾€çˆ¶äº²èŠ‚ç‚¹éå†ï¼Œé€ä¸ªæ’å…¥åˆ°pathçš„å¤´éƒ¨ï¼Œå®ç°æ­£åºè¾“å‡ºã€‚</span><br>    &#125;<br>    <span class="hljs-keyword">if</span> (endNode)<br>    &#123;<br>        <span class="hljs-keyword">while</span> (endNode)<br>        &#123;<br>            path.<span class="hljs-built_in">push_front</span>(endNode-&gt;v);<br>            endNode = endNode-&gt;pre;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//æœ€åå†…å­˜çš„æ¸…ç†</span><br>    <span class="hljs-built_in">destory</span>();<br>    <span class="hljs-keyword">return</span> path;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AStart::getH</span><span class="hljs-params">(Pos now)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">abs</span>(now.x-end.x)+std::<span class="hljs-built_in">abs</span>(now.y-end.y);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">AStart::check</span><span class="hljs-params">(Pos v)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (level.<span class="hljs-built_in">isValid</span>(v) &amp;&amp; !<span class="hljs-built_in">findList</span>(v))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">AStart::findList</span><span class="hljs-params">(Pos v)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; e : openLsit)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (e-&gt;v.x == v.x &amp;&amp; e-&gt;v.y == v.y)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; e : closeList)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (e-&gt;v.x == v.x &amp;&amp; e-&gt;v.y == v.y)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AStart::destory</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> e : openLsit)<br>        <span class="hljs-keyword">delete</span> e;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> e : closeList)<br>        <span class="hljs-keyword">delete</span> e;<br>    openLsit.<span class="hljs-built_in">clear</span>();<br>    closeList.<span class="hljs-built_in">clear</span>();<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AStart::addRound</span><span class="hljs-params">(Node* now)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> Pos dir[]<span class="hljs-comment">//ä½¿ç”¨èŠ±æ‹¬å·ç›´æ¥åˆå§‹åŒ–ä¸èƒ½æœ‰å¼ºè½¬å¦åˆ™ä¼šæŠ¥é”™</span><br>    &#123;<br>        &#123;<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<span class="hljs-comment">//ä¸‹</span><br>        &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>&#125;,<span class="hljs-comment">//å³</span><br>        &#123;<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>&#125;,<span class="hljs-comment">//ä¸Š</span><br>        &#123;<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>&#125;<span class="hljs-comment">//å·¦</span><br>    &#125;;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> e : dir)<br>    &#123;<br>        e = &#123; now-&gt;v.x + e.x,now-&gt;v.y + e.y &#125;;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">check</span>(e))<br>        &#123;<br>            openLsit.<span class="hljs-built_in">push_back</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Node</span>(e, now-&gt;G + <span class="hljs-number">1</span>, <span class="hljs-built_in">getH</span>(e), now));<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><h1 id="æµ‹è¯•ç»“æœ">æµ‹è¯•ç»“æœ</h1><p><img src="/img/00002/Astar.gif" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /> #æœ€è¿‘æœ‰å°ä¼™ä¼´éœ€è¦è¿™æ•´ä¸ªå·¥ç¨‹ï¼Œæ¥æ»¡è¶³ä¸€ä¸‹å¤§å®¶ã€‚ <ahref="https://download.csdn.net/download/Howl_1/86893463">Aæ˜Ÿå¯»è·¯å·¥ç¨‹ï¼Œvs2019ï¼Œ0ç§¯åˆ†ä¸‹è½½</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>C++</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>C++æ·±åº¦ä¼˜å…ˆå’Œå¹¿åº¦ä¼˜å…ˆçš„å®ç°</title>
    <link href="/2021/01/27/00001.%20C++%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E5%92%8C%E5%B9%BF%E5%BA%A6%E4%BC%98%E5%85%88%E7%9A%84%E5%AE%9E%E7%8E%B0/"/>
    <url>/2021/01/27/00001.%20C++%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E5%92%8C%E5%B9%BF%E5%BA%A6%E4%BC%98%E5%85%88%E7%9A%84%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€">å‰è¨€</h1><blockquote><p><strong>æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚</strong><br />æœ¬æ–‡ä¸»è¦è®²çš„æ·±åº¦ä¼˜å…ˆç®—æ³•å’Œå¹¿åº¦ä¼˜å…ˆç®—æ³•çš„åŒºåˆ«ï¼Œå…¶ä¸­æ·±åº¦ä¼˜å…ˆæœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œä¸€ç§æ˜¯é€’å½’æ³•ï¼Œå¦ä¸€ç§æ˜¯éé€’å½’ï¼ˆæ ˆå®ç°ï¼‰ï¼Œè€Œå¹¿åº¦ä¼˜å…ˆå°±æ˜¯é˜Ÿåˆ—çš„å®ç°ï¼›åé¢è¿˜ä¼šä»¥å›¾å½¢è¡¨è¿°æ ˆå®ç°å’Œé˜Ÿåˆ—å®ç°ï¼›ä¸”ç”¨åˆ°äº†å›¾å½¢åº“easyxï¼›--------------------------------------------------------</p></blockquote><h1 id="æºç å¦‚ä¸‹">æºç å¦‚ä¸‹ï¼š</h1><h4 id="main.cpp">main.cpp</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;windows.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;Draw.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;DFS.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;BFS.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&quot;Search.h&quot;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br>vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; map =<br>&#123;<br>    &#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>    &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>    &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>&#125;,<br>    &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>&#125;,<br>    &#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>    &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>&#125;,<br>    &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<br>&#125;;<br><span class="hljs-comment">//æ£€æŸ¥æ•°æ®çš„åˆæ³•æ€§</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//æ‰€èµ°çš„è·¯å¾„ä¸èƒ½è¶Šç•Œï¼Œä¹Ÿä¸èƒ½èµ°åˆ°åœ°å›¾ä¸º1çš„åœ°æ–¹ã€‚</span><br>    <span class="hljs-keyword">if</span> ((y &lt; <span class="hljs-number">0</span> ||  x&lt;<span class="hljs-number">0</span>) || y &gt;= map.<span class="hljs-built_in">size</span>() ||x&gt;=map[y].<span class="hljs-built_in">size</span>() || map[y][x] == <span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-comment">//æµ‹è¯•å›¾å½¢åº“æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œ</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">Draw <span class="hljs-title">draw</span><span class="hljs-params">(<span class="hljs-number">600</span>, map)</span></span>;<br>    draw.<span class="hljs-built_in">updata</span>();<br>&#125;<br><span class="hljs-comment">//æ·±åº¦ä¼˜å…ˆç®—æ³•</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">DFS <span class="hljs-title">dfs</span><span class="hljs-params">(check)</span></span>;<br>    <span class="hljs-function">Draw <span class="hljs-title">draw</span><span class="hljs-params">(<span class="hljs-number">600</span>, map)</span></span>;<br>    Pos start&#123; <span class="hljs-number">0</span>,<span class="hljs-number">0</span> &#125;;<br>    Pos end&#123; <span class="hljs-number">1</span>,<span class="hljs-number">6</span> &#125;;<br>    draw.level[end.y][end.x] = Draw::end;<span class="hljs-comment">//è®¾ç½®ç»ˆç‚¹ä½ç½®</span><br>    draw.<span class="hljs-built_in">updata</span>();<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; path = dfs.<span class="hljs-built_in">recursive</span>(start,end);<span class="hljs-comment">//å¼€å§‹å¯»è·¯ï¼Œè·¯å¾„æ‰¾å®Œåç”¨vectorä¿å­˜äº†</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; e : path)<br>    &#123;<br>        draw.level[e.y][e.x] = Draw::visit;<span class="hljs-comment">//è·¯å¾„è®¾ç½®ä¸ºvisitã€‚æ³¨æ„xï¼Œyä¸è¦å†™åäº†</span><br>        draw.<span class="hljs-built_in">updata</span>();<br>        <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">500</span>);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//å¹¿åº¦ä¼˜å…ˆç®—æ³•</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">BFS <span class="hljs-title">bfs</span><span class="hljs-params">(check)</span></span>;<br>    <span class="hljs-function">Draw <span class="hljs-title">draw</span><span class="hljs-params">(<span class="hljs-number">600</span>, map)</span></span>;<br>    Pos start&#123; <span class="hljs-number">1</span>,<span class="hljs-number">1</span> &#125;;<br>    Pos end&#123; <span class="hljs-number">3</span>,<span class="hljs-number">0</span> &#125;;<br>    draw.level[end.y][end.x] = Draw::end;<br>    draw.<span class="hljs-built_in">updata</span>();<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; path = bfs.<span class="hljs-built_in">queue</span>(start, end);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; e : path)<br>    &#123;<br>        draw.level[e.y][e.x] = Draw::visit;<br>        draw.<span class="hljs-built_in">updata</span>();<br>        <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">500</span>);<br>    &#125;<br><br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//test();</span><br>    <span class="hljs-comment">//test1();</span><br>    <span class="hljs-comment">//test2();</span><br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="draw.h">Draw.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;easyx.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><br><span class="hljs-comment">//åŒºåˆ«å</span><br><span class="hljs-keyword">using</span> vec2 = std::vector&lt;std::vector&lt;<span class="hljs-type">int</span>&gt;&gt;;<br><span class="hljs-comment">//ç»˜åˆ¶åœ°å›¾çš„ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Draw</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">Draw</span>(<span class="hljs-type">int</span>&amp;&amp; length, vec2&amp; map) :<span class="hljs-built_in">length</span>(length)<br>&#123;<br><span class="hljs-keyword">this</span>-&gt;level = map;<br><span class="hljs-keyword">this</span>-&gt;size = length / level.<span class="hljs-built_in">size</span>();<br><span class="hljs-built_in">initgraph</span>(length, length, EW_SHOWCONSOLE);<br>&#125;<br>~<span class="hljs-built_in">Draw</span>()<br>&#123;<br><span class="hljs-built_in">closegraph</span>();<br>&#125;<br><span class="hljs-keyword">enum</span> &#123;<br>road=<span class="hljs-number">0</span>,<span class="hljs-comment">//ç©ºåœ°</span><br>wall,<span class="hljs-comment">//å¢™</span><br>visit,<span class="hljs-comment">//èµ°è¿‡çš„è·¯</span><br>end,<span class="hljs-comment">//ç»ˆç‚¹</span><br>&#125;;<br><span class="hljs-comment">//ç»˜åˆ¶çš„åœ°å›¾ã€‚</span><br>vec2 level;<br><span class="hljs-comment">//æ¸¸æˆæ›´æ–°</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">updata</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">draw</span>();<br><span class="hljs-built_in">test</span>();<br>&#125;<br><span class="hljs-keyword">private</span>:<br><span class="hljs-type">int</span> length;<span class="hljs-comment">//å®½åº¦å’Œé«˜åº¦</span><br><span class="hljs-type">int</span> size;<span class="hljs-comment">//æ¯ä¸ªç“¦ç‰‡çš„å¤§å°</span><br><span class="hljs-comment">//ç»˜åˆ¶åœ°å›¾</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">draw</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">BeginBatchDraw</span>();<span class="hljs-comment">//å¼€å§‹æ‰¹é‡ç”»å›¾</span><br><span class="hljs-built_in">cleardevice</span>();<span class="hljs-comment">//æŠŠä¹‹å‰çš„å…ˆæ¸…é™¤</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; level.<span class="hljs-built_in">size</span>(); i++)<br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; level[i].<span class="hljs-built_in">size</span>(); j++)<br>&#123;<br><span class="hljs-keyword">if</span> (level[i][j] == road)<br>&#123;<br><span class="hljs-built_in">setfillcolor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0xdd</span>, <span class="hljs-number">0xdd</span>, <span class="hljs-number">0xdd</span>));<span class="hljs-comment">//è®¾ç½®è·¯çš„é¢œè‰²</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (level[i][j] == wall)<br>&#123;<br><span class="hljs-built_in">setfillcolor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0x33</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0xcc</span>));<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (level[i][j] == visit)<br>&#123;<br><span class="hljs-built_in">setfillcolor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0x33</span>, <span class="hljs-number">0xcc</span>, <span class="hljs-number">0x33</span>));<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (level[i][j] == end)<br>&#123;<br><span class="hljs-built_in">setfillcolor</span>(<span class="hljs-built_in">RGB</span>(<span class="hljs-number">0xff</span>, <span class="hljs-number">0x33</span>, <span class="hljs-number">0x33</span>));<br>&#125;<br><span class="hljs-built_in">rect</span>(j, i);<span class="hljs-comment">//ç»˜åˆ¶ç“¦ç‰‡ï¼Œjä»£è¡¨xï¼Œiä»£è¡¨yã€‚</span><br><span class="hljs-comment">/*ï¼ˆ0ï¼Œ0ï¼‰----------â–· xçš„æ­£æ–¹å‘</span><br><span class="hljs-comment">      |</span><br><span class="hljs-comment">  |</span><br><span class="hljs-comment">  |</span><br><span class="hljs-comment">  |</span><br><span class="hljs-comment"> â–½ yçš„æ­£æ–¹å‘</span><br><span class="hljs-comment">å›¾å½¢åº“çª—å£çš„åæ ‡*/</span><br>&#125;  <br>&#125;<br><span class="hljs-built_in">EndBatchDraw</span>();<br>&#125; <br><span class="hljs-comment">//ç»˜åˆ¶æ–‡æœ¬</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;cls&quot;</span>);<span class="hljs-comment">//æ¸…å±</span><br>std::string str=<span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; level.<span class="hljs-built_in">size</span>(); i++)<br>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; level[i].<span class="hljs-built_in">size</span>(); j++)<br>&#123;<br><span class="hljs-keyword">if</span> (level[i][j] == road)<br>&#123;<br>str += <span class="hljs-string">&quot;  &quot;</span>;<span class="hljs-comment">//è®¾ç½®è·¯çš„æ ‡è¯†ç¬¦</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (level[i][j] == wall)<br>&#123;<br>str += <span class="hljs-string">&quot;+ &quot;</span>;<span class="hljs-comment">//å¢™</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (level[i][j] == visit)<br>&#123;<br>str += <span class="hljs-string">&quot;. &quot;</span>;<span class="hljs-comment">//èµ°è¿‡çš„è·¯</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (level[i][j] == end)<br>&#123;<br>str += <span class="hljs-string">&quot;= &quot;</span>;<span class="hljs-comment">//ç»ˆç‚¹</span><br>&#125;<br>&#125;<br>str += <span class="hljs-string">&#x27;\n&#x27;</span>;<br>&#125;<br>std::cout &lt;&lt; str &lt;&lt; std::endl;<br>&#125;<br><span class="hljs-comment">//ç»˜åˆ¶ç“¦ç‰‡</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rect</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-built_in">fillrectangle</span>(x * size, y * size, (x + <span class="hljs-number">1</span>) * size, (y + <span class="hljs-number">1</span>) * size);<br><span class="hljs-comment">/* void fillrectangle(</span><br><span class="hljs-comment">int left,</span><br><span class="hljs-comment">int top,</span><br><span class="hljs-comment">int right,</span><br><span class="hljs-comment">int bottom</span><br><span class="hljs-comment">); */</span><br><br>&#125;<br>&#125;;<br><br></code></pre></td></tr></table></figure><h4 id="search.h">Search.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;functional&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Pos</span><br>&#123;<br><span class="hljs-type">int</span> x;<br><span class="hljs-type">int</span> y;<br><span class="hljs-built_in">Pos</span>(<span class="hljs-type">int</span> x=<span class="hljs-number">0</span>, <span class="hljs-type">int</span> y=<span class="hljs-number">0</span>) :<span class="hljs-built_in">x</span>(x), <span class="hljs-built_in">y</span>(y) &#123;&#125;<br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Search</span><br>&#123;<br><span class="hljs-keyword">protected</span>:<br><span class="hljs-keyword">using</span> Function = std::function&lt;<span class="hljs-built_in">bool</span>(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)&gt;;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">Search</span>(Function fn) :<span class="hljs-built_in">fn</span>(fn) &#123;&#125;<br><span class="hljs-keyword">protected</span>:<br><br><span class="hljs-comment">//é€šè¿‡å‡½æ•°é€‚é…å™¨è°ƒç”¨å¤–éƒ¨è§„åˆ™ï¼Œå¯¹æ•°æ®è¿›è¡Œåˆ¤æ–­ï¼›</span><br>Function fn;<br><span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªvectorä¿å­˜è·¯å¾„</span><br>std::vector&lt;Pos&gt; path;<br><span class="hljs-comment">//åˆ¤æ–­è¿™æ¡è·¯æ˜¯å¦èµ°è¿‡</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isVisited</span><span class="hljs-params">(Pos pos)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; e : path)<br>&#123;<br><span class="hljs-keyword">if</span> (pos.x == e.x &amp;&amp; pos.y == e.y)<br>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-comment">//åˆ¤æ–­ä¸‹æ¬¡ç§»åŠ¨æ˜¯å¦åˆæ³•</span><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isValid</span><span class="hljs-params">(Pos pos)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">fn</span>(pos.x, pos.y) &amp;&amp; !<span class="hljs-built_in">isVisited</span>(pos);<span class="hljs-comment">//fnè°ƒç”¨å¤–éƒ¨è§„åˆ™check</span><br>&#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="dfs.h">DFS.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Search.h&quot;</span></span><br><span class="hljs-comment">//æ·±åº¦ä¼˜å…ˆç®—æ³•</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DFS</span> : <span class="hljs-keyword">public</span> Search<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">DFS</span>(std::function&lt;<span class="hljs-built_in">bool</span>(<span class="hljs-type">int</span>, <span class="hljs-type">int</span>)&gt; fn):<span class="hljs-built_in">Search</span>(fn)<span class="hljs-comment">//æ„é€ å­ç±»çš„æ—¶å€™ï¼Œéœ€è¦åˆå§‹åŒ–çˆ¶ç±»ã€‚</span><br>&#123;<br>    <br>&#125;<br><span class="hljs-comment">/*start èµ·ç‚¹åæ ‡</span><br><span class="hljs-comment">  end   ç»ˆç‚¹åæ ‡*/</span><br><span class="hljs-comment">//é€’å½’æ³•</span><br><span class="hljs-function">std::vector&lt;Pos&gt; <span class="hljs-title">recursive</span><span class="hljs-params">(Pos start, Pos end)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">this</span>-&gt;end = end;<br>    path.<span class="hljs-built_in">push_back</span>(start);<br>    _recursive(start);<br>    <span class="hljs-keyword">return</span> path;<br>&#125;<br><span class="hljs-comment">//éé€’å½’æ³•ï¼ˆæ ˆå®ç°ï¼‰</span><br><span class="hljs-function">std::vector&lt;Pos&gt; <span class="hljs-title">stack</span><span class="hljs-params">(Pos start, Pos end)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> Pos dir[<span class="hljs-number">4</span>] = &#123;<br>        &#123;<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<span class="hljs-comment">//y+1å‘ä¸‹</span><br>        &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>&#125;,<span class="hljs-comment">//x+1å‘å³</span><br>        &#123;<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>&#125;,<span class="hljs-comment">//x-1å‘å·¦</span><br>        &#123;<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>&#125;,<span class="hljs-comment">//y-1å‘ä¸Š</span><br>    &#125;;<br>    std::stack&lt;Pos&gt; st;<br>    st.<span class="hljs-built_in">push</span>(start);<br>    <span class="hljs-keyword">while</span> (!st.<span class="hljs-built_in">empty</span>())<br>    &#123;<br>        <span class="hljs-keyword">auto</span> now = st.<span class="hljs-built_in">top</span>();<br>        st.<span class="hljs-built_in">pop</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>        &#123;<br>            <span class="hljs-comment">//å‡†å¤‡ç§»åŠ¨çš„è·¯å¾„</span><br>            <span class="hljs-function">Pos <span class="hljs-title">move</span><span class="hljs-params">(now.x + dir[i].x, now.y + dir[i].y)</span></span>;<br>            <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦èƒ½ç§»åŠ¨</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isValid</span>(move))<br>            &#123;<br>                st.<span class="hljs-built_in">push</span>(move);<br>                path.<span class="hljs-built_in">push_back</span>(move);<br>                <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹</span><br>                <span class="hljs-keyword">if</span> (move.x == end.x &amp;&amp; move.y == end.y)<br>                &#123;<br>                    <span class="hljs-keyword">return</span> path;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> path;<br>&#125;<br><span class="hljs-keyword">private</span>:<br><span class="hljs-type">bool</span> is_end=<span class="hljs-literal">false</span>;<span class="hljs-comment">//é€’å½’éœ€è¦çš„æ ‡å¿—ä½ï¼Œé»˜è®¤ä½false</span><br>Pos end;  <span class="hljs-comment">//ä¿å­˜ç»ˆç‚¹åæ ‡</span><br><span class="hljs-type">void</span> _recursive(Pos now)<br>&#123;<br>    <span class="hljs-type">static</span> Pos dir[<span class="hljs-number">4</span>] = &#123;<br>        &#123;<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<span class="hljs-comment">//y+1å‘ä¸‹</span><br>        &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>&#125;,<span class="hljs-comment">//x+1å‘å³</span><br>        &#123;<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>&#125;,<span class="hljs-comment">//x-1å‘å·¦</span><br>        &#123;<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>&#125;,<span class="hljs-comment">//y-1å‘ä¸Š</span><br>    &#125;;<br>    <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦åˆ°è¾¾ç»ˆç‚¹</span><br>    <span class="hljs-keyword">if</span> (now.x == end.x &amp;&amp; now.y == end.y)<br>    &#123;<br>        is_end = <span class="hljs-literal">true</span>;<span class="hljs-comment">//æ‰¾åˆ°ç»ˆç‚¹æ ‡å¿—ä½ç½®1</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">//å¾ªç¯éå†ä¸‹å³å·¦ä¸Š4ä¸ªæ–¹å‘</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>    &#123;<br>        <span class="hljs-comment">//å‡†å¤‡ç§»åŠ¨çš„è·¯å¾„</span><br>        <span class="hljs-function">Pos <span class="hljs-title">move</span><span class="hljs-params">(now.x + dir[i].x, now.y + dir[i].y)</span></span>;<br>        <span class="hljs-comment">//åˆ¤æ–­èƒ½å¦ç§»åŠ¨</span><br>            <span class="hljs-keyword">if</span> (!is_end &amp;&amp; <span class="hljs-built_in">isValid</span>(move))<br>            &#123;<br>                path.<span class="hljs-built_in">push_back</span>(move);<span class="hljs-comment">//ä¿å­˜èµ°è¿‡çš„è·¯å¾„</span><br>                _recursive(move);<br>            &#125;<br>    &#125;<br>&#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="bfs.h">BFS.h</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Search.h&quot;</span></span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BFS</span> :<span class="hljs-keyword">public</span> Search<br>&#123;<br><span class="hljs-keyword">public</span>:<br><span class="hljs-built_in">BFS</span>(Function fn):<span class="hljs-built_in">Search</span>(fn)<br>&#123;<br>&#125;<br><span class="hljs-function">std::vector&lt;Pos&gt; <span class="hljs-title">queue</span><span class="hljs-params">(Pos start, Pos end)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> Pos dir[<span class="hljs-number">4</span>] = &#123;<br>       &#123;<span class="hljs-number">0</span>,<span class="hljs-number">1</span>&#125;,<span class="hljs-comment">//y+1å‘ä¸‹</span><br>       &#123;<span class="hljs-number">1</span>,<span class="hljs-number">0</span>&#125;,<span class="hljs-comment">//x+1å‘å³</span><br>       &#123;<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>&#125;,<span class="hljs-comment">//x-1å‘å·¦</span><br>       &#123;<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>&#125;,<span class="hljs-comment">//y-1å‘ä¸Š</span><br>    &#125;;<br>    std::queue&lt;Pos&gt; qu;<br>    qu.<span class="hljs-built_in">push</span>(start);<br>    <span class="hljs-keyword">while</span> (!qu.<span class="hljs-built_in">empty</span>())<br>    &#123;<br>        <span class="hljs-keyword">auto</span> now = qu.<span class="hljs-built_in">front</span>();<br>        qu.<span class="hljs-built_in">pop</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>        &#123;<br>            <span class="hljs-function">Pos <span class="hljs-title">move</span><span class="hljs-params">(now.x + dir[i].x, now.y + dir[i].y)</span></span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isValid</span>(move))<br>            &#123;<br>                qu.<span class="hljs-built_in">push</span>(move);<br>                path.<span class="hljs-built_in">push_back</span>(move);<br>                <span class="hljs-keyword">if</span> (move.x == end.x &amp;&amp; move.y == end.y)<br>                &#123;<br>                    <span class="hljs-keyword">return</span> path;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> path;<br>&#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h1 id="æµ‹è¯•ç»“æœ">æµ‹è¯•ç»“æœ</h1><blockquote><p><strong>é€’å½’å®ç°ï¼š</strong> <img src="/img/00001/dfs.gif"alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p></blockquote><blockquote><p><strong>æ·±åº¦ä¼˜å…ˆï¼ˆæ ˆå®ç°ï¼‰ï¼š</strong> <imgsrc="/img/00001/bfs-stack.gif" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p></blockquote><blockquote><p><strong>å¹¿åº¦ä¼˜å…ˆï¼ˆé˜Ÿåˆ—å®ç°ï¼‰</strong> <imgsrc="/img/00001/bfs-queue.gif" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /> #æ·±åº¦ä¼˜å…ˆï¼ˆæ ˆå®ç°ï¼‰å’Œå¹¿åº¦ä¼˜å…ˆï¼ˆé˜Ÿåˆ—å®ç°ï¼‰å›¾è§£ <strong>æ·±åº¦ä¼˜å…ˆï¼š</strong><img src="/img/00001/dfs.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /><strong>å¹¿åº¦ä¼˜å…ˆï¼š</strong> <img src="/img/00001/bfs.png"alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" /></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>C++</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
