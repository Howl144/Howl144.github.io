

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="elv6HP48K6bVVMeBdbFYkmoi4IBF6JVtH0WaCgUXRNY" />
  <link rel="apple-touch-icon" sizes="76x76" href="/img/rose.png">
  <link rel="icon" href="/img/rose.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Deng Ye">
  <meta name="keywords" content="">
  
    <meta name="description" content="æ•ˆæœå›¾ 1024sppï¼š Specular + Glass(0.08 roughness) + Sliver(0.4 roughness)  1024sppï¼š Specular + Glass(0.28 roughness)  1024sppï¼š Diffuse + Glass(0.08 roughness)  ä¸å¾—ä¸è¯´ï¼Œè¿™é•œé¢å’Œé€æ˜æè´¨ä¸€ä½†å¼•å…¥ï¼Œå™ªå£°å°±ä¼šå˜å¾—éå¸¸å¤§ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯">
<meta property="og:type" content="article">
<meta property="og:title" content="Games101 Final Project">
<meta property="og:url" content="https://howl144.github.io/2023/09/30/00014.%20Games101%20FinalProject/index.html">
<meta property="og:site_name" content="ğŸ¥°Howl&#39;s Blog">
<meta property="og:description" content="æ•ˆæœå›¾ 1024sppï¼š Specular + Glass(0.08 roughness) + Sliver(0.4 roughness)  1024sppï¼š Specular + Glass(0.28 roughness)  1024sppï¼š Diffuse + Glass(0.08 roughness)  ä¸å¾—ä¸è¯´ï¼Œè¿™é•œé¢å’Œé€æ˜æè´¨ä¸€ä½†å¼•å…¥ï¼Œå™ªå£°å°±ä¼šå˜å¾—éå¸¸å¤§ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://howl144.github.io/img/00014/MIS-1024spp-1.png">
<meta property="article:published_time" content="2023-09-30T01:23:12.000Z">
<meta property="article:modified_time" content="2023-09-30T07:12:25.903Z">
<meta property="article:author" content="Deng Ye">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://howl144.github.io/img/00014/MIS-1024spp-1.png">
  
  
  
  <title>Games101 Final Project - ğŸ¥°Howl&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"howl144.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"MY3hK2j6KKqPNCHItX2Yargj-gzGzoHsz","app_key":"U0dZRBpPFA46kRmFcsltQFF2","server_url":"https://my3hk2j6.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Howl&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Portfolio/">
                <i class="iconfont icon-pen"></i>
                <span>Portfolio</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Category</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archive</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About Me</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/post.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.5)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Games101 Final Project"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-09-30 09:23" pubdate>
          September 30, 2023 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          25k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          212 mins
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Games101 Final Project</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="æ•ˆæœå›¾">æ•ˆæœå›¾</h1>
<p><code>1024spp</code>ï¼š <code>Specular</code> +
<code>Glass</code>(0.08 roughness) + <code>Sliver</code>(0.4
roughness)<br />
<img src="/img/00014/MIS-1024spp-1.png" srcset="/img/loading.gif" lazyload alt="0" /><br />
<code>1024spp</code>ï¼š <code>Specular</code> + <code>Glass</code>(0.28
roughness)<br />
<img src="/img/00014/MIS-1024spp-2.png" srcset="/img/loading.gif" lazyload alt="1" /><br />
<code>1024spp</code>ï¼š <code>Diffuse</code> + <code>Glass</code>(0.08
roughness)<br />
<img src="/img/00014/MIS-1024spp-3.png" srcset="/img/loading.gif" lazyload alt="2" /><br />
ä¸å¾—ä¸è¯´ï¼Œè¿™é•œé¢å’Œé€æ˜æè´¨ä¸€ä½†å¼•å…¥ï¼Œå™ªå£°å°±ä¼šå˜å¾—éå¸¸å¤§ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯å› ä¸ºç„¦æ•£æˆ–åå°„å…‰çš„ç”Ÿæˆæ•ˆç‡å¤ªä½å¯¼è‡´çš„ï¼Œä¸ªäººè§‰å¾—éœ€è¦ç”¨åˆ°<code>Photon Mapping</code>æŠ€æœ¯ï¼Œä»¥åæœ‰éœ€è¦å†æ¥ç ”ç©¶å§ï¼Œæ²¡æœ‰é•œé¢å’Œé€æ˜æè´¨ï¼Œ<code>16ssp</code>æ„Ÿè§‰è¿˜è¡Œ:<br />
<code>16ssp</code> <code>Sliver</code>(0.4 roughness) +
<code>Gold</code>(0.4 roughness)<br />
<img src="/img/00014/MIS-16spp-2.png" srcset="/img/loading.gif" lazyload /></p>
<p>ä¸‹é¢æ˜¯å¤šé‡é‡è¦æ€§é‡‡æ ·ï¼ˆMISï¼‰çš„ç»“æœ:<br />
<code>16spp</code><br />
<img src="/img/00014/Multiple-Importance-Sampling.png" srcset="/img/loading.gif" lazyload /></p>
<h1 id="æºç ">æºç </h1>
<p><a
target="_blank" rel="noopener" href="https://github.com/Howl144/GAMES202/tree/GAMES101">GAMES101</a></p>
<h1 id="å‰è¨€">å‰è¨€</h1>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®²çš„æ˜¯<code>GAMES101</code>çš„<code>Next Event Estimation Path Tracing</code>ï¼Œä»¥åŠ<code>BRDF</code>ï¼Œ<code>BSDF</code>æè´¨çš„ç¼–å†™ï¼Œæœ€ååœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†<code>Multiple Importance Sampling</code>ï¼Œä»¥æé«˜æ”¶æ•›é€Ÿåº¦ã€‚è·¯å¾„è¿½è¸ªéƒ¨åˆ†åŒ…å«å…‰çº¿ä¸ä¸‰è§’å½¢æ±‚äº¤ä¸éšå¼è¡¨é¢æ±‚äº¤ï¼ŒåŠ é€Ÿç»“æ„çš„æ„å»ºï¼ˆBVHï¼ŒSAHï¼‰ï¼Œå…‰çº¿ä¸åŠ é€Ÿç»“æ„æ±‚äº¤ï¼Œä»¥åŠå…¨å±€å…‰ç…§çš„å®ç°ç­‰ã€‚æœ¬æ–‡ä¸è®²çš„æ˜¯æ¡†æ¶ç†è§£ï¼Œå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å®ç°è¿‡ç¨‹ä¸­ä¸€å®šä¸€å®šè¦æ³¨æ„<code>pdfValue</code>ç­‰äº<code>0</code>å¯¼è‡´çš„<code>NaN</code>çš„æƒ…å†µï¼Œè¿˜æœ‰å°±æ˜¯æ¸²æŸ“æ–¹ç¨‹ä¸­çš„<code>cosÎ¸</code>è®°å¾—é™åˆ¶åœ¨<code>[0,1]</code>ä¹‹é—´ï¼Œä¸ç„¶ä¼šå¾—åˆ°æ„æƒ³ä¸åˆ°çš„è€Œä¸”éå¸¸éšè”½çš„æ•ˆæœï¼Œæ’æŸ¥èµ·æ¥å¾ˆå›°éš¾ã€‚</p>
<h1 id="whitted-style-ray-tracing">Whitted-Style Ray Tracing</h1>
<p>åœ¨ä»‹ç»<code>Path Tracing</code>ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹<code>Whitted-Style Ray Tracing</code>:<br />
<img src="/img/00014/image.png" srcset="/img/loading.gif" lazyload alt="3" /> <img
src="/img/00014/image-1.png" srcset="/img/loading.gif" lazyload alt="4" /> 1.
å¯¹äºå±å¹•ä¸Šçš„æ¯ä¸ªåƒç´ æˆ‘ä»¬éƒ½å»æ‰“ä¸€æ ¹å…‰çº¿ã€‚<br />
2.
å‘å°„å‡ºå»çš„å…‰çº¿éœ€è¦ä¸åœºæ™¯ä¸­çš„ç‰©ä½“è¿›è¡Œæ±‚äº¤ï¼Œç„¶åç®—å…‰æºå¯¹è¿™ä¸ªç‚¹çš„è´¡çŒ®ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨Blinn
Phongç®—æ³•ï¼‰ï¼Œå¦‚æœäº¤ç‚¹æ˜¯ç»ç’ƒæè´¨çš„åˆ™äº§ç”Ÿåå°„å…‰çº¿å’ŒæŠ˜å°„å…‰çº¿è¿›è¡Œé€’å½’ï¼Œç›´åˆ°å…‰çº¿æ‰“åˆ°Diffuseç‰©ä½“ä¸Šã€‚
3.
ç„¶ååå‘æ²¿å…‰çº¿å°†äº¤ç‚¹å¤„çš„é¢œè‰²ç´¯åŠ èµ·æ¥ï¼ŒæœŸé—´ç»è¿‡äº†ç»ç’ƒæè´¨å°±æŒ‰<code>Fresnel</code>é¡¹ï¼Œç®—åå°„å…‰çº¿å’ŒæŠ˜å°„å…‰çº¿çš„æƒé‡ã€‚<br />
4. æœ€åå°†å¾—åˆ°çš„é¢œè‰²å†™å…¥åƒç´ ã€‚</p>
<p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¦‚æœå…‰çº¿æ‰“åˆ°æ˜¯é•œé¢ï¼Œæ²¿ç€å®ƒåå°„çš„æ–¹å‘è·å¾—çš„ç¯å¢ƒå…‰è¿˜ç®—æ˜¯å¯¹çš„ï¼Œå› ä¸º<code>Diffuse</code>ç‰©ä½“ä¹‹é—´ä¹Ÿä¼šå‘ç”Ÿå¤šæ¬¡å¼¹å°„ã€‚ä½†æ˜¯å½“å…‰çº¿æ‰“åˆ°<code>Glossy</code>ç‰©ä½“ä¸Šæ—¶ï¼Œ<code>Whitted-Style Ray Tracing</code>æ— æ³•äº§ç”Ÿå…‰çº¿<code>lobe</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒåªèƒ½æ²¿ç€é•œé¢åå°„é‡‡æ ·ï¼Œè¿™æ ·å°±æ— æ³•å¾—åˆ°ä¸‹é¢å³å›¾çš„æ•ˆæœã€‚
<img src="/img/00014/image-2.png" srcset="/img/loading.gif" lazyload alt="5" /></p>
<p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯<code>Whitted-Style Ray Tracing</code>æ‰“åˆ°<code>Diffuse</code>ç‰©ä½“å°±åœä½äº†ï¼Œå®ƒä¸è€ƒè™‘è¯¥<code>Diffuse</code>ç‰©ä½“å—åˆ°ç¯å¢ƒçš„å½±å“ï¼Œè¿™æ ·å°±æ— æ³•å¾—åˆ°ä¸‹é¢å³å›¾çš„æ•ˆæœã€‚<br />
<img src="/img/00014/image-3.png" srcset="/img/loading.gif" lazyload alt="6" /></p>
<p>è¿˜æœ‰æœ€åä¸€ä¸ªé—®é¢˜ï¼Œ<code>Whitted-Style Ray Tracing</code>åœ¨è®¡ç®—å…‰ç…§å¯¹äº¤ç‚¹çš„å½±å“æ—¶ï¼Œä»¥åŠåå‘æ²¿å…‰çº¿å°†äº¤ç‚¹å¤„çš„é¢œè‰²ç´¯åŠ èµ·æ¥æ—¶ï¼Œéƒ½æ²¡æœ‰æ­£ç¡®çš„è€ƒè™‘èƒ½é‡çš„ä¼ é€’è¿‡ç¨‹ï¼Œè€Œ<code>Path Tracing</code>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†è¾å°„åº¦é‡å­¦çš„æ¦‚å¿µã€‚</p>
<h1 id="the-rendering-equation">The Rendering Equation</h1>
<p>å¯¹äºè¾å°„åº¦é‡å­¦ï¼Œæˆ‘ä»¬è¿™é‡Œç†æ¸…æ¥š<code>5</code>ä¸ªæ¦‚å¿µå°±è¡Œ:</p>
<ol type="1">
<li><p><code>power(Radiant flux)</code>ï¼Œ<span
class="math inline">\(\Phi=\frac{\text{d}Q}{\text{d}t}\)</span><br />
å³å•ä½æ—¶é—´å†…çš„èƒ½é‡</p></li>
<li><p><code>Solid Angle</code>ï¼Œ<span
class="math inline">\(\Omega=\frac{A}{r^2}\)</span><br />
å³çƒé¢ä¸ŠåŒ…å«çš„æŸå—é¢ç§¯æ¯”ä¸Šè·ç¦»å¹³æ–¹ï¼š<br />
<img src="/img/00014/image-4.png" srcset="/img/loading.gif" lazyload alt="7" /></p></li>
<li><p><code>Differential Solid Angles</code>ï¼Œ<span
class="math inline">\(\text{d}w=\frac{\text{d}A}{r^2}\)</span><br />
<img src="/img/00014/image-5.png" srcset="/img/loading.gif" lazyload alt="8" /><br />
å›¾ä¸­<code>dA</code>å·¦è¾¹å’Œå³è¾¹çš„é•¿åº¦ç”¨å¼§é•¿å…¬å¼æ±‚å¾—ï¼šrdÎ¸<br />
<code>dA</code>ä¸‹é¢å’Œä¸Šé¢çš„é•¿åº¦ï¼Œå…ˆæ±‚æ°´å¹³é¢ä¸Šçš„åŠå¾„<code>r sinÎ¸</code>ï¼Œå†åˆ©ç”¨å¼§é•¿å…¬å¼æ±‚å¾—ï¼š<code>r sinÎ¸ dÏ†</code>ï¼Œåˆ™dwä¸ºï¼ˆå¦‚æœæ˜¯å•ä½çƒï¼Œ<code>dw</code>å°±ç­‰äº<code>dA</code>ï¼‰ï¼š<br />
<span class="math display">\[
\begin{align}
\text{d}w=\frac{\text{d}A}{r^2}=\sin\theta\text{d}\theta\text{d}\phi
\end{align} \tag{1}
\]</span></p></li>
<li><p><code>Irradiance</code>ï¼Œ<span
class="math inline">\(E(x)=\frac{\text{d}\Phi(x)}{\text{d}A}\)</span><br />
å³å•ä½é¢ç§¯ä¸Šæ¥æ”¶åˆ°æˆ–è¾å°„å‡ºçš„èƒ½é‡ï¼š<br />
<img src="/img/00014/image-6.png" srcset="/img/loading.gif" lazyload alt="9" /><br />
å¦‚æœé¢ç§¯å’Œå…‰æºä¸æ˜¯æ­£å¯¹ç€ï¼Œè¿˜è¦ä¹˜ä¸Šä¸€ä¸ª<code>cosÎ¸</code>ã€‚</p></li>
<li><p><code>Radiance</code>ï¼Œ<span
class="math inline">\(L(p,w)=\frac{\text{d}^2\Phi(p,w)}{\text{d}w\text{d}A\cos\theta}\)</span><br />
å³å•ä½é¢ç§¯ä¸Šå¹¶ä¸”åœ¨å•ä½ç«‹ä½“è§’ä¸Šçš„èƒ½é‡ï¼Œå¯ä»¥æ˜¯æ¥å—åˆ°çš„ä¹Ÿå¯ä»¥æ˜¯è¾å°„å‡ºçš„ã€‚
<img src="/img/00014/image-7.png" srcset="/img/loading.gif" lazyload alt="10" /></p></li>
</ol>
<p>é€šè¿‡ä¸Šé¢ä¸¤è€…çš„å‡†ç¡®å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°<code>Irradiance</code>å’Œ<code>Radiance</code>çš„å…³ç³»ï¼š<br />
<img src="/img/00014/image-8.png" srcset="/img/loading.gif" lazyload alt="11" /><br />
å‡è®¾è¿™æ˜¯<code>Incident Radiance</code>ï¼Œåˆ™<code>Irradiance</code>å°±æ˜¯å„ä¸ªæ–¹å‘ä¸Šæ¥å—åˆ°çš„èƒ½é‡æ€»å’Œï¼Œç§¯åˆ†å°±æ˜¯æ±‚å’Œï¼Œæ˜¯ä¸€æ ·çš„æ„æ€ã€‚å‡è®¾åªæœ‰ä¸€ä¸ªæ–¹å‘ä¸Šèƒ½æ¥æ”¶åˆ°å…‰ç…§çš„èƒ½é‡ï¼Œåˆ™<code>dA</code>å¯¹åº”çš„<code>Irradiance</code>å’Œ<code>dA</code>ä»è¿™ä¸ªæ–¹å‘ä¸Šæ¥çš„èƒ½é‡(Radiance
* cosÎ¸ * dw)æ˜¯ç›¸ç­‰çš„ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥ç†è§£ä¸€ä¸‹ï¼Œåå°„æ˜¯ä»€ä¹ˆã€‚å¯ä»¥è¿™æ ·è®¤ä¸ºï¼Œåå°„æ˜¯å…¥å°„æ–¹å‘æ¥çš„<code>Radiance</code>ï¼Œè½¬æ¢æˆ<code>Irradiance</code>åï¼Œæœ€åå†å‘å‡ºå°„æ–¹å‘è¾å°„å‡ºçš„<code>Radiance</code>:<br />
<img src="/img/00014/image-9.png" srcset="/img/loading.gif" lazyload alt="12" /><br />
ç°åœ¨æˆ‘ä»¬çŸ¥é“åå°„æœ€åå¾—åˆ°çš„æ˜¯<code>dA</code>å¯¹åº”çš„<code>Irradiance</code>å‘åå°„æ–¹å‘è¾å°„å‡ºçš„<code>Radiance</code>ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“çš„æ˜¯è¿™ä¸ªè¾å°„å‡ºçš„<code>Radiance</code>å’Œ<code>dA</code>å¯¹åº”çš„<code>Irradiance</code>ä¹‹é—´çš„å…³ç³»ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥æè¿°è¿™ç§è¡Œä¸ºé‚£é—®é¢˜å°±è§£å†³äº†ã€‚</p>
<p>è€ŒBRDF(åŒå‘åå°„åˆ†å¸ƒå‡½æ•°)ï¼Œå°±å¯ä»¥æè¿°<code>dA</code>å¯¹åº”çš„<code>Irradiance</code>å‘æŸåå°„æ–¹å‘è¾å°„å‡º<code>Radiance</code>å…·ä½“æ˜¯å¤šå°‘ï¼š<br />
<span class="math display">\[
\begin{align}
\text{d}L_r(w_r)=f_r(w_i,w_r)\cdot\text{d}E_i(w_i)
\end{align} \tag{2}
\]</span> <img src="/img/00014/image-10.png" srcset="/img/loading.gif" lazyload alt="13" /></p>
<p>æœ€åæˆ‘ä»¬å§<span
class="math inline">\(\text{d}E_i(w_i)\)</span>æ¢æˆ<code>Radiance</code>çš„å½¢å¼å¾—åˆ°ä¸‹é¢æ–¹ç¨‹ï¼š<br />
<span class="math display">\[
\begin{align}
\text{d}L_r(w_r)=f_r(w_i,w_r)\cdot L_i(w_i)\cos\theta\text{d}w_i
\end{align} \tag{3}
\]</span>
ç°åœ¨åªæ˜¯æŸä¸€ä¸ªå…¥å°„æ–¹å‘<code>w_i</code>å¯¹å‡ºå°„æ–¹å‘<code>w_r</code>çš„è´¡çŒ®ï¼Œç„¶åä¸¤è¾¹åˆ†åˆ«ç§¯åˆ†å¾—åˆ°å‡ºå°„æ–¹å‘<code>w_r</code>æ€»å…±çš„<code>Radiance</code>ï¼š<br />
<span class="math display">\[
\begin{align}
L_r(w_r)=\int_{\Omega+}f_r(w_i,w_r)\cdot L_i(w_i)\cos\theta\text{d}w_i
\end{align} \tag{4}
\]</span> <img src="/img/00014/image-11.png" srcset="/img/loading.gif" lazyload alt="14" /><br />
è¿™å°±æ˜¯åå°„æ–¹ç¨‹çš„ç”±æ¥ã€‚è€Œæ¸²æŸ“æ–¹ç¨‹å°±æ˜¯åœ¨è¿™åŸºç¡€ä¸ŠåŠ ä¸Šäº†ä¸€ä¸ªè‡ªå‘å…‰é¡¹ï¼š<br />
<img src="/img/00014/image-12.png" srcset="/img/loading.gif" lazyload alt="15" /></p>
<h1 id="nee-path-tracing">NEE Path Tracing</h1>
<p>æˆ‘ä»¬çœ‹å›¾<code>15</code>ï¼Œå¯ä»¥å‘ç°<code>Le</code>ï¼Œ<code>BRDF</code>ï¼Œ<code>cosÎ¸</code>æˆ‘ä»¬å·²ç»çŸ¥é“äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯<code>Li</code>ã€‚è€ŒLiå¹¶ä¸æ˜¯åªæ¥è‡ªå…‰æºï¼Œè¿˜æ¥è‡ªå®ƒå‘¨å›´çš„é—´æ¥å…‰ï¼ˆå…¶ä»–ç‰©ä½“è¢«ç…§äº®åä¹Ÿç®—æ˜¯ä¸€ä¸ªå°å‹å…‰æºï¼‰ã€‚è¿™æ ·å¯¹äºæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªç‰©ä½“è¡¨é¢ï¼Œå®ƒçš„<code>Li</code>ï¼Œå³è¦è€ƒè™‘ç›´æ¥å…‰å¯¹å®ƒçš„å½±å“ï¼Œåˆè¦è€ƒè™‘é—´æ¥å…‰å¯¹å®ƒçš„å½±å“ã€‚è€Œé—´æ¥å…‰åˆå¾—ç»§ç»­è€ƒè™‘ç›´æ¥å…‰å’Œé—´æ¥å…‰ã€‚ä»è€Œå½¢æˆä¸€ä¸ªé€’å½’è¿‡ç¨‹ï¼ˆNEE
Path Tracingï¼‰ï¼š<br />
<img src="/img/00014/image-13.png" srcset="/img/loading.gif" lazyload alt="16" /><br />
ä¸‹é¢æ˜¯è¿™ä¸€é€’å½’è¿‡ç¨‹çš„ä¼ªä»£ç ï¼š<br />
<img src="/img/00014/image-14.png" srcset="/img/loading.gif" lazyload alt="17" /><br />
è¿™é‡Œç”¨åˆ°äº†<code>Russian Roulette</code>çš„æ¦‚å¿µï¼Œå› ä¸ºé—´æ¥å…‰ä¸èƒ½ä¸€ç›´é€’å½’ä¸‹å»ï¼Œè€Œæˆ‘ä»¬åˆæƒ³å¾—åˆ°çš„æœŸæœ›å€¼ä¸å˜ï¼Œå‡è®¾æœŸæœ›å€¼ä¸º<code>Lo</code>ã€‚æˆ‘ä»¬å‡åŒ€çš„å–ä¸€ä¸ªéšæœºå˜é‡<code>P</code>(0
&lt; P &lt;
1)ï¼Œä»¥<code>P</code>æ¦‚ç‡è¿›è¡Œé€’å½’ï¼Œ<code>1-P</code>çš„æ¦‚ç‡æ¯™æ‰è¿™æ ¹å…‰çº¿ï¼Œåˆ™ç¦»æ•£å‹éšæœºå˜é‡çš„æœŸæœ›ä¸ºï¼š<br />
<span class="math display">\[
\begin{align}
E(X)=P*L_o+(1-P)*0
\end{align} \tag{5}
\]</span>
ä¸ºäº†å…¶æœŸæœ›å€¼æœ€åè¿˜æ˜¯<code>Lo</code>ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å¾—åˆ°çš„é—´æ¥å…‰<code>Lo</code>é™¤ä»¥<code>P</code>å°±è¡Œï¼š<br />
<span class="math display">\[
\begin{align}
E(X)=P*(\frac{L_o}{P})+(1-P)*0=L_o
\end{align} \tag{6}
\]</span></p>
<h2 id="monte-carlo-integral">Monte Carlo Integral</h2>
<p>ä¸Šé¢ä¼ªä»£ç ä¸­ï¼Œæ²¡æœ‰è¯´æ¸²æŸ“æ–¹ç¨‹(ä¸è€ƒè™‘è‡ªå‘å…‰)åœ¨ä»£ç ä¸­åº”è¯¥æ€ä¹ˆå®ç°ï¼Œå¯¹äºä¸€ä¸ªå®šç§¯åˆ†æˆ‘ä»¬å¯ä»¥ç”¨è’™ç‰¹å¡æ´›çš„æ–¹æ³•æ¥è¿‘ä¼¼æ±‚è§£è¿™ä¸ªç§¯åˆ†ï¼š<br />
<img src="/img/00014/image-15.png" srcset="/img/loading.gif" lazyload alt="18" /><br />
åœ¨ç§¯åˆ†åŸŸä¸Šï¼Œç”¨ä»»æ„ä¸€ç§æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼ˆPDFï¼‰ï¼Œå»é‡‡æ ·å¤šä¸ªä½ç½®<code>Xi</code>ï¼Œåˆ™è¯¥å®šç§¯åˆ†çš„å€¼ä¸ºï¼š<br />
<span class="math display">\[
\begin{align}
F_N=\frac{1}{N}\sum_{i=1}^{N}\frac{f(X_i)}{p(X_i)}
\end{align} \tag{7}
\]</span>
å¦‚æœæ˜¯å‡åŒ€çš„é‡‡æ ·ä¸€ä¸ªä½ç½®ï¼Œåˆ™<code>PDF</code>å°±æ˜¯ä¸€ä¸ªå¸¸å€¼ï¼š<br />
<img src="/img/00014/image-16.png" srcset="/img/loading.gif" lazyload alt="19" /><br />
<code>7</code>å¼å¯ä»¥å†™æˆï¼š<br />
<span class="math display">\[
\begin{align}
F_N=\frac{b-a}{N}\sum_{i=1}^{N}f(X_i)
\end{align} \tag{8}
\]</span>
ä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šå»ç”¨å‡åŒ€é‡‡æ ·ï¼Œå› ä¸ºå™ªå£°å¾ˆå¤§ã€‚å¦‚æœæœ‰ä¸€ä¸ª<code>PDF</code>ï¼Œå…¶å½¢çŠ¶å’Œ<code>f(x)</code>å¤§è‡´å»åˆï¼Œé‚£ä¹ˆç”¨è¿™æ ·çš„<code>PDF</code>å»é‡‡æ ·ä¸€ä¸ªä½ç½®æˆ–æ–¹å‘ï¼Œæ”¶æ•›é€Ÿåº¦æ›´å¿«ï¼Œè¿™å°±æ˜¯é‡è¦æ€§é‡‡æ ·ï¼ˆæˆ‘åœ¨<a
href="https://howl144.github.io/2023/07/01/00018.%20Games202%20Hw4/#splitsum%E5%92%8Cggx%E9%87%8D%E8%A6%81%E6%80%A7%E9%87%87%E6%A0%B7">è¿™ç¯‡æ–‡ç« </a>ä¸­æœ‰è¯¦ç»†è®²åˆ°é‡è¦æ€§é‡‡æ ·çš„è¿‡ç¨‹ï¼‰ã€‚</p>
<p>æ¸²æŸ“æ–¹ç¨‹å†™æˆè’™ç‰¹å¡æ´›ç§¯åˆ†çš„å½¢å¼å¦‚ä¸‹ï¼š<br />
<span class="math display">\[
\begin{align}
L_o(p,w_o)=\int_{\Omega+}L_i(p,w_i)f_r(p,w_i,w_o)(n\cdot w_i)\text{d}w_i
\\
\approx\frac{1}{N}\sum_{i=1}^{N}\frac{L_i(p,w_i)f_r(p,w_i,w_o)(n\cdot
w_i)}{p(w_i)}
\end{align} \tag{9}
\]</span>
ä½†æ˜¯å¦‚æœæ¯ä¸ªäº¤ç‚¹éƒ½å‘å¤–å‘å°„<code>N</code>æ¡å…‰çº¿ï¼ŒæŒ‡æ•°çˆ†ç‚¸è¿˜æ˜¯åƒä¸æ¶ˆï¼š<br />
<img src="/img/00014/image-17.png" srcset="/img/loading.gif" lazyload alt="20" /><br />
æˆ‘ä»¬å°±è®©äº¤ç‚¹æ¯æ¬¡åªäº§ç”Ÿä¸€æ¡å…‰çº¿å‘å¤–è¿½è¸ªï¼Œç„¶ååœ¨ä¸€ä¸ªåƒç´ é‡Œé¢å¤šæ‰“å‡ æ¡å…‰çº¿ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æŒ‡æ•°çˆ†ç‚¸ï¼š<br />
<img src="/img/00014/image-18.png" srcset="/img/loading.gif" lazyload alt="21" /><br />
ä¸‹é¢æ˜¯æ›´æ–°åçš„<code>NEE Path Tracing</code>ä¼ªä»£ç ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">function <span class="hljs-title">Li</span><span class="hljs-params">(p,wo,depth)</span></span><br><span class="hljs-function">    <span class="hljs-title">if</span><span class="hljs-params">(depth==<span class="hljs-number">0</span> &amp;&amp; Ray hit light source)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">return</span> LightRadiance</span>;<br><br>	P_RR = <span class="hljs-number">0.8</span>;<br>	Randomly select ksi in a uniform dist. in [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>]<br>	<span class="hljs-keyword">if</span>(ksi &gt; P_RR) <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;<br>	<br>	Randomly select a sampling point on the light source, <span class="hljs-function">p_on_light</span><br><span class="hljs-function">	Trace a shadowRay <span class="hljs-title">sr</span><span class="hljs-params">(p,(p_on_light - p).normalized() )</span></span><br><span class="hljs-function">	<span class="hljs-title">if</span><span class="hljs-params">(ray sr does <span class="hljs-keyword">not</span> hit an object except light source)</span></span><br><span class="hljs-function">		direct </span>= LightRadiance * f_r * cosÎ¸ / pdfLight_solidAngle;<br>	<br>	Randomly choose One direction wi ~ <span class="hljs-built_in">pdf</span>(w)<br>	<span class="hljs-function">Trace a ray <span class="hljs-title">r</span><span class="hljs-params">(p,wi)</span></span><br><span class="hljs-function">	<span class="hljs-title">if</span><span class="hljs-params">(ray r hit an object at q &amp;&amp; does <span class="hljs-keyword">not</span> hit light source)</span></span><br><span class="hljs-function">		indirect </span>= <span class="hljs-built_in">Li</span>(q,-wi,depth+<span class="hljs-number">1</span>) * f_r * cosÎ¸ / <span class="hljs-built_in">pdf</span>(wi);<br>	<br>	<span class="hljs-keyword">return</span> (direct + indirect) / P_RR;<br></code></pre></td></tr></table></figure>
å¯ä»¥çœ‹åˆ°é‡Œé¢å¤šäº†ä¸€ä¸ª<code>Trace</code>å‡½æ•°ï¼Œåœ¨<code>Trace</code>å…‰çº¿æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­å…‰çº¿ä¸åœºæ™¯ä¸­ç‰©ä½“çš„æ±‚äº¤ï¼Œè€Œåœºæ™¯ä¸­å¤§éƒ¨åˆ†çš„ç‰©ä½“éƒ½æ˜¯ç”±ä¸‰è§’å½¢ç»„æˆçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªé«˜æ•ˆçš„ç®—æ³•æ¥åˆ¤æ–­å…‰çº¿ä¸ä¸‰è§’å½¢æ±‚äº¤ã€‚</p>
<h2 id="å…‰çº¿ä¸ä¸‰è§’å½¢æ±‚äº¤">å…‰çº¿ä¸ä¸‰è§’å½¢æ±‚äº¤</h2>
<p>è¦æƒ³æ±‚å…‰çº¿æ˜¯å¦ä¸ä¸‰è§’å½¢ç›¸äº¤ï¼Œæˆ‘ä»¬å¾ˆè‡ªç„¶å¯ä»¥æƒ³åˆ°ä¸€ç§æ–¹æ³•ï¼Œå…ˆåˆ¤æ–­å…‰çº¿ä¸ä¸‰è§’å½¢æ‰€åœ¨çš„å¹³é¢æ˜¯å¦ç›¸äº¤ï¼Œç„¶åå†åˆ¤æ–­äº¤ç‚¹æ˜¯å¦åœ¨ä¸‰è§’å½¢å†…ã€‚<br />
<img src="/img/00014/image-19.png" srcset="/img/loading.gif" lazyload alt="22" /><br />
æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå°„çº¿æ–¹ç¨‹ï¼š<span class="math inline">\(r(t)=o+t*\vec d,0\leq
t&lt;\inf\)</span>ï¼Œå†å®šä¹‰ä¸€ä¸ªå¹³é¢æ–¹ç¨‹ï¼š <span
class="math inline">\((p-p&#39;)\cdot\vec
N=0\)</span>ï¼Œç„¶åå‡è®¾<code>p</code>ç­‰äº<code>r(t)</code>åˆ™æˆ‘ä»¬å¯ä»¥æ±‚å‡º<code>t</code>è¿™ä¸ªç³»æ•°ï¼š
<span class="math display">\[
\begin{align}
&amp; (p-p&#39;)\cdot\vec N=(o+t*\vec d-p&#39;)=0 \\
&amp; t=\frac{(p&#39;-o)\cdot\vec N}{\vec d\cdot N}
\end{align} \tag{10}
\]</span>
åˆ¤æ–­ç‚¹åœ¨ä¸‰è§’å½¢å†…ï¼Œç›´æ¥å°†äº¤ç‚¹<code>p</code>ä¸ä¸‰è§’å½¢å„ä¸ªé¡¶ç‚¹æŒ‰é¡ºåºç›¸è¿ï¼Œå‡è®¾æ˜¯é€†æ—¶é’ˆï¼Œè¿åˆ°ç¬¬ä¸€ä¸ªé¡¶ç‚¹å¾—åˆ°çš„å‘é‡ä¸ç¬¬ä¸€ä¸ªé¡¶ç‚¹å’Œç¬¬äºŒé¡¶ç‚¹çš„å‘é‡åšå‰ä¹˜ï¼Œè½¬ä¸€åœˆï¼Œç„¶ååˆ¤æ–­å‰ä¹˜å‡ºçš„æ–¹å‘æ˜¯å¦åŒå‘ï¼ŒåŒå‘åœ¨ä¸‰è§’å½¢é‡Œé¢ï¼Œä¸åŒå‘åˆ™ä¸åœ¨ã€‚</p>
<p>è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æ¥åˆ¤æ–­æ±‚äº¤ï¼Œä½†æ˜¯æ•ˆç‡ä¸é«˜ï¼Œæœ‰ä¸€ä¸ªæ•ˆç‡æ›´é«˜çš„ç®—æ³•<code>Moller Trumbore</code>ï¼Œå®ƒæ˜¯ä¸€ç§å¯ä»¥å¿«é€Ÿæ±‚è§£ç›´çº¿ä¸ä¸‰è§’å½¢æ±‚äº¤çš„ç®—æ³•ï¼Œé€šè¿‡ä¸‰é˜¶æ–¹é˜µè¡Œåˆ—å¼çš„æ··åˆç§¯å¯ä»¥å¿«é€Ÿå¾—å‡ºäº¤ç‚¹ä¸é‡å¿ƒåæ ‡ï¼Œç„¶ååˆ¤æ–­é‡å¿ƒåæ ‡æ˜¯å¦å¤§äºé›¶ï¼Œä¸”<code>1-u-v</code>ä¹Ÿè¦å¤§äºé›¶ã€‚è¦æ¨å¯¼å®ƒè¿˜æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦ç”¨åˆ°<a
target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/%E4%B8%89%E9%87%8D%E7%A7%AF">æ··åˆç§¯</a>å’Œ<a
target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/%E5%85%8B%E8%90%8A%E5%A7%86%E6%B3%95%E5%89%87">å…‹è±å§†æ³•åˆ™</a>ã€‚<br />
<code>å…ˆä»‹ç»ä¸€ä¸‹æ··åˆç§¯çš„å¿«é€Ÿè®°å¿†æ³•</code>ï¼š<br />
<img src="/img/00014/image-20.png" srcset="/img/loading.gif" lazyload alt="23" /><br />
å¯¹äºä¸€ä¸ªä¸‰é˜¶æ–¹é˜µçš„è¡Œåˆ—å¼ï¼š<br />
<span class="math display">\[
\begin{align}
\left | \begin{matrix}
A_1 &amp; B_1 &amp; C_1 \\
A_2 &amp; B_2 &amp; C_2 \\
A_3 &amp; B_3 &amp; C_3
\end{matrix} \right |
\end{align} \tag{11}
\]</span> å…¶æ··åˆç§¯å¯ä»¥å†™æˆä»¥ä¸‹å½¢å¼ï¼š<br />
<span class="math display">\[
\begin{align}
(\vec A\times\vec B)\cdot\vec C=(\vec B\times\vec C)\cdot\vec A=(\vec
C\times\vec A)\cdot\vec B
\end{align} \tag{12}
\]</span> <code>å…‹è±å§†æ³•åˆ™</code>:<br />
å¯¹äºçº¿æ€§æ–¹ç¨‹ç»„ <span class="math inline">\(A\vec x = \vec c\)</span>,
å…¶ä¸­<code>A</code>æ˜¯å¯é€†æ–¹é˜µï¼Œ<span class="math inline">\(\vec x,\vec
c\)</span>éƒ½æ˜¯åˆ—å‘é‡ï¼Œé‚£ä¹ˆæ–¹ç¨‹æœ‰è§£ï¼Œä¸”<span class="math inline">\(\vec
x\)</span>çš„æ¯ä¸€ä¸ªè§£ä¸ºï¼š<br />
<span class="math display">\[
\begin{align}
x_i=\frac{\text{det}A_i}{\text{det}A}
\end{align} \tag{13}
\]</span> å…¶ä¸­<code>A_i</code>æ˜¯è¢«åˆ—å‘é‡<span class="math inline">\(\vec
c\)</span>å–ä»£äº†ç¬¬<code>i</code>åˆ—çš„çŸ©é˜µã€‚</p>
<p>ä¸‹é¢æ˜¯<code>MT</code>ç®—æ³•çš„æ¨ç†ï¼Œå¦‚ä¸‹ï¼š<br />
ä¸‰è§’å½¢ä¸­çš„æŸä¸€ç‚¹å¯ä»¥å†™æˆé‡å¿ƒåæ ‡çš„å½¢å¼ï¼Œè¯¥ç‚¹ä¹Ÿå¯ä»¥ç”±å°„çº¿æ–¹ç¨‹å¾—åˆ°ï¼Œåˆ™å¯ä»¥å¾—åˆ°ä¸‹é¢ç­‰å¼ï¼š<br />
<span class="math display">\[
\begin{align}
O+t*\vec D=(1-u-v)*\vec V_0+u*\vec V_1+v*\vec V_2 \\
O-\vec V_0=(\vec V_1-\vec V_0)*u+(\vec V_2-\vec V_0)*v-t*\vec D
\end{align} \tag{14}
\]</span> è®¾ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; \vec S=O-\vec V_0 \\
&amp; \vec E_1=\vec V_1-\vec V_0 \\
&amp; \vec E_2=\vec V_2-\vec V_0 \\
&amp; \vec S=\vec E_1*u+\vec E_2v-t*\vec D
\end{align} \tag{15}
\]</span> è¿™æ˜¯ä¸€ä¸ªçº¿æ€§æ–¹ç¨‹ç»„ï¼Œæˆ‘ä»¬å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š<br />
<span class="math display">\[
\begin{align}
[-\vec D,\vec E_1,\vec E_2]\cdot
\left[\begin{matrix}
t\\
u\\
v
\end{matrix} \right]
=\vec S
\end{align} \tag{16}
\]</span> ç”±å…‹è±å§†æ³•åˆ™å¾—åˆ°å®ƒä»¬çš„è§£ä¸ºï¼š<br />
<span class="math display">\[
\begin{align}
t=\frac{\text{det}(\vec S,\vec E_1,\vec E_2)}{\text{det}(-\vec D,\vec
E_1,\vec E_2)} \\
u=\frac{\text{det}(-\vec D,\vec S,\vec E_2)}{\text{det}(-\vec D,\vec
E_1,\vec E_2)} \\
v=\frac{\text{det}(-\vec D,\vec E_1,\vec S)}{\text{det}(-\vec D,\vec
E_1,\vec E_2)}
\end{align} \tag{17}
\]</span> å†ç”±æ··åˆç§¯å¯å¾—åˆ°åˆ†æ¯å’Œåˆ†å­è¡Œåˆ—å¼çš„å€¼ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; \text{det}(-\vec D,\vec E_1,\vec E_2)=-\vec D\cdot (\vec
E_1\times\vec E_2)=\vec E_1\cdot(\vec E_2\times-\vec D)=\vec
E_1\cdot(\vec D\times\vec E_2)=\vec E_1\cdot\vec S_1 \\
&amp; \text{det}(\vec S,\vec E_1,\vec E_2)=\vec S\cdot (\vec
E_1\times\vec E_2)=\vec E_2\cdot(\vec S\times\vec E_1)=\vec E_2\cdot\vec
S_2 \\
&amp; \text{det}(-\vec D,\vec S,\vec E_2)=-\vec D\cdot (\vec S\times\vec
E_2)=\vec S\cdot(\vec D\times\vec E_2)=\vec S\cdot\vec S_1 \\
&amp; \text{det}(-\vec D,\vec E_1,\vec S)=-\vec D\cdot (\vec
E_1\times\vec S)=\vec D\cdot(\vec S\times\vec E_1)=\vec D\cdot\vec S_2
\end{align} \tag{18}
\]</span> åˆ™ï¼š<br />
<span class="math display">\[
\begin{align}
t=\frac{\vec E_2\cdot\vec S_2}{\vec E_1\cdot\vec S_1} \\
u=\frac{\vec S\cdot\vec S_1}{\vec E_1\cdot\vec S_1} \\
v=\frac{\vec D\cdot\vec S_2}{\vec E_1\cdot\vec S_1}
\end{align} \tag{19}
\]</span> è¿™å°±æ˜¯è¯¾å ‚ä¸Šçœ‹åˆ°çš„å…¬å¼ï¼š<br />
<img src="/img/00014/image-21.png" srcset="/img/loading.gif" lazyload alt="24" /></p>
<h2 id="å…‰çº¿ä¸éšå¼è¡¨é¢æ±‚äº¤">å…‰çº¿ä¸éšå¼è¡¨é¢æ±‚äº¤</h2>
<p>è¿™é‡Œä¸¾ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œå…‰çº¿ä¸çƒé¢æ±‚äº¤ï¼Œå…¶è¿‡ç¨‹å’Œä¸Šé¢å…‰çº¿ä¸å¹³é¢æ±‚äº¤ç±»ä¼¼ï¼š<br />
<img src="/img/00014/image-22.png" srcset="/img/loading.gif" lazyload alt="25" /><br />
è¿˜æ˜¯ä¸€æ ·ç”¨å°„çº¿æ–¹ç¨‹ä»£æ›¿çƒé¢ä¸Šä¸€ç‚¹<code>P</code>ï¼Œç„¶åç›´æ¥æ±‚äºŒæ¬¡å‡½æ•°çš„æ ¹ã€‚</p>
<h2 id="åŠ é€Ÿç»“æ„bounding-volume-hierarchy">åŠ é€Ÿç»“æ„Bounding Volume
Hierarchy</h2>
<p>æœ‰äº†<code>MT</code>ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«åˆ¤æ–­å…‰çº¿æ˜¯å¦ä¸ä¸‰è§’å½¢ç›¸äº¤ï¼Œè€Œéšå¼è¡¨é¢çš„æ±‚äº¤ä¹Ÿå¾ˆå¿«ã€‚ä½†å¤æ‚åœºæ™¯ä¸­çš„ä¸‰è§’å½¢é¢æ•°éå¸¸å¤šï¼Œå¦‚æœæ¯æ¬¡å…‰çº¿å¼¹å°„ä¸€æ¬¡éƒ½è¦ä¸åœºæ™¯ä¸­æ‰€æœ‰ä¸‰è§’å½¢æ±‚äº¤ï¼Œè®¡ç®—é‡è¿˜æ˜¯å¤ªå¤§äº†ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªåŠ é€Ÿç»“æ„<code>BVH</code>ï¼Œæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨æ­¤ä¹‹å‰å…ˆä»‹ç»ä¸€ä¸‹
<code>Bounding Volume</code>æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼š<br />
<img src="/img/00014/image-23.png" srcset="/img/loading.gif" lazyload alt="26" /><br />
æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„åŒ…å›´ç›’åŒ…ä½ä¸€ä¸ªå¤æ‚çš„ç‰©ä½“ï¼Œå…ˆå¯¹åŒ…å›´ç›’æ±‚äº¤å†å¯¹å¤æ‚ç‰©ä½“æ±‚äº¤ï¼Œè¿™æ ·å½“å…‰çº¿æ²¡æœ‰ä¸åŒ…å›´ç›’ç›¸äº¤æ—¶ï¼Œå°±å¯ä»¥é¿å…ä¸å¤æ‚ç‰©ä½“æ±‚äº¤ï¼Œè¿™å¯ä»¥èŠ‚çœå¤§é‡æ—¶é—´ã€‚</p>
<p>åœ¨ä¸‰ç»´åœºæ™¯ä¸­ï¼ŒåŒ…å›´ç›’é€šå¸¸æ˜¯æ¨ªå¹³ç«–ç›´çš„è½´å¯¹é½åŒ…å›´ç›’ï¼ˆAABBï¼‰ï¼š<br />
<img src="/img/00014/image-24.png" srcset="/img/loading.gif" lazyload alt="27" /><br />
è¿™ç§åŒ…å›´ç›’æœ‰ä¸ªç‰¹ç‚¹ï¼Œå®ƒçš„å¹³é¢éƒ½æ˜¯<code>xy</code> <code>yz</code>
<code>zx</code>å¹³é¢ï¼Œæ²¡æœ‰ä»»ä½•æ—‹è½¬ï¼Œåˆ†åˆ«å’Œ<code>z</code> <code>x</code>
<code>y</code>è½´å‚ç›´ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é™ç»´å¤„ç†æ¯ä¸€å¯¹å¹³é¢ï¼Œç„¶ååˆ©ç”¨ä¸‹é¢å…¬å¼è®¡ç®—å…‰çº¿è¿›å…¥å’Œå‡ºå»è¿™å¯¹å¹³é¢çš„æ—¶é—´ï¼Œè¿™é‡Œå‡è®¾æ˜¯<code>yz</code>å¹³é¢ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; t_{min}=\frac{X_0-O}{\vec {d}.x} \\
&amp; t_{max}=\frac{X_1-O}{\vec {d}.x}
\end{align} \tag{20}
\]</span> å…¶ä»–å¯¹å¹³é¢çš„å¤„ç†æ–¹å¼ç›¸åŒï¼š<br />
<img src="/img/00014/image-25.png" srcset="/img/loading.gif" lazyload alt="28" /><br />
ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œ<code>t_min</code>è¦çš„æ˜¯ä¸‰å¯¹å¹³é¢ä¸­æœ€å¤§çš„ä¸€ä¸ªï¼Œè€Œ<code>t_max</code>åˆ™è¦çš„æ˜¯ä¸‰å¯¹å¹³é¢ä¸­æœ€å°çš„ä¸€ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ä¸‹é¢å…¬å¼æ¥æ±‚å¾—å…‰çº¿è¿›å…¥<code>t_enter</code>åŒ…å›´ç›’ä»¥åŠå‡ºå»<code>t_exit</code>åŒ…å›´ç›’çš„æ—¶é—´ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; t_{enter}=\text{max}(t_{min})\\
&amp; t_{exit}=\text{min}(t_{max})
\end{align} \tag{21}
\]</span> æœ€åæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œå…‰çº¿ä¼šä¸åŒ…å›´ç›’ç›¸äº¤ï¼š<br />
1.
<code>t_enter &lt; t_exit</code>ï¼Œè¿™ç§æƒ…å†µè¯´æ˜å…‰çº¿åœ¨åŒ…å›´ç›’ä¸­åœç•™äº†ä¸€æ®µæ—¶é—´ï¼Œæ‰€ä»¥æ˜¯ç›¸äº¤ã€‚
2.
<code>t_enter &lt; 0 &amp;&amp; t_exit &gt;=0</code>ï¼Œè¿™è¯´æ˜å…‰çº¿å°±åœ¨åŒ…å›´ç›’å†…éƒ¨ï¼Œé‚£è‚¯å®šæ˜¯ç›¸äº¤ã€‚</p>
<p>ç»¼åˆè¿™ä¸¤ç§æƒ…å†µå¾—å…‰çº¿ä¸åŒ…å›´ç›’ç›¸äº¤çš„æ¡ä»¶<code>t_enter &lt; t_exit &amp;&amp; t_exit &gt;=0</code>ã€‚</p>
<p>ç°åœ¨æœ‰äº†åŒ…å›´ç›’ï¼Œä½†æ˜¯å…‰çº¿å’ŒåŒ…å›´ç›’ç›¸äº¤åï¼Œå¦‚æœç‰©ä½“å¾ˆå¤æ‚ï¼Œé‚£è¿˜æ˜¯è¦å’Œç‰©ä½“ä¸Šæ¯ä¸ªä¸‰è§’å½¢æ±‚äº¤ï¼Œåªç”¨ä¸€ä¸ªåŒ…å›´ç›’è¿˜æ˜¯è¾¾ä¸åˆ°æˆ‘ä»¬é¢„æœŸï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªåŠ é€Ÿç»“æ„ï¼Œç„¶åå°†å¤æ‚ç‰©ä½“çš„ä¸‰è§’å½¢ä¸æ–­åˆ’åˆ†åˆ°å­åŒ…å›´ç›’ä¸­ï¼Œè¿™é‡Œä»‹ç»ä¸¤ç§åˆ’åˆ†æ–¹æ³•ï¼š</p>
<p>ç¬¬ä¸€ç§æ˜¯ç©ºé—´åˆ’åˆ†æ³•ï¼Œä»¥<code>KD-Tree</code>ä¸ºä¾‹:<br />
å¯¹ç©ºé—´è¿›è¡ŒäºŒåˆ†ï¼ˆä¸€èˆ¬æ˜¯å–ä¸­é—´è¿›è¡Œåˆ’åˆ†ï¼‰ï¼Œæ¯ä¸ªçˆ¶èŠ‚ç‚¹éƒ½æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œä¸ºäº†ä¿è¯åœºæ™¯åˆ’åˆ†çš„å‡åŒ€ï¼Œæ¯æ¬¡éƒ½ä¼šæ²¿ç€<code>xyz</code>è½´åˆ’åˆ†ï¼Œä¸Šæ¬¡æ˜¯æ²¿<code>x</code>è½´åˆ™ä¸‹æ¬¡å°±æ˜¯yè½´ï¼Œå†ä¸‹æ¬¡å°±æ˜¯<code>z</code>è½´ï¼Œå¦‚æ­¤å¾ªç¯ï¼Œç›´åˆ°å¶å­èŠ‚ç‚¹åŒ…å«çš„ä¸‰è§’å½¢æ•°é‡æ¯”è¾ƒå°‘æ—¶åœæ­¢åˆ’åˆ†ï¼Œå…¶ä¸­éå¶å­èŠ‚ç‚¹ä¸å­˜å‚¨ä¸‰è§’å½¢ï¼š<br />
<img src="/img/00014/image-26.png" srcset="/img/loading.gif" lazyload alt="29" /><br />
æœ‰äº†è¿™ä¸ªåŠ é€Ÿç»“æ„ï¼Œæˆ‘ä»¬å†<code>Trace</code>ä¸€ä¸ªç‰©ä½“æ—¶ï¼Œå°±èƒ½æœ‰æ•ˆé¿å…å’Œæ•´ä¸ªç‰©ä½“çš„ä¸‰è§’å½¢æ±‚äº¤ï¼Œæ—¶é—´å¤æ‚åº¦ç”±<span
class="math inline">\(O(n)\)</span>é™ä¸º<span
class="math inline">\(O(\log_{2}n)\)</span>ï¼š<br />
<img src="/img/00014/image-27.png" srcset="/img/loading.gif" lazyload alt="30" /><br />
å›¾ä¸­è“è‰²å—å’Œ<code>A</code>çš„å­èŠ‚ç‚¹ä¸€æ ·å¤„ç†ï¼Œåªä¸è¿‡è¿™é‡Œéšè—äº†ã€‚<br />
ä½†æ˜¯ç©ºé—´åˆ’åˆ†æœ‰ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œä¸‰è§’å½¢ä¼šå’ŒåŒ…å›´ç›’ç›¸äº¤ï¼Œæˆ‘ä»¬å¾—çŸ¥é“åŒ…å›´ç›’å’Œå“ªäº›ä¸‰è§’å½¢æœ‰äº¤é›†ï¼Œæ‰èƒ½å°†è¿™äº›ä¸‰è§’å½¢å­˜å‚¨åˆ°å¶å­èŠ‚ç‚¹ä¸­ï¼Œè¿™æ ·é—®é¢˜åˆå˜å¾—æ¯”è¾ƒå¤æ‚äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¸ç”¨<code>KD-Tree</code>æ¥åˆ’åˆ†ç©ºé—´ï¼Œè€Œæ˜¯ç”¨<code>BVH</code>æ¥åˆ’åˆ†ç‰©ä½“ï¼Œä»è€Œé¿å…åˆ¤æ–­ä¸‰è§’å½¢å’ŒåŒ…å›´ç›’æ±‚äº¤çš„é—®é¢˜ã€‚</p>
<p>ç¬¬äºŒç§æ–¹æ³•åˆ™æ˜¯ç‰©ä½“åˆ’åˆ†æ³•ï¼Œä»¥<code>BVH</code>ä¸ºä¾‹ï¼Œç°åœ¨åŸºæœ¬ä¸Šåªè¦æ˜¯è·Ÿå…‰çº¿è¿½è¸ªæœ‰å…³çš„åŠ é€Ÿç»“æ„ï¼Œéƒ½æ˜¯ç”¨çš„ç±»ä¼¼<code>BVH</code>æ¥è§£å†³çš„ï¼Œå¯è§å…¶é‡è¦æ€§ã€‚<br />
<code>BVH</code>çš„åˆ’åˆ†æ€è·¯å’Œ<code>KD-Tree</code>æ˜¯ç±»ä¼¼çš„ï¼Œå³å¯¹ç‰©ä½“çš„ä¸‰è§’å½¢è¿›è¡ŒäºŒåˆ†ï¼ˆåé¢è¯´å…·ä½“çš„åˆ’åˆ†æ³•ï¼‰ï¼Œç„¶ååˆ†åˆ«æ±‚å­èŠ‚ç‚¹çš„åŒ…å›´ç›’ï¼Œéå¶å­èŠ‚ç‚¹ä¹Ÿæ˜¯ä¸€æ ·ä¸å­˜å‚¨ä¸‰è§’å½¢åªç”¨äºåˆ¤æ–­æ˜¯å¦ç›¸äº¤ï¼Œå¶å­èŠ‚ç‚¹åœ¨åŒ…å›´ç›’å†…ä¸‰è§’å½¢æ¯”è¾ƒå°‘æ—¶åœæ­¢åˆ’åˆ†ï¼š<br />
<img src="/img/00014/image-28.png" srcset="/img/loading.gif" lazyload alt="31" /><br />
ç”¨<code>BVH</code>åˆ’åˆ†ä¹Ÿä¼šæœ‰ç‚¹å°é—®é¢˜ï¼Œé‚£å°±æ˜¯åŒ…å›´ç›’é‡å ï¼Œé‡å éƒ¨åˆ†è¶Šå¤šéœ€è¦è®¿é—®çš„èŠ‚ç‚¹æ•°é‡å°±è¶Šå¤šï¼Œæ±‚äº¤çš„æ•ˆç‡å°±è¶Šä½ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¥½çš„æ–¹æ³•å»å°½é‡é¿å…é‡å ï¼Œä¸€ä¸ªè¿˜ç®—ä¸é”™ä¸”æ¯”è¾ƒé€šç”¨çš„æ‰‹æ®µæ˜¯å¯¹ç‰©ä½“å…ˆè¿›è¡Œæ’åºï¼Œç„¶åå–ä¸­é—´ç‰©ä½“ä½œä¸ºåˆ†å‰²çº¿ï¼Œåœ¨æ­¤ä¹‹å‰è¿˜è¦å‘<code>KD-Tree</code>å­¦ä¹ ï¼Œæˆ‘ä»¬æ‰¾åˆ°å½“å‰èŠ‚ç‚¹ä¸‹èƒ½åŒ…å›´æ‰€æœ‰ä¸‰è§’å½¢çš„åŒ…å›´ç›’ä¸­å¿ƒä½ç½®ï¼Œç„¶ååˆ¤æ–­è¯¥ä½ç½®çš„<code>xyz</code>åˆ†é‡ï¼Œå–æœ€å¤§åˆ†é‡çš„è½´ä¸ºæ’åºè½´ï¼š<br />
<img src="/img/00014/image-29.png" srcset="/img/loading.gif" lazyload alt="32" /><br />
éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä¸Šé¢è¯´çš„<code>åˆ†åˆ«æ±‚å­èŠ‚ç‚¹çš„åŒ…å›´ç›’</code>è¿™è¿‡ç¨‹æ˜¯åœ¨å›æº¯è¿‡ç¨‹ä¸­å®Œæˆçš„ï¼Œé€’å½’å®Œæˆçš„æ˜¯æ’åºå’Œåˆ’åˆ†ï¼Œä¸ºäº†é™åˆ¶æ–‡ç« é•¿åº¦ï¼Œå°±ä¸è´´ä»£ç äº†ã€‚</p>
<p>ç›¸æ¯”äº<code>BVH</code>ï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´åŠ é«˜æ•ˆçš„æ–¹æ³•<code>Surface Area Heuristic</code>ï¼š<br />
æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™ä¸ªä¾‹å­ï¼š<br />
<img src="/img/00014/image-30.png" srcset="/img/loading.gif" lazyload alt="33" /><br />
å‡è®¾æˆ‘ä»¬å·²ç»å¯¹å›¾<code>b</code>å’Œå›¾<code>c</code>åœ¨æŸè½´ä¸Šæ’åºå¥½äº†ä»–ä»¬çš„åŒ…å›´ç›’ï¼ŒæŒ‰ç…§<code>BVH</code>çš„åˆ’åˆ†æ€è·¯ï¼Œå®ƒåˆ’åˆ†å¥½çš„æ ·å­æ˜¯å›¾<code>b</code>ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾å›¾<code>c</code>æ˜¯ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œè€Œ<code>SAH</code>å°±å¯ä»¥åšè¿™æ ·çš„ä¸€ä»¶äº‹æƒ…ã€‚<br />
æ­£å¦‚å®ƒçš„åå­—æ‰€è¯´ï¼Œè¿™ä¸ªç®—æ³•è€ƒè™‘äº†åŒ…å›´ç›’çš„è¡¨é¢ç§¯ï¼Œä¸å†æ˜¯ä¸­é—´ä¸€åˆ€åˆ‡ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒå°†åŒ…å›´ç›’åˆ†æˆäº†è‹¥å¹²ä¸ªæ¡¶ï¼Œå°±ä¸‹å›¾è€Œè¨€ï¼Œæœ‰<code>6</code>ä¸ªæ¡¶ï¼š<br />
<img src="/img/00014/image-31.png" srcset="/img/loading.gif" lazyload alt="34" /><br />
ç„¶åè®°å½•æ¯ä¸ªæ¡¶ä¸­ä¸‰è§’å½¢çš„æ•°é‡ï¼Œå¹¶ä¾æ¬¡æŒ‰æ¡¶çš„è¾¹ç•Œå¯¹åŒ…å›´ç›’è¿›è¡ŒäºŒåˆ†ï¼Œç„¶åè®°å½•æ¯æ¬¡åˆ†å‰²åçš„å¼€é”€ï¼Œç”¨ä¸‹é¢è¿™ä¸ªå…¬å¼è®¡ç®—ï¼š<br />
<span class="math display">\[
\begin{align}
\text{cost}(A,B)=t_{trav}+p_A\sum_{i=1}^{N_A}t_{isect}(a_i)+p_B\sum_{i=1}^{N_B}t_{isect}(b_i)
\end{align} \tag{22}
\]</span> å…¶ä¸­<code>A</code>ï¼Œ<code>B</code>æ˜¯åˆ†å‰²åçš„ä¸¤ä¸ªåŒ…å›´ç›’ã€‚<br />
<code>t_trav</code>ä»£è¡¨è®¿é—®è¯¥èŠ‚ç‚¹çš„å¼€é”€ï¼Œä¸æ˜¯æ±‚äº¤ï¼Œå°±æ˜¯å•çº¯çš„è·å–æ•°æ®è¯»å–æ•°æ®ï¼Œæˆ‘ä»¬ä¸€èˆ¬æŠŠå®ƒè®¾ä¸º<code>0.125</code>ã€‚<br />
<code>t_isect(a_i)</code>ä»£è¡¨å¯¹åŒ…å›´ç›’<code>A</code>å†…çš„æŸä¸ªä¸‰è§’å½¢æ±‚äº¤çš„å¼€é”€ï¼Œæˆ‘ä»¬ä¸€èˆ¬å°†å…¶è®¾ä¸º<code>1</code>ï¼Œ<code>t_isect(b_i)</code>åŒç†ã€‚<br />
å¯¹äº<code>p_A</code>å’Œ<code>p_B</code>ï¼Œçœ‹ä¸‹é¢å›¾ä¾‹ï¼š<br />
<img src="/img/00014/image-32.png" srcset="/img/loading.gif" lazyload alt="35" /><br />
å…‰çº¿ç©¿è¿‡åŒ…å›´ç›’<code>C</code>çš„å‰æä¸‹ç©¿è¿‡åŒ…å›´ç›’<code>A</code>çš„æ¦‚ç‡ä¸º<span
class="math inline">\(p_A=\frac{S(A)}{S(C)}\)</span>ï¼ŒåŒç†<span
class="math inline">\(p_B=\frac{S(B)}{S(C)}\)</span>ï¼Œå…¶ä¸­<code>S(x)</code>å‡½æ•°çš„ä½œç”¨ä¸ºè·å–åŒ…å›´ç›’çš„è¡¨é¢ç§¯ã€‚<br />
è¿™æ ·ä¸Šé¢<code>22</code>å¼å°±å¯ä»¥ç®€åŒ–ä¸ºï¼š<br />
<span class="math display">\[
\begin{align}
\text{cost}(A,B)=0.125+\frac{S(A)}{S(C)}*N_A+\frac{S(B)}{S(C)}*N_B
\end{align} \tag{23}
\]</span>
æœ€åé€‰æ‹©å¼€é”€æœ€å°çš„åˆ†å‰²çº¿å¯¹ç‰©ä½“è¿›è¡Œåˆ†å‰²ï¼Œé€’å½’ä¸‹å»ï¼Œç›´åˆ°åŒ…å›´ç›’å†…ä¸‰è§’å½¢æ•°é‡è¾ƒå°‘æ—¶åœæ­¢ã€‚è¿™éƒ¨åˆ†çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">BVHAccel::computeObjSurArea</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Object *&gt;&amp; objects)</span></span>&#123;<br>    <span class="hljs-type">double</span> area = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; obj:objects)&#123;<br>        area += obj-&gt;<span class="hljs-built_in">getBounds</span>().<span class="hljs-built_in">SurfaceArea</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> area;<br>&#125;<br><span class="hljs-function">BVHBuildNode * <span class="hljs-title">BVHAccel::recursiveBuildSAH</span><span class="hljs-params">(std::vector&lt;Object *&gt; objects)</span></span>&#123;<br>    BVHBuildNode* node = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BVHBuildNode</span>();<br><br>    <span class="hljs-comment">// Compute bounds of all primitives in BVH node</span><br>    <span class="hljs-keyword">if</span> (objects.<span class="hljs-built_in">size</span>() == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// Create leaf _BVHBuildNode_</span><br>        node-&gt;bounds = objects[<span class="hljs-number">0</span>]-&gt;<span class="hljs-built_in">getBounds</span>();<br>        node-&gt;object = objects[<span class="hljs-number">0</span>];<br>        node-&gt;left = <span class="hljs-literal">nullptr</span>;<br>        node-&gt;right = <span class="hljs-literal">nullptr</span>;<br>        node-&gt;area = objects[<span class="hljs-number">0</span>]-&gt;<span class="hljs-built_in">getArea</span>();<br>        <span class="hljs-keyword">return</span> node;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objects.<span class="hljs-built_in">size</span>() == <span class="hljs-number">2</span>) &#123;<br>        node-&gt;left = <span class="hljs-built_in">recursiveBuildSAH</span>(&#123;objects[<span class="hljs-number">0</span>]&#125;);<br>        node-&gt;right = <span class="hljs-built_in">recursiveBuildSAH</span>(&#123;objects[<span class="hljs-number">1</span>]&#125;);<br><br>        node-&gt;bounds = <span class="hljs-built_in">Union</span>(node-&gt;left-&gt;bounds, node-&gt;right-&gt;bounds);<br>        node-&gt;area = node-&gt;left-&gt;area + node-&gt;right-&gt;area;<br>        <span class="hljs-keyword">return</span> node;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        Bounds3 bounds;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; objects.<span class="hljs-built_in">size</span>(); ++i)<br>            bounds = <span class="hljs-built_in">Union</span>(bounds, objects[i]-&gt;<span class="hljs-built_in">getBounds</span>());<br>        <span class="hljs-type">double</span> boundsSurfaceAreaInv = <span class="hljs-number">1.0f</span> / bounds.<span class="hljs-built_in">SurfaceArea</span>();<br><br>        <span class="hljs-keyword">auto</span> beginning=objects.<span class="hljs-built_in">begin</span>();<br>        <span class="hljs-keyword">auto</span> ending=objects.<span class="hljs-built_in">end</span>();<br>        <span class="hljs-keyword">if</span>(objects.<span class="hljs-built_in">size</span>() &lt; <span class="hljs-number">4</span>)&#123;<br>            <span class="hljs-keyword">auto</span> middling = objects.<span class="hljs-built_in">begin</span>() +objects.<span class="hljs-built_in">size</span>()/<span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">auto</span> leftshapes = std::<span class="hljs-built_in">vector</span>&lt;Object*&gt;(beginning, middling);<br>            <span class="hljs-keyword">auto</span> rightshapes = std::<span class="hljs-built_in">vector</span>&lt;Object*&gt;(middling, ending);<br>            node-&gt;left = <span class="hljs-built_in">recursiveBuildSAH</span>(std::<span class="hljs-built_in">move</span>(leftshapes));<br>            node-&gt;right = <span class="hljs-built_in">recursiveBuildSAH</span>(std::<span class="hljs-built_in">move</span>(rightshapes));<br>            node-&gt;bounds = <span class="hljs-built_in">Union</span>(node-&gt;left-&gt;bounds, node-&gt;right-&gt;bounds);<br>            node-&gt;area = node-&gt;left-&gt;area + node-&gt;right-&gt;area;<br>        &#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">int</span> bestChoice=<span class="hljs-number">0</span>;<br>            <span class="hljs-type">double</span> minCost=std::numeric_limits&lt;<span class="hljs-type">double</span> &gt;::<span class="hljs-built_in">max</span>();<br>            <span class="hljs-type">double</span> objSize =(<span class="hljs-type">double</span>)objects.<span class="hljs-built_in">size</span>();<br>            <span class="hljs-type">double</span> nums[]=&#123;<span class="hljs-number">1.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">2.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">3.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">4.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">5.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">6.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">7.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">8.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">9.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">10.0</span>/<span class="hljs-number">12</span>,<span class="hljs-number">11.0</span>/<span class="hljs-number">12</span>&#125;;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-number">11</span>;i++)<br>                nums[i]*= objSize;<br>            <span class="hljs-type">int</span> dim = bounds.<span class="hljs-built_in">maxExtent</span>();<br>            <span class="hljs-keyword">switch</span> (dim)&#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<span class="hljs-comment">//x</span><br>                    std::<span class="hljs-built_in">sort</span>(objects.<span class="hljs-built_in">begin</span>(), objects.<span class="hljs-built_in">end</span>(), [](<span class="hljs-keyword">auto</span> f1, <span class="hljs-keyword">auto</span> f2)<br>                            &#123; <span class="hljs-keyword">return</span> f1-&gt;<span class="hljs-built_in">getBounds</span>().<span class="hljs-built_in">Centroid</span>().x &lt;<br>                                    f2-&gt;<span class="hljs-built_in">getBounds</span>().<span class="hljs-built_in">Centroid</span>().x; &#125;);<br>                    <span class="hljs-keyword">break</span>;<br>				...<span class="hljs-comment">//y z</span><br>            &#125;<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-number">11</span>;i++)&#123;<br>                <span class="hljs-keyword">auto</span> middling = objects.<span class="hljs-built_in">begin</span>() + (<span class="hljs-type">int</span>)nums[i];<br>                <span class="hljs-keyword">auto</span> leftshapes = std::<span class="hljs-built_in">vector</span>&lt;Object*&gt;(beginning, middling);<br>                <span class="hljs-keyword">auto</span> rightshapes = std::<span class="hljs-built_in">vector</span>&lt;Object*&gt;(middling, ending);<br>                <span class="hljs-type">double</span> leftBoxArea = <span class="hljs-built_in">computeObjSurArea</span>(leftshapes);<br>                <span class="hljs-type">double</span> rightBoxArea = <span class="hljs-built_in">computeObjSurArea</span>(rightshapes);<br>                <span class="hljs-type">double</span> cost = <span class="hljs-number">0.125f</span>+<br>                ( leftBoxArea * leftshapes.<span class="hljs-built_in">size</span>() + rightBoxArea * rightshapes.<span class="hljs-built_in">size</span>() )<br>                 * boundsSurfaceAreaInv;<br>                <span class="hljs-keyword">if</span>(cost &lt; minCost)&#123;   <br>                    minCost = cost;<br>                    bestChoice=(<span class="hljs-type">int</span>)nums[i];<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">auto</span> middling = objects.<span class="hljs-built_in">begin</span>() + bestChoice;<br>            <span class="hljs-keyword">auto</span> leftshapes = std::<span class="hljs-built_in">vector</span>&lt;Object*&gt;(beginning, middling);<br>            <span class="hljs-keyword">auto</span> rightshapes = std::<span class="hljs-built_in">vector</span>&lt;Object*&gt;(middling, ending);<br>            node-&gt;left = <span class="hljs-built_in">recursiveBuildSAH</span>(std::<span class="hljs-built_in">move</span>(leftshapes));<br>            node-&gt;right = <span class="hljs-built_in">recursiveBuildSAH</span>(std::<span class="hljs-built_in">move</span>(rightshapes));<br>            node-&gt;bounds = <span class="hljs-built_in">Union</span>(node-&gt;left-&gt;bounds, node-&gt;right-&gt;bounds);<br>            node-&gt;area = node-&gt;left-&gt;area + node-&gt;right-&gt;area;<br>        &#125;<br>        <span class="hljs-keyword">return</span> node;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure> å’Œ<code>BVH</code>çš„å¯¹æ¯”æ•ˆæœå›¾å¦‚ä¸‹ï¼š<br />
<img src="/img/00014/BVH-SAH.png" srcset="/img/loading.gif" lazyload alt="36" /><br />
<img src="/img/00014/image-33.png" srcset="/img/loading.gif" lazyload alt="37" /><br />
å¿«äº†ä¸€ç‚¹ç‚¹ï¼Œä¸å¤šï¼Œå¯èƒ½åœ¨æ›´å¤æ‚çš„åœºæ™¯ä¸‹å·®è·ä¼šæ‹‰å¼€ã€‚<br />
ä¸Šé¢éƒ¨åˆ†å›¾ç‰‡æ¥æºäº<a
target="_blank" rel="noopener" href="https://pbr-book.org/3ed-2018/Primitives_and_Intersection_Acceleration/Bounding_Volume_Hierarchies">pbrt-SAH</a>ã€‚</p>
<h2 id="ç›´æ¥å…‰é‡‡æ ·">ç›´æ¥å…‰é‡‡æ ·</h2>
<p>å›åˆ°<code>NEE Path Tracing</code>ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">function <span class="hljs-title">Li</span><span class="hljs-params">(p,wo,depth)</span></span><br><span class="hljs-function">    ...</span><br><span class="hljs-function">	Randomly select a sampling point on the light source, p_on_light</span><br><span class="hljs-function">	Trace a shadowRay <span class="hljs-title">sr</span><span class="hljs-params">(p,(p_on_light - p).normalized() )</span></span><br><span class="hljs-function">	<span class="hljs-title">if</span><span class="hljs-params">(ray sr does <span class="hljs-keyword">not</span> hit an object except light source)</span></span><br><span class="hljs-function">		direct </span>= LightRadiance * f_r * cosÎ¸ / pdfLight_solidAngle;<br>	...<br></code></pre></td></tr></table></figure>
è¿™ä¸ª<code>pdfLight_solidAngle</code>æˆ‘ä»¬è¿˜ä¸çŸ¥é“æ€ä¹ˆç®—ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“<code>BRDF</code>é‡‡æ ·ï¼Œç”¨ä¸€ç§æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼ˆPDFï¼‰ï¼Œå»é‡‡æ ·ä¸€ä¸ªæ–¹å‘<code>wi</code>ï¼Œå¹¶ä¸”è·å¾—è¯¥æ–¹å‘çš„<code>pdf</code>æ˜¯å¤šå°‘ï¼Œä¸‹é¢æ˜¯<code>cos weight PDF</code>å¾—åˆ°çš„<code>16spp</code>ç›´æ¥å…‰é‡‡æ ·æ•ˆæœï¼š<br />
<img src="/img/00014/image-34.png" srcset="/img/loading.gif" lazyload alt="38" /><br />
è¿™æ•ˆæœå¤ªå·®äº†ï¼Œå› ä¸º<code>BRDF</code>é‡‡æ ·å¯¹äº<code>Diffuse</code>ç‰©ä½“è€Œè¨€ï¼Œå®ƒå¾ˆéš¾ç”Ÿæˆä¸€æ ¹æ‰“ä¸­å…‰æºçš„å…‰çº¿ï¼Œæˆ‘ä»¬è¦æ”¹è¿›è¿™ä¸€ç‚¹ï¼Œè®©ç‰©ä½“ç›´æ¥å¯¹å…‰æºé‡‡æ ·ï¼š<br />
å¯¹å…‰æºçš„é‡‡æ ·ä¸»è¦æ˜¯è·å¾—é‡‡æ ·æ–¹å‘<code>wi</code>ä»¥åŠå®ƒçš„<code>pdf</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é¢å…‰æºä¸Šéšæœºé€‰æ‹©ä¸€ä¸ªé‡‡æ ·ç‚¹ï¼Œå¯¹äºç‰©ä½“ä¸Šçš„ä¸€ç‚¹<code>x</code>ä¸å®ƒè¿çº¿ï¼Œå½¢æˆ<code>ShadowRay</code>ï¼Œå› ä¸ºæ˜¯åœ¨å…‰æºä¸Šéšæœºé€‰æ‹©ä¸€ä¸ªé‡‡æ ·ç‚¹ï¼Œæ‰€ä»¥é‡‡æ ·å…‰æºçš„<code>pdf</code>ä¸º<code>1/A</code>ï¼Œ<code>A</code>ä¸ºå…‰æºçš„é¢ç§¯ï¼Œå†å°†æ¸²æŸ“æ–¹ç¨‹å¯¹<code>dw</code>çš„ç§¯åˆ†æ¢æˆ<code>dA</code>çš„ç§¯åˆ†å³å¯ï¼š<br />
<img src="/img/00014/image-35.png" srcset="/img/loading.gif" lazyload alt="39" /><br />
ä½†æ˜¯æˆ‘ä¸è¿™æ ·åšï¼Œå› ä¸ºåé¢å¤šé‡é‡è¦æ€§é‡‡æ ·éœ€è¦<code>pdf</code>åœ¨åŒä¸€ä¸ªè§’åº¦è€ƒè™‘ï¼Œè¦ä¹ˆæ˜¯åœ¨ç«‹ä½“è§’ä¸Šè¦ä¹ˆæ˜¯åœ¨é¢ç§¯ä¸Šï¼Œè€Œæˆ‘é€‰æ‹©çš„æ˜¯ç«‹ä½“è§’ä¸Šï¼Œå³å°†å…‰æºçš„é¢ç§¯æŠ•å½±åˆ°ç«‹ä½“è§’ä¸Šï¼Œç„¶åè·å¾—å…‰æºåœ¨ç«‹ä½“è§’ä¸Šçš„<code>pdf</code>ï¼Œå…¶è¿‡ç¨‹å’Œä¸Šé¢<code>dw</code>è½¬æ¢ä¸º<code>dA</code>ç±»ä¼¼ï¼š<br />
<span class="math display">\[
\begin{align}
pdfLight\text{-}SolidAngle=\frac{A\cos\theta&#39;}{||x-x&#39;||^2}
\end{align} \tag{24}
\]</span> ä»£ç ä¸­æ¸²æŸ“æ–¹ç¨‹è¿˜æ˜¯å†™æˆä¸‹é¢è¿™ç§å½¢å¼ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">Le += L_dir_Inter.emit * f_r * std::<span class="hljs-built_in">fmax</span>(<span class="hljs-built_in">dotProduct</span>(w_Li, intersection.normal),<span class="hljs-number">0.0</span>) / light_solidAngle_pdf;<br></code></pre></td></tr></table></figure> ä¸‹é¢æ˜¯<code>1spp</code>ç›´æ¥å…‰é‡‡æ ·çš„æ•ˆæœï¼š<br />
<img src="/img/00014/image-36.png" srcset="/img/loading.gif" lazyload alt="40" /><br />
å¯ä»¥çœ‹åˆ°è¿™æ¯”<code>16sppBRDF</code>é‡‡æ ·çš„æ•ˆæœå¥½å¤ªå¤šï¼è€Œé—´æ¥å…‰å¦‚ä½•å¤„ç†åœ¨ä¸Šé¢ä¼ªä»£ç ä¸­å·²ç»å†™å‡ºæ¥ï¼Œè¿™éƒ¨åˆ†æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œæˆ‘ä»¬çœ‹<code>16spp</code>å…¨å±€å…‰ç…§çš„æ•ˆæœï¼š<br />
<img src="/img/00014/MIS-16spp-1.png" srcset="/img/loading.gif" lazyload alt="41" /><br />
è¿˜æ˜¯æŒºä¸é”™çš„ğŸ˜†ï¼ä»£ç å°±ä¸è´´äº†ï¼Œå¯ä»¥çœ‹ä¸‹æˆ‘çš„æºç ï¼Œæœ‰è¯¦ç»†æ³¨é‡Šï¼</p>
<h1 id="brdf-and-bsdf">BRDF and BSDF</h1>
<h2 id="brdf">BRDF</h2>
<p><code>BRDF</code>è¿™ä¸ª<code>R</code>æŒ‡çš„æ˜¯åå°„ï¼Œè€Œ<code>BSDF</code>çš„<code>S</code>æŒ‡çš„æ˜¯æ•£å°„ï¼Œå®ƒç”±<code>BRDF</code>å’Œ<code>BTDF</code>ç»„æˆçš„ï¼Œå…ˆæ¥çœ‹ä¸‹<code>BRDF</code>ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç”¨çš„æ˜¯<code>Cook-Torrance</code>åå°„æ–¹ç¨‹:<br />
<span class="math display">\[
\begin{align}
L_{o}(p,w_{o})=\int_{\Omega}^{}(kd\frac{c}{\pi}+ks\frac{DFG}{4(w_{o}\cdot
n)(w_{i}\cdot n)})L_{i}(p,w_{i})n\cdot w_{i}dw_{i}
\end{align} \tag{25}
\]</span></p>
<p>å› ä¸ºè¿™é‡Œ<code>ks</code>å’Œ<code>Fresnel</code>é¡¹æŒ‡ä»£çš„æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥å»æ‰<code>ks</code>,å…¶ä¸­<code>o</code>ä»£è¡¨å‡ºå°„æ–¹å‘ä¹Ÿå°±æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„æ–¹å‘ï¼Œ<code>i</code>æ˜¯å…¥å°„æ–¹å‘å³å…‰ç…§æ–¹å‘ã€‚<br />
è¿™ä¸ªæ–¹ç¨‹çš„æ¨å¯¼å°±ä¸ç»†è¯´äº†ï¼Œå…¶å®æˆ‘ä¹Ÿæ²¡æ¨è¿‡ğŸ˜‘ï¼Œèƒ½ç”¨å°±è¡Œå“ˆå“ˆï¼Œä¸è¿‡å®ƒçš„ä½œç”¨æˆ‘åœ¨ä¸Šæ–‡ä¸­å·²ç»è¯¦ç»†è®²è¿‡äº†ï¼Œå¯ä»¥å»çœ‹ä¸‹ã€‚è¯´ä¸‹è¿™é‡Œæ¯é¡¹å…·ä½“éƒ½æ˜¯äº›ä»€ä¹ˆä¸œè¥¿ï¼š</p>
<p><code>kd</code>è¡¨ç¤ºæŠ˜å°„æˆ–æ¼«åå°„éƒ¨åˆ†æ‰€å çš„æ¯”ä¾‹ï¼Œè€Œ<code>ks</code>åˆ™æ˜¯åå°„æ¯”ä¾‹ã€‚åœ¨<code>BRDF</code>ä¸­<code>kd</code>å°±æ˜¯æ¼«åå°„éƒ¨åˆ†<code>kd=1.0-ks</code>ã€‚å› ä¸ºé‡‘å±ä¸ä¼šæŠ˜å°„å…‰çº¿ï¼Œå› æ­¤ä¸ä¼šæœ‰æ¼«åå°„ï¼Œå¦‚æœè¡¨é¢æ˜¯é‡‘å±çš„ï¼Œæˆ‘ä»¬ä¼šæŠŠç³»æ•°<code>kd</code>å˜ä¸º<code>0</code>ï¼Œå³<code>kd=(1.0-ks)*(1.0-metallic)</code>ã€‚</p>
<p><code>c/Ï€</code>æ˜¯å…°ä¼¯ç‰¹é¡¹ï¼Œä¹Ÿç§°ä½œ<code>Diffuse</code>é¡¹ï¼Œ<code>c</code>æ˜¯<code>albedo</code>ï¼Œé™¤ä»¥<code>Ï€</code>æ˜¯ä¸ºäº†èƒ½é‡å®ˆæ’ï¼Œä¸Šé¢æˆ‘æœ‰æåˆ°<code>BRDF</code>çš„å®šä¹‰æ˜¯å…¥å°„å…‰çš„<code>Irradiance</code>å‘åå°„æ–¹å‘<code>wo</code>è¾å°„å‡ºçš„<code>Radiance</code>æ˜¯å¤šå°‘ï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬çš„æ¯”ç‡ï¼Œå‡è®¾æ¼«åå°„è¾å°„å‡ºçš„èƒ½é‡æ˜¯<code>c</code>ï¼Œå…¥å°„å…‰çš„<code>Radiance</code>ä¸º<code>1</code>ï¼Œå› ä¸ºæ¼«åå°„çš„<code>BRDF</code>æ˜¯å¸¸å€¼åˆ™æœ‰ä¸‹é¢ç­‰å¼ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; c=f_r\int_{\Omega+}\cos\theta\text{d}w_i \\
&amp; c=f_r*2\pi*\int_{0}^{\frac{\pi}{2}}\sin\theta\text{d}\sin\theta \\
&amp; c=f_r*2\pi*\frac{\sin^2\theta}{2}|_{0}^{\frac{\pi}{2}}\\
&amp; c=f_r*\pi\\
&amp; f_r=\frac{c}{\pi}
\end{align} \tag{26}
\]</span></p>
<p><span class="math inline">\(\frac{DFG}{4(w_{o}\cdot n)(w_{i}\cdot
n)}\)</span>è¿™å¨ä¸œè¥¿æ˜¯<code>Specular</code>åå°„é¡¹ã€‚å®ƒæ˜¯åŸºäºå¾®å¹³é¢ç†è®ºæ¨å¯¼å‡ºæ¥çš„ï¼Œå¾®å¹³é¢ç†è®ºå‡è®¾ç‰©ä½“æ˜¯ç”±å¾ˆå¤šå¾®å¹³é¢ç»„æˆï¼Œæ¯ä¸ªå¾®å¹³é¢éƒ½æ˜¯ç»å¯¹å…‰æ»‘çš„ï¼Œä½†æ˜¯éƒ½éå¸¸å°ï¼Œæ²¡åŠæ³•ä¸€ä¸ªä¸€ä¸ªè§‚å¯Ÿåˆ°ï¼Œåªèƒ½çœ‹åˆ°ç»Ÿè®¡åçš„å®è§‚ç»“æœã€‚å®ƒä¸‹é¢<span
class="math inline">\(4(w_{o}\cdot n)(w_{i}\cdot
n)\)</span>æ˜¯ä¸€ä¸ªæ ¡æ­£å› å­ï¼Œç”¨æ¥æ ¡æ­£ä»å¾®å¹³é¢çš„å±€éƒ¨ç©ºé—´è½¬åˆ°æ•´ä½“è¡¨é¢æ—¶çš„æ•°é‡å·®å¼‚ã€‚</p>
<h3 id="normal-distribution-function">Normal Distribution Function</h3>
<p><code>D</code>é¡¹ä¸º<code>GGX</code>æ³•çº¿åˆ†å¸ƒå‡½æ•°ï¼Œ<code>Glossy</code>ç‰©ä½“é‡‡æ ·æŸæ–¹å‘çš„<code>PDF</code>å‡½æ•°å°±æ˜¯ç”±è¯¥å‡½æ•°ä¹˜ä¸Š<code>cos</code>åœ¨åŠçƒç§¯åˆ†æ‰€å¾—ï¼š<br />
<span class="math display">\[
\begin{align}
\int_{\Omega+}D(h)(n\cdot h)\text{d}w_h=1
\end{align} \tag{27}
\]</span> <img src="/img/00014/image-37.png" srcset="/img/loading.gif" lazyload alt="42" /><br />
ä¹˜ä¸Š<code>cos</code>é¡¹æ˜¯ä¸ºäº†å°†å¾®å¹³é¢æŠ•å½±åˆ°ç«‹ä½“è§’ä¸Šï¼Œ<code>n</code>æ˜¯è¡¨é¢çš„æ³•çº¿ï¼Œ<code>h</code>æ˜¯åŠç¨‹å‘é‡ã€‚å…³äºè¿™é‡Œ<code>cos</code>çš„æ¥æºæ›´å¤šå†…å®¹çœ‹<a
target="_blank" rel="noopener" href="https://www.reedbeta.com/blog/hows-the-ndf-really-defined/">è¿™ç¯‡æ–‡ç« </a>ã€‚æœ‰äº†æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼Œæ ¹æ®é€†å˜æ¢é‡‡æ ·å°±å¯ä»¥å¾—åˆ°å…·ä½“çš„æ–¹å‘äº†ï¼Œæˆ‘åœ¨<a
href="https://howl144.github.io/2023/07/01/00018.%20Games202%20Hw4/#splitsum%E5%92%8Cggx%E9%87%8D%E8%A6%81%E6%80%A7%E9%87%87%E6%A0%B7">è¿™ç¯‡æ–‡ç« </a>æœ‰è¯¦ç»†è®²åˆ°é€†å˜æ¢é‡‡æ ·å’Œé‡è¦æ€§é‡‡æ ·æ€ä¹ˆç®—ã€‚<br />
çœ‹ä¸‹<code>D</code>é¡¹å…·ä½“çš„ä½œç”¨ä»¥åŠå‡½æ•°å¼ï¼š<br />
<span class="math display">\[
\begin{align}
NDF_{GGX}(n,h,\alpha)=\frac{\alpha^2}{\pi((n\cdot h)^2(\alpha^2-1)+1)^2}
\end{align} \tag{28}
\]</span>
å…¶ä¸­<code>Î±</code>æ˜¯ç²—ç³™åº¦ï¼Œ<code>n</code>æ˜¯å®è§‚è¡¨é¢æ³•çº¿ï¼Œ<code>h</code>æ˜¯åŠç¨‹å‘é‡ã€‚è¯¥å‡½æ•°<code>D(h)</code>æè¿°äº†åŠç¨‹å‘é‡<code>h</code>å’Œå¾®å¹³é¢æ³•çº¿çš„åˆ†å¸ƒå…³ç³»ï¼Œå…¶å–å€¼èŒƒå›´å¦‚ä¸‹ï¼š<br />
<span class="math display">\[
\begin{align}
0\leq D(h)\leq \infty
\end{align} \tag{29}
\]</span>
è¯¥å‡½æ•°æ˜¯ç”¨æ¥æ§åˆ¶<code>Specular</code>é«˜å…‰çš„å¤§å°ï¼Œäº®åº¦å’Œå½¢çŠ¶ï¼Œ<code>Î±</code>è¶Šå¤§ç²—ç³™åº¦è¶Šå¤§ï¼ŒåŠç¨‹å‘é‡<code>h</code>å’Œå¾®è¡¨é¢æ³•çº¿ä¸€è‡´çš„èŒƒå›´å˜å¤§ï¼Œä½†æ˜¯å…‰æ–‘å¼ºåº¦ä¼šå‡å¼±ï¼š<br />
<img src="/img/00014/image-38.png" srcset="/img/loading.gif" lazyload alt="43" /></p>
<h3 id="shadowing-masking-function">Shadowing Masking Function</h3>
<p><code>G</code>æ˜¯å‡ ä½•é¡¹ï¼Œè€Œ<code>G</code>é¡¹åŒ…å«äº†<code>Shadowing</code>å’Œ<code>Masking</code>ä¸¤é¡¹ï¼Œä¸ºäº†ç®€åŒ–æ“ä½œï¼Œæˆ‘ä»¬é€šå¸¸ç”¨<span
class="math inline">\(G_{Schlick\text{-}GGX}\)</span>æ¥è®¡ç®—è¿™ä¸¤é¡¹çš„å€¼ï¼š<br />
<span class="math display">\[
\begin{align}
G(n,v,l,k)=G_{Schlick\text{-}GGX}(n,v,k)G_{Schlick\text{-}GGX}(n,l,k)
\end{align} \tag{30}
\]</span>
<code>Schlick-GGX</code>å‡ ä½•å‡½æ•°æ˜¯<code>GGX</code>ä¸<code>Schlick-Beckmann</code>è¿‘ä¼¼çš„ç»“åˆä½“ï¼š<br />
<span class="math display">\[
\begin{align}
G_{Schlick\text{-}GGX}(n,v,k)=\frac{n\cdot v}{(n\cdot v)(1-k)+k}
\end{align} \tag{31}
\]</span>
å…¶ä¸­<code>n</code>æ˜¯å®è§‚è¡¨é¢æ³•çº¿ï¼Œ<code>v</code>æ˜¯å…¥å°„æ–¹å‘æˆ–è€…å‡ºå°„æ–¹å‘ï¼Œè€Œ<code>k</code>æ˜¯ç²—ç³™åº¦<code>Î±</code>çš„é‡æ˜ å°„å½¢å¼ï¼Œ<code>k</code>çš„è®¡ç®—å–å†³äºæˆ‘ä»¬é’ˆå¯¹ç›´æ¥å…‰ç…§è¿˜æ˜¯<code>IBL</code>å…‰ç…§ï¼š<br />
<span class="math display">\[
\begin{align}
k_{direct}=\frac{(\alpha+1)^2}{8} \\
k_{IBL}=\frac{\alpha^2}{2}
\end{align} \tag{32}
\]</span>
è¯¥å‡½æ•°æ˜¯ç”¨æ¥æè¿°ç”±äºå¾®è¡¨é¢è‡ªé®æŒ¡äº§ç”Ÿçš„å˜æš—ç°è±¡ã€‚å› ä¸ºå¾®è¡¨é¢çš„è‡ªé®æŒ¡ç°è±¡ï¼Œä»¥è‡³äºå¾—åˆ°çš„ç»“æœä¸å¦‚æˆ‘ä»¬è®¡ç®—å‡ºæ¥ç»“æœé‚£ä¹ˆäº®ã€‚<br />
<code>Shadowing</code>æ˜¯å…‰æ‰“åˆ°å¾®è¡¨é¢æ—¶ï¼Œç”±äºå¾®è¡¨é¢çš„è‡ªé®æŒ¡ç°è±¡è€Œå¯¼è‡´ä¸€éƒ¨åˆ†å¾®è¡¨é¢æœªèƒ½æ¥å—åˆ°å…‰ç…§ã€‚<br />
<code>Masking</code>åˆ™æ˜¯å…‰æ‰“åˆ°å¾®è¡¨é¢åï¼Œç”±äºå¾®è¡¨é¢çš„è‡ªé®æŒ¡ç°è±¡ä¸€éƒ¨åˆ†å…‰ç…§æ— æ³•åå°„åˆ°æˆ‘ä»¬çœ¼ç›é‡Œã€‚
<img src="/img/00014/image-39.png" srcset="/img/loading.gif" lazyload alt="44" /><br />
è¿™ä¸ªå‡½æ•°çš„å–å€¼èŒƒå›´å¦‚ä¸‹ï¼š<br />
<span class="math display">\[
\begin{align}
0\leq G(n,v,l,k)\leq 1
\end{align} \tag{33}
\]</span> æˆ‘åœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯<a
target="_blank" rel="noopener" href="https://pbr-book.org/3ed-2018/Reflection_Models/Microfacet_Models">PBRT</a>ä¸Šæä¾›çš„<code>G</code>é¡¹ï¼Œä¸è¿‡æˆ‘æ›´æ¨èç”¨<span
class="math inline">\(G_{Schlick\text{-}GGX}\)</span>æ¥è®¡ç®—<code>G</code>é¡¹çš„å€¼ï¼Œè®¡ç®—é‡å°ã€‚</p>
<h3 id="fresnel-term">Fresnel Term</h3>
<p>è²æ¶…å°”å‡½æ•°ä¼šæ ¹æ®æˆ‘ä»¬çœ‹å‘çš„è§’åº¦ä¸åŒï¼Œä»¥åŠç‰©ä½“çš„æŠ˜å°„ç‡ï¼Œå¾—å‡ºæ€»å…±åå°„çš„èƒ½é‡å æ¯”å¤šå¤§ï¼š<br />
<img src="/img/00014/image-40.png" srcset="/img/loading.gif" lazyload alt="45" /><br />
å¯¹äº<code>ç”µä»‹è´¨</code>ï¼Œæˆ‘ä»¬ä»¥å‚ç›´è¡¨é¢çš„æ–¹å‘å»çœ‹ï¼Œåå°„çš„èƒ½é‡å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œè€Œè¶Šæ˜¯ä»¥æ å°„è§’å»çœ‹å‘è¡¨é¢ï¼Œåå°„çš„èƒ½é‡å æ¯”å°±è¶Šå¤§ï¼š<br />
<img src="/img/00014/image-41.png" srcset="/img/loading.gif" lazyload alt="46" /><br />
å¯¹äº<code>å¯¼ä½“</code>æ¥è¯´ï¼Œå› ä¸ºå…¶åŸºç¡€åå°„ç‡å¾ˆå¤§ï¼Œå°±ç®—æ˜¯ä»¥å‚ç›´è¡¨é¢çš„æ–¹å‘å»çœ‹å®ƒï¼Œåå°„çš„èƒ½é‡å æ¯”ä¹Ÿå¾ˆå¤§ï¼š<br />
<img src="/img/00014/image-42.png" srcset="/img/loading.gif" lazyload alt="47" /><br />
è²æ¶…å°”å…¬å¼æœ¬èº«ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œå®ƒåˆ©ç”¨äº†<code>å…‰ä¼ è¾“ä»‹è´¨</code>çš„æŠ˜å°„ç‡è®¡ç®—å‡º<code>å¹³è¡ŒåæŒ¯å…‰</code>å’Œ<code>å‚ç›´åæŒ¯å…‰</code>ï¼Œç„¶åå–å„è‡ªå¹³æ–¹çš„<code>1/2</code>åŠ èµ·æ¥å¾—å‡º<code>Fresnel</code>å€¼ï¼Œè¿™ç§æ–¹å¼è®¡ç®—å‡ºçš„<code>Fresnel</code>å€¼å¾ˆæ­£ç¡®ï¼Œä½†æ˜¯è®¡ç®—é‡æœ‰ç‚¹å¤§ï¼š<br />
<img src="/img/00014/image-43.png" srcset="/img/loading.gif" lazyload alt="48" /><br />
æˆ‘åœ¨ä»£ç ä¸­æœ‰å®ç°è¿™æ ·ç®—<code>Fresnel</code>é¡¹çš„å‡½æ•°ï¼Œä½†æ˜¯è€ƒè™‘åˆ°è®¡ç®—é‡çš„é—®é¢˜ï¼Œæˆ‘è¿˜æ˜¯æ¢äº†ä¸€ä¸ªæ›´åŠ é€šç”¨ä¸”è®¡ç®—é‡æ›´å°çš„è®¡ç®—æ–¹æ³•ï¼š<br />
<img src="/img/00014/image-44.png" srcset="/img/loading.gif" lazyload alt="49" /><br />
å…¶ä¸­<code>R_0</code>æ˜¯ç‰©è´¨çš„åŸºç¡€åå°„ç‡ï¼Œç”µä»‹è´¨ä¼šå¾ˆå°ï¼ŒåŸºæœ¬ä¸Šå–å®ƒä»¬å¹³å‡å€¼<code>0.04</code>å°±è¡Œï¼Œè€Œé‡‘å±å¯¼ä½“ä¼šå¾ˆå¤§ï¼Œå·®å¼‚ä¹Ÿå¾ˆå¤§ï¼Œéœ€è¦å‡†ç¡®å®šä¹‰ï¼Œè¿˜å¯ä»¥é€šè¿‡<code>å…‰ä¼ è¾“ä»‹è´¨</code>æ¥è®¡ç®—<code>R_0</code>ã€‚<code>cosÎ¸</code>çš„ä¸¤ä¸ªå‚æ•°æ˜¯<code>æˆ‘ä»¬çœ‹å‘çš„æ–¹å‘</code>å’Œ<code>åŠç¨‹å‘é‡</code>ã€‚<br />
å…¶å–å€¼èŒƒå›´å¦‚ä¸‹ï¼š<br />
<span class="math display">\[
\begin{align}
0\leq F(v,h,ior,F_0)\leq 1
\end{align} \tag{34}
\]</span></p>
<h3 id="brdfæ•ˆæœå›¾">BRDFæ•ˆæœå›¾</h3>
<p>åœ¨è®¡ç®—é‡‡æ ·æ–¹å‘çš„<code>pdf</code>æ—¶éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦ç»¼åˆè€ƒè™‘æ¼«åå°„å’Œé•œé¢åå°„çš„<code>pdf</code>å€¼ï¼Œç„¶ååŠ èµ·æ¥ï¼Œè¿™æ˜¯ç”¨<code>Fresnel</code>é¡¹æ¥æ§åˆ¶çš„ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">double</span> D = <span class="hljs-built_in">NDF</span>(roughness, H, N);<br>Vector3f F = <span class="hljs-built_in">Fresnel_Schlick</span>(H, wo, ior);<br>pdf.pdfValue = (F.x * D * <span class="hljs-built_in">dotProduct</span>(H,N) / (<span class="hljs-number">4.0</span> * <span class="hljs-built_in">dotProduct</span>(H, pdf.reflectDir))) + (<span class="hljs-number">1</span> - F.x) * <span class="hljs-built_in">dotProduct</span>(pdf.reflectDir, N) / M_PI;<br></code></pre></td></tr></table></figure>
<code>4.0 * dotProduct(H, pdf.reflectDir)</code>è¿™ä¸ªåˆ†æ¯æ€ä¹ˆæ¥çš„å¯ä»¥çœ‹æˆ‘<a
href="https://howl144.github.io/2023/07/01/00018.%20Games202%20Hw4/#%E9%95%9C%E9%9D%A2%E5%8F%8D%E5%B0%84%E5%85%89%E7%85%A7%E7%9A%84%E9%A2%84%E8%AE%A1%E7%AE%97">è¿™ç¯‡æ–‡ç« </a>ã€‚<br />
ä½†æ˜¯è¿™é‡ŒæŒ‰ç†æ¥è¯´ï¼Œåº”è¯¥è¦è€ƒè™‘ä»¥æ¼«åå°„<code>cos weight PDF</code>ç”Ÿæˆé‡‡æ ·æ–¹å‘<code>wi</code>çš„æƒ…å†µï¼Œä½†æ˜¯æˆ‘æ²¡å†™è¿™éƒ¨åˆ†ï¼Œä¸è¿‡æ„Ÿè§‰æ•ˆæœå¥½åƒä¹ŸæŒºä¸é”™çš„å“ˆå“ˆï¼š<br />
<img src="/img/00014/image-45.png" srcset="/img/loading.gif" lazyload alt="50" /><br />
è¿™åªå…”å­å°±æ˜¯<code>BRDF</code>æè´¨æ¸²æŸ“å‡ºæ¥çš„ç»“æœï¼Œä»£ç å°±ä¸è´´äº†ï¼Œè¿™ç¯‡æ–‡ç« å®åœ¨å¤ªé•¿äº†ã€‚</p>
<h2 id="bsdf">BSDF</h2>
<p>å‰é¢è¯´äº†<code>BSDF</code>æ˜¯æœ‰<code>BRDF</code>å’Œ<code>BTDF</code>ç»„åˆè€Œæˆï¼š<br />
<img src="/img/00014/image-46.png" srcset="/img/loading.gif" lazyload alt="51" /><br />
<span class="math display">\[
\begin{align}
f_r(i,o,n)=\frac{F(i,h_r)G(i,o,h_r)D(h_r)}{4|i\cdot n||o\cdot n|}
\end{align} \tag{35}
\]</span> <span class="math display">\[
\begin{align}
f_t(i,o,n)=\frac{|i\cdot h_t||o\cdot h_t|}{|i\cdot n||o\cdot n|}
\frac{\eta_{o}^{2}(1-F(i,h_t))G(i,o,h_t)D(h_t)}{(\eta_i(i\cdot
h_t)+\eta_o(o\cdot h_t))^2}
\end{align} \tag{36}
\]</span>
<code>BRDF</code>è·Ÿä¸Šé¢<code>SpecularBRDF</code>å·®ä¸å¤šï¼Œè¿™é‡Œçš„æ ¡æ­£å› å­éœ€è¦å–ç»å¯¹å€¼ã€‚æˆ‘ä»¬ç°åœ¨ä¸»è¦çœ‹ä¸‹<code>BTDF</code>ï¼Œè¿™é‡Œçš„<code>T</code>æ˜¯é€å°„çš„æ„æ€ã€‚<br />
<code>i</code>ä¸ºè§†è§’æ–¹å‘ï¼Œ<code>o</code>ä¸ºé‡‡æ ·æ–¹å‘ï¼Œè¿™å’Œä¸Šé¢<code>BRDF</code>æ˜¯åç€æ¥çš„ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå› ä¸ºå›¾ä¾‹æ˜¯æ¥è‡ª<a
target="_blank" rel="noopener" href="https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.pdf">è®ºæ–‡</a>ï¼Œæˆ‘æ²¡æœ‰åšä¿®æ”¹ï¼š<br />
<img src="/img/00014/image-47.png" srcset="/img/loading.gif" lazyload alt="52" /><br />
å‘é‡<code>i</code>,<code>o</code>,<code>h_t</code>éƒ½æ˜¯å½’ä¸€åŒ–çš„å‘é‡ï¼Œ<code>h_t</code>æ˜¯è§†è§’æ–¹å‘å’Œé€å°„é‡‡æ ·æ–¹å‘çš„åŠç¨‹å‘é‡ï¼Œ<code>h_r</code>åˆ™æ˜¯è§†è§’æ–¹å‘å’Œåå°„é‡‡æ ·æ–¹å‘çš„åŠç¨‹å‘é‡ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; h_r=\text{normalize}(i+o) \\
&amp; h_t=\text{normalize}(-\eta_ii-\eta_oo)
\end{align} \tag{37}
\]</span> <span
class="math inline">\(\eta_i\)</span>æ˜¯å›¾ä¾‹ä¸­ä¸Šæ–¹å…‰ä¼ è¾“ä»‹è´¨çš„æŠ˜å°„ç‡ï¼Œå‡è®¾ä¸ºç©ºæ°”ï¼Œåˆ™<span
class="math inline">\(\eta_i\)</span>ä¸º<code>1.0</code>ã€‚<br />
<span
class="math inline">\(\eta_o\)</span>æ˜¯å›¾ä¾‹ä¸­ä¸‹æ–¹å…‰ä¼ è¾“ä»‹è´¨çš„æŠ˜å°„ç‡ï¼Œå‡è®¾ä¸ºç»ç’ƒï¼Œåˆ™<span
class="math inline">\(\eta_o\)</span>ä¸º<code>1.5</code>ã€‚<br />
å¦‚æœå…‰çº¿æ˜¯ä»ç»ç’ƒå†…éƒ¨é€ƒé€¸å‡ºæ¥ï¼Œåˆ™è¿™ä¸ªè¿‡ç¨‹æ˜¯ç›¸åçš„ã€‚</p>
<p>æ¥ç€çœ‹è¿™ä¸ª<span
class="math inline">\(\eta_o^2\text{d}w_o\)</span>æ€ä¹ˆæ¥çš„ï¼š<br />
å‡è®¾<span class="math inline">\(-\eta_oo\)</span>å¯¹åº”çš„ç«‹ä½“è§’ä¸º<span
class="math inline">\(c*\text{d}w_o\)</span>ï¼Œåˆ™æœ‰ä»¥ä¸‹ç­‰å¼ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; \frac{c*\text{d}w_o}{||-\eta_o*o||^2}=\text{d}w_o \\
&amp; c=\eta_o^2
\end{align} \tag{38}
\]</span> <code>pdf_h</code>è½¬æ¢åˆ°<code>pdf_o</code>çš„ç­‰å¼ä¸ºï¼š<br />
<span class="math display">\[
\begin{align}
p_{o}(\theta,\phi)=p_{h}(\theta,\phi)\cdot\lVert\frac{\partial
w_{h}}{\partial w_{o}}\rVert \\
\end{align} \tag{39}
\]</span> åé¢é‚£ä¸ªæ˜¯é›…å…‹æ¯”è¡Œåˆ—å¼ï¼Œå¦å¤–è®ºæ–‡è¯´è¿™ä¸ª<span
class="math inline">\(\vec
{h_t}\)</span>çš„å®šä¹‰å˜å¾—æ¨¡ç³Šäº†ï¼Œç›´æ¥ç»™å‡ºäº†è¿™ä¸ªè¡Œåˆ—å¼çš„å…¬å¼ï¼Œè¿™é‡Œå°±ä¸å†æ¨å¯¼äº†ï¼Œæˆ‘ä¹Ÿæ˜¯ç›´æ¥ç”¨çš„è¿™ä¸ªå…¬å¼ï¼š<br />
<span class="math display">\[
\begin{align}
\lVert\frac{\partial w_{h}}{\partial w_{o}}\rVert=
\frac{\eta_o^2|o\cdot h_t|}{||\vec {h_t}||^2}=
\frac{\eta_o^2|o\cdot h_t|}{(\eta_i(i\cdot h_t)+\eta_o(o\cdot h_t))^2}
\end{align} \tag{40}
\]</span>
æœ€åéœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œ<code>Fresnel_Schlick</code>å¤„ç†ä¸äº†å…‰çº¿ç”±ç»ç’ƒå‘ç©ºæ°”<code>Trace</code>çš„æƒ…å†µï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯å¾—é€šè¿‡æŠ˜å°„ç‡è®¡ç®—å‡º<code>å¹³è¡ŒåæŒ¯å…‰</code>å’Œ<code>å‚ç›´åæŒ¯å…‰</code>ï¼Œç„¶åå¾—å‡ºå‡†ç¡®çš„<code>Fresnel</code>é¡¹ï¼Œè¿™éƒ¨åˆ†ä»£ç å®ç°å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">double</span> G, D;<br>Vector3f F;<br>Vector3f h = pdf.halfVec;<br><span class="hljs-type">double</span> etai = <span class="hljs-number">1</span>, etao = ior;<span class="hljs-comment">//ç©ºæ°”é»˜è®¤ä¸º1</span><br><span class="hljs-keyword">if</span> (isOutside == <span class="hljs-literal">false</span>)<br>    std::<span class="hljs-built_in">swap</span>(etai, etao);<br>F = <span class="hljs-built_in">Fresnel</span>(-wo, h, isOutside);<br><span class="hljs-comment">//Trowbridgeâ€“Reitz GGxçš„å‡ ä½•é¡¹ </span><br>G = <span class="hljs-built_in">G1G2</span>(roughness, wo, wi, h);<br><span class="hljs-comment">//Trowbridgeâ€“Reitz GGxçš„æ³•çº¿åˆ†å¸ƒé¡¹</span><br>D = <span class="hljs-built_in">NDF</span>(roughness, h, N);<br><span class="hljs-keyword">if</span> (pdf.isReflect == <span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-comment">// brdf</span><br>    <span class="hljs-type">double</span> divisor = <span class="hljs-number">4</span> * std::<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">dotProduct</span>(N, wo)) * std::<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">dotProduct</span>(N, wi));<br>    <span class="hljs-keyword">if</span> (divisor &lt; EPSILON) <span class="hljs-keyword">return</span> &#123;&#125;;<br>    <span class="hljs-keyword">return</span> F * G * D / divisor;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// btdf</span><br>    <span class="hljs-type">double</span> prefixEntry = std::<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">dotProduct</span>(wo, h)) * std::<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">dotProduct</span>(wi, h)) / (std::<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">dotProduct</span>(wo, N)) * std::<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">dotProduct</span>(wi, N)));<br>    <span class="hljs-type">double</span> divisor1 = etai * <span class="hljs-built_in">dotProduct</span>(wo, h) + etao * <span class="hljs-built_in">dotProduct</span>(wi, h);<br>    <span class="hljs-type">double</span> divisor2 = divisor1 * divisor1;<br>    <span class="hljs-keyword">if</span> (divisor2 &lt; EPSILON) <span class="hljs-keyword">return</span> &#123;&#125;;<br>    <span class="hljs-keyword">return</span> (prefixEntry * etao * etao * (<span class="hljs-built_in">Vector3f</span>(<span class="hljs-number">1.0f</span>) - F) * G * D) / divisor2;<br>&#125;<br><span class="hljs-keyword">return</span> &#123;&#125;;<br></code></pre></td></tr></table></figure>
æˆ‘ä¹‹å‰æœ‰è¯•è¿‡è¿”å›<code>brdf+btdf</code>ï¼Œ<code>pdf</code>ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä½†æ˜¯ç»“æœå¹¶ä¸æ­£ç¡®ï¼Œæ¨¡å‹æœ€å¤–åœˆä¼šå‡ºç°ç™½è‰²çš„åœˆï¼Œç»è¿‡<code>debug</code>å‘ç°ç™½åœˆæ˜¯å› ä¸ºåœ¨æ å°„è§’ä¸‹<code>btdf</code>çš„<code>pdf</code>å°ï¼Œè€Œ<code>btdf</code>è¿‡å¤§å¯¼è‡´çš„ã€‚æ‰€ä»¥æˆ‘è®¤ä¸ºè¿™é‡Œå…¬å¼ä¸Šè™½ç„¶å†™çš„æ˜¯<code>brdf</code>+<code>btdf</code>ï¼Œä½†æ˜¯å®é™…å¤„ç†è¿˜æ˜¯å¾—åˆ†å¼€ã€‚åå°„çš„åŠç¨‹å‘é‡å…¶å®å’Œé€å°„çš„åŠç¨‹å‘é‡æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¡ç®—ä¸€æ¬¡å³å¯ã€‚</p>
<h3 id="bsdfæ•ˆæœå›¾">BSDFæ•ˆæœå›¾</h3>
<p><img src="/img/00014/image-48.png" srcset="/img/loading.gif" lazyload alt="53" /><br />
ä¸¤è¾¹æ˜¯<code>Roughness</code>ä¸º<code>0.08</code>çš„æƒ…å†µï¼Œä¸­é—´æ˜¯<code>0.28</code>ã€‚</p>
<h1 id="multiple-importance-sampling">Multiple Importance Sampling</h1>
<p>å¤šé‡é‡è¦æ€§é‡‡æ ·çš„ç›®çš„æ˜¯ç”¨æ¥é™ä½å™ªå£°çš„ï¼Œæˆ‘ä»¬çŸ¥é“æ¸²æŸ“æ–¹ç¨‹ç”±<code>Li</code>ï¼Œ<code>BRDF</code>ç»„æˆï¼Œè€Œå½“æˆ‘ä»¬è¿›è¡Œé‡‡æ ·æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å…¶ä¸­ä¸€ç§<code>pdf</code>ï¼Œå¹¶ç”¨è’™ç‰¹å¡æ´›ç§¯åˆ†æ±‚å‡ºç§¯åˆ†å€¼ã€‚ä½†æ˜¯ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦<code>BRDF</code>è¿›è¡Œé‡‡æ ·è€Œæœ‰æ—¶å€™åˆéœ€è¦ç›´æ¥å…‰é‡‡æ ·ï¼Œè¿™å°±æœ‰é—®é¢˜äº†ï¼Œçœ‹ä¸‹é¢ä¾‹å­(è¿™ä¸ªå¤šé‡é‡è¦æ€§çš„åœºæ™¯æ˜¯æˆ‘è‡ªå·±æ­å»ºçš„)ï¼š<br />
<code>16spp</code> <code>BRDF</code>é‡‡æ ·ï¼š<br />
<img src="/img/00014/brdf-sampling.png" srcset="/img/loading.gif" lazyload alt="54" /><br />
<code>16spp</code> ç›´æ¥å…‰é‡‡æ ·ï¼š<br />
<img src="./MIS-finalProject/directLight-sampling.png" srcset="/img/loading.gif" lazyload alt="55" /><br />
å¯ä»¥çœ‹åˆ°åªç”¨ç›´æ¥å…‰é‡‡æ ·ï¼Œæˆ–è€…åªç”¨<code>BRDF</code>é‡‡æ ·ï¼Œå…¶æ•ˆæœéƒ½ä¸è¡Œï¼Œä½†æ˜¯å®ƒä»¬å´åˆèƒ½äº’è¡¥ã€‚åœ¨å®Œå…¨é•œé¢çš„åœ°æ–¹ï¼Œç›´æ¥å…‰å¯¹å¤§é¢ç§¯å…‰æºçš„é‡‡æ ·æ•ˆæœéå¸¸å·®ï¼Œè€Œåœ¨æ¯”è¾ƒç²—ç³™çš„åœ°æ–¹<code>BRDF</code>å¯¹å°é¢ç§¯å…‰æºçš„é‡‡æ ·æ•ˆæœä¹Ÿä¸å¥½ã€‚è€Œç»“åˆå®ƒä»¬å°±å¯ä»¥å–é•¿è¡¥çŸ­ï¼Œ<code>MIS</code>æ­£æ˜¯è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œå®ƒå¯ä»¥ä½¿ç”¨å¤šç§é‡‡æ ·ç­–ç•¥ï¼Œç„¶åæ ¹æ®ä¸€å®šæƒé‡å°†å®ƒç»„åˆèµ·æ¥ï¼š<br />
å‡è®¾è¿™é‡Œæœ‰ä¸€ä¸ªç§¯åˆ†å½¢å¦‚<span class="math inline">\(\int
f(x)g(x)\text{d}x\)</span>æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢å…¬å¼ç®—å¾—è¯¥ç§¯åˆ†çš„å€¼ï¼š<br />
<span class="math display">\[
\begin{align}
\int
f(x)g(x)\text{d}x\approx\frac{1}{n_f}\sum_{i=1}^{n_f}\frac{f(X_i)g(X_i)w_f(X_i)}{p_f(X_i)}+
\frac{1}{n_g}\sum_{j=1}^{n_g}\frac{f(Y_j)g(Y_j)w_g(Y_j)}{p_g(Y_j)}
\end{align} \tag{41}
\]</span>
å…¶ä¸­<code>w_f</code>å’Œ<code>w_g</code>å°±æ˜¯æƒé‡å‡½æ•°ï¼Œç”±<code>Power Heuristic</code>å…¬å¼æ‰€å¾—ï¼š<br />
<span class="math display">\[
\begin{align}
w_s(x)=\frac{(n_sp_s(x))^\beta}{\sum_{i}(n_ip_i(x))^\beta}
\end{align} \tag{42}
\]</span>
å…¶ä¸­<code>n_s</code>ä¸º<code>p_s</code>é‡‡æ ·ç­–ç•¥çš„é‡‡æ ·æ¬¡æ•°ï¼Œ<code>n_i</code>ä¸º<code>p_i</code>é‡‡æ ·ç­–ç•¥çš„é‡‡æ ·æ¬¡æ•°ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä½¿ç”¨çš„è’™ç‰¹å¡æ´›ç§¯åˆ†éƒ½æ˜¯é‡‡æ ·ä¸€æ¬¡ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ˜¯<code>1</code>ã€‚è€Œ<code>p(x)</code>ä¸ºå„è‡ªé‡‡æ ·ç­–ç•¥çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ã€‚<code>Î²</code>ç¡¬ç¼–ç ä¸º<code>2</code>å³å¯ï¼ˆæ›´å¤šå†…å®¹è¯·å‚è€ƒ<a
target="_blank" rel="noopener" href="https://pbr-book.org/3ed-2018/Monte_Carlo_Integration/Importance_Sampling">pbrt</a>ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">PowerHeuristic</span><span class="hljs-params">(<span class="hljs-type">double</span> nf, <span class="hljs-type">double</span> fPdf, <span class="hljs-type">double</span> ng, <span class="hljs-type">double</span> gPdf)</span> <span class="hljs-type">const</span> </span>&#123;<br>    <span class="hljs-type">double</span> f = nf * fPdf, g = ng * gPdf;<br>    <span class="hljs-keyword">return</span> (f * f) / (f * f + g * g);<br>&#125;<br><span class="hljs-function">Vector3f <span class="hljs-title">Scene::mis_directLight</span><span class="hljs-params">(Intersection intersection,Vector3f wo,Intersection L_dir_Inter,<span class="hljs-type">double</span> pdf_light, <span class="hljs-type">int</span> depth)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">Vector3f <span class="hljs-title">Le</span><span class="hljs-params">(<span class="hljs-number">0.0</span>)</span></span>;<br>    MaterialType interType = intersection.m-&gt;<span class="hljs-built_in">getType</span>();<br><br>    <span class="hljs-comment">//1. ç›´æ¥å¯¹å…‰æºé‡‡æ ·</span><br>    <span class="hljs-comment">//èµ·å§‹ç‚¹</span><br>    Vector3f p = intersection.coords;<br>    <span class="hljs-comment">//å…‰æºä½ç½®ç‚¹</span><br>    Vector3f x = L_dir_Inter.coords;<br>    <span class="hljs-comment">//å…‰æºæ–¹å‘ï¼Œç›´æ¥å…‰çš„å…¥å°„æ–¹å‘</span><br>    Vector3f w_Li = (x - p).<span class="hljs-built_in">normalized</span>();<br>    <span class="hljs-function">Ray <span class="hljs-title">p_2_light_ray</span><span class="hljs-params">(p, w_Li)</span></span>;<br>    ...<br>    Intersection p_2_light_inter = <span class="hljs-built_in">intersect</span>(p_2_light_ray);<br>    <span class="hljs-comment">//å‡»ä¸­çš„æ˜¯å…‰æº ä¸” èµ·å§‹ç‚¹çš„æè´¨ä¸æ˜¯é•œé¢æˆ–è€…é€æ˜ã€‚</span><br>    <span class="hljs-keyword">if</span> (p_2_light_inter.happened &amp;&amp; p_2_light_inter.m-&gt;<span class="hljs-built_in">hasEmission</span>() &amp;&amp; interType != MIRROR &amp;&amp; interType != TRANSPARENT)<br>    &#123;<br>        Pdf pdf;<br>        pdf.halfVec = <span class="hljs-built_in">normalize</span>(wo + w_Li);<br>        <span class="hljs-type">double</span> light_solidAngle_pdf = pdf_light;<br>        intersection.m-&gt;<span class="hljs-built_in">mis_getpdf</span>(interType, intersection.normal,wo, w_Li,pdf);<br>        <span class="hljs-type">double</span> brdf_solidAngle_pdf = pdf.pdfValue;<br>        Vector3f f_r = intersection.m-&gt;<span class="hljs-built_in">eval</span>(wo, w_Li, intersection.normal, intersection.isOutside, pdf);<br>        <span class="hljs-type">double</span> weight = <span class="hljs-built_in">PowerHeuristic</span>(<span class="hljs-number">1.0</span>, light_solidAngle_pdf, <span class="hljs-number">1.0</span>, brdf_solidAngle_pdf);<br>        ...<br>        Le = L_dir_Inter.emit * f_r * std::<span class="hljs-built_in">fmax</span>(<span class="hljs-built_in">dotProduct</span>(w_Li, intersection.normal),<span class="hljs-number">0.0</span>) / light_solidAngle_pdf * weight;<br>    &#125;<br>    <span class="hljs-comment">//2.brdfå¯¹å…‰æºé‡‡æ ·</span><br>    Pdf pdf;<br>    Vector3f wi = (intersection.m-&gt;<span class="hljs-built_in">sample</span>(wo, intersection.normal, intersection.isOutside, pdf)).<span class="hljs-built_in">normalized</span>();<br>    ...<br>    Vector3f bxdf = intersection.m-&gt;<span class="hljs-built_in">eval</span>(wo, wi, intersection.normal, intersection.isOutside, pdf);<br>    Ray L_brdf_Ray = <span class="hljs-built_in">Ray</span>(p, wi);<br>    ...<br>    Intersection L_brdf_Inter = <span class="hljs-built_in">intersect</span>(L_brdf_Ray);<br>    <span class="hljs-comment">//å‡»ä¸­çš„æ˜¯å…‰æº ä¸” èµ·å§‹ç‚¹çš„æè´¨ä¸æ˜¯é•œé¢æˆ–è€…é€æ˜ã€‚</span><br>    <span class="hljs-keyword">if</span> (L_brdf_Inter.happened &amp;&amp; L_brdf_Inter.m-&gt;<span class="hljs-built_in">hasEmission</span>() &amp;&amp; interType != MIRROR &amp;&amp; interType != TRANSPARENT)<br>    &#123;<br>        <span class="hljs-comment">//èµ·å§‹ç‚¹</span><br>        Vector3f newP = intersection.coords;<br>        <span class="hljs-comment">//å…‰æºä½ç½®ç‚¹</span><br>        Vector3f newX = L_brdf_Inter.coords;<br>        <span class="hljs-type">double</span> lightDistance = (newX - newP).<span class="hljs-built_in">norm</span>();<br>        <span class="hljs-type">double</span> lightDistance2 = lightDistance * lightDistance;<br>        <span class="hljs-type">double</span> newPdf_light = <span class="hljs-number">0.0</span>;<br>        <span class="hljs-comment">//é¢å…‰æº</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">dynamic_cast</span>&lt;Sphere*&gt;(L_brdf_Inter.obj) == <span class="hljs-literal">nullptr</span>) &#123;<br>            <span class="hljs-comment">//é¢å…‰æºæ˜¯ä¸¤ä¸ªä¸‰è§’å½¢ç»„æˆ * 2</span><br>            newPdf_light = lightDistance2 / L_brdf_Inter.obj-&gt;<span class="hljs-built_in">getArea</span>() * <span class="hljs-number">2</span> * std::<span class="hljs-built_in">fmax</span>(<span class="hljs-built_in">dotProduct</span>(-wi, L_brdf_Inter.normal), <span class="hljs-number">0.0</span>);<br>        &#125;<br>        <span class="hljs-comment">//çƒå…‰æº</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            Intersection tmp;<br>            tmp.tcoords = intersection.coords;<br>            <span class="hljs-comment">//åªç”¨æ‹¿åˆ°pdfå°±è¡Œ</span><br>            L_brdf_Inter.obj-&gt;<span class="hljs-built_in">Sample</span>(tmp, newPdf_light);<br>        &#125;<br>        <span class="hljs-type">double</span> light_solidAngle_pdf = newPdf_light;<br>        <span class="hljs-type">double</span> brdf_solidAngle_pdf = pdf.pdfValue;<br>        <br>        <span class="hljs-type">double</span> weight = <span class="hljs-built_in">PowerHeuristic</span>(<span class="hljs-number">1.0</span>, brdf_solidAngle_pdf, <span class="hljs-number">1.0</span>, light_solidAngle_pdf);<br>        Le += L_brdf_Inter.m-&gt;<span class="hljs-built_in">getEmission</span>() * bxdf * std::<span class="hljs-built_in">fmax</span>(<span class="hljs-built_in">dotProduct</span>(wi, intersection.normal), <span class="hljs-number">0.0</span>) / brdf_solidAngle_pdf * weight;<br>    &#125;<br>    <span class="hljs-comment">//é•œé¢å’Œé€æ˜ç‰©è´¨å•ç‹¬å¤„ç†ï¼Œè¿™æ˜¯ç›´æ¥å…‰ã€‚</span><br>    ...<br>    <span class="hljs-keyword">return</span> Le;<br>&#125;<br></code></pre></td></tr></table></figure> MIS-16sppæ•ˆæœå¦‚ä¸‹ï¼š<br />
<img src="/img/00014/Multiple-Importance-Sampling.png" srcset="/img/loading.gif" lazyload alt="56" /><br />
## Sampling a Sphere Object
å¦å¤–å› ä¸ºå…‰æºæ˜¯ä¸ªçƒï¼Œæˆ‘ä»¬éœ€è¦å¯¹çƒè¿›è¡Œé‡‡æ ·ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹ï¼ˆä¸‹é¢éƒ¨åˆ†å†…å®¹æ¥æºäº<a
target="_blank" rel="noopener" href="https://raytracing.github.io/books/RayTracingTheRestOfYourLife.html#samplingasphereobject">RayTracingTheRestOfYourLife</a>ï¼‰ï¼š<br />
<img src="/img/00014/image-49.png" srcset="/img/loading.gif" lazyload alt="57" /><br />
å¯¹äºä¸€ä¸ªç€è‰²ç‚¹<code>P</code>ï¼Œæˆ‘ä»¬è¦åœ¨æ­£å¯¹ç€å®ƒçš„çƒå…‰æºä¸Šå‡åŒ€çš„å–ä¸€ä¸ªé‡‡æ ·ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ä»¥ä¸‹ç­‰å¼ï¼š<br />
<span class="math display">\[
\begin{align}
1=\int_{0}^{2\pi}\int_{0}^{\theta_{max}}f(\theta)\sin\theta\text{d}\theta\text{d}\phi
\end{align} \tag{43}
\]</span>
å› ä¸ºæ˜¯å‡åŒ€é‡‡æ ·ï¼Œè¿™é‡Œ<code>f(Î¸)</code>å…¶å®æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œæˆ‘ä»¬å°šä¸”å°†å…¶è®¾ä¸º<code>C</code>ï¼Œç„¶ååˆ†åˆ«æ±‚å…¶è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; p(\theta)=\int_{0}^{2\pi}C\sin\theta\text{d}\phi \\
&amp; p(\theta)=C2\pi\sin\theta \\
&amp; p(\phi)=\int_{0}^{\theta_{max}}C\sin\theta\text{d}\theta \\
&amp; p(\phi)=C(1-\cos\theta_{max})
\end{align} \tag{44}
\]</span> å†åˆ†åˆ«æ±‚å…¶ç´¯ç§¯åˆ†å¸ƒå‡½æ•°ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; P(\theta)=\int_{0}^{\theta}C2\pi\sin\theta\text{d}\theta \\
&amp; P(\theta)=C2\pi(1-\cos\theta) \\
&amp; P(\phi)=\int_{0}^{\phi}C(1-\cos\theta_{max})\text{d}\phi \\
&amp; P(\phi)=\phi*C(1-\cos\theta_{max})
\end{align} \tag{45}
\]</span>
æ ¹æ®<code>CDF</code>çš„æ€§è´¨ï¼Œåœ¨<code>Î¸</code>ç­‰äº<code>Î¸_max</code>æ—¶ï¼Œæœ‰ä»¥ä¸‹ç­‰å¼ï¼š<br />
<span class="math display">\[
\begin{align}
&amp; 1=\int_{0}^{\theta_{max}}C2\pi\sin\theta\text{d}\theta \\
&amp; 1=C2\pi(1-\cos\theta_{max}) \\
&amp; C=\frac{1}{2\pi(1-\cos\theta_{max})}
\end{align} \tag{46}
\]</span> ç”±å›¾<code>57</code>å¯çŸ¥ï¼Œ<span
class="math inline">\(\sin(\theta_{max})\)</span>ä¸ºï¼š<br />
<span class="math display">\[
\begin{align}
&amp; \sin(\theta_{max})=\frac{R}{\text{length}(c-p)} \\
&amp; \cos(\theta_{max})=\sqrt{1-\frac{R^2}{\text{length}^2(c-p)}}
\end{align} \tag{47}
\]</span> åˆ™ï¼š<br />
<span class="math display">\[
\begin{align}
&amp;
P(\theta)=\frac{1-cos\theta}{1-\sqrt{1-\frac{R^2}{\text{length}^2(c-p)}}}
\\
&amp; P(\phi)=\frac{\phi}{2\pi}
\end{align} \tag{48}
\]</span>
æˆ‘ä»¬å‡åŒ€çš„ä»<code>U[0,1]</code>ä¸­å–å‡ºä¸¤ä¸ªéšæœºæ•°<code>X_1</code>ï¼Œ<code>X_2</code>åˆ™æˆ‘ä»¬è¦çš„é‡‡æ ·æ–¹å‘<code>Î¸</code>å’Œ<code>Ï†</code>ä¸ºï¼š<br />
<span class="math display">\[
\begin{align}
&amp; \cos\theta=1+X_1(\cos(\theta_{max})-1) \\
&amp; \phi=2\pi X_2 \\
&amp; z=\cos\theta=1+X_1(\cos(\theta_{max})-1) \\
&amp; x=\cos\phi\sin\theta=\cos(2\pi*X_2)*\sqrt{1-\cos^2\theta} \\
&amp; y=\sin\phi\sin\theta=sin(2\pi*X_2)*\sqrt{1-\cos^2\theta}
\end{align} \tag{49}
\]</span> æˆ‘ä»¬ç°åœ¨æ¥æ±‚çƒå…‰æºæŠ•å½±åˆ°ç€è‰²ç‚¹<code>P</code>çš„ç«‹ä½“è§’ï¼š<br />
<span class="math display">\[
\begin{align}
&amp;
\text{solid-angle}=\int_{0}^{2\pi}\int_{0}^{\theta_{max}}\sin\theta\text{d}\theta\text{d}\phi
\\
&amp; \text{solid-angle}=2\pi*(1-\cos(\theta_{max}))
\end{align} \tag{50}
\]</span> åˆ™<code>pdf</code>ä¸º<span
class="math inline">\(\frac{1}{solid-angle}\)</span>ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Sample</span><span class="hljs-params">(Intersection &amp;pos, <span class="hljs-type">double</span> &amp;pdf)</span></span>&#123;<br>    <span class="hljs-comment">//å¯¹çƒè¿›è¡Œé‡‡æ ·</span><br>    <span class="hljs-type">double</span> cos_theta_max = <span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1</span>- radius2/(center - pos.tcoords).<span class="hljs-built_in">norm</span>());<br><br>    <span class="hljs-type">double</span> phi = <span class="hljs-number">2.0</span> * M_PI * <span class="hljs-built_in">get_random_double</span>();<br><br>    <span class="hljs-type">double</span> z = <span class="hljs-number">1</span> + <span class="hljs-built_in">get_random_double</span>() * (cos_theta_max - <span class="hljs-number">1</span>);<br><br>    <span class="hljs-function">Vector3f <span class="hljs-title">dir</span><span class="hljs-params">(sqrt(<span class="hljs-number">1</span> - z * z) * std::cos(phi), sqrt(<span class="hljs-number">1</span> - z * z) * std::sin(phi), z)</span></span>;<br>    dir = <span class="hljs-built_in">toWorld</span>(dir, <span class="hljs-built_in">normalize</span>(pos.tcoords - center));<br>    pos.coords = center + radius * dir;<br>    pos.normal = dir;<br>    pos.emit = m-&gt;<span class="hljs-built_in">getEmission</span>();<br><br>    <span class="hljs-type">double</span> solid_angle = <span class="hljs-number">2</span> * M_PI * (<span class="hljs-number">1</span> - cos_theta_max);<br>    pdf = <span class="hljs-number">1.0</span> / solid_angle;<br>&#125;<br></code></pre></td></tr></table></figure></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Games101/" class="category-chain-item">Games101</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Games101 Final Project</div>
      <div>https://howl144.github.io/2023/09/30/00014. Games101 FinalProject/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Deng Ye</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>September 30, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/07/21/00019.%20Games202%20Hw5/" title="Games202 Hw5 JBF and SVGF">
                        <span class="hidden-mobile">Games202 Hw5 JBF and SVGF</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        Views: 
        <span id="leancloud-site-pv"></span>
        
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        Visitors: 
        <span id="leancloud-site-uv"></span>
        
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
