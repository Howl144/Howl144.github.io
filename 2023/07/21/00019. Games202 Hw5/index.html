

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="elv6HP48K6bVVMeBdbFYkmoi4IBF6JVtH0WaCgUXRNY" />
  <link rel="apple-touch-icon" sizes="76x76" href="/img/rose.png">
  <link rel="icon" href="/img/rose.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Deng Ye">
  <meta name="keywords" content="">
  
    <meta name="description" content="æœ€ç»ˆæ•ˆæœå›¾ä¸ºäº†é™ä½å›¾ç‰‡å­˜å‚¨ç©ºé—´ï¼Œåªèƒ½æ§åˆ¶ä¸€ä¸‹FPSä»¥åŠåˆ†è¾¨ç‡äº†ï¼Œçœ‹èµ·æ¥åƒpptåˆ«ä»‹æ„ğŸ‘€ã€‚ Pinkroom-SVGFPinkroom-JBF-Atrous   ä½œä¸šè¦æ±‚æ€»è§ˆ å®ç°å•å¸§é™å™ªã€‚   å®ç°ä¸¤å¸§é—´çš„æŠ•å½±ã€‚   å®ç°ä¸¤å¸§é—´çš„ç´¯ç§¯ã€‚   Bouns 1ï¼šå®ç°A-Trous WaveletåŠ é€Ÿå•å¸§é™å™ªã€‚  æºç æš‚æœªå…¬å¼€   å‰è¨€å…³äºä½œä¸šçš„æ„å»ºä»¥åŠå®Œæ•´è¿è¡Œæµç¨‹æœ¬æ–‡ä¸åšå¤ªå¤šä»‹ç»ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºè¯¥éƒ¨">
<meta property="og:type" content="article">
<meta property="og:title" content="Games202 Hw5 JBF and SVGF">
<meta property="og:url" content="https://howl144.github.io/2023/07/21/00019.%20Games202%20Hw5/index.html">
<meta property="og:site_name" content="ğŸ¥°Howl&#39;s Blog">
<meta property="og:description" content="æœ€ç»ˆæ•ˆæœå›¾ä¸ºäº†é™ä½å›¾ç‰‡å­˜å‚¨ç©ºé—´ï¼Œåªèƒ½æ§åˆ¶ä¸€ä¸‹FPSä»¥åŠåˆ†è¾¨ç‡äº†ï¼Œçœ‹èµ·æ¥åƒpptåˆ«ä»‹æ„ğŸ‘€ã€‚ Pinkroom-SVGFPinkroom-JBF-Atrous   ä½œä¸šè¦æ±‚æ€»è§ˆ å®ç°å•å¸§é™å™ªã€‚   å®ç°ä¸¤å¸§é—´çš„æŠ•å½±ã€‚   å®ç°ä¸¤å¸§é—´çš„ç´¯ç§¯ã€‚   Bouns 1ï¼šå®ç°A-Trous WaveletåŠ é€Ÿå•å¸§é™å™ªã€‚  æºç æš‚æœªå…¬å¼€   å‰è¨€å…³äºä½œä¸šçš„æ„å»ºä»¥åŠå®Œæ•´è¿è¡Œæµç¨‹æœ¬æ–‡ä¸åšå¤ªå¤šä»‹ç»ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºè¯¥éƒ¨">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://howl144.github.io/img/00019/pinkroom-svgf.gif">
<meta property="article:published_time" content="2023-07-21T00:43:59.000Z">
<meta property="article:modified_time" content="2023-08-11T09:57:44.785Z">
<meta property="article:author" content="Deng Ye">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://howl144.github.io/img/00019/pinkroom-svgf.gif">
  
  
  
  <title>Games202 Hw5 JBF and SVGF - ğŸ¥°Howl&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"howl144.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"MY3hK2j6KKqPNCHItX2Yargj-gzGzoHsz","app_key":"U0dZRBpPFA46kRmFcsltQFF2","server_url":"https://my3hk2j6.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Howl&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Portfolio/">
                <i class="iconfont icon-pen"></i>
                <span>Portfolio</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Category</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archive</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About Me</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/post.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.5)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Games202 Hw5 JBF and SVGF"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-07-21 08:43" pubdate>
          July 21, 2023 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          189 mins
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Games202 Hw5 JBF and SVGF</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="æœ€ç»ˆæ•ˆæœå›¾"><a href="#æœ€ç»ˆæ•ˆæœå›¾" class="headerlink" title="æœ€ç»ˆæ•ˆæœå›¾"></a>æœ€ç»ˆæ•ˆæœå›¾</h1><p>ä¸ºäº†é™ä½å›¾ç‰‡å­˜å‚¨ç©ºé—´ï¼Œåªèƒ½æ§åˆ¶ä¸€ä¸‹FPSä»¥åŠåˆ†è¾¨ç‡äº†ï¼Œçœ‹èµ·æ¥åƒpptåˆ«ä»‹æ„ğŸ‘€ã€‚</p>
<p>Pinkroom-SVGF<br><img src="/img/00019/pinkroom-svgf.gif" srcset="/img/loading.gif" lazyload alt="1"><br>Pinkroom-JBF-Atrous<br><img src="/img/00019/pinkroom-JBF-atrous.gif" srcset="/img/loading.gif" lazyload alt="2">  </p>
<h1 id="ä½œä¸šè¦æ±‚æ€»è§ˆ"><a href="#ä½œä¸šè¦æ±‚æ€»è§ˆ" class="headerlink" title="ä½œä¸šè¦æ±‚æ€»è§ˆ"></a>ä½œä¸šè¦æ±‚æ€»è§ˆ</h1><ol>
<li>å®ç°å•å¸§é™å™ªã€‚  </li>
<li>å®ç°ä¸¤å¸§é—´çš„æŠ•å½±ã€‚  </li>
<li>å®ç°ä¸¤å¸§é—´çš„ç´¯ç§¯ã€‚  </li>
<li>Bouns 1ï¼šå®ç°A-Trous WaveletåŠ é€Ÿå•å¸§é™å™ªã€‚</li>
</ol>
<h1 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h1><p>æš‚æœªå…¬å¼€  </p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å…³äºä½œä¸šçš„æ„å»ºä»¥åŠå®Œæ•´è¿è¡Œæµç¨‹æœ¬æ–‡ä¸åšå¤ªå¤šä»‹ç»ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºè¯¥éƒ¨åˆ†å†…å®¹çš„æ•™ç¨‹ï¼Œé‡ç‚¹æ”¾åœ¨ç®—æ³•æœ¬èº«ã€‚</p>
<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>æœ¬æ¬¡ä½œä¸šæ¡†æ¶æä¾›äº†<code>exræ–‡ä»¶</code>çš„è¯»å†™æ“ä½œï¼ˆexrçš„å†…å®¹å°±æ˜¯1Sppçš„path tracingå¾—åˆ°çš„ç»“æœï¼‰ï¼Œæˆ‘ä»¬éœ€è¦çš„æ•°æ®ä¹Ÿé€šè¿‡<code>FrameInfo</code>å°è£…å¥½äº†ï¼Œéœ€è¦å®Œæˆçš„åœ°æ–¹å°±æ˜¯<code>denoiserç±»</code>çš„æˆå‘˜å‡½æ•°ã€‚</p>
<p>å…³äº<code>è¯»å–exr</code>éœ€è¦çš„æ³¨æ„çš„åœ°æ–¹å°±æ˜¯,<code>width</code>å’Œ<code>height</code>è®°å¾—å°†å…¶åˆå§‹åŒ–ä¸€ä¸‹ï¼Œå¦åˆ™<code>exræ–‡ä»¶</code>è¯»å–é”™è¯¯æ—¶ï¼Œå†…å­˜ä¼šç›´æ¥æ’‘çˆ†ï¼Œå¡çš„è¦æ­»ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Buffer2D&lt;Float3&gt; <span class="hljs-title">ReadFloat3Image</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;filename)</span> </span>&#123;<br>    <span class="hljs-type">int</span> width = <span class="hljs-number">0</span>, height = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">float</span> *_buffer = <span class="hljs-built_in">ReadImage</span>(filename, width, height, <span class="hljs-number">3</span>);<br>    ...<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">float</span> *<span class="hljs-title">ReadImage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;filename, <span class="hljs-type">int</span> &amp;width, <span class="hljs-type">int</span> &amp;height,</span></span><br><span class="hljs-params"><span class="hljs-function">                 <span class="hljs-type">const</span> <span class="hljs-type">int</span> &amp;channel)</span> </span>&#123;<br>    ...<br>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">LoadEXR</span>(&amp;out, &amp;width, &amp;height, filename.<span class="hljs-built_in">c_str</span>(), &amp;err);<br>    <span class="hljs-comment">//ä¸åˆå§‹åŒ–ï¼Œè¯»å–å¤±è´¥åwidth * heightå¾—åˆ°çš„å€¼å·¨å¤§æ— æ¯”ã€‚</span><br>    <span class="hljs-type">float</span> *buffer = <span class="hljs-keyword">new</span> <span class="hljs-type">float</span>[width * height * channel];<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ç„¶åå°±æ˜¯<code>debug</code>éƒ¨åˆ†åœ¨è¿™é‡ŒåŠ ä¸Šæ–­ç‚¹ï¼Œå¯ä»¥è®©ä½ åœ¨è°ƒè¯•æ—¶å€™é€šè¿‡<strong>å †æ ˆ</strong>å¿«é€Ÿå®šä½é—®é¢˜åœ°æ–¹ã€‚å¦åˆ™æŠ¥é”™åªæœ‰ç®€çŸ­çš„æŠ¥é”™ä¿¡æ¯ï¼Œå‹æ ¹ä¸çŸ¥é“æ˜¯å“ªé”™äº†ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> T&gt;<br><span class="hljs-keyword">inline</span> T &amp;Buffer2D&lt;T&gt;::<span class="hljs-built_in">operator</span>()(<span class="hljs-type">const</span> <span class="hljs-type">int</span> &amp;x, <span class="hljs-type">const</span> <span class="hljs-type">int</span> &amp;y) &#123;<br>    <span class="hljs-keyword">if</span> (!(<span class="hljs-number">0</span> &lt;= x &amp;&amp; x &lt; m_width &amp;&amp; <span class="hljs-number">0</span> &lt;= y &amp;&amp; y &lt; m_height))<br>        <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="å®ç°-JBF-A-Trous-Wavelet"><a href="#å®ç°-JBF-A-Trous-Wavelet" class="headerlink" title="å®ç° JBF A-Trous Wavelet"></a>å®ç° JBF A-Trous Wavelet</h1><h2 id="é«˜æ–¯æ»¤æ³¢"><a href="#é«˜æ–¯æ»¤æ³¢" class="headerlink" title="é«˜æ–¯æ»¤æ³¢"></a>é«˜æ–¯æ»¤æ³¢</h2><p>å…ˆä»‹ç»ä¸€ä¸‹é«˜æ–¯æ»¤æ³¢åœ¨å›¾å½¢å­¦çš„åº”ç”¨åé¢ä¼šç”¨åˆ°<br>äºŒç»´é«˜æ–¯å‡½æ•°çš„å®šä¹‰ä¸ºï¼š<br>$$<br>f(x,y) &#x3D; \dfrac{1}{2\pi\sigma^{2}}e^{-\dfrac{x^{2}+y^{2}}{2\sigma^{2}}}<br>$$</p>
<p><code>x,y</code> ï¼šæ˜¯åç§»å€¼ï¼Œ$r^2 &#x3D; x^2 + y^2$å¯ä»¥çœ‹åšè·ç¦»å¹³æ–¹<br><code>Ïƒ</code> ï¼šæ˜¯æ­£æ€åˆ†å¸ƒçš„æ ‡å‡†åå·®ï¼Œå¯ä»¥å†³å®šå‡½æ•°çš„èƒ–ç˜¦ã€‚  </p>
<p>åœ¨äºŒç»´ç©ºé—´ä¸­ï¼Œè¿™ä¸ªå…¬å¼ç”Ÿæˆçš„æ›²é¢çš„ç­‰é«˜çº¿æ˜¯ä»ä¸­å¿ƒå¼€å§‹å‘ˆæ­£æ€åˆ†å¸ƒçš„åŒå¿ƒåœ†ã€‚åˆ†å¸ƒä¸ä¸ºé›¶çš„åƒç´ ç»„æˆçš„å·ç§¯çŸ©é˜µä¸åŸå§‹å›¾åƒåšå˜æ¢ã€‚æ¯ä¸ªåƒç´ çš„å€¼éƒ½æ˜¯å‘¨å›´ç›¸é‚»åƒç´ å€¼çš„åŠ æƒå¹³å‡ã€‚åŸå§‹åƒç´ çš„å€¼æœ‰æœ€å¤§çš„é«˜æ–¯åˆ†å¸ƒå€¼ï¼Œæ‰€ä»¥æœ‰æœ€å¤§çš„æƒé‡ï¼Œç›¸é‚»åƒç´ éšç€è·ç¦»åŸå§‹åƒç´ è¶Šæ¥è¶Šè¿œï¼Œå…¶æƒé‡ä¹Ÿè¶Šæ¥è¶Šå°ã€‚  </p>
<p>ä¸€ä¸ª<code>3 * 3</code>é«˜æ–¯æ ¸çš„åç§»å›¾ï¼š<br>$$<br>\begin{bmatrix}<br>-1,1 &amp; 0,1 &amp; 1,1 \<br>-1,0 &amp; 0,0 &amp; 1,0 \<br>-1,-1 &amp; 0,-1 &amp; 1,-1<br>\end{bmatrix}<br>$$</p>
<p>å‡å®š$\sigma &#x3D; 0.8$ï¼Œæ ¹æ®åç§»å€¼å’Œé«˜æ–¯å‡½æ•°å¯ä»¥å¾—åˆ°ä¸€ä¸ª<code>3 * 3</code>é«˜æ–¯æ ¸ï¼š<br>$$<br>\begin{bmatrix}<br>0.05212 &amp; 0.1138 &amp; 0.05212 \<br>0.1138 &amp; 0.2486 &amp; 0.1138 \<br>0.05212 &amp; 0.1138 &amp; 0.05212<br>\end{bmatrix}<br>$$<br>ç”±äºé«˜æ–¯æ ¸çš„å¤§å°ä¸èƒ½æ— é™å¤§ï¼Œæ‰€ä»¥è¯¥ä¸Šé¢ç”Ÿæˆçš„é«˜æ–¯æ ¸æƒé‡åŠ èµ·æ¥å¤§çº¦åªæœ‰<code>0.91</code>å·¦å³ã€‚åœ¨æ¬¡ä¹‹å‰éœ€è¦é™¤ä»¥å·¦ä¸Šè§’çš„å€¼ä½¿æœ€å°å€¼ä¸º<code>1</code>ï¼Œç„¶åå–æ•´ï¼Œæœ€åè¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œä½¿<code>3 * 3</code>çš„é«˜æ–¯æ ¸æ€»æƒé‡ä¸º<code>1</code>ï¼Œå¾—åˆ°ä¸€ä¸ªç±»é«˜æ–¯çš„æ»¤æ³¢æ ¸ã€‚ä¸‹é¢æ˜¯å½’ä¸€åŒ–çš„é«˜æ–¯æ ¸ï¼š<br>$$<br>\begin{bmatrix}<br>\dfrac{1}{16} &amp; \dfrac{1}{8} &amp; \dfrac{1}{16} \ \<br>\dfrac{1}{8} &amp; \dfrac{1}{4} &amp; \dfrac{1}{8} \ \<br>\dfrac{1}{16} &amp; \dfrac{1}{8} &amp; \dfrac{1}{16}<br>\end{bmatrix}<br>$$</p>
<h2 id="è”åˆåŒè¾¹æ»¤æ³¢"><a href="#è”åˆåŒè¾¹æ»¤æ³¢" class="headerlink" title="è”åˆåŒè¾¹æ»¤æ³¢"></a>è”åˆåŒè¾¹æ»¤æ³¢</h2><p>æƒé‡æ€»å’Œä¸º<code>1</code>æˆ–ä¸ä¸º<code>1</code>çš„æ»¤æ³¢å™¨çš„å®ç°åœ¨è¯¾ä¸Šæœ‰æåˆ°ï¼š<br><img src="/img/00019/implementation-of-filtering.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br><code>w_ij</code> : éå†åˆ°å‘¨å›´åƒç´ æ—¶ï¼Œè¯¥åƒç´ çš„æƒé‡ã€‚<br><code>sum_of_weights</code> : å„åƒç´ æƒé‡æ€»å’Œï¼Œå¦‚æœæ˜¯ä¸Šé¢æåˆ°çš„å½’ä¸€åŒ–é«˜æ–¯æ ¸ï¼Œåˆ™è¯¥å€¼ç­‰äº<code>1</code>ã€‚<br><code>sum_of_weighted_values</code> : å„åƒç´ å€¼ç»è¿‡æƒé‡å¤„ç†åçš„æ€»å’Œã€‚<br><code>C^&#123;input&#125;[j]</code> : å„åƒç´ çš„å€¼ï¼Œå¯ä»¥æ˜¯ç°åº¦å€¼æˆ–è€…<code>RGB</code>é¢œè‰²å€¼ã€‚<br>æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯æ¯ä¸ªåƒç´ éƒ½ä¼šè€ƒè™‘å®ƒä¸€å®šèŒƒå›´å†…åƒç´ å€¼å¯¹å®ƒçš„è´¡çŒ®ï¼Œæœ€åå†é™¤ä»¥<strong>æƒé‡æ€»å’Œ</strong>å°±æ˜¯è¯¥åƒç´ çš„é¢œè‰²å€¼ã€‚è¿™æ ·åšä¼˜ç‚¹åœ¨äºï¼Œå®ƒä¸ä¼šå¼•èµ·æ•´ä½“èƒ½é‡çš„é™ä½æˆ–å‡é«˜ï¼Œä¸ä¼šå¯¼è‡´å›¾åƒæ•´ä½“å˜æš—æˆ–å˜äº®ã€‚<br>æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å†å…³ç³»æ»¤æ³¢æ ¸çš„æƒé‡ï¼Œè€Œæ˜¯å…³æ³¨æ»¤æ³¢æ ¸çš„å½¢çŠ¶ï¼Œè€Œå›¾åƒé™å™ªéƒ¨åˆ†æœ€é‡è¦çš„å°±æ˜¯æ»¤æ³¢æ ¸çš„å½¢çŠ¶ã€‚  </p>
<p>å¦‚æœåªæ˜¯ä½¿ç”¨é«˜æ–¯æ»¤æ³¢æ ¸ï¼Œåˆ™å›¾åƒçš„é«˜é¢‘ä¿¡æ¯éƒ½ä¼šè¢«æŠ¹å»ï¼Œä¿ç•™ä½äº†ä½é¢‘ä¿¡æ¯ï¼Œè¿™æ ·çœ‹èµ·æ¥å›¾åƒå°±ä¼šå˜å¾—å¾ˆæ¨¡ç³Šï¼š<br><img src="/img/00019/gaussian-filter.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>è€Œæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›è¾¹ç•Œä¸è¦è¢«ç³Šæ‰ï¼Œä»¥åŠä¿ç•™ä¸€äº›æœ‰ç”¨çš„é«˜é¢‘ä¿¡æ¯ï¼Œè¿™å°±å¼•å…¥äº†æ–°çš„æ–¹æ³•<code>BF(Bilateral Filtering)</code>ï¼š<br><img src="/img/00019/bilateral-filtering.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br><code>i</code>ï¼Œ<code>j</code> è¡¨ç¤ºä¸€ä¸ªç‚¹ï¼› <code>k</code>ï¼Œ<code>l</code> è¡¨ç¤ºå¦ä¸€ä¸ªç‚¹ã€‚<br>è¯¥æ–¹æ³•åœ¨ç±»é«˜æ–¯æ»¤æ³¢ï¼ˆä¸€åˆ‡éšè·ç¦»è¡°å‡çš„å‡½æ•°éƒ½å¯ä»¥ç”¨ï¼Œæ‰€ä»¥å‰é¢é‚£ä¸€å¨å°±å»æ‰äº†ï¼‰ä¸Šå¢åŠ äº†ä¸€ä¸ªé¢œè‰²è´¡çŒ®é¡¹ï¼Œä¹Ÿå°±è¯´ä¸­å¿ƒå‘¨å›´çš„åƒç´ å’Œä¸­å¿ƒåƒç´ çš„é¢œè‰²å·®å¼‚è¿‡å¤§å°±ä¸ç»™äºˆå®ƒè´¡çŒ®ï¼Œè¿™æ ·è¾¹ç•Œè¿™ç§é«˜é¢‘ä¿¡æ¯å°±ä¸ä¼šè¢«ç³Šæ‰ã€‚ä¸‹é¢å°±æ˜¯è¯¥æ–¹æ³•çš„æ•ˆæœï¼š<br><img src="/img/00019/bilateral-filtering-result.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>æ•ˆæœæ˜¯å¥½äº†å¾ˆå¤šï¼Œè¾¹ç•Œä¹Ÿå¾ˆæ¸…æ™°äº†ï¼Œä½†è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå±±ä½“ä»¥åŠæ°´é¢å¾ˆå¤šæœ‰ç”¨çš„é«˜é¢‘ä¿¡æ¯è¢«å½“åšå™ªå£°æŠ¹æ‰äº†ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ–¹æ³•åˆ†ä¸æ¸…å™ªç‚¹å’Œæœ‰ç”¨çš„é«˜é¢‘ä¿¡æ¯ã€‚  </p>
<p>æ‰€ä»¥åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå†å¢åŠ ä¸€äº›æ–°çš„åˆ¤æ–­æ ‡å‡†å°±å¯ä»¥ä¿ç•™æ›´å¤šæœ‰ç”¨çš„é«˜é¢‘ä¿¡æ¯ï¼Œè¿™å°±æ˜¯å¼•å…¥äº†<code>JBF/CBF(Joint/Cross Bilateral Filtering)</code>:<br>$$<br>J(i,j) &#x3D; \exp(-\frac{\lVert i-j\lVert ^2}{2\sigma_{p}^2} - \frac{\lVert \widetilde{C}[i] - \widetilde{C}[j] \lVert ^2 }{2\sigma_{c}^2} - \frac{D_{normal}(i,j)^2}{2\sigma_{n}^2} - \frac{D_{plane}(i,j)^2}{2\sigma_{d}^2})<br>$$</p>
<p>å…¶ä¸­<code>i</code>ï¼Œ<code>j</code> ä¸ºä¸åŒçš„ä¸¤ä¸ªåƒç´ ç‚¹ã€‚<br>$$<br>D_{normal}(i,j) &#x3D; arccos(Normal[i] \cdot Normal[j])<br>$$</p>
<p>$$<br>D_{plane}(i,j) &#x3D; Normal[i]\cdot \frac{Position[j] - Position[i]}{\lVert Position[j] - Positon[i] \lVert}<br>$$</p>
<p>$\widetilde{C}$ä¸ºæœ‰å™ªå£°çš„è¾“å…¥å›¾åƒï¼Œ$D_{normal}$ä¸ºä¸¤æ³•çº¿å¤¹è§’ï¼Œ$D_{plane}$ä¸ºæ·±åº¦å·®å€¼æŒ‡æ ‡ã€‚å…¬å¼ä¸­çš„å„ä¸ª<code>Ïƒ</code>å€¼åœ¨<code>Denoiser</code>ç±»ä¸­æœ‰æä¾›ã€‚  </p>
<p>è¯¥æ–¹æ³•æ–°å¢ä¸¤ä¸ªåˆ¤æ–­æ ‡å‡†æ¥æº<code>Gbuffer</code>ï¼Œç”±äº<code>Gbuffer</code>ç”Ÿæˆçš„çº¹ç†æ˜¯æ²¡æœ‰ä»»ä½•å™ªå£°çš„ï¼Œæ‰€ä»¥ç”¨å®ƒä»¬æ¥æŒ‡å¯¼æ»¤æ³¢æ•ˆæœéå¸¸ä¸é”™ï¼Œè€Œä¸”ç”Ÿæˆ<code>Gbuffer</code>çš„æ€§èƒ½æ¶ˆè€—å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œåœ¨ç¬¬ä¸€è¶Ÿ<code>Rasterization</code>ç”Ÿæˆ<code>Primary Ray</code>çš„æ—¶å€™ç›´æ¥é¡ºå¸¦å°±ç”Ÿæˆäº†æ‰€éœ€è¦çš„<code>Gbuffer</code>ã€‚</p>
<p><code>JBF</code>çš„ä»£ç ç­‰åˆ°åé¢è®²è§£<code>A-Trous Wavelet</code>å•å¸§é™å™ªåŠ é€Ÿæ—¶åœ¨è´´ä¸Šã€‚</p>
<h2 id="ä¸¤å¸§é—´çš„æŠ•å½±"><a href="#ä¸¤å¸§é—´çš„æŠ•å½±" class="headerlink" title="ä¸¤å¸§é—´çš„æŠ•å½±"></a>ä¸¤å¸§é—´çš„æŠ•å½±</h2><p>è¿™ä¸€æ­¥ä¸»è¦æ˜¯æ‰¾å‡ºå½“å‰å¸§çš„æ¯ä¸ªåƒç´ åœ¨ä¸Šä¸€å¸§å¯¹åº”æ˜¯å“ªä¸ªåƒç´ ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/img/00019/back-projection.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>æˆ‘ä»¬ç§°è¿™ä¸€è¿‡ç¨‹ä¸º<code>Back Projection</code>ï¼Œå®ƒå®ç°çš„å…·ä½“è¡¨è¾¾å¼å¦‚ä¸‹ï¼š<br>$$<br>Screen_{i-1} &#x3D; E_{i-1}P_{i-1}V_{i-1}M_{i-1}M_{i}^{-1}World_{i}<br>$$<br> $E_{i-1}$ æ˜¯è§†å£å˜æ¢ï¼Œé—«è€å¸ˆè¯´å…¬å¼ä¸­æ¼æ‰äº†ï¼Œè¿™é‡Œæˆ‘è¡¥ä¸Šã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯¥å¼å­æ‰¾åˆ°å½“å‰å¸§å½“å‰ç‰‡æ®µå¯¹åº”çš„ä¸Šä¸€å¸§çš„ç‰‡æ®µï¼Œä¸Šè¿°å¼å­ä¸­æ‰€éœ€è¦çš„å„ç§æ•°æ®åœ¨æ¡†æ¶ä¸­éƒ½æœ‰æä¾›ï¼Œå…·ä½“è¯·åé¢çš„ä»£ç å®ç°ã€‚æ‰¾åˆ°çš„ä¸Šä¸€å¸§ä¿¡æ¯è¿˜æœ‰å¯èƒ½æ— æ³•ä½¿ç”¨ï¼Œè¿™ä¸€ç°è±¡æˆ‘ä»¬ç§°ä½œä¸º<code>Temporal Failure</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæœ‰ä¸‰ç§æƒ…å¢ƒä¼šå¯¼è‡´æŠ•å½±å¾—åˆ°çš„ä¿¡æ¯æ— æ•ˆã€‚<br><img src="/img/00019/temporal-failure.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>å·¦è¾¹çš„ç®±å­æ˜¯ä¸Šä¸€å¸§ï¼Œå³è¾¹çš„ç®±å­æ˜¯å½“å‰å¸§ã€‚<br>disocclusion ï¼š å½“å‰å¸§æ–°å‡ºç°çš„ç‰©ä½“ï¼Œç”±è¢«é®æŒ¡çš„çŠ¶æ€å˜æˆæœªè¢«é®æŒ¡çš„çŠ¶æ€ã€‚  </p>
<p>å‰ä¸¤ç§æƒ…å†µç”±å±å¹•ç©ºé—´çš„èŒƒå›´æ¥çº¦æŸå®ƒï¼Œè¶…å‡ºèŒƒå›´çš„ç›´æ¥ä¸¢å¼ƒï¼ˆå› ä¸ºä¸Šä¸€å¸§å¹¶æœªè®°å½•å±å¹•å¤–çš„ä¿¡æ¯ï¼‰ã€‚å¯¹äºç¬¬ä¸‰ç§ï¼Œæˆ‘ä»¬åˆ™ç”¨ä¸€ä¸ªå«<code>Object ID</code>çš„æ–¹æ³•æ¥æ£€æµ‹<code>Temporal Failure</code>ï¼Œå¦‚æœä¸Šä¸€å¸§å’Œå½“å‰å¸§çš„<code>Object ID</code>ä¸ä¸€è‡´åˆ™ä¸¢å¼ƒï¼Œè¯´æ˜å½“å‰å¸§è¯¥ç‰©ä½“å±äº<code>disocclusion</code>çŠ¶æ€ã€‚</p>
<p>ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Denoiser_JBF::Reprojection</span><span class="hljs-params">(<span class="hljs-type">const</span> FrameInfo &amp;frameInfo)</span> </span>&#123;<br>    <span class="hljs-type">int</span> height = m_accColor.m_height;<br>    <span class="hljs-type">int</span> width = m_accColor.m_width;<br>    Matrix4x4 pre_World_To_Screen =<br>        m_preFrameInfo.m_matrix[m_preFrameInfo.m_matrix.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>];<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Reproject</span><br>            <span class="hljs-built_in">m_valid</span>(x, y) = <span class="hljs-literal">false</span>;<br>            <span class="hljs-built_in">m_misc</span>(x, y) = <span class="hljs-built_in">Float3</span>(<span class="hljs-number">0.f</span>);<br><br>            <span class="hljs-type">int</span> id = frameInfo.<span class="hljs-built_in">m_id</span>(x, y);<br>            <span class="hljs-keyword">if</span> (id == <span class="hljs-number">-1</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            Matrix4x4 world_to_local = <span class="hljs-built_in">Inverse</span>(frameInfo.m_matrix[id]);<br>            Matrix4x4 pre_local_to_world = m_preFrameInfo.m_matrix[id];<br>            <span class="hljs-keyword">auto</span> world_position = frameInfo.<span class="hljs-built_in">m_position</span>(x, y);<br>            <span class="hljs-keyword">auto</span> local_position =<br>                <span class="hljs-built_in">world_to_local</span>(world_position, Float3::EType::Point);<br>            <span class="hljs-keyword">auto</span> pre_world_position =<br>                <span class="hljs-built_in">pre_local_to_world</span>(local_position, Float3::EType::Point);<br>            <span class="hljs-keyword">auto</span> pre_screen_position =<br>                <span class="hljs-built_in">pre_World_To_Screen</span>(pre_world_position, Float3::EType::Point);<br><br>            <span class="hljs-keyword">if</span> (pre_screen_position.x &lt; <span class="hljs-number">0</span> || pre_screen_position.x &gt;= width ||<br>                pre_screen_position.y &lt; <span class="hljs-number">0</span> || pre_screen_position.y &gt;= height) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">int</span> pre_id =<br>                    m_preFrameInfo.<span class="hljs-built_in">m_id</span>(pre_screen_position.x, pre_screen_position.y);<br>                <span class="hljs-keyword">if</span> (pre_id == id) &#123;<br>                    <span class="hljs-built_in">m_valid</span>(x, y) = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-built_in">m_misc</span>(x, y) =<br>                        <span class="hljs-built_in">m_accColor</span>(pre_screen_position.x, pre_screen_position.y);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//m_miscæ˜¯ä¸€ä¸ªä¸´æ—¶å­˜å‚¨çš„bufferï¼Œå¦‚æœä¸€è¶Ÿpassä¸­ï¼Œè¯»å†™æ˜¯åŒä¸€ä¸ªbufferï¼Œå°±éœ€è¦å¦å¼€ä¸€ä¸ªbufferæ¥é¿å…å®ƒä»¬ç›¸äº’å¹²æ‰°ã€‚åœ¨åé¢svgfä¸­æˆ‘ä»¬ä¹Ÿä¼šç»å¸¸è¿™ä¹ˆä½¿ç”¨ã€‚</span><br>    std::<span class="hljs-built_in">swap</span>(m_misc, m_accColor);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>world_to_local</code>å¯¹åº” $M_{i}^{-1}$ï¼Œ<code>pre_local_to_world</code>å¯¹åº” $M_{i-1}$ï¼Œ<code>pre_World_To_Screen</code>å¯¹åº” $E_{i-1}P_{i-1}V_{i-1}$ã€‚</p>
<h2 id="ä¸¤å¸§é—´çš„ç´¯ç§¯"><a href="#ä¸¤å¸§é—´çš„ç´¯ç§¯" class="headerlink" title="ä¸¤å¸§é—´çš„ç´¯ç§¯"></a>ä¸¤å¸§é—´çš„ç´¯ç§¯</h2><p>ä¸Šä¸€èŠ‚ä¸­æˆ‘å·²ç»æ‹¿åˆ°äº†ä¸Šä¸€å¸§æœ‰ç”¨çš„å†å²ä¿¡æ¯ï¼Œè¿™ä¸€å°èŠ‚åˆ™æ˜¯å°†å½“å‰å¸§ä¸ä¸Šä¸€å¸§è¿›è¡Œçº¿æ€§æ··åˆï¼Œåœ¨çº¿æ€§æ··åˆä¹‹å‰è¿˜éœ€è¦ä¸€æ¬¡<code>Clamp</code>æ“ä½œï¼Œå°†ä¸Šä¸€å¸§çš„é¢œè‰²åˆ©ç”¨å½“å‰å¸§çš„å‡å€¼å’Œæ–¹å·®ä¸¥æ ¼æ§åˆ¶åœ¨å½“å‰å¸§é¢œè‰²é™„è¿‘ï¼Œå…¬å¼å¦‚ä¸‹ï¼š</p>
<p>$$<br>\overline{C}<em>{i} &#x3D; \alpha \overline{C}</em>{i} + (1-\alpha) Clamp(\overline{C}<em>{i-1})<br>$$<br> $\alpha$çš„å€¼é€šå¸¸å–<code>0.2</code>ã€‚<br>å¯¹äº<code>Clamp</code>éƒ¨åˆ†ï¼Œé¦–å…ˆéœ€è¦è®¡ç®— $\overline{C}</em>{i}$åœ¨<code>7 * 7</code>çš„é‚»åŸŸå†…çš„å‡å€¼<code>Î¼</code>å’Œæ–¹å·®<code>Ïƒ</code>ï¼Œç„¶åæŠŠä¸Šä¸€å¸§çš„é¢œè‰² $\overline{C}_{i-1}$<code>Clamp</code>åœ¨ $(\mu - k\sigma, \mu + k \sigma)$èŒƒå›´å†…ã€‚  </p>
<p>ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Denoiser_JBF::TemporalAccumulation</span><span class="hljs-params">(<span class="hljs-type">const</span> Buffer2D&lt;Float3&gt; &amp;curFilteredColor)</span> </span>&#123;<br>    <span class="hljs-type">int</span> height = m_accColor.m_height;<br>    <span class="hljs-type">int</span> width = m_accColor.m_width;<br>    <span class="hljs-type">int</span> kernelRadius = <span class="hljs-number">3</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Temporal clamp</span><br>            Float3 color = <span class="hljs-built_in">m_accColor</span>(x, y);<br>            <span class="hljs-comment">//Set Alpha to 1 when no legal corresponding point was found in the previous frame</span><br>            <span class="hljs-type">float</span> alpha = <span class="hljs-number">1.0f</span>;<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">m_valid</span>(x, y)) &#123;<br>                alpha = m_alpha;<br><br>                <span class="hljs-type">int</span> x_start = std::<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, x - kernelRadius);<br>                <span class="hljs-type">int</span> x_end = std::<span class="hljs-built_in">min</span>(width - <span class="hljs-number">1</span>, x + kernelRadius);<br>                <span class="hljs-type">int</span> y_start = std::<span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, y - kernelRadius);<br>                <span class="hljs-type">int</span> y_end = std::<span class="hljs-built_in">min</span>(height - <span class="hljs-number">1</span>, y + kernelRadius);<br><br>                <span class="hljs-function">Float3 <span class="hljs-title">mu</span><span class="hljs-params">(<span class="hljs-number">0.f</span>)</span></span>;<br>                <span class="hljs-function">Float3 <span class="hljs-title">sigma</span><span class="hljs-params">(<span class="hljs-number">0.f</span>)</span></span>;<br><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> m = x_start; m &lt;= x_end; m++) &#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> n = y_start; n &lt;= y_end; n++) &#123;<br>                        mu += <span class="hljs-built_in">curFilteredColor</span>(m, n);<br>                        <span class="hljs-comment">//sqrï¼šå¹³æ–¹</span><br>                        sigma += <span class="hljs-built_in">Sqr</span>(<span class="hljs-built_in">curFilteredColor</span>(x, y) - <span class="hljs-built_in">curFilteredColor</span>(m, n));<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-type">int</span> count = kernelRadius * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;<br>                <span class="hljs-comment">// 7 * 7</span><br>                count *= count;<br><br>                mu /= <span class="hljs-built_in">float</span>(count);<br>                sigma = <span class="hljs-built_in">SafeSqrt</span>(sigma / <span class="hljs-built_in">float</span>(count));<br>                color = <span class="hljs-built_in">Clamp</span>(color, mu - sigma * m_colorBoxK, mu + sigma * m_colorBoxK);<br>            &#125;<br><br>            <span class="hljs-built_in">m_misc</span>(x, y) = <span class="hljs-built_in">Lerp</span>(color, <span class="hljs-built_in">curFilteredColor</span>(x, y), alpha);<br>        &#125;<br>    &#125;<br>    std::<span class="hljs-built_in">swap</span>(m_misc, m_accColor);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>Clamp</code>æ˜¯ä¸ºäº†å‡è½»<code>Lagging(æ‹–å½±)</code>ç°è±¡ï¼Œå¦‚æœä»€ä¹ˆéƒ½ä¸åšå¼ºè¡Œä½¿ç”¨ä¸Šä¸€å¸§çš„ä¿¡æ¯ï¼Œå°±ä¼šå¯¼è‡´æ‹–å½±ç°è±¡:<br><img src="/img/00019/lagging.png" srcset="/img/loading.gif" lazyload alt="Alt text"></p>
<p>ä½¿ç”¨äº†<code>Clamp</code>æ–¹æ³•åï¼Œæ‹–å½±ç°è±¡æ²¡äº†ï¼Œä½†æ˜¯ä¼šé‡æ–°å¼•å…¥å™ªå£°ï¼Œä¸è¿‡ç›¸æ¯”äºæ‹–å½±æ•ˆæœè¿˜æ˜¯å¥½äº†å¾ˆå¤šï¼š<br><img src="/img/00019/noise.png" srcset="/img/loading.gif" lazyload alt="Alt text"></p>
<p>é€šå¸¸<code>Object ID</code>å’Œ<code>Clamp</code>æ–¹æ³•æ˜¯ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>å³ä½¿æˆ‘ä»¬å·²ç»åšå¾—è¶³å¤Ÿå¥½äº†ï¼Œä½†è¿˜æ˜¯æœ‰å¾ˆå¤šçš„<code>Temporal Failure</code>ï¼Œå¹¶ä¸æ˜¯å› ä¸ºå‡ ä½•çš„åŸå› ï¼Œè€Œæ˜¯<code>shading</code>è¿‡ç¨‹ä¸­ä¹Ÿä¼šå‡ºé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´é˜´å½±æˆ–è€…åå°„è¿™ç§ç°è±¡ï¼Œåœ¨ç”¨ä¸Šä¸€å¸§çš„ä¿¡æ¯æ—¶ï¼Œå®ƒçš„<code>motion vector</code>æ˜¯é›¶ï¼Œå½“å‰å¸§å½“å‰ç‰‡æ®µå°±ä¼šç”¨ä¸Šä¸€å¸§çš„ä¿¡æ¯ï¼Œè¿™å°±ä¼šå¯¼è‡´é˜´å½±æ‹–å°¾æˆ–è€…åå°„å»¶è¿Ÿçš„ç°è±¡ï¼š<br>Detached&#x2F;Lagging shadows<br><img src="/img/00019/lagging-shadows.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>Reflection hysteresis<br><img src="/img/00019/reflection-hysteresis.gif" srcset="/img/loading.gif" lazyload alt="Alt text"></p>
<h2 id="åŠ é€Ÿå•å¸§é™å™ª"><a href="#åŠ é€Ÿå•å¸§é™å™ª" class="headerlink" title="åŠ é€Ÿå•å¸§é™å™ª"></a>åŠ é€Ÿå•å¸§é™å™ª</h2><h3 id="Separate-Passes"><a href="#Separate-Passes" class="headerlink" title="Separate Passes"></a>Separate Passes</h3><p>åœ¨æ­¤ä¹‹å‰è¿˜ä»‹ç»ä¸€ç§<code>Separate Passes</code>çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¯ä»¥å°†å¤æ‚åº¦ä»<code>N^2</code>é™åˆ°<code>2N</code>ï¼š<br><img src="/img/00019/image.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>è¯¥æ–¹æ³•å¾ˆé€‚åˆé«˜æ–¯æ»¤æ³¢ï¼Œå› ä¸ºé«˜æ–¯æ»¤æ³¢åœ¨å®šä¹‰ä¸Šå°±å¯ä»¥æ‹†åˆ†æˆä¸¤ä¸ªæ–¹å‘ä¸Šå‡½æ•°çš„ä¹˜ç§¯å½¢å¼,æ»¤æ³¢è¿‡ç¨‹ä¸­ç›¸å½“äºå…ˆæ°´å¹³æ–¹å‘åšä¸€æ¬¡å·ç§¯ï¼Œç„¶åå°†ç»“æœç»™åˆ°ç«–ç›´æ–¹å‘å†åšä¸€æ¬¡å·ç§¯ï¼Œéå¸¸å®Œç¾ï¼š<br><img src="/img/00019/image-1.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>ä½†é—®é¢˜æ˜¯<code>BF</code>å’Œ<code>JBF</code>çš„å·ç§¯æ ¸ï¼Œä¸æ˜¯ä¸€ä¸ªé«˜æ–¯å‡½æ•°ï¼Œæƒ³è¦å°†å®ƒæ‹†åˆ†æˆæ°´å¹³ç«–ç›´çš„å‡½æ•°æ˜¯å‡ ä¹ä¸å¯èƒ½ï¼Œä½†è¿™é‡Œæ˜¯å®æ—¶æ¸²æŸ“ï¼Œâ€œçº¦ç­‰äºâ€æ— å¤„ä¸åœ¨ğŸ˜†ï¼Œ<code>filter</code>çš„èŒƒå›´åªè¦ä¸æ˜¯å¤ªå¤§æ¯”å¦‚<code>32 * 32</code>è¿˜æ˜¯å¯ä»¥å‹‰å¼ºç”¨ä¸€ç”¨çš„ã€‚  </p>
<h3 id="A-Trous-Wavelet"><a href="#A-Trous-Wavelet" class="headerlink" title="A-Trous Wavelet"></a>A-Trous Wavelet</h3><p>ä¸Šé¢æåˆ°çš„<code>Separate Passes</code>æ–¹æ³•ï¼Œæˆ‘è¿˜æ²¡çœ‹åˆ°åœ¨å“ªé‡Œç”¨ä¸Šäº†ğŸ˜…ã€‚è€Œ<code>A-Trous Wavelet</code>æ–¹æ³•åœ¨é™å™ªè¿™æ–¹é¢å‡ ä¹æ˜¯é€šåƒï¼Œåº”ç”¨éå¸¸å¹¿æ³›ï¼š<br><img src="/img/00019/image-2.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>è¿™é‡Œ<code>ppt</code>ä¸Šçš„å›¾ç‰‡ä¸å¤ªå¥½ç†è§£ï¼Œæˆ‘è¿™é‡Œå¼•ç”¨ä¸€ä¸‹çŸ¥ä¹<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/607012514">èŠ±æ¡‘</a>çš„å›¾ç‰‡<br><img src="/img/00019/image-3.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br><code>A-Trous Wavelet</code>æ–¹æ³•ç›¸å½“äºå§ä¸€ä¸ªéå¸¸å¤§èŒƒå›´çš„<code>filterè¿‡ç¨‹</code>åˆ†è§£æˆ<code>å‡ è¶Ÿpass</code>æ¥å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦<code>filter</code>çš„ç‚¹ä½<code>p</code>å°±æ˜¯<code>const Float3 p = ipos + Float3(xx, yy,0) * stepSize;</code>å…¶ä¸­<code>ipos</code>ä¸­å¿ƒç‚¹ï¼Œ<code>xx,yy</code>æ˜¯åç§»å€¼ï¼Œ<code>stepSize</code>åˆ™æ˜¯ $2^{pass-1}$<br>è¿™æ ·<code>3</code>è¶Ÿ<code>5 * 5</code>çš„æ»¤æ³¢å°±ç›¸å½“äº<code>16 * 16</code>çš„æ»¤æ³¢ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ä¸€ä¸ªå¤§å°ä¸º<code>5 * 5</code>çš„æ»¤æ³¢æ ¸ï¼Œèµ°<code>5</code>è¶Ÿï¼Œæ¥æ¨¡æ‹Ÿ<code>64 * 64</code>çš„æ»¤æ³¢è¿‡ç¨‹ã€‚(5 * 5çš„æ»¤æ³¢æ ¸ï¼Œèµ°5è¶Ÿï¼ŒfilteråŠå¾„å³ $2 \times 2^{5-1}&#x3D;32$)</p>
<p>å½“ç„¶è¿™åªæ˜¯è¯¥æ–¹æ³•çš„åº”ç”¨ï¼Œå®ƒçš„åŸç†å…¶å®å¾ˆå¤æ‚ï¼Œç®€å•æ¦‚è¿°ä¸€ä¸‹ï¼š<br><img src="/img/00019/image-4.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼š<br>ä¸ºä»€ä¹ˆè¦ç”¨ä¸€ä¸ªé€æ¸å¢åŠ çš„<code>filter</code>èŒƒå›´ï¼Œä¸èƒ½ä¸€ä¸Šæ¥å°±æ˜¯æœ€å¤§èŒƒå›´ï¼Ÿ<br>å›¾ä¸Šç»™å‡ºçš„ç­”æ¡ˆæ˜¯ï¼Œé€æ¸å¢åŠ çš„<code>filter</code>èŒƒå›´ &#x3D;&#x3D; å»æ‰æ›´ä½çš„é¢‘ç‡ã€‚<br>å¯¹äºç¬¬ä¸€è¶Ÿ<code>pass</code>ï¼Œæˆ‘ä»¬<code>filter</code>çš„è¿‡ç¨‹æ˜¯å°†é«˜é¢‘ä¿¡æ¯é™åˆ¶åœ¨ä¸€ä¸ªå¯æ¥å—çš„èŒƒå›´å†…ï¼Œå¾€åçš„æ¯ä¸€è¶Ÿ<code>pass</code>éƒ½æ˜¯åœ¨å‰ä¸€è¶Ÿçš„åŸºç¡€ä¸Šç»§ç»­å°†é«˜é¢‘ä¿¡æ¯é™åˆ¶åœ¨ä¸€ä¸ªæ›´ä½çš„å¯æ¥å—èŒƒå›´å†…ï¼Œæ‰€ä»¥è¿™é‡Œâ€œå»æ‰æ›´ä½çš„é¢‘ç‡â€æ„æ€æ˜¯ç›¸æ¯”äºä¸Šä¸€è¶Ÿ<code>pass</code>ï¼Œå»æ‰æ¯”ä¸Šä¸€è¶Ÿé«˜é¢‘ä¿¡æ¯æ›´ä½ä¸€ç‚¹çš„é«˜é¢‘ä¿¡æ¯ã€‚è‡ªç„¶è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯<code>filter</code>çš„èŒƒå›´æ˜¯é€æ¸å¢åŠ ï¼Œè€Œä¸èƒ½ä¸€ä¸Šæ¥å°±æ˜¯<code>filter</code>æœ€å¤§çš„èŒƒå›´ã€‚<br>å¯¹äºç¬¬äºŒä¸ªé—®é¢˜ï¼š<br>ä¸ºä»€ä¹ˆå¯ä»¥å®‰å…¨çš„è·³è¿‡ä¸€äº›é‡‡æ ·ç‚¹ï¼Ÿ<br>å›¾ä¸Šç»™å‡ºçš„ç­”æ¡ˆæ˜¯ï¼Œé‡‡æ · &#x3D;&#x3D; é‡å¤æ¬ç§»é¢‘è°±ã€‚<br>é¦–å…ˆå¯¹äºé‡‡æ ·æ¥è¯´ï¼Œæ—¶åŸŸä¸Šçš„é‡‡æ ·ç­‰äºåŸå§‹å‡½æ•°ä¹˜ä¸Šå†²å‡»å‡½æ•°ã€‚è€Œå¯¹åº”é¢‘åŸŸä¸Šï¼Œå°±æ˜¯åŸå§‹é¢‘è°±å·ç§¯å†²å‡»é¢‘è°±ï¼Œç›¸å½“äºå¯¹åœ¨é¢‘åŸŸä¸Šå¯¹åŸå§‹é¢‘è°±è¿›è¡Œæ¬ç§»çš„æ“ä½œï¼Œè€Œä¸”æ—¶åŸŸå†²å‡»å‡½æ•°çš„å†²å‡»é—´éš”è¶Šå¤§ï¼Œå¯¹åº”é¢‘åŸŸæ¬ç§»çš„é—´éš”å°±è¶Šå°ï¼š<br><img src="/img/00019/image-5.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>(a)ä¸ºåŸå§‹å‡½æ•°ï¼Œ(b)ä¸ºè¯¥å‡½æ•°ç»è¿‡å‚…é‡Œå¶å˜åŒ–åçš„é¢‘è°±ã€‚<br>(c)ä¸ºå†²å‡»å‡½æ•°ï¼Œ(d)ä¸ºè¯¥å‡½æ•°ç»è¿‡å‚…é‡Œå¶å˜åŒ–åçš„é¢‘è°±ã€‚<br>(e)ä¸ºåŸå§‹å‡½æ•°ä¹˜ä¸Šå†²å‡»å‡½æ•°çš„ç»“æœã€‚<br>(f)ä¸º(b)(d)é¢‘è°±å·ç§¯åçš„ç»“æœã€‚<br>æˆ‘ä»¬çŸ¥é“å¦‚æœæ—¶åŸŸé‡‡æ ·é—´éš”å¢åŠ å¤§ï¼Œé¢‘åŸŸä¸Šé¢‘è°±æ··å å°±è¶Šä¸¥é‡ï¼Œåªæœ‰å½“é¢‘è°±ä¸­é«˜é¢‘ä¿¡æ¯è¢«æŠ¹æ‰åï¼Œæ··å æ‰ä¸ä¼šå¼•èµ·èµ°æ ·ã€‚è¿™ä¹Ÿæ˜¯è¦ç”¨ä¸€ä¸ªé€æ¸å¢åŠ çš„<code>filter</code>èŒƒå›´çš„ä¸€ä¸ªåŸå› ã€‚<br><img src="/img/00019/image-6.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>å›åˆ°é—®é¢˜ä¸Šï¼Œ<code>A-Trous Wavelet</code>çš„é‡‡æ ·é—´éš”ä¸º$2^{pass-1}-1$ï¼Œè¿™ç§é‡‡æ ·é—´è·çš„å¥½å¤„æ˜¯æ¬ç§»çš„è¾¹ç•Œæ­£å¥½æ˜¯ä¸Šä¸€è¶Ÿç•™ä¸‹çš„æœ€é«˜é¢‘ç‡ã€‚<br>æ‰€ä»¥è¿™ç§é‡‡æ ·å¯ä»¥å®‰å…¨çš„è·³è¿‡ä¸€äº›é‡‡æ ·ç‚¹ï¼Œè€Œä¸å¼•å…¥èµ°æ ·ã€‚<br>ç»“åˆç¬¬ä¸€ä¸ªé—®é¢˜å’Œç¬¬äºŒä¸ªé—®é¢˜ï¼Œå½“å‰<code>pass</code>ä¼šé™¤å»ä¸€äº›æ›´ä½çš„é«˜é¢‘ä¿¡æ¯ï¼Œæœ‰åŠ©äºæ¬ç§»æ··å æ—¶å‡å°‘èµ°æ ·ç°è±¡ï¼Œä»¥$2^{pass-1}-1$çš„é—´éš”å»é‡‡æ ·ï¼Œç”±äºæ¬ç§»æ—¶å·¦å³è¾¹ç•Œéƒ½æ˜¯ä¸Šä¸€æ¬¡ç•™ä¸‹çš„æœ€é«˜é¢‘ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™ç§é€æ¸å¢å¤§çš„é‡‡æ ·é—´éš”å¹¶ä¸ä¼šæ–°å¢èµ°æ ·ã€‚<br>æ›´å¤šå†…å®¹è¯·å…³æ³¨è¯¥è®ºæ–‡ï¼š<br><a target="_blank" rel="noopener" href="https://jo.dreggn.org/home/2010_atrous.pdf">Edge-Avoiding Ã€-Trous Wavelet Transform for fast Global Illumination Filtering</a></p>
<p><code>JBF A-Trous Wavelet</code>çš„ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Buffer2D&lt;Float3&gt; <span class="hljs-title">Denoiser_JBF::ATrousWaveletFilter</span><span class="hljs-params">(<span class="hljs-type">const</span> FrameInfo &amp;frameInfo)</span> </span>&#123;<br>    <span class="hljs-type">int</span> height = frameInfo.m_beauty.m_height;<br>    <span class="hljs-type">int</span> width = frameInfo.m_beauty.m_width;<br>    Buffer2D&lt;Float3&gt; filteredImage = <span class="hljs-built_in">CreateBuffer2D</span>&lt;Float3&gt;(width, height);<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Joint bilateral filter</span><br>            <span class="hljs-comment">// filteredImage(x, y) = frameInfo.m_beauty(x, y);</span><br><br>            <span class="hljs-keyword">auto</span> center_postion = frameInfo.<span class="hljs-built_in">m_position</span>(x, y);<br>            <span class="hljs-keyword">auto</span> center_normal = frameInfo.<span class="hljs-built_in">m_normal</span>(x, y);<br>            <span class="hljs-keyword">auto</span> center_color = frameInfo.<span class="hljs-built_in">m_beauty</span>(x, y);<br><br>            Float3 final_color;<br>            <span class="hljs-keyword">auto</span> total_weight = <span class="hljs-number">.0</span>f;<br><br>            <span class="hljs-type">int</span> passes = <span class="hljs-number">5</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> pass = <span class="hljs-number">0</span>; pass &lt; passes; pass++) &#123;<br><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> filterX = <span class="hljs-number">-2</span>; filterX &lt;= <span class="hljs-number">2</span>; filterX++) &#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> filterY = <span class="hljs-number">-2</span>; filterY &lt;= <span class="hljs-number">2</span>; filterY++) &#123;<br><br>                        <span class="hljs-type">int</span> m = x + std::<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, pass) * filterX;<br>                        <span class="hljs-type">int</span> n = y + std::<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>, pass) * filterY;<br><br>                        <span class="hljs-keyword">auto</span> postion = frameInfo.<span class="hljs-built_in">m_position</span>(m, n);<br>                        <span class="hljs-keyword">auto</span> normal = frameInfo.<span class="hljs-built_in">m_normal</span>(m, n);<br>                        <span class="hljs-keyword">auto</span> color = frameInfo.<span class="hljs-built_in">m_beauty</span>(m, n);<br><br>                        <span class="hljs-keyword">auto</span> d_position = <span class="hljs-built_in">SqrDistance</span>(center_postion, postion) /<br>                                          (<span class="hljs-number">2.0f</span> * m_sigmaCoord * m_sigmaCoord);<br>                        <span class="hljs-keyword">auto</span> d_color = <span class="hljs-built_in">SqrDistance</span>(center_color, color) /<br>                                       (<span class="hljs-number">2.0f</span> * m_sigmaColor * m_sigmaColor);<br>                        <span class="hljs-keyword">auto</span> d_normal = <span class="hljs-built_in">SafeAcos</span>(<span class="hljs-built_in">Dot</span>(center_normal, normal));<br>                        d_normal *= d_normal;<br>                        d_normal /= (<span class="hljs-number">2.0f</span> * m_sigmaNormal * m_sigmaNormal);<br><br>                        <span class="hljs-type">float</span> d_plane = <span class="hljs-number">.0</span>f;<br>                        <span class="hljs-keyword">if</span> (d_position &gt; <span class="hljs-number">0.f</span>) &#123;<br>                            d_plane = <span class="hljs-built_in">Dot</span>(center_normal, <span class="hljs-built_in">Normalize</span>(postion - center_postion));<br>                        &#125;<br>                        d_plane *= d_plane;<br>                        d_plane /= (<span class="hljs-number">2.0f</span> * m_sigmaPlane * m_sigmaPlane);<br><br>                        <span class="hljs-type">float</span> weight =<br>                            std::<span class="hljs-built_in">exp</span>(-d_plane - d_position - d_color - d_normal);<br>                        total_weight += weight;<br>                        final_color += color * weight;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (total_weight == <span class="hljs-number">0</span>)<br>                <span class="hljs-built_in">filteredImage</span>(x, y) = center_color;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-built_in">filteredImage</span>(x, y) = final_color / total_weight;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> filteredImage;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç”¨è¯¥æ–¹æ³•<code>filter</code>çš„æ•ˆæœå›¾ï¼š<br>æ­¤æ—¶çš„<code>sigmaColor</code>ä¸º<code>0.6f</code><br><img src="/img/00019/box-JBF-atrous.gif" srcset="/img/loading.gif" lazyload><br>è€Œ<code>Pink Room</code>çš„<code>sigmaColor</code>éœ€è¦è°ƒä¸º<code>10.0f</code>ï¼Œå¦åˆ™å®Œå…¨ä¸èƒ½çœ‹ã€‚<br><img src="/img/00019/pinkroom-JBF-atrous.gif" srcset="/img/loading.gif" lazyload>    </p>
<h1 id="å®ç°-SVGF"><a href="#å®ç°-SVGF" class="headerlink" title="å®ç° SVGF"></a>å®ç° SVGF</h1><h2 id="è®ºæ–‡åœ°å€ä»¥åŠè®ºæ–‡æä¾›çš„æºç åœ°å€"><a href="#è®ºæ–‡åœ°å€ä»¥åŠè®ºæ–‡æä¾›çš„æºç åœ°å€" class="headerlink" title="è®ºæ–‡åœ°å€ä»¥åŠè®ºæ–‡æä¾›çš„æºç åœ°å€"></a>è®ºæ–‡åœ°å€ä»¥åŠè®ºæ–‡æä¾›çš„æºç åœ°å€</h2><p><code>Paper</code> : <a target="_blank" rel="noopener" href="https://research.nvidia.com/sites/default/files/pubs/2017-07_Spatiotemporal-Variance-Guided-Filtering%3A//svgf_preprint.pdf">Spatiotemporal-Variance-Guided-Filtering</a><br><code>Source Code</code> : <a target="_blank" rel="noopener" href="https://github.com/NVIDIAGameWorks/Falcor/tree/master/Source/RenderPasses/SVGFPass">Falcor</a><br>æœ¬æ–‡éƒ¨åˆ†ä»£ç ä»¥åŠå›¾ç‰‡å‡æ¥æºäºæ­¤ã€‚</p>
<h2 id="ç®—æ³•æ¦‚è¿°"><a href="#ç®—æ³•æ¦‚è¿°" class="headerlink" title="ç®—æ³•æ¦‚è¿°"></a>ç®—æ³•æ¦‚è¿°</h2><p><code>SVGF</code>èµ„æ–™ä¸å¤šï¼Œæˆ‘å¼•ç”¨ä¸€ä¸‹è®ºæ–‡ä¸­çš„å›¾ç‰‡æ¥è®²è§£ï¼š<br><img src="/img/00019/image-8.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>é¦–å…ˆä»è·¯å¾„è¿½è¸ªå¾—åˆ°ç›´æ¥å…‰å’Œé—´æ¥å…‰æ¯ä¸ªåƒç´ çš„é¢œè‰²ï¼Œç„¶åé€šè¿‡é™¤ä»¥åƒç´ ä¸Šçš„çº¹ç†ä¿¡æ¯ï¼ˆDemodulate Albedoï¼‰å¾—åˆ°åƒç´ çš„<code>Irradiance</code>ï¼ˆè¾ç…§åº¦ï¼‰ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">float3 <span class="hljs-title">demodulate</span><span class="hljs-params">(float3 c, float3 albedo)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> c / <span class="hljs-built_in">max</span>(albedo, <span class="hljs-built_in">float3</span>(<span class="hljs-number">0.001</span>, <span class="hljs-number">0.001</span>, <span class="hljs-number">0.001</span>));<br>&#125;<br><br>float3 illumination = <span class="hljs-built_in">demodulate</span>(gColor[ipos].rgb - gEmission[ipos].rgb, gAlbedo[ipos].rgb);<br></code></pre></td></tr></table></figure>
<p>æ¥ç€å¯¹åˆ†åˆ«å¯¹ç›´æ¥å…‰ç…§å’Œé—´æ¥å…‰ç…§çš„<code>Irradiance</code>ä¿¡æ¯è¿›è¡Œæ—¶é—´å’Œç©ºé—´ä¸Šçš„æ··åˆ<code>Filter</code>æ¥é‡å»ºå› ä¸ºæ ·æœ¬æåº¦ç¨€ç–æ‰€ä¸¢å¤±çš„ä¿¡æ¯ï¼ˆReconstruction Filterï¼‰ã€‚å¯¹<code>Irradiance</code>è¿›è¡Œ<code>Filter</code>ä¹‹åï¼Œå†æŠŠçº¹ç†ä¿¡æ¯å åŠ å›æ¥ï¼ˆModulate Albedoï¼‰ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">float4 <span class="hljs-title">main</span><span class="hljs-params">(FullScreenPassVsOut vsOut)</span> : SV_TARGET0</span><br><span class="hljs-function">&#123;</span><br>    <span class="hljs-type">const</span> int2 ipos = <span class="hljs-built_in">int2</span>(vsOut.posH.xy);<br><br>    <span class="hljs-keyword">return</span> gAlbedo[ipos] * gIllumination[ipos] + gEmission[ipos];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œçº¹ç†çš„ç»†èŠ‚å¹¶ä¸ä¼šå› ä¸º<code>Filter</code>çš„å¼ºåº¦è¿‡äºå¤§è€Œä¸¢å¤±æ‰ã€‚åœ¨<code>Pipeline</code>çš„æœ€åï¼Œé‡‡ç”¨ç°åœ¨å¼•æ“é‡Œéå¸¸æµè¡Œçš„<code>Temporal AA</code>ï¼Œæ›´è¿›ä¸€æ­¥çš„æ¶ˆé™¤ç”»é¢ä¸Šæ®‹ç•™çš„æŠ–åŠ¨ï¼Œä¿è¯ç»“æœåºåˆ—å¸§é—´çš„ç¨³å®šã€‚   </p>
<p>ç”±äºä½œä¸š5ï¼Œæä¾›çš„<code>EXRæ–‡ä»¶</code>ä¸­åªåŒ…å«äº†ç›´æ¥å…‰å’Œé—´æ¥å…‰ç»“åˆåœ¨ä¸€èµ·çš„å®Œæ•´ç»“æœï¼Œæˆ‘åœ¨è¿›è¡Œ<code>Reconstruction Filter</code>è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯ç›´æ¥å¯¹è¯¥ç»“æœè¿›è¡Œçš„<code>Filter</code>ï¼Œæ‰€ä»¥ç”»é¢æœ‰äº›åœ°æ–¹ä¼šç³Šæ‰ä¼šå¾ˆæ­£å¸¸ã€‚  </p>
<p>è‡³äº<code>Tone Mapping</code>å’Œ<code>TAA</code>æˆ‘å‡æœªå®ç°ï¼Œæˆ‘ä»¬çš„é‡ç‚¹æ˜¯<code>Reconstruction Filter</code>ã€‚</p>
<h2 id="Reconstruction-Filter"><a href="#Reconstruction-Filter" class="headerlink" title="Reconstruction Filter"></a>Reconstruction Filter</h2><p><img src="/img/00019/image-9.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br>é‡å»ºæ‰§è¡Œä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼šåœ¨æ—¶é—´ä¸Šç´¯ç§¯æˆ‘ä»¬çš„<code>1 spp</code>è·¯å¾„è·Ÿè¸ªè¾“å…¥ä»¥æé«˜æœ‰æ•ˆé‡‡æ ·ç‡ï¼Œä½¿ç”¨è¿™äº›æ—¶é—´ä¸Šå¢å¼ºçš„é¢œè‰²æ ·æœ¬æ¥ä¼°è®¡å±€éƒ¨äº®åº¦æ–¹å·®ï¼Œä»¥åŠä½¿ç”¨è¿™äº›æ–¹å·®ä¼°è®¡æ¥é©±åŠ¨åˆ†å±‚çš„<code>â€œa-trouså°æ³¢æ»¤æ³¢å™¨â€</code>ã€‚  </p>
<h3 id="Temporal-Filtering"><a href="#Temporal-Filtering" class="headerlink" title="Temporal Filtering"></a>Temporal Filtering</h3><p><code>Temporal Filter</code>å’Œä¸Šæ–‡æåˆ°çš„â€œä¸¤å¸§é—´çš„ç´¯ç§¯â€å¾ˆç›¸ä¼¼ï¼Œå…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>C_{i} &#x3D; \alpha C_{i} + (1-\alpha)C_{i-1}<br>$$<br>ä¸ºäº†å°½å¯èƒ½å¤šçš„å›Šæ‹¬å†å²å¸§é‡Œçš„æ ·æœ¬ä¿¡æ¯ï¼Œ<code>Temporal Filter</code>å¹¶ä¸åƒ<code>JBF</code>é‚£æ ·é€šè¿‡<code>Color Clamping</code>æ¥é˜²æ­¢<code>Ghosting</code>è¿™ç§é—®é¢˜ã€‚æ‰€ä»¥åœ¨åš<code>Sample Reprojection</code>çš„æ—¶å€™éœ€è¦æ£€æŸ¥èŒƒå›´ï¼Œæ·±åº¦ï¼Œæ³•çº¿ï¼Œæ¨¡å‹ç´¢å¼•ç­‰ï¼Œå»å°½å¯èƒ½çš„ä¸¢å¼ƒæ— æ•ˆçš„å†å²æ ·æœ¬:  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span> (loc.x &lt; <span class="hljs-number">0</span> || loc.x &gt;= width || loc.y &lt; <span class="hljs-number">0</span> || loc.y &gt;= height)<br>    <span class="hljs-comment">//ä¸¢å¼ƒ</span><br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Denoiser_SVGF::isReprjValid</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">float</span> depth,<span class="hljs-type">const</span> <span class="hljs-type">float</span> preDepth,<span class="hljs-type">const</span> <span class="hljs-type">float</span> fwidthZ,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> Float3 normal, <span class="hljs-type">const</span> Float3 preNormal,<span class="hljs-type">const</span> <span class="hljs-type">float</span> fwidthNormal,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> <span class="hljs-type">int</span> meshId,<span class="hljs-type">const</span> <span class="hljs-type">int</span> preMeshId</span></span><br><span class="hljs-params"><span class="hljs-function">)</span> </span>&#123;<br>    <span class="hljs-comment">// check if deviation of depths is acceptable</span><br>    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">fabs</span>(depth - preDepth) / (fwidthZ + <span class="hljs-number">1e-2</span>) &gt; <span class="hljs-number">10.0f</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// check normals for compatibility</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Distance</span>(normal, preNormal) / (fwidthNormal + <span class="hljs-number">1e-2</span>) &gt; <span class="hljs-number">16.0</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// Since the grayscale is the result of direct path-tracing, there is a mutual contribution that can occur without meshid.</span><br>    <span class="hljs-comment">//To mitigate this, add meshid, which can cause other problems such as artifacts.</span><br>    <span class="hljs-keyword">if</span> (meshId != preMeshId)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>ä»£ç ä¸­çš„<code>fwidthZï¼ŒfwidthNormal</code>ä¸ºæ·±åº¦æˆ–æ³•çº¿<a target="_blank" rel="noopener" href="https://developer.download.nvidia.com/cg/fwidth.html">åœ¨xï¼Œyæ–¹å‘ä¸Šçš„åå¯¼å’Œ</a>ã€‚å…¶è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> Float3 normal = frameInfo.<span class="hljs-built_in">m_normal</span>(x, y);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> ddxN = <span class="hljs-built_in">Distance</span>(frameInfo.<span class="hljs-built_in">m_normal</span>(x + <span class="hljs-number">1</span>, y), normal);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> ddyN = <span class="hljs-built_in">Distance</span>(frameInfo.<span class="hljs-built_in">m_normal</span>(x, y + <span class="hljs-number">1</span>), normal);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> fwidthNormal = ddxN + ddyN;<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> depth = frameInfo.<span class="hljs-built_in">m_depth</span>(x, y);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> ddxZ = std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(x + <span class="hljs-number">1</span>, y) - depth);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> ddyZ = std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(x, y + <span class="hljs-number">1</span>) - depth);<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> fwidthZ = ddxZ + ddyZ;<br></code></pre></td></tr></table></figure>
<p><code>Temporal Filter</code>å…¬å¼ä¸­çš„$\alpha$æ˜¯æ ¹æ®å¯»æ‰¾å†å²æ ·æœ¬çš„æˆåŠŸæ¬¡æ•°æ¥å®šçš„ï¼Œæœ€å¤§ä¸º<code>1</code>ï¼Œæœ€å°è‡ªå®šï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// this adjusts the alpha for the case where insufficient history is available.</span><br><span class="hljs-comment">// It boosts the temporal accumulation to give the samples equal weights in the beginning.</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> alpha = success ? std::<span class="hljs-built_in">fmax</span>(m_Alpha, <span class="hljs-number">1.0</span> / historyLength) : <span class="hljs-number">1.0</span>;<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> alphaMoments = success ? std::<span class="hljs-built_in">fmax</span>(m_MomentsAlpha, <span class="hljs-number">1.0</span> / historyLength) : <span class="hljs-number">1.0</span>;<br><br><span class="hljs-comment">// compute first two moments of luminance</span><br>Float3 moments;<br>moments.x = <span class="hljs-built_in">Luminance</span>(illumination);<br>moments.y = moments.x * moments.x;<br><br><span class="hljs-comment">// temporal integration of the moments</span><br>moments = <span class="hljs-built_in">Lerp</span>(prevMoments, moments, alphaMoments);<br><br><span class="hljs-type">float</span> variance = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">0.f</span>, moments.y - moments.x * moments.x);<br><span class="hljs-comment">// temporal integration of illumination</span><br><span class="hljs-built_in">m_accColor</span>(x, y) = <span class="hljs-built_in">Lerp</span>(prevIllumination, illumination, alpha);<br><span class="hljs-built_in">m_curFrameVariance</span>(x,y) = variance;<br><span class="hljs-built_in">m_moments</span>(x, y) = moments;<br><span class="hljs-built_in">m_tmpHisLength</span>(x,y) = historyLength;<br></code></pre></td></tr></table></figure>
<p>æ˜¯çš„ï¼Œä¸ä»…ä»…æ˜¯é¢œè‰²éœ€è¦<code>Temporal Filter</code>ï¼Œ<code>Moments</code>ä¹Ÿéœ€è¦ï¼Œæ–¹å·®çš„è®¡ç®—ä¾èµ–å®ƒï¼Œé€šè¿‡åœ¨æ—¶é—´ä¸Šç§¯ç´¯<code>Luminance</code>çš„<code>First</code>å’Œ<code>Second Moment</code>, $\mu^{\prime}<em>{1i}$å’Œ $\mu^{\prime}</em>{2i}$ï¼Œæ–¹å·®çš„è®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>\sigma^{\prime2}<em>{i}&#x3D;\mu^{\prime}</em>{2i}-\mu^{\prime2}_{1i}<br>$$<br><code>Moments Temporal Filter</code>å¯¹åº”ä¸Šå›¾ä¸­ç´«è‰²å—çš„å¤„ç†è¿‡ç¨‹ã€‚</p>
<h3 id="Variance-Estimation"><a href="#Variance-Estimation" class="headerlink" title="Variance Estimation"></a>Variance Estimation</h3><p>ç”±äºæ‘„åƒæœºè¿åŠ¨ã€å½±è§†æ•ˆæœå’Œè§†å£å˜æ¢å‡ºç•Œéƒ½ä¼šå¯¼è‡´<code>disocclusionäº‹ä»¶</code>ï¼Œä»è€Œå½±å“æ–¹å·®ä¼°è®¡çš„è´¨é‡ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å¯¹å‡ºç°<code>disocclusionäº‹ä»¶</code>çš„å‰<code>4</code>å¸§è¿›è¡Œç©ºé—´ä¸Šçš„<code>7 * 7</code>åŒè¾¹æ»¤æ³¢ï¼Œè¯¥æ»¤æ³¢æ ¸æƒé‡ç”±æ·±åº¦ï¼Œæ³•çº¿ï¼Œç°åº¦å€¼å†³å®šã€‚åœ¨æ­¤æœŸé—´ä¹Ÿå¯¹<code>illumination</code>åšä¸€æ¬¡<code>Filter</code>ï¼Œä¸¤è€…æ˜¯åŒæ—¶è¿›è¡Œï¼Œå‡ ä¹æ²¡æœ‰é¢å¤–å¼€é”€ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Denoiser_SVGF::VarianceEstimation</span><span class="hljs-params">(<span class="hljs-type">const</span> FrameInfo &amp;frameInfo)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> height = frameInfo.m_beauty.m_height;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> width = frameInfo.m_beauty.m_width;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> radius = <span class="hljs-number">3</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br><br>            <span class="hljs-type">const</span> Float3 ipos = <span class="hljs-built_in">Float3</span>(x, y, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">float</span> h = <span class="hljs-built_in">m_historyLength</span>(ipos.x, ipos.y);<br>            <span class="hljs-keyword">if</span> (h &lt; <span class="hljs-number">4.0</span>)&#123;<span class="hljs-comment">// not enough temporal history available</span><br>                <span class="hljs-type">float</span> sumWIllumination = <span class="hljs-number">0.0</span>;<br>                Float3 sumIllumination = <span class="hljs-built_in">Float3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>                Float3 sumMoments = <span class="hljs-built_in">Float3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>                <span class="hljs-type">const</span> Float3 illuminationCenter = <span class="hljs-built_in">m_accColor</span>(ipos.x, ipos.y);<br>                <span class="hljs-type">const</span> <span class="hljs-type">float</span> lIlluminationCenter = <span class="hljs-built_in">Luminance</span>(illuminationCenter);<br><br>                <span class="hljs-type">const</span> Float3 nCenter = frameInfo.<span class="hljs-built_in">m_normal</span>(ipos.x, ipos.y);<br>                <span class="hljs-type">const</span> <span class="hljs-type">float</span> zCenter = frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x, ipos.y);<br>                <span class="hljs-comment">// depth-gradient estimation from screen-space derivatives</span><br>                <span class="hljs-type">float</span> dgrad_x = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">1e-8</span>, std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x + <span class="hljs-number">1</span>, ipos.y) - zCenter)) * <span class="hljs-number">3.0</span>;<br>                <span class="hljs-type">float</span> dgrad_y = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">1e-8</span>, std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x, ipos.y + <span class="hljs-number">1</span>) - zCenter)) * <span class="hljs-number">3.0</span>;<br>                <span class="hljs-type">float</span> maxDgrad = std::<span class="hljs-built_in">fmax</span>(dgrad_x, dgrad_y);<br><br>                <span class="hljs-comment">// compute first and second moment spatially. This code also applies cross-bilateral</span><br>                <span class="hljs-comment">// filtering on the input illumination.</span><br><br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yy = -radius; yy &lt;= radius; yy++) &#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xx = -radius; xx &lt;= radius; xx++) &#123;<br>                        <span class="hljs-type">const</span> Float3 p = ipos + <span class="hljs-built_in">Float3</span>(xx, yy,<span class="hljs-number">0</span>);<br>                        <span class="hljs-type">bool</span> inside = <span class="hljs-literal">false</span>;<br>                        <span class="hljs-keyword">if</span> (p.x &gt;= <span class="hljs-number">0</span> &amp;&amp; p.y &gt;= <span class="hljs-number">0</span> &amp;&amp; p.x &lt; width &amp;&amp; p.y &lt; height)<br>                            inside = <span class="hljs-literal">true</span>;<br><br>                        <span class="hljs-keyword">if</span> (inside) &#123;<br>                            <span class="hljs-type">const</span> Float3 illuminationP = <span class="hljs-built_in">m_accColor</span>(p.x, p.y);<br>                            <span class="hljs-type">const</span> Float3 momentsP = <span class="hljs-built_in">m_moments</span>(p.x, p.y);<br>                            <span class="hljs-type">const</span> <span class="hljs-type">float</span> lIlluminationP = <span class="hljs-built_in">Luminance</span>(illuminationP);<br>                            <span class="hljs-type">const</span> <span class="hljs-type">float</span> zP = frameInfo.<span class="hljs-built_in">m_depth</span>(p.x, p.y);<br>                            <span class="hljs-type">const</span> Float3 nP = frameInfo.<span class="hljs-built_in">m_normal</span>(p.x,p.y);<br><br>                            <span class="hljs-comment">// calculate the normal, depth and luminance weights</span><br>                            <span class="hljs-type">float</span> nw = <span class="hljs-built_in">normalWeight</span>(nCenter, nP);<br>                            <span class="hljs-type">float</span> dw = <span class="hljs-built_in">depthWeight</span>(zCenter, zP, maxDgrad,xx, yy);<br>                            <span class="hljs-type">float</span> lw = <span class="hljs-built_in">luminanceWeight</span>(lIlluminationCenter,<br>                                                       lIlluminationP, <span class="hljs-number">1.0</span>);<br>                            <span class="hljs-type">float</span> w = nw * dw * lw;<br>                            sumWIllumination += w;<br>                            sumIllumination += illuminationP * w;<br>                            sumMoments += momentsP * w;<br>                        &#125;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// Clamp sum to &gt;0 to avoid NaNs.</span><br>                sumWIllumination = std::<span class="hljs-built_in">fmax</span>(sumWIllumination, <span class="hljs-number">1e-6</span>f);<br>                sumIllumination /= sumWIllumination;<br>                sumMoments /= sumWIllumination;<br><br>                <span class="hljs-comment">// compute variance using the first and second moments</span><br>                <span class="hljs-type">float</span> variance = sumMoments.y - sumMoments.x * sumMoments.x;<br><br>                <span class="hljs-comment">// give the variance a boost for the first frames</span><br>                <span class="hljs-keyword">if</span> (h != <span class="hljs-number">0</span>)<br>                    variance *= <span class="hljs-number">4.0</span> / h;<br><br>                <span class="hljs-built_in">m_tmpColor</span>(ipos.x, ipos.y) = sumIllumination;<br>                <span class="hljs-built_in">m_curFrameVariance</span>(ipos.x, ipos.y) = variance;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// do nothing</span><br>                <span class="hljs-built_in">m_tmpColor</span>(ipos.x, ipos.y) = <span class="hljs-built_in">m_accColor</span>(ipos.x, ipos.y);<br>            &#125;<br>        &#125;<br>    &#125;<br>    std::<span class="hljs-built_in">swap</span>(m_tmpColor, m_accColor);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æœ¬è´¨ä¸Šæ¥è¯´æˆ‘ä»¬åªå¯¹å‡ºç°äº†<code>disocclusionäº‹ä»¶</code>çš„å‰å‡ å¸§è¿›è¡Œç©ºé—´ä¸Šçš„æ–¹å·®ä¼°è®¡ï¼Œç›´åˆ°æ—¶é—´ç´¯ç§¯æ”¶é›†äº†è¶³å¤Ÿçš„æ•°æ®æ¥è¿›è¡Œç¨³å®šçš„ä¼°è®¡ã€‚æƒé‡è®¡ç®—å‡½æ•°åœ¨ä¸‹ä¸€èŠ‚è®²ã€‚</p>
<h3 id="Edge-Stopping-Functions"><a href="#Edge-Stopping-Functions" class="headerlink" title="Edge-Stopping Functions"></a>Edge-Stopping Functions</h3><h4 id="Depth"><a href="#Depth" class="headerlink" title="Depth"></a>Depth</h4><p>çœŸå®çš„åœºæ™¯åœ¨å‡ ä½•å°ºåº¦ä¸Šæœ‰å¾ˆå¤§çš„å˜åŒ–ï¼Œå°¤å…¶æ˜¯åœ¨å¼€é˜”çš„æ™¯è§‚ä¸­ã€‚ä½¿å¾—å…¨å±€è¾¹ç¼˜åœæ­¢å‡½æ•°ä¸å—æ§åˆ¶ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯¹è¡¨é¢æ·±åº¦è®¾å®šäº†ä¸€ä¸ªå±€éƒ¨çº¿æ€§æ¨¡å‹ï¼Œå¹¶ä¸”æµ‹é‡å…¶è¡¨é¢æ·±åº¦çš„åå·®ã€‚æˆ‘ä»¬ä½¿ç”¨å‰ªåˆ‡ç©ºé—´æ·±åº¦ï¼ˆåªè¦æ˜¯çº¿æ€§æ·±åº¦å³å¯ï¼Œæœ¬æ–‡ä½¿ç”¨çš„æ·±åº¦ä¿¡æ¯åº”è¯¥å±äºview spaceï¼‰çš„å±å¹•ç©ºé—´åå¯¼æ•°æ¥ä¼°è®¡å±€éƒ¨æ·±åº¦æ¨¡å‹ã€‚è¯¥æƒé‡å‡½æ•°ä¸ºï¼š<br>$$<br>w_{z}&#x3D;exp(-\dfrac{\left| z(p)-z(q) \right|}{\sigma_{z} \left| \nabla z(p) \cdot (p-q) \right|+\epsilon})<br>$$<br>æ ¹æ®ç»éªŒ$\sigma_{z}$ä¸º<code>1.0</code>å¯ä»¥å¾—åˆ°æ¯”è¾ƒå¥½çš„æ•ˆæœï¼Œç”¨æ¥æ§åˆ¶æ·±åº¦çš„å½±å“æ˜¯å¤§è¿˜æ˜¯å°ã€‚<br>$\nabla z$æ˜¯å±å¹•åæ ‡ä¸‹æ·±åº¦çš„æ¢¯åº¦ï¼Œ$\epsilon$æ˜¯é˜²æ­¢é™¤ä»¥é›¶ã€‚ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">Denoiser_SVGF::depthWeight</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">float</span> center_depth, <span class="hljs-type">const</span> <span class="hljs-type">float</span> depth,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">const</span> <span class="hljs-type">float</span> dgrad, </span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-type">const</span> <span class="hljs-type">float</span> offset_x, <span class="hljs-type">const</span> <span class="hljs-type">float</span> offset_y)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> eps = <span class="hljs-number">1e-8</span>;<br>    Float3 offset&#123;offset_x, offset_y,<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">exp</span>( (-std::<span class="hljs-built_in">fabs</span>(center_depth - depth)) / (std::<span class="hljs-built_in">fabs</span>( m_phiDepth * dgrad * <span class="hljs-built_in">Length</span>(offset)+ eps)) );<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æœ¬åº”è¯¥æ˜¯$\nabla z(p) \cdot (p-q)$å³æ¢¯åº¦ç‚¹ä¹˜åç§»ï¼Œæ¢¯åº¦å’Œåç§»éƒ½æ˜¯äºŒç»´å‘é‡ã€‚ä½†æ˜¯è¿™é‡Œçš„å†™æ³•æ˜¯ï¼Œå–æ¢¯åº¦ä¸­è¾ƒå¤§çš„ä¸€ä¸ªåå¯¼æ•°ä½œä¸ºä¸€ç»´æ¢¯åº¦å€¼ ç„¶åä¹˜ä¸Š åç§»å‘é‡çš„é•¿åº¦ã€‚å…¶ç»“æœç›¸å·®ä¸å¤§ï¼Œè‡³äºè®ºæ–‡æºç ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç®—ç›®å‰ä¸å¾—è€ŒçŸ¥ï¼Œä¸¤ç§ç®—æ³•å¾—åˆ°çš„ç»“æœæˆ‘éƒ½çœ‹äº†ä¸€ä¸‹å‡ ä¹æ²¡åŒºåˆ«ï¼Œè¯»è€…æœ‰å…´è¶£å¯ä»¥å»è¯•ä¸‹ã€‚</p>
<h4 id="Normal"><a href="#Normal" class="headerlink" title="Normal"></a>Normal</h4><p>æ³•çº¿æƒé‡æ¯”è¾ƒç®€å•ï¼Œæ³•çº¿å¤¹è§’å°æƒé‡å¤§ï¼Œåä¹‹æƒé‡å°ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>w_{n}&#x3D;max(0,n(p)\cdot n(q))^{\sigma_{n}}<br>$$<br>$\sigma_{n}$æŒ‰ç»éªŒæ¥è¯´ä¸º<code>128</code>æ•ˆæœæ¯”è¾ƒå¥½ï¼Œç”¨æ¥æ§åˆ¶æ³•çº¿çš„æƒé‡ã€‚<br>ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">Denoiser_SVGF::normalWeight</span><span class="hljs-params">(<span class="hljs-type">const</span> Float3 &amp;center_normal, <span class="hljs-type">const</span> Float3 &amp;normal)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">pow</span>(std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">0.0</span>, <span class="hljs-built_in">Dot</span>(center_normal, normal)), m_phiNormal);<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="Luminance"><a href="#Luminance" class="headerlink" title="Luminance"></a>Luminance</h4><p>äº®åº¦è¾¹ç¼˜åœæ­¢å‡½æ•°çš„ä¸€ä¸ªå…³é”®æ–¹é¢æ˜¯å®ƒèƒ½å¤Ÿé€šè¿‡å…¶å±€éƒ¨æ ‡å‡†å·®é‡æ–°å½’ä¸€åŒ–äº®åº¦ï¼Œæ¥è‡ªåŠ¨é€‚åº”æ‰€æœ‰äº®åº¦ã€‚ä½†æ˜¯ï¼Œåœ¨ä½æ ·æœ¬æ•°ä¸‹æ“ä½œä¼šåœ¨æˆ‘ä»¬å¯¹æ–¹å·®å’Œæ ‡å‡†å·®çš„ä¼°è®¡ä¸­å¼•å…¥ä¸ç¨³å®šæ€§ï¼›è¿™å¯èƒ½ä¼šå¼•å…¥èµ°æ ·ç°è±¡ã€‚ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>3 * 3</code>é«˜æ–¯æ ¸å¯¹æ–¹å·®å›¾åƒè¿›è¡Œé¢„æ»¤æ³¢ï¼Œè¿™æ˜¾è‘—æé«˜äº†é‡å»ºè´¨é‡ã€‚äº®åº¦è¾¹ç¼˜åœæ­¢å‡½æ•°å˜ä¸ºï¼š<br>$$<br>w_{l}&#x3D;exp(-\dfrac{|l_{i}(p)-l_{i}(q)|}{\sigma_{l}\sqrt{g_{3\times3}(Var(l_{i}(p)))}+\epsilon})<br>$$<br>æ ¹æ®ç»éªŒ$\sigma_{l}$ä¸º<code>4</code>æ•ˆæœæ¯”è¾ƒå¥½ï¼Œç”¨äºæ§åˆ¶äº®åº¦çš„å½±å“ã€‚<br>ç”±äºäº®åº¦æ–¹å·®å¾€å¾€ä¼šéšç€åç»­è¿­ä»£è€Œå‡å°‘ï¼Œå› æ­¤$w_{l}$çš„å½±å“ä¼šéšç€æ¯æ¬¡è¿­ä»£è€Œå¢åŠ ï¼Œä»è€Œé˜²æ­¢è¿‡åº¦æ¨¡ç³Šã€‚<br>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªé«˜æ–¯é¢„æ»¤æ³¢å™¨ä»…ç”¨äºé©±åŠ¨äº®åº¦è¾¹ç¼˜åœæ­¢å‡½æ•°ï¼Œè€Œä¸ç”¨äºä¼ æ’­åˆ°å°æ³¢å˜æ¢ä¸‹çš„ä¸€æ¬¡è¿­ä»£çš„æ–¹å·®ä¸­ã€‚<br>ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">Denoiser_SVGF::computeVarianceCenter</span><span class="hljs-params">(<span class="hljs-type">const</span> Float3&amp; ipos,<span class="hljs-type">const</span> <span class="hljs-type">int</span> width,<span class="hljs-type">const</span> <span class="hljs-type">int</span> height)</span> </span>&#123;<br>    <span class="hljs-type">float</span> sum = <span class="hljs-number">0.f</span>;<br>    <br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> kernel[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>] = &#123;&#123;<span class="hljs-number">1.0</span> / <span class="hljs-number">4.0</span>, <span class="hljs-number">1.0</span> / <span class="hljs-number">8.0</span>&#125;, &#123;<span class="hljs-number">1.0</span> / <span class="hljs-number">8.0</span>, <span class="hljs-number">1.0</span> / <span class="hljs-number">16.0</span>&#125;&#125;;<br><br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> radius = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yy = -radius; yy &lt;= radius; yy++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xx = -radius; xx &lt;= radius; xx++) &#123;<br>            Float3 p = ipos + <span class="hljs-built_in">Float3</span>(xx, yy,<span class="hljs-number">0</span>);<br>            p.x = std::<span class="hljs-built_in">fmin</span>(std::<span class="hljs-built_in">fmax</span>(p.x, <span class="hljs-number">0.0</span>), width - <span class="hljs-number">1.0</span>);<br>            p.y = std::<span class="hljs-built_in">fmin</span>(std::<span class="hljs-built_in">fmax</span>(p.y, <span class="hljs-number">0.0</span>), height - <span class="hljs-number">1.0</span>);<br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> k = kernel[std::<span class="hljs-built_in">abs</span>(xx)][std::<span class="hljs-built_in">abs</span>(yy)];<br>            sum += <span class="hljs-built_in">m_curFrameVariance</span>(p.x,p.y) * k;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> variance = <span class="hljs-built_in">computeVarianceCenter</span>(ipos,width,height);<br><br><span class="hljs-function"><span class="hljs-type">float</span> <span class="hljs-title">Denoiser_SVGF::luminanceWeight</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">float</span> center_lum, <span class="hljs-type">const</span> <span class="hljs-type">float</span> lum,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-type">const</span> <span class="hljs-type">float</span> variance</span></span><br><span class="hljs-params"><span class="hljs-function">)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> eps = <span class="hljs-number">1e-10</span>;<br>    <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">exp</span>( (-std::<span class="hljs-built_in">fabs</span>(center_lum - lum)) /<br>               (m_phiColor * std::<span class="hljs-built_in">sqrt</span>(std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">0.0</span>, variance) + eps)));<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>kernel</code>æ˜¯ $\sigma$ä¸º0.8çš„é«˜æ–¯æ»¤æ³¢æ ¸ï¼Œä¸Šæ–‡æœ‰æåˆ°ã€‚</p>
<h3 id="Edge-avoiding-A-trous-wavelet-transform"><a href="#Edge-avoiding-A-trous-wavelet-transform" class="headerlink" title="Edge-avoiding A-trous wavelet transform"></a>Edge-avoiding A-trous wavelet transform</h3><p><code>Reconstruction Filter</code>çš„æœ€åæœ€é‡è¦çš„ä¸€æ­¥ï¼Œ<code>Reproject</code>ï¼ˆTemporal Filteringï¼‰ä»¥åŠ<code>Variance Estimation</code>éƒ½æ˜¯ä¸ºäº†è¿™ä¸€æ­¥åšé“ºå«ã€‚ä¸Šæ–‡è¯´åˆ°å…‰æ …åŒ–çš„<code>G-buffer</code>ä¸åŒ…å«éšæœºå™ªå£°ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨<code>G-buffer</code>æ¥å®šä¹‰è¾¹ç¼˜åœæ­¢å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å¯ä»¥ç”¨æ¥é‰´åˆ«åƒç´ æ˜¯å¦åœ¨åŒä¸€è¡¨é¢ï¼Œä»è€Œè¿›è¡Œç›¸äº’è´¡çŒ®ã€‚è¯¥è®ºæ–‡çš„å®ç°ä¹Ÿä½¿ç”¨äº†<code>A-trous wavelet</code>æ–¹æ³•ï¼ˆä¸Šæ–‡æœ‰æåŠï¼‰ï¼Œæƒé‡å‡½æ•° $w(p,q)$ä½¿ç”¨çš„æ˜¯ä¸€ä¸ª<code>5 * 5</code>çš„è”åˆåŒè¾¹æ»¤æ³¢æ ¸ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>\hat{c}<em>{i+1(p)}&#x3D;\dfrac{\sum</em>{q\in\Omega}h(q)\cdot w(p,q)\cdot \hat{c}<em>{i}(q)}{\sum</em>{q\in\Omega}h(q)\cdot w(p,q)}<br>$$<br>$h(q)$æ˜¯ä¸€ä¸ªç±»é«˜æ–¯æ»¤æ³¢æ ¸ï¼Œè®ºæ–‡å’Œæœ¬æ­¤å®ç°ä½¿ç”¨çš„ $h(q)$æƒé‡ç³»æ•°ä¸å¤ªä¸€æ ·ä¸è¿‡æ²¡å…³ç³»ï¼Œéƒ½æ˜¯éšè·ç¦»è¡°å‡çš„å‡½æ•°å°±è¡Œã€‚ $\Omega$æ˜¯æ»¤æ³¢å™¨ä¸­è¢«æ”¶é›†çš„åƒç´ é›†åˆï¼ˆå°±æ˜¯æ¯ä¸€è¶Ÿä¸­è¸©åˆ°çš„åƒç´ ç‚¹çš„é›†åˆï¼‰<br>$\hat{c}<em>{i+1(p)}$å’Œ $\hat{c}</em>{i(p)}$åˆ™æ˜¯æ»¤æ³¢åçš„è¾“å‡ºé¢œè‰²ä»¥åŠæ»¤æ³¢å‰çš„è¾“å…¥é¢œè‰²ã€‚  </p>
<p>è¯¥è®ºæ–‡æ–°é¢–çš„æƒé‡å‡½æ•° $w(p,q)$ä½¿ç”¨çš„æ˜¯æ·±åº¦ã€ä¸–ç•Œç©ºé—´æ³•çº¿ä»¥åŠ<code>Filter</code>åè¾“å…¥çš„<code>Luminance</code>ï¼Œå…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>w_{i}(p,q)&#x3D;w_{z}\cdot w_{n}\cdot w_{l}<br>$$<br>è¿™å‡ ä¸ªå‡½æ•°åœ¨ä¸Šä¸€èŠ‚æˆ‘å·²ç»è¯¦ç»†è§£é‡Šäº†ã€‚</p>
<p>åœ¨åº”ç”¨<code>A-trous wavelet</code>è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šåŸºäºäº®åº¦æ–¹å·®çš„å±€éƒ¨ä¼°è®¡æ¥è°ƒæ•´äº®åº¦è¾¹ç¼˜åœæ­¢å‡½æ•°ã€‚ç„¶åæ ¹æ®<code>A-trous wavelet</code>æ¥<code>Filter</code>æ—¶é—´ä¸Šç´¯è®¡çš„é¢œè‰²ï¼Œå¹¶å‡è®¾æˆ‘ä»¬é‡‡æ ·åˆ°çš„æ–¹å·®æ ·æœ¬æ˜¯ä¸ç›¸å…³çš„ï¼ˆç›¸äº’ç‹¬ç«‹ï¼‰ï¼Œåˆ™æˆ‘ä»¬å‘ä¸‹ä¸€æ¬¡<code>A-trous wavelet</code>ä¼ é€’æ–¹å·®çš„å…¬å¼ä¸ºï¼š<br>$$<br>Var(\hat{c}<em>{i+1(p)})&#x3D;\dfrac{\sum</em>{q\in\Omega}h(q)^{2}\cdot w(p,q)^{2}\cdot Var(\hat{c}<em>{i}(q))}{(\sum</em>{q\in\Omega}h(q)\cdot w(p,q))^{2}}<br>$$<br>æˆ‘ä»¬ä¼šä½¿ç”¨è¿™ä¸ªç»“æœæ¥æ§åˆ¶ä¸‹ä¸€æ¬¡<code>A-trous wavelet</code>çš„è¾¹ç¼˜åœæ­¢å‡½æ•°ã€‚<br>ä»£ç å®ç°å¦‚ä¸‹ï¼š  </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Denoiser_SVGF::ATrousWaveletFilter</span><span class="hljs-params">(<span class="hljs-type">const</span> FrameInfo &amp;frameInfo,<span class="hljs-type">const</span> <span class="hljs-type">int</span> stepSize)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> height = frameInfo.m_beauty.m_height;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> width = frameInfo.m_beauty.m_width;<br>    <span class="hljs-type">const</span> <span class="hljs-type">float</span> kernelWeights[<span class="hljs-number">3</span>] = &#123;<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span> / <span class="hljs-number">3.0</span>, <span class="hljs-number">1.0</span> / <span class="hljs-number">6.0</span>&#125;;<br><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> omp parallel for</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) &#123;<br>            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> SVGF</span><br>            <span class="hljs-type">const</span> Float3 ipos = <span class="hljs-built_in">Float3</span>(x, y, <span class="hljs-number">0</span>);<br>            <span class="hljs-type">const</span> Float3 illuminationCenter = <span class="hljs-built_in">m_accColor</span>(ipos.x, ipos.y);<br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> lIlluminationCenter = <span class="hljs-built_in">Luminance</span>(illuminationCenter);<br><br>            <span class="hljs-comment">//variance,filtered using 3 * 3 gaussin blur</span><br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> var = <span class="hljs-built_in">computeVarianceCenter</span>(ipos,width,height);<br><br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> zCenter = frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x, ipos.y);<br>            <span class="hljs-type">const</span> Float3 nCenter = frameInfo.<span class="hljs-built_in">m_normal</span>(ipos.x, ipos.y);<br><br>            <span class="hljs-type">float</span> dgrad_x = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">1e-8</span>, std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x + <span class="hljs-number">1</span>, ipos.y) - zCenter)) * stepSize;<br>            <span class="hljs-type">float</span> dgrad_y = std::<span class="hljs-built_in">fmax</span>(<span class="hljs-number">1e-8</span>, std::<span class="hljs-built_in">fabs</span>(frameInfo.<span class="hljs-built_in">m_depth</span>(ipos.x, ipos.y + <span class="hljs-number">1</span>) - zCenter)) * stepSize;<br>            <br>            <span class="hljs-type">float</span> maxDgrad = std::<span class="hljs-built_in">fmax</span>(dgrad_x, dgrad_y);<br><br>            <span class="hljs-comment">//explicitly store/accumulate center pixel with weight 1 to prevent issues</span><br>            <span class="hljs-comment">//with the edge-stopping functions</span><br>            <span class="hljs-type">float</span> sumWIllumination = <span class="hljs-number">1.0</span>;<br>            <span class="hljs-type">float</span> sumVariance = <span class="hljs-built_in">m_curFrameVariance</span>(ipos.x, ipos.y);<br>            Float3 sumIllumination = illuminationCenter;<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yy = <span class="hljs-number">-2</span>; yy &lt;= <span class="hljs-number">2</span>; yy++) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xx = <span class="hljs-number">-2</span>; xx &lt;= <span class="hljs-number">2</span>; xx++) &#123;<br>                    <span class="hljs-type">const</span> Float3 p = ipos + <span class="hljs-built_in">Float3</span>(xx, yy,<span class="hljs-number">0</span>) * stepSize;<br>                    <span class="hljs-type">bool</span> inside = <span class="hljs-literal">false</span>;<br>                    <span class="hljs-keyword">if</span> (p.x &gt;= <span class="hljs-number">0</span> &amp;&amp; p.y &gt;= <span class="hljs-number">0</span> &amp;&amp; p.x &lt; width &amp;&amp; p.y &lt; height)<br>                        inside = <span class="hljs-literal">true</span>;<br><br>                    <span class="hljs-type">const</span> <span class="hljs-type">float</span> kernel = kernelWeights[std::<span class="hljs-built_in">abs</span>(xx)] * kernelWeights[std::<span class="hljs-built_in">abs</span>(yy)];<br><br>                    <span class="hljs-keyword">if</span> (inside &amp;&amp;<br>                        (xx != <span class="hljs-number">0</span> ||<br>                         yy != <span class="hljs-number">0</span>)) <span class="hljs-comment">// skip center pixel, it is already accumulated</span><br>                    &#123;<br>                        <span class="hljs-type">const</span> Float3 illuminationP = <span class="hljs-built_in">m_accColor</span>(p.x,p.y);<br>                        <span class="hljs-type">const</span> <span class="hljs-type">float</span> lIlluminationP = <span class="hljs-built_in">Luminance</span>(illuminationP);<br>                        <span class="hljs-type">const</span> <span class="hljs-type">float</span> zP = frameInfo.<span class="hljs-built_in">m_depth</span>(p.x,p.y);<br>                        <span class="hljs-type">const</span> Float3 nP = frameInfo.<span class="hljs-built_in">m_normal</span>(p.x,p.y);<br>                        <span class="hljs-type">const</span> <span class="hljs-type">float</span> varP = <span class="hljs-built_in">m_curFrameVariance</span>(p.x,p.y);<br><br>                        <span class="hljs-comment">// calculate the normal, depth and luminance weights</span><br>                        <span class="hljs-type">float</span> nw = <span class="hljs-built_in">normalWeight</span>(nCenter, nP);<br>                        <span class="hljs-type">float</span> dw = <span class="hljs-built_in">depthWeight</span>(zCenter, zP, maxDgrad, xx, yy);<br>                        <span class="hljs-type">float</span> lw = <span class="hljs-built_in">luminanceWeight</span>(lIlluminationCenter, lIlluminationP, var);<br><br>                        <span class="hljs-type">const</span> <span class="hljs-type">float</span> wIllumination = nw * dw * lw * kernel;<br><br>                        <span class="hljs-comment">// alpha channel contains the variance, therefore the weights need</span><br>                        <span class="hljs-comment">// to be squared, see paper for the formula(4.3 (1) (2))</span><br>                        sumWIllumination += wIllumination;<br>                        sumIllumination += <span class="hljs-built_in">Float3</span>(wIllumination) * illuminationP;<br>                        sumVariance += wIllumination * wIllumination * varP;<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// renormalization is different for variance, check paper for the formula</span><br>            <span class="hljs-built_in">m_tmpColor</span>(ipos.x, ipos.y) = sumIllumination / sumWIllumination;<br>            <span class="hljs-built_in">m_tmpCurFrameVar</span>(ipos.x, ipos.y) = sumVariance / (sumWIllumination * sumWIllumination);<br>        &#125;<br>    &#125;<br>    std::<span class="hljs-built_in">swap</span>(m_tmpColor,m_accColor);<br>    std::<span class="hljs-built_in">swap</span>(m_tmpCurFrameVar,m_curFrameVariance);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>Step Size</code>ä¸º$2^{i},i\in([0,4] \cap \mathbb{Z})$  </p>
<p>Cornell Boxæ•ˆæœå¦‚ä¸‹ï¼š<br><img src="/img/00019/box-svgf.gif" srcset="/img/loading.gif" lazyload alt="1"><br>Pink Roomæ•ˆæœå¦‚ä¸‹:<br><img src="/img/00019/pinkroom-svgf.gif" srcset="/img/loading.gif" lazyload alt="2"><br>è¿™æ˜¯é™å™ªå‰çš„å›¾ç‰‡ï¼š<br><img src="/img/00019/image-10.png" srcset="/img/loading.gif" lazyload alt="Alt text"><br><img src="/img/00019/image-11.png" srcset="/img/loading.gif" lazyload alt="Alt text">  </p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Games202/" class="category-chain-item">Games202</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Games202 Hw5 JBF and SVGF</div>
      <div>https://howl144.github.io/2023/07/21/00019. Games202 Hw5/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Deng Ye</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>July 21, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/19/00006.%20c++%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B%E4%B9%8B%E8%99%9A%E8%A1%A8%EF%BC%8C%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88%E7%AD%89/" title="c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†">
                        <span class="hidden-mobile">c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        Views: 
        <span id="leancloud-site-pv"></span>
        
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        Visitors: 
        <span id="leancloud-site-uv"></span>
        
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
