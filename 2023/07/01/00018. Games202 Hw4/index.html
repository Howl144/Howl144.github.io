

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="elv6HP48K6bVVMeBdbFYkmoi4IBF6JVtH0WaCgUXRNY" />
  <link rel="apple-touch-icon" sizes="76x76" href="/img/rose.png">
  <link rel="icon" href="/img/rose.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Deng Ye">
  <meta name="keywords" content="">
  
    <meta name="description" content="æœ€ç»ˆæ•ˆæœå›¾ æ¯ç»„ä¸‹é¢ä¸€æ’çƒæ˜¯æ²¡ç”¨Kulla Contyçš„å¯¹ç…§ç»„ï¼Œæ‰€æœ‰çƒçš„é‡‘å±åº¦éƒ½ä¸º1,ç²—ç³™åº¦æœ€å°0.05ï¼Œæœ€å¤§0.95,å¯ä»¥æ˜æ˜¾çœ‹åˆ°å¯¹ç…§ç»„éšç€ç²—ç³™åº¦å¢å¤§ï¼Œä¼šè¶Šæ¥è¶Šæš—ï¼Œè€Œä½¿ç”¨äº†Kulla Contyçš„å®éªŒç»„ï¼Œäº®åº¦ä¸ä¼šéšç€ç²—ç³™åº¦çš„å¢åŠ è€Œè¡°å‡ï¼Œä¸ºäº†ä½¿ç°è±¡æ›´æ˜æ˜¾è¿™é‡Œå§HDR tonemappingåŠŸèƒ½ç¦ç”¨äº†ï¼  ä¸‹é¢æ˜¯é‡‘æè´¨çš„Kulla-Conty Approximationæ•ˆæœï¼š  ä½œä¸šæ€»è§ˆ">
<meta property="og:type" content="article">
<meta property="og:title" content="Games202 Hw4 IBL and Kulla Conty">
<meta property="og:url" content="https://howl144.github.io/2023/07/01/00018.%20Games202%20Hw4/index.html">
<meta property="og:site_name" content="ğŸ¥°Howl&#39;s Blog">
<meta property="og:description" content="æœ€ç»ˆæ•ˆæœå›¾ æ¯ç»„ä¸‹é¢ä¸€æ’çƒæ˜¯æ²¡ç”¨Kulla Contyçš„å¯¹ç…§ç»„ï¼Œæ‰€æœ‰çƒçš„é‡‘å±åº¦éƒ½ä¸º1,ç²—ç³™åº¦æœ€å°0.05ï¼Œæœ€å¤§0.95,å¯ä»¥æ˜æ˜¾çœ‹åˆ°å¯¹ç…§ç»„éšç€ç²—ç³™åº¦å¢å¤§ï¼Œä¼šè¶Šæ¥è¶Šæš—ï¼Œè€Œä½¿ç”¨äº†Kulla Contyçš„å®éªŒç»„ï¼Œäº®åº¦ä¸ä¼šéšç€ç²—ç³™åº¦çš„å¢åŠ è€Œè¡°å‡ï¼Œä¸ºäº†ä½¿ç°è±¡æ›´æ˜æ˜¾è¿™é‡Œå§HDR tonemappingåŠŸèƒ½ç¦ç”¨äº†ï¼  ä¸‹é¢æ˜¯é‡‘æè´¨çš„Kulla-Conty Approximationæ•ˆæœï¼š  ä½œä¸šæ€»è§ˆ">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://howl144.github.io/img/00018/result.png">
<meta property="article:published_time" content="2023-06-30T23:34:10.000Z">
<meta property="article:modified_time" content="2023-08-23T14:54:00.890Z">
<meta property="article:author" content="Deng Ye">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://howl144.github.io/img/00018/result.png">
  
  
  
  <title>Games202 Hw4 IBL and Kulla Conty - ğŸ¥°Howl&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"howl144.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"MY3hK2j6KKqPNCHItX2Yargj-gzGzoHsz","app_key":"U0dZRBpPFA46kRmFcsltQFF2","server_url":"https://my3hk2j6.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Howl&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/Portfolio/">
                <i class="iconfont icon-pen"></i>
                <span>Portfolio</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Category</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archive</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About Me</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/post.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.5)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Games202 Hw4 IBL and Kulla Conty"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-07-01 07:34" pubdate>
          July 1, 2023 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          30k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          251 mins
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Games202 Hw4 IBL and Kulla Conty</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="æœ€ç»ˆæ•ˆæœå›¾">æœ€ç»ˆæ•ˆæœå›¾</h1>
<p>æ¯ç»„ä¸‹é¢ä¸€æ’çƒæ˜¯æ²¡ç”¨<code>Kulla Conty</code>çš„å¯¹ç…§ç»„ï¼Œæ‰€æœ‰çƒçš„é‡‘å±åº¦éƒ½ä¸º<code>1</code>,ç²—ç³™åº¦æœ€å°<code>0.05</code>ï¼Œæœ€å¤§<code>0.95</code>,å¯ä»¥æ˜æ˜¾çœ‹åˆ°å¯¹ç…§ç»„éšç€ç²—ç³™åº¦å¢å¤§ï¼Œä¼šè¶Šæ¥è¶Šæš—ï¼Œè€Œä½¿ç”¨äº†<code>Kulla Conty</code>çš„å®éªŒç»„ï¼Œäº®åº¦ä¸ä¼šéšç€ç²—ç³™åº¦çš„å¢åŠ è€Œè¡°å‡ï¼Œä¸ºäº†ä½¿ç°è±¡æ›´æ˜æ˜¾è¿™é‡Œå§<code>HDR tonemapping</code>åŠŸèƒ½ç¦ç”¨äº†ï¼
<img src="/img/00018/result.png" srcset="/img/loading.gif" lazyload alt="0" /><br />
ä¸‹é¢æ˜¯é‡‘æè´¨çš„<code>Kulla-Conty Approximation</code>æ•ˆæœï¼š<br />
<img src="/img/00018/image-15.png" srcset="/img/loading.gif" lazyload alt="1" /></p>
<h1 id="ä½œä¸šæ€»è§ˆ">ä½œä¸šæ€»è§ˆ</h1>
<ol type="1">
<li>å®ç°é¢„è®¡ç®—<span class="math inline">\(E(\mu)\)</span></li>
<li>å®ç°é¢„è®¡ç®—<span class="math inline">\(E_{avg}\)</span></li>
<li>æ­£ç¡®å®ç°PBRæè´¨</li>
<li>æ­£ç¡®å®ç°Kulla-Contyæè´¨</li>
<li>æé«˜1ï¼šå®ç°é‡è¦æ€§é‡‡æ ·çš„é¢„è®¡ç®—æ–¹æ³•<br />
</li>
<li>æé«˜2ï¼šåœ¨é¢„è®¡ç®—<span
class="math inline">\(E(\mu)\)</span>æ—¶ï¼Œä½¿ç”¨<code>Split Sum</code>å®Œæˆé¢„è®¡ç®—å·¥ä½œ</li>
</ol>
<p>ä¸ªäººæ‰©å±•éƒ¨åˆ†ï¼š<code>Image Based Lighting</code></p>
<h1 id="æºç ">æºç </h1>
<p>æš‚æœªå…¬å¼€</p>
<h1 id="webglä»£ç æ¡†æ¶çš„ç†è§£">Webglä»£ç æ¡†æ¶çš„ç†è§£</h1>
<p>è¿™éƒ¨åˆ†ä»£ç ä¸»è¦è§£é‡Šæˆ‘ä»¬éœ€è¦çš„åœ°æ–¹ï¼Œå¤ªè¿‡äºç»†èŠ‚çš„åœ°æ–¹æœ¬èŠ‚å†…å®¹ä¸åšè§£é‡Šï¼Œåªå»ç†è§£é‚£äº›èƒ½å¸®åŠ©æˆ‘å®ç°æƒ³è¦æ•ˆæœçš„ä»£ç ã€‚</p>
<h2 id="æ¨¡å‹åŠ è½½">æ¨¡å‹åŠ è½½</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> pbrSphere1Transform = <span class="hljs-title function_">setTransform</span>(<span class="hljs-number">360</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">180</span>, <span class="hljs-number">180</span>, <span class="hljs-number">180</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-title function_">loadGLTF</span>(renderer, <span class="hljs-string">&#x27;assets/ball/&#x27;</span>, <span class="hljs-string">&#x27;ball&#x27;</span>, <span class="hljs-string">&#x27;PBRMaterial&#x27;</span>, pbrSphere1Transform,irradianceMap,prefilterMap,pbrBrdfLutObj,metallic,<span class="hljs-number">0.95</span>);<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">loadGLTF</span>(<span class="hljs-params">renderer, path, name, objMaterial, transform,irradianceMap,prefilterMap,pbrBrdfLut, metallic=<span class="hljs-number">1.0</span>, roughness=<span class="hljs-number">0.2</span></span>)&#123;<br>    ...<br>	<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">GLTFLoader</span>(manager)<br>		.<span class="hljs-title function_">setPath</span>(path)<br>		.<span class="hljs-title function_">load</span>(name + <span class="hljs-string">&#x27;.gltf&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">gltf</span>) &#123;<br>			gltf.<span class="hljs-property">scene</span>.<span class="hljs-title function_">traverse</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">child</span>) &#123;<br>				<span class="hljs-keyword">if</span> (child.<span class="hljs-property">isMesh</span>) &#123;<br>                    ...<br>					<span class="hljs-keyword">let</span> colorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Texture</span>(renderer.<span class="hljs-property">gl</span>);<br>					...<br>                    <span class="hljs-comment">//gold : 0.94423,0.77611,0.37217</span><br>                    <span class="hljs-keyword">let</span> kd = [<span class="hljs-number">1.00</span>,<span class="hljs-number">1.00</span>, <span class="hljs-number">1.00</span>]; <span class="hljs-comment">//albedo</span><br>                    colorMap.<span class="hljs-title class_">CreateConstantTexture</span>(renderer.<span class="hljs-property">gl</span>, kd, <span class="hljs-literal">true</span>);<br>					<span class="hljs-keyword">let</span> material;<br>					<span class="hljs-keyword">switch</span> (objMaterial) &#123;<br>						<span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;KullaContyMaterial&#x27;</span>:<br>							material = <span class="hljs-title function_">buildKullaContyMaterial</span>(colorMap,metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut,kullaContyBrdflut,kullaContyEavglut,<span class="hljs-string">&quot;./src/shaders/kullaContyShader/KullaContyVertex.glsl&quot;</span>, <span class="hljs-string">&quot;./src/shaders/kullaContyShader/KullaContyFragment.glsl&quot;</span>);<br>							<span class="hljs-keyword">break</span>;<br>						<span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;PBRMaterial&#x27;</span>:<br>							material = <span class="hljs-title function_">buildPBRMaterial</span>(colorMap,metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut,<span class="hljs-string">&quot;./src/shaders/pbrShader/PBRVertex.glsl&quot;</span>, <span class="hljs-string">&quot;./src/shaders/pbrShader/PBRFragment.glsl&quot;</span>);<br>							<span class="hljs-keyword">break</span>;<br>					&#125;<br>					material.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>						<span class="hljs-keyword">let</span> meshRender = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MeshRender</span>(renderer.<span class="hljs-property">gl</span>, mesh, data,objMaterial);<br>						renderer.<span class="hljs-title function_">addMeshRender</span>(meshRender);<br>					&#125;);<br>				&#125;<br>			&#125;);<br>		&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ¨¡å‹åŠ è½½ä¸»è¦å°±çœ‹è¿™éƒ¨åˆ†ï¼Œæ‰“äº†çœç•¥çš„éƒ¨åˆ†ä¸éœ€è¦å»ç†è§£ã€‚<br />
<code>colorMap</code>è·å–åˆ›å»ºçš„çº¹ç†<code>ID</code>,<code>kD</code>æ˜¯<code>albedo</code>ï¼Œåªä¸ºäº†è§‚å¯Ÿèƒ½é‡æŸå¤±å’Œè¡¥å……ç›´æ¥å¡«<code>1.0</code>å°±è¡Œï¼Œ<code>CreateConstantTexture</code>ç”¨<code>albedo</code>åˆ›å»ºä¸€å¼ å®½é«˜ä¸º<code>1</code>çš„çº¹ç†ã€‚<br />
<code>buildKullaContyMaterial</code>æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå‡½æ•°æ‰§è¡Œå®Œæˆåå°±ä¼šè¿›å…¥å›è°ƒéƒ¨åˆ†<code>material.then((data))</code>,<code>data</code>æ‰æ˜¯å‡½æ•°çš„è¿”å›å€¼ã€‚<br />
<code>child.isMesh</code>ä¼šåˆ¤æ–­æ¨¡å‹çš„å­èŠ‚ç‚¹æ˜¯å¦ä¸º<code>mesh</code>èŠ‚ç‚¹ï¼Œç»è¿‡<code>debug</code>å‘ç°ï¼Œè¯¥<code>ball</code>æ¨¡å‹æœ‰<code>4</code>ä¸ªå­èŠ‚ç‚¹ï¼Œä¹Ÿå°±è¯´ä¼šè¿›å…¥å›è°ƒéƒ¨åˆ†<code>material.then((data))</code>4æ¬¡ã€‚</p>
<h2 id="shaderç¼–è¯‘">shaderç¼–è¯‘</h2>
<p>åœ¨ç†è§£æ¡†æ¶<code>shader</code>ç¼–è¯‘ä¹‹å‰éœ€è¦æŠŠæè´¨ç±»å‹ç†Ÿæ‚‰ä¸€ä¸‹ï¼Œä»¥<code>PBRMaterial.js</code>ä¸ºä¾‹:<br />
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Material</span> &#123;<br>    #flatten_uniforms;<br>    #flatten_attribs;<br>    #vsSrc;<br>    #fsSrc;<br>    <span class="hljs-comment">// Uniforms is a map, attribs is a Array</span><br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">uniforms, attribs, vsSrc, fsSrc, frameBuffer</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">uniforms</span> = uniforms;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">attribs</span> = attribs;<br>        <span class="hljs-variable language_">this</span>.#vsSrc = vsSrc;<br>        <span class="hljs-variable language_">this</span>.#fsSrc = fsSrc;<br><br>        <span class="hljs-variable language_">this</span>.#flatten_uniforms = [<span class="hljs-string">&#x27;uViewMatrix&#x27;</span>,<span class="hljs-string">&#x27;uModelMatrix&#x27;</span>, <span class="hljs-string">&#x27;uProjectionMatrix&#x27;</span>, <span class="hljs-string">&#x27;uCameraPos&#x27;</span>, <span class="hljs-string">&#x27;uLightPos&#x27;</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k <span class="hljs-keyword">in</span> uniforms) &#123;<br>            <span class="hljs-variable language_">this</span>.#flatten_uniforms.<span class="hljs-title function_">push</span>(k);<br>        &#125;<br>        <span class="hljs-variable language_">this</span>.#flatten_attribs = attribs;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameBuffer</span> = frameBuffer;<br>    &#125;<br>    <span class="hljs-title function_">setMeshAttribs</span>(<span class="hljs-params">extraAttribs</span>) &#123;<br>    <br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; extraAttribs.<span class="hljs-property">length</span>; i++) &#123;<br>            <span class="hljs-variable language_">this</span>.#flatten_attribs.<span class="hljs-title function_">push</span>(extraAttribs[i]);<br>        &#125;<br>    &#125;<br>    <span class="hljs-title function_">compile</span>(<span class="hljs-params">gl</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shader</span>(gl, <span class="hljs-variable language_">this</span>.#vsSrc, <span class="hljs-variable language_">this</span>.#fsSrc,<br>            &#123;<br>                <span class="hljs-attr">uniforms</span>: <span class="hljs-variable language_">this</span>.#flatten_uniforms,<br>                <span class="hljs-attr">attribs</span>: <span class="hljs-variable language_">this</span>.#flatten_attribs<br>            &#125;);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PBRMaterial</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Material</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">albedo, metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut, vertexShader, fragmentShader</span>) &#123;<br>        <span class="hljs-variable language_">super</span>(&#123;<br>            <span class="hljs-string">&#x27;uAlbedoMap&#x27;</span>:          &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;texture&#x27;</span>, <span class="hljs-attr">value</span>: albedo &#125;,<br>            <span class="hljs-string">&#x27;uMetallic&#x27;</span>:        &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;1f&#x27;</span>, <span class="hljs-attr">value</span>: metallic &#125;,<br>            ...<br>            <span class="hljs-comment">// &#x27;uLightPos[4]&#x27;: &#123; type: &#x27;3fv&#x27;, value: null &#125;,</span><br>            <span class="hljs-comment">// &#x27;uLightColors[4]&#x27;: &#123; type: &#x27;3fv&#x27;, value: null &#125;,</span><br>        &#125;, [], vertexShader, fragmentShader);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildPBRMaterial</span>(<span class="hljs-params">albedo, metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut, vertexPath, fragmentPath</span>) &#123;<br>    <span class="hljs-keyword">let</span> vertexShader = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getShaderString</span>(vertexPath);<br>    <span class="hljs-keyword">let</span> fragmentShader = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getShaderString</span>(fragmentPath);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PBRMaterial</span>(albedo, metallic,roughness,irradianceMap,prefilterMap,pbrBrdfLut, vertexShader, fragmentShader);<br>&#125;<br></code></pre></td></tr></table></figure>
å„ç§æè´¨ç±»éƒ½æ˜¯ç»§æ‰¿è‡ªçˆ¶ç±»<code>Material</code>,å­ç±»éƒ¨åˆ†åªè´Ÿè´£å¡«å†™å¯¹åº”<code>shader</code>éœ€è¦<code>uniform</code>çš„å˜é‡ï¼Œå­ç±»ç”¨<code>super</code>å…³é”®å­—æ¥å¯¹çˆ¶ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œéšåå¡«å†™<code>uniform</code>æ•°æ®å…¨éƒ¨è¢«ä¿å­˜å…¥çˆ¶ç±»ç§æœ‰å˜é‡<code>#flatten_uniforms</code>ä¸­ï¼Œçˆ¶ç±»è¿˜åŒ…å«äº†ä¸€äº›å¸¸ç”¨<code>uniform</code>å˜é‡<code>'uViewMatrix','uModelMatrix'...</code>,è¿™äº›åå­—åœ¨ä¸åŒçš„<code>vertex</code>å’Œ<code>fragment</code>ä¸­åå­—éƒ½æ˜¯ç»Ÿä¸€çš„,å¯è‡ªè¡Œä¿®æ”¹ï¼Œæ•°ç»„<code>uniform</code>å˜é‡éœ€è¦è‡ªå·±æ‰‹åŠ¨è®¾ç½®ï¼Œæ¡†æ¶æ²¡æœ‰å¯¹è¿™ç±»å˜é‡è¿›è¡Œè§£æã€‚<br />
<code>this.#vsSrc</code>å’Œ<code>this.#fsSrc</code>ä¿å­˜çš„<code>shader</code>æ–‡ä»¶è·¯å¾„ï¼Œ<code>#this.attribs</code>ä¿å­˜çš„<code>vertexShader</code>çš„<code>location</code>å˜é‡åå­—ï¼Œæ¯”å¦‚:<br />
<code>layout (location = 0) in vec3 aVertexPosition;</code>ä¸­çš„<code>aVertexPosition</code>ï¼Œæ‰€ä»¥åœ¨<code>vertexShader</code>ä¸­ä¸è¦æ›´æ”¹å®ƒçš„åå­—ï¼Œåå­—éƒ½æ˜¯æ¥æºäº<code>mesh</code>èŠ‚ç‚¹ï¼Œåœ¨<code>MeshRender.js</code>æ–‡ä»¶ä¸­ä¼šåˆ¤æ–­<code>mesh</code>èŠ‚ç‚¹æ˜¯å¦åŒ…å«è¯¥å±æ€§åå­—ï¼Œæœ‰çš„è¯å°±è°ƒç”¨è¯¥æè´¨çš„<code>setMeshAttribs</code>å‡½æ•°å°†åå­—å­˜å…¥<code>#this.attribs</code>ã€‚<br />
åœ¨è°ƒç”¨<code>compile()</code>å‡½æ•°çš„æ—¶å€™ï¼Œ<code>shader</code>è·¯å¾„ï¼Œ<code>uniform</code>å˜é‡åï¼Œ<code>attribs</code>å˜é‡åå­—ä¼šä¸€åŒä¼ å…¥<code>new</code>å‡ºæ¥çš„<code>shader</code>å¯¹è±¡ã€‚<br />
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Shader</span> &#123;<br>    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">gl, vsSrc, fsSrc, shaderLocations</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span> = gl;<br>        <span class="hljs-keyword">const</span> vs = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compileShader</span>(vsSrc, gl.<span class="hljs-property">VERTEX_SHADER</span>);<br>        <span class="hljs-keyword">const</span> fs = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compileShader</span>(fsSrc, gl.<span class="hljs-property">FRAGMENT_SHADER</span>);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">program</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addShaderLocations</span>(&#123;<br>            <span class="hljs-attr">glShaderProgram</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">linkShader</span>(vs, fs),<br>        &#125;, shaderLocations);<br>    &#125;<br>    <span class="hljs-title function_">compileShader</span>(<span class="hljs-params">shaderSource, shaderType</span>) &#123;<br>        <span class="hljs-keyword">const</span> gl = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span>;<br>        <span class="hljs-keyword">var</span> shader = gl.<span class="hljs-title function_">createShader</span>(shaderType);<br>        ...<br>        <span class="hljs-keyword">return</span> shader;<br>    &#125;;<br>    <span class="hljs-title function_">linkShader</span>(<span class="hljs-params">vs, fs</span>) &#123;<br>        <span class="hljs-keyword">const</span> gl = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span>;<br>        <span class="hljs-keyword">var</span> prog = gl.<span class="hljs-title function_">createProgram</span>();<br>        ...<br>        <span class="hljs-keyword">return</span> prog;<br>    &#125;;<br>    <span class="hljs-title function_">addShaderLocations</span>(<span class="hljs-params">result, shaderLocations</span>) &#123;<br>        <span class="hljs-keyword">const</span> gl = <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span>;<br>        result.<span class="hljs-property">uniforms</span> = &#123;&#125;;<br>        result.<span class="hljs-property">attribs</span> = &#123;&#125;;<br>        <span class="hljs-keyword">if</span> (shaderLocations &amp;&amp; shaderLocations.<span class="hljs-property">uniforms</span> &amp;&amp; shaderLocations.<span class="hljs-property">uniforms</span>.<span class="hljs-property">length</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shaderLocations.<span class="hljs-property">uniforms</span>.<span class="hljs-property">length</span>; ++i) &#123;<br>                result.<span class="hljs-property">uniforms</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(result.<span class="hljs-property">uniforms</span>, &#123;<br>                    [shaderLocations.<span class="hljs-property">uniforms</span>[i]]: gl.<span class="hljs-title function_">getUniformLocation</span>(result.<span class="hljs-property">glShaderProgram</span>, shaderLocations.<span class="hljs-property">uniforms</span>[i]),<br>                &#125;);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (shaderLocations &amp;&amp; shaderLocations.<span class="hljs-property">attribs</span> &amp;&amp; shaderLocations.<span class="hljs-property">attribs</span>.<span class="hljs-property">length</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; shaderLocations.<span class="hljs-property">attribs</span>.<span class="hljs-property">length</span>; ++i) &#123;<br>                result.<span class="hljs-property">attribs</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(result.<span class="hljs-property">attribs</span>, &#123;<br>                    [shaderLocations.<span class="hljs-property">attribs</span>[i]]: gl.<span class="hljs-title function_">getAttribLocation</span>(result.<span class="hljs-property">glShaderProgram</span>, shaderLocations.<span class="hljs-property">attribs</span>[i]),<br>                &#125;);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
shaderå¯¹è±¡åœ¨æ„é€ å‡½æ•°ä¸­å°±å®Œæˆäº†æ‰€æœ‰äº‹æƒ…ï¼Œ<code>gl.createProgram()</code>è¿™ä¸ªå‡½æ•°è¿”å›shaderçš„IDï¼Œè¯¥IDå­˜å‚¨åœ¨<code>addShaderLocations()</code>è¿™ä¸ªå‡½æ•°ä¸­resultå¯¹è±¡é‡Œé¢ï¼Œ<code>&#123; glShaderProgram: this.linkShader(vs, fs) &#125;</code>è¿™é‡Œæ˜¯å¯¹resultå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œåé¢åˆåŠ äº†ä¸¤ä¸ªæˆå‘˜å˜é‡<code>result.uniforms</code>å’Œ<code>result.attribs</code>ã€‚<br />
é‡ç‚¹æ˜¯è¿™ä¸ªå‡½æ•°<code>addShaderLocations()</code>,<code>result.uniforms</code>å’Œ<code>result.attribs</code>å­˜å‚¨çš„æ˜¯ä¸€ç³»åˆ—é”®å€¼å¯¹ï¼Œ<code>key</code>æ˜¯ä¹‹å‰ä¼ å…¥çš„uniformå˜é‡åï¼Œ<code>value</code>æ˜¯locationåå¾—åˆ°ID,<code>result.attribs</code>åŒç†ã€‚<br />
æ‰€ä»¥åœ¨<code>MeshRender</code>å¯¹è±¡ä¸­ï¼Œè¿›è¡Œ<code>gl.useProgram()</code>,<code>gl.uniform()</code>,<code>gl.enableVertexAttribArray()</code>æ“ä½œæ—¶ï¼Œåªéœ€è¦æ‰€ä»¥ç”¨å˜é‡åæ¥ç´¢å¼•<code>shader.program</code>çš„shaderIDï¼ŒuniformID,attribsIDä»¥åŠå³å¯,è¯¥<code>program</code>å°±å¯¹åº”ä¸Šé¢è¯´çš„<code>result</code>çš„å†…å®¹ã€‚<br />
çŸ¥é“è¿™äº›ä»¥åæˆ‘ä»¬å°±å¯ä»¥è‡ªè¡Œå¯¹shaderè¿›è¡Œ<code>uniform</code>,å’Œ<code>useProgram</code>æ“ä½œ,å¯¹äºéœ€è¦æ‰‹åŠ¨è®¾ç½®<code>uniformå˜é‡</code>å¦‚ä¸‹ï¼š<br />
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> l = <span class="hljs-number">0</span>; l &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">lights</span>.<span class="hljs-property">length</span>; l++) &#123;<br>    ...<br>    <span class="hljs-comment">// Camera pass</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>.<span class="hljs-property">length</span>; i++) &#123;<br>        <br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>[i].<span class="hljs-property">materialName</span> == <span class="hljs-string">&quot;KullaContyMaterial&quot;</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>[i].<span class="hljs-property">materialName</span> == <span class="hljs-string">&quot;PBRMaterial&quot;</span>)&#123;<br>            <span class="hljs-keyword">let</span> <span class="hljs-variable constant_">ID</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>[i].<span class="hljs-property">shader</span>.<span class="hljs-property">program</span>.<span class="hljs-property">glShaderProgram</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">gl</span>.<span class="hljs-title function_">useProgram</span>(<span class="hljs-variable constant_">ID</span>);<br>            gl.<span class="hljs-title function_">uniform3fv</span>(gl.<span class="hljs-title function_">getUniformLocation</span>(<br>                <span class="hljs-variable constant_">ID</span>, <span class="hljs-string">&quot;uLightPos&quot;</span> + <span class="hljs-string">&quot;[&quot;</span> + l + <span class="hljs-string">&quot;]&quot;</span>), <br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">lights</span>[l].<span class="hljs-property">entity</span>.<span class="hljs-property">lightPos</span>);<br>            gl.<span class="hljs-title function_">uniform3fv</span>(gl.<span class="hljs-title function_">getUniformLocation</span>(<br>                <span class="hljs-variable constant_">ID</span>, <span class="hljs-string">&quot;uLightColors&quot;</span> + <span class="hljs-string">&quot;[&quot;</span> + l + <span class="hljs-string">&quot;]&quot;</span>), <br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">lights</span>[l].<span class="hljs-property">entity</span>.<span class="hljs-property">lightRadiance</span>);<br>        &#125;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">meshes</span>[i].<span class="hljs-title function_">draw</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">camera</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
å¥½çš„ï¼Œæ¡†æ¶æ ¸å¿ƒçš„ä¸œè¥¿å¤§æ¦‚éƒ½è®²å®Œäº†ï¼Œå…¶ä»–çš„åœ°æ–¹æ ¹æ®ä¸Šé¢è¯´çš„å†…å®¹ï¼Œå¤šçœ‹å‡ éå°±æ²¡ä»»ä½•é—®é¢˜äº†ï¼Œä¸‹é¢è®²ä¸‹IBLã€‚</p>
<h1 id="ibl">IBL</h1>
<p>IBLçš„å®ç°æµç¨‹å¦‚ä¸‹ï¼š<br />
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//ibl</span><br><span class="hljs-keyword">let</span> envCubemap,irradianceMap,prefilterMap;<br><span class="hljs-keyword">let</span> pbrBrdfLutObj;<br><span class="hljs-keyword">let</span> hdrObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Texture</span>(gl);<br><span class="hljs-comment">//åŠ è½½HDRæ–‡ä»¶</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadTexture</span>(<span class="hljs-params"></span>) &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123;<br>		<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">RGBELoader</span>().<span class="hljs-title function_">load</span>(<span class="hljs-string">&quot;assets/winter_sky_1k.hdr&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">texture</span>) &#123;<br>			<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;HDR Loaded&quot;</span>);<br>			<span class="hljs-title function_">resolve</span>(texture);<br>		&#125;);<br>	&#125;);<br>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">integral</span>(<span class="hljs-params"></span>) &#123;<br>	<span class="hljs-keyword">let</span> hdrData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadTexture</span>();<br>	<span class="hljs-keyword">let</span> data = hdrData.<span class="hljs-property">image</span>.<span class="hljs-property">data</span>;<br>	<span class="hljs-keyword">let</span> width = hdrData.<span class="hljs-property">image</span>.<span class="hljs-property">width</span>;<br>	<span class="hljs-keyword">let</span> height = hdrData.<span class="hljs-property">image</span>.<span class="hljs-property">height</span>;<br>	gl.<span class="hljs-title function_">bindTexture</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, hdrObj.<span class="hljs-property">texture</span>);<br>	gl.<span class="hljs-title function_">texImage2D</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, <span class="hljs-number">0</span>, gl.<span class="hljs-property">RGBA</span>, width, height, <span class="hljs-number">0</span>, gl.<span class="hljs-property">RGBA</span>, gl.<span class="hljs-property">UNSIGNED_BYTE</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(data));<br>	<span class="hljs-comment">////debug texture</span><br>	<span class="hljs-comment">// gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 1, 1, 0, gl.RGBA, gl.UNSIGNED_BYTE,</span><br>	<span class="hljs-comment">// 	new Uint8Array([0, 0, 255, 255]));</span><br>	gl.<span class="hljs-title function_">texParameteri</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, gl.<span class="hljs-property">TEXTURE_WRAP_S</span>, gl.<span class="hljs-property">CLAMP_TO_EDGE</span>);<br>	gl.<span class="hljs-title function_">texParameteri</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, gl.<span class="hljs-property">TEXTURE_WRAP_T</span>, gl.<span class="hljs-property">CLAMP_TO_EDGE</span>);<br>	gl.<span class="hljs-title function_">texParameteri</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, gl.<span class="hljs-property">TEXTURE_MIN_FILTER</span>, gl.<span class="hljs-property">LINEAR</span>);<br>	gl.<span class="hljs-title function_">texParameteri</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, gl.<span class="hljs-property">TEXTURE_MAG_FILTER</span>, gl.<span class="hljs-property">LINEAR</span>);<br>	gl.<span class="hljs-title function_">bindTexture</span>(gl.<span class="hljs-property">TEXTURE_2D</span>, <span class="hljs-literal">null</span>);<br>	<span class="hljs-title function_">getErrorMessage</span>(gl,<span class="hljs-string">&quot;engine.js&quot;</span>);<br>	<span class="hljs-keyword">let</span> ibl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">IBL</span>(gl,hdrObj.<span class="hljs-property">texture</span>);<br>	<span class="hljs-keyword">await</span> ibl.<span class="hljs-title function_">init</span>();<br>	envCubemap = ibl.<span class="hljs-title function_">caculateEnvCubemap</span>();<br>	irradianceMap = ibl.<span class="hljs-title function_">caculateIrradianceMap</span>();<br>	prefilterMap = ibl.<span class="hljs-title function_">caculatePrefilterMap</span>();<br>	pbrBrdfLutObj = ibl.<span class="hljs-title function_">caculateLut</span>();<br>&#125;<br><span class="hljs-keyword">await</span> <span class="hljs-title function_">integral</span>();<br></code></pre></td></tr></table></figure>
ä¸»è¦å°±æ˜¯åŠ è½½<code>HDR</code>æ–‡ä»¶ï¼Œå°†<code>HDR</code>çš„å†…å®¹è½½å…¥ä¸€å¼ <code>2Dçº¹ç†</code>ä¸­(hdrObj)ï¼Œç„¶åæ ¹æ®çº¹ç†ç”Ÿæˆ<code>environmentCubemap</code>(envCubemap),ç„¶åæ ¹æ®<code>Cubemap</code>é¢„è®¡ç®—æ¼«åå°„é¡¹(irradianceMap)çš„å…‰ç…§éƒ¨åˆ†ï¼Œé•œé¢åå°„é¡¹çš„å…‰ç…§éƒ¨åˆ†(prefilterMap)ä»¥åŠå¯¹BRDFæœ¬èº«çš„é¢„è®¡ç®—(pbrBrdfLutObj)ï¼Œç„¶ååœ¨shaderä¸­ç›´æ¥æŸ¥è¡¨å®Œæˆç¯å¢ƒå…‰<code>Cook-Torrance</code>åå°„æ¨¡å‹çš„ç§¯åˆ†ã€‚<br />
æ³¨æ„<code>gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE,new Uint8Array(data));</code>è¿™ä¸ªå‡½æ•°è¯»å–æ•°æ®çš„ç±»å‹ä¸èƒ½åƒ<code>Opengl</code>é‚£æ ·å¡«<code>gl.FLOAT</code>,ä¸ç„¶ä¼šæŠ¥é”™,å¯ä»¥ç”¨è¿™ä¸ªå‡½æ•°æ¥æ£€æµ‹<code>getErrorMessage()</code>ã€‚åæ­£æˆ‘è¿™æ˜¯ä¸è¡Œï¼Œä½ ä»¬å¯ä»¥è‡ªè¡Œæµ‹è¯•ã€‚</p>
<h2 id="ä»ç­‰è·æŸ±çŠ¶æŠ•å½±åˆ°ç«‹æ–¹ä½“è´´å›¾">ä»ç­‰è·æŸ±çŠ¶æŠ•å½±åˆ°ç«‹æ–¹ä½“è´´å›¾</h2>
<p><code>HDR</code>æ–‡ä»¶è½½å…¥<code>2Dçº¹ç†</code>åå°±æ˜¯<code>ç­‰è·æŸ±çŠ¶æŠ•å½±å›¾(Equirectangular Map)</code>,æˆ‘ä»¬è¦åšçš„å°±æ˜¯å°†è¿™å¼ <code>2Dçº¹ç†</code>è½¬æ¢æˆ<code>Cubemap</code>ã€‚<br />
è¿™é‡Œç”¨<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/UV_mapping">UV
mapping</a>ä¸­çš„æŠ€æœ¯,ä»çƒé¢ä¸Šæ‰¾åˆ°UVåæ ‡ã€‚ä»<code>ç¬›å¡å°”åæ ‡ç³»</code>è½¬<code>çƒåæ ‡ç³»</code>ç„¶åæ˜ å°„åˆ°<code>[0,1]</code>åŒºé—´å»é‡‡æ ·ç­‰è·æŸ±çŠ¶å›¾ï¼Œåœ¨å³æ‰‹åæ ‡ç³»è¿›è¡Œï¼Œ<code>phi</code>é€†æ—¶é’ˆæ—‹è½¬ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br />
<span class="math display">\[
u=0.5+\frac{\arctan(p_{z},p_{x})}{2\pi}  \\
v=0.5+\frac{\arcsin(p_{y})}{\pi}  \tag{1}
\]</span> è§£é‡Šå¦‚ä¸‹ï¼š<br />
<img src="/img/00018/uv-mapping.png" srcset="/img/loading.gif" lazyload alt="2" /> ä»£ç å¦‚ä¸‹:<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">const</span> vec2 invAtan = <span class="hljs-built_in">vec2</span>(<span class="hljs-number">0.1591</span>, <span class="hljs-number">0.3183</span>);<br><span class="hljs-comment">// hdræ–‡ä»¶å­˜å‚¨æ¯ä¸ªæµ®ç‚¹å€¼çš„æ–¹å¼</span><br><span class="hljs-comment">// æ¯ä¸ªé€šé“å­˜å‚¨ 8 ä½ï¼Œå†ä»¥ alpha é€šé“å­˜æ”¾æŒ‡æ•°</span><br><span class="hljs-comment">// å› æ­¤åˆ©ç”¨è¿™ç§æ–¹å¼è§£ç </span><br><span class="hljs-function">vec3 <span class="hljs-title">hdrDecode</span><span class="hljs-params">(vec4 encoded)</span></span>&#123;<br>    <span class="hljs-type">float</span> exponent = encoded.a * <span class="hljs-number">256.0</span> - <span class="hljs-number">128.0</span>;<br>    vec3 mantissa = encoded.rgb;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">exp2</span>(exponent) * mantissa;<br>&#125;<br><span class="hljs-function">vec2 <span class="hljs-title">SampleSphericalMap</span><span class="hljs-params">(vec3 v)</span></span><br><span class="hljs-function"></span>&#123;<br>    vec2 uv = <span class="hljs-built_in">vec2</span>(<span class="hljs-built_in">atan</span>(v.z, v.x), <span class="hljs-built_in">asin</span>(v.y));<br>    uv *= invAtan;<br>    uv += <span class="hljs-number">0.5</span>;<br>    <span class="hljs-keyword">return</span> uv;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;		<br>    vec2 uv = <span class="hljs-built_in">SampleSphericalMap</span>(<span class="hljs-built_in">normalize</span>(WorldPos));<br>    vec4 enCodeColor = <span class="hljs-built_in">texture</span>(uEquirectangularMap,uv).rgba;<br>    vec3 deCodeColor = <span class="hljs-built_in">hdrDecode</span>(enCodeColor);<br>    fragColor = <span class="hljs-built_in">vec4</span>(<span class="hljs-built_in">vec3</span>(deCodeColor), <span class="hljs-number">1.0</span>);<br>&#125;<br>```  <br><br>## ç¯å¢ƒå…‰Cook-Torranceåå°„æ–¹ç¨‹çš„é¢„è®¡ç®—  <br><br>å¿«é€Ÿæµè§ˆä¸€ä¸‹åå°„æ–¹ç¨‹ï¼š  <br>$$<br>L_&#123;o&#125;(p,w_&#123;o&#125;)=\int_&#123;\Omega&#125;^&#123;&#125;(kd\frac&#123;c&#125;&#123;\pi&#125;+ks\frac&#123;DFG&#125;&#123;<span class="hljs-number">4</span>(w_&#123;o&#125;\cdot n)(w_&#123;i&#125;\cdot n)&#125;)L_&#123;i&#125;(p,w_&#123;i&#125;)n\cdot w_&#123;i&#125;dw_&#123;i&#125; \tag&#123;<span class="hljs-number">2</span>&#125;<br>$$<br>è¯¥å…¬å¼çš„è§£é‡Šå¯ä»¥å‚è€ƒ[Opengl Pbr](https:<span class="hljs-comment">//learnopengl-cn.github.io/07%20PBR/01%20Theory/)ã€‚å€¼å¾—ä¸€æçš„æ˜¯å…¬å¼ä¸­`ks`å’Œ`Fresnel`é¡¹æŒ‡ä»£çš„åŒä¸€ä»¶äº‹æƒ…ï¼Œæ‰€ä»¥`ks`å¯ä»¥çœç•¥ï¼Œå…¶ä¸­`o`ä»£è¡¨å‡ºå°„æ–¹å‘ä¹Ÿå°±æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„æ–¹å‘ï¼Œ`i`æ˜¯å…¥å°„æ–¹å‘å³å…‰ç…§æ–¹å‘ã€‚</span><br><br>### æ¼«åå°„å…‰ç…§çš„é¢„è®¡ç®—  <br><br>ä»”ç»†è§‚å¯Ÿä¼šå‘ç°`BRDF`çš„æ¼«åå°„`kd`å’Œé•œé¢`ks`é¡¹æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç§¯åˆ†åˆ†æˆä¸¤éƒ¨åˆ†ï¼š <br>$$<br>L_&#123;o&#125;(p,w_&#123;o&#125;)=\int_&#123;\Omega&#125;(kd\frac&#123;c&#125;&#123;\pi&#125;)L_&#123;i&#125;(p,w_&#123;i&#125;)n\cdot w_&#123;i&#125;dw_&#123;i&#125;+\int_&#123;\Omega&#125;(\frac&#123;DFG&#125;&#123;<span class="hljs-number">4</span>(w_&#123;o&#125;\cdot n)(w_&#123;i&#125;\cdot n)&#125;)L_&#123;i&#125;(p,w_&#123;i&#125;)n\cdot w_&#123;i&#125;dw_&#123;i&#125; \tag&#123;<span class="hljs-number">3</span>&#125;<br>$$<br>å‰è¿™éƒ¨åˆ†æ‰æ˜¯æœ¬èŠ‚çš„é‡ç‚¹ï¼Œè®©æˆ‘ä»¬åœ¨åŒ–ç®€ä¸€ä¸‹(é¢œè‰²`c`,æ¼«åå°„ç‡`kd`,å’Œ`Ï€`åœ¨æ•´ä¸ªç§¯åˆ†æ˜¯å¸¸æ•°)ï¼š  <br>$$<br>L_&#123;o&#125;(p,w_&#123;o&#125;)=(kd\frac&#123;c&#125;&#123;\pi&#125;)\int_&#123;\Omega&#125;L_&#123;i&#125;(p,w_&#123;i&#125;)n\cdot w_&#123;i&#125;dw_&#123;i&#125; \tag&#123;<span class="hljs-number">4</span>&#125;<br>$$<br>ç»è¿‡ç®€åŒ–æœ‰å¯ä»¥å‘ç°ï¼Œç§¯åˆ†ç›®å‰åªè·Ÿ`wi`æœ‰å…³(å‡è®¾ç‰©ä½“ä¸Šçš„ç‚¹pä½äºç«‹æ–¹ä½“ä¸­é—´ï¼Œ`N`ä¸º`p`ä¸ç«‹æ–¹ä½“ä¸ŠæŸç‚¹çš„è¿çº¿)ï¼Œç”±äºæ˜¯æ¼«åå°„åœ¨åŠçƒä¸Šçš„ç§¯åˆ†ï¼Œå…¶å…¥å°„æ–¹å‘æ˜¯å‡åŒ€çš„æ¥è‡ªåŠçƒçš„å››é¢å…«æ–¹ã€‚  <br>ç§¯åˆ†å‚è€ƒ`Opengl`çš„æ–¹æ³•ï¼šå¯¹äºç«‹æ–¹ä½“è´´å›¾çš„æ¯ä¸ªçº¹ç´ ï¼Œåœ¨`çº¹ç´ æ‰€ä»£è¡¨çš„æ–¹å‘`çš„åŠçƒÎ©å†…ç”Ÿæˆå›ºå®šæ•°é‡çš„é‡‡æ ·å‘é‡ï¼Œå¹¶å¯¹é‡‡æ ·ç»“æœå–å¹³å‡å€¼ã€‚æ•°é‡å›ºå®šçš„é‡‡æ ·å‘é‡å°†å‡åŒ€åœ°åˆ†å¸ƒåœ¨åŠçƒå†…éƒ¨ã€‚æ³¨æ„ï¼Œç§¯åˆ†æ˜¯è¿ç»­å‡½æ•°ï¼Œåœ¨é‡‡æ ·å‘é‡æ•°é‡å›ºå®šçš„æƒ…å†µä¸‹ç¦»æ•£åœ°é‡‡æ ·åªæ˜¯ä¸€ç§è¿‘ä¼¼è®¡ç®—æ–¹æ³•ï¼Œæˆ‘ä»¬é‡‡æ ·çš„å‘é‡è¶Šå¤šï¼Œå°±è¶Šæ¥è¿‘æ­£ç¡®çš„ç»“æœã€‚   <br>çº¹ç´ æ‰€ä»£è¡¨çš„æ–¹å‘çš„åŠçƒ`Î©`å†…ç”Ÿæˆå›ºå®šæ•°é‡çš„é‡‡æ ·å‘é‡ï¼Œå›¾è§£å¦‚ä¸‹ï¼š  <br>![<span class="hljs-number">3</span>](/img/<span class="hljs-number">00018</span>/irradiance.png)  <br>åå°„æ–¹ç¨‹çš„ç§¯åˆ†`âˆ«`æ˜¯å›´ç»•ç«‹ä½“è§’`dw`æ—‹è½¬ï¼Œè€Œè¿™ä¸ªç«‹ä½“è§’ç›¸å½“éš¾ä»¥å¤„ç†ã€‚ä¸ºäº†é¿å…å¯¹éš¾å¤„ç†çš„ç«‹ä½“è§’æ±‚ç§¯åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨çƒåæ ‡`Î¸`å’Œ`Ï•`æ¥ä»£æ›¿ç«‹ä½“è§’ã€‚å…¬å¼å¦‚ä¸‹ï¼š  <br>$$<br>L_&#123;o&#125;(p,\phi_&#123;o&#125;,\theta_&#123;o&#125;)=kd\frac&#123;c&#125;&#123;\pi&#125;\int_&#123;\phi=<span class="hljs-number">0</span>&#125;^&#123;<span class="hljs-number">2</span>\pi&#125;\int_&#123;\theta=<span class="hljs-number">0</span>&#125;^&#123;\frac&#123;<span class="hljs-number">1</span>&#125;&#123;<span class="hljs-number">2</span>&#125;\pi&#125;L_&#123;i&#125;(p,\phi_&#123;i&#125;,\theta_&#123;i&#125;)\<span class="hljs-built_in">cos</span>(\theta_&#123;i&#125;)\<span class="hljs-built_in">sin</span>(\theta_&#123;i&#125;)d\theta d\phi\\<br>=kd\frac&#123;c&#125;&#123;\pi&#125;\frac&#123;<span class="hljs-number">2</span>\pi&#125;&#123;n1&#125;\frac&#123;\pi&#125;&#123;<span class="hljs-number">2</span>\cdot n2&#125;\sum_&#123;m=<span class="hljs-number">0</span>&#125;^&#123;n1&#125;\sum_&#123;n=<span class="hljs-number">0</span>&#125;^&#123;n2&#125;L_&#123;i&#125;(p,\phi_&#123;m&#125;,\theta_&#123;n&#125;)\<span class="hljs-built_in">cos</span>(\theta_&#123;n&#125;)\<span class="hljs-built_in">sin</span>(\theta_&#123;n&#125;)\\<br>=kd\frac&#123;c\pi&#125;&#123;n1\cdot n2&#125;\sum_&#123;m=<span class="hljs-number">0</span>&#125;^&#123;n1&#125;\sum_&#123;n=<span class="hljs-number">0</span>&#125;^&#123;n2&#125;L_&#123;i&#125;(p,\phi_&#123;m&#125;,\theta_&#123;n&#125;)\<span class="hljs-built_in">cos</span>(\theta_&#123;n&#125;)\<span class="hljs-built_in">sin</span>(\theta_&#123;n&#125;) \tag&#123;<span class="hljs-number">5</span>&#125;<br>$$<br>è¯¥ç»“æœç”±è’™ç‰¹å¡æ´›ç§¯åˆ†æ‰€å¾—ï¼Œ`Ï†`çš„æ¦‚ç‡å¯†åº¦ä¸º`<span class="hljs-number">1</span>/<span class="hljs-number">2</span>PI`ï¼Œ`Î¸`çš„æ¦‚ç‡å¯†åº¦ä¸º`<span class="hljs-number">2</span>/PI`ï¼Œå…¶ä¸­æ·»åŠ çš„`<span class="hljs-built_in">sin</span>(Î¸)`æ˜¯ä¸ºäº†æƒè¡¡è¾ƒé«˜åŠçƒåŒºåŸŸçš„è¾ƒå°é‡‡æ ·åŒºåŸŸçš„è´¡çŒ®åº¦å¦‚å›¾ï¼š  <br>![<span class="hljs-number">4</span>](/img/<span class="hljs-number">00018</span>/image.png)  <br>ç»™å®šæ¯ä¸ªç‰‡æ®µçš„ç§¯åˆ†çƒåæ ‡ï¼Œå¯¹åŠçƒè¿›è¡Œç¦»æ•£é‡‡æ ·ï¼Œè¿‡ç¨‹ä»£ç å¦‚ä¸‹ï¼š  <br>``` cpp<br><span class="hljs-type">const</span> <span class="hljs-type">float</span> PI = <span class="hljs-number">3.14159265359</span>;<br><span class="hljs-type">void</span> <span class="hljs-built_in">main</span>()<br>&#123;		<br>    vec3 N = <span class="hljs-built_in">normalize</span>(WorldPos);<br>    vec3 irradiance = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);   <br>    <span class="hljs-comment">// tangent space calculation from origin point</span><br>    vec3 up    = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>);<br>    vec3 right = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">cross</span>(up, N));<br>    up         = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">cross</span>(N, right));<br>    <span class="hljs-type">float</span> sampleDelta = <span class="hljs-number">0.025</span>;<br>    <span class="hljs-type">float</span> nrSamples = <span class="hljs-number">0.0f</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">float</span> phi = <span class="hljs-number">0.0</span>; phi &lt; <span class="hljs-number">2.0</span> * PI; phi += sampleDelta)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">float</span> theta = <span class="hljs-number">0.0</span>; theta &lt; <span class="hljs-number">0.5</span> * PI; theta += sampleDelta)<br>        &#123;<br>            <span class="hljs-comment">// spherical to cartesian (in tangent space)</span><br>            vec3 tangentSample = <span class="hljs-built_in">vec3</span>(<span class="hljs-built_in">sin</span>(theta) * <span class="hljs-built_in">cos</span>(phi),  <span class="hljs-built_in">sin</span>(theta) * <span class="hljs-built_in">sin</span>(phi), <span class="hljs-built_in">cos</span>(theta));<br>            <span class="hljs-comment">// tangent space to world</span><br>            vec3 sampleVec = tangentSample.x * right + tangentSample.y * up + tangentSample.z * N; <br>            irradiance += <span class="hljs-built_in">texture</span>(uEnvironmentMap, sampleVec).rgb * <span class="hljs-built_in">cos</span>(theta) * <span class="hljs-built_in">sin</span>(theta);<br>            nrSamples++;<br>        &#125;<br>    &#125;<br>    irradiance = PI * irradiance * (<span class="hljs-number">1.0</span> / <span class="hljs-built_in">float</span>(nrSamples));<br>    FragColor = <span class="hljs-built_in">vec4</span>(irradiance, <span class="hljs-number">1.0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
çƒåæ ‡ç³»è½¬ç¬›å¡å°”åæ ‡ç³»ï¼Œå¾—åˆ°çš„æ˜¯åˆ‡çº¿ç©ºé—´çš„å‘é‡ï¼Œéœ€è¦ç”¨<code>TBN</code>çŸ©é˜µå°†è¯¥å‘é‡è½¬è‡³ä¸–ç•Œç©ºé—´ã€‚æœ€åå¾—åˆ°æ¼«åå°„è¾ç…§åº¦è´´å›¾å¦‚ä¸‹ï¼š<br />
<img src="/img/00018/image-1.png" srcset="/img/loading.gif" lazyload alt="5" /><br />
ç³Šçš„å¾ˆï¼Œæ ¹æœ¬æ²¡æœ‰ç»†èŠ‚å¯è¨€ã€‚</p>
<h3 id="splitsumå’Œggxé‡è¦æ€§é‡‡æ ·">SplitSumå’ŒGGXé‡è¦æ€§é‡‡æ ·</h3>
<p>ä¸ºäº†ç†è§£ï¼Œæˆ‘ä»¬å›é¡¾ä¸€ä¸‹åå°„æ–¹ç¨‹ï¼Œä½†è¿™æ¬¡åªå…³æ³¨é•œé¢åå°„éƒ¨åˆ†ï¼ˆåœ¨ä¸Šä¸€èŠ‚ä¸­å·²ç»å‰¥ç¦»äº†æ¼«åå°„éƒ¨åˆ†ï¼‰ï¼š<br />
<span class="math display">\[
L_{o}(p,w_{o})=\int_{\Omega}(\frac{DFG}{4(w_{o}\cdot n)(w_{i}\cdot
n)})L_{i}(p,w_{i})n\cdot w_{i}dw_{i} \tag{6}
\]</span>
å¯¹è¿™éƒ¨åˆ†ç§¯åˆ†è¿›è¡Œé¢„è®¡ç®—æœ‰ä¸ªæ£˜æ‰‹çš„åœ°æ–¹ï¼Œå®ƒä¸ä»…ä¾èµ–<code>wi</code>è¿˜ä¾èµ–<code>wo</code>ï¼Œæˆ‘ä»¬ä¸å¯èƒ½å§<code>wi</code>å’Œ<code>wo</code>çš„æ¯ç§ç»„åˆéƒ½è¿›è¡Œé¢„è®¡ç®—(wi(Î¸ï¼ŒÏ†),wo(Î¸ï¼ŒÏ†),F0,roughness,ä¸€å…±å…­ä¸ªç»´åº¦ä¹Ÿæ— æ³•é¢„è®¡ç®—)ï¼Œæ‰€ä»¥<code>Epic Games</code>æå‡ºäº†ä¸€ä¸ªæ–°çš„è§£å†³æ–¹æ³•<a
target="_blank" rel="noopener" href="http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf">split
sum</a>ï¼š<br />
<span class="math display">\[
\int_{\Omega}(\frac{DFG}{4(w_{o}\cdot n)(w_{i}\cdot
n)})L_{i}(p,w_{i})n\cdot w_{i}dw_{i} \\
\approx\frac{1}{N}\sum_{k=1}^{N}\frac{L_{i}(p,w_{ik})f_{r}(p,w_{ik},w_{ok})\cos(\theta_{ik})}{p(w_{ik},w_{ok})}
\\
\approx(\frac{1}{N}\sum_{k=1}^{N}L_{i}(p,w_{ik}))(\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{ik},w_{ok})\cos(\theta_{ik})}{p(w_{ik},w_{ok})})
\tag{7}
\]</span>
è¯¥å¼å­å·¦è¾¹æ˜¯ä¸€ä¸ªæ±‚å’Œï¼Œå³è¾¹æ˜¯è’™ç‰¹å¡æ´›ç§¯åˆ†ï¼Œå·¦å³åˆ†åˆ«ä¸ºä¸¤ç»´åº¦ï¼Œå¯ä»¥ç›´æ¥æŸ¥è¡¨ã€‚å·¦è¾¹wiæ˜¯ä¸¤ç»´åº¦å¥½ç†è§£ï¼Œå³è¾¹ä¸¤ç»´åº¦æˆ‘åœ¨åé¢ç« èŠ‚è§£é‡Šã€‚æˆ‘ä»¬åˆ†åˆ«å¯¹è¿™ä¸¤éƒ¨åˆ†è¿›è¡Œé¢„è®¡ç®—å°±å¯ä»¥è§£å†³ä¸Šé¢æ£˜æ‰‹çš„éƒ¨åˆ†ã€‚<br />
ä½†æ˜¯å®ƒä»¬éƒ½æ˜¯å»ºç«‹åœ¨<code>GGXé‡è¦æ€§é‡‡æ ·</code>çš„åŸºç¡€ä¸Šï¼Œå…ˆä»‹ç»ä¸€ä¸‹é‡è¦æ€§é‡‡æ ·ï¼š<br />
æˆ‘ä»¬ä½¿ç”¨çƒé¢åæ ‡ç”Ÿæˆå‡åŒ€åˆ†å¸ƒåœ¨åŠçƒ<code>Î©</code>ä¸Šçš„é‡‡æ ·å‘é‡ï¼Œä»¥å¯¹ç¯å¢ƒè´´å›¾è¿›è¡Œå·ç§¯ã€‚è™½ç„¶è¿™ä¸ªæ–¹æ³•éå¸¸é€‚ç”¨äºè¾ç…§åº¦ï¼Œä½†å¯¹äºé•œé¢åå°„æ•ˆæœè¾ƒå·®ã€‚é•œé¢åå°„ä¾èµ–äºè¡¨é¢çš„ç²—ç³™åº¦ï¼Œåå°„å…‰çº¿å¯èƒ½æ¯”è¾ƒæ¾æ•£ï¼Œä¹Ÿå¯èƒ½æ¯”è¾ƒç´§å¯†ï¼Œä½†æ˜¯ä¸€å®šä¼šå›´ç»•ç€åå°„å‘é‡<code>r</code>ï¼Œé™¤éè¡¨é¢æåº¦ç²—ç³™:<br />
<img src="/img/00018/image-2.png" srcset="/img/loading.gif" lazyload alt="6" /><br />
æ‰€æœ‰å¯èƒ½å‡ºå°„çš„åå°„å…‰æ„æˆçš„å½¢çŠ¶ç§°ä¸ºé•œé¢æ³¢ç“£ã€‚éšç€ç²—ç³™åº¦çš„å¢åŠ ï¼Œé•œé¢æ³¢ç“£çš„å¤§å°å¢åŠ ï¼›éšç€å…¥å°„å…‰æ–¹å‘ä¸åŒï¼Œå½¢çŠ¶ä¼šå‘ç”Ÿå˜åŒ–ã€‚å› æ­¤ï¼Œé•œé¢æ³¢ç“£çš„å½¢çŠ¶é«˜åº¦ä¾èµ–äºæè´¨ã€‚
åœ¨å¾®è¡¨é¢æ¨¡å‹é‡Œç»™å®šå…¥å°„å…‰æ–¹å‘ï¼Œåˆ™é•œé¢æ³¢ç“£æŒ‡å‘å¾®å¹³é¢çš„åŠå‘é‡çš„åå°„æ–¹å‘ã€‚è€ƒè™‘åˆ°å¤§å¤šæ•°å…‰çº¿æœ€ç»ˆä¼šåå°„åˆ°ä¸€ä¸ªåŸºäºåŠå‘é‡çš„é•œé¢æ³¢ç“£å†…ï¼Œé‡‡æ ·æ—¶ä»¥ç±»ä¼¼çš„æ–¹å¼é€‰å–é‡‡æ ·å‘é‡æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå¤§éƒ¨åˆ†å…¶ä½™çš„å‘é‡éƒ½è¢«æµªè´¹æ‰äº†ã€‚æ ¹æ®è¡¨é¢ç²—ç³™åº¦ç”Ÿæˆæ³•çº¿<code>N</code>ï¼Œç„¶åä»¥é•œé¢åå°„çš„å½¢å¼è®¡ç®—å‡ºé‡‡æ ·æ–¹å‘çš„è¿‡ç¨‹ç§°ä¸º<code>é‡è¦æ€§é‡‡æ ·</code>ã€‚<br />
è¦ç†è§£é‡è¦æ€§é‡‡æ ·éœ€è¦å…ˆç†è§£<a
target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Inverse_transform_sampling">é€†å˜æ¢é‡‡æ ·</a>ï¼Œé€†å˜æ¢é‡‡æ ·æ˜¯ç”¨rangeä¸º[0,1]ä¹‹é—´çš„å‡åŒ€éšæœºæ•°æ¥ç”Ÿæˆæœä»pdfçš„æ ·æœ¬ï¼Œå…¶è¿‡ç¨‹å¦‚ä¸‹ï¼š<br />
1.ä»å‡åŒ€åˆ†å¸ƒ<code>U[0,1]</code>ä¸­äº§ç”Ÿä¸€ä¸ªéšæœºæ•°<code>ui</code><br />
2.è®¡ç®—<span
class="math inline">\(x_{i}=F_{X}^{-1}(u_{i})\)</span>ä½œä¸ºé‡‡æ ·ç»“æœ<br />
å…¶ä¸­<span
class="math inline">\(F_{X}(x)\)</span>ä¸º<code>CDF</code>(ç´¯ç§¯åˆ†å¸ƒå‡½æ•°)æ‰€æœ‰çš„<code>CDF</code>ä¸­ï¼Œåœ¨<code>x</code>è¶‹è¿‘æœ€å°å€¼æ—¶ï¼Œ<code>CDF</code>è¶‹è¿‘äº<code>0</code>ï¼Œå½“<code>x</code>è¶‹è¿‘æœ€å¤§å€¼æ—¶ï¼Œ<code>CDF</code>è¶‹è¿‘ä¸<code>1</code>ã€‚<br />
<span
class="math inline">\(f_{X}(x)\)</span>ä¸ºéšæœºå˜é‡<code>X</code>çš„<code>pdf</code>(æ¦‚ç‡å¯†åº¦å‡½æ•°)ã€‚è¿™æ˜¯å®ƒä»¬çš„å…³ç³»<span
class="math inline">\(F_{X}(x)=\int_{-\infty}^{x}f_{X}(u)du\)</span><br />
<span
class="math inline">\(F_{X}^{-1}(x)\)</span>ä¸º<code>cdf</code>çš„åå‡½æ•°ï¼Œåªæœ‰å•è°ƒéå‡çš„å‡½æ•°æ‰æœ‰åå‡½æ•°ã€‚
<code>GGXé‡è¦æ€§é‡‡æ ·</code>ç”¨çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸º<a
target="_blank" rel="noopener" href="https://www.reedbeta.com/blog/hows-the-ndf-really-defined/">D(h)dot(n,h)</a>ï¼Œå…¶åœ¨çƒåæ ‡ç³»ä¸‹çš„æ¦‚ç‡å¯†åº¦å‡½æ•°ä¸ºï¼š
<span class="math display">\[
p_{h}(\theta,\phi)=\frac{\alpha^{2}\cos(\theta)\sin(\theta)}{\pi((\alpha^{2}-1)\cos^{2}(\theta)+1)^{2}}
\tag{8}
\]</span> åˆ†åˆ«æ±‚Î¸å’ŒÏ†çš„è¾¹ç¼˜æ¦‚ç‡å¯†åº¦å‡½æ•°(pdf)ï¼š <span
class="math display">\[
p_{h}(\theta)=\int_{0}^{2\pi}p_{h}(\theta,\phi)d\phi=\frac{2\alpha^{2}\cos(\theta)\sin(\theta)}{((\alpha^{2}-1)\cos^{2}(\theta)+1)^{2}}
\tag{9}
\]</span> <span class="math display">\[
p_{h}(\phi)=\int_{0}^{\frac{\pi}{2}}\frac{\alpha^{2}\cos(\theta)\sin(\theta)}{\pi((\alpha^2-1)\cos^{2}(\theta)+1)^{2}}d\theta
\\
=-\frac{\alpha^{2}}{2\pi}\int_{0}^{\frac{\pi}{2}}\frac{-2\cos(\theta)\sin(\theta)}{((\alpha^2-1)\cos^{2}(\theta)+1)^{2}}d\theta
\\
=\frac{\alpha^{2}}{2\pi}\int_{\frac{\pi}{2}}^{0}\frac{1}{(\alpha^2-1)\cos^{2}(\theta)+1)^{2}}d(\cos^{2}\theta)
\\
=\frac{\alpha^{2}}{2\pi}\int_{0}^{1}\frac{1}{((\alpha^{2}-1)t+1)^{2}}dt
\\
\]</span> ä»¤<code>x=(Î±^2-1)t+1</code> <span class="math display">\[
=\frac{\alpha^{2}}{2\pi(\alpha^2-1)}\int_{1}^{\alpha^2}\frac{1}{x^{2}}dx
\\
=\frac{\alpha^{2}}{2\pi(1-\alpha^2)}\frac{1}{x}\vert_{1}^{\alpha^2} \\
=\frac{1}{2\pi} \tag{10}
\]</span> å†åˆ†åˆ«æ±‚<code>Î¸</code>å’Œ<code>Ï†</code>çš„ç´¯è®¡åˆ†å¸ƒå‡½æ•°(cdf):
<span class="math display">\[
P_{h}(\phi)=\int_{0}^{\phi}\frac{1}{2\pi}dt=\frac{\phi}{2\pi} \tag{11}
\]</span> <span class="math display">\[
P_{h}(\theta)=\int_{0}^{\theta}\frac{2\alpha^{2}\cos(t)\sin(t)}{((\alpha^{2}-1)\cos^{2}(t)+1)^{2}}dt
\\
=\alpha^{2}\int_{\theta}^{0}\frac{1}{(\alpha^2-1)\cos^{2}(t)+1)^{2}}d(\cos^{2}(t))
\\
=\frac{\alpha^2}{\alpha^2-1}\int_{\alpha^2}^{(\alpha^2-1)\cos^{2}(\theta)+1}-\frac{1}{x^{2}}dx
\\
=\frac{\alpha^2}{\alpha^2-1}\frac{1}{x}\vert_{\alpha^{2}}^{(\alpha^2-1)\cos^{2}(\theta)+1}
\\
=\frac{\alpha^{2}}{\alpha^{2}-1}\cdot
(\frac{1}{(\alpha^2-1)\cos^{2}(\theta)+1}-\frac{1}{\alpha^{2}}) \tag{12}
\]</span>
åå‡½æ•°å°±æ˜¯å‡½æ•°å€¼åŸŸ<code>Y</code>å’Œå®šä¹‰åŸŸ<code>X</code>çš„æ˜ å°„å…³ç³»ç¿»è½¬ä¸€ä¸‹ã€‚
å‡åŒ€çš„ä»<code>U[0,1]</code>ä¸­å–å‡ºä¸¤ä¸ªéšæœºæ•°<span
class="math inline">\(X_{1}\)</span>å’Œ<span
class="math inline">\(X_{2}\)</span>,åˆ™æˆ‘ä»¬è¦çš„é‡‡æ ·<code>Î¸</code>å’Œ<code>Ï†</code>ä¸ºï¼š<br />
<span class="math display">\[
\phi=2\pi X_{1} \tag{13}
\]</span> <span class="math display">\[
\theta=\arccos\sqrt{\frac{1-X_{2}}{X_{2}(\alpha^{2}-1)+1}} \tag{14}
\]</span> å¯¹åº”ä»£ç å®ç°å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">ImportanceSampleGGX</span><span class="hljs-params">(vec2 Xi, vec3 N, <span class="hljs-type">float</span> roughness)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">float</span> a = roughness*roughness;	<br>	<span class="hljs-type">float</span> phi = <span class="hljs-number">2.0</span> * PI * Xi.x;<br>	<span class="hljs-type">float</span> cosTheta = <span class="hljs-built_in">sqrt</span>((<span class="hljs-number">1.0</span> - Xi.y) / (<span class="hljs-number">1.0</span> + (a*a - <span class="hljs-number">1.0</span>) * Xi.y));<br>	<span class="hljs-type">float</span> sinTheta = <span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1.0</span> - cosTheta*cosTheta);<br>	<span class="hljs-comment">// from spherical coordinates to cartesian coordinates - halfway vector</span><br>	vec3 H;<br>	H.x = <span class="hljs-built_in">cos</span>(phi) * sinTheta;<br>	H.y = <span class="hljs-built_in">sin</span>(phi) * sinTheta;<br>	H.z = cosTheta;<br>	<span class="hljs-comment">// from tangent-space H vector to world-space sample vector</span><br>	vec3 up          = <span class="hljs-built_in">abs</span>(N.z) &lt; <span class="hljs-number">0.999</span> ? <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>) : <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>);<br>	vec3 tangent   = <span class="hljs-built_in">normalize</span>(<span class="hljs-built_in">cross</span>(up, N));<br>	vec3 bitangent = <span class="hljs-built_in">cross</span>(N, tangent);<br>	vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">normalize</span>(sampleVec);<br>&#125;<br></code></pre></td></tr></table></figure> ### é•œé¢åå°„å…‰ç…§çš„é¢„è®¡ç®—</p>
<p>ä¸ŠèŠ‚å†…å®¹æåˆ°ç”¨<code>Split Sum</code>æ¥åˆ†å‰²é•œé¢åå°„çš„å…‰ç…§å’ŒBRDFéƒ¨åˆ†ä»¥é¿å…å»æ±‚wiå’Œwoæ‰€æœ‰ç»„åˆä¸‹çš„ç§¯åˆ†ã€‚æœ¬èŠ‚é‡è¦ç‚¹æ”¾åœ¨é•œé¢åå°„å…‰ç…§çš„é¢„è®¡ç®—ï¼Œæˆ‘ä»¬å†çœ‹ä¸‹è¿™éƒ¨åˆ†çš„å…¬å¼ï¼š<br />
<span class="math display">\[
\frac{1}{N}\sum_{k=1}^{N}L_{i}(p,w_{ik}) \tag{15}
\]</span>
è¿™é‡Œå¯ä»¥çœ‹åšæ˜¯ä¸€æ¬¡æ±‚å’Œå–å¹³å‡ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œè¿™é‡Œçš„wiä¸ä»…éœ€è¦<code>GGXé‡è¦æ€§é‡‡æ ·</code>å¾—åˆ°çš„ç¬¦åˆ<code>D(h)dot(n,h)æ¦‚ç‡å¯†åº¦å‡½æ•°</code>çš„å¾®è¡¨é¢æ³•çº¿æ–¹å‘ï¼Œè¿˜éœ€è¦è§†è§’æ–¹å‘<code>V</code>,ä½†æ˜¯æˆ‘ä»¬å¹¶ä¸èƒ½æå‰çŸ¥é“<code>V</code>æ˜¯ä»€ä¹ˆæ–¹å‘ï¼Œè¿™é‡Œ<code>Epic Games</code>å†ä¸€æ¬¡å‡è®¾ï¼Œå³<code>v=r=n</code>ã€‚è¿™ç§å„å‘åŒæ€§å‡è®¾æ˜¯ç¬¬äºŒä¸ªè¿‘ä¼¼æ¥æºï¼Œä¸å¹¸çš„æ˜¯ï¼Œè¿™æ„å‘³åœ¨æ å…¥å°„è§’æ—¶ä¸ä¼šå¾—åˆ°é•¿åå°„æ•ˆæœï¼š<br />
<img src="/img/00018/image-3.png" srcset="/img/loading.gif" lazyload alt="7" /><br />
ä¸åˆ†è£‚å’Œè¿‘ä¼¼ç›¸æ¯”ï¼Œè¿™å®é™…ä¸Šæ˜¯æˆ‘ä»¬<code>IBL</code>è§£çš„è¾ƒå¤§è¯¯å·®æºã€‚ä»£ç ä¸­é€šè¿‡<code>cosÎ¸lk</code>åŠ æƒå¯ä»¥è·å¾—æ›´å¥½çš„ç»“æœï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;		<br>    vec3 N = <span class="hljs-built_in">normalize</span>(WorldPos);<br>    <span class="hljs-comment">// make the simplifying assumption that V equals R equals the normal </span><br>    vec3 R = N;<br>    vec3 V = R;<br>    <span class="hljs-type">const</span> uint SAMPLE_COUNT = <span class="hljs-number">1024u</span>;<br>    vec3 prefilteredColor = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);<br>    <span class="hljs-type">float</span> totalWeight = <span class="hljs-number">0.0</span>;<br>    <span class="hljs-keyword">for</span>(uint i = <span class="hljs-number">0u</span>; i &lt; SAMPLE_COUNT; ++i)<br>    &#123;<br>        <span class="hljs-comment">// generates a sample vector that&#x27;s biased towards the preferred alignment direction (importance sampling).</span><br>        vec2 Xi = <span class="hljs-built_in">Hammersley</span>(i, SAMPLE_COUNT);<br>        vec3 H = <span class="hljs-built_in">ImportanceSampleGGX</span>(Xi, N, uRoughness);<br>        vec3 L  = <span class="hljs-built_in">normalize</span>(<span class="hljs-number">2.0</span> * <span class="hljs-built_in">dot</span>(V, H) * H - V);<br>        <span class="hljs-comment">//COS weight can increase image quality</span><br>        <span class="hljs-type">float</span> NdotL = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N, L), <span class="hljs-number">0.0</span>);<br>        <span class="hljs-keyword">if</span>(NdotL &gt; <span class="hljs-number">0.0</span>)<br>        &#123;<br>            <span class="hljs-comment">// sample from the environment&#x27;s mip level based on roughness/pdf</span><br>            <span class="hljs-type">float</span> D   = <span class="hljs-built_in">DistributionGGX</span>(N, H, uRoughness);<br>            <span class="hljs-type">float</span> NdotH = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N, H), <span class="hljs-number">0.0</span>);<br>            <span class="hljs-type">float</span> HdotV = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(H, V), <span class="hljs-number">0.0</span>);<br>            <span class="hljs-type">float</span> pdf = D * NdotH / (<span class="hljs-number">4.0</span> * HdotV) + <span class="hljs-number">0.0001</span>; <br>            <span class="hljs-type">float</span> resolution = <span class="hljs-number">512.0</span>; <span class="hljs-comment">// resolution of source cubemap (per face)</span><br>            <span class="hljs-type">float</span> saTexel  = <span class="hljs-number">4.0</span> * PI / (<span class="hljs-number">6.0</span> * resolution * resolution);<br>            <span class="hljs-type">float</span> saSample = <span class="hljs-number">1.0</span> / (<span class="hljs-built_in">float</span>(SAMPLE_COUNT) * pdf + <span class="hljs-number">0.0001</span>);<br>            <span class="hljs-comment">//sample solid angle ratio to pixel solid angle</span><br>            <span class="hljs-type">float</span> mipLevel = uRoughness == <span class="hljs-number">0.0</span> ? <span class="hljs-number">0.0</span> : <span class="hljs-number">0.5</span> * <span class="hljs-built_in">log2</span>(saSample / saTexel);        <br>            prefilteredColor += <span class="hljs-built_in">textureLod</span>(uEnvironmentMap, L, mipLevel).rgb * NdotL;<br>            totalWeight      += NdotL;<br>        &#125;<br>    &#125;<br>    prefilteredColor = prefilteredColor / totalWeight;<br>    FragColor = <span class="hljs-built_in">vec4</span>(prefilteredColor, <span class="hljs-number">1.0</span>);<br>&#125;<br></code></pre></td></tr></table></figure> ä»£ç ä¸­çš„<code>pdf</code>æ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹ï¼Œå›¾ç‰‡æ¥æºäº<a
target="_blank" rel="noopener" href="https://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.pdf">2007å¹´è®ºæ–‡</a>ï¼š<br />
<span class="math display">\[
p_{o}(\theta,\phi)=p_{h}(\theta,\phi)\cdot\lVert\frac{\partial
w_{h}}{\partial w_{o}}\rVert \tag{16}
\]</span> <img src="/img/00018/pdf-derivation.png" srcset="/img/loading.gif" lazyload alt="8" /><br />
<span class="math display">\[
\lVert\frac{\partial w_{h}}{\partial w_{o}}\rVert=\frac{\vert o\cdot
h\vert}{\lVert\vec{h}\rVert^{2}} \\
=\frac{\vert o\cdot h\vert}{\lVert 2(o\cdot h)h\rVert^{2}}
=\frac{\vert o\cdot h\vert}{4(o\cdot h)^{2}\lVert
h\rVert^{2}}=\frac{1}{4\vert o\cdot h\vert} \tag{17}
\]</span>
å…¶ä¸­<code>i</code>ï¼Œ<code>o</code>å’Œ<code>æ²¡ç®­å¤´çš„h</code>ï¼Œéƒ½æ˜¯å½’ä¸€åŒ–åçš„å‘é‡ã€‚è¿™åªæ˜¯åå°„æ¨¡å‹çš„<code>pdf</code>ï¼Œä»¥åŒæ ·çš„è®¡ç®—æ–¹æ³•è®ºæ–‡ä½œè€…è¿˜ç»™å‡ºäº†æŠ˜å°„çš„<code>pdf</code>ï¼Œæ„Ÿå…´è¶£å¯ä»¥å»çœ‹ä¸‹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œæ¨å¯¼æ¶‰åŠçš„iï¼Œoå’Œä»£ç ä¸­çš„vï¼ŒLæ²¡å…³ç³»ï¼Œåªæ˜¯å•çº¯ç”¨æ¥æ¨å¯¼çš„,ä¸€èˆ¬æ¥è¯´æˆ‘ä»¬è§†<code>i</code>ä¸ºå…‰ç…§æ–¹å‘ï¼Œ<code>o</code>ä¸ºè§†è§’æ–¹å‘ã€‚</p>
<p>ä»£ç ä¸­<a
target="_blank" rel="noopener" href="https://developer.nvidia.com/gpugems/gpugems3/part-iii-rendering/chapter-20-gpu-based-importance-sampling">é‡‡æ ·</a>æ˜¯å¯¹<code>uEnvironmentMap</code>çš„<code>mipmap</code>æ¥é‡‡æ ·ï¼Œè€Œä¸æ˜¯ç›´æ¥å»è·å–æ¸…æ™°åº¦æœ€é«˜çš„<code>uEnvironmentMap</code>,è¿™æ ·åšçš„åŸå› æ˜¯<code>pdf</code>è¶Šä½ï¼Œæ ·æœ¬æ‰€å¯¹åº”çš„ç¯å¢ƒè´´å›¾ä¸­å¹³å‡åƒç´ æ•°å°±è¶Šå¤šï¼Œä½¿ç”¨çš„<code>mipmap</code>å±‚çº§åº”è¯¥è¶Šå¤§ï¼Œè¿™å¯ä»¥åšåˆ°å°‘é‡‡æ ·æ•°é‡è¾¾åˆ°å¤šé‡‡æ ·æ•°é‡çš„æ•ˆæœï¼Œå¹¶å‡å°‘ä¼ªå½±ã€‚æˆ‘ä»¬ç”¨ä¸æ ·æœ¬ç›¸å…³çš„å®ä½“è§’æ¥å®šä¹‰è¿™ç§å…³ç³»ï¼Œè®¡ç®—æ–¹æ³•æ˜¯<code>pdf</code>ä¸æ ·æœ¬æ€»æ•°<code>N</code>ä¹‹é—´ä¹˜ç§¯çš„å€’æ•°ï¼š<br />
<span class="math display">\[
\Omega_{s}=\frac{1}{N\cdot p_{L}(\theta,\phi)} \tag{18}
\]</span>
è¯¥å¼å­è¡¨ç¤ºé‡‡æ ·æ–¹å‘æ‰€å¯¹åº”çš„ç¯å¢ƒè´´å›¾ä¸­åƒç´ æ•°çš„å¤šå°‘(é‡‡æ ·ç«‹ä½“è§’çš„å¤§å°)ã€‚æˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ç«‹æ–¹ä½“è´´å›¾ä¸­ä¸€ä¸ªåƒç´ å¯¹åº”çš„ç«‹ä½“è§’æ˜¯å¤šå¤§,æˆ‘ä»¬è¿™é‡Œæ˜¯æ±‚å•ä½çƒè¡¨é¢ç§¯æ¯”ä¸Šç«‹æ–¹ä½“åˆ†è¾¨ç‡ï¼š<br />
<span class="math display">\[
\Omega_{p}=\frac{d(u)}{w\cdot h} \tag{19}
\]</span>
åŸæ–‡è¿™ä¸ª<code>d(u)</code>æ˜¯è®¡ç®—ä»åŠçƒçš„å•ä½é¢ç§¯åˆ°çº¹ç†ä¸Šçš„å•ä½é¢ç§¯çš„å˜åŒ–é€Ÿç‡ï¼ˆæ¢å¥è¯è¯´ï¼Œè®¡ç®—æ˜ å°„çš„ç•¸å˜ç‡ï¼‰ï¼ŒåŸæ–‡<code>d(u)</code>æ˜¯åº”ç”¨åœ¨å¦ä¸€ç§é‡‡æ ·æ–¹å¼ï¼Œä¸æ˜¯åœ¨ç«‹æ–¹ä½“è´´å›¾ä¸Šé¢è¿›è¡Œçš„é‡‡æ ·ï¼Œå’Œæˆ‘ä»¬è¿™é‡Œä¸ä¸€æ ·ï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥ç®—ç«‹æ–¹ä½“è´´å›¾ä¸Šä¸€ä¸ªåƒç´ å¯¹åº”çš„ç«‹ä½“è§’å¤§å°å°±è¡Œã€‚é‚£<code>d(u)</code>ç›´æ¥å°±æ˜¯å•ä½çƒçš„è¡¨é¢ç§¯<code>4Ï€</code>ã€‚<br />
æœ€åç”¨ä¸‹é¢è¿™ä¸ªå…¬å¼è®¡ç®—<code>mipmap</code>å±‚æ•°ï¼š<br />
<span class="math display">\[
level=max[\frac{1}{2}\log_{2}\frac{\Omega_{s}}{\Omega_{p}},0] \tag{20}
\]</span>
æœ€åè®¡ç®—å®Œçš„<code>prefilteredColor</code>æ ¹æ®ç²—ç³™åº¦<code>[0,1]</code>ï¼Œåˆ†åˆ«å­˜å…¥<code>prefilterMap</code>çš„<code>5</code>å±‚<code>mipmap</code>ä¸­ï¼Œåœ¨æœ€å<code>shading</code>è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®ç²—ç³™åº¦æ¥è·å–<code>prefilteredColor</code>å±‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š<br />
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js">gl.<span class="hljs-title function_">bindFramebuffer</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>, captureFBO);<br><span class="hljs-keyword">const</span> maxMipLevels = <span class="hljs-number">5</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> mip = <span class="hljs-number">0</span>; mip &lt; maxMipLevels; ++mip)<br>&#123;<br>    <span class="hljs-comment">// reisze framebuffer according to mip-level size.</span><br>    <span class="hljs-keyword">let</span> mipWidth  = <span class="hljs-number">128</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">0.5</span>, mip);<br>    <span class="hljs-keyword">let</span> mipHeight = <span class="hljs-number">128</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">0.5</span>, mip);<br>    gl.<span class="hljs-title function_">bindRenderbuffer</span>(gl.<span class="hljs-property">RENDERBUFFER</span>, captureRBO);<br>    gl.<span class="hljs-title function_">renderbufferStorage</span>(gl.<span class="hljs-property">RENDERBUFFER</span>, gl.<span class="hljs-property">DEPTH_COMPONENT24</span>, mipWidth, mipHeight);<br>    gl.<span class="hljs-title function_">viewport</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, mipWidth, mipHeight);<br>    <span class="hljs-keyword">let</span> roughness = mip / (maxMipLevels - <span class="hljs-number">1</span>);<br>    gl.<span class="hljs-title function_">uniform1f</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prefilterShader</span>.<span class="hljs-property">program</span>.<span class="hljs-property">uniforms</span>[<span class="hljs-string">&quot;uRoughness&quot;</span>],roughness);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; ++i)<br>    &#123;<br>        gl.<span class="hljs-title function_">uniformMatrix4fv</span>(<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prefilterShader</span>.<span class="hljs-property">program</span>.<span class="hljs-property">uniforms</span>[<span class="hljs-string">&quot;uViewMatrix&quot;</span>],<br>            <span class="hljs-literal">false</span>,<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">captureViews</span>[i]);<br>        gl.<span class="hljs-title function_">framebufferTexture2D</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>, gl.<span class="hljs-property">COLOR_ATTACHMENT0</span>, gl.<span class="hljs-property">TEXTURE_CUBE_MAP_POSITIVE_X</span> + i, <span class="hljs-variable language_">this</span>.<span class="hljs-property">prefilterMap</span>, mip);<br>        gl.<span class="hljs-title function_">clear</span>(gl.<span class="hljs-property">COLOR_BUFFER_BIT</span> | gl.<span class="hljs-property">DEPTH_BUFFER_BIT</span>);<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">renderCube</span>();<br>    &#125;<br>&#125;<br>gl.<span class="hljs-title function_">bindFramebuffer</span>(gl.<span class="hljs-property">FRAMEBUFFER</span>, <span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure> ä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œä¼šå¾—åˆ°ä¸‹é¢çš„å›¾ç‰‡ï¼š<br />
<img src="/img/00018/image-6.png" srcset="/img/loading.gif" lazyload alt="9" /></p>
<h3 id="é¢„è®¡ç®—brdf">é¢„è®¡ç®—BRDF</h3>
<p>æœ‰äº†ä¸Šé¢çš„åŸºç¡€ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°±æ¯”è¾ƒç®€å•äº†ï¼Œå¿«é€Ÿçœ‹ä¸€éå…¬å¼ï¼š<br />
<span class="math display">\[
\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{ik},w_{ok})\cos(\theta_{ik})}{p(w_{ik},w_{ok})}
\tag{21}
\]</span>
ä¸Šæ–‡è¯´åˆ°é•œé¢åå°„æ–¹ç¨‹æœ‰å…­ä¸ªç»´åº¦<code>wi(Î¸ï¼ŒÏ†)</code>,<code>wo(Î¸ï¼ŒÏ†)</code>,<code>F0</code>,<code>roughness</code>,ç”±äºå…‰ç…§éƒ¨åˆ†æˆ‘ä»¬å·²ç»å¤„ç†è¿‡äº†ï¼Œè€Œæ­¤æ—¶<code>BRDF</code>çš„<code>wi</code>å’Œ<code>wo</code>éƒ½æ˜¯å’Œ<code>n</code>ç»‘å®šåœ¨ä¸€èµ·çš„ï¼Œé‚£è¿™é‡Œ<code>BRDF</code>å°±åªå‰©ä¸‹<code>4</code>ä¸ªç»´åº¦<code>wiÂ·n</code>,<code>woÂ·n</code>,<code>F0</code>,<code>roughness</code>,ç”±äºé‡è¦æ€§é‡‡æ ·å¯ä»¥ç”±<code>wo</code>ç”Ÿæˆæœä»<code>D(h)dot(n,h)</code>æ¦‚ç‡å¯†åº¦å‡½æ•°çš„<code>wi</code>ï¼Œåˆ™ç»´åº¦å¯ä»¥å†é™åˆ°3ä¸ª<code>woÂ·n</code>,<code>F0</code>,<code>roughness</code>ï¼Œå†å°†<code>Fresnel</code>é¡¹æ‹†åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œ<code>F0</code>ä¹Ÿå¯ä»¥ç§»å‡ºç§¯åˆ†èŒƒå›´ï¼Œç»´åº¦å†é™åˆ°2ä¸ª<code>woÂ·n</code>,<code>roughness</code>ï¼Œè¿™æ ·å°±å¯ä»¥æ„‰å¿«çš„æ‰“è¡¨äº†ğŸ˜†ï¼ä¸‹é¢æ˜¯æ‹†åˆ†è¿‡ç¨‹ï¼Œæˆ‘è¿™é‡ŒæŠŠ<code>k</code>è§’æ ‡å»æ‰äº†æ–¹ä¾¿è§‚çœ‹ï¼š<br />
<span class="math display">\[
\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})\cos(\theta_{i})}{p(w_{i},w_{o})}
\\
=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})F(w_{o},h)\cos(\theta_{i})}{F(w_{o},h)p(w_{i},w_{o})}
\\
=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}(F0+(1-F0)(1-w_{o}\cdot
h)^{5})\cos(\theta_{i})
\]</span> è¿™é‡Œç”¨<code>Î±</code>ä»£æ›¿<code>(1-woÂ·h)^5</code>:<br />
<span class="math display">\[
=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}(F0+(1-F0)\alpha)\cos(\theta_{i})
\\
=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}(F0*(1-\alpha)+\alpha)\cos(\theta_{i})
\\
=\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}F0*(1-\alpha)\cos(\theta_{i})+\frac{1}{N}\sum_{k=1}^{N}\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}\alpha\cos(\theta_{i})
\tag{22}
\]</span> å¯ä»¥çœ‹åˆ°è¿™ä¸¤éƒ¨åˆ†éƒ½åŒ…å«ä¸€ä¸ªå…±åŒé¡¹ï¼š<br />
<span class="math display">\[
\frac{f_{r}(p,w_{i},w_{o})}{F(w_{o},h)p(w_{i},w_{o})}\cos(\theta_{i})
\]</span>
æˆ‘ä»¬å°†å…¶åŒ–ç®€ä¸€ä¸‹,å…¶ä¸­<code>pdf=D * NdotH / (4.0 * VdotH)</code>ï¼š<br />
<span class="math display">\[
=\frac{DG\cos(\theta_{i})}{4\cos(\theta_{o})\cos(\theta_{i})}\frac{4(o\cdot
h)}{D(n\cdot h)} \\
=\frac{G(o\cdot h)}{(o\cdot n)(n\cdot h)} \tag{23}
\]</span> å¸¦å…¥(22)å¼ä¸­å¾—ï¼š<br />
<span class="math display">\[
F0*\frac{1}{N}\sum_{k=1}^{N}\frac{G(o\cdot h)}{(o\cdot n)(n\cdot
h)}(1-(1-(w_{o}\cdot h)^{5}))+\frac{1}{N}\sum_{k=1}^{N}\frac{G(o\cdot
h)}{(o\cdot n)(n\cdot h)}(1-(w_{o}\cdot h)^{5}) \tag{24}
\]</span> ä»£ç å®ç°å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec2 <span class="hljs-title">IntegrateBRDF</span><span class="hljs-params">(<span class="hljs-type">float</span> NdotV, <span class="hljs-type">float</span> roughness)</span></span><br><span class="hljs-function"></span>&#123;<br>    vec3 V;<br>    V.x = <span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1.0</span> - NdotV*NdotV);<br>    V.y = <span class="hljs-number">0.0</span>;<br>    V.z = NdotV;<br>    <span class="hljs-type">float</span> A = <span class="hljs-number">0.0</span>;<br>    <span class="hljs-type">float</span> B = <span class="hljs-number">0.0</span>; <br>    vec3 N = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);<br>    <span class="hljs-type">const</span> uint SAMPLE_COUNT = <span class="hljs-number">1024u</span>;<br>    <span class="hljs-keyword">for</span>(uint i = <span class="hljs-number">0u</span>; i &lt; SAMPLE_COUNT; ++i)<br>    &#123;<br>        <span class="hljs-comment">// generates a sample vector that&#x27;s biased towards the</span><br>        <span class="hljs-comment">// preferred alignment direction (importance sampling).</span><br>        vec2 Xi = <span class="hljs-built_in">Hammersley</span>(i, SAMPLE_COUNT);<br>        vec3 H = <span class="hljs-built_in">ImportanceSampleGGX</span>(Xi, N, roughness);<br>        vec3 L = <span class="hljs-built_in">normalize</span>(<span class="hljs-number">2.0</span> * <span class="hljs-built_in">dot</span>(V, H) * H - V);<br>        <span class="hljs-type">float</span> NdotL = <span class="hljs-built_in">max</span>(L.z, <span class="hljs-number">0.0</span>);<br>        <span class="hljs-type">float</span> NdotH = <span class="hljs-built_in">max</span>(H.z, <span class="hljs-number">0.0</span>);<br>        <span class="hljs-type">float</span> VdotH = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(V, H), <span class="hljs-number">0.0</span>);<br>        <span class="hljs-keyword">if</span>(NdotL &gt; <span class="hljs-number">0.0</span>)<br>        &#123;<br>            <span class="hljs-type">float</span> G = <span class="hljs-built_in">GeometrySmith</span>(N, V, L, roughness);<br>            <span class="hljs-type">float</span> G_Vis = (G * VdotH) / (NdotH * NdotV);<br>            <span class="hljs-type">float</span> Fc = <span class="hljs-built_in">pow</span>(<span class="hljs-number">1.0</span> - VdotH, <span class="hljs-number">5.0</span>);<br>            <span class="hljs-comment">//pdf = D * NdotH / (4.0 * HdotV); </span><br>            A += (<span class="hljs-number">1.0</span> - Fc) * G_Vis;<br>            B += Fc * G_Vis;<br>        &#125;<br>    &#125;<br>    A /= <span class="hljs-built_in">float</span>(SAMPLE_COUNT);<br>    B /= <span class="hljs-built_in">float</span>(SAMPLE_COUNT);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">vec2</span>(A, B);<br>&#125;<br></code></pre></td></tr></table></figure> å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œä¼šå¾—åˆ°è¿™æ ·ä¸€å¼ çº¹ç†ï¼š<br />
<img src="/img/00018/image-4.png" srcset="/img/loading.gif" lazyload alt="10" /><br />
ä»£ç ä¸­debugå‡ºçš„æ ·å­å¦‚ä¸‹ï¼š<br />
<img src="/img/00018/image-5.png" srcset="/img/loading.gif" lazyload alt="11" /></p>
<h2 id="å®Œæˆiblåå°„">å®ŒæˆIBLåå°„</h2>
<p>å¯¹ä¸Šé¢å®Œæˆçš„ä¸‰éƒ¨åˆ†é¢„è®¡ç®—çº¹ç†è¿›è¡ŒæŸ¥è¡¨ï¼Œå³ç¯å¢ƒå…‰Cook-Torranceåå°„æ–¹ç¨‹çš„ç§¯åˆ†å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">fresnelSchlickRoughness</span><span class="hljs-params">(vec3 F0, vec3 V, vec3 N,<span class="hljs-type">float</span> roughness)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> F0 + (<span class="hljs-built_in">max</span>(<span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span> - roughness), F0) - F0) * <span class="hljs-built_in">pow</span>(<span class="hljs-number">1.0</span> - <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N,V),<span class="hljs-number">0.0</span>), <span class="hljs-number">5.0</span>);<br>&#125; <br>...<br><span class="hljs-comment">//ä»¥ç¯å¢ƒå…‰ä½œä¸ºIBL</span><br>vec3 F = <span class="hljs-built_in">fresnelSchlickRoughness</span>(F0,V,N,uRoughness);<br>vec3 kD = (<span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>) - F) * (<span class="hljs-number">1.0</span> - uMetallic);<br><span class="hljs-comment">//æ¼«åå°„å…‰ç…§é¡¹</span><br>vec3 irradiance = <span class="hljs-built_in">texture</span>(uIrradianceMap,N).rgb;<br>vec3 diffuse = irradiance * albedo;<br><span class="hljs-comment">//ä»¥ç¡®ä¿ä¸ä¼šå¯¹ä¸€ä¸ªæ²¡æœ‰æ•°æ®çš„mipçº§åˆ«é‡‡æ ·</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> MAX_REFLECTION_LOD = <span class="hljs-number">4.0</span>;<br><span class="hljs-comment">//é•œé¢åå°„å…‰ç…§é¡¹</span><br>vec3 prefilteredColor = <span class="hljs-built_in">textureLod</span>(uPrefilterMap,R,uRoughness * MAX_REFLECTION_LOD).rgb;<br><span class="hljs-comment">//BRDFé¡¹</span><br>vec2 brdf = <span class="hljs-built_in">texture</span>(uPbrBrdfLUT,<span class="hljs-built_in">vec2</span>(<span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N,V),<span class="hljs-number">0.0</span>),uRoughness)).rg;<br><span class="hljs-comment">//split sum</span><br>vec3 specular = prefilteredColor * (F0 * brdf.r + brdf.g);<br><span class="hljs-comment">//ç¯å¢ƒå…‰Cook-Torranceåå°„æ–¹ç¨‹çš„ç§¯åˆ†å€¼</span><br>vec3 ambient = (kD * diffuse + specular) * uAo;<br></code></pre></td></tr></table></figure>
ä½¿ç”¨<code>fresnelSchlickRoughness</code>å‡½æ•°ï¼Œæ˜¯ç”±äºç¯å¢ƒå…‰æ¥è‡ªåœ¨åŠçƒå†…æ‰€æœ‰å›´ç»•ç€æ³•çº¿<code>N</code>çš„æ–¹å‘ï¼Œæ²¡æœ‰å•ä¸€çš„åŠå‘é‡å»å†³å®šè²æ¶…å°”å› å­ã€‚ä¸ºäº†ä»ç„¶èƒ½æ¨¡æ‹Ÿè²æ¶…å°”ï¼Œè¿™é‡Œé‡‡ç”¨äº†æ³•çº¿å’Œè§†çº¿çš„å¤¹è§’ã€‚ä¹‹å‰çš„ç®—æ³•é‡‡ç”¨äº†å—è¡¨é¢ç²—ç³™åº¦å½±å“çš„å¾®å¹³é¢åŠå‘é‡ï¼Œä½œä¸ºè²æ¶…å°”æ–¹ç¨‹çš„è¾“å…¥ã€‚è¿™é‡Œæˆ‘ä»¬åŠ å…¥ç²—ç³™åº¦æ¥æƒè¡¡è¿™ä¸€æŸå¤±ã€‚<br />
ç„¶åå°†<code>ambient</code>åŠ åˆ°æ­£å¸¸çš„<code>PBR</code>æ¨¡å‹ä¸Šå°±å¤§åŠŸå‘Šæˆäº†ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp">vec3 albedo = <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">texture</span>(uAlbedoMap, vTexCoords).rgb,<span class="hljs-built_in">vec3</span>(<span class="hljs-number">2.2</span>));<br><br>vec3 N = <span class="hljs-built_in">normalize</span>(vNormal);<br>vec3 V = <span class="hljs-built_in">normalize</span>(uCameraPos - vWorldPos);<br>vec3 R = <span class="hljs-built_in">reflect</span>(-V, N);<br><br>vec3 F0 = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.04</span>); <br>F0 = <span class="hljs-built_in">mix</span>(F0, albedo, uMetallic);<br>vec3 Lo = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.0</span>);<br><span class="hljs-keyword">for</span> (uint i = <span class="hljs-number">0u</span>;i &lt; <span class="hljs-number">4u</span>;++i)&#123;<br>    vec3 L = <span class="hljs-built_in">normalize</span>(uLightPos[i] - vWorldPos);<br>    vec3 H = <span class="hljs-built_in">normalize</span>(V + L);<br>    <span class="hljs-comment">// float distance = length(uLightPos[i] - vWorldPos);</span><br>    <span class="hljs-comment">// float attenuation = 1.0 / (distance * distance); </span><br>    vec3 radiance = uLightColors[i] * <span class="hljs-number">1.0</span>;<br>    <span class="hljs-comment">//Cook-Torrance BRDF</span><br>    <span class="hljs-type">float</span> NDF = <span class="hljs-built_in">DistributionGGX</span>(N, H, uRoughness);   <br>    <span class="hljs-type">float</span> G   = <span class="hljs-built_in">GeometrySmith</span>(N, V, L, uRoughness); <br>    vec3 F    = <span class="hljs-built_in">fresnelSchlick</span>(F0, V, H);<br>    <span class="hljs-type">float</span> NdotL = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N,L),<span class="hljs-number">0.0</span>);<br>    <span class="hljs-type">float</span> NdotV = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N,V),<span class="hljs-number">0.0</span>);<br>    vec3 numerator    = NDF * G * F; <br>    <span class="hljs-type">float</span> denominator = <span class="hljs-built_in">max</span>((<span class="hljs-number">4.0</span> * NdotL * NdotV), <span class="hljs-number">0.0000001</span>);<br>    vec3 specular = numerator / denominator;<br>    <span class="hljs-comment">//Reference opengl pbr</span><br>    vec3 diffuse = (<span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>)-F) * (<span class="hljs-number">1.0</span> - uMetallic) * albedo / PI;<br>    <span class="hljs-comment">// Lo += ( diffuse + specular) * radiance * NdotL;</span><br>    Lo += (specular) * radiance * NdotL;<br>&#125;<br>...<br>vec3 color = ambient + Lo;<br><span class="hljs-comment">// HDR tonemapping</span><br>color = color / (color + <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>));<br><span class="hljs-comment">// gamma correct</span><br>color = <span class="hljs-built_in">pow</span>(color, <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>/<span class="hljs-number">2.2</span>)); <br>FragColor = <span class="hljs-built_in">vec4</span>(color, <span class="hljs-number">1.0</span>);<br></code></pre></td></tr></table></figure>
ä¸ºäº†å¯¹æ¯”<code>kulla Conty</code>æ–¹æ³•è¿™é‡Œå§<code>diffuse</code>é¡¹å»æ‰ã€‚
ä¸€åˆ‡é¡ºåˆ©çš„è¯ï¼Œä¼šå¾—åˆ°ä¸‹é¢çš„æ•ˆæœï¼š<br />
<img src="/img/00018/image-7.png" srcset="/img/loading.gif" lazyload alt="12" /></p>
<h1 id="kulla-conty-approximation">Kulla Conty Approximation</h1>
<h2 id="é¢„è®¡ç®—eÎ¼å’Œe_avg">é¢„è®¡ç®—E(Î¼)å’ŒE_avg</h2>
<p>åœ¨å¼•å…¥<code>Kulla Conty</code>æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹<code>Cook-Torrance</code>åå°„æ–¹ç¨‹çš„<code>G</code>é¡¹ï¼š<br />
<img src="/img/00018/image-8.png" srcset="/img/loading.gif" lazyload alt="13" /><br />
<code>G</code>é¡¹è€ƒè™‘äº†å¾®è¡¨é¢æ¨¡å‹çš„è‡ªé®æŒ¡ç°è±¡ï¼Œåœ¨å‚ç›´è§’åº¦çœ‹å¾®è¡¨é¢æ—¶ï¼Œå‡ ä¹æ²¡æœ‰è‡ªé®æŒ¡ç°è±¡ï¼Œè€Œåœ¨æ å°„è§’æ–¹å‘çœ‹å‘å¾®è¡¨é¢æ—¶ï¼Œè‡ªé®æŒ¡ç°è±¡å°±ä¼šå¾ˆä¸¥é‡ï¼Œè¿™æ˜¯ç¬¦åˆç‰©ç†ç°è±¡çš„ã€‚ä½†æ˜¯<code>G</code>é¡¹åªè€ƒè™‘äº†å…‰çº¿åœ¨å¾®è¡¨é¢ä¸Šä¸€æ¬¡åå°„åçš„ç»“æœï¼Œè¿™å°±å¯¼è‡´å¿…å®šä¼šæœ‰ä¸€éƒ¨åˆ†å‚ä¸åç»­å¼¹å°„çš„å…‰çº¿æœªè¢«è€ƒè™‘è¿›å»ï¼Œå½“ç²—ç³™åº¦è¶Šé«˜ï¼Œæ²Ÿå£‘è¶Šå¤§åç»­å¼¹å°„çš„å…‰çº¿å æ¯”è¶Šå¤§èƒ½é‡æŸå¤±å°±è¶Šå¤šã€‚è€Œ<code>kulla conty</code>æ–¹æ³•å°±æ˜¯ä¸ºäº†å¼¥è¡¥è¿™éƒ¨åˆ†æŸå¤±çš„èƒ½é‡ã€‚</p>
<p>è€ƒè™‘<code>Kulla Conty</code>æ–¹æ³•æ—¶ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“æœ‰å¤šå°‘èƒ½é‡ä¸¢å¤±äº†ï¼Œå¦‚æœåªè€ƒè™‘ä¸€æ¬¡åå°„ï¼Œé‚£ä¸¢å¤±çš„èƒ½é‡å°±æ˜¯<code>1 - ä¸€æ¬¡åå°„</code>ã€‚è€Œå¾®è¡¨é¢åå°„æ¨¡å‹æœ¬æ¥ä¹Ÿå°±æ˜¯åªè€ƒè™‘äº†ä¸€æ¬¡çš„åå°„ï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰å…¥å°„æ–¹å‘<code>Li</code>çš„<code>radiance</code>éƒ½ä¸º<code>1</code>ï¼Œåˆ™ä¸€æ¬¡åå°„åæˆ‘ä»¬èƒ½çœ‹åˆ°çš„èƒ½é‡ä¸ºï¼š
<span class="math display">\[
E(p,w_o)=\int_{\Omega+}\frac{DG}{4(w_o\cdot n)(w_i\cdot n)}n\cdot
w_idw_i \tag{25}
\]</span>
ç”±äºè¿™é‡Œè€ƒè™‘çš„å…¨åå°„ï¼Œ<code>F</code>è‡ªç„¶å°±<code>1</code>ï¼Œç„¶åæˆ‘ä»¬è®¾<code>Î¼i=cos(wi)</code>:<br />
<span class="math display">\[
E(\mu_o)=\int_{0}^{2\pi}\int_{0}^{1}f(\mu_o,\mu_i,\phi)\mu_id\mu_id\phi
\tag{26}
\]</span>
è¿™é‡Œ<code>Î¸</code>ç”±<code>Ï€/2</code>åˆ°<code>0</code>ã€‚é—«è€å¸ˆè¯¾ä¸Šè®²çš„æ˜¯ç”¨<code>sinÎ¸</code>å»æ›¿æ¢ï¼Œä½†æ˜¯åé¢è®¡ç®—<code>sinÎ¸</code>è¯´ä¸é€šï¼Œè€Œä¸è®º<code>sinÎ¸</code>æ›¿æ¢è¿˜æ˜¯<code>conÎ¸</code>ï¼Œå…¶æ¨å¯¼å‡ºçš„å…¬å¼éƒ½æ˜¯ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯<code>sinÎ¸</code>ï¼Œ<code>Î¸</code>ç”±<code>0</code>åˆ°<code>Ï€/2</code>ã€‚</p>
<p>å¾—åˆ°äº†<code>E(Î¼o)</code>åï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥è®¾è®¡å¦ä¸€ä¸ª<code>BRDF</code>ä½¿å¾—å…¶ç§¯åˆ†çš„ç»“æœä¸º<code>1-E(Î¼o)</code>ï¼Œç„¶åå°†ç»“æœåŠ åˆ°åŸæœ‰çš„<code>BRDF</code>ä¸Šé¢ï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰èƒ½é‡æŸå¤±äº†ã€‚<br />
è¿™ä¸ªæ–°è®¾è®¡çš„<code>BRDF</code>å°±æ˜¯ï¼š<br />
<span class="math display">\[
f_{ms}(\mu_o,\mu_i)=\frac{(1-E(\mu_o))(1-E(\mu_i))}{\pi(1-E_{avg})}
\tag{27}
\]</span>
å…¶ä¸­<code>E_avg</code>æ˜¯å‡½æ•°<code>E(Î¼)</code>åœ¨åŒºé—´<code>[0,1]</code>çš„å¹³å‡å€¼ï¼š<br />
<span class="math display">\[
E_{avg}=\frac{\int_{0}^{1}E(\mu)\mu d\mu}{\int_{0}^{1}\mu d\mu} \\
=2\int_{0}^{1}E(\mu)\mu d\mu \tag{28}
\]</span> å…¶æ­£ç¡®æ€§å‚è€ƒè¯¾å ‚ä¸Šç»™çš„è¿‡ç¨‹ï¼š <img src="/img/00018/image-9.png" srcset="/img/loading.gif" lazyload
alt="14" /><br />
è¯¥æ–°è®¾è®¡çš„<code>BRDF</code>ä¸­æœ‰ä¸¤ä¸ªç§¯åˆ†å€¼ï¼Œæˆ‘ä»¬åŒæ ·é‡‡ç”¨æ‰“è¡¨çš„å½¢å¼ï¼ŒæŠŠç§¯åˆ†å€¼å­˜åˆ°ä¸€å¼ çº¹ç†ä¸­ã€‚<code>E(Î¼)</code>çš„ç§¯åˆ†å€¼æˆ‘ä»¬åŒæ ·ä½¿ç”¨é‡è¦æ€§é‡‡æ ·æ¥ä¿è¯ç»“æœçš„æ­£ç¡®æ€§ï¼Œå…¶ä»£ç å®ç°å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Vec3f <span class="hljs-title">IntegrateBRDF</span><span class="hljs-params">(Vec3f V, <span class="hljs-type">float</span> roughness)</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> sample_count = <span class="hljs-number">1024</span>;<br>    <span class="hljs-type">float</span> A = <span class="hljs-number">0.0</span>;<br>    <span class="hljs-type">float</span> B = <span class="hljs-number">0.0</span>;<br>    Vec3f N = <span class="hljs-built_in">Vec3f</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; sample_count; i++) &#123;<br>        Vec2f Xi = <span class="hljs-built_in">Hammersley</span>(i, sample_count);<br>        Vec3f H = <span class="hljs-built_in">ImportanceSampleGGX</span>(Xi, N, roughness);<br>        Vec3f L = <span class="hljs-built_in">normalize</span>(H * <span class="hljs-number">2.0f</span> * <span class="hljs-built_in">dot</span>(V, H) - V);<br>        <span class="hljs-type">float</span> NoL = std::<span class="hljs-built_in">max</span>(L.z, <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-type">float</span> NoH = std::<span class="hljs-built_in">max</span>(H.z, <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-type">float</span> VoH = std::<span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(V, H), <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-type">float</span> NoV = std::<span class="hljs-built_in">max</span>(<span class="hljs-built_in">dot</span>(N, V), <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> To calculate (fr * ni) / p_o here - Bonus 1</span><br>        <span class="hljs-type">float</span> Fc = <span class="hljs-built_in">pow</span>(<span class="hljs-number">1.0f</span> - VoH, <span class="hljs-number">5.0f</span>);<br>        <span class="hljs-type">float</span> G = <span class="hljs-built_in">GeometrySmith</span>(roughness, NoV, NoL);<br>        <span class="hljs-type">float</span> G_Vis  = VoH * G / (NoV * NoH);<br><br>        <span class="hljs-comment">// //no split sum </span><br>        <span class="hljs-comment">// A += G_Vis;</span><br><br>        <span class="hljs-comment">// Split Sum - Bonus 2</span><br>        A += (<span class="hljs-number">1.0</span> - Fc) * G_Vis;<br>        B += Fc * G_Vis;<br>    &#125;<br>    <span class="hljs-comment">// return &#123; A / sample_count, A / sample_count, A / sample_count &#125;; // No split sum version</span><br>    <span class="hljs-keyword">return</span> &#123; A / sample_count, B / sample_count, <span class="hljs-number">0.0</span> &#125;;  <span class="hljs-comment">// Split sum</span><br>&#125;<br></code></pre></td></tr></table></figure>
å…¶å®è¿™é‡Œä¸¥è°¨æ¥è¯´ä¸å«<code>Split Sum</code>ï¼Œè¯¥æ–¹æ³•æ˜¯å¯¹å…‰ç…§çš„å‰¥ç¦»ï¼Œæˆ‘åœ¨ä¸Šé¢ç« èŠ‚æœ‰æåˆ°ã€‚ä½†æ˜¯ä½œä¸šè¦æ±‚æœ‰<code>Split Sum</code>çš„æé«˜éƒ¨åˆ†ï¼Œæˆ‘çŒœæµ‹åº”è¯¥æ˜¯æƒ³è®©æˆ‘ä»¬è¿™æ ·å®ç°å§ã€‚ä½†æ˜¯ä»”ç»†è€ƒè™‘çš„è¯å…¶å®ä¹Ÿæ²¡å¿…è¦è¿™ä¹ˆå®ç°ï¼Œå› ä¸ºè®¡ç®—ä¸€æ¬¡åå°„çš„èƒ½é‡ï¼Œå…¶<code>Fresenl</code>é¡¹ä¸º<code>1</code>å³å…¨åå°„ï¼Œè¿™é‡Œä¹Ÿä¸éœ€è¦å°†<code>F0</code>å‰¥ç¦»æ¥ä½¿å‚æ•°é™ç»´ã€‚å°±è¿™æ ·å§ï¼Œè¿™æ ·å¾—åˆ°çš„çº¹ç†å¦‚ä¸‹ï¼š<br />
Split Sum<br />
<img src="/img/00018/image-10.png" srcset="/img/loading.gif" lazyload alt="15" /><br />
Not Split Sum<br />
<img src="/img/00018/image-11.png" srcset="/img/loading.gif" lazyload alt="16" /></p>
<p><code>E_avg</code>çš„é¢„è®¡ç®—å°±æ¯”è¾ƒç®€å•äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">Vec3f <span class="hljs-title">IntegrateEmu</span><span class="hljs-params">(Vec3f V, <span class="hljs-type">float</span> roughness, <span class="hljs-type">float</span> NdotV, Vec3f Ei)</span> </span>&#123;<br>    Vec3f Eavg = <span class="hljs-built_in">Vec3f</span>(<span class="hljs-number">0.0f</span>);<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> sample_count = <span class="hljs-number">1024</span>;<br>    Vec3f N = <span class="hljs-built_in">Vec3f</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; sample_count; i++) &#123;<br>        Vec2f Xi = <span class="hljs-built_in">Hammersley</span>(i, sample_count);<br>        Vec3f H = <span class="hljs-built_in">ImportanceSampleGGX</span>(Xi, N, roughness);<br>        Vec3f L = <span class="hljs-built_in">normalize</span>(H * <span class="hljs-number">2.0f</span> * <span class="hljs-built_in">dot</span>(V, H) - V);<br>        <span class="hljs-type">float</span> NoL = std::<span class="hljs-built_in">max</span>(L.z, <span class="hljs-number">0.0f</span>);<br>        <span class="hljs-comment">// float pdf = 1;//è·Ÿroughnessæ²¡å…³ç³»</span><br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> To calculate Eavg here</span><br>        Eavg +=  Ei * <span class="hljs-number">2.0f</span> * NoL ;<span class="hljs-comment">//Ei * 2.0f * NoL, NoL : cos thetai</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> Eavg / sample_count;<br>&#125;<br></code></pre></td></tr></table></figure> å¾—åˆ°çº¹ç†å¦‚ä¸‹ï¼š<br />
Split Sum<br />
<img src="/img/00018/image-12.png" srcset="/img/loading.gif" lazyload alt="17" /><br />
Not Split Sum<br />
<img src="/img/00018/image-13.png" srcset="/img/loading.gif" lazyload alt="18" /></p>
<h2 id="å®Œæˆkulla-conty-approximation">å®ŒæˆKulla Conty
Approximation</h2>
<p>æˆ‘ä»¬æ‹¿åˆ°å·²ç»é¢„è®¡ç®—å¥½çš„<code>E(Î¼)</code>å’Œ<code>E_avg</code>ï¼Œç°åœ¨å°±å¯ä»¥å°†æ–°è®¾è®¡çš„<code>BRDF</code>ç§¯åˆ†å€¼ç®—å‡ºæ¥äº†ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//split sum</span><br><span class="hljs-function">vec3 <span class="hljs-title">MultiScatterBRDF</span><span class="hljs-params">(<span class="hljs-type">float</span> NdotL, <span class="hljs-type">float</span> NdotV, vec3 F)</span></span><br><span class="hljs-function"></span>&#123;<br>  vec3 albedo = <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">texture</span>(uAlbedoMap, vTexCoords).rgb,<span class="hljs-built_in">vec3</span>(<span class="hljs-number">2.2</span>));<br><br>  <span class="hljs-comment">// A split-sum result in which R-channel repesent F interger term</span><br>  vec3 E_o = <span class="hljs-built_in">texture</span>(uKullaContyBrdflut, <span class="hljs-built_in">vec2</span>(NdotL, uRoughness)).xyz;<br>  vec3 E_i = <span class="hljs-built_in">texture</span>(uKullaContyBrdflut, <span class="hljs-built_in">vec2</span>(NdotV, uRoughness)).xyz;<br>  <span class="hljs-comment">// Split sum result add here.</span><br>  vec3 Emu_o = F * E_o.x + <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>) * E_o.y;<br>  vec3 Emu_i = F * E_i.x + <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>) * E_i.y;<br>  vec3 E_avg = <span class="hljs-built_in">texture</span>(uKullaContyEavglut, <span class="hljs-built_in">vec2</span>(<span class="hljs-number">0</span>, uRoughness)).xyz;<br>  vec3 E_avgss = F * E_avg.x + <span class="hljs-built_in">vec3</span>(<span class="hljs-number">1.0</span>) * E_avg.y;<br>  ... <br>  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> To calculate fms and missing energy here</span><br>  vec3 F_ms = (<span class="hljs-number">1.0</span> - Emu_o) * (<span class="hljs-number">1.0</span> - Emu_i) / (PI * (<span class="hljs-number">1.0</span> - E_avgss));<br>  ...<br>  <span class="hljs-keyword">return</span> F_ms;<br>&#125;<br></code></pre></td></tr></table></figure>
ç›®å‰æ¥è¯´ï¼Œè¿˜åªèƒ½è¡¥å¿<code>albedo</code>ä¸º<code>1</code>æƒ…å†µä¸‹çš„èƒ½é‡ã€‚å¦‚æœç‰©ä½“æœ¬èº«è‡ªå¸¦é¢œè‰²ï¼Œé‚£è¿˜è¦è€ƒè™‘å› ä¸ºç‰©ä½“æœ¬èº«å¸æ”¶èƒ½é‡è€Œå¼•èµ·çš„èƒ½é‡æŸå¤±ã€‚é¦–å…ˆè¦å®šä¸€ä¸ªå¹³å‡<code>Fresenl</code>é¡¹ï¼Œæ¥è¡¨ç¤ºä¸åŒå…¥å°„æ–¹å‘ä¸‹æ‰“åˆ°å¾®è¡¨é¢ï¼Œå¹³å‡è¢«åå°„å‡ºå»çš„èƒ½é‡å æ¯”å¤šå°‘ã€‚å…¬å¼å¦‚ä¸‹ï¼š<br />
<span class="math display">\[
F_{avg}=\frac{\int_{0}^{1}F(\mu)\mu d\mu}{\int_{0}^{1}\mu d\mu} \\
=2\int_{0}^{1}F(\mu)\mu d\mu \tag{29}
\]</span> è¿™ç¯‡<a
target="_blank" rel="noopener" href="https://blog.selfshadow.com/publications/s2017-shading-course/imageworks/s2017_pbs_imageworks_slides_v2.pdf">è®ºæ–‡</a>ä¸­ï¼Œç»™å‡ºäº†è¯¥å…¬å¼ç¡¬ç¼–ç ä¸‹çš„ä»£ç ï¼š<br />
<img src="/img/00018/image-14.png" srcset="/img/loading.gif" lazyload alt="19" /><br />
å…¶ä¸­<code>r</code>æ˜¯<code>albedo</code>ï¼Œå…¥å°„è§’ä¸º0åº¦æ—¶ç»™çš„å€¼ã€‚<code>g</code>æ˜¯<code>EdgeTint</code>è¾¹ç¼˜è‰²è°ƒï¼Œå…¥å°„è§’ä¸º80åº¦ç»™çš„å€¼ã€‚è¿™ç¯‡<a
target="_blank" rel="noopener" href="https://groups.google.com/g/alshaders/c/IZTbaqJMQBo">æ–‡ç« </a>æ•™äº†æˆ‘ä»¬æ€ä¹ˆç”Ÿæˆè¿™ä¸¤ä¸ªå€¼ï¼Œæˆ‘ç”Ÿæˆäº†é‡‘æè´¨çš„<code>R</code>å’Œ<code>G</code>ã€‚<code>R(0.94423,0.77611,0.37217)</code>ï¼Œ<code>G(0.94806,0.86104,0.60760)</code>ã€‚</p>
<p>æœ‰äº†<code>å¹³å‡Fresenl</code>é¡¹ï¼Œæˆ‘ä»¬ç°åœ¨ä»æ–°è®¤è¯†ä¸€ä¸‹<code>E_avg</code>ï¼šå«ä¹‰ä¸ºä¸è€ƒè™‘è²æ¶…å°”é¡¹æ—¶ï¼Œä¸åŒå…¥å°„è§’åº¦æ‰“åˆ°å¾®è¡¨é¢æ—¶ï¼Œç¦»å¼€è¡¨é¢åå¹³å‡èƒ½è¢«ä½ çœ‹åˆ°çš„èƒ½é‡ã€‚</p>
<p>é‚£è€ƒè™‘ä¸Šç‰©ä½“æœ¬èº«ä¼šå¸æ”¶çš„é¢œè‰²ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°ä¸€æ¬¡åå°„åçš„å¹³å‡èƒ½é‡ä¸º<span
class="math inline">\(F_{avg}E_{avg}\)</span>ï¼Œåˆ™å‘ç”Ÿä¸€æ¬¡åå°„åæ²¡æœ‰å‡ºå»çš„å¹³å‡èƒ½é‡ä¸º<span
class="math inline">\(F_{avg}(1-E_{avg})\)</span>ï¼Œç„¶åè¿™éƒ¨åˆ†èƒ½é‡å†æ¬¡å‘ç”Ÿåå°„åæˆ‘ä»¬èƒ½çœ‹åˆ°çš„å¹³å‡èƒ½é‡ä¸º<span
class="math inline">\(F_{avg}(1-E_{avg})F_{avg}E_{avg}\)</span>ï¼Œæ€»ç»“å‡º<code>K</code>æ¬¡åå°„åæˆ‘ä»¬èƒ½çœ‹åˆ°çš„å¹³å‡èƒ½é‡ä¸º<span
class="math inline">\(F_{avg}^{k}(1-E_{avg})^{k}F_{avg}E_{avg}\)</span>ï¼Œæœ€åå°†è¿™éƒ¨åˆ†èƒ½é‡å…¨éƒ¨åŠ èµ·æ¥ï¼Œå°±æ˜¯ä¸€ä¸ªçº§æ•°ï¼Œå…¶æ•°å­¦å…¬å¼ä¸ºï¼š<br />
<span class="math display">\[
((F_{avg}(1-E_{avg}))^{0}+(F_{avg}^{}(1-E_{avg}))^{1}+(F_{avg}(1-E_{avg}))^{k})*F_{avg}E_{avg}
\tag{30}
\]</span>
å‰é¢éƒ¨åˆ†æ˜¯ä¸€ä¸ªç­‰æ¯”æ•°åˆ—ï¼Œç”±äº<code>F_avg</code>å’Œ<code>1-E_avg</code>éƒ½æ˜¯å°äº<code>1</code>çš„æ•°ï¼Œæ‰€ä»¥ç»“æœä¸ºï¼š<br />
<span class="math display">\[
=\frac{F_{avg}E_{avg}}{1-F_{avg}(1-E_{avg})} \tag{31}
\]</span>
è¯¾å ‚ä¸Šçš„è®²è§£å›¾ç‰‡å¦‚ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„<code>one bounce</code>æŒ‡çš„æ˜¯ä¸¤æ¬¡åå°„ï¼š<br />
<img src="/img/00018/image-16.png" srcset="/img/loading.gif" lazyload alt="20" /><br />
è¿™ä¸ªå…¬å¼å°±æ˜¯é¢œè‰²é¡¹ï¼Œæˆ‘ä»¬ç›´æ¥ä¹˜ä¸Šä¹‹å‰æ²¡æœ‰è€ƒè™‘é¢œè‰²æ—¶çš„èƒ½é‡è¡¥å¿é¡¹ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br />
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">vec3 <span class="hljs-title">MultiScatterBRDF</span><span class="hljs-params">(<span class="hljs-type">float</span> NdotL, <span class="hljs-type">float</span> NdotV)</span></span><br><span class="hljs-function"></span>&#123;<br>  vec3 albedo = <span class="hljs-built_in">pow</span>(<span class="hljs-built_in">texture</span>(uAlbedoMap, vTexCoords).rgb,<span class="hljs-built_in">vec3</span>(<span class="hljs-number">2.2</span>));<br>  vec3 E_o = <span class="hljs-built_in">texture</span>(uKullaContyBrdflut, <span class="hljs-built_in">vec2</span>(NdotL, uRoughness)).xyz;<br>  vec3 E_i = <span class="hljs-built_in">texture</span>(uKullaContyBrdflut, <span class="hljs-built_in">vec2</span>(NdotV, uRoughness)).xyz;<br>  vec3 E_avg = <span class="hljs-built_in">texture</span>(uKullaContyEavglut, <span class="hljs-built_in">vec2</span>(<span class="hljs-number">0</span>, uRoughness)).xyz;<br>  <span class="hljs-comment">//gold</span><br>  vec3 edgetint = <span class="hljs-built_in">vec3</span>(<span class="hljs-number">0.94806</span>,<span class="hljs-number">0.86104</span>,<span class="hljs-number">0.60760</span>);<br>  vec3 F_avg = <span class="hljs-built_in">AverageFresnel</span>(albedo, edgetint);<br>  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> To calculate fms and missing energy here</span><br>  vec3 F_ms = (<span class="hljs-number">1.0</span> - E_o) * (<span class="hljs-number">1.0</span> - E_i) / (PI * (<span class="hljs-number">1.0</span> - E_avg));<br>  vec3 F_add = F_avg * E_avg / (<span class="hljs-number">1.0</span> - F_avg * (<span class="hljs-number">1.0</span> - E_avg));<br>  <span class="hljs-keyword">return</span> F_add * F_ms;<br>&#125;<br></code></pre></td></tr></table></figure> æ•ˆæœå¦‚ä¸‹ï¼š<br />
<img src="/img/00018/image-15.png" srcset="/img/loading.gif" lazyload alt="21" /></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Games202/" class="category-chain-item">Games202</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Games202 Hw4 IBL and Kulla Conty</div>
      <div>https://howl144.github.io/2023/07/01/00018. Games202 Hw4/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Deng Ye</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>July 1, 2023</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/21/00019.%20Games202%20Hw5/" title="Games202 Hw5 JBF and SVGF">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Games202 Hw5 JBF and SVGF</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/19/00006.%20c++%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B%E4%B9%8B%E8%99%9A%E8%A1%A8%EF%BC%8C%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88%E7%AD%89/" title="c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†">
                        <span class="hidden-mobile">c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        Views: 
        <span id="leancloud-site-pv"></span>
        
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        Visitors: 
        <span id="leancloud-site-uv"></span>
        
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
