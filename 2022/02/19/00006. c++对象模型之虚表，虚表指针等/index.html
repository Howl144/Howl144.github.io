

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="elv6HP48K6bVVMeBdbFYkmoi4IBF6JVtH0WaCgUXRNY" />
  <link rel="apple-touch-icon" sizes="76x76" href="/img/rose.png">
  <link rel="icon" href="/img/rose.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Deng Ye">
  <meta name="keywords" content="">
  
    <meta name="description" content="å‰è¨€ æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚ä¸Šä¸¤ç¯‡æ–‡ç« å°†c++çš„æ ¸å¿ƒéƒ¨ä»¶ï¼ˆValue categoriesï¼‰è®²æ¸…æ¥šäº†ï¼Œè¿™ç¯‡æ–‡ç« å°†ä¼šå¸¦å¤§å®¶åˆ†æc++å¯¹è±¡æ¨¡å‹çš„åº•å±‚åŸç†ã€‚ç¬”è€…è¿™é‡Œç”¨çš„ç¼–è¯‘å™¨æ˜¯clang version 10.0.0-4ubuntu1ï¼Œä¸åŒç¼–è¯‘å™¨å¯¹æ•°æ®å¸ƒå±€çš„å¤„ç†å¯èƒ½ä¼šä¸åŒï¼ˆã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹ä¸­å·²é˜è¿°åŸå› ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ï¼‰ã€‚å‹æƒ…æç¤ºï¼šæœ¬æ–‡ç« æ¶‰åŠATTå¼å’Œintelå¼">
<meta property="og:type" content="article">
<meta property="og:title" content="c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†">
<meta property="og:url" content="https://howl144.github.io/2022/02/19/00006.%20c++%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B%E4%B9%8B%E8%99%9A%E8%A1%A8%EF%BC%8C%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88%E7%AD%89/index.html">
<meta property="og:site_name" content="ğŸ¥°Howl&#39;s Blog">
<meta property="og:description" content="å‰è¨€ æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚ä¸Šä¸¤ç¯‡æ–‡ç« å°†c++çš„æ ¸å¿ƒéƒ¨ä»¶ï¼ˆValue categoriesï¼‰è®²æ¸…æ¥šäº†ï¼Œè¿™ç¯‡æ–‡ç« å°†ä¼šå¸¦å¤§å®¶åˆ†æc++å¯¹è±¡æ¨¡å‹çš„åº•å±‚åŸç†ã€‚ç¬”è€…è¿™é‡Œç”¨çš„ç¼–è¯‘å™¨æ˜¯clang version 10.0.0-4ubuntu1ï¼Œä¸åŒç¼–è¯‘å™¨å¯¹æ•°æ®å¸ƒå±€çš„å¤„ç†å¯èƒ½ä¼šä¸åŒï¼ˆã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹ä¸­å·²é˜è¿°åŸå› ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ï¼‰ã€‚å‹æƒ…æç¤ºï¼šæœ¬æ–‡ç« æ¶‰åŠATTå¼å’Œintelå¼">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://howl144.github.io/img%5C00006%5Cindex.png">
<meta property="article:published_time" content="2022-02-19T02:12:32.000Z">
<meta property="article:modified_time" content="2023-08-06T09:43:49.556Z">
<meta property="article:author" content="Deng Ye">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://howl144.github.io/img%5C00006%5Cindex.png">
  
  
  
  <title>c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç† - ğŸ¥°Howl&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"howl144.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"MY3hK2j6KKqPNCHItX2Yargj-gzGzoHsz","app_key":"U0dZRBpPFA46kRmFcsltQFF2","server_url":"https://my3hk2j6.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Howl&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/portfolio/">
                <i class="iconfont icon-pen"></i>
                <span>Portfolio</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Category</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archive</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About Me</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/post.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.5)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-02-19 10:12" pubdate>
          February 19, 2022 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          28k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          233 mins
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> views
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><blockquote>
<p><strong>æœ¬ç¯‡æ–‡ç« ä¸ºç¬”è€…çš„è¯»ä¹¦ç¬”è®°ï¼Œæœªç»å…è®¸è¯·å‹¿è½¬è½½ã€‚</strong><br>ä¸Šä¸¤ç¯‡æ–‡ç« å°†c++çš„æ ¸å¿ƒéƒ¨ä»¶ï¼ˆ<a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/value_category">Value categories</a>ï¼‰è®²æ¸…æ¥šäº†ï¼Œè¿™ç¯‡æ–‡ç« å°†ä¼šå¸¦å¤§å®¶åˆ†æc++å¯¹è±¡æ¨¡å‹çš„åº•å±‚åŸç†ã€‚ç¬”è€…è¿™é‡Œç”¨çš„ç¼–è¯‘å™¨æ˜¯<code>clang version 10.0.0-4ubuntu1</code>ï¼Œä¸åŒç¼–è¯‘å™¨å¯¹æ•°æ®å¸ƒå±€çš„å¤„ç†å¯èƒ½ä¼šä¸åŒï¼ˆã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹ä¸­å·²é˜è¿°åŸå› ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ï¼‰ã€‚<br>å‹æƒ…æç¤ºï¼šæœ¬æ–‡ç« æ¶‰åŠ<code>ATTå¼</code>å’Œ<code>intelå¼</code>æ±‡ç¼–ä»£ç çš„ç›¸å…³çŸ¥è¯†ã€‚</p>
</blockquote>
<hr>
<h1 id="è™šè¡¨å’Œè™šè¡¨æŒ‡é’ˆï¼ˆvtbl-vptrï¼‰"><a href="#è™šè¡¨å’Œè™šè¡¨æŒ‡é’ˆï¼ˆvtbl-vptrï¼‰" class="headerlink" title="è™šè¡¨å’Œè™šè¡¨æŒ‡é’ˆï¼ˆvtbl &amp; vptrï¼‰"></a>è™šè¡¨å’Œè™šè¡¨æŒ‡é’ˆï¼ˆvtbl &amp; vptrï¼‰</h1><blockquote>
<ul>
<li>æ¯ä¸ªclassäº§ç”Ÿå‡ºä¸€å †æŒ‡å‘virtual functionçš„æŒ‡é’ˆï¼Œæ”¾åœ¨è¡¨æ ¼ä¹‹ä¸­ï¼Œè¿™ä¸ªè¡¨æ ¼è¢«ç§°ä¸ºvirtual tableï¼ˆvtblï¼‰ã€‚</li>
<li>æ¯ä¸€ä¸ªclass objectè¢«å®‰æ’ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ç›¸å…³çš„virtual tableã€‚é€šå¸¸è¿™ä¸ªæŒ‡é’ˆè¢«ç§°ä¸ºvptrã€‚vptrçš„è®¾å®šï¼ˆsettingï¼‰å’Œé‡ç½®ï¼ˆresettingï¼‰éƒ½ç”±æ¯ä¸€ä¸ªclassçš„constructorã€destructorå’Œcopy assignmentè¿ç®—ç¬¦è‡ªåŠ¨å®Œæˆã€‚æ¯ä¸€ä¸ªclassæ‰€å…³è”çš„type_info objectï¼ˆç”¨ä»¥æ”¯æŒruntime type identificationï¼ŒRTTIï¼‰ä¹Ÿç»ç”±virtual tableè¢«æŒ‡å‡ºæ¥ï¼Œé€šå¸¸æ”¾åœ¨è¡¨æ ¼çš„ç¬¬ä¸€ä¸ªslotï¼ˆclang++ä¸æ˜¯æ”¾åœ¨ç¬¬ä¸€ä¸ªslotï¼Œæ–‡ç« åé¢ä¼šè®²åˆ°ï¼‰ã€‚</li>
</ul>
</blockquote>
<hr>
<blockquote>
<p>æ¥ä¸‹æ¥ç¬”è€…å†™ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹æ¥å¸®å¤§å®¶åˆ†æclang++ç¼–è¯‘å™¨ä¸‹çš„vtbl &amp; vptrã€‚</p>
<h2 id="é¦–å…ˆå’±ä»¬æ¥çœ‹ä¸‹vptræ”¾åœ¨å¯¹è±¡çš„ä»€ä¹ˆä½ç½®ï¼š"><a href="#é¦–å…ˆå’±ä»¬æ¥çœ‹ä¸‹vptræ”¾åœ¨å¯¹è±¡çš„ä»€ä¹ˆä½ç½®ï¼š" class="headerlink" title="é¦–å…ˆå’±ä»¬æ¥çœ‹ä¸‹vptræ”¾åœ¨å¯¹è±¡çš„ä»€ä¹ˆä½ç½®ï¼š"></a>é¦–å…ˆå’±ä»¬æ¥çœ‹ä¸‹vptræ”¾åœ¨å¯¹è±¡çš„ä»€ä¹ˆä½ç½®ï¼š</h2></blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> <br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">testfunc</span><span class="hljs-params">()</span></span>&#123;&#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//è™šå‡½æ•°è¡¨æŒ‡é’ˆä½ç½®åˆ†æ</span><br>    <span class="hljs-comment">//ç±»ï¼šæœ‰è™šå‡½æ•°ï¼Œè¿™ä¸ªç±»ä¼šäº§ç”Ÿä¸€ä¸ªè™šå‡½æ•°è¡¨ã€‚</span><br>    <span class="hljs-comment">//ç±»å¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆï¼ˆvptrï¼‰ä¼šæŒ‡å‘è¿™ä¸ªè™šå‡½æ•°è¡¨çš„å¼€å§‹åœ°å€ã€‚</span><br>    A obj;<br>    <span class="hljs-type">int</span> objLen = <span class="hljs-built_in">sizeof</span>(obj);<br>    std::cout&lt;&lt; objLen &lt;&lt; std::endl; <span class="hljs-comment">//x86-64 16å­—èŠ‚</span><br><br>    <span class="hljs-comment">/*p1è·å–å¯¹è±¡é¦–åœ°å€ï¼Œp2è·å–å¯¹è±¡æ•°æ®æˆå‘˜içš„åœ°å€ï¼Œä¸¤è€…éƒ½ä»¥ä½å±‚æ¬¡char *å»è§£é‡Šï¼Œä»¥ä¾¿ç”¨æ—è§‚è€…è§’åº¦å»æ¯”è¾ƒ*/</span><br>    <span class="hljs-type">char</span> *p1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(&amp;obj);<span class="hljs-comment">//reinterpret_casté€šå¸¸ä¸ºè¿ç®—å¯¹è±¡çš„ä½æ¨¡å¼æä¾›è¾ƒä½å±‚æ¬¡ä¸Šçš„é‡æ–°è§£é‡Šã€‚</span><br>    <span class="hljs-type">char</span> *p2 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">char</span> *&gt;(&amp;(obj.i));<br>    <span class="hljs-keyword">if</span>(p1 == p2)<span class="hljs-comment">//è¯´æ˜obj.iå’Œobjçš„ä½ç½®ç›¸åŒï¼Œè¯´æ˜iåœ¨å¯¹è±¡objå†…å­˜å¸ƒå±€çš„ä¸Šè¾¹ã€‚è™šå‡½æ•°è¡¨æŒ‡é’ˆvptråœ¨ä¸‹è¾¹</span><br>    &#123;<br>        std::cout&lt;&lt; <span class="hljs-string">&quot;è™šå‡½æ•°è¡¨æŒ‡é’ˆä½äºå¯¹è±¡å†…å­˜çš„ æœ«å°¾ &quot;</span> &lt;&lt;std::endl;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        std::cout&lt;&lt; <span class="hljs-string">&quot;è™šå‡½æ•°è¡¨æŒ‡é’ˆä½äºå¯¹è±¡å†…å­˜çš„ å¼€å¤´ &quot;</span> &lt;&lt;std::endl;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br><img src="/img%5C00006%5C1.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>å¯ä»¥çœ‹åˆ° <code>obj </code>å¯¹è±¡çš„å¤§å°æ˜¯16å­—èŠ‚ï¼Œ<code>vptr</code>ä½äºå¯¹è±¡çš„å¼€å¤´ã€‚</p>
</blockquote>
<hr>
<blockquote>
<h2 id="æ¥ä¸‹é‡Œå’±ä»¬ä¸èµ°virtualæœºåˆ¶ï¼Œç›´æ¥ä»è™šè¡¨ä¸­è·å–è™šå‡½æ•°å¹¶ä¸”è¿è¡Œå¯¹åº”è™šå‡½æ•°ã€‚"><a href="#æ¥ä¸‹é‡Œå’±ä»¬ä¸èµ°virtualæœºåˆ¶ï¼Œç›´æ¥ä»è™šè¡¨ä¸­è·å–è™šå‡½æ•°å¹¶ä¸”è¿è¡Œå¯¹åº”è™šå‡½æ•°ã€‚" class="headerlink" title="æ¥ä¸‹é‡Œå’±ä»¬ä¸èµ°virtualæœºåˆ¶ï¼Œç›´æ¥ä»è™šè¡¨ä¸­è·å–è™šå‡½æ•°å¹¶ä¸”è¿è¡Œå¯¹åº”è™šå‡½æ•°ã€‚"></a>æ¥ä¸‹é‡Œå’±ä»¬ä¸èµ°virtualæœºåˆ¶ï¼Œç›´æ¥ä»è™šè¡¨ä¸­è·å–è™šå‡½æ•°å¹¶ä¸”è¿è¡Œå¯¹åº”è™šå‡½æ•°ã€‚</h2></blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;Base::f()&quot;</span> &lt;&lt; std::endl; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;Base::g()&quot;</span> &lt;&lt; std::endl; &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;Base::h()&quot;</span> &lt;&lt; std::endl; &#125;<br>&#125;;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derive</span> : <span class="hljs-keyword">public</span> Base<br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span> </span>&#123; std::cout &lt;&lt; <span class="hljs-string">&quot;Derive::g()&quot;</span> &lt;&lt; std::endl; &#125;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    Derive* pd = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derive</span>();<span class="hljs-comment">//æ´¾ç”Ÿç±»æŒ‡é’ˆã€‚</span><br>    <span class="hljs-type">long</span>* pd_cast = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(pd);<span class="hljs-comment">//è·å–è¾ƒä½å±‚æ¬¡ä¸Šçš„é‡æ–°è§£é‡Šã€‚</span><br>    <span class="hljs-type">long</span>* vptr_pd = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*pd_cast);<br>    <span class="hljs-comment">/*è§£å¼•ç”¨æ´¾ç”Ÿç±»æŒ‡é’ˆå¾—åˆ°è™šè¡¨æŒ‡é’ˆï¼Œè€Œä¸æ˜¯å¾—åˆ°æ´¾ç”Ÿç±»ï¼Œå› ä¸ºåšäº†ä½æ¨¡å¼çš„ä½å±‚æ¬¡è½¬æ¢ã€‚</span><br><span class="hljs-comment">    å¾—åˆ°è™šè¡¨æŒ‡é’ˆåï¼Œå°†è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚</span><br><span class="hljs-comment">    ä½¿ç”¨longè¿‡æ¸¡ï¼Œæ˜¯å› ä¸ºlongåœ¨32ä½ç¼–è¯‘å™¨å’Œ64ä½ç¼–è¯‘å™¨æ‰€å ç”¨çš„ç©ºé—´å¤§å°å’ŒæŒ‡é’ˆæ˜¯ä¸€æ ·çš„*/</span><br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vptr_pd[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,vptr_pd[i]);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*Func)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹</span><br>    Func f_pd = (Func)vptr_pd[<span class="hljs-number">0</span>];<br>    Func g_pd = (Func)vptr_pd[<span class="hljs-number">1</span>];<br>    Func h_pd = (Func)vptr_pd[<span class="hljs-number">2</span>];<br><br>    <span class="hljs-built_in">f_pd</span>();<br>    <span class="hljs-built_in">g_pd</span>();<br>    <span class="hljs-built_in">h_pd</span>();<br><br>    Base* pb = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Base</span>();<span class="hljs-comment">//æ´¾ç”Ÿç±»æŒ‡é’ˆã€‚</span><br>    <span class="hljs-type">long</span>* pb_cast = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(pb);<br>    <span class="hljs-type">long</span>* vptr_pb = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*pb_cast);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vptr_pb[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,vptr_pb[i]);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*Func)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹</span><br>    Func f_pb = (Func)vptr_pb[<span class="hljs-number">0</span>];<br>    Func g_pb = (Func)vptr_pb[<span class="hljs-number">1</span>];<br>    Func h_pb = (Func)vptr_pb[<span class="hljs-number">2</span>];<br><br>    <span class="hljs-built_in">f_pb</span>();<br>    <span class="hljs-built_in">g_pb</span>();<br>    <span class="hljs-built_in">h_pb</span>();<br><br>    <span class="hljs-keyword">delete</span> pd;<br>    <span class="hljs-keyword">delete</span> pb;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>è¿è¡Œç»“æœä¸ºï¼š<br><img src="/img%5C00006%5C2.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>æˆ–è€…ç”¨GDBå‘½ä»¤æ‰“å°å‡ºvtblçš„æ ·å­ï¼š<br><code>gefâ¤  info vtbl pd</code><br><img src="/img%5C00006%5C3.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>å’Œä¸Šé¢ä»£ç è¿è¡Œçš„ç»“æœä¸€è‡´ï¼å€¼å¾—å…³æ³¨çš„ä¸€ç‚¹æ˜¯ï¼Œ<code>vtbl</code>æ˜¯å­˜åœ¨äºåªè¯»æ•°æ®æ®µï¼Œè€Œ<code>vptr</code>åœ¨å †ä¸­ï¼ˆ<code>vptr</code>ä¹Ÿå¯ä»¥åœ¨æ ˆä¸­ï¼‰ã€‚<br>ä¸‹é¢ç”¨ä¸€å¼ å›¾æ¥æè¿°ä¸Šè¿°ä»£ç çš„è¡Œä¸ºï¼š<br><img src="/img%5C00006%5C4.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"></p>
</blockquote>
<hr>
<blockquote>
<h2 id="vptr-vtblçš„åˆ›å»ºæ—¶æœºä»¥åŠvptråˆå§‹åŒ–é—®é¢˜"><a href="#vptr-vtblçš„åˆ›å»ºæ—¶æœºä»¥åŠvptråˆå§‹åŒ–é—®é¢˜" class="headerlink" title="vptr &amp; vtblçš„åˆ›å»ºæ—¶æœºä»¥åŠvptråˆå§‹åŒ–é—®é¢˜"></a>vptr &amp; vtblçš„åˆ›å»ºæ—¶æœºä»¥åŠvptråˆå§‹åŒ–é—®é¢˜</h2><p>å¼•ç”¨ã€Šæ·±åº¦æ¢ç´¢C++å¯¹è±¡æ¨¡å‹ã€‹p45ä¸­çš„ä¸€æ®µè¯ï¼š<br>ä¸‹é¢ä¸¤ä¸ªæ‰©å¼ è¡ŒåŠ¨ä¼šåœ¨ç¼–è¯‘æœŸé—´å‘ç”Ÿï¼š</p>
<ul>
<li>ä¸€ä¸ªvirtual function tableä¼šè¢«ç¼–è¯‘å™¨äº§ç”Ÿå‡ºæ¥ï¼Œå†…æ”¾classçš„virtual functionsåœ°å€</li>
<li>åœ¨æ¯ä¸€ä¸ªclass objectä¸­ï¼Œä¸€ä¸ªé¢å¤–çš„pointer memberä¼šè¢«ç¼–è¯‘å™¨åˆæˆå‡ºæ¥ï¼Œå†…å«ç›¸å…³çš„class vtblçš„åœ°å€</li>
</ul>
<p>åœ¨c++ä¸­ï¼Œvirtual functionså¯ä»¥åœ¨ç¼–è¯‘æ—¶æœŸè·çŸ¥ã€‚æ­¤å¤–ï¼Œè¿™ä¸€ç»„åœ°å€æ˜¯å›ºå®šä¸å˜çš„ï¼Œæ‰§è¡ŒæœŸä¸å¯èƒ½æ–°å¢æˆ–æ›¿æ¢å®ƒã€‚ç”±äºç¨‹åºæ‰§è¡Œæ—¶ï¼Œè¡¨æ ¼çš„å¤§å°å’Œå†…å®¹éƒ½ä¸ä¼šæ”¹å˜ï¼Œæ‰€ä»¥å…¶æ„å»ºå’Œå­˜å–çš†å¯ä»¥ç”±ç¼–è¯‘å™¨å®Œå…¨æŒæ¡ï¼Œä¸éœ€è¦æ‰§è¡ŒæœŸçš„ä»»ä½•ä»‹å…¥ã€‚<br>å€¼å¾—æ³¨æ„çš„æ˜¯<code>vptrçš„åˆå§‹åŒ–</code>é—®é¢˜ï¼š<br>è¿™é‡Œç¬”è€…å°±ä¸å¸¦å¤§å®¶ç”»å †æ ˆå›¾ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼<br>ç›¸å…³ATTå¼åæ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs apache">    <span class="hljs-attribute">Derive</span>* pd = new Derive();//æ´¾ç”Ÿç±»æŒ‡é’ˆã€‚<br>  <span class="hljs-attribute">401222</span>:	bf <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	mov    $<span class="hljs-number">0</span>x8,%edi<br>  <span class="hljs-attribute">401227</span>:	e8 <span class="hljs-number">64</span> fe ff ff       	callq  <span class="hljs-number">401090</span> &lt;operator new(unsigned long)@plt&gt;<br>  <span class="hljs-attribute">40122c</span>:	<span class="hljs-number">31</span> f6                	xor    %esi,%esi<br>  <span class="hljs-attribute">40122e</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             	mov    %rax,%rcx<br>  <span class="hljs-attribute">401231</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             	mov    %rcx,%rdi<br>  <span class="hljs-attribute">401234</span>:	ba <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	mov    $<span class="hljs-number">0</span>x8,%edx<br>  <span class="hljs-attribute">401239</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> <span class="hljs-number">80</span>          	mov    %rax,-<span class="hljs-number">0</span>x80(%rbp)<br>  <span class="hljs-attribute">40123d</span>:	e8 <span class="hljs-number">0</span>e fe ff ff       	callq  <span class="hljs-number">401050</span> &lt;memset@plt&gt;<br>  <span class="hljs-attribute">401242</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">7</span>d <span class="hljs-number">80</span>          	mov    -<span class="hljs-number">0</span>x80(%rbp),%rdi<br>  <span class="hljs-attribute">401246</span>:	e8 <span class="hljs-number">95</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">4013</span>e0 &lt;Derive::Derive()&gt;<br>  <span class="hljs-attribute">40124b</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">80</span>          	mov    -<span class="hljs-number">0</span>x80(%rbp),%rax<br>  <span class="hljs-attribute">40124f</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          	mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <br>  <span class="hljs-attribute">00000000004013e0</span> &lt;Derive::Derive()&gt;:<br><span class="hljs-attribute">class</span> Derive : public Base<br>  <span class="hljs-attribute">4013e0</span>:	<span class="hljs-number">55</span>                   	push   %rbp<br>  <span class="hljs-attribute">4013e1</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             	mov    %rsp,%rbp<br>  <span class="hljs-attribute">4013e4</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> ec <span class="hljs-number">10</span>          	sub    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">4013e8</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          	mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">4013ec</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          	mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">4013f0</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             	mov    %rax,%rcx<br>  <span class="hljs-attribute">4013f3</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             	mov    %rcx,%rdi<br>  <span class="hljs-attribute">4013f6</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          	mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <span class="hljs-attribute">4013fa</span>:	e8 <span class="hljs-number">21</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">401420</span> &lt;Base::Base()&gt;<br>  <span class="hljs-attribute">4013ff</span>:	<span class="hljs-number">48</span> b8 <span class="hljs-number">70</span> <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	movabs $<span class="hljs-number">0</span>x402070,%rax<br>  <span class="hljs-attribute">401406</span>:	<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <br>  <span class="hljs-attribute">401409</span>:	<span class="hljs-number">48</span> <span class="hljs-number">05</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	add    $<span class="hljs-number">0</span>x10,%rax<br>  <span class="hljs-attribute">40140f</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d f0          	mov    -<span class="hljs-number">0</span>x10(%rbp),%rcx<br>  <span class="hljs-attribute">401413</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">01</span>             	mov    %rax,(%rcx)<br>  <span class="hljs-attribute">401416</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> c4 <span class="hljs-number">10</span>          	add    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">40141a</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br>  <span class="hljs-attribute">40141b</span>:	c3                   	retq   <br>  <span class="hljs-attribute">40141c</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">40</span> <span class="hljs-number">00</span>          	nopl   <span class="hljs-number">0</span>x0(%rax)<br><br><span class="hljs-attribute">0000000000401420</span> &lt;Base::Base()&gt;:<br><span class="hljs-attribute">class</span> Base<br>  <span class="hljs-attribute">401420</span>:	<span class="hljs-number">55</span>                   	push   %rbp<br>  <span class="hljs-attribute">401421</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             	mov    %rsp,%rbp<br>  <span class="hljs-attribute">401424</span>:	<span class="hljs-number">48</span> b8 d0 <span class="hljs-number">20</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	movabs $<span class="hljs-number">0</span>x4020d0,%rax<br>  <span class="hljs-attribute">40142b</span>:	<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <br>  <span class="hljs-attribute">40142e</span>:	<span class="hljs-number">48</span> <span class="hljs-number">05</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	add    $<span class="hljs-number">0</span>x10,%rax<br>  <span class="hljs-attribute">401434</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          	mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">401438</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d f8          	mov    -<span class="hljs-number">0</span>x8(%rbp),%rcx<br>  <span class="hljs-attribute">40143c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">01</span>             	mov    %rax,(%rcx)<br>  <span class="hljs-attribute">40143f</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br>  <span class="hljs-attribute">401440</span>:	c3                   	retq   <br>  <span class="hljs-attribute">401441</span>:	<span class="hljs-number">66</span> <span class="hljs-number">2</span>e <span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">84</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	nopw   %cs:<span class="hljs-number">0</span>x0(%rax,%rax,<span class="hljs-number">1</span>)<br>  <span class="hljs-attribute">401448</span>:	<span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <br>  <span class="hljs-attribute">40144b</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">44</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	nopl   <span class="hljs-number">0</span>x0(%rax,%rax,<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>
<hr>
<blockquote>
<p><img src="/img%5C00006%5C5.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>è¯¥å›¾å¯¹åº”<code>mov    %rax,-0x80(%rbp)</code>æ‰§è¡Œå®Œã€‚å·²ç»å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šnewè¡¨è¾¾å¼é€šè¿‡<code>operator new(unsigned long)</code>è¿™ä¸ªåŠ¨æ€å‡½æ•°ç”³è¯·äº†é¦–åœ°å€ä¸º<code>0x0000000000416eb0</code>çš„å †å†…å­˜ï¼Œå¹¶å°†å…¶èµ‹ç»™äº†æ ˆç©ºé—´ä¸º<code>rbp-0x80ï¼ˆ0x00007fffffffe060ï¼‰</code>çš„åœ°å€ä¸­ï¼Œä¸‹ä¸€æ¡åæ±‡ç¼–ä»£ç å°†ä¼šä¸ºé¦–åœ°å€ä¸º<code>0x0000000000416eb0</code>çš„å †å†…å­˜è¿›è¡Œå†…å­˜åˆå§‹åŒ–ã€‚<br>ï¼ˆå»¶è¿Ÿç»‘å®š:åŠ¨æ€å‡½æ•°æ¯”é™æ€å‡½æ•°ç»‘å®šè¦æ™šé™æ€å‡½æ•°åœ¨<code>a.out</code>ç”Ÿæˆçš„æ—¶å€™åœ°å€å·²ç»è¢«ç»‘å®š<br>åŠ¨æ€å‡½æ•°éœ€è¦åŠ¨æ€åº“åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åç”¨åŠ¨æ€åº“é‡Œé¢çš„å‡½æ•°åœ°å€æ›¿æ¢æ‰ç±»ä¼¼äºåæ±‡ç¼–å‡ºæ¥çš„<code>@plt</code>ï¼Œä¹‹åå¾—åˆ°åŠ¨æ€å‡½æ•°çš„åœ°å€è¿›è¡Œè°ƒç”¨ã€‚ï¼‰</p>
</blockquote>
<hr>
<blockquote>
<p><img src="/img%5C00006%5C6.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>è¯¥å›¾å¯¹åº”<code>0x40143c &lt;Base::Base()+28&gt; mov    QWORD PTR [rcx], rax</code>æ‰§è¡Œå®Œã€‚å·²ç»å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šè°ƒç”¨äº†<code>Deriveåˆæˆé»˜è®¤æ„é€ å‡½æ•°</code>ï¼Œå¹¶ä¸”åœ¨å…¶ä¸­åˆè°ƒç”¨äº†<code>Baseåˆæˆé»˜è®¤æ„é€ å‡½æ•°</code>ï¼Œé¦–åœ°å€ä¸º<code>0x0000000000416eb0</code>çš„å †å†…å­˜æŒ‡é’ˆèµ‹ç»™äº†ç¬¬ä¸€å‚æ•°å¯„å­˜å™¨<code>rdi</code>ï¼Œ<code>0x4020d0ç«‹å³æ•°</code>ï¼ˆBaseè™šè¡¨åœ°å€ï¼‰èµ‹ç»™äº†ä¸´æ—¶å¯„å­˜å™¨<code>rax</code>ï¼Œ<code>rdi</code>å¯„å­˜å™¨åˆå°†å †å†…å­˜æŒ‡é’ˆèµ‹ç»™äº†Baseåˆæˆé»˜è®¤æ„é€ å‡½æ•°çš„<code>rbp-0x8</code>åœ°å€ä¸Šï¼Œæœ€åç”±<code>rax</code>å¯„å­˜å™¨å°†Baseè™šè¡¨åœ°å€èµ‹ç»™äº†å †å†…å­˜æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ä¸­ã€‚è‡³æ­¤newå‡ºæ¥çš„Deriveç±»å¯¹è±¡çš„<code>vptr</code>å·²ç»è·å–åˆ°Baseç±»çš„è™šè¡¨åœ°å€ï¼ˆæ³¨æ„ç°åœ¨è¿˜æ²¡æœ‰è·å–åˆ°Deriveç±»çš„è™šè¡¨åœ°å€ï¼‰ã€‚</p>
</blockquote>
<hr>
<blockquote>
<p><img src="/img%5C00006%5C7.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>è¯¥å›¾å¯¹åº”<code>0x401413 &lt;Derive::Derive()+51&gt; mov    QWORD PTR [rcx], rax</code>æ‰§è¡Œå®Œã€‚å·²ç»å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼š<code>Baseçš„åˆæˆé»˜è®¤æ„é€ å‡½æ•°</code>å·²<code>return</code>ï¼Œæ¥ç€<code>0x402070ç«‹å³æ•°</code>èµ‹ç»™äº†<code>rax</code>å¯„å­˜å™¨ï¼Œ<code>rax</code>å°†å…¶å€¼åŠ ä¸Š<code>0x10</code>åå°±å¾—åˆ°äº†Deriveç±»çš„è™šè¡¨åœ°å€ã€‚ç„¶å<code>rax</code>å°†è¯¥åœ°å€èµ‹ç»™äº†å †å†…å­˜æŒ‡é’ˆæ‰€æŒ‡å‘çš„åœ°å€ä¸­ã€‚è‡³æ­¤ä¼´éšç€<code>Deriveåˆæˆé»˜è®¤æ„é€ å‡½æ•°</code>çš„ç»“æŸï¼Œnewå‡ºæ¥çš„Deriveç±»å¯¹è±¡çš„<code>vptr</code>è·å¾—äº†è‡ªå·±çš„è™šè¡¨åœ°å€ã€‚</p>
</blockquote>
<hr>
<h3 id="vptråˆå§‹åŒ–å°ç»“"><a href="#vptråˆå§‹åŒ–å°ç»“" class="headerlink" title="vptråˆå§‹åŒ–å°ç»“"></a>vptråˆå§‹åŒ–å°ç»“</h3><blockquote>
<p>å¯ä»¥å‘ç°ï¼Œ<code>vptrçš„åˆå§‹åŒ–</code>å¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±è·å¾—äº†è‡ªå·±çš„è™šè¡¨åœ°å€ï¼Œè€Œæ˜¯ä¼´éšçˆ¶ç±»åˆæˆé»˜è®¤æ„é€ å‡½æ•°çš„ç»“æŸï¼Œå…ˆè·å¾—çˆ¶ç±»è™šè¡¨åœ°å€ï¼Œç„¶åä¼´éšè‡ªèº«åˆæˆé»˜è®¤æ„é€ å‡½æ•°çš„ç»“æŸï¼Œå†è·å¾—è‡ªèº«è™šè¡¨åœ°å€ã€‚</p>
</blockquote>
<hr>
<h2 id="ç¼–è¯‘å™¨ä¼šåˆæˆå‡ºnontrivial-default-constructorçš„4ç§æƒ…å†µï¼ˆã€Šæ·±åº¦æ¢ç´¢c-å¯¹è±¡æ¨¡å‹ã€‹p40ï¼‰"><a href="#ç¼–è¯‘å™¨ä¼šåˆæˆå‡ºnontrivial-default-constructorçš„4ç§æƒ…å†µï¼ˆã€Šæ·±åº¦æ¢ç´¢c-å¯¹è±¡æ¨¡å‹ã€‹p40ï¼‰" class="headerlink" title="ç¼–è¯‘å™¨ä¼šåˆæˆå‡ºnontrivial default constructorçš„4ç§æƒ…å†µï¼ˆã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p40ï¼‰"></a>ç¼–è¯‘å™¨ä¼šåˆæˆå‡ºnontrivial default constructorçš„4ç§æƒ…å†µï¼ˆã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p40ï¼‰</h2><blockquote>
<ul>
<li>å¸¦æœ‰default constructorçš„member class object</li>
</ul>
<p>å¦‚æœä¸€ä¸ªclassæ²¡æœ‰ä»»ä½•constructorï¼Œä½†å®ƒå†…å«ä¸€ä¸ªmember objectï¼Œè€Œåè€…æœ‰default constructorï¼Œé‚£ä¹ˆè¿™ä¸ªclassçš„implicit default constructorå°±æ˜¯nontrivialï¼Œç¼–è¯‘å™¨éœ€è¦ä¸ºè¯¥classåˆæˆå‡ºä¸€ä¸ªdefault constructorã€‚</p>
<ul>
<li>å¸¦æœ‰default constructorçš„base class</li>
</ul>
<p>å¦‚æœä¸€ä¸ªæ²¡æœ‰ä»»ä½•constructorçš„classæ´¾ç”Ÿè‡ªä¸€ä¸ªå¸¦æœ‰default constructorçš„base classï¼Œé‚£ä¹ˆè¿™ä¸ªderived classçš„default constructorä¼šè¢«è§†ä¸ºnontrivialï¼Œå¹¶å› æ­¤éœ€è¦è¢«åˆæˆå‡ºæ¥ã€‚å®ƒå°†è°ƒç”¨ä¸Šä¸€å±‚base classesçš„default constructorï¼ˆæ ¹æ®å®ƒä»¬çš„å£°æ˜é¡ºåºï¼‰ã€‚</p>
<ul>
<li>å¸¦æœ‰ä¸€ä¸ªvirtual functionçš„class</li>
</ul>
<p>å¯¹äºé‚£äº›æœªå£°æ˜ä»»ä½•constructorçš„classesï¼Œç¼–è¯‘å™¨ä¼šä¸ºå®ƒä»¬åˆæˆä¸€ä¸ªdefault constructorï¼Œä»¥ä¾¿æ­£ç¡®åœ°åˆå§‹åŒ–æ¯ä¸€ä¸ªclass objectçš„vptrã€‚</p>
<ul>
<li>å¸¦æœ‰ä¸€ä¸ªvirtual base classçš„class</li>
</ul>
<p>Virtual base class çš„å®ç°æ–¹æ³•åœ¨ä¸åŒç¼–è¯‘å™¨ä¹‹é—´æœ‰æå¤§çš„å·®å¼‚ã€‚ç„¶è€Œï¼Œæ¯ä¸€ç§å®ç°æ–¹æ³•çš„å…±åŒç‚¹åœ¨äºå¿…é¡»ä½¿virtual base classåœ¨å…¶æ¯ä¸€ä¸ªderived class objectä¸­çš„ä½ç½®ï¼Œèƒ½å¤Ÿäºæ‰§è¡ŒæœŸå‡†å¤‡å¦¥å½“ã€‚åœ¨æœªå£°æ˜ä»»ä½•constructorçš„derived class objectä¸­ï¼Œç¼–è¯‘å™¨å¿…é¡»ä¸ºå®ƒåˆæˆä¸€ä¸ªdefault constructorï¼Œå¹¶å®‰æ’é‚£äº›â€œå…è®¸æ¯ä¸€ä¸ªvirtual base classçš„æ‰§è¡ŒæœŸå­˜å–æ“ä½œâ€çš„ä»£ç ã€‚</p>
</blockquote>
<hr>
<h1 id="å¤šé‡ç»§æ‰¿ä¸‹çš„virtual-functionï¼Œthunkï¼Œä»¥åŠç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰"><a href="#å¤šé‡ç»§æ‰¿ä¸‹çš„virtual-functionï¼Œthunkï¼Œä»¥åŠç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰" class="headerlink" title="å¤šé‡ç»§æ‰¿ä¸‹çš„virtual functionï¼Œthunkï¼Œä»¥åŠç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰"></a>å¤šé‡ç»§æ‰¿ä¸‹çš„virtual functionï¼Œthunkï¼Œä»¥åŠç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰</h1><blockquote>
<p>åœ¨å¤šé‡ç»§æ‰¿ä¸­æ”¯æŒvirtual functionï¼Œå…¶å¤æ‚åº¦å›´ç»•åœ¨ç¬¬äºŒä¸ªä»¥åŠåç»§çš„base classesèº«ä¸Šï¼Œä»¥åŠâ€œå¿…é¡»åœ¨æ‰§è¡ŒæœŸè°ƒæ•´thisæŒ‡é’ˆâ€è¿™ä¸€ç‚¹ï¼Œä»¥ä¸‹é¢çš„classä½“ç³»ä¸ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::g()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><span class="hljs-comment">//åŸºç±»2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">i</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::i()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»1çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">i</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»2çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::i()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br><br>    <span class="hljs-comment">//æˆ‘ä»¬è‡ªå·±çš„è™šå‡½æ•°</span><br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">myFunc1</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::myFunc1()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-comment">//éè™šå‡½æ•°</span><br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">myFunc2</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::myFunc2()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br><br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    std::cout &lt;&lt; <span class="hljs-built_in">sizeof</span>(Base1) &lt;&lt; std::endl;<br>    std::cout &lt;&lt; <span class="hljs-built_in">sizeof</span>(Base2) &lt;&lt; std::endl;<br>    std::cout &lt;&lt; <span class="hljs-built_in">sizeof</span>(Derived) &lt;&lt; std::endl;<br><br>    Derived ins;<br>    Base1&amp; b1 = ins;<span class="hljs-comment">//ä¸ºäº†æ”¯æŒå¤šæ€ã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹p25ã€‹</span><br>    Base2&amp; b2 = ins;<br>    Derived&amp; d = ins;<br><br>    <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span><span class="hljs-params">(*Func)</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<br>    <span class="hljs-comment">/*è·å¾—Base1ç±»çš„ç¬¬è™šè¡¨æŒ‡é’ˆ*/</span><br>    Base1 temp1;<br>    <span class="hljs-type">long</span>* base1_cast = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(&amp;temp1);<span class="hljs-comment">//é‡æ–°è§£é‡Šç±»å¯¹è±¡,è·å¾—è™šè¡¨æŒ‡é’ˆçš„åœ°å€ã€‚</span><br>    <span class="hljs-type">long</span>* base1_vptr = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*base1_cast);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-comment">//æ‰“å°è™šå‡½æ•°åœ°å€</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base1_vptr[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,base1_vptr[i]);<br>        ((Func)base1_vptr[i])();<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">/*è·å¾—Base2ç±»çš„ç¬¬è™šè¡¨æŒ‡é’ˆ*/</span><br>    Base2 temp2;<br>    <span class="hljs-type">long</span>* base2_cast = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(&amp;temp2);<span class="hljs-comment">//é‡æ–°è§£é‡Šç±»å¯¹è±¡,è·å¾—ç¬¬è™šè¡¨æŒ‡é’ˆçš„åœ°å€ã€‚</span><br>    <span class="hljs-type">long</span>* base2_vptr = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*base2_cast);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-comment">//æ‰“å°è™šå‡½æ•°åœ°å€</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;base2_vptr[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,base2_vptr[i]);<br>        ((Func)base2_vptr[i])();<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">/*è·å¾—derivedç±»çš„ç¬¬ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆ*/</span><br>    <span class="hljs-type">long</span>* ins_cast1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(&amp;ins);<span class="hljs-comment">//é‡æ–°è§£é‡Šç±»å¯¹è±¡,è·å¾—ç¬¬ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆçš„åœ°å€ã€‚</span><br>    <span class="hljs-type">long</span>* vptr1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*ins_cast1);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-comment">//æ‰“å°è™šå‡½æ•°åœ°å€</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vptr1[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,vptr1[i]);<br>        ((Func)vptr1[i])();<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">/*è·å¾—derivedç±»çš„ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆ*/</span><br>    <span class="hljs-type">long</span>* ins_cast2 = ins_cast1 + <span class="hljs-number">1</span>;<span class="hljs-comment">//åç§»åˆ°ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆçš„åœ°å€ä¸Š</span><br>    <span class="hljs-type">long</span>* vptr2 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*ins_cast2);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-comment">//æ‰“å°è™šå‡½æ•°åœ°å€</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;vptr2[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,vptr2[i]);<br>        ((Func)vptr2[i])();<br>    &#125;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-comment">//åŠ¨æ€ç»‘å®š</span><br>    b1.<span class="hljs-built_in">f</span>();<br>    b2.<span class="hljs-built_in">i</span>();<br>    d.<span class="hljs-built_in">f</span>();<br>    d.<span class="hljs-built_in">i</span>();<br>    d.<span class="hljs-built_in">g</span>();<br>    d.<span class="hljs-built_in">myFunc1</span>();<br>    <span class="hljs-comment">//ç¼–è¯‘æœŸç»‘å®š</span><br>    d.<span class="hljs-built_in">myFunc2</span>();<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„å­ç±»ä¼šæœ‰ä¸¤ä¸ªè™šæŒ‡é’ˆï¼Œä¸¤å¼ è™šè¡¨ï¼Œç¬¬ä¸€å¼ è™šè¡¨æ˜¯é‡å†™çˆ¶ç±»è™šå‡½æ•°ã€è‡ªèº«è™šå‡½æ•°ä»¥åŠbase1è™šå‡½æ•°å…±äº«çš„è™šè¡¨ï¼Œç¬¬äºŒå¼ åˆ™æ˜¯é’ˆå¯¹base2çš„ã€‚ä¸‹é¢æ¥çœ‹ä¸‹è¿è¡Œç»“æœï¼š<br><img src="/img%5C00006%5C8.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>é‡å†™çš„çˆ¶ç±»è™šå‡½æ•°ï¼š<code>f()</code>ï¼Œ<code>i()</code>ã€è‡ªèº«è™šå‡½æ•°ï¼š<code>myFunc1()</code>ã€base1è™šå‡½æ•°ï¼š<code>g()</code>éƒ½åœ¨ç¬¬ä¸€å¼ è™šè¡¨ã€‚è€Œç¬¬äºŒå¼ è™šè¡¨ä¸­ï¼Œ<code>h()</code>çš„å‡ºç°å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯è¿™ä¸ªè¢«é‡å†™çš„çˆ¶ç±»è™šå‡½æ•°<code>i()</code>ï¼Œä¸ºä»€ä¹ˆä¼šå†æ¬¡å‡ºç°å‘¢ï¼Ÿï¼Œä¸åº”è¯¥åªåœ¨è¡¨ä¸€å‡ºç°å—ï¼Ÿ<br>è¿™é‡Œè¡¨äºŒä¸­è¢«é‡å†™çš„çˆ¶ç±»è™šå‡½æ•°<code>i()</code>ï¼Œå…¶çœŸåå«<code>nonvirtual thunk</code>å‡½æ•°ã€‚<br>å’±ä»¬ç”¨æŒ‡ä»¤æ¥æ›´æ¸…æ™°çš„è§‚å¯ŸDerivedç±»å¯¹è±¡insçš„ä¸¤å¼ è™šè¡¨ï¼š<br>ï¼ˆæ³¨æ„ï¼š å¿…é¡»åœ¨æ”¯æŒå¤šæ€çš„æƒ…å†µä¸‹è§‚å¯ŸDerivedç±»å¯¹è±¡insï¼Œå…·ä½“åŸå› è¯·å‚è€ƒã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p13ï¼‰<br><img src="/img%5C00006%5C9.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>ä¸Šæ–‡è¯´è¿‡â€œå¿…é¡»åœ¨æ‰§è¡ŒæœŸè°ƒæ•´thisæŒ‡é’ˆâ€ï¼Œè€Œthunkå‡½æ•°çš„çœŸæ­£ç›®çš„ä¸ºï¼š</p>
<ul>
<li>ä»¥é€‚å½“çš„offsetå€¼è°ƒæ•´thisæŒ‡é’ˆ</li>
<li>è·³åˆ°virtual functionå»</li>
</ul>
<p>å…¶å®thunkå‡½æ•°å°±æ˜¯ä¸€æ®µassemblyä»£ç ï¼Œä¸‹é¢æˆ‘ä¼šå¸¦å¤§å®¶ä¸€èµ·æ­å¼€thunkå‡½æ•°çš„çœŸæ­£é¢çº±ï¼<br>é¦–å…ˆè¦æƒ³çŸ¥é“thunkå‡½æ•°å¹²äº†ä»€ä¹ˆï¼Œå°±è¦æƒ³ä¸ªåŠæ³•å»è°ƒç”¨å®ƒï¼Œç„¶åè·Ÿè¸ªè¿›å»ã€‚æˆ‘ä»¬ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­æœ‰ä¸€è¡Œä»£ç ï¼š<code>b2.i();</code>ä¼šè°ƒç”¨thunkå‡½æ•°ã€‚åŸå› æ˜¯<code>Base2&amp; b2 = ins;</code>ä¸­ï¼Œb2çš„thisæŒ‡é’ˆæŒ‡å‘çš„inså¯¹è±¡çš„ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨inså¯¹è±¡çš„è¢«é‡å†™çˆ¶ç±»è™šå‡½æ•°<code>i()</code>æ—¶ï¼Œéœ€è¦è°ƒæ•´thisæŒ‡é’ˆã€‚<br>å…·ä½“åˆ†æè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache">    <span class="hljs-attribute">b2</span>.i();<br>  <span class="hljs-attribute">401553</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d8          	mov    -<span class="hljs-number">0</span>x28(%rbp),%rax//rbp-<span class="hljs-number">0</span>x28é‡Œé¢å­˜ç€b2çš„thisæŒ‡é’ˆï¼ŒæŒ‡å‘inså¯¹è±¡çš„ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆ<br>  <span class="hljs-attribute">401557</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx//å°†insè™šè¡¨äºŒçš„ç¬¬ä¸€ä¸ªè™šå‡½æ•°æŒ‡é’ˆèµ‹ç»™äº†rcxå¯„å­˜å™¨<br>  <span class="hljs-attribute">40155a</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi//å°†b2çš„thisæŒ‡é’ˆå­˜åˆ°rdiå¯„å­˜å™¨ä½œä¸ºthunkå‡½æ•°çš„ç¬¬ä¸€å‚æ•°<br>  <span class="hljs-attribute">40155d</span>:	ff <span class="hljs-number">51</span> <span class="hljs-number">08</span>             	callq  *<span class="hljs-number">0</span>x8(%rcx)//åç§»<span class="hljs-number">0</span>x8å­—èŠ‚åè°ƒç”¨thunkå‡½æ•°ï¼Œ*<span class="hljs-number">0</span>x8(%rcx)çš„å€¼ä¸º<span class="hljs-number">0</span>x4017f0<br><br><span class="hljs-attribute">00000000004017f0</span> &lt;non-virtual thunk to Derived::i()&gt;:<br>  <span class="hljs-attribute">4017f0</span>:	<span class="hljs-number">55</span>                   	push   %rbp<br>  <span class="hljs-attribute">4017f1</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             	mov    %rsp,%rbp<br>  <span class="hljs-attribute">4017f4</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          	mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)//å°†b2çš„thisæŒ‡é’ˆå­˜æ”¾åˆ°è¯¥thunkå‡½æ•°rbp-<span class="hljs-number">0</span>x8çš„åœ°å€ä¸­<br>  <span class="hljs-attribute">4017f8</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          	mov    -<span class="hljs-number">0</span>x8(%rbp),%rax//å°†b2çš„thisæŒ‡é’ˆå­˜æ”¾åˆ°raxä¸´æ—¶å¯„å­˜å™¨ä¸­<br>  <span class="hljs-attribute">4017fc</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> c0 f8          	add    $<span class="hljs-number">0</span>xfffffffffffffff8,%rax//thisæŒ‡é’ˆçš„å€¼ï¼ˆ<span class="hljs-number">0</span>x00007fffffffe120ï¼‰åŠ ä¸Š<span class="hljs-number">0</span>xfffffffffffffff8ï¼Œå› ä¸ºæº¢å‡ºï¼Œç›¸å½“äº<span class="hljs-number">0</span>x00007fffffffe120-<span class="hljs-number">0</span>x8ï¼Œç»“æœä¸º<span class="hljs-number">0</span>x00007fffffffe118å³inså¯¹è±¡çš„é¦–åœ°å€<br>  <span class="hljs-attribute">401800</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi//å°†åç§»åçš„thisæŒ‡é’ˆå­˜åˆ°rdiç¬¬ä¸€å‚æ•°å¯„å­˜å™¨ä¸­ï¼Œä½œä¸º&lt;Derived::i()&gt;çš„å‚æ•°<br>  <span class="hljs-attribute">401803</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br>  <span class="hljs-attribute">401804</span>:	e9 <span class="hljs-number">27</span> ff ff ff       	jmpq   <span class="hljs-number">401730</span> &lt;Derived::i()&gt;<br>  <span class="hljs-attribute">401809</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	nopl   <span class="hljs-number">0</span>x0(%rax)<br></code></pre></td></tr></table></figure>
<blockquote>
<p>åé¢å°±æ˜¯è°ƒç”¨è™šå‡½æ•°<code>&lt;Derived::i()&gt;</code>åçš„è¿‡ç¨‹ï¼Œä¸å†èµ˜è¿°ã€‚ç»è¿‡åˆ†æï¼Œå¯ä»¥å‘ç°thunkå‡½æ•°å°±åšäº†ä¸¤ä»¶äº‹ï¼Œä»¥é€‚å½“çš„<code>offset</code>å€¼è°ƒæ•´thisæŒ‡é’ˆï¼Œè·³åˆ°virtual functionå»ã€‚å’Œä¸Šé¢è¯´çš„ä¸¤ç‚¹å®Œå…¨ä¸€è‡´ã€‚</p>
</blockquote>
<hr>
<h2 id="ç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰"><a href="#ç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰" class="headerlink" title="ç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰"></a>ç¼–è¯‘æœŸç»‘å®šå’Œè¿è¡ŒæœŸç»‘å®šï¼ˆåŠ¨æ€ç»‘å®šï¼‰</h2><blockquote>
<p>è¿˜æ˜¯ç”¨ä¸Šé¢çš„ç¤ºä¾‹ï¼Œå¯ä»¥çœ‹åˆ°å­ç±»ä¸­æœ‰å®šä¹‰ä¸€ä¸ªéè™šå‡½æ•°ã€‚å’±ä»¬å°±æ¥çœ‹ä¸‹ä»€ä¹ˆæ˜¯è¿è¡ŒæœŸç»‘å®šå’ŒåŠ¨æ€ç»‘å®šçš„åŒºåˆ«æ˜¯ä»€ä¹ˆã€‚<br>åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹ç»‘å®šçš„æ¦‚å¿µï¼šè°ƒç”¨ä»£ç è·Ÿå‡½æ•°åœ°å€ä»€ä¹ˆæ—¶å€™å…³è”åˆ°ä¸€èµ·ã€‚</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//ç¼–è¯‘æœŸç»‘å®š</span><br>d.<span class="hljs-built_in">myFunc2</span>();<br></code></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">d</span>.myFunc2();<br><span class="hljs-attribute">401596</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">7</span>d d0          	mov    -<span class="hljs-number">0</span>x30(%rbp),%rdi<br><span class="hljs-attribute">40159a</span>:	e8 d1 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">401670</span> &lt;Derived::myFunc2()&gt;<br></code></pre></td></tr></table></figure>
<blockquote>
<p><code>ç¼–è¯‘æœŸç»‘å®š</code>ï¼šè°ƒç”¨ä»£ç è·Ÿå‡½æ•°åœ¨ç¼–è¯‘æœŸå°±å…³è”åˆ°ä¸€èµ·ã€‚å¯ä»¥çœ‹åˆ°å‡½æ•°è°ƒç”¨æ˜¯ç›´æ¥è°ƒç”¨æŒ‡å®šåœ°å€çš„å‡½æ•°ï¼Œè€Œä¸”æœºå™¨ç ä¼šå‡ºç°E8çš„å­—æ ·ï¼Œè¡¨ç¤ºç›´æ¥è°ƒç”¨ï¼Œä¿—ç§°<code>E8CALL</code>ã€‚</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//åŠ¨æ€ç»‘å®š</span><br>b1.<span class="hljs-built_in">f</span>();<br>b2.<span class="hljs-built_in">i</span>();<br>d.<span class="hljs-built_in">f</span>();<br>d.<span class="hljs-built_in">i</span>();<br>d.<span class="hljs-built_in">g</span>();<br>d.<span class="hljs-built_in">myFunc1</span>();<br></code></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs apache"> <span class="hljs-attribute">b1</span>.f();<br><span class="hljs-attribute">401540</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d e0          	mov    -<span class="hljs-number">0</span>x20(%rbp),%rcx<br><span class="hljs-attribute">401544</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">11</span>             	mov    (%rcx),%rdx<br><span class="hljs-attribute">401547</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             	mov    %rcx,%rdi<br><span class="hljs-attribute">40154a</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">85</span> <span class="hljs-number">20</span> ff ff ff 	mov    %rax,-<span class="hljs-number">0</span>xe0(%rbp)<br><span class="hljs-attribute">401551</span>:	ff <span class="hljs-number">12</span>                	callq  *(%rdx)<br>  <span class="hljs-attribute">b2</span>.i();<br><span class="hljs-attribute">401553</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d8          	mov    -<span class="hljs-number">0</span>x28(%rbp),%rax<br><span class="hljs-attribute">401557</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">40155a</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">40155d</span>:	ff <span class="hljs-number">51</span> <span class="hljs-number">08</span>             	callq  *<span class="hljs-number">0</span>x8(%rcx)<br>  <span class="hljs-attribute">d</span>.f();<br><span class="hljs-attribute">401560</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          	mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">401564</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">401567</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">40156a</span>:	ff <span class="hljs-number">11</span>                	callq  *(%rcx)<br>  <span class="hljs-attribute">d</span>.i();<br><span class="hljs-attribute">40156c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          	mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">401570</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">401573</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">401576</span>:	ff <span class="hljs-number">51</span> <span class="hljs-number">10</span>             	callq  *<span class="hljs-number">0</span>x10(%rcx)<br>  <span class="hljs-attribute">d</span>.g();<br><span class="hljs-attribute">401579</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          	mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">40157d</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             	mov    %rax,%rcx<br><span class="hljs-attribute">401580</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">00</span>             	mov    (%rax),%rax<br><span class="hljs-attribute">401583</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             	mov    %rcx,%rdi<br><span class="hljs-attribute">401586</span>:	ff <span class="hljs-number">50</span> <span class="hljs-number">08</span>             	callq  *<span class="hljs-number">0</span>x8(%rax)<br>  <span class="hljs-attribute">d</span>.myFunc1();<br><span class="hljs-attribute">401589</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          	mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">40158d</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">401590</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">401593</span>:	ff <span class="hljs-number">51</span> <span class="hljs-number">18</span>             	callq  *<span class="hljs-number">0</span>x18(%rcx)<br></code></pre></td></tr></table></figure>
<blockquote>
<p><code>åŠ¨æ€ç»‘å®š</code>ï¼šè°ƒç”¨ä»£ç è·Ÿå‡½æ•°åœ¨è¿è¡ŒæœŸæ‰èƒ½å…³è”åˆ°ä¸€èµ·ã€‚é€šè¿‡ä¸Šé¢çš„åæ±‡ç¼–ä»£ç å¯ä»¥å‘ç°ï¼Œå‡½æ•°çš„è°ƒç”¨åœ°å€æ˜¯åŸºäºæŸä¸ªå¯„å­˜å™¨çš„åç§»å€¼è€Œç¡®å®šçš„ï¼Œæ— æ³•åœ¨ç¼–è¯‘æœŸç¡®å®šã€‚è€Œä¸”åœ¨å‡½æ•°è°ƒç”¨æœºå™¨ç ä¸­ä¼šå‡ºç°ffçš„å­—æ ·ï¼Œè¡¨ç¤ºé—´æ¥è°ƒç”¨ï¼Œä¿—ç§°<code>FFCALL</code>ã€‚åŠ¨æ€ç»‘å®šè¿˜æœ‰ä¸€ä¸ªåˆ«åå«<code>å¤šæ€</code>ï¼Œåªæœ‰è™šå‡½æ•°æ‰èƒ½æ˜¯åŠ¨æ€ç»‘å®šã€‚</p>
</blockquote>
<hr>
<h1 id="å¤šé‡ç»§æ‰¿ä¸‹çš„æˆå‘˜å¸ƒå±€ä»¥åŠthisæŒ‡é’ˆåç§»"><a href="#å¤šé‡ç»§æ‰¿ä¸‹çš„æˆå‘˜å¸ƒå±€ä»¥åŠthisæŒ‡é’ˆåç§»" class="headerlink" title="å¤šé‡ç»§æ‰¿ä¸‹çš„æˆå‘˜å¸ƒå±€ä»¥åŠthisæŒ‡é’ˆåç§»"></a>å¤šé‡ç»§æ‰¿ä¸‹çš„æˆå‘˜å¸ƒå±€ä»¥åŠthisæŒ‡é’ˆåç§»</h1><blockquote>
<p>ç»è¿‡ä¸Šæ–‡çš„åˆ†æï¼Œæˆ‘ä»¬å·²ç»ç†ŸçŸ¥å¤šé‡ç»§æ‰¿ä¸‹è™šæœºåˆ¶æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚è¿™ä¸€å°èŠ‚ï¼Œæˆ‘å°†å¸¦å¤§å®¶åˆ†æçˆ¶ç±»å«æˆå‘˜å˜é‡æ—¶å¤šé‡ç»§æ‰¿çš„æˆå‘˜å¸ƒå±€ã€‚åœ¨çˆ¶ç±»æŒ‡é’ˆæ”¯æŒå¤šæ€æ—¶ä¼šå‘ç”ŸthisæŒ‡é’ˆåç§»ï¼Œdelete thisæŒ‡é’ˆåç§»åçš„çˆ¶ç±»æŒ‡é’ˆä¼šå¯¼è‡´å¼‚å¸¸ã€‚è¯´çš„æœ‰ç‚¹ç¹çï¼Œä¸è¦ç´§ï¼Œå’±ä»¬çœ‹ä¸‹æ–‡ï¼š<br>ä»£ç ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//åŸºç±»1</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base1</span>():<span class="hljs-built_in">b1</span>(<span class="hljs-number">1</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-type">int</span> b1;<br>&#125;;<br><span class="hljs-comment">//åŸºç±»2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base2</span>():<span class="hljs-built_in">b2</span>(<span class="hljs-number">2</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-type">int</span> b2;<br>&#125;;<br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Derived</span>():<span class="hljs-built_in">m</span>(<span class="hljs-number">3</span>),<span class="hljs-built_in">n</span>(<span class="hljs-number">4</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»1çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-type">int</span> m;<br>    <span class="hljs-type">int</span> n;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derivedç±»çš„å¤§å°%d\n&quot;</span>,<span class="hljs-built_in">sizeof</span>(Derived));<br>    <span class="hljs-comment">//æ‰“å°æˆå‘˜å˜é‡çš„åç§»å€¼</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derived::b1 = %d\n&quot;</span>,&amp;Derived::b1);<span class="hljs-comment">//b1æ˜¯åŸºäºBase1çš„åç§»</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derived::b2 = %d\n&quot;</span>,&amp;Derived::b2);<span class="hljs-comment">//b2æ˜¯åŸºäºBase2çš„åç§»</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derived::m = %d\n&quot;</span>,&amp;Derived::m);<span class="hljs-comment">//måŸºäºDerivedçš„åç§»</span><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Derived::n = %d\n&quot;</span>,&amp;Derived::n);<span class="hljs-comment">//nåŸºäºDerivedçš„åç§»</span><br><br>    Derived obj;<br>    Base1 *pbase1 = &amp;obj;<span class="hljs-comment">//thisæŒ‡é’ˆæ²¡æœ‰è°ƒæ•´ã€‚</span><br>    Base2 *pbase2 = &amp;obj;<span class="hljs-comment">//thisæŒ‡é’ˆå‘ä¸‹è°ƒæ•´0x10å­—èŠ‚ã€‚</span><br><br>    <span class="hljs-comment">//ç°åœ¨æˆ‘ä»¬çŸ¥é“Base2åœ¨æ”¯æŒå¤šæ€æ—¶ä¼šè°ƒæ•´thisæŒ‡é’ˆã€‚å¦‚æœæˆ‘ä»¬çš„objæ˜¯newå‡ºæ¥çš„ï¼Œå½“æˆ‘ä»¬ç”¨deleteå»åˆ é™¤pbase2æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</span><br>    Base2 *new_pbase2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    <span class="hljs-comment">//delete new_pbase2;å¼‚å¸¸</span><br>    <span class="hljs-built_in">delete</span> (Derived*)new_pbase2;<span class="hljs-comment">//è®©ç¼–è¯‘å™¨é‡æ–°è°ƒæ•´thisæŒ‡é’ˆï¼Œå†deleteæ‰ã€‚</span><br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br><img src="/img%5C00006%5C10.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>æ ¹æ®æ•°æ®æˆå‘˜çš„åç§»å€¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¯¥ç±»çš„æˆå‘˜å¸ƒå±€ï¼š<br><img src="/img%5C00006%5C11.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>ç”¨GDBæ‰“å°å‡ºç©ºé—´å¸ƒå±€ï¼Œä»¥åŠè™šè¡¨å†…çš„è™šå‡½æ•°ï¼š<br><img src="/img%5C00006%5C12.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>å’Œä¸Šè¿°è¯´æ˜ä¸€è‡´ï¼<br>å€¼å¾—å…³æ³¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼ŒBase2åœ¨æ”¯æŒå¤šæ€æ—¶ä¼šè°ƒæ•´thisæŒ‡é’ˆã€‚å¦‚æœæˆ‘ä»¬çš„objæ˜¯newå‡ºæ¥çš„ï¼Œå½“æˆ‘ä»¬ç”¨deleteå»åˆ é™¤pbase2æ—¶ä¼šæŠ¥å¼‚å¸¸ï¼Œå…¶åŸå› åœ¨äºç›´æ¥deleteè°ƒæ•´åçš„thisæŒ‡é’ˆæ— æ³•å°†newå‡ºæ¥çš„derivedç±»å¯¹è±¡å®Œæ•´åˆ é™¤ã€‚é™¤éæˆ‘ä»¬å°†è¯¥thisæŒ‡é’ˆç»§ç»­è°ƒæ•´åˆ°derivedç±»å¯¹è±¡çš„å¼€å¤´ï¼Œæˆ–è€…åœ¨çˆ¶ç±»å’ŒåŸºç±»ä¸­æ·»åŠ virtualææ„å‡½æ•°ã€‚<br>ä¸‹ä¸€å°èŠ‚å’±ä»¬ç»§ç»­æ·±å…¥æ¢è®¨å¤šé‡ç»§æ‰¿ä¸‹virtualææ„å‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠè™šè¡¨å¯¹åº”çš„å˜åŒ–ï¼</p>
</blockquote>
<hr>
<h1 id="å¤šé‡ç»§æ‰¿ä¸‹virtualææ„å‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠè™šè¡¨çš„å˜åŒ–"><a href="#å¤šé‡ç»§æ‰¿ä¸‹virtualææ„å‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠè™šè¡¨çš„å˜åŒ–" class="headerlink" title="å¤šé‡ç»§æ‰¿ä¸‹virtualææ„å‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠè™šè¡¨çš„å˜åŒ–"></a>å¤šé‡ç»§æ‰¿ä¸‹virtualææ„å‡½æ•°çš„å·¥ä½œåŸç†ä»¥åŠè™šè¡¨çš„å˜åŒ–</h1><blockquote>
<p>ç»§ä¸Šä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“å¤šé‡ç»§æ‰¿ä¸‹æ•°æ®æˆå‘˜çš„åˆ†å¸ƒï¼Œä¸ºäº†æ›´å¥½çš„è§£å†³delete thisæŒ‡é’ˆåç§»åçš„çˆ¶ç±»æŒ‡é’ˆï¼Œæˆ‘ä»¬å¿…é¡»åœ¨çˆ¶ç±»å’ŒåŸºç±»ä¸­æ·»åŠ virtualææ„å‡½æ•°ã€‚è¿™æ ·ç¼–è¯‘å™¨å°±ä¼šä¸ºè™šè¡¨å¤šåŠ å‡ ä¸ªæ§½ï¼Œç›®çš„åœ¨äºå¸®åŠ©thisæŒ‡é’ˆåç§»åçš„çˆ¶ç±»æŒ‡é’ˆå›è°ƒåˆ°derivedç±»å¯¹è±¡çš„å¼€å¤´ï¼Œè¿›è€Œå®Œæˆdeleteã€‚<br>ç¤ºä¾‹ä»£ç å’Œä¸Šä¸€å°èŠ‚å·®ä¸å¤šï¼Œå¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//åŸºç±»1</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base1</span>():<span class="hljs-built_in">b1</span>(<span class="hljs-number">1</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base1</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> b1;<br>&#125;;<br><span class="hljs-comment">//åŸºç±»2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base2</span>():<span class="hljs-built_in">b2</span>(<span class="hljs-number">2</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base2</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> b2;<br>&#125;;<br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Derived</span>():<span class="hljs-built_in">m</span>(<span class="hljs-number">3</span>),<span class="hljs-built_in">n</span>(<span class="hljs-number">4</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»1çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Derived</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> m;<br>    <span class="hljs-type">int</span> n;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    Derived *new_pderived = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    <span class="hljs-comment">//æ‰“å°ç¬¬ä¸€å¼ è™šè¡¨</span><br>    <span class="hljs-type">long</span>* pderived_cast1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(new_pderived);<span class="hljs-comment">//é‡æ–°è§£é‡Šç±»å¯¹è±¡,è·å¾—è™šè¡¨æŒ‡é’ˆçš„åœ°å€ã€‚</span><br>    <span class="hljs-type">long</span>* pderived_vptr1 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*pderived_cast1);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pderived_vptr1[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,pderived_vptr1[i]);<br>    &#125;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;----------------------------&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-comment">//æ‰“å°ç¬¬äºŒå¼ è™šè¡¨</span><br>    <span class="hljs-type">long</span>* pderived_cast2 = pderived_cast1 + <span class="hljs-number">2</span>;<span class="hljs-comment">//åç§»åˆ°ç¬¬äºŒä¸ªè™šè¡¨æŒ‡é’ˆçš„åœ°å€ä¸Š</span><br>    <span class="hljs-type">long</span>* pderived_vptr2 = <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">long</span>*&gt;(*pderived_cast2);<span class="hljs-comment">//è™šè¡¨æŒ‡é’ˆçš„ç±»å‹ä»longé‡æ–°è§£é‡Šä¸ºlong*ã€‚è®©å®ƒä½“ç°å‡ºæŒ‡é’ˆçš„æ€§è´¨è€Œä¸æ˜¯longæ•°å€¼</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;pderived_vptr2[%d] çš„å†…å®¹ä¸ºï¼š %p\n&quot;</span>,i,pderived_vptr2[i]);<br>    &#125;<br>    <span class="hljs-keyword">delete</span> new_pderived;<br><br>    Base2 *new_pbase2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    <span class="hljs-keyword">delete</span> new_pbase2;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>å…¶å¯¹åº”çš„åæ±‡ç¼–ä»£ç å¦‚ä¸‹(æˆ‘å°†æœ‰ç”¨çš„éƒ¨åˆ†è´´åœ¨ä¸‹é¢)ï¼š</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs apache">    <span class="hljs-attribute">Base2</span> *new_pbase2 = new Derived();<br>  <span class="hljs-attribute">40136e</span>:	e8 <span class="hljs-number">0</span>d fd ff ff       	callq  <span class="hljs-number">401080</span> &lt;operator new(unsigned long)@plt&gt;<br>  <span class="hljs-attribute">401373</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             	mov    %rax,%rcx<br>  <span class="hljs-attribute">401376</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c2             	mov    %rax,%rdx<br>  <span class="hljs-attribute">401379</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br>  <span class="hljs-attribute">40137c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d <span class="hljs-number">88</span>          	mov    %rcx,-<span class="hljs-number">0</span>x78(%rbp)<br>  <span class="hljs-attribute">401380</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">55</span> <span class="hljs-number">80</span>          	mov    %rdx,-<span class="hljs-number">0</span>x80(%rbp)<br>  <span class="hljs-attribute">401384</span>:	e8 <span class="hljs-number">87</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">401410</span> &lt;Derived::Derived()&gt;<br>  <span class="hljs-attribute">401389</span>:	e9 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	jmpq   <span class="hljs-number">40138</span>e &lt;main+<span class="hljs-number">0</span>x16e&gt;<br>  <span class="hljs-attribute">40138e</span>:	<span class="hljs-number">31</span> c0                	xor    %eax,%eax<br>  <span class="hljs-attribute">401390</span>:	<span class="hljs-number">89</span> c1                	mov    %eax,%ecx<br>  <span class="hljs-attribute">401392</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">55</span> <span class="hljs-number">80</span>          	mov    -<span class="hljs-number">0</span>x80(%rbp),%rdx<br>  <span class="hljs-attribute">401396</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> fa <span class="hljs-number">00</span>          	cmp    $<span class="hljs-number">0</span>x0,%rdx<br>  <span class="hljs-attribute">40139a</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">8</span>d <span class="hljs-number">78</span> ff ff ff 	mov    %rcx,-<span class="hljs-number">0</span>x88(%rbp)<br>  <span class="hljs-attribute">4013a1</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">11</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	je     <span class="hljs-number">4013</span>b8 &lt;main+<span class="hljs-number">0</span>x198&gt;<br>  <span class="hljs-attribute">4013a7</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">80</span>          	mov    -<span class="hljs-number">0</span>x80(%rbp),%rax<br>  <span class="hljs-attribute">4013ab</span>:	<span class="hljs-number">48</span> <span class="hljs-number">05</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	add    $<span class="hljs-number">0</span>x10,%rax<br>  <span class="hljs-attribute">4013b1</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">85</span> <span class="hljs-number">78</span> ff ff ff 	mov    %rax,-<span class="hljs-number">0</span>x88(%rbp)<br>  <span class="hljs-attribute">4013b8</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">85</span> <span class="hljs-number">78</span> ff ff ff 	mov    -<span class="hljs-number">0</span>x88(%rbp),%rax<br>  <span class="hljs-attribute">4013bf</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> a8          	mov    %rax,-<span class="hljs-number">0</span>x58(%rbp)<br>    <span class="hljs-attribute">delete</span> new_pbase2;<br>  <span class="hljs-attribute">4013c3</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> a8          	mov    -<span class="hljs-number">0</span>x58(%rbp),%rax<br>  <span class="hljs-attribute">4013c7</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> f8 <span class="hljs-number">00</span>          	cmp    $<span class="hljs-number">0</span>x0,%rax<br>  <span class="hljs-attribute">4013cb</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">85</span> <span class="hljs-number">70</span> ff ff ff 	mov    %rax,-<span class="hljs-number">0</span>x90(%rbp)<br>  <span class="hljs-attribute">4013d2</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	je     <span class="hljs-number">4013</span>e8 &lt;main+<span class="hljs-number">0</span>x1c8&gt;<br>  <span class="hljs-attribute">4013d8</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">85</span> <span class="hljs-number">70</span> ff ff ff 	mov    -<span class="hljs-number">0</span>x90(%rbp),%rax<br>  <span class="hljs-attribute">4013df</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br>  <span class="hljs-attribute">4013e2</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br>  <span class="hljs-attribute">4013e5</span>:	ff <span class="hljs-number">51</span> <span class="hljs-number">10</span>             	callq  *<span class="hljs-number">0</span>x10(%rcx)<br>  <span class="hljs-attribute">4013e8</span>:	<span class="hljs-number">8</span>b <span class="hljs-number">45</span> fc             	mov    -<span class="hljs-number">0</span>x4(%rbp),%eax<br>  <span class="hljs-attribute">4013eb</span>:	<span class="hljs-number">48</span> <span class="hljs-number">81</span> c4 <span class="hljs-number">90</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	add    $<span class="hljs-number">0</span>x90,%rsp<br>  <span class="hljs-attribute">4013f2</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br>  <span class="hljs-attribute">4013f3</span>:	c3                   	retq  <br><br><span class="hljs-attribute">0000000000401540</span> &lt;Derived::~Derived()&gt;:<br>    <span class="hljs-attribute">virtual</span> ~Derived() &#123;&#125;<br>  <span class="hljs-attribute">401540</span>:	<span class="hljs-number">55</span>                   	push   %rbp<br>  <span class="hljs-attribute">401541</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             	mov    %rsp,%rbp<br>  <span class="hljs-attribute">401544</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> ec <span class="hljs-number">10</span>          	sub    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">401548</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          	mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">40154c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          	mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">401550</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             	mov    %rax,%rcx<br>  <span class="hljs-attribute">401553</span>:	<span class="hljs-number">48</span> <span class="hljs-number">81</span> c1 <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	add    $<span class="hljs-number">0</span>x10,%rcx<br>  <span class="hljs-attribute">40155a</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> cf             	mov    %rcx,%rdi<br>  <span class="hljs-attribute">40155d</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          	mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <span class="hljs-attribute">401561</span>:	e8 aa <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">401710</span> &lt;Base2::~Base2()&gt;<br>  <span class="hljs-attribute">401566</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f0          	mov    -<span class="hljs-number">0</span>x10(%rbp),%rax<br>  <span class="hljs-attribute">40156a</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br>  <span class="hljs-attribute">40156d</span>:	e8 <span class="hljs-number">1</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">401690</span> &lt;Base1::~Base1()&gt;<br>  <span class="hljs-attribute">401572</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> c4 <span class="hljs-number">10</span>          	add    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">401576</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br>  <span class="hljs-attribute">401577</span>:	c3                   	retq   <br>  <span class="hljs-attribute">401578</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">84</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	nopl   <span class="hljs-number">0</span>x0(%rax,%rax,<span class="hljs-number">1</span>)<br>  <span class="hljs-attribute">40157f</span>:	<span class="hljs-number">00</span> <br><br><span class="hljs-attribute">0000000000401580</span> &lt;Derived::~Derived()&gt;:<br>  <span class="hljs-attribute">401580</span>:	<span class="hljs-number">55</span>                   	push   %rbp<br>  <span class="hljs-attribute">401581</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             	mov    %rsp,%rbp<br>  <span class="hljs-attribute">401584</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> ec <span class="hljs-number">10</span>          	sub    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">401588</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          	mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">40158c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          	mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">401590</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br>  <span class="hljs-attribute">401593</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          	mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <span class="hljs-attribute">401597</span>:	e8 a4 ff ff ff       	callq  <span class="hljs-number">401540</span> &lt;Derived::~Derived()&gt;<br>  <span class="hljs-attribute">40159c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f0          	mov    -<span class="hljs-number">0</span>x10(%rbp),%rax<br>  <span class="hljs-attribute">4015a0</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br>  <span class="hljs-attribute">4015a3</span>:	e8 b8 fa ff ff       	callq  <span class="hljs-number">401060</span> &lt;operator delete(void*)@plt&gt;<br>  <span class="hljs-attribute">4015a8</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> c4 <span class="hljs-number">10</span>          	add    $<span class="hljs-number">0</span>x10,%rsp<br>  <span class="hljs-attribute">4015ac</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br>  <span class="hljs-attribute">4015ad</span>:	c3                   	retq   <br>  <span class="hljs-attribute">4015ae</span>:	<span class="hljs-number">66</span> <span class="hljs-number">90</span>                	xchg   %ax,%ax<br><br><span class="hljs-attribute">0000000000401610</span> &lt;non-virtual thunk to Derived::~Derived()&gt;:<br>  <span class="hljs-attribute">401610</span>:	<span class="hljs-number">55</span>                   	push   %rbp<br>  <span class="hljs-attribute">401611</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             	mov    %rsp,%rbp<br>  <span class="hljs-attribute">401614</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          	mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">401618</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          	mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">40161c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> c0 f0          	add    $<span class="hljs-number">0</span>xfffffffffffffff0,%rax<br>  <span class="hljs-attribute">401620</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br>  <span class="hljs-attribute">401623</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br>  <span class="hljs-attribute">401624</span>:	e9 <span class="hljs-number">17</span> ff ff ff       	jmpq   <span class="hljs-number">401540</span> &lt;Derived::~Derived()&gt;<br>  <span class="hljs-attribute">401629</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	nopl   <span class="hljs-number">0</span>x0(%rax)<br><br><span class="hljs-attribute">0000000000401630</span> &lt;non-virtual thunk to Derived::~Derived()&gt;:<br>  <span class="hljs-attribute">401630</span>:	<span class="hljs-number">55</span>                   	push   %rbp<br>  <span class="hljs-attribute">401631</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> e5             	mov    %rsp,%rbp<br>  <span class="hljs-attribute">401634</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">7</span>d f8          	mov    %rdi,-<span class="hljs-number">0</span>x8(%rbp)<br>  <span class="hljs-attribute">401638</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> f8          	mov    -<span class="hljs-number">0</span>x8(%rbp),%rax<br>  <span class="hljs-attribute">40163c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> c0 f0          	add    $<span class="hljs-number">0</span>xfffffffffffffff0,%rax<br>  <span class="hljs-attribute">401640</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br>  <span class="hljs-attribute">401643</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br>  <span class="hljs-attribute">401644</span>:	e9 <span class="hljs-number">37</span> ff ff ff       	jmpq   <span class="hljs-number">401580</span> &lt;Derived::~Derived()&gt;<br>  <span class="hljs-attribute">401649</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">1</span>f <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	nopl   <span class="hljs-number">0</span>x0(%rax)<br></code></pre></td></tr></table></figure>
<blockquote>
<p>å› ä¸ºvirtualææ„å‡½æ•°çš„åŠ å…¥ï¼Œæˆ‘å°†æ‰“å°çš„æ­¥éª¤ç®€åŒ–äº†ï¼Œå¦åˆ™æ˜¾ç¤ºä¼šæ··ä¹±ã€‚è¿è¡Œç»“æœå¦‚ä¸‹ï¼š<br><img src="/img%5C00006%5C13.png" srcset="/img/loading.gif" lazyload alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>è¿™ç§æƒ…å†µä¸‹GDBæ‰“å°å‡ºæ¥çš„è™šè¡¨å†…å®¹æœ‰é”™è¯¯ï¼Œæˆ–è€…æ˜¯å®ƒæ•…æ„éšç’ï¼Œå…¶åŸå› ä¸å¾—è€ŒçŸ¥ï¼Œæˆ‘å°†è¡¥å……åçš„ç»“æœè´´åœ¨è¿™é‡Œï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">&gt;gefâ¤  info vtbl *new_pderived<br>&gt;vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;Derived&#x27;</span> @ <span class="hljs-number">0</span>x4020b0 (subobject @ <span class="hljs-number">0</span>x416eb0):<br>&gt;<span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x401500 &lt;Derived::<span class="hljs-built_in">f</span>()&gt;<br>&gt;<span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x401540 &lt;Derived::~<span class="hljs-built_in">Derived</span>()&gt;<br>&gt;<span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x401580 &lt;Derived::~<span class="hljs-built_in">Derived</span>()&gt;<br>&gt;<span class="hljs-selector-attr">[3]</span>: <span class="hljs-number">0</span>x4015b0 &lt;Derived::<span class="hljs-built_in">h</span>()&gt;<br>&gt;vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;Base2&#x27;</span> @ <span class="hljs-number">0</span>x4020e0 (subobject @ <span class="hljs-number">0</span>x416ec0):<br>&gt;<span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x4015f0 &lt;non-virtual thunk to Derived::<span class="hljs-built_in">h</span>()&gt;<br>&gt;<span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x401610 &lt;non-virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……ä¸Šçš„</span><br>&gt;<span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x401630 &lt;non-virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……ä¸Šçš„</span><br></code></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨æœ€åä¸¤è¡Œï¼š<code>Base2 *new_pbase2 = new Derived();delete new_pbase2;</code>çœ‹ç¼–è¯‘å¦‚ä½•å®ŒæˆthisæŒ‡é’ˆçš„å›è°ƒï¼š<br><img src="/img%5C00006%5C14.png" srcset="/img/loading.gif" lazyload alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>åæ±‡ç¼–ä»£ç è¿è¡Œåˆ°<code>0x4013c3 &lt;main+419&gt;       mov    rax, QWORD PTR [rbp-0x58]</code>ä¹‹å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šDerivedç±»å¯¹è±¡åœ¨<code>0x416eb0</code>å †å†…å­˜åœ°å€ä¸Šè¿›è¡Œæ„é€ ï¼Œ<code>0x416eb0+0x10</code>åçš„å †æŒ‡é’ˆï¼ˆBase2ç±»å¯¹è±¡çš„thisæŒ‡é’ˆï¼‰å­˜å‚¨åœ¨<code>$rbp-0x58</code>ï¼ˆ0x7fffffffe0d8ï¼‰æ ˆå†…å­˜ä¸­ã€‚è¿™ä¸€è¿‡ç¨‹çš„ç»“æœæˆ‘ç”¨ä¸€å¼ å›¾è¿›è¡Œè¡¨è¾¾ï¼š<br><img src="/img%5C00006%5C15.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"></p>
</blockquote>
<blockquote>
<p><img src="/img%5C00006%5C16.png" srcset="/img/loading.gif" lazyload alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>è¯¥å›¾åœ¨<code>0x4013e5 &lt;main+453&gt;       call   QWORD PTR [rcx+0x10]</code>è¿˜æœªæ‰§è¡Œæ—¶å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šç¼–è¯‘å™¨å°†Base2ç±»å¯¹è±¡çš„thisæŒ‡é’ˆå­˜å‚¨åœ¨<code>rdi</code>å‚æ•°å¯„å­˜å™¨ä¸­ï¼Œä½œä¸º<code>&lt;non-virtual thunk to Derived::~Derived()&gt;</code>å‡½æ•°ï¼ˆ<code>rcx+0x10</code>ï¼‰çš„ç¬¬ä¸€å‚æ•°ã€‚è¯¥å‡½æ•°æŒ‡é’ˆæŒ‡å‘æ–‡æœ¬æ®µ<code>0x401630</code>å¤„ã€‚<br><img src="/img%5C00006%5C17.png" srcset="/img/loading.gif" lazyload alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>åæ±‡ç¼–ä»£ç è¿è¡Œåˆ°<code>0x401644 &lt;non-virtual+0&gt;  jmp    0x401580 &lt;Derived::~Derived()&gt;</code>ä¹‹å‰å‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šrdiå‚æ•°å¯„å­˜å™¨å°†å…¶å€¼ä¿å­˜åˆ°<code>rax</code>ä¸´æ—¶å¯„å­˜å™¨ä¸­ï¼Œ<code>rax</code>å°†è¯¥å€¼ï¼ˆ<code>0x416ec0</code>ï¼‰åŠ ä¸Š<code>0xfffffffffffffff0</code>ï¼Œç”±äºæº¢å‡ºï¼Œç›¸å½“äº<code>-0x10</code>ï¼Œå¾—åˆ°çš„æ–°å€¼ï¼ˆ<code>0x416eb0</code>ï¼‰å­˜å‚¨åˆ°<code>rax</code>å¯„å­˜å™¨ä¸­ã€‚éšåè°ƒç”¨å¸¦<code>operator delete(void*)</code>çš„virtualææ„å‡½æ•°ã€‚<br>è‡³æ­¤å®ŒæˆthisæŒ‡é’ˆå›è°ƒï¼Œdeleteå¯ä»¥æ­£å¸¸é”€æ¯æ‰newå‡ºæ¥Derivedç±»å¯¹è±¡ã€‚</p>
</blockquote>
<hr>
<h1 id="å¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå­ç±»æˆå‘˜å¸ƒå±€"><a href="#å¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå­ç±»æˆå‘˜å¸ƒå±€" class="headerlink" title="å¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå­ç±»æˆå‘˜å¸ƒå±€"></a>å¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†ï¼Œä»¥åŠå­ç±»æˆå‘˜å¸ƒå±€</h1><blockquote>
<p>åœ¨åˆ†æä¹‹å‰ï¼Œå’±ä»¬å…ˆå›é¡¾ä¸€ä¸‹ã€Šæ·±åº¦æ¢ç´¢c++å¯¹è±¡æ¨¡å‹ã€‹p120æå‡ºæ¥çš„ä¸€ä¸ªé—®é¢˜ï¼š<br>æ¯ä¸€ä¸ªå¯¹è±¡å¿…é¡»é’ˆå¯¹å…¶æ¯ä¸€ä¸ªvirtual base classèƒŒè´Ÿä¸€ä¸ªé¢å¤–çš„æŒ‡é’ˆï¼Œç„¶è€Œç†æƒ³ä¸Šæˆ‘ä»¬å´å¸Œæœ›class objectæœ‰å›ºå®šçš„è´Ÿæ‹…ï¼Œä¸å› ä¸ºå…¶virtual base classesçš„ä¸ªæ•°è€Œæœ‰æ‰€å˜åŒ–ã€‚æƒ³æƒ³çœ‹è¿™è¯¥å¦‚ä½•è§£å†³ï¼Ÿ</p>
<ul>
<li>ä¸€èˆ¬è€Œè¨€æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ã€‚Microsoft ç¼–è¯‘å™¨å¼•å…¥æ‰€è°“çš„virtual base class tableã€‚æ¯ä¸€ä¸ªclass objectå¦‚æœæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªvirtual base classesï¼Œå°±ä¼šç”±ç¼–è¯‘å™¨å®‰æ’ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘virtual base class tableã€‚è‡³äºçœŸæ­£çš„virtual base classæŒ‡é’ˆï¼Œå½“ç„¶æ˜¯è¢«æ”¾åœ¨è¯¥è¡¨æ ¼ä¸­ã€‚</li>
<li>ç¬¬äºŒä¸ªè§£å†³æ–¹æ³•ï¼Œæ˜¯åœ¨virtual function table ä¸­æ”¾ç½®virtual base class çš„ offsetï¼ˆè€Œä¸æ˜¯ç¬¬ä¸€ç§åŠæ³•ä¸­è¯´çš„virtual base classæŒ‡é’ˆï¼‰ã€‚ç¼–è¯‘å™¨å¯ä»¥é€šè¿‡virtual function tableçš„æ­£è´Ÿå€¼æ¥ç´¢å¼•è¯¥offsetã€‚å¦‚æœæ˜¯æ­£å€¼ï¼Œæ˜¾ç„¶ç´¢å¼•åˆ°çš„æ˜¯virtual functionï¼›å¦‚æœæ˜¯è´Ÿå€¼ï¼Œåˆ™æ˜¯ç´¢å¼•åˆ°virtual base class offsetsã€‚</li>
</ul>
<p>æ­£å¦‚ä¸Šé¢ç¬¬äºŒç§æ–¹æ³•æ‰€è¿°ï¼Œclangç¼–è¯‘å™¨é‡‡å–çš„å°±æ˜¯åŸºäºvtblçš„offsetæ¥è·å–è™šåŸºç±»çš„thisæŒ‡é’ˆï¼Œè¿›è€Œå®Œæˆè™šåŸºç±»æ•°æ®æˆå‘˜çš„è®¿é—®ã€‚<br>å’±ä»¬æ¥çœ‹å…·ä½“åˆ†æè¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š<br>å…ˆè®¾è®¡ä¸€ä¸ªè±å½¢ç»§æ‰¿çš„Derivedç±»ã€‚</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">//çˆ·çˆ·ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">grandpa</span><span class="hljs-comment">//ç±»åé¦–å­—æ¯å¿˜è®°å¤§å†™äº†ï¼ŒæŠ±æ­‰</span><br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">grandpa</span>():<span class="hljs-built_in">pa</span>(<span class="hljs-number">1</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;grandpa::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">g</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;grandpa::g()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">grandpa</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> pa;<br>&#125;;<br><span class="hljs-comment">//çˆ¶ç±»1</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span>:<span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> grandpa<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base1</span>():<span class="hljs-built_in">b1</span>(<span class="hljs-number">2</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">i</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base1::i()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base1</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> b1;<br>&#125;;<br><span class="hljs-comment">//çˆ¶ç±»2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base2</span>:<span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> grandpa<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Base2</span>():<span class="hljs-built_in">b2</span>(<span class="hljs-number">3</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">j</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::j()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">k</span><span class="hljs-params">()</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;base2::k()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base2</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> b2;<br>&#125;;<br><span class="hljs-comment">//å­ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base1,<span class="hljs-keyword">public</span> Base2<br>&#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-built_in">Derived</span>():<span class="hljs-built_in">m</span>(<span class="hljs-number">4</span>),<span class="hljs-built_in">n</span>(<span class="hljs-number">5</span>) &#123;&#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">f</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ·çˆ·ç±»çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::f()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">h</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»1çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::h()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">j</span><span class="hljs-params">()</span><span class="hljs-comment">//è¦†ç›–çˆ¶ç±»2çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::j()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">l</span><span class="hljs-params">()</span><span class="hljs-comment">//derivedç±»è‡ªå·±çš„è™šå‡½æ•°</span></span><br><span class="hljs-function">    </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;derived::l()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Derived</span>() &#123;&#125;<br>    <span class="hljs-type">int</span> m;<br>    <span class="hljs-type">int</span> n;<br>&#125;;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    Derived *new_pderived = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    new_pderived-&gt;pa = <span class="hljs-number">11</span>;<br>    <span class="hljs-keyword">delete</span> new_pderived;<br><br>    Base1 *new_pbase1 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    new_pbase1-&gt;pa = <span class="hljs-number">11</span>;<br>    <span class="hljs-keyword">delete</span> new_pbase1;<br><br>    Base2 *new_pbase2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Derived</span>();<br>    new_pbase2-&gt;pa = <span class="hljs-number">11</span>;<br>    <span class="hljs-keyword">delete</span> new_pbase2;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>éœ€è¦ç”¨åˆ°çš„åæ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs apache">  <span class="hljs-attribute">Derived</span> *new_pderived = new Derived();<br><span class="hljs-attribute">401227</span>:	e8 <span class="hljs-number">44</span> fe ff ff       	callq  <span class="hljs-number">401070</span> &lt;operator new(unsigned long)@plt&gt;<br><span class="hljs-attribute">40122c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             	mov    %rax,%rcx<br><span class="hljs-attribute">40122f</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c2             	mov    %rax,%rdx<br><span class="hljs-attribute">401232</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">401235</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d c8          	mov    %rcx,-<span class="hljs-number">0</span>x38(%rbp)<br><span class="hljs-attribute">401239</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">55</span> c0          	mov    %rdx,-<span class="hljs-number">0</span>x40(%rbp)<br><span class="hljs-attribute">40123d</span>:	e8 <span class="hljs-number">7</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">4013</span>c0 &lt;Derived::Derived()&gt;<br><span class="hljs-attribute">401242</span>:	e9 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	jmpq   <span class="hljs-number">401247</span> &lt;main+<span class="hljs-number">0</span>x37&gt;<br><span class="hljs-attribute">401247</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> c0          	mov    -<span class="hljs-number">0</span>x40(%rbp),%rax<br><span class="hljs-attribute">40124b</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> f0          	mov    %rax,-<span class="hljs-number">0</span>x10(%rbp)<br>  <span class="hljs-attribute">new_pderived</span>-&gt;pa = <span class="hljs-number">11</span>;<br><span class="hljs-attribute">40124f</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d f0          	mov    -<span class="hljs-number">0</span>x10(%rbp),%rcx<br><span class="hljs-attribute">401253</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">11</span>             	mov    (%rcx),%rdx<br><span class="hljs-attribute">401256</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">52</span> e8          	mov    -<span class="hljs-number">0</span>x18(%rdx),%rdx<br><span class="hljs-attribute">40125a</span>:	c7 <span class="hljs-number">44</span> <span class="hljs-number">11</span> <span class="hljs-number">08</span> <span class="hljs-number">0</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	movl   $<span class="hljs-number">0</span>xb,<span class="hljs-number">0</span>x8(%rcx,%rdx,<span class="hljs-number">1</span>)<br><span class="hljs-attribute">401261</span>:	<span class="hljs-number">00</span> <br>  <span class="hljs-attribute">delete</span> new_pderived;<br><span class="hljs-attribute">401262</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">4</span>d f0          	mov    -<span class="hljs-number">0</span>x10(%rbp),%rcx<br><span class="hljs-attribute">401266</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> f9 <span class="hljs-number">00</span>          	cmp    $<span class="hljs-number">0</span>x0,%rcx<br><span class="hljs-attribute">40126a</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d b8          	mov    %rcx,-<span class="hljs-number">0</span>x48(%rbp)<br><span class="hljs-attribute">40126e</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	je     <span class="hljs-number">401281</span> &lt;main+<span class="hljs-number">0</span>x71&gt;<br><span class="hljs-attribute">401274</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> b8          	mov    -<span class="hljs-number">0</span>x48(%rbp),%rax<br><span class="hljs-attribute">401278</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">40127b</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">40127e</span>:	ff <span class="hljs-number">51</span> <span class="hljs-number">18</span>             	callq  *<span class="hljs-number">0</span>x18(%rcx)<br><span class="hljs-attribute">401281</span>:	bf <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	mov    $<span class="hljs-number">0</span>x38,%edi<br><br>  <span class="hljs-attribute">Base1</span> *new_pbase1 = new Derived();<br><span class="hljs-attribute">401286</span>:	e8 e5 fd ff ff       	callq  <span class="hljs-number">401070</span> &lt;operator new(unsigned long)@plt&gt;<br><span class="hljs-attribute">40128b</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             	mov    %rax,%rcx<br><span class="hljs-attribute">40128e</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c2             	mov    %rax,%rdx<br><span class="hljs-attribute">401291</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">401294</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d b0          	mov    %rcx,-<span class="hljs-number">0</span>x50(%rbp)<br><span class="hljs-attribute">401298</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">55</span> a8          	mov    %rdx,-<span class="hljs-number">0</span>x58(%rbp)<br><span class="hljs-attribute">40129c</span>:	e8 <span class="hljs-number">1</span>f <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">4013</span>c0 &lt;Derived::Derived()&gt;<br><span class="hljs-attribute">4012a1</span>:	e9 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	jmpq   <span class="hljs-number">4012</span>a6 &lt;main+<span class="hljs-number">0</span>x96&gt;<br><span class="hljs-attribute">4012a6</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> a8          	mov    -<span class="hljs-number">0</span>x58(%rbp),%rax<br><span class="hljs-attribute">4012aa</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> d8          	mov    %rax,-<span class="hljs-number">0</span>x28(%rbp)<br>  <span class="hljs-attribute">new_pbase1</span>-&gt;pa = <span class="hljs-number">11</span>;<br><span class="hljs-attribute">4012ae</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d8          	mov    -<span class="hljs-number">0</span>x28(%rbp),%rax<br><span class="hljs-attribute">4012b2</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">4012b5</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">49</span> e8          	mov    -<span class="hljs-number">0</span>x18(%rcx),%rcx<br><span class="hljs-attribute">4012b9</span>:	c7 <span class="hljs-number">44</span> <span class="hljs-number">08</span> <span class="hljs-number">08</span> <span class="hljs-number">0</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	movl   $<span class="hljs-number">0</span>xb,<span class="hljs-number">0</span>x8(%rax,%rcx,<span class="hljs-number">1</span>)<br><span class="hljs-attribute">4012c0</span>:	<span class="hljs-number">00</span> <br>  <span class="hljs-attribute">delete</span> new_pbase1;<br><span class="hljs-attribute">4012c1</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d8          	mov    -<span class="hljs-number">0</span>x28(%rbp),%rax<br><span class="hljs-attribute">4012c5</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> f8 <span class="hljs-number">00</span>          	cmp    $<span class="hljs-number">0</span>x0,%rax<br><span class="hljs-attribute">4012c9</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> a0          	mov    %rax,-<span class="hljs-number">0</span>x60(%rbp)<br><span class="hljs-attribute">4012cd</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	je     <span class="hljs-number">4012</span>e0 &lt;main+<span class="hljs-number">0</span>xd0&gt;<br><span class="hljs-attribute">4012d3</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> a0          	mov    -<span class="hljs-number">0</span>x60(%rbp),%rax<br><span class="hljs-attribute">4012d7</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">4012da</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">4012dd</span>:	ff <span class="hljs-number">51</span> <span class="hljs-number">18</span>             	callq  *<span class="hljs-number">0</span>x18(%rcx)<br><span class="hljs-attribute">4012e0</span>:	bf <span class="hljs-number">38</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	mov    $<span class="hljs-number">0</span>x38,%edi<br><br>  <span class="hljs-attribute">Base2</span> *new_pbase2 = new Derived();<br><span class="hljs-attribute">4012e5</span>:	e8 <span class="hljs-number">86</span> fd ff ff       	callq  <span class="hljs-number">401070</span> &lt;operator new(unsigned long)@plt&gt;<br><span class="hljs-attribute">4012ea</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c1             	mov    %rax,%rcx<br><span class="hljs-attribute">4012ed</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c2             	mov    %rax,%rdx<br><span class="hljs-attribute">4012f0</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">4012f3</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d <span class="hljs-number">98</span>          	mov    %rcx,-<span class="hljs-number">0</span>x68(%rbp)<br><span class="hljs-attribute">4012f7</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">55</span> <span class="hljs-number">90</span>          	mov    %rdx,-<span class="hljs-number">0</span>x70(%rbp)<br><span class="hljs-attribute">4012fb</span>:	e8 c0 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	callq  <span class="hljs-number">4013</span>c0 &lt;Derived::Derived()&gt;<br><span class="hljs-attribute">401300</span>:	e9 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>       	jmpq   <span class="hljs-number">401305</span> &lt;main+<span class="hljs-number">0</span>xf5&gt;<br><span class="hljs-attribute">401305</span>:	<span class="hljs-number">31</span> c0                	xor    %eax,%eax<br><span class="hljs-attribute">401307</span>:	<span class="hljs-number">89</span> c1                	mov    %eax,%ecx<br><span class="hljs-attribute">401309</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">55</span> <span class="hljs-number">90</span>          	mov    -<span class="hljs-number">0</span>x70(%rbp),%rdx<br><span class="hljs-attribute">40130d</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> fa <span class="hljs-number">00</span>          	cmp    $<span class="hljs-number">0</span>x0,%rdx<br><span class="hljs-attribute">401311</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">4</span>d <span class="hljs-number">88</span>          	mov    %rcx,-<span class="hljs-number">0</span>x78(%rbp)<br><span class="hljs-attribute">401315</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">0</span>e <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	je     <span class="hljs-number">401329</span> &lt;main+<span class="hljs-number">0</span>x119&gt;<br><span class="hljs-attribute">40131b</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">90</span>          	mov    -<span class="hljs-number">0</span>x70(%rbp),%rax<br><span class="hljs-attribute">40131f</span>:	<span class="hljs-number">48</span> <span class="hljs-number">05</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	add    $<span class="hljs-number">0</span>x10,%rax<br><span class="hljs-attribute">401325</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> <span class="hljs-number">88</span>          	mov    %rax,-<span class="hljs-number">0</span>x78(%rbp)<br><span class="hljs-attribute">401329</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">88</span>          	mov    -<span class="hljs-number">0</span>x78(%rbp),%rax<br><span class="hljs-attribute">40132d</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> d0          	mov    %rax,-<span class="hljs-number">0</span>x30(%rbp)<br>  <span class="hljs-attribute">new_pbase2</span>-&gt;pa = <span class="hljs-number">11</span>;<br><span class="hljs-attribute">401331</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          	mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">401335</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">401338</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">49</span> e8          	mov    -<span class="hljs-number">0</span>x18(%rcx),%rcx<br><span class="hljs-attribute">40133c</span>:	c7 <span class="hljs-number">44</span> <span class="hljs-number">08</span> <span class="hljs-number">08</span> <span class="hljs-number">0</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	movl   $<span class="hljs-number">0</span>xb,<span class="hljs-number">0</span>x8(%rax,%rcx,<span class="hljs-number">1</span>)<br><span class="hljs-attribute">401343</span>:	<span class="hljs-number">00</span> <br>  <span class="hljs-attribute">delete</span> new_pbase2;<br><span class="hljs-attribute">401344</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> d0          	mov    -<span class="hljs-number">0</span>x30(%rbp),%rax<br><span class="hljs-attribute">401348</span>:	<span class="hljs-number">48</span> <span class="hljs-number">83</span> f8 <span class="hljs-number">00</span>          	cmp    $<span class="hljs-number">0</span>x0,%rax<br><span class="hljs-attribute">40134c</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> <span class="hljs-number">80</span>          	mov    %rax,-<span class="hljs-number">0</span>x80(%rbp)<br><span class="hljs-attribute">401350</span>:	<span class="hljs-number">0</span>f <span class="hljs-number">84</span> <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>    	je     <span class="hljs-number">401363</span> &lt;main+<span class="hljs-number">0</span>x153&gt;<br><span class="hljs-attribute">401356</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">45</span> <span class="hljs-number">80</span>          	mov    -<span class="hljs-number">0</span>x80(%rbp),%rax<br><span class="hljs-attribute">40135a</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">08</span>             	mov    (%rax),%rcx<br><span class="hljs-attribute">40135d</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> c7             	mov    %rax,%rdi<br><span class="hljs-attribute">401360</span>:	ff <span class="hljs-number">51</span> <span class="hljs-number">18</span>             	callq  *<span class="hljs-number">0</span>x18(%rcx)<br><span class="hljs-attribute">401363</span>:	<span class="hljs-number">8</span>b <span class="hljs-number">45</span> fc             	mov    -<span class="hljs-number">0</span>x4(%rbp),%eax<br><span class="hljs-attribute">401366</span>:	<span class="hljs-number">48</span> <span class="hljs-number">81</span> c4 <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 	add    $<span class="hljs-number">0</span>x80,%rsp<br><span class="hljs-attribute">40136d</span>:	<span class="hljs-number">5</span>d                   	pop    %rbp<br><span class="hljs-attribute">40136e</span>:	c3                   	retq   <br><span class="hljs-attribute">40136f</span>:	<span class="hljs-number">48</span> <span class="hljs-number">89</span> <span class="hljs-number">45</span> e8          	mov    %rax,-<span class="hljs-number">0</span>x18(%rbp)<br><span class="hljs-attribute">401373</span>:	<span class="hljs-number">89</span> <span class="hljs-number">55</span> e4             	mov    %edx,-<span class="hljs-number">0</span>x1c(%rbp)<br><span class="hljs-attribute">401376</span>:	<span class="hljs-number">48</span> <span class="hljs-number">8</span>b <span class="hljs-number">7</span>d c8          	mov    -<span class="hljs-number">0</span>x38(%rbp),%rdi<br></code></pre></td></tr></table></figure>
<blockquote>
<p>Derivedç±»çš„vtblå†…å®¹å¦‚ä¸‹(ç¼–è¯‘å™¨æ²¡æœ‰å®Œå…¨æ‰“å°å‡ºæ¥ï¼Œç¬”è€…å°†è¡¥å……åçš„åˆ—åœ¨ä¸‹é¢)ï¼š</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs stylus">gefâ¤  info vtbl *new_pderived<br>vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;Derived&#x27;</span> @ <span class="hljs-number">0</span>x402020 (subobject @ <span class="hljs-number">0</span>x416eb0):<br><span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x401850 &lt;Derived::<span class="hljs-built_in">h</span>()&gt;<br><span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x4015b0 &lt;Base1::<span class="hljs-selector-tag">i</span>()&gt;<br><span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x401890 &lt;Derived::~<span class="hljs-built_in">Derived</span>()&gt;<br><span class="hljs-selector-attr">[3]</span>: <span class="hljs-number">0</span>x4018d0 &lt;Derived::~<span class="hljs-built_in">Derived</span>()&gt;<br><span class="hljs-selector-attr">[4]</span>: <span class="hljs-number">0</span>x401900 &lt;Derived::<span class="hljs-built_in">f</span>()&gt;<br><span class="hljs-selector-attr">[5]</span>: <span class="hljs-number">0</span>x401940 &lt;Derived::<span class="hljs-built_in">j</span>()&gt;<br><span class="hljs-selector-attr">[6]</span>: <span class="hljs-number">0</span>x401980 &lt;Derived::<span class="hljs-built_in">l</span>()&gt;<br>vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;Base2&#x27;</span> @ <span class="hljs-number">0</span>x402070 (subobject @ <span class="hljs-number">0</span>x416ec0):<br><span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x4019c0 &lt;non-virtual thunk to Derived::<span class="hljs-built_in">j</span>()&gt;<br><span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x401760 &lt;Base2::<span class="hljs-built_in">k</span>()&gt;<br><span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x4019e0 &lt;non-virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……çš„</span><br><span class="hljs-selector-attr">[3]</span>: <span class="hljs-number">0</span>x401a00 &lt;non-virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……çš„</span><br>vtable <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;grandpa&#x27;</span> @ <span class="hljs-number">0</span>x4020b8 (subobject @ <span class="hljs-number">0</span>x416ed8):<br><span class="hljs-selector-attr">[0]</span>: <span class="hljs-number">0</span>x401a20 &lt;virtual thunk to Derived::<span class="hljs-built_in">f</span>()&gt;<br><span class="hljs-selector-attr">[1]</span>: <span class="hljs-number">0</span>x4016a0 &lt;grandpa::<span class="hljs-built_in">g</span>()&gt;<br><span class="hljs-selector-attr">[2]</span>: <span class="hljs-number">0</span>x401a40 &lt;virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……çš„</span><br><span class="hljs-selector-attr">[3]</span>: <span class="hljs-number">0</span>x401a60 &lt;virtual thunk to Derived::~<span class="hljs-built_in">Derived</span>()&gt;<span class="hljs-comment">//ç¬”è€…è¡¥å……çš„</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>è‡³äºä¸ºä»€ä¹ˆBase2ç±»å’Œgrandpaç±»ä¼šå¤šå‡ºä¸¤ä¸ªthunkå‡½æ•°ï¼Œä¸Šä¸€å°èŠ‚å·²ç»åˆ†æè¿‡ã€‚è¿™é‡Œè¡¥å……ä¸€ç‚¹ï¼Œå› ä¸ºDerivedç±»å¯¹è±¡çš„æ•°æ®å¸ƒå±€æœ€ä¸Šé¢æ˜¯Base1ç±»å¯¹è±¡ï¼Œä¸­é—´æ˜¯Base2ç±»å¯¹è±¡ï¼Œvirtual grandpaå¯¹è±¡æ°¸è¿œæ˜¯åœ¨æœ€ä¸‹é¢ã€‚è¿™æ ·å°±å¯¼è‡´Base2ç±»åœ¨æ”¯æŒå¤šæ€æ—¶è°ƒç”¨è¢«é‡å†™çš„è™šå‡½æ•°ä»¥åŠè°ƒç”¨Derivedç±»çš„virtualææ„å‡½æ•°æ—¶ï¼Œéœ€è¦è°ƒæ•´thisæŒ‡é’ˆã€‚grandpaç±»é“ç†ä¸€æ ·ã€‚<br>å’±ä»¬ç”¨GDBæŸ¥çœ‹Derivedç±»å¯¹è±¡çš„å†…å­˜å¸ƒå±€ï¼Œå¹¶ç”¨å›¾ç”»æ–¹å¼ç›´è§‚è¡¨è¾¾å‡ºæ¥ï¼š<br><img src="/img%5C00006%5C18.png" srcset="/img/loading.gif" lazyload alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br><img src="/img%5C00006%5C19.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>ä¸Šå›¾ä¸­ï¼Œç¬”è€…å°†offsetå‡ºç°çš„åœ°æ–¹æ˜ç¡®æ ‡æ˜å‡ºæ¥äº†ï¼Œä¸‹é¢å’±ä»¬å°±æ¥çœ‹ä¸‹ç¼–è¯‘æ˜¯å¦‚ä½•å–å‡ºè¿™ä¸ªoffsetsçš„ï¼<br><img src="/img%5C00006%5C20.png" srcset="/img/loading.gif" lazyload alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°"><br>åæ±‡ç¼–ä»£ç <code>0x401256 &lt;main+70&gt;        mov    rdx, QWORD PTR [rdx-0x18]</code>è¿˜æœªæ‰§è¡Œæ—¶ï¼Œå‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šDerivedç±»å¯¹è±¡åœ¨<code>0x416eb0</code>å †å†…å­˜ä¸­è¿›è¡Œäº†æ„é€ ã€‚new_pderivedæŒ‡é’ˆçš„åœ°å€ä¸º<code>rbp-0x10</code>ï¼Œå®ƒæŒ‡å‘<code>0x416eb0</code>å †å†…å­˜ã€‚ç¼–è¯‘å™¨å°†Derivedç±»<code>vptr1</code>æŒ‡å‘çš„è™šè¡¨åœ°å€å­˜å‚¨åˆ°<code>rdx</code>ä¸­ã€‚<br>æ¥ä¸‹æ¥å°†ä¼šå‘ç”Ÿçš„äº‹æƒ…æœ‰ï¼šç¼–è¯‘å™¨å°†è¯¥è™šè¡¨åœ°å€åç§»<code>-0x18</code>å­—èŠ‚å¹¶è·å–è¯¥åœ°å€ä¸­çš„å†…å®¹ï¼ˆ<code>offset</code>ï¼‰ï¼Œå°†å…¶å€¼ï¼ˆ<code>0x28</code>ï¼‰å­˜å…¥<code>rdx</code>å¯„å­˜å™¨ä¸­ã€‚æœ€åå°†<code>åè¿›åˆ¶11</code>å­˜å…¥thisæŒ‡é’ˆåç§»åçš„åœ°å€ä¸­ï¼ˆ<code>rcx+rdx*1+0x8</code>ï¼š<code>0x416eb0+0x28*1+0x8 = 0x416ee0</code>ï¼Œå³<code>pa</code>çš„åœ°å€ï¼‰ã€‚<br><img src="/img%5C00006%5C21.png" srcset="/img/loading.gif" lazyload alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>ä»£ç æ®µ<code>new_pbase1-&gt;pa = 11;</code>å’Œ<code>new_pbase2-&gt;pa = 11;</code>åŒæ ·ä¼šå‡ºç°å–<code>offset</code>è¿›è¡Œåç§»åï¼Œç„¶åå­˜å–grandpaçš„æˆå‘˜å˜é‡paçš„æƒ…å†µã€‚<code>new_pbase1-&gt;pa</code>å–åˆ°çš„<code>offset</code>å€¼å’Œ<code>new_pderived-&gt;pa</code>ä¸€æ ·æ˜¯<code>0x28</code>ã€‚è€Œ<code>new_pbase2-&gt;pa</code>å–åˆ°çš„å€¼ä¸º<code>0x18</code>ã€‚<br><img src="/img%5C00006%5C22.png" srcset="/img/loading.gif" lazyload alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å¦‚æœæ˜¯è™šåŸºç±»grandpaåœ¨æ”¯æŒå¤šæ€æ—¶ï¼Œä¸”<code>new_pgrandpa-&gt;pa</code>è¿›è¡Œå­˜å–æ“ä½œï¼Œåˆ™ä¸ç”¨åç§»thisæŒ‡é’ˆï¼Œä¹Ÿå°±ä¸éœ€è¦å–<code>offset</code>ã€‚è¯¥è™šåŸºç±»çš„è™šè¡¨ä¸­ä¹Ÿæ²¡æœ‰å­˜<code>offset</code>ã€‚<br><img src="/img%5C00006%5C23.png" srcset="/img/loading.gif" lazyload alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br>å¯ä»¥çœ‹åˆ°<code>0x4020b8-0x18</code>åœ°å€ä¸Šçš„å€¼æ˜¯ä¸ªç‰›é©¬å€¼ :)</p>
</blockquote>
<hr>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/C/" class="category-chain-item">C++</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆï¼Œthunkï¼Œå¤šæ€ï¼Œå¤šé‡ç»§æ‰¿thisæŒ‡é’ˆåç§»ï¼Œå¤šé‡ç»§æ‰¿virtualææ„å‡½æ•°ï¼Œå¤šé‡è™šç»§æ‰¿ä¸‹çš„è®¿é—®è™šåŸºç±»æˆå‘˜å˜é‡æ—¶è™šè¡¨çš„å·¥ä½œåŸç†</div>
      <div>https://howl144.github.io/2022/02/19/00006. c++å¯¹è±¡æ¨¡å‹ä¹‹è™šè¡¨ï¼Œè™šè¡¨æŒ‡é’ˆç­‰/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Deng Ye</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>February 19, 2022</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/07/21/00020.%20Games202%20Hw5/" title="Games202 Hw5">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Games202 Hw5</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/09/00005.%20C++11,14,17%E4%B8%ADauto%E5%92%8Cdecltype%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E5%8F%8A%E6%8B%93%E5%B1%95/" title="C++11,14,17ä¸­autoå’Œdecltypeç›¸å…³çŸ¥è¯†åŠæ‹“å±•">
                        <span class="hidden-mobile">C++11,14,17ä¸­autoå’Œdecltypeç›¸å…³çŸ¥è¯†åŠæ‹“å±•</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        Views: 
        <span id="leancloud-site-pv"></span>
        
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        Visitors: 
        <span id="leancloud-site-uv"></span>
        
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
